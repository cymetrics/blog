<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/favicon.svg" rel="icon" type="image/svg+xml"><meta content="#5789d3" name="theme-color"><title>DNS Hacking 之 基礎知識：DNS 運作與紀錄類型</title><meta content="DNS Hacking 之 基礎知識：DNS 運作與紀錄類型" property="og:title"><meta content="DNS Hacking 之 基礎知識：DNS 運作與紀錄類型" name="twitter:title"><meta content="summary" name="twitter:card"><meta content="要打掛別人的網站難道只能從網頁中的漏洞下手嗎？其實，常常被忽略的 DNS 的漏洞可能更致命，讓駭客輕輕鬆鬆接管你的網站！但首先，我們要認識 DNS 的運作機制，以及有哪些紀錄類型。" name="description"><meta content="要打掛別人的網站難道只能從網頁中的漏洞下手嗎？其實，常常被忽略的 DNS 的漏洞可能更致命，讓駭客輕輕鬆鬆接管你的網站！但首先，我們要認識 DNS 的運作機制，以及有哪些紀錄類型。" name="twitter:description"><meta content="要打掛別人的網站難道只能從網頁中的漏洞下手嗎？其實，常常被忽略的 DNS 的漏洞可能更致命，讓駭客輕輕鬆鬆接管你的網站！但首先，我們要認識 DNS 的運作機制，以及有哪些紀錄類型。" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/crystal/dns-hacking-1/" property="og:url"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/crystal/dns-hacking/cover-1.jpg" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/crystal/dns-hacking/cover-1.jpg" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://tech-blog.cymetrics.io/posts/crystal/dns-hacking-1/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=bcb67b09df" defer=""></script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body,figure{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,ol,p,pre,ul{font-size:1em}ol,p,pre,ul{margin-bottom:1.5em}body,ol,p,pre,ul{font-size:1rem;line-height:1.6}ol,p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,ol,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}body,ol,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.632rem}}th{font-weight:600}td,th{border-bottom:1px solid #595959;overflow:auto;padding:.75em;text-align:left;vertical-align:top}thead th{border-bottom:1px solid #f9c412}table{display:table}code,pre,table{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}figcaption{color:#757575;margin-top:.75em;text-align:center}figcaption>p{margin:0;font-size:90%}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}figure img,header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;flex-direction:column}header p,ol,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol,li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#2d2d2d}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title,header{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">DNS Hacking 之 基礎知識：DNS 運作與紀錄類型</h1><aside class="w-full"><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/dns/" class="post-tag">#DNS</a></div><div class="post-avatar"><img src="/img/authors/crystal_logo.png" alt="crystal" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/crystal">crystal</a></div><div class="post-avatar__time">25 Nov 2021</div></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>要打掛別人的網站難道只能從網頁中的漏洞下手嗎？其實，常常被忽略的 DNS 的漏洞可能更致命，讓駭客輕輕鬆鬆接管你的網站！但首先，我們要認識 DNS 的運作機制，以及有哪些紀錄類型。</p><h2 id="dns-%E5%A6%82%E4%BD%95%E9%81%8B%E4%BD%9C"><a href="#dns-%E5%A6%82%E4%BD%95%E9%81%8B%E4%BD%9C" class="direct-link">#</a> DNS 如何運作</h2><p>想像一下你要寄一箱水果到客戶劉先生的家裡，但你並不知道人家的地址。你總不能就只把『螃蟹公司業務部門劉先生』寫在包裹外面，因為郵差先生當然也不知道這個人是誰、更不知道他到底住哪裡。那，你要怎麼知道劉先生的門牌號碼，順利寄出水果呢？</p><p>首先，你可能會先 google 一下螃蟹公司的電話號碼，然後播一通電話過去問問該如何聯繫到業務部門的窗口。對方可能會給你另一支電話號碼或是轉撥分機，讓你聯繫上業務部門的人。最後，業務人員也許能直接從他的通訊錄中找到並告訴你劉先生家的地址，或是給你劉先生的電話讓你親自聯繫他。</p><p>這樣經過層層關係追朔出地址的做法，就是 DNS 運作的方式。</p><p>網路世界中，DNS 是一本巨大的通訊錄，紀錄每個網域的名稱（人看得懂的 <code>google.com</code>）與實際地址（人看不懂的 <code>172.217.160.78</code>）的對應關係。</p><p>你可以想成是，有一個服務專線會幫你處理前述反覆打電話的過程，當你透過專線詢問『螃蟹公司業務部門劉先生』的地址時，他就會直接回覆你詳細的門牌資訊。</p><p>當然，這麼複雜的工作不是一個人可以有效完成的，所以查詢的工作也需要多個層級的聯絡人，例如一個地方級聯絡人手上有信義區所有公司的電話號碼，而上一層的縣市級聯絡人手上則有所有地方級聯絡人的電話號碼，再往上也許還有區域級甚至全國級的聯絡人。為你服務的接線生手上也不會有所有聯絡人的資訊，畢竟這個清單太龐大了，而且他光是翻遍自己手上的筆記本就要耗費太多時間與資源。所以接線生的筆記本只會紀錄最常用的數筆電話號碼，以及最高層級的聯絡人（可以透過他層層推進往下查詢）。</p><p>同理，DNS 也是一個樹狀結構，有層級的分別。實際的機制我們用下圖解釋：</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/dns-hacking/dns-lookup-1920w.webp 1920w, /img/posts/crystal/dns-hacking/dns-lookup-1280w.webp 1280w, /img/posts/crystal/dns-hacking/dns-lookup-840w.webp 840w, /img/posts/crystal/dns-hacking/dns-lookup-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/dns-hacking/dns-lookup-1920w.jpg 1920w, /img/posts/crystal/dns-hacking/dns-lookup-1280w.jpg 1280w, /img/posts/crystal/dns-hacking/dns-lookup-840w.jpg 840w, /img/posts/crystal/dns-hacking/dns-lookup-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/dns-hacking/dns-lookup-1920w.jpg" height="1698" width="3208" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 3208 1698'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA40lEQVQY0y2PS0vDUBSE8/8XpQ8ItrYuBbsQRaqiqIUoQVzoSrQkmsdNok3aJo02udXyeZM6cBbD+RhmtGyRUqwKKhm3d5imSZ6v+Mq/efd89o9PcVy3/mvDvSaPDyZyDe12h/5gQFmuSeIZIoy4GBv4vtjC1uRZGRep6FarQ2+3z+/Phixd4oqAw/MrwijawmlWMlUplSp4p9tVtSTz2QJPwaPLaxznP7k3PGN8/1SbRqOJrusUhSRJ5nhByOjGQASB2pGjic8pH3Fcw7Ztq7NIVYVlljOxbA6OTnh5fUOWG/4AZcfqeXzoLkkAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>DNS Lookup</p></figcaption></figure><p></p><p>當小華雙十一想要大買特買，在瀏覽器輸入 <code>www.abc.com</code> 的網址時，會依照圖中的流程發生這些事：</p><ol><li>你的瀏覽器對撥打專線尋求接線生的協助，這個接線生就是我們說的 DNS resolver。</li><li>稱職的接線生手上沒有 <code>www.abc.com</code> 的記錄，但為了幫你找到正確的地址，會先去詢問最高層級的 DNS，也就是概念上屬於 <code>.</code> 網域的 Root DNS。</li><li>Root DNS 查一下自己手上的子網域清單，找到負責 <code>.com</code> 網域的 TLD(Top Level Domain) DNS，於是把這個地址轉介給 resolver。</li><li>resolver 轉向 <code>.com</code> 網域的 TLD DNS 詢問 <code>www.abc.com</code> 的地址。</li><li>TLD DNS 從手上的清單找到負責 <code>abc.com</code> 網域的 Authoritative DNS 的位置，回覆給 resolver。</li><li>resolver 向負責 <code>abc.com</code> 網域的 Authoritative DNS 詢問 <code>www.abc.com</code> 這個子網域。</li><li>Authoritative DNS 的記錄裡存在 <code>www.abc.com</code> 的記錄，把 IP 告訴 resolver！</li><li>DNS resolver 回覆瀏覽器查詢結果，可能是一個或是數個 IP 的清單。</li><li>瀏覽器對查到的 IP 發起 HTTP Request，成功帶小華到購物網站！</li></ol><p>經過好一番波折我們才終於得到一個網域名稱對應的實際 IP，如果每次都要經過這麼多次查詢未免太繁瑣了。作為一個世上最大的分散式資料庫系統，能快速查詢結果及同步更新是極為重要的。</p><p>還記得我們說過接線生手上有一個紀錄聯絡人的筆記本嗎？每個 DNS resolver 都會有 caching 的機制，記錄一些常用聯絡人的資訊，讓查詢的過程可以跳過幾個步驟。如果接線生手上本來就有 <code>www.abc.com</code> 的地址，那就會直接回覆給瀏覽器，不用經過更多查詢。如果差了一點，只有 <code>abc.com</code> 網域的 Authoritative DNS 位置，那也可以直接跳到第六個步驟開始。通常 DNS resolver 手上本來就會有多個 TLD DNS 的位置了，所以除非 DNS cache 剛被清空，否則很少會需要從頭開始詢問 Root DNS。</p><p>不過，DNS cache 中的紀錄也不是就一直存放在裡面的。每一筆紀錄都會有一個 TTL (Time-to-live)，這是一個代表『此紀錄可以被 cache 存多久』的數字，如果超過有效期限就表示這筆紀錄不新鮮，需要丟掉然後重新查詢一次來獲得新紀錄。這個機制的好處是能快速更新各個網域『搬家』的狀態，假設 TTL 為一小時，網管人員若是發布新的紀錄或是更改了服務的 IP，則可以確保至少在一小時後新紀錄就能生效，否則 DNS resolver 怎麼確認手上的地址是否還有效呢？</p><p>整理一下幾種角色：</p><ul><li>Root DNS：最高層級的 DNS，共有 13 種，全世界共有 600-700 多台，由 ICANN 管理，是每個 DNS Resolver 的已知資訊。存放關於各個 TLD DNS 的資訊。</li><li>TLD DNS：次高層級的 DNS，負責如 <code>.com</code>、<code>.net</code>、<code>.org</code>、<code>.tw</code> 等最後一個後綴的網域，會存放各個 Authoritative DNS 的資訊。由 ICANN 下的分支 IANA 管理。</li><li>Authoritative DNS：其他較低層級的 DNS，一般來說會是查詢的最後一站，專屬於掌握此網域的機構並存放此機構的子網域資訊。</li><li>DNS Resolver：Lookup 的第一站，接線生的角色。 DNS cache 中會存放常用聯絡人，或更精確的說，最近使用的聯絡人的紀錄，向其他 DNS 查詢後會把回覆的紀錄寫進 cache。</li></ul><h2 id="dns-%E8%A8%98%E9%8C%84%E6%9C%89%E5%93%AA%E4%BA%9B"><a href="#dns-%E8%A8%98%E9%8C%84%E6%9C%89%E5%93%AA%E4%BA%9B" class="direct-link">#</a> DNS 記錄有哪些</h2><p>DNS 記錄非常多種，常見的有： <code>SOA</code>、<code>A</code>、<code>AAAA</code>、<code>CNAME</code>、<code>NS</code>、<code>MX</code>、<code>TXT</code>、<code>SRV</code>、<code>PTR</code></p><p>不常見的還有： <code>DNSKEY</code>、<code>CAA</code>、<code>IPSECKEY</code>、<code>RRSIG</code>、<code>NSEC</code>、<code>AFSDB</code>、<code>APL</code>、<code>CDNSKEY</code>、<code>CERT</code>、<code>DCHID</code>、<code>DNAME</code>、<code>HIP</code>、<code>LOC</code>、<code>NAPTR</code>、<code>P</code>、<code>SSHFP</code> 等等</p><p>這裡我們先介紹常見的紀錄，不常見的下次再說 XDDD</p><h3 id="soa"><a href="#soa" class="direct-link">#</a> SOA</h3><p>在討論 SOA 記錄之前，我們需要先了解 DNS zone 的概念。</p><p>很多人誤以為一個網域就是一個 DNS zone，但其實 zone 是一個方便管理 DNS 記錄的分群法，或者可以說是『適合通一管理的網域們的紀錄集合』。</p><p>想像你的公司 <code>abc.com</code> 有三個子網域：<code>blog.abc.com</code>、<code>news.abc.com</code>、<code>internal.abc.com</code>，可能本來都放在同一個 DNS zone。但有一天你發現了一個問題：性質上，<code>internal.abc.com</code> 是內部網域，會需要較嚴格的權限控管，而且下面也許還有更多子網域來辨別各個內部系統；另一方面，<code>abc.com</code>、<code>blog.abc.com</code>、<code>news.abc.com</code> 都是官網上會連結到的對外網域，性質較為相近。當你想要進行設定時，要一次設置共用設定有些困難、個別處理又顯得麻煩，各個網域全部混雜在一起讓你管理變得複雜。</p><p>這時，你就會考慮將 <code>internal.abc.com</code> 獨立出來變成自己的 DNS zone，這個切分允許管理者做更精細的控制，而且日後擴展新的子網域也更方便套用設定。</p><p>所以，DNS zone 可以是一個網域、多個網域、或是一個網域以及他的數個子網域等等各種分群方式，一台 DNS 上也可以有多個 DNS zone。</p><p>每個 DNS zone 都能用一個 zone file 代表，基本上就是一個文字檔，寫著所有屬於此 DNS zone 的網域的所有紀錄。而 zone file 的第一筆必須是 SOA (Start of Authority) 紀錄，主要記載這個 zone 相關的資訊，例如管理員信箱、用來辨別是否有更新的序號、主要的 NS 等等。</p><p>此外，主要負責管理 zone file 的那一台 DNS 稱為 primary nameserver，其餘備用或是用於 load balancing 的 nameserver 稱為 secondary nameserver，只有 zone file 的唯讀權限，並且會透過一個稱為 zone transfer 的溝通過程從 primary nameserver 那裡更新 zone file。</p><p>SOA 紀錄的欄位及敘述，以 <code>example.com</code> 為範例整理成下面這張表：</p><pre class="language-txt"><code class="language-txt">example.com.		3600	IN	SOA	ns.icann.org. noc.dns.icann.org. 2021110801 7200 3600 1209600 3600</code></pre><table><thead><tr><th>欄位</th><th>值</th><th>敘述</th></tr></thead><tbody><tr><td>name</td><td><a href="http://example.com" rel="noopener noreferrer" target="_blank">example.com</a></td><td></td></tr><tr><td>record</td><td>SOA</td><td></td></tr><tr><td>MNAME</td><td><a href="http://ns.icann.org" rel="noopener noreferrer" target="_blank">ns.icann.org</a></td><td>DNS zone 的 primary nameserver</td></tr><tr><td>RNAME                  </td><td><a href="http://noc.dns.icann.org" rel="noopener noreferrer" target="_blank">noc.dns.icann.org</a>                    </td><td>管理員信箱，第一個點其實翻譯成 <code>@</code> ，所以這個例子中是 <code>noc@dns.icann.org</code></td></tr><tr><td>SERIAL</td><td>2021110801</td><td>可以想成版本序號，更動時會讓 secondary nameserver 知道該更新了</td></tr><tr><td>REFRESH</td><td>7200</td><td>secondary nameserver 詢問更新該間隔的時間</td></tr><tr><td>RETRY</td><td>3600</td><td>若 primary nameserver 沒有回應，secondary nameserver 再次詢問前該間隔的時間</td></tr><tr><td>EXPIRE</td><td>1209600</td><td>primary nameserver 多久沒有回應，secondary nameserver 該停止回應 DNS query</td></tr><tr><td>TTL</td><td>3600</td><td></td></tr></tbody></table><h3 id="a%2Faaaa"><a href="#a%2Faaaa" class="direct-link">#</a> A/AAAA</h3><p>最基本的 DNS 記錄，代表 Address，也就是實際的 IP 地址。 A 用於 IPv4 地址，AAAA 用於 IPv6 地址。</p><pre class="language-txt"><code class="language-txt">example.com.		17460	IN	A	93.184.216.34</code></pre><p>一般來說只會有一筆 A 紀錄，不過你可能在用 AWS 等第三方服務的時候會發現 <code>dig</code> 指令竟然顯示了好幾筆紀錄，這其實是實作 load balancing 的一種方法，用數個 IP 分散網站的流量。</p><pre class="language-txt"><code class="language-txt">abc.com.		60	IN	A	13.226.115.26<br>abc.com.		60	IN	A	13.226.115.14<br>abc.com.		60	IN	A	13.226.115.45<br>abc.com.		60	IN	A	13.226.115.117<br>abc.com.		300	IN	NS	ns-1368.awsdns-43.org.<br>abc.com.		300	IN	NS	ns-1869.awsdns-41.co.uk.<br>abc.com.		300	IN	NS	ns-318.awsdns-39.com.<br>abc.com.		300	IN	NS	ns-736.awsdns-28.net.<br>abc.com.		900	IN	SOA	ns-318.awsdns-39.com. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 86400</code></pre><h3 id="cname"><a href="#cname" class="direct-link">#</a> CNAME</h3><p>CNAME 指的是 canonical name，也就是標準的、真實的名稱，讓指向的網域作為別名代表自己的意思。可以想成是一條線索接著一條線索，順著指向最終的寶藏。</p><pre class="language-txt"><code class="language-txt">foo.abc.com.	21600	IN	CNAME	bar.abc.com</code></pre><p>進行 DNS lookup 的時候，如果得到 CNAME 紀錄，就會以對應的網域為目標重啟一次新的 DNS lookup，直到成功解析出 IP 為止。也因此，CNAME 紀錄跟 A 紀錄互斥，後者是直接給出網域對應的 IP，前者則是把原本的網域映射到另一個網域，等同採用對方的 DNS 紀錄。如果一個網域有 CNAME 紀錄，那麼根據 RFC ，除了使用 DNSSEC 的情況會設置 RRSIG、NSEC 的紀錄外，不能有其他的 DNS 紀錄（例如 NS、MX、TXT 等等）</p><p>你可能會困惑，如果兩個網域最後都解析到同一個 IP，那我們為什麼不刪掉其中一個就好了，反正都會是同一個網站啊？</p><p>這個問題的盲點在於，同一台機器的同一個 port 並不是只能運行一個網站，網頁伺服器是可以透過網址決定處理方式的。</p><p>假設你有 <code>blog.abc.com</code> 跟 <code>news.abc.com</code> 兩個網域，且他們都用 CNAME 紀錄指到 <code>abc.com</code>。當你 URL 輸入 <code>http://blog.abc.com/</code> 時，這個請求同樣是送到 <code>abc.com</code> 的 IP，但是網站伺服器會判斷是要存取 <code>blog.abc.com</code> 的資料而回應公司的部落格頁面。透過網站伺服器的分流，就能讓使用不同 URL 的訪客分別存取到部落格、時事、跟主網頁的資訊。而且這樣做的好處是，這三個網域都在同一台機器上，所以要變更 IP 的時候只要調整 <code>abc.com</code> 的 A 紀錄就可以確保三個都一起搬家。</p><h3 id="ns"><a href="#ns" class="direct-link">#</a> NS</h3><p>NS 指的是 name server，也就是負責解析這個網域的 Authoritative DNS，所以 NS 紀錄就代表『去這個 DNS 問可以找到你要的 IP 喔』。</p><p>如同前面介紹過的，一個 DNS zone 通常不會只有一台 DNS 在運行，所以相對的 NS 紀錄也通常會有多筆資料。這些 Authoritative DNS 就是負責這個 DNS zone 的 primary nameserver 跟 secondary nameserver 們。</p><p>你可以拿一些網域試試看，會發現往往都會在主網域下發現 SOA 紀錄跟多筆 NS 紀錄：</p><pre class="language-txt"><code class="language-txt">$ dig any onedegree.hk<br><br>;; ANSWER SECTION:<br>onedegree.hk.		21600	IN	NS	ns1-03.azure-dns.com.<br>onedegree.hk.		21600	IN	NS	ns2-03.azure-dns.net.<br>onedegree.hk.		21600	IN	NS	ns3-03.azure-dns.org.<br>onedegree.hk.		21600	IN	NS	ns4-03.azure-dns.info.<br>onedegree.hk.		3600	IN	SOA	ns1-03.azure-dns.com. azuredns-hostmaster.microsoft.com. 20200910 3600 300 2419200 300<br>...</code></pre><p>這並不是說子網域不能有 NS 紀錄，只是通常一個 DNS zone 會以一個主網域以及他下面的多個子網域構成，所以 SOA、NS 等代表整個 zone 的資訊就會掛在主要網域的下面。</p><h3 id="mx"><a href="#mx" class="direct-link">#</a> MX</h3><p>MX 指的是 mail exchange，也就是郵件伺服器，所以 MX 紀錄指示的是『負責這個網域的郵件伺服器的網域』。</p><pre class="language-txt"><code class="language-txt">onedegree.hk.		3600	IN	MX	0 onedegree-hk.mail.protection.outlook.com.</code></pre><p>當你要寄出一封信到 <code>receiver@onedegree.hk</code> 時，幫你寄信的 mail server 首先會去查找 <code>onedegree.hk</code> 的 MX 紀錄，得知信件應該送到 <code>onedegree-hk.mail.protection.outlook.com</code> 這個網域。再來才會透過 SMTP（email 專用的協議）把信送到 <code>onedegree-hk.mail.protection.outlook.com</code> 實際上的 IP 位置。沒有設置 MX 紀錄就像不告訴機長目的地的機場在哪裡，信件會完全無法發送。</p><p>為了增加維運的穩定度，MX 紀錄也可以有很多筆，但是 SOA 紀錄裡又沒有標示 primary mail server 之類的主次關係，寄信的時候怎麼知道要用哪一個結果呢？</p><p>上面的範例紀錄中，除了 TTL (<code>3600</code>) 之外還有一個寫在目標網域之前的數字 <code>0</code>，這個數字是 priority number，可以想像成是採用紀錄的優先序，所以帶有越小的數字表示越優先寄送給這個 mail server。兩個不同 priority number 的 MX 紀錄自然好懂，就是先嘗試寄給數字小的，如果失敗了再嘗試寄到數字大的。那如果兩個 MX 紀錄 有一樣大的 priority number，就是隨機採用其中一筆紀錄，做 load balancing 達到信件分流減少負載的效果。</p><h3 id="txt"><a href="#txt" class="direct-link">#</a> TXT</h3><p>TXT 指的是 text，也就是純文字的紀錄，原意是讓網管能為他的網域加一些註解，不過現在大多主要用於防範垃圾信以及驗證網域擁有權。</p><p>格式基本上沒有限制，雖然 RFC 有定義需要是由雙括號包住、等號分隔的 key-value 型態（<code>"attribute=value"</code>），但並不是所有的 TXT 紀錄都會遵守此規範。</p><p>以防範垃圾信及偽冒信來說，會設置 SPF、DKIM、DMARC 這三個目前廣泛套用的機制，利用合法發信網域宣告的 IP 位置及郵件政策來實現 email security。這三筆紀錄會在郵件驗證的時候被查詢且採用，以此保障收受信人的安全。</p><p>更詳細的介紹可以參考我之前寫過的一系列文章：</p><p><a href="https://tech-blog.cymetrics.io/posts/crystal/email-sec-theory">關於 email security 的大小事 — 原理篇</a><br><a href="https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-spf">關於 email security 的大小事 — 設定篇 SPF</a><br><a href="https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-dkimdmarc">關於 email security 的大小事 — 設定篇 DKIM、DMARC</a><br><a href="https://tech-blog.cymetrics.io/posts/crystal/email-sec-examples">關於 email security 的大小事 — 範例篇</a><br><a href="https://tech-blog.cymetrics.io/posts/crystal/email-sec-extra">關於 email security 的大小事 — 延伸篇</a></p><p>另一方面，當我們使用第三方服務，例如用 Sendgrid 替自己的網域寄信、或是希望創建出的電商頁面掛上自己的子網域名時，往往會需要先驗證網域擁有權，避免有心人士濫用服務來仿冒我們的網域。這時候廠商就可能會要求我們發一筆指定的 TXT 紀錄以茲證明，畢竟如果你真的是網域的擁有者，就應該能夠存取發佈 DNS 紀錄。這個概念就像是用某個信箱註冊服務時，必須去信箱裡點選確認信才能證明信箱真的是你的。</p><p>舉例來說，網頁為了行銷需求大多會設置 Google Analytics (GA) 來幫助 marketing 了解使用者的行為，因為這些資料也許包含過多或是敏感的商業資訊，所以 Google 為了確保能存取資料的必須是網域的擁有者，會要求用戶先驗證網域所有權，在 DNS 發佈一筆 <code>"google-site-verification=&lt;long-random-string>"</code>，然後當 Google 檢查 TXT 紀錄發現確實存在這筆指定紀錄，就可以證明是合法的網域擁有者。</p><p>下圖是 <code>onedegree.hk</code> 的一些 TXT 紀錄，你可以看到有多種驗證紀錄及 SPF 紀錄：</p><pre class="language-txt"><code class="language-txt">onedegree.hk.		3600	IN	TXT	"facebook-domain-verification=etkvd5dxxpnlcjkol3e1vi3k348k03"<br>onedegree.hk.		3600	IN	TXT	"google-site-verification=kEw0MSSQxwrU4d5GXYBTL6HLTwnQW4aJjh8Om-NTY4Q"<br>onedegree.hk.		3600	IN	TXT	"google-site-verification=EntX-1hrFmMHtANmXdTE4rpEwSxpsZGwnVUPWA9476A"<br>onedegree.hk.		3600	IN	TXT	"VXZDM75TVG5AVR81FP8ZS1Q3RTRJCPO1LFMCGU6G"<br>onedegree.hk.		3600	IN	TXT	"v=spf1 include:spf.protection.outlook.com include:servers.mcsv.net include:email.freshdesk.com -all"<br>onedegree.hk.		3600	IN	TXT	"MS=ms90944132"<br>onedegree.hk.		3600	IN	TXT	"apple-domain-verification=6dcjCOWtHHIBWjLW"<br>onedegree.hk.		3600	IN	TXT	"atlassian-domain-verification=x2gMLRLJwdsyccXscDcOrLausiFdjmV/P37fCfiKf/eEaA6l9tPsfrEadfGQsA7j"<br></code></pre><h3 id="srv"><a href="#srv" class="direct-link">#</a> SRV</h3><p>SRV 紀錄算是相對少見的一種紀錄，是為了支援特定網路協議（例如 <a href="https://en.wikipedia.org/wiki/Session_Initiation_Protocol" rel="noopener noreferrer" target="_blank">SIP</a>、<a href="https://en.wikipedia.org/wiki/XMPP" rel="noopener noreferrer" target="_blank">XMPP</a> 等多媒體或 messaging 功能）的服務 (<strong>s</strong>e<strong>rv</strong>ice) 所誕生的紀錄，定義在 <a href="https://datatracker.ietf.org/doc/html/rfc2782" rel="noopener noreferrer" target="_blank">RFC 2782</a> 中。</p><p>其他的 DNS 紀錄大多都只會含有網域名或是 IP，不過 SRV 紀錄最大的特色就是會寫出目標 port 以及使用的協議，格式為：</p><pre class="language-txt"><code class="language-txt">_service._proto.name.   TTL  class type priority weight port    target<br><br>_xmpp._tcp.example.com. 86400  IN   SRV    10       5   5223  server.example.com</code></pre><p>從上面的範例可以看到，要向 <code>example.com</code> 發起使用 TCP 的 XMPP 服務請求的話，就需要聯繫 <code>server.example.com</code> 的 5223 port。</p><p>那 priority 跟 weight 是什麼呢？跟前面提過的 MX 紀錄相似，這兩個參數都是用來調配目標伺服器的流量，只不過是分兩階段評比，先比 priority 再比 weight。也就是說，查詢到多筆 SRV 紀錄時會先看 priority 的大小，如果平手了再用 weight 一決勝負。有趣的一點是這兩個的勝負條件完全相反，priority （優先序）代表嘗試連線的順序，越小越吃香；反之 weight （權重）代表同優先序之間負載分配的比例，所以越大越有利。</p><p>下面的範例取自<a href="https://en.wikipedia.org/wiki/SRV_record" rel="noopener noreferrer" target="_blank">維基百科</a>：</p><pre class="language-txt"><code class="language-txt">_sip._tcp.example.com.   86400 IN    SRV 10       60     5060 bigbox.example.com.<br>_sip._tcp.example.com.   86400 IN    SRV 10       20     5060 smallbox1.example.com.<br>_sip._tcp.example.com.   86400 IN    SRV 10       20     5060 smallbox2.example.com.<br>_sip._tcp.example.com.   86400 IN    SRV 20       0      5060 backupbox.example.com.</code></pre><p>今天一個用戶想要連線時，會發現前三條紀錄的 priority 都是 10，所以除非前三個都連不上，否則他是不會去嘗試 priority 20 的 <code>backupbox.example.com</code> 的。再來，因為 priority 10 的比重是 60 20 20，所以代表有 60% 的請求會選擇發給 <code>bigbox.example.com</code>，剩下的再平分到 <code>smallbox1.example.com</code> 跟 <code>smallbox2.example.com</code> 這兩台機器。另外，如果 <code>bigbox.example.com</code> 沒有回應，那麼服務就會由 <code>smallbox1.example.com</code> 跟 <code>smallbox2.example.com</code> 平均分擔，各處理 50% 的流量。</p><h3 id="ptr"><a href="#ptr" class="direct-link">#</a> PTR</h3><p>PTR 紀錄可以說是 A 紀錄的對立面，A 紀錄把網域對應到 IP（用於 DNS lookup），而 PTR 紀錄則是把 IP 對應到網域（用於 reverse DNS lookup）。</p><p>PTR 紀錄也必須放在某個網域下，所以根據規範，會將 IP 反轉，然後後綴加上 <code>".in-addr.arpa"</code> 來構成網域，例如 <code>14.13.12.11</code> 就會被放在 <code>"11.12.13.14.in-addr.arpa"</code> 的網域下。如果是 IPv6，反轉後會被轉換成 4-bit 區段，並加上 <code>".ip6.arpa"</code>，如 <code>2001:db8::567:89ab</code> 會變成 <code>b.a.9.8.7.6.5.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.8.b.d.0.1.0.0.2.ip6.arpa</code>。</p><p><code>.arpa</code> 是最早創立的一個 TLD，源於網路世界草創期的先驅 Advanced Research Projects Agency (ARPA) 的縮寫，不過目前被重新定義為 Address and Routing Parameter Area (ARPA)。<code>.arpa</code> 由 IETF 用於管理網路架構，不提供網域註冊也鮮少新增子網域。</p><h2 id="%E7%B5%90%E8%AB%96"><a href="#%E7%B5%90%E8%AB%96" class="direct-link">#</a> 結論</h2><p>DNS 是網路世界的電話簿，負擔起全世界的網路流量跟導航，是每個人生活中不可或缺的一環。從 1980 年代到現在，DNS 已經有十分悠久的歷史，也經歷了多次修改與強化，然而如同多數古老的協議，最初的設計其實並沒有考量到太多資安層面，導致隨著應用範圍越來越廣、各種技術越來越進步，層出不窮的攻擊手法才使得許多潛在的資安議題浮出檯面，各種防禦也因應而生。</p><p>為了後續能介紹一些 DNS 相關的攻擊，開頭還是要先科普一下確定大家都具備基礎知識。下一篇我們會聊聊 DNS 常見的攻擊手法與相應的防禦，探討這場攻防戰的演進史。</p><p>這篇中的資訊多取自維基百科與 <a href="https://www.cloudflare.com/learning/dns" rel="noopener noreferrer" target="_blank">Cloudfare DNS Learning</a> 的介紹，Cloudfare 提供相當完整且深入的資訊，推薦給大家～</p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/crystal/dns-hacking-1/" on-click="share"><img src="/img/icons/icon_external link hyperlink.svg" alt="Share" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/dns/" class="post-tag">#DNS</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/nick/google-recaptcha/">當 Google Hacking 遇到 reCAPTCHA</a></li><li><a href="/posts/nick/sqli/">秒懂 SQL Injection</a></li><li><a href="/posts/genchilu/concurrency-paradigms-golang-and-java-zh/">並行程式典範 (Paradigms): Golang V.S. Java</a></li><li><a href="/posts/nick/shodan-fofa/">駭客起手式 : Shodan & Fofa</a></li><li><a href="/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-zh/">比較 Java 和 Golang 在撰寫併發時處理共享變數的差異</a></li></ol></div><div class="article-author"><img src="/img/authors/crystal_logo.png" alt="crystal" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/crystal">crystal</a></div><div class="article-author__intro">Security newbie with a gallon of passion</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"DNS Hacking 之 基礎知識：DNS 運作與紀錄類型","image":["https://tech-blog.cymetrics.io/img/posts/crystal/dns-hacking/dns-lookup-1920w.jpg","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/crystal_logo.png"],"author":{"@type":"Person","name":"crystal"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/crystal/dns-hacking-1/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/crystal/dns-hacking-1/","datePublished":"2021-11-25","dateModified":"2021-12-29","description":"要打掛別人的網站難道只能從網頁中的漏洞下手嗎？其實，常常被忽略的 DNS 的漏洞可能更致命，讓駭客輕輕鬆鬆接管你的網站！但首先，我們要認識 DNS 的運作機制，以及有哪些紀錄類型。 # DNS 如何運作..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/Cymetrics-100957872049641" rel="noopener noreferrer" target="_blank"><img src="/img/icons/icon_social media_facebook.svg" alt="facebook" height="30" width="30"></a><a href="https://www.linkedin.com/company/onedegree-hk" rel="noopener noreferrer" target="_blank"><img src="/img/icons/icon_social media_linkedln.svg" alt="linkedin" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img src="/img/icons/rss-feed.svg" alt="rss feed" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>