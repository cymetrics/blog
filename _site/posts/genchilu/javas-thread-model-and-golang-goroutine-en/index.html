<!DOCTYPE html><html domain=cymetrics.io ga-id=G-3VBVCXV9Z0 lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=/favicon.svg rel=icon type=image/svg+xml><meta content=#f9c412 name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>Java’s Thread Model and Golang Goroutine</title><meta content="Java’s Thread Model and Golang Goroutine" property=og:title><meta content="One of the most important features of Golang is its ability to handle high concurrency. And goroutine is the foundation to support high..." name=description><meta content="One of the most important features of Golang is its ability to handle high concurrency. And goroutine is the foundation to support high..." property=og:description><meta content=summary_large_image name=twitter:card><meta content=@ name=twitter:site><meta content=@ name=twitter:creator><meta content=hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk name=google-site-verification><link href=https://tech-blog.cymetrics.io/posts/genchilu/javas-thread-model-and-golang-goroutine-en/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="Cymetrics Tech Blog"><link href=/ rel=preconnect crossorigin=""><script async src="/js/min.js?hash=b870cb012d" defer></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #00bcb2;--primary-dark-color: #ffd349;--fgColor: #222;--bgColor: #eee;--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;padding:.375em 1.5em;background:rgba(255,255,255,.9);font-weight:200;text-align:right}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}share-widget{position:fixed;right:20px;bottom:20px;opacity:.9;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);position:fixed;opacity:.8;z-index:1000;font-size:10px}#nav{z-index:2;position:relative}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;top:0;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}h1{text-align:left;font-size:3em;line-height:1.25;margin:.67em 0 .5em;font-size:2.074rem}hr{box-sizing:content-box;height:0;overflow:visible;border-bottom:1px solid #eee}a{background-color:transparent;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}small{font-size:80%;color:#ccc}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,input{font-family:inherit;font-size:100%;line-height:1.15;overflow:visible}button{text-transform:none}input{margin:0}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=checkbox]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em}h1,h2,h3{margin-bottom:1.36rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.6rem}body,ol,p,pre{font-size:1em}ol,p,pre{margin-bottom:1.5em}h1,h2{line-height:2.4rem}h2{font-size:1.728rem}body,ol,p,pre{font-size:1rem;line-height:1.6}ol,p,pre{margin-bottom:1.36rem}@media (min-width:600px){h1{font-size:3.0978rem;line-height:1.25}h2{font-size:2.7097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,ol,p,pre{font-size:1.1rem;line-height:1.6}h1,h2,h3,ol,p,pre{margin-bottom:1.496rem}}@media (min-width:1200px){h1{font-size:3rem}h2{font-size:2.05rem}h3{font-size:1.5rem}body,ol,p,pre{font-size:1.2rem;line-height:1.6}h1,h2,h3,ol,p,pre{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){padding:1.5em;overflow-x:scroll}code{border-radius:.3em;color:var(--primary);padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}button,input{border-radius:.3em;max-width:100%}input{padding:.75em;margin-bottom:1.5em;display:inline}button+input[type=checkbox],button+label,input+input[type=checkbox],input+label,label+*{page-break-before:always}.copyright,button,label{display:inline-block}button{background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}input[type=file],input[type=number],input[type=time],input[type=url]{border:1px solid #595959;padding:.75em}input[type=checkbox]{flex-grow:0;margin:.75em .375em .75em 0;vertical-align:middle}input[type=checkbox]+label{page-break-before:avoid}*{border:0;box-sizing:border-box}body,header nav a{font-family:var(--font-family)}body{background:var(--bg);color:var(--fg)}header label{display:block}header{padding:4.5em 1.5em 3em;width:42.5em;margin:0 auto;text-align:center;max-width:100%;display:flex;align-items:center;flex-direction:column}header p,ol{margin-top:0}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;color:#181818;margin-left:1.5em}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;border-top:.5px solid #ccc;min-height:60vh}footer{font-size:14px;padding:3em;text-align:center}footer>*{margin:.5em}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:100%;padding:1.5em;width:42.5em;margin:0 auto;word-break:break-word}li ol{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#2d2d2d}.token.punctuation{color:#ccc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.builtin,.token.important,.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.important{font-weight:700}.token.inserted{color:green}.avatar{width:50px;border-radius:50%;overflow:hidden;margin:inherit}.avatar-large{width:75px}.utterances{position:relative;box-sizing:border-box;width:100%;max-width:760px;margin-left:auto;margin-right:auto}.flex{display:flex}.items-center{align-items:center}.w-full{width:100%}#menu__control,.menu__btn{display:none}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}nav a:hover{color:#595959}@media screen and (max-width:960px){#nav .nav__links a{margin-right:.5rem;margin-left:.5rem}}@media screen and (max-width:840px){header nav{padding:0}#nav,.menu__btn{position:relative}#nav h1{padding:.375rem 1.5rem;justify-content:space-between}#nav h1 *{margin:0}.menu__btn{display:inline-block;width:1.5rem;height:1.5rem;border:1px solid #191919;border-radius:.3rem}.menu__btn::before{content:"";position:absolute;top:51%;left:50%;transform:translate(-50%,-50%);height:.1rem;width:.9rem;background-color:#2d2d2d;border-radius:.1rem;box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn:hover{filter:brightness(.6)}#nav h1,.nav__links{display:flex;align-items:center;width:100%}.nav__links{flex-direction:column;justify-content:center;height:0;max-height:0;overflow:hidden;position:absolute;top:2.24em;transition:max-height .6s ease;margin:0;padding:0;z-index:-1;background:rgba(255,255,255,.9)}.nav__links a{text-align:center;width:100%;padding:.5rem 0;transition:all .3s ease-out}.nav__links a:hover{color:#f9c412;background:rgba(245,245,245,.9)}#menu__control:checked+.nav__links{height:auto;max-height:100vh}}#rss{vertical-align:text-top}#nav{display:flex}#color-scheme-toggle{cursor:pointer;vertical-align:text-top;display:inline-block;margin-right:1em}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}}.posts{max-width:100%}.post{display:flex;margin-bottom:1em;padding:1em 0}.summary{font-size:1rem;line-height:1.25rem;margin:.5em 0;overflow:hidden;word-break:break-word}@media (max-width:480px){.post{padding:0}.summary{display:none}}</style></head><body><header><nav><div id=nav><h1><a href=/ title=Homepage>Cymetrics Tech Blog</a> <label class=menu__btn for=menu__control><span>Menu</span></label></h1><img alt="switch dark mode" height=22 src=/img/dark.svg width=22 id=color-scheme-toggle> <input id=menu__control type=checkbox><div class=nav__links><a href=/posts/ >Archive</a> <a href=/tags/ >Tags</a> <a href=/about/ >About</a></div></div><div id=reading-progress aria-hidden=true></div></nav><h1 class=w-full>Java’s Thread Model and Golang Goroutine</h1><aside class=w-full><div class="flex items-center"><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/genchilu_logo-1920w.avif 1920w, /img/authors/genchilu_logo-1280w.avif 1280w, /img/authors/genchilu_logo-640w.avif 640w, /img/authors/genchilu_logo-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/genchilu_logo-1920w.webp 1920w, /img/authors/genchilu_logo-1280w.webp 1280w, /img/authors/genchilu_logo-640w.webp 640w, /img/authors/genchilu_logo-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/genchilu_logo-1920w.jpg 1920w, /img/authors/genchilu_logo-1280w.jpg 1280w, /img/authors/genchilu_logo-640w.jpg 640w, /img/authors/genchilu_logo-320w.jpg 320w" type=image/jpeg><img alt=avatar height=360 src=/img/authors/genchilu_logo-1920w.jpg width=640 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 640 360'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAxUlEQVQI1wG6AEX/ADMiKHJoYYxqYjAeIxcWFyoXHy8dJx8dI0k5OD01PQBLOC2bfmN4XklbOCNbNB5RNCE1Ix5DLSJmTjxwXU4AW0EwaE46SCgaakMnoW9Cd08vOyAWVz4vZUgyhGdLAJRxSJxjLFYtF1MwHm0/JGA3ImM2G6hvMotpQIBmSgC6VQl2NQcTDhRpOBehUxl/RxwVDBFfKAa8WAt4VjUAqmIorGAcnk8Sm04OqncmqVYOmUwOmVAZsG0wekwrhjMzcLKXvw0AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)" class=avatar></picture><span style="margin-left: 12px;"><a href=/posts/genchilu>genchilu</a> published on 2021-07-05</span></div><div style="text-align: left;"><a href=/tags/java/ class=post-tag>#java</a> <a href=/tags/golang/ class=post-tag>#golang</a> <a href=/tags/thread/ class=post-tag>#thread</a> <a href=/tags/goroutine/ class=post-tag>#goroutine</a> <a href=/tags/concurrency/ class=post-tag>#concurrency</a></div></aside><dialog id=message></dialog></header><main><article><p>One of the most important features of Golang is its ability to handle high concurrency. And goroutine is the foundation to support high concurrency. This article will briefly explain how Java’s thread model and Golang’s goroutine work in OS. And I believe you will be impressive in the principle behind goroutine. Let’s go!</p><h1 id=java-thread-model><a href=#java-thread-model class=direct-link>#</a> Java Thread Model</h1><p>Java uses native thread in OS. That is every Java thread mapping to one kernel thread. Java can not determine which thread would occupy the core, it is completely dependent on OS’s scheduler.</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-1920w.avif 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-1280w.avif 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-640w.avif 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-1920w.webp 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-1280w.webp 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-640w.webp 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-1920w.jpg 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-1280w.jpg 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-640w.jpg 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-320w.jpg 320w" type=image/jpeg><img alt="" height=251 src=/img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-1920w.jpg width=746 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 746 251'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAECAIAAADahiLjAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAXklEQVQI112NOQ4EIQwE+f8ryUk4RoANhi15pQmmg1apfXSIMdZaH9daC+69i0gpBR9jAORBVc0MAu696jrnsIQzAsiDucT1wt6bTzj3AHlIKc05W2uf3pzzvxcg/wElXpcDgLDfvAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Below is a simple java code that creates 1000 threads and does nothing:</p><pre class=language-java><code class=language-java><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">1000</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">{</span><br>            <span class="token keyword">try</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>I run this code in my Linux VM and use ps command to monitor the number of threads. It shows that the Java process creates about 1018 threads (Java creates about 18 threads to maintain JVM system, like GC.)</p><pre class=language-bash><code class=language-bash>**g7@g7test1**:**~**$ <span class="token function">ps</span> -T <span class="token number">102763</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<br><br><span class="token number">1018</span></code></pre><p>However, with the advent of technology, it becomes more common for people to connect to the internet, we all want our server could support high concurrency to serve our customers. But the thread — ever called lightweight process — becomes too heavy to support high concurrency. Why?</p><h2 id=problem-of-thread><a href=#problem-of-thread class=direct-link>#</a> Problem of Thread</h2><ol><li>Memory size<br>Every time Java creates a thread, Java would allocate a fixed memory size as that thread’s stack. The number of threads would be limit by OS’s memory and SWAP size, even if your Java application does not use that much memory.<br>You can use -Xss JVM option to the specific memory size of the stack used by each thread. But JVM would not run up if you specify too small memory size. Take my laptop, for example, JVM would crash if I set memory size smaller than 135k.</li><li>The Cost of Create Thread and Context Switch<br>When the number of threads exceeds the number of cores, OS would arrange core to run each thread as fairs as it can through the scheduler. When one core switches one thread to another thread, it would store the current thread’s state, load another thread’s state and run it. That is the so-called context switch.<br>But one thing you must know is that context switch is also cost. If there are too many threads, your core would spend too much time in context switch. Thus it would decrease your system’s throughput.</li></ol><p>Let’s see an actual example to show how expensive thread is. Below is a simple Java code, it uses ExecutorService with a fixed number thread pool to run the function doSomething 200000 times.</p><pre class=language-java><code class=language-java><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">int</span> anInt <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span><br>    <span class="token keyword">int</span> threadNum <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>threadNum<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">200000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    executorService<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>I run the code with the number of threads from 100 to 9900 and record the time it runs:</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-1920w.avif 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-1280w.avif 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-640w.avif 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-1920w.webp 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-1280w.webp 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-640w.webp 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-1920w.jpg 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-1280w.jpg 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-640w.jpg 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-320w.jpg 320w" type=image/jpeg><img alt="" height=748 src=/img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-1920w.jpg width=1206 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1206 748'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAbUlEQVQI1yWOQQ4AIQgD+f9nTVREhcpWtwdSmcYiZtZaA+DuiCua7THMx3ThQ1XPSQ/YwljQGW8ikFJrVbW1z1z8AAwFcK6QeaT3PsZI2nO3F+E3xCksI/67b/0zXO69GRI8rSeeWUphmoye+AP1irAYXCllhAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>You can see that it take more time to finish the process if Java creates more thread. Let dig deep into what happened by profiling CPU. When the number of threads is set to 100, about 51% of CPU time is spent in function <strong>doSomething:</strong></p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-1920w.avif 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-1280w.avif 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-640w.avif 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-1920w.webp 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-1280w.webp 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-640w.webp 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-1920w.jpg 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-1280w.jpg 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-640w.jpg 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-320w.jpg 320w" type=image/jpeg><img alt="" height=372 src=/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-1920w.jpg width=1400 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1400 372'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAECAIAAADec/LeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkUlEQVQI12P4jwX8AyMsgOH/779YhP/++/fr94fvb97/eP3q0/PXX56/+fry3ddnDM9eXPv/49ff71//ff/29+tXIPrz9dO228tnHK2bfLtu5ovmKQ/qZjxvnPW6ee7bNobjW+bcm7fg2bIlQPRq9YoP69Y827Ry9eG+Fad6Nl2YsuP2zN0P5+y6PxuIdt6bBQDHJJz0Z+TWDgAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>And we increase the number of threads to 9900, the CPU time spent in function <strong>doSomething</strong> is down to about 27%.</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-1920w.avif 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-1280w.avif 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-640w.avif 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-1920w.webp 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-1280w.webp 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-640w.webp 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-1920w.jpg 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-1280w.jpg 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-640w.jpg 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-320w.jpg 320w" type=image/jpeg><img alt="" height=529 src=/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-1920w.jpg width=1400 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1400 529'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmElEQVQI12P4Dwf//v3HBf79Y/gHk0ZW9u8/jPPvL1Di359fDP/BQr8/vPh2cd3/X98Rcv/+/f7z58/vH0CBb4/vM9y7fezwwkmnZzefmB/75sUlkLI/v47f3b7gyoQlD6fsfb3qyuIFR4sKGNbu7Zq2vWTRgfpFZ1tO7Zn3eu2Gt1s2LtnZMONw1eJLrRtOdpysq7zW3QkALUaqLRN5FPQAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>All of the metrics tell us the cost of the thread makes Java’s thread model suffer in the high concurrency scenario.</p><h1 id=how-goroutine><a href=#how-goroutine class=direct-link>#</a> How Goroutine</h1><p>Compare to Java, Golang does not use OS’s native thread. Instead, Golang implements its scheduler, arrange goroutines to run spread between a fixed number of threads.</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-1920w.avif 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-1280w.avif 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-640w.avif 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-1920w.webp 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-1280w.webp 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-640w.webp 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-1920w.jpg 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-1280w.jpg 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-640w.jpg 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-320w.jpg 320w" type=image/jpeg><img alt="" height=331 src=/img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-1920w.jpg width=956 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 956 331'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfUlEQVQI1zWMSQ6EIBBFuf8diW4kEIJAVCYB+0XTf1GpPwrvvZTyOI5937XWxphlWa7rgqaUeu/rulprBTzGiBFCqLUibduWcy6lUG6tKaWcc4ISEvw8z/u+KXw2lDR7UB4xxiDKrS+IcqFfaM75vBCoVBlgqbzg+fawnj9++d66f2twHjwAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Every thread would switch one goroutine to another goroutine in about 10ms. And the basic police for a thread to pick a goroutine is:</p><ol><li>pick a goroutine from a FIFO per-thread local queue</li><li>pick a goroutine from a global FIFO queue</li><li>steal a goroutine from another thread’s local queue (work-stealing)</li></ol><blockquote><p>Golang uses GOMAXPROCS parameter to determine how many threads to use in Golang application. The default value is the number of cores.</p></blockquote><p>To be more specific, let’s run the below go code and monitor the numbers of threads:</p><pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		<span class="token keyword">go</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>It shows up that the number of threads is between 4~6.</p><pre class=language-bash><code class=language-bash>**g7@g7test1**:**~**$ <span class="token function">ps</span> -T <span class="token number">1013506</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<br><br><span class="token number">5</span></code></pre><h2 id=goroutine%E2%80%99s-memory><a href=#goroutine%E2%80%99s-memory class=direct-link>#</a> Goroutine’s Memory</h2><p>Golang would allocate 4k memory to goroutine in the very beginning. As Goroutine uses more and more memory, Golang would dynamically scale up the stack size. That’s to say the number of goroutines is also bound by the size of memory, but not as suffer as Java’s thread.</p><h2 id=blocking-system-call><a href=#blocking-system-call class=direct-link>#</a> Blocking System Call</h2><p>Since goroutines are run between threads, what if a thread were blocked by a blocking system call, like file IO?</p><p>Let’s see the below graph, if three of four threads are blocked, would Golang’s throughput be impacted because there was only one thread serve Goroutine?</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-1920w.avif 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-1280w.avif 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-640w.avif 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-1920w.webp 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-1280w.webp 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-640w.webp 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-1920w.jpg 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-1280w.jpg 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-640w.jpg 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-320w.jpg 320w" type=image/jpeg><img alt="" height=371 src=/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-1920w.jpg width=956 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 956 371'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAFCAIAAAD+GJp4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAcklEQVQI1z2OSQoFIQxEc/9TqgsFFf3OOGD/QumuRai8SjQUQmCMlVK01tZaIYT3PsYIMsbgnMOTcy6lBIRaa1VKgSLOOffepZTgBNdaA8XcnPNm7WithTVAujF6UPQ3u/55RfNo741/cd/vCO8ZY76hP6wYrDzlaf+0AAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>The answer is NO. To solve this problem, Golang design processor to separate goroutine.</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-1920w.avif 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-1280w.avif 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-640w.avif 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-1920w.webp 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-1280w.webp 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-640w.webp 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-1920w.jpg 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-1280w.jpg 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-640w.jpg 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-320w.jpg 320w" type=image/jpeg><img alt="" height=431 src=/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-1920w.jpg width=956 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 956 431'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAFCAIAAAD+GJp4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAY0lEQVQI102NSQ7AIAwD8/+HcqgqdgphrZWqiDlYSeQBWmvdQkrJWnsJRWBmpZRzjlDy3mP/0hijtcYQQqi1Qo4xEoqPkHPGY+cMf4wx56TeOwutNSTsnfOH4OF7qLgiy8EuvTvQrX3JkL3hAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>If a thread was blocked by a system call, Golang would create a new thread and handoff the whole processor to the new thread. Thus the processor can keep serving goroutine, and the blocking thread could keep waiting system call to finish.</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-1920w.avif 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-1280w.avif 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-640w.avif 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-1920w.webp 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-1280w.webp 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-640w.webp 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-1920w.jpg 1920w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-1280w.jpg 1280w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-640w.jpg 640w, /img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-320w.jpg 320w" type=image/jpeg><img alt="" height=461 src=/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-1920w.jpg width=956 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 956 461'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAIAAAAcxIEBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAbElEQVQI1z2OSQpEIQwFc/9ruvGLE6jfGbuw6a5FCOFVEjnnWGudcymlGKNSKoRQa+29G2O01rL3zjm31qhjDO/9e2FCRROM9gMPm1wphf5cZK3FqF/mnOTmWu+j0TG4IN/4Hzbj8A3PYdJ/AF78nmMcg7nyAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Here is a simple Golang code, create 1000 goroutine to read big file:</p><pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">readBigFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	fi<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"bigfile"</span><span class="token punctuation">)</span><br>	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span><br>		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">defer</span> fi<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span><br>	<span class="token keyword">for</span> <span class="token punctuation">{</span><br>		n<span class="token punctuation">,</span> err <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><br>		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&&</span> err <span class="token operator">!=</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span><br>			<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>		<span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">==</span> n <span class="token punctuation">{</span><br>			<span class="token keyword">break</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>		<span class="token keyword">go</span> <span class="token function">readBigFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><br><br>	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>After running it in my Linux VM, ps command show up that the number of threads increasing to 130~200:</p><pre class=language-bash><code class=language-bash>**g7@g7test1**:**~**$ <span class="token function">ps</span> -T <span class="token number">1013506</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<br><br><span class="token number">142</span></code></pre><p>So that if you use lots of goroutine to call blocking system call, the concurrency may degrade as Java’s thread model.</p><blockquote><p>If you want to know more about goroutine scheduler，please refer <a href="https://www.youtube.com/watch?v=-K11rY57K7k&t=316s&ab_channel=Hydra" target=_blank>Go scheduler: Implementing language with lightweight concurrency</a>。</p></blockquote><h1 id=conclusion><a href=#conclusion class=direct-link>#</a> Conclusion</h1><p>So far we had discussed the challenge Java’s thread model meet in high concurrency scenario and how Golang’ goroutine solve these issue. Does that mean Java is powerless in high concurrency?</p><p>Of Course NO. There is an ongoing project name <a href=https://blogs.oracle.com/javamagazine/going-inside-javas-project-loom-and-virtual-threads target=_blank>Loom Project</a>, it’s purpose is to implement a mechanism like goroutine in JVM. Maybe in the next Java LTS version, we could handle high concurrency in JVM gracefully, just like goroutine.</p><p>By the way, what makes me feel interesting is that before Java 1.2, Java uses green thread which runs virtual thread on OS thread just like goroutine. But green thread suffers some performance issues in multi-core environment. That’s why Java decide to use native afterJava 1.3.</p><p>I wonder that if OS could provide some concurrency mechanism one day as goroutine does, would programing language switch to use native mechanism instead of implementing their scheduler?</p><hr><p></p><h3>Author</h3><div class="flex items-center"><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/genchilu_logo-1920w.avif 1920w, /img/authors/genchilu_logo-1280w.avif 1280w, /img/authors/genchilu_logo-640w.avif 640w, /img/authors/genchilu_logo-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/genchilu_logo-1920w.webp 1920w, /img/authors/genchilu_logo-1280w.webp 1280w, /img/authors/genchilu_logo-640w.webp 640w, /img/authors/genchilu_logo-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/genchilu_logo-1920w.jpg 1920w, /img/authors/genchilu_logo-1280w.jpg 1280w, /img/authors/genchilu_logo-640w.jpg 640w, /img/authors/genchilu_logo-320w.jpg 320w" type=image/jpeg><img alt=avatar height=360 src=/img/authors/genchilu_logo-1920w.jpg width=640 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 640 360'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAxUlEQVQI1wG6AEX/ADMiKHJoYYxqYjAeIxcWFyoXHy8dJx8dI0k5OD01PQBLOC2bfmN4XklbOCNbNB5RNCE1Ix5DLSJmTjxwXU4AW0EwaE46SCgaakMnoW9Cd08vOyAWVz4vZUgyhGdLAJRxSJxjLFYtF1MwHm0/JGA3ImM2G6hvMotpQIBmSgC6VQl2NQcTDhRpOBehUxl/RxwVDBFfKAa8WAt4VjUAqmIorGAcnk8Sm04OqncmqVYOmUwOmVAZsG0wekwrhjMzcLKXvw0AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)" class="avatar avatar-large"></picture><h3 style="margin-left: 12px;"><a href=/posts/genchilu>genchilu</a></h3></div><p>I am Genchi, a backend engineer in Taiwan.</p><p></p><p><a href=https://tech-blog.cymetrics.io/posts/genchilu/javas-thread-model-and-golang-goroutine-en/ on-click=share>Share this post</a></p><script async src=https://utteranc.es/client.js crossorigin=anonymous id=utterance-script issue-term=title label=utterance repo=cymetrics/blog theme=github-light></script><share-widget><button aria-label=Share href=https://tech-blog.cymetrics.io/posts/genchilu/javas-thread-model-and-golang-goroutine-en/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Java’s Thread Model and Golang Goroutine","image":["https://tech-blog.cymetrics.io/img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3-1920w.jpg","https://tech-blog.cymetrics.io/img/authors/genchilu_logo-1920w.jpg"],"author":"genchilu","genre":"Insert a schema.org genre","publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","logo":{"@type":"ImageObject","url":"/img/favicon/favicon-192x192.png?hash=42b087227d"}},"url":"https://tech-blog.cymetrics.io/posts/genchilu/javas-thread-model-and-golang-goroutine-en/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/genchilu/javas-thread-model-and-golang-goroutine-en/","datePublished":"2021-07-05","dateModified":"2021-07-23","description":"One of the most important features of Golang is its ability to handle high concurrency. And goroutine is the foundation to support high..."}</script></article></main><footer><div class=copyright>© 2021 Cymetrics Tech Blog</div><a href=https://tech-blog.cymetrics.io/feed/feed.xml id=rss><img alt="rss feed" height=18 src=/img/rss-feed.svg width=18></a></footer><script>// light/dark theme switch
      const toggleEl = document.querySelector('#color-scheme-toggle')
      const bodyEl = document.querySelector('body');
      const DARK = 'dark';
      const LIGHT = 'light';
      const currentTheme = localStorage.getItem("theme") ||
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : LIGHT);
      setTheme(currentTheme)

      toggleEl.addEventListener("click", handleToggleEvent)

      function handleToggleEvent(){
        const isDark = bodyEl.classList.toggle(DARK);
        const theme = isDark ? DARK : LIGHT;
        setTheme(theme)
        localStorage.setItem('theme', theme);
      }
      function setTheme(theme){
        if (theme === DARK) {
          setUtterancesTheme(DARK)
          bodyEl.classList.add(DARK);
          toggleEl.src = toggleEl.src.replace(DARK, LIGHT);
        }else{
          setUtterancesTheme(LIGHT)
          toggleEl.src = toggleEl.src.replace(LIGHT, DARK);
        }
      }

      var isUtterancesLoaded = false
      window.addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') {
          return;
        }
        isUtterancesLoaded = true
      });

      function setUtterancesTheme(theme) {
        let utterancesIframe = document.querySelector('.utterances iframe')
        if (!isUtterancesLoaded) {
          return requestAnimationFrame(() => setUtterancesTheme(theme))
        }

        utterancesIframe.contentWindow.postMessage({
          type: 'set-theme',
          theme: theme === DARK ? 'github-dark-orange' : 'github-light'
        }, 'https://utteranc.es');
      }</script></body></html>