<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>Sensitive Data Disclosure in WordPress Plugin Amelia &lt; 1.0.49</title><meta content="Sensitive Data Disclosure in WordPress Plugin Amelia < 1.0.49" property="og:title"><meta content="Sensitive Data Disclosure in WordPress Plugin Amelia < 1.0.49" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="Amelia is a WordPress plugin for booking systems developed by TNS. With 40,000+ active installations, it has been used for the clinic, hair salon, tutor, and so on.In March, we studied the source code of Amelia and found three vulnerabilities in the end" name="description"><meta content="Amelia is a WordPress plugin for booking systems developed by TNS. With 40,000+ active installations, it has been used for the clinic, hair salon, tutor, and so on.In March, we studied the source code of Amelia and found three vulnerabilities in the end" name="twitter:description"><meta content="Amelia is a WordPress plugin for booking systems developed by TNS. With 40,000+ active installations, it has been used for the clinic, hair salon, tutor, and so on.In March, we studied the source code of Amelia and found three vulnerabilities in the end" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/en/posts/huli/amelia-wordpress-plugin-sensitive-data-exposure-detail/" property="og:url"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/cover-en.png" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/cover-en.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://tech-blog.cymetrics.io/en/posts/huli/amelia-wordpress-plugin-sensitive-data-exposure-detail/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],[type=reset],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,ol,p,pre,ul{font-size:1em}ol,p,pre,ul{margin-bottom:1.5em}body,ol,p,pre,ul{font-size:1rem;line-height:1.6}ol,p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,ol,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}body,ol,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.632rem}}table{display:table}code,pre,table{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol,li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.namespace{color:#e2777a}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property{color:#f8c555}.token.important,.token.keyword{color:#cc99cd}.token.string,.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/en" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/en/archive/">Archive</a> <a href="/en/tags/">Tags</a> <a href="/en/about/">About</a> <a href="/" style="white-space:nowrap;">中文</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">Sensitive Data Disclosure in WordPress Plugin Amelia &lt; 1.0.49</h1><aside class="w-full"><div class="post-tags"><a href="/en/tags/postsen/" class="post-tag">#postsEn</a> <a href="/en/tags/security/" class="post-tag">#Security</a></div><div class="post-avatar"><img alt="huli" src="/img/authors/huli_logo.jpg" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/en/posts/huli">huli</a></div><div class="post-avatar__time">30 Mar 2022</div></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p><a href="https://tw.wordpress.org/plugins/ameliabooking/" rel="noopener noreferrer" target="_blank">Amelia</a> is a WordPress plugin for booking systems developed by TNS. With 40,000+ active installations, it has been used for the clinic, hair salon, tutor, and so on.</p><p>In March, we studied the source code of Amelia and found three vulnerabilities in the end:</p><ul><li><code>CVE-2022-0720</code> Amelia &lt; 1.0.47 - Customer+ Arbitrary Appointments Update and Sensitive Data Disclosure (CVSS 6.3)</li><li><code>CVE-2022-0825</code> Amelia &lt; 1.0.49 - Customer+ Arbitrary Appointments Status Update (CVSS 6.3)</li><li><code>CVE-2022-0837</code> Amelia &lt; 1.0.48 - Customer+ SMS Service Abuse and Sensitive Data Disclosure (CVSS 5.4)</li></ul><p>By exploiting these vulnerabilities, a malicious actor could get all the customer's data, including name, phone, and booking details.</p><p>In this article, I will talk about the code structure of Amelia and the details of three vulnerabilities.</p><h2 id="a-brief-introduction-to-amelia"><a href="#a-brief-introduction-to-amelia" class="direct-link">#</a> A Brief Introduction to Amelia</h2><p>After installing Amelia plugin, the admin can create a new booking page:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-320w.png 320w" type="image/png"><img alt="intro1" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1920w.png" height="1032" width="1514" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1514 1032'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAIAAACepSOSAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAs0lEQVQImQGoAFf/AM7k+X+48YW67oS47Ia36YK05YGy4nus3dLi8gCcx/IAbd8GcdoFbdQMb9ABZMYCX8AAVLWkxOMAo8rwDnXbGnnXF3XRFnDKE2zEE2m/B161qsfjAJ/H7gdu1BRz0RBtyQxowwxlvQphtwBWrafE4AClyewUcs8gd8sdcsUabr8ZaroYZ7UMXKqsxuAA9vj76e/15+315ez05e305Ozz5+3z6O3z9/j6AZNi4ASqriAAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>As a customer, basic personal information like name and email should be provided before making a booking:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-320w.png 320w" type="image/png"><img alt="intro2" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1920w.png" height="1714" width="1686" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1686 1714'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfElEQVQImVXOwQ6CQAwEUP7/r/wO0YMQoArBXZawFtohgxy0t+nrJC2qIQ+TAuglPtsAwM3cvShlbsYMIKUcwkxwNzPCtRkBA6DK6gk3SXWfmMFxwE7o0kMi747tL8TqNX3hr1F2sSYwr3yH2wPaIO8FwPJZL3fVjbXNbAd3ornG07e+XAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>After the customer finished booking, Amelia will create a new low-privilege account for it and send a reset password email to enable the account.</p><p>Then, the customer can log into WordPress and manage their bookings:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-320w.png 320w" type="image/png"><img alt="intro3" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1920w.png" height="1222" width="2526" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2526 1222'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAIAAAAcxIEBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmklEQVQImWXKqQ7CQBCA4X0DUA2hQSDRWBSah8LiUJzVWF6EcPRuCG/A1W13tjOzdAkg+fLLX3T7w/Fkmp0vu/3hePL9IPwVhFEUJ0maid5g5G221lokrm1t/4iW21ksV9ZapYA+GBGRCJHJvMgY0XDc2feQJZQVIRKzQWI0TE/J90I0nfZ87clCxkmaawIFWlcAugRQt0d1zd9UL4o7NzkNOgAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h2 id="how-wordpress-plugin-works-and-the-code-structure-of-amelia"><a href="#how-wordpress-plugin-works-and-the-code-structure-of-amelia" class="direct-link">#</a> How WordPress Plugin Works and the Code Structure of Amelia</h2><p>When developing a WordPress plugin, the developer uses <code>add_action</code> to add a hook to the WordPress system. The hook function will be invoked when the corresponding action has been called.</p><p>The action starts with <code>wp_ajax_nopriv_</code> can be invoked via <code>wp-admin/admin-ajax.php</code>, following is the excerpt of <a href="https://github.com/WordPress/WordPress/blob/master/wp-admin/admin-ajax.php" rel="noopener noreferrer" target="_blank">admin-ajax.php</a>:</p><pre class="language-php"><code class="language-php"><span class="token language-php php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token variable">$action</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">is_user_logged_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// If no action is registered, return a Bad Request response.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">has_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$action</span><span class="token punctuation">}</span></span>"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">wp_die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token number">400</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">/**<br>   * Fires authenticated Ajax actions for logged-in users.<br>   *<br>   * The dynamic portion of the hook name, `$action`, refers<br>   * to the name of the Ajax action callback being fired.<br>   *<br>   * @since 2.1.0<br>   */</span><br>  <span class="token function">do_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$action</span><span class="token punctuation">}</span></span>"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>  <span class="token comment">// If no action is registered, return a Bad Request response.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">has_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_nopriv_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$action</span><span class="token punctuation">}</span></span>"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">wp_die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token number">400</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">/**<br>   * Fires non-authenticated Ajax actions for logged-out users.<br>   *<br>   * The dynamic portion of the hook name, `$action`, refers<br>   * to the name of the Ajax action callback being fired.<br>   *<br>   * @since 2.8.0<br>   */</span><br>  <span class="token function">do_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_nopriv_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$action</span><span class="token punctuation">}</span></span>"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token delimiter important">?></span></span></code></pre><p>Amelia registered two hooks in <code>ameliabooking.php</code>:</p><pre class="language-php"><code class="language-php"><span class="token comment">/** Isolate API calls */</span><br><span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_ajax_wpamelia_api'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AmeliaBooking\Plugin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wpAmeliaApiCall'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_ajax_nopriv_wpamelia_api'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AmeliaBooking\Plugin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wpAmeliaApiCall'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The difference between <code>wp_ajax_wpamelia_api</code> and <code>wp_ajax_nopriv_wpamelia_api</code> is that the former requires authenticated user to perform the action, while the latter requires none.</p><p>As you can see, many plugins choose to handle both actions in the same place, to deal with the permission check itself.</p><p>In <code>wpAmeliaApiCall</code>, a few routes have been registered:</p><pre class="language-php"><code class="language-php"><span class="token comment">/**<br> * API Call<br> *<br> * @throws \InvalidArgumentException<br> */</span><br><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function function-definition">wpAmeliaApiCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        <span class="token comment">/** @var Container $container */</span><br>        <span class="token variable">$container</span> <span class="token operator">=</span> <span class="token keyword">require</span> <span class="token constant">AMELIA_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/src/Infrastructure/ContainerConfig/container.php'</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$app</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">App</span><span class="token punctuation">(</span><span class="token variable">$container</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Initialize all API routes</span><br>        <span class="token class-name static-context">Routes</span><span class="token operator">::</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token variable">$app</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'ERROR: '</span> <span class="token operator">.</span> <span class="token variable">$e</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>There are a few files in <code>src/Infrastructure/Routes</code> folder for handling routing. For example, <code>src/Infrastructure/Routes/User/User.php</code> is responsible for the routing of <code>/users</code>:</p><pre class="language-php"><code class="language-php"><span class="token comment">/**<br> * Class User<br> *<br> * @package AmeliaBooking\Infrastructure\Routes\User<br> */</span><br><span class="token keyword">class</span> <span class="token class-name class-name-definition">User</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/**<br>     * @param App $app<br>     */</span><br>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function function-definition">routes</span><span class="token punctuation">(</span><span class="token class-name type-declaration">App</span> <span class="token variable">$app</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/wp-users'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetWPUsersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/authenticate'</span><span class="token punctuation">,</span> <span class="token class-name static-context">LoginCabinetController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/logout'</span><span class="token punctuation">,</span> <span class="token class-name static-context">LogoutCabinetController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Customers</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCustomersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/delete/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/effect/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetUserDeleteEffectController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/reauthorize'</span><span class="token punctuation">,</span> <span class="token class-name static-context">ReauthorizeController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Providers</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetProvidersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/status/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateProviderStatusController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/delete/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/effect/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetUserDeleteEffectController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Current User</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/current'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCurrentUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Usually, the routing is related to the URL path directly, but Amelia is a bit different because it's a WordPress plugin.</p><p>In Amelia, it's based on the query string, instead of the path of URL(<code>src/Infrastructure/ContainerConfig/request.php</code>):</p><pre class="language-php"><code class="language-php"><span class="token language-php php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Uri</span><span class="token punctuation">;</span><br><br><span class="token variable">$entries</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'request'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified type-declaration">AmeliaBooking<span class="token punctuation">\</span>Infrastructure<span class="token punctuation">\</span>Common<span class="token punctuation">\</span>Container</span> <span class="token variable">$c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token variable">$curUri</span> <span class="token operator">=</span> <span class="token class-name static-context">Uri</span><span class="token operator">::</span><span class="token function">createFromEnvironment</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'environment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// Note: AMELIA_ACTION_SLUG = "action=wpamelia_api&call="</span><br>    <span class="token variable">$newRoute</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><br>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'XDEBUG_SESSION_START=PHPSTORM&'</span> <span class="token operator">.</span> <span class="token constant">AMELIA_ACTION_SLUG</span><span class="token punctuation">,</span> <span class="token constant">AMELIA_ACTION_SLUG</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><br>        <span class="token variable">$curUri</span><span class="token operator">-></span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$newPath</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">substr</span><span class="token punctuation">(</span><br>        <span class="token variable">$newRoute</span><span class="token punctuation">,</span><br>        <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token variable">$newRoute</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$newQuery</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">substr</span><span class="token punctuation">(</span><br>        <span class="token variable">$newRoute</span><span class="token punctuation">,</span><br>        <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><br>    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span><br><br>   <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token class-name static-context">Request</span><span class="token operator">::</span><span class="token function">createFromEnvironment</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'environment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>       <span class="token operator">-></span><span class="token function">withUri</span><span class="token punctuation">(</span><br>           <span class="token variable">$curUri</span><br>               <span class="token operator">-></span><span class="token function">withPath</span><span class="token punctuation">(</span><span class="token variable">$newPath</span><span class="token punctuation">)</span><br>               <span class="token operator">-></span><span class="token function">withQuery</span><span class="token punctuation">(</span><span class="token variable">$newQuery</span><span class="token punctuation">)</span><br>       <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">method_exists</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'getParam'</span><span class="token punctuation">)</span> <span class="token operator">&&</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'showAmeliaErrors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'display_errors'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'display_startup_errors'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token constant">E_ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$request</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre><p>For example, when the request URL is <code>/wordpress/wp-admin/admin-ajax.php?action=wpamelia_api&call=/users/wp-users</code>, query string is <code>action=wpamelia_api&call=/users/wp-users</code>. After AMELIA_ACTION_SLUG has been replaced with empty string, the remaining part is <code>/users/wp-users</code>, that's how the system handles routes.</p><p>Let's check <code>GetWPUsersController::class</code>, the corresponding controller for <code>/users/wp-users</code>:</p><pre class="language-php"><code class="language-php"><span class="token language-php php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token keyword">namespace</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>User</span><span class="token punctuation">;</span><br><br><span class="token keyword">use</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Commands<span class="token punctuation">\</span>User<span class="token punctuation">\</span>GetWPUsersCommand</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * Class GetWPUsersController<br> *<br> * @package AmeliaBooking\Application\Controller\User<br> */</span><br><span class="token keyword">class</span> <span class="token class-name class-name-definition">GetWPUsersController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/**<br>     * Instantiates the Get WP Users command to hand it over to the Command Handler<br>     *<br>     * @param Request $request<br>     * @param         $args<br>     *<br>     * @return GetWPUsersCommand<br>     * @throws \RuntimeException<br>     */</span><br>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function function-definition">instantiateCommand</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$command</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetWPUsersCommand</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'role'</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'role'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$requestBody</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getParsedBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">setCommandFields</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">,</span> <span class="token variable">$requestBody</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">return</span> <span class="token variable">$command</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></span></code></pre><p>We can see a classic design pattern here: Command Pattern, every action is a command. The command will be processed by its parent class <code>AmeliaBooking\Application\Controller\Controller</code>:</p><pre class="language-php"><code class="language-php"><span class="token comment">/**<br> * @param Request  $request<br> * @param Response $response<br> * @param          $args<br> *<br> * @return Response<br> * @throws \InvalidArgumentException<br> * @throws \RuntimeException<br> */</span><br><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">__invoke</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Response</span> <span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/** @var Command $command */</span><br>    <span class="token variable">$command</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">instantiateCommand</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token punctuation">(</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteUserCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCategoryCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteServiceCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteExtraCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteLocationCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePaymentCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCouponCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCustomFieldCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteAppointmentCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteBookingCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventBookingCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCustomerCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteNotificationCommand</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">/** @var CommandResult $commandResult */</span><br>    <span class="token variable">$commandResult</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">commandBus</span><span class="token operator">-></span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">emitSuccessEvent</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">eventBus</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">/** @var Response $response */</span><br>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location'</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_REDIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">hasAttachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token variable">$responseBody</span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>            <span class="token string single-quoted-string">'message'</span> <span class="token operator">=></span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token string single-quoted-string">'data'</span>    <span class="token operator">=></span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">emitSuccessEvent</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">eventBus</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>                <span class="token keyword">break</span><span class="token punctuation">;</span><br>            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_CONFLICT</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_CONFLICT</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>                <span class="token keyword">break</span><span class="token punctuation">;</span><br>            <span class="token keyword">default</span><span class="token punctuation">:</span><br>                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>                <span class="token keyword">break</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">/** @var Response $response */</span><br>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'application/json;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span><br>            <span class="token function">json_encode</span><span class="token punctuation">(</span><br>                <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">hasDataInResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span><br>                    <span class="token variable">$responseBody</span> <span class="token punctuation">:</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$responseBody</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>After instantiated the command, it called <code>$this->commandBus->handle($command)</code>. Following is the excerpt of <code>src/Infrastructure/ContainerConfig/command.bus.php</code>:</p><pre class="language-php"><code class="language-php"><span class="token language-php php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token function">defined</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ABSPATH'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'No script kiddies please!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// @codingStandardsIgnoreStart</span><br><span class="token variable">$entries</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'command.bus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token variable">$commands</span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>        <span class="token comment">// User</span><br>        <span class="token class-name static-context class-name-fully-qualified">User<span class="token punctuation">\</span>DeleteUserCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                             <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>DeleteUserCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token class-name static-context class-name-fully-qualified">User<span class="token punctuation">\</span>GetCurrentUserCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                         <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetCurrentUserCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token class-name static-context class-name-fully-qualified">User<span class="token punctuation">\</span>GetUserDeleteEffectCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                    <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetUserDeleteEffectCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token class-name static-context class-name-fully-qualified">User<span class="token punctuation">\</span>GetWPUsersCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                             <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetWPUsersCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><br>        <span class="token comment">// more commands...</span><br>    <span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token class-name static-context class-name-fully-qualified">League<span class="token punctuation">\</span>Tactician<span class="token punctuation">\</span>Setup<span class="token punctuation">\</span>QuickStart</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token variable">$commands</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token comment">// @codingStandardsIgnoreEnd</span><br></span></code></pre><p>We can see that the <code>GetWPUsersCommand</code> is taken by <code>User\GetWPUsersCommandHandler</code>, so the main logic is inside this file:</p><pre class="language-php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name class-name-definition">GetWPUsersCommandHandler</span> <span class="token keyword">extends</span> <span class="token class-name">CommandHandler</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/**<br>     * @param GetWPUsersCommand $command<br>     *<br>     * @return CommandResult<br>     * @throws AccessDeniedException<br>     * @throws InvalidArgumentException<br>     * @throws \AmeliaBooking\Infrastructure\Common\Exceptions\QueryExecutionException<br>     * @throws \Interop\Container\Exception\ContainerException<br>     */</span><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">handle</span><span class="token punctuation">(</span><span class="token class-name type-declaration">GetWPUsersCommand</span> <span class="token variable">$command</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanRead</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">EMPLOYEES</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to read employees.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanRead</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">CUSTOMERS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to read customers.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">checkMandatoryFields</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">/** @var UserService $userService */</span><br>        <span class="token variable">$userService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$adminIds</span> <span class="token operator">=</span> <span class="token variable">$userService</span><span class="token operator">-></span><span class="token function">getWpUserIdsByRoles</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'administrator'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">/** @var WPUserRepository $wpUserRepository */</span><br>        <span class="token variable">$wpUserRepository</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'domain.wpUsers.repository'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Successfully retrieved users.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">[</span><br>            <span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">USER</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'s'</span> <span class="token operator">=></span> <span class="token variable">$wpUserRepository</span><span class="token operator">-></span><span class="token function">getAllNonRelatedWPUsers</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$adminIds</span><span class="token punctuation">)</span><br>        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Besides, you can also see the part of permission check:</p><pre class="language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>  <span class="token punctuation">(</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteUserCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCategoryCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteServiceCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteExtraCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteLocationCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePaymentCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCouponCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCustomFieldCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteAppointmentCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteBookingCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventBookingCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCustomerCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteNotificationCommand</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>If the command is about deleting, need to pass the check of <code>wp_verify_nonce</code>, what is it?</p><p><code>wp_verify_nonce</code> is a function provided by WordPress to perform security check. This nonce is generated in admin page via <code>var wpAmeliaNonce = '&lt;?php echo wp_create_nonce('ajax-nonce'); ?>';</code>, and the nonce is actually the result of hashing.</p><p>In theory, it's not possible to spoof the nonce unless you can get the salt, which is generated randomly at install time:</p><pre class="language-php"><code class="language-php"><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AUTH_KEY'</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">' Xakm&lt;o xQy rw4EMsLKM-?!T+,PFF})H4lzcW57AF0U@N@&lt; >M%G4Yt>f`z]MON'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SECURE_AUTH_KEY'</span><span class="token punctuation">,</span>  <span class="token string single-quoted-string">'LzJ}op]mr|6+![P}Ak:uNdJCJZd>(Hx.-Mh#Tz)pCIU#uGEnfFz|f ;;eU%/U^O~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LOGGED_IN_KEY'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'|i|Ux`9&lt;p-h$aFf(qnT:sDO:D1P^wZ$$/Ra@miTJi9G;ddp_&lt;q}6H1)o|a +&JCM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'NONCE_KEY'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'%:R{[P|,s.KuMltH5}cI;/k&lt;Gx~j!f0I)m_sIyu+&NJZ)-iO>z7X>QYR0Z_XnZ@|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AUTH_SALT'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'eZyT)-Naw]F8CwA*VaW#q*|.)g@o}||wf~@C-YSt}(dh_r6EbI#A,y|nU2{B#JBW'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SECURE_AUTH_SALT'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'!=oLUTXh,QW=H `}`L|9/^4-3 STz},T(w}W&lt;I`.JjPi)&lt;Bmf1v,HpGe}T1:Xt7n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LOGGED_IN_SALT'</span><span class="token punctuation">,</span>   <span class="token string single-quoted-string">'+XSqHc;@Q*K_b|Z?NC[3H!!EONbh.n&lt;+=uKR:>*c(u`g~EJBf#8u#R{mUEZrozmm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'NONCE_SALT'</span><span class="token punctuation">,</span>       <span class="token string single-quoted-string">'h`GXHhD>SLWVfg1(1(N{;.V!MoE(SfbA_ksP@&`+AycHcAV$+?@3q+rxV{%^VyKT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>So, we can ensure that only authenticated users have the ability to use certain features via <code>wp_verify_nonce</code>.</p><p>Phew! That's all about the structure of Amelia. It's elegant compared to other plugins, and it's easy to find what you want.</p><p>Finally, it's time to talk about the vulnerabilities.</p><h2 id="cve-2022-0720%3A-amelia-%3C-1.0.47---customer%2B-arbitrary-appointments-update-and-sensitive-data-disclosure"><a href="#cve-2022-0720%3A-amelia-%3C-1.0.47---customer%2B-arbitrary-appointments-update-and-sensitive-data-disclosure" class="direct-link">#</a> CVE-2022-0720: Amelia &lt; 1.0.47 - Customer+ Arbitrary Appointments Update and Sensitive Data Disclosure</h2><p>There are two modules for managing the booking. One is "Appointment", the other is "Booking", it's a one-to-many relationship. One appointment can have multiple bookings.</p><p>Below are the routes for the appointment module:</p><p><code>src/Infrastructure/Routes/Booking/Appointment/Appointment.php</code></p><pre class="language-php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name class-name-definition">Appointment</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/**<br>     * @param App $app<br>     *<br>     * @throws \InvalidArgumentException<br>     */</span><br>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function function-definition">routes</span><span class="token punctuation">(</span><span class="token class-name type-declaration">App</span> <span class="token variable">$app</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetAppointmentsController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/delete/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/status/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentStatusController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/time/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentTimeController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Take <code>/appointments/{id:[0-9]+}</code> as an example, you can't see other customer's booking because there is a line to remove it in <code>GetAppointmentCommandHandler</code>:</p><pre class="language-php"><code class="language-php"><span class="token variable">$customerAS</span><span class="token operator">-></span><span class="token function">removeBookingsForOtherCustomers</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Collection</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$appointment</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>And here is the file for updating appointment(<code>UpdateAppointmentCommandHandler.php</code>):</p><pre class="language-php"><code class="language-php"><span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token comment">/** @var AbstractUser $user */</span><br>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">authorization</span><span class="token punctuation">(</span><br>        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'cabinet'</span> <span class="token operator">?</span> <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name return-type">null</span><span class="token punctuation">,</span><br>        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getCabinetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthorizationException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span><br>        <span class="token punctuation">[</span><br>            <span class="token string single-quoted-string">'reauthorize'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><br>        <span class="token punctuation">]</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">isProvider</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token operator">&&</span> <span class="token operator">!</span><span class="token variable">$settingsDS</span><span class="token operator">-></span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'roles'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'allowWriteAppointments'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// update appointment</span></code></pre><p>In the beginning, there are two checks. The first one is to check if the user is logged in, and the second one is to check if the user's role is "Provider".</p><p>There are a few roles in Amelia: Customer, (Service) Provider, and Admin. So, as a customer, we can pass the check and update other customer's appointments!</p><p>When the customer manages their bookings, they use another module called "booking" because the appointment module is for providers. I guess that's why there is no permission check for the customer role because the developer has a false assumption that the customer won't access this endpoint at all.</p><p>What can we do besides updating the booking? Let's see the response:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-320w.png 320w" type="image/png"><img alt="update booking" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1920w.png" height="1668" width="2084" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2084 1668'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnklEQVQImRXJURKCIBAAUO5/uT7LRh01y8UEARdYSNjGzzdP3Jtp6Md9NynQAqptx0V+Q4iHj6Lv5DS9jdmJolL4bD4ACyKWUkTXyte8IgYi8khytSEH+qXr1scw3xq4j/IxlUTb5q3zzHydAXWsxmt/aM+1gt5nDTbbI6GwjjaNzFwrM7OUDsAyXxBaObVhLeX8nTGSc8FjOs+Sc/4DR/KxyA097mcAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>There is a field called "info", it contains the personal data of the customer who booked it. This field is added by <code>processBooking</code> in <code>src/Application/Services/Reservation/AbstractReservationService.php</code> :</p><pre class="language-php"><code class="language-php"><span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'info'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><br><span class="token punctuation">[</span><br>    <span class="token string single-quoted-string">'firstName'</span> <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'firstName'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'lastName'</span>  <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lastName'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'phone'</span>     <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'locale'</span>    <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'locale'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'timeZone'</span>  <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'timeZone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'urlParams'</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlParams'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlParams'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>To sum up, a customer can update other customers' appointments and see their personal information due to a flawed permission check. Moreover, the appointment ID is a serial number so it's easy to enumerate.</p><h3 id="remediation"><a href="#remediation" class="direct-link">#</a> Remediation</h3><p>In 1.0.47, they made two changes.</p><p>The first one is to implement the permission check for customer:</p><pre class="language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">isCustomer</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>The other is about the permission check for routes, from the positive list to the negative list, only a few commands are accessible without logging in:</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">validateNonce</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">LoginCabinetCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">AddBookingCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">AddStatsCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">MolliePaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">MolliePaymentNotifyCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">PayPalPaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">PayPalPaymentCallbackCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">RazorpayPaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">WooCommercePaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">SuccessfulBookingCommand</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2 id="cve-2022-0825%3A-amelia-%3C-1.0.49---customer%2B-arbitrary-appointments-status-update"><a href="#cve-2022-0825%3A-amelia-%3C-1.0.49---customer%2B-arbitrary-appointments-status-update" class="direct-link">#</a> CVE-2022-0825: Amelia &lt; 1.0.49 - Customer+ Arbitrary Appointments Status Update</h2><p>This vulnerability is quite similar to the previous one, it's also about permission check.</p><p>The route for updating appointment status is <code>$app->post('/appointments/status/{id:[0-9]+}', UpdateAppointmentStatusController::class);</code>, and the main handler is <code>src/Application/Commands/Booking/Appointment/UpdateAppointmentStatusCommandHandler.php</code>.</p><p>There is a permission check in the very beginning:</p><pre class="language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanWriteStatus</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">APPOINTMENTS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// update appointment</span></code></pre><p>Let's dive in and see what is the implementation of <code>currentUserCanWriteStatus</code>:</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">currentUserCanWriteStatus</span><span class="token punctuation">(</span><span class="token variable">$object</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">userCan</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">currentUser</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">WRITE_STATUS_PERMISSIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Keep diving, check <code>userCan</code>：</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">userCan</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token keyword">instanceof</span> <span class="token class-name">Admin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">permissionsChecker</span><span class="token operator">-></span><span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>In <code>src/Infrastructure/WP/PermissionsService/PermissionsChecker.php</code>, we can find the implementation of <code>checkPermissions</code>:</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">checkPermissions</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token comment">// Admin can do all</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token keyword">instanceof</span> <span class="token class-name">Admin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Get the WP role name of the user, rollback to customer by default</span><br>    <span class="token variable">$wpRoleName</span> <span class="token operator">=</span> <span class="token variable">$user</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'wpamelia-'</span> <span class="token operator">.</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">'wpamelia-customer'</span><span class="token punctuation">;</span><br>    <span class="token comment">// Get the wp name of capability we are looking for.</span><br>    <span class="token variable">$wpCapability</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"amelia_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$permission</span><span class="token punctuation">}</span></span>_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$object</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">&&</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getExternalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">user_can</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getExternalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$wpCapability</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// If user is guest check does it have capability</span><br>    <span class="token variable">$wpRole</span> <span class="token operator">=</span> <span class="token function">get_role</span><span class="token punctuation">(</span><span class="token variable">$wpRoleName</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token variable">$wpRole</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">&&</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$wpRole</span><span class="token operator">-></span><span class="token property">capabilities</span><span class="token punctuation">[</span><span class="token variable">$wpCapability</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span><br>        <span class="token punctuation">(</span><span class="token keyword type-casting">bool</span><span class="token punctuation">)</span><span class="token variable">$wpRole</span><span class="token operator">-></span><span class="token property">capabilities</span><span class="token punctuation">[</span><span class="token variable">$wpCapability</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>It was noteworthy that if the user is <code>null</code>, it will be treated as a <code>customer</code>. To check if a role has certain permission, we need to see the <code>capabilities</code> table in <code>src/Infrastructure/WP/config/Roles.php</code>:</p><pre class="language-php"><code class="language-php"><span class="token comment">// Customer</span><br><span class="token punctuation">[</span><br>    <span class="token string single-quoted-string">'name'</span>         <span class="token operator">=></span> <span class="token string single-quoted-string">'wpamelia-customer'</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'label'</span>        <span class="token operator">=></span> <span class="token function">__</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Amelia Customer'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'amelia'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'capabilities'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><br>        <span class="token string single-quoted-string">'read'</span>                             <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_read_menu'</span>                 <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_read_calendar'</span>             <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_read_appointments'</span>         <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_read_events'</span>               <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_write_status_appointments'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_write_time_appointments'</span>   <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>    <span class="token punctuation">]</span><br><span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre><p><code>amelia_write_status_appointments</code> is true, so the customer has permission to update the appointment status.</p><p>The rest part is just like the last vulnerability, the response of updating the appointment has a field called <code>info</code>, which contains the personal information of the customer who booked it.</p><p>By the way, the vulnerability is pre-auth before 1.0.48, because in 1.0.47 the permission check for routes is incomplete, an unauthenticated user can access this endpoint as well.</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-320w.png 320w" type="image/png"><img alt="update booking status" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1920w.png" height="1616" width="2072" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2072 1616'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmUlEQVQImSWMyw7CIBAA+f//01oP9hGgtQIlsLSwPNZY5zCXSYZ1/SDF4qzHcKyrmma+6T3GaD2wZy/miSuljgBaQ/fgUsoAodbK7jcxvKQ1JsYTIAlp/OH8AZiRjaMRwoJx6UxETesAIRJRa40hIl209vPyMVy9AT0gsJzzVehKpIxbth0L5poZANRa/xPEZPeTS5NKKrl8AbPZszF5XXsKAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h3 id="remediation-2"><a href="#remediation-2" class="direct-link">#</a> Remediation</h3><p>Customer role has no permission of <code>amelia_write_status_appointments</code> since 1.0.49.</p><h2 id="cve-2022-0837%3A-amelia-%3C-1.0.48---customer%2B-sms-service-abuse-and-sensitive-data-disclosure"><a href="#cve-2022-0837%3A-amelia-%3C-1.0.48---customer%2B-sms-service-abuse-and-sensitive-data-disclosure" class="direct-link">#</a> CVE-2022-0837: Amelia &lt; 1.0.48 - Customer+ SMS Service Abuse and Sensitive Data Disclosure</h2><p>Let's see the last vulnerability, it's still about permission check.</p><p>The route is <code>$app->post('/notifications/sms', SendAmeliaSmsApiRequestController::class);</code>, and the handler is <code>SendAmeliaSmsApiRequestCommandHandler</code>:</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">handle</span><span class="token punctuation">(</span><span class="token class-name type-declaration">SendAmeliaSmsApiRequestCommand</span> <span class="token variable">$command</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">/** @var SMSAPIServiceInterface $smsApiService */</span><br>    <span class="token variable">$smsApiService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'application.smsApi.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Call method dynamically and pass data to the function. Method name is the request field.</span><br>    <span class="token variable">$apiResponse</span> <span class="token operator">=</span> <span class="token variable">$smsApiService</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Amelia SMS API request successful'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token variable">$apiResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>As you see, there is no permission check at all, and we can control the parameters here:</p><pre class="language-php"><code class="language-php"><span class="token variable">$apiResponse</span> <span class="token operator">=</span> <span class="token variable">$smsApiService</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>There are few methods with only one parameter, including <code>getUserInfo</code>, <code>getPaymentHistory</code> and <code>testNotification</code>:</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'auth/info'</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">getPaymentHistory</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/payment/history'</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">testNotification</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/sms/send'</span><span class="token punctuation">;</span><br><br>    <span class="token comment">/** @var SettingsService $settingsService */</span><br>    <span class="token variable">$settingsService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'domain.settings.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">/** @var EmailNotificationService $notificationService */</span><br>    <span class="token variable">$notificationService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'application.emailNotification.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">/** @var PlaceholderService $placeholderService */</span><br>    <span class="token variable">$placeholderService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"application.placeholder.<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>.service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$appointmentsSettings</span> <span class="token operator">=</span> <span class="token variable">$settingsService</span><span class="token operator">-></span><span class="token function">getCategorySettings</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'appointments'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$notification</span> <span class="token operator">=</span> <span class="token variable">$notificationService</span><span class="token operator">-></span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'notificationTemplate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$dummyData</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">getPlaceholdersDummyData</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sms'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$isForCustomer</span> <span class="token operator">=</span> <span class="token variable">$notification</span><span class="token operator">-></span><span class="token function">getSendTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token class-name static-context">NotificationSendTo</span><span class="token operator">::</span><span class="token constant">CUSTOMER</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$placeholderStringRec</span>  <span class="token operator">=</span> <span class="token string single-quoted-string">'recurring'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Placeholders'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token variable">$isForCustomer</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'Customer'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Sms'</span><span class="token punctuation">;</span><br>    <span class="token variable">$placeholderStringPack</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'package'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Placeholders'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token variable">$isForCustomer</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'Customer'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Sms'</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$dummyData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'recurring_appointments_details'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span><span class="token variable">$appointmentsSettings</span><span class="token punctuation">[</span><span class="token variable">$placeholderStringRec</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dummyData</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token variable">$dummyData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'package_appointments_details'</span><span class="token punctuation">]</span>   <span class="token operator">=</span>  <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span><span class="token variable">$appointmentsSettings</span><span class="token punctuation">[</span><span class="token variable">$placeholderStringPack</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dummyData</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><br>    <span class="token variable">$body</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span><br>        <span class="token variable">$notification</span><span class="token operator">-></span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token variable">$dummyData</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>        <span class="token string single-quoted-string">'to'</span>   <span class="token operator">=></span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'recipientPhone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'from'</span> <span class="token operator">=></span> <span class="token variable">$settingsService</span><span class="token operator">-></span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'notifications'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'smsAlphaSenderId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'body'</span> <span class="token operator">=></span> <span class="token variable">$body</span><br>    <span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Screenshot:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-320w.png 320w" type="image/png"><img alt="sms1" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1920w.png" height="1326" width="2052" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2052 1326'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkUlEQVQImT2J4QqDIBgAff+XG2MMIk1LraVpYalJy8+xDbp/d4eeFW9pN+nZ2SVugVDJWq6M3VNafUQEK0almbRz7jgORi2uv+q9zzkj0iguxrhHKCXnbE1oWKcXFVIAANRjIatOsUHTPszLeQIX/Ra28gOZWr5uRD1acedejv96gfTglJi8nuOa8vsspQDAtT9ah6gwJaZeJwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Send test notification:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-320w.png 320w" type="image/png"><img alt="sms2" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1920w.png" height="1504" width="2064" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2064 1504'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlklEQVQImU3M7Q6CIBhAYe7/5qrN2tocGFDmy0eoiIDC29afPH+f7RDKxDCoyc3RewDDheyVWddgJk+uN84oA1DLPFnrz2fWddw5t+VMKAXQppQdERefODfaaTvavGXyuEvRSiXh84ItpjWlWGIuudZKoGH9qZWX7tnwPQQ8RAaujXgv2mUf6u/8N2VmPY97LRWxHgXxCyt0sgZLPfu6AAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Sending test notifications still costs real money, so we can drain out the account by keep calling this API.</p><h3 id="remediation-3"><a href="#remediation-3" class="direct-link">#</a> Remediation</h3><p>In 1.0.48, they added permission check in the controller:</p><pre class="language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanWrite</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">NOTIFICATIONS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to send test email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2 id="conclusion"><a href="#conclusion" class="direct-link">#</a> Conclusion</h2><p>When the software becomes more and more complex, developers usually overlook some basic permission checks and have false assumptions sometimes.</p><p>For example, although front-end customers can't see appointments-related API because it's for providers, we can still find those API endpoints by looking at the source code in WordPress SVN.</p><p>Developers should be cautions with those authorizations when implementing those features, to make sure the current user has permission to do certain operations.</p><h2 id="disclosure-timeline"><a href="#disclosure-timeline" class="direct-link">#</a> Disclosure timeline</h2><p><code>2022-02-20</code> Report updating appointment vulnerability via WPScan, reserved CVE-2022-0720<br><code>2022-03-01</code> 1.0.47 is published, fixed CVE-2022-0720. <a href="https://wpscan.com/vulnerability/435ef99c-9210-46c7-80a4-09cd4d3d00cf" rel="noopener noreferrer" target="_blank">WPScan</a><br><code>2022-03-02</code> Report updating appointment vulnerability via WPScan, reserved CVE-2022-0825<br><code>2022-03-03</code> Report SMS related vulnerability via WPScan, reserved CVE-2022-0837<br><code>2022-03-09</code> 1.0.48 is published, fixed CVE-2022-0837. <a href="https://wpscan.com/vulnerability/0882e5c0-f319-4994-9346-aa18438fda6a" rel="noopener noreferrer" target="_blank">WPScan</a><br><code>2022-03-14</code> 1.0.49 is published, fixed CVE-2022-0825. <a href="https://wpscan.com/vulnerability/1a92a65f-e9df-41b5-9a1c-8e24ee9bf50e" rel="noopener noreferrer" target="_blank">WPScan</a><br><code>2022-03-26</code> Details and POC have been disclosed on WPScan<br><code>2022-03-30</code> Blog post published</p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/en/posts/huli/amelia-wordpress-plugin-sensitive-data-exposure-detail/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/en/tags/postsen/" class="post-tag">#postsEn</a> <a href="/en/tags/security/" class="post-tag">#Security</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/en/posts/nick/exchange_en/">How to Choose a Safe Exchange</a></li><li><a href="/en/posts/nick/data-leakage_en/">Basic Awareness of Hacking Prevention: Data Protection</a></li><li><a href="/en/posts/nick/backup_en/">Basic Awareness of Hacking Prevention：Backup and Restore</a></li><li><a href="/en/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/">SSRF and Account Takeover via XSS in ERPNext (0-day)</a></li><li><a href="/en/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-en/">The Difference Between Java and Golang in Writing Concurrent Code to Access Shared Variable</a></li></ol></div><div class="article-author"><img alt="huli" src="/img/authors/huli_logo.jpg" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/en/posts/huli">huli</a></div><div class="article-author__intro">Act as a bridge between Front-end and Security world</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Sensitive Data Disclosure in WordPress Plugin Amelia &lt; 1.0.49","image":["https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1920w.png","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/huli_logo.jpg"],"author":{"@type":"Person","name":"huli"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/en/posts/huli/amelia-wordpress-plugin-sensitive-data-exposure-detail/","mainEntityOfPage":"https://tech-blog.cymetrics.io/en/posts/huli/amelia-wordpress-plugin-sensitive-data-exposure-detail/","datePublished":"2022-03-30","dateModified":"2023-02-02","description":"Amelia is a WordPress plugin for booking systems developed by TNS. With 40,000+ active installations, it has been used for the clinic, hair..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a>. <a href="https://oneinfinity.global/" rel="noopener noreferrer" target="_blank">OneInfinity</a></div></footer><script>const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>