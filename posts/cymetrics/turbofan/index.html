<!DOCTYPE html><html domain=tech-blog.cymetrics.io ga-id=G-3VBVCXV9Z0 lang=zh-TW><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content=CYBER,Cymetrics,Security name=keywords><link href=/favicon.svg rel=icon type=image/svg+xml><meta content=#5789d3 name=theme-color><title>從編譯器優化角度初探 Javascript的V8 引擎</title><meta content="從編譯器優化角度初探 Javascript的V8 引擎" property=og:title><meta content="從編譯器優化角度初探 Javascript的V8 引擎" name=twitter:title><meta content=summary name=twitter:card><meta content=這篇文章想以V8引擎對於JS的實現為例來探討編譯器優化的一些基礎議題並搭配實驗，希望能讓讀者對於血汗的編譯器到底在背後幫我們完成了多少事情有點概念。 name=description><meta content=這篇文章想以V8引擎對於JS的實現為例來探討編譯器優化的一些基礎議題並搭配實驗，希望能讓讀者對於血汗的編譯器到底在背後幫我們完成了多少事情有點概念。 name=twitter:description><meta content=這篇文章想以V8引擎對於JS的實現為例來探討編譯器優化的一些基礎議題並搭配實驗，希望能讓讀者對於血汗的編譯器到底在背後幫我們完成了多少事情有點概念。 property=og:description><meta content=article property=og:type><meta content=https://tech-blog.cymetrics.io/posts/cymetrics/turbofan/ property=og:url><meta content="Cymetrics Tech Blog" property=og:site_name><meta content=https://tech-blog.cymetrics.io/img/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q.jpeg property=og:image><meta content=https://tech-blog.cymetrics.io/img/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q.jpeg name=twitter:image><meta content=hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk name=google-site-verification><link href=https://tech-blog.cymetrics.io/posts/cymetrics/turbofan/ rel=canonical><meta content=always name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="Cymetrics Tech Blog"><link href=/ rel=preconnect crossorigin=""><script async src="/js/min.js?hash=bcb67b09df" defer></script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}code{overflow-x:auto;border-radius:.3em;color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}small{font-size:80%;color:#ccc}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}summary{display:list-item}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,ol,p,ul{font-size:1em}ol,p,ul{margin-bottom:1.5em}body,ol,p,ul{font-size:1rem;line-height:1.6}ol,p,ul{margin-bottom:1.36rem}@media (min-width:600px){h3{font-size:1.7989rem;line-height:2rem}body,ol,p,ul{font-size:1.1rem;line-height:1.6}h3,ol,p,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h3{font-size:1.5rem}body,ol,p,ul{font-size:1.2rem;line-height:1.6}h3,ol,p,ul{margin-bottom:1.632rem}}mark{background:#f9c412;padding:0 .3em;background:var(--primary)}h1,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}@media (max-width:767px){x:-moz-any-link{display:table-cell}}button{border-radius:.3em;max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*,.utterances{box-sizing:border-box}*{border:0}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;flex-direction:column}header p,ol,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol,li ul{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}.utterances{position:relative;width:100%;max-width:760px;margin-left:auto;margin-right:auto}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title,header{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id=nav><div class=nav-title><a href=/ class=nav-logo title=Homepage></a> <label class=menu__btn for=menu__control><span>Menu</span></label></div><div class=nav__links><a href=/archive/ >Archive</a> <a href=/tags/ >Tags</a> <a href=/about/ >About</a></div></div><div id=reading-progress aria-hidden=true></div></nav><h1 class=w-full>從編譯器優化角度初探 Javascript的V8 引擎</h1><aside class=w-full><div class=post-tags><a href=/tags/front-end/ class=post-tag>#Front-end</a> <a href=/tags/javascript/ class=post-tag>#JavaScript</a></div><div class=post-avatar><img alt=maxchiu src=/img/authors/max_logo.jpeg class=post-avatar__img data-deopt=true><div class=post-avatar__info><div class=post-avatar__author><a href=/posts/maxchiu>maxchiu</a></div><div class=post-avatar__time>07 Apr 2021</div></div></div><div class=notice-block data-nosnippet="">我們正在尋找一位 Senior Security Engineer 加入我們的團隊，詳情請參考<a href=https://github.com/cymetrics/blog/issues/6 rel="noopener noreferrer" target=_blank>職缺資訊</a></div></aside><dialog id=message></dialog></header><main><article><div id=post-page></div><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q-1920w.jpg height=425 width=640 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 640 425'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxUlEQVQI1wG6AEX/ABkZG1ZhZWyFiTFDRyYuMhcbHhYbHgoNED9BP5+GggAkKCtdYFVUXFsxPEAeJScVGRwUGBoKCQs9SEu2vsAAICUoaXN1gpWbN0RHJCwuFxocEhYXCQkLNjw+r8zOACgsLmZxbl5ucThCRiAoLBsgIRIVFgcGCDM5O7LCwgApLi1zZktNTUY9R008QkMpMDASGRsMExUzOz2zrqsAICEgZ2RUand0QEhJKCssGh0fFBseDhETHCAjRE1Pe5ws0OrPyAYAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>這篇文章想以V8引擎對於JS的實現為例來探討編譯器優化的一些基礎議題並搭配實驗，希望能讓讀者對於血汗的編譯器到底在背後幫我們完成了多少事情有點概念。</p><p>一般人對於 JS 這種 Scripting Language 的印象大概就是相比於 C++ 之類直接編譯成對應指令集的語言，因為是把 Source code 藉由 Interpreter 編譯成 跑在原生環境的 <a href=https://en.wikipedia.org/wiki/Virtual_machine rel="noopener noreferrer" target=_blank>Process VM</a> 上對應的 Bytecode，沒辦法直接在 Machine code 層級做優化，所以速度通常會慢了一截。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk-1920w.jpg height=460 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 460'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApklEQVQI10WMSwuCQBhF55f3F1oVocs2CUVGq14YGBUEoURmmZWJkRiN+UAd0y+nos7qcO/lImvJ3FWuM1b4kdyeHOqDbZJmAJADBcWe+YzxDYcO9h038gICX+gAfYxq9phNWVFkVaXFC2XbEIoI0dW7Jf5ZVxr6pmlq/H7H+adenoTo95NG1rVfvXQr9pAxaiW84CAnCP6Q4LjyNDk01liaE9cqoheEYaFiiAYonQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>雖然 Bytecode 這種做法在執行時期速度顯然會較慢，但把 Source code 編譯成 Bytecode 形式，不僅僅是具備了“編譯一次，各平台通用”的跨平台的特性，同時 Bytecode 的指令層級也因為比較 High level， 相比於精確繁瑣的 Machine 層級指令，編譯 Bytecode 的速度通常會快出許多。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm-1920w.jpg height=382 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 382'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAIAAAAcxIEBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtUlEQVQI1wGqAFX/APn5+ejp6evp6ezj4fDm5O/m5e/n5e/m5O7k4vPr6f///wD9/f32+Pjr4t/EkoPDkIDCkIHDkYHDkIHEkIHNqaD38fAA/Pz88fHx6ejolp2/hJC4iJK6iJK6iZO6ipS9w87n////APz8/fX19fr6+4mkv3KSs3aVtXKRsnaVtbTGz93k2/Dz7QD9/f3y8vL4+Pe/zq+zxJ+2x6Osvpe3x6Xi6NfZ4tPq7+fxzoR8iM4ltAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB-1920w.jpg height=330 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 330'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAFCAIAAAD+GJp4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAhElEQVQI11WOsQoDIRBE/f/fkSstrQQrTRQRbLTRC4JROO/0shAiZIrhLcOwg+5/zTm/cBxHKeW6LmC0MlDvvbUGZ0qJc84Ys9ae54kg8N7HGEMIlFIhhHMOHGO8bRshpNaKoCTlwxgDJSmlUkprDfz8KeeM9v1V32WMsdasZeAwCz58AJubpa7G9ZxDAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>以上圖為例，一個 result = 1 + obj.x 這樣的 source code，隨著指令層級的越低，編譯的複雜度和時間也會隨之提升。然而越精確的指令對 CPU 來說才可以發揮最高的硬體效能。 所以其實要把 Source code 抽象到怎樣的層級就是設計編譯器時一個很重要的 Issue。</p><p>而許多基於 Bytecode 的語言為了能夠提升效率，引入了所謂的 <a href=https://zh.wikipedia.org/wiki/%E5%8D%B3%E6%99%82%E7%B7%A8%E8%AD%AF rel="noopener noreferrer" target=_blank>JIT</a> 技術，透過在執行時期分析常被執行的片段，同步地把這些片段的 profileing data 在背後偷偷餵進 optimizing compiler ，編譯成 Machine code 後偷偷的替換掉原本 bytecode 以提升運行的速度。（可以是從 <a href="https://www.google.com/search?q=abstract+syntax+tree&sxsrf=ALeKk02ELy_J6aRB-LjA0fdC8u6fBk-ITA%3A1617433965743&ei=bRVoYNz1LIOmmAXr6LfwBg&oq=abstract+syn&gs_lcp=Cgdnd3Mtd2l6EAEYADICCAAyAggAMgIIADICCAAyBQgAEMsBMgUIABDLATIFCAAQywEyBQgAEMsBMgUIABDLATIFCAAQywE6BAgjECc6BAgAEEM6BQgAELEDOggIABCxAxCDAToHCAAQsQMQQzoKCAAQsQMQRhD_AVDY_QhYtZAJYL2bCWgDcAB4AIABQIgBhQWSAQIxM5gBAKABAaoBB2d3cy13aXrAAQE&sclient=gws-wiz" rel="noopener noreferrer" target=_blank>AST</a> 也可以是從 Bytecode 優化）[2]</p><p>V8 引擎目前所使用的 Optimizing Compiler叫做 <a href=https://v8.dev/ rel="noopener noreferrer" target=_blank>TurboFan</a> ， 他使用了一套自訂的 IR [3] ，並用 Sea Of Nodes 取代傳統編譯器優化中使用的 CFG，大幅提升了優化策略的彈性，並實現了大部分語言都有的共通優化方式（ Inlining、Loop Splitting 、 Escape Analysis … etc )。(<strong>＊註一)</strong></p><p>具體來說， Turbofan 採用的是所謂的推測式優化（ Speculative Optimization ）。動態語言因為允許不指名變數型別，執行期的 Machine 指令理當是無法確定（舉最簡單的例子 ，“＋”這個 operator 在 String 跟 Number 行為完全不一樣），但 Turbofan 根據 Runtime 時的 Profiling 資訊，“推測” 一些這段 Source Code 確切的型別。以函式呼叫來說， Turbofan會在執行期的每個 Function的Code Object裡面都額外帶上所謂的 <strong>Feedback Vector[4]</strong> ，用來統計一個函式的執行狀況。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu-1920w.jpg height=404 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 404'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAIAAACaUPOvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAeUlEQVQI113L3Q6DIAyGYe7/HhcDApbfxW4WEIgSj8aefGd9y+RjFasQwjlHRKWU6wdTYKQCtUEM0XsfY6y1zoUBZcLYQdRaG+fe+1Ro6yTYRUJETI9rxrwP2jhp3wG/lFI+z/9i4ZzL7cU1WLsPiEdKlDPiB/fxlG/yPryCEb7l7wAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>我們考慮一個簡單的狀況</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU-1920w.jpg height=132 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 132'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAADCAIAAAD+5KMAAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAOElEQVQI15XLQQ4AEAwEQP9/pwi6lFZTR4kXMPcJypNTHRk5oV3+JizVic6xoICIROR1mplv3/8OWoqjx8bFYVEAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>這樣的話函式為例，若執行期數十次對這個函式的呼叫傳入的都是Integer，那麼 Feedback Vector 就會開始統計這些資訊，Turbofan 會開始在背後同步地把 Add( x, y)的 Bytecode 轉換成針對 Integer 操作的指令。</p><p>然而推測性的優化終究只是推測性的，過了一陣子如果User突然對 Add 函式傳進了一個 String，V8引擎是不是就要爆掉了？畢竟連 Machine code 都已經把它當成 Integer 來操作了，難道要噴 Segmentation Fault了？</p><p>實際上 TurboFan 在處理 JIT 優化時，並不只是單純的把對應的 code 轉成 machine code ， 而是會同時在 Code 中塞入所謂的 Checkpoint，執行優化過的 Machine code 函式 之前，會先檢查傳入的參數是否跟先前的假設一致，若假設不成立了，則進行 Deoptimization。<br>（這邊有個點要提醒，若 同一段 code Optimization-Deoptimization 這樣子的重複了五次以上，在 Turbofan 就會認定這是段 Megamorphic 的 Code，並放棄對他進行 JIT 優化）[7]</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3-1920w.jpg height=452 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 452'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAqUlEQVQI1x2NSw6CMBQAe3Uv4AlM3LnhEMYFISxEw9YICQVjUQot/cBr+ypxtpPMkG6wq/OI3lo7SzmJKYRgraGUaq2JGj16dOCVVFbICLAu68gHxt7GWHKfkkbnDJqIuIZwlqzoKs4/McYtQ9rvlfW3lrdyNmqeymRHsz3M1IfoAMjlkeV12olSjMwIM5x6MxhAvy02SHE4Vkn6SjJVP7egQ7/8DQAg4g/rQaXkBMVWmAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>從上圖可以看到，優化過的機器碼中，實際的函數內指令是黃色的部分，藍色部分檢查參數是否為 Small Integer 型別，橘色部分檢查 object 的 Hidden Class (＊註二）是否相同。 若不相同就直接 Jump 到對應的處理程式碼。</p><p>具體來說， 為了能順利 fallback 回去用 Bytecode 執行，Deoptimization 要做以下幾件事：</p><ul><li>把目前 memory stack 中的 frame 和 Register 中的資訊存進 buffer</li><li>從 (optimized) frame 中重構出 interpreter 的 frame，若優化後的 frame 是 inlined 的，則必須依序建構出正確的 function stack (畢竟 interpreter 是沒有辦法做 inlining 優化的啊啊）</li><li>把 Register 的值讀進新的 stack 需要的位置 （有沒有感覺跟 Context Switch 在做的事有點像XD)</li><li>重新 Materialize 那些被 Turbofan 用 <a href=https://en.wikipedia.org/wiki/Escape_analysis rel="noopener noreferrer" target=_blank>Escape Analysis</a> 優化省略掉的物件實例</li><li>把 Program counter 跳回去給 Interpreter</li></ul><p>以上這就是 V8引擎中所謂的 Eager Deoptimization。</p><p>並且，若某個變數的 CheckPoint Fail了，所有其他會使用到同一個變數的函式也要 Deoptimize。然而實際上這些相依的函式因為不是在 Stack 的頂端，不能直接 Deoptimize ( 例如無法取得 register 的 snapshot )</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh-1920w.jpg height=219 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 219'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAECAIAAADec/LeAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAp0lEQVQI1xWNyRLBQABE86U+zMXZiTjaySUKVbbYVWyjJqFSmGAyW8t0v9vrqnaye8SGPhsN+DowgH6ccZ2BBKBLxCtEyxxFA8mZVNoRKcsI4WEobhcAk2RTCZvVbas2b7UPvnebNo6j3WkM8VHaOJzQeNz/8gQ22u/+ysXUdT/1u+gAPaCpzMLkr1BKORlNkz396QzG9lV6xoWIe+/cQkqLsuRTIeUfQz2jpmOpnooAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>所以實務上 Turbofan 還有一招所謂的 Lazy Deoptimization。 在一開始編譯 Machine Code 時就會註冊函式和變數之間的 Dependency， 而若某一段code 改到了某個變數的 Shape，會在相依的函數中把原本要存取此變數的 code 區段先用一段 Patched instruction 替代。這個 instruction 的功用就是去呼叫Deoptimizer。這樣子我們就可以在執行到會出問題的片段時再去 Deoptimize了！</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP-1920w.jpg height=166 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 166'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAAECAIAAADnFEOFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkklEQVQI112NPQ/CIBiE+f+/RgcXXVw7uLnZJhaEvhI+CqXYlI+Kg4Z4t9zl8uQQADDGpJTGGK21EMI5F0KIIUouCWAy9CCZcmIctVJqWRZEh0d/7znnpXjvrbUlwBNmM5MLPrX74213xofrq2FAu7ajlKJpmtZ13b7KOf9yyh9veSufKaYypZRijKgGarKG//QGSv3BzEMrTR0AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>以上就是我們偉大的 Turbofan 大大在我們跑 JS Code 時一直勞心勞力在做的事情。講了這麼多理論上的東西我想大家可能還是有點茫然，以下就用幾個簡單的實驗來探討一些 Turbofan 幫我們做的事情。</p><p>讓我們考慮以下這個簡單的程式片段 test.js</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD-1920w.jpg height=390 width=284 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 284 390'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAJCAIAAABxOqH0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAj0lEQVQI1zWOSw7DIAwFOUiTYMzHGAS4lEZddNP7HyokbWfhxejJGmW5xZQRYVnXZZnnRLkysIw2+vvzAgN/m1rf9/HsRYRydT5s0ybORNkTB05gcLtQ5KOnEBMjJefcz0Zi6U0e91DEWAtwvlYl5yqVq8wtOG8RT6vRapwYo7eZdrviFIQElCkSeau1/pYdKL0cFtoxJNYAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>我們在 node 環境下執行 <strong>node — trace-opt — trace-deopt test.js | grep doSomething ，藉由 — trace-opt 和 — tract-deopt觀</strong>察 V8 在執行時動態優化和反優化時的行為**，**並用 <strong>perf_hook</strong> 紀錄執行時間 <strong>。</strong></p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c-1920w.jpg height=84 width=237 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 237 84'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAp0lEQVQI102M2wqCQBRF/YwIPc44ZxIVxUtqhjnqmJQmFNRjWf//Ew1R0GK97cXW2rbt+34nKnGUYt+sN1kQB8xBsrKoy4nNgJgAoKloGIYoTdJDiZnPyhDLiCkTj+c+i11uczBAk1Kqy9M4nqdLGPJ6Sq7P7W3Oi8JdLnQwDPigNU3TdZ1KK1GLClthvR7OfHc8z9LVbsK34z8opQyBoYmcIBJdh3/eVgUkh9Xent4AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J-1920w.jpg height=50 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 50'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB8AAAACCAIAAAAvhJArAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAhUlEQVQI1yVMQQrEIBDrO7T07EGtFUHw0EK1sroq+v/PNNQcQiaZZPl9GGOUUlprMUaI8zxTSjnn53nu+3bOwURUa4WDFCZECAFF8HEc1lqllNZaCGGM4Zyv67pgEa8YwhzKvff/h+u65jpGEeGEAON/mt57KeW+7/wDY2zbNkIIpXQyzhfRZyy/ozMjSQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>可以看到 Turbofan 確實在執行期間動態的去優化了 doSomething。 被 mark起來的 reason是 <strong>small function</strong>，也就是說 Turbofan 覺得可以進行 inlining的優化。</p><blockquote><p><em>Inlining 代表的是 假裝函式裡面的 code 像是直接在 caller 對函式的呼叫處展開。這樣的做法可以省略創建跟維護新的 stack frame 所需的時間。 TurboFan 中對於一個函式是否可以進行 Inlining 的標準可以參考 [9].</em></p></blockquote><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw-1920w.jpg height=77 width=223 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 223 77'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAo0lEQVQI1xWJWxKCIAAAuYYBOoryfiqgYlE23f9M6dfu7IJVJ2v8aPMwslIPoYSPaVrKlN8Tl8aHfcuccyCZZmHlsYTXVxrlrHZpE7HIZRPGMeN9+WilQD8QH55xLvk4/XpoF5SbTVhSPdWcCOUDNyMhgE00cJPlIgbq9mrzzoSkjM31Z+PakxE9GowxoJQ28AExQhhfCSF48Rrw9lvarmvb9g/RVCC0qZLStQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><blockquote><p><em>簡單來說，如果函式在 AST 中的 Node 數少於 200，且函式的 callstack 深度小於 5，就是一個合格的 Candidate。<br>但程式中可能會有大量的 Candidate，如果全部都展開可能過度消耗資源，所以 Turbofan 會考量函式的 Relative Call Frequency。也就是說，從 callstack 最下面的函式的執行次數開始，依序乘上每個函數在父函數每次執行時被執行到的比例（而非直接看函式被執行的絕對次數）。 此值越高的函式會越優先被 Inlining。</em></p></blockquote><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g-1920w.jpg height=82 width=228 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 228 82'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsUlEQVQI1yWMSQ6CMAAAeYdCN1tqC0gVjUAVxAKpkaAS8aj//4XbZI6TcZqm6brOWlvZurv1RVUmm4RLDghCjCBK4AwDAJwsy8ZxVEpFh40oVzMdk3VIckX1kuuYphFTEiHkpGnatq0xZrgO22Stcp6fVXEOdybCHnQnU+B635/Wuu97Y4513e73i8fdHy7+6zk/2TlEGEDw9dNJKYUQQRD4PmcMhiGWEseKUArd3+nPG6c2JYHsXFilAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><blockquote><p><em>另外如果我們在上面的執行中把 — no-turbo-inlining flag 打開來，可以看到效能也有明顯的下降</em></p></blockquote><p>接著我們把上面的 code 的第二個迴圈的型別改成 String。再重新執行一次。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO-1920w.jpg height=143 width=273 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 273 143'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAIAAACaUPOvAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAk0lEQVQI10WNWw6CMBRE2Qe2hfvotQXSQqM0gVj9MO5/RwoYPZ8zJzMVI7doGyAkapEMCSBZKwCglNJaV47dJefHs5SS13sZbi/xnff+bzBbQLDCQGTPQlZU0560bnY2YxrivKwpz9NafExxHPvrQn4IIYrIZ6ZyTlLqQ/AxdE5YCBlBaXVcbBvGmLo+fdnzX3fwBkalHZqjNF0pAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw-1920w.jpg height=166 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 166'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAAECAIAAADnFEOFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArUlEQVQI1xWN2w6CMBBE+Q6hSmNpQUlVEgOB0O12Wy5e/v93XJPJZOblnGxNiRNDIPQIDuaZNwJ4cOMw2LZtjOGcZVnkh2ORiyLPvmvaPdA0fpf0SXEBtwcM0/iisHrXXS/3uramuhndSNnIsq1URkQBGeqWGCMfxL/HA3q/b9vQ93dru+6hK2W0ZiF3tlN4R2IqjwQuufkVaUVgIU7j09pWK2ab8qREUR2FEuIHNcwrs/pu/nIAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>從上面這段 trace 可以看出來， Turbofan 對 doSomething 一樣先做了優化，接著因為參數型別不一致而進行了 Eager 的反優化（畢竟是傳入參數的問題，並不是動到了別的地方的 object ) 。並且在最後執行了 doSomething 函式裡面的 obj 的 <strong>Materialization</strong>。[8]</p><blockquote><p><em>Materialization 意味著的就是在優化時， Turbofan 把 obj 做了 “Escape Analysis” (De-materialization)，也就是說它分析了這段函式的執行狀況，認定 obj 這個物件從來都不會脫離當前的 scope。</em></p></blockquote><blockquote><p><em>不會脫離當前 scope 代表的意義就是其實沒有必要把 obj 放到 heap 去（放到 Heap 最重要的意義就是為了讓別的 frame 可以存取到）， 直接把 obj 裡的property 都變成 local variable 放到 stack 裡面，可以提昇操作速度（畢竟放到 heap 的話就變成要先從 stack 讀變數在 heap 的位置再去拿）。</em></p></blockquote><blockquote><p>舉例來說我們以上的 code 若做了 De-materialization，會變成這樣的形式</p></blockquote><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA-1920w.jpg height=88 width=239 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 239 88'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlUlEQVQI11WNWw6CMBREuw7TS6FCaEsrfVweggaQEBPZ/35E8EMnk/mZyRmS46hdeK3j5nnupse1rmzp0IQqdPdUGmUs5wlJNeYl4rDIMghZKBsoPQEAiyKgNNoEsAXJDErX1OPTYKu0KXwNsNf/Ik7Z7tJ6HZpl1dgKIXw/+NuUCfXlHbvPBWOww+OEHy8JPzMW//LeXLEfSEsVjk0AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm-1920w.jpg height=86 width=232 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 232 86'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAr0lEQVQI1yWNWw6CMBRE2YZIW6AXEQQpKiiPFIFUKiX6Y4zG/e/DiiczfyczRpZlbdsOw8DPDb+0/VXkxzxise05jk9tnxJwMcGGaZpCiElNu/ywF5VXxFAzt0homXinLWQbygIKYCCEOOdSSjWOSirGVpWM+lukHnGa+suFhRHCGBu62tO/XdeVVd00cJ+813P1ea+DwLW0Q/DPC8OQzgAAIcRxMQXbdoiONS/9+QIYJyQOUgKLxQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><blockquote><p><em>當然，這些優化是不能在 Bytecode 層級做的，所以既然要反優化，就表示我們必須把 obj 重新放回 heap ，這就是所謂的 Materialization。</em></p></blockquote><p>但隨著後半的 iteration 傳入的型別都是 String， Turbofan 過了一段時間再次把 doSomething 編譯成了針對字串參數的機器碼。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf-1920w.jpg height=87 width=239 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 239 87'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArUlEQVQI1yWOWQ6CMAAFewwT7UJLwZRSREFkSQELEiEhbtF4/4uIMN+TNw80TdO2bW3O1dVUFxOfjipUlsOISy3BCacIY4QQ0FoP/bCPD3FXsMhjeWAXIc0CHkmeSBZsKaUQQlCWpTFm6Pvn7RXunMQIM/rj2w98Z73aIAjRDEjTtK7ryc7yXGvWtez7cR93x+bWosAZoJQSQkgpPc/jnNqcEoLx/xNelqYuIeQHAgwj3ldHQloAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>其實從上面的 trace 可以看出來，執行動態優化和反優化花費的時間大多都在 1ms 以下，然而最後的執行時間卻有如此大的差異，應該不難想像執行優化前跟優化後的代碼的效率有多大的差異了。</p><p>再來我們看看這段程式碼的效率</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN-1920w.jpg height=158 width=252 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 252 158'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAjUlEQVQI1y2MWw6DMAwEcw7I++U0JA4hFR+oEqK9/51qlY72w/KszYL1ax2xju05MjaHw2fE1gBACMG0UiWX63Ne79dx7Kk2GyItCSkl01pHCIiPUtKyAGllHOdc/mDUWnPbtxHBh+CtVt5oZy19vq8NQBwDey+915xiClRzf02zMXaa5nnmFC4E5XbEF0nmGpfFKLO0AAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash-1920w.jpg height=87 width=228 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 228 87'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAqElEQVQI1zXKyQ6CMBRAUT6kPoY+oCVUK+BA0diBStxgNO4c/v8zFKM3d3kCKaUxRmttrT146459225lJWOMIzod0hhCCAgh3a47j2OzauqjYt0SlcRWJpt50pRpK2hdUKSTU0oZa4ZhuF1vQvC1Lw7jYn8qq4YDCWE2A4Cf8973vXNu0Dq/nNPXgz3vbC7wa6aCLMs454iY51mSUEwhZ9FnxiJC/grgDftfJDYpqVgPAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>不難看出，如果每次呼叫 doSomething 時的參數型別都持續變化，對於 Turbofan 來說是很難進行有效率的優化的。 這也正是為什麼寫 JS 時我們應該要盡可能遵守固定參數型別的原因。（ 從另一方面來看，使用 Typescript 也是有執行期效率的考量，畢竟型別都固定了，對編譯器來說很好優化）</p><p>接著考慮以下這段 code</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls-1920w.jpg height=312 width=230 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 230 312'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAJCAIAAABxOqH0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAm0lEQVQI1y2MbQ6DIBBEOYgCC7uwC35Vi22tpmm8/52KSZOZPy8zTyF3af1Mpeznt2xPToKEyjlw3tdagBpEBABlSaz0IF3uWAIxYttqZTDyOMtwixyMbpum0VqryN3yPpfX9jiO/r6mlC8DGEueWOL8mspeQgjX1hhNMVbskSzS3+AoYB4pD6mec3YAbaU2MMjgpE+JmdC7i/4AjBwdGSIIGIcAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__-1920w.jpg height=83 width=229 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 229 83'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAArElEQVQI103MSw6CMBSF4S6DAdy2QKHyqoBpq0YehhoURQiJ+1+KyMhvcEZ/DjLG9JvWXF/TWNVVWRYBD4AA9ih2CSYYAJCUclmWIi/S+hA3JTvvvTJxtXBVxk7CVwkTu7VFWuthGLqum9/TUcnswvUzr0bR3AXFxLFt/LsDpJRau7ZtOnOTMnn03mcJ55EdFaMuccCBDYrjOIqidTnnvk/SjCYpDUJiWTb8+QJuxyTXB3Rf8QAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>如果我們把 <strong>yoo (obj)</strong> 這行的註解拿掉，就符合了我們上面所講的， Stack Top 的 Frame 更改了會被其他地方存取的變數的 Shape 的狀況。這會讓 couter += obj.x 這行機器碼指令因為 obj 的形狀改變而失效。 我們印出他的 trace-opt:</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x-1920w.jpg height=87 width=232 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 232 87'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAp0lEQVQI1zXK3QqCMACG4V1H6P7bZmqIYMPS/aWhNDoI7Dy6/3tIpJ6j94MPdF3nvb+NownOz0Nne91qcRCIYaIYlgxRDCEEQogYo7eusW111bQp9ram54o2pdAlP+UsFwRjIKUchsE591oWczFVw0w8zs+iD5ngPNklcAOyLAshGGOmada69o487vzzVsFzhDD8A0opSinbIAQZx4wTQtHaafo7reMLCOIjxyzHjwkAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG-1920w.webp 1920w, /img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG-1280w.webp 1280w, /img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG-840w.webp 840w, /img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG-320w.webp 320w" type=image/webp><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG-1920w.jpg 1920w, /img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG-1280w.jpg 1280w, /img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG-840w.jpg 840w, /img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG-1920w.jpg height=65 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 65'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAACCAIAAAAmbzBRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAgUlEQVQI1z2MSw4CIRBE5ywMRBDkExWIECfQKBFn4/0vYwcT36JStai3DKijwf5sn/d4QX0AlFrvEwDoveect21rk1IKTq21EEIpJaUkhKzr+kvGGKV0uR0PxZzAmT3FdnbhesFPSinGiIk9hOC9RylOLMYYNKqJc85ai4Vz/jd+Aa76Ie3IC4sDAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>我們可以看到，這次的 Deoptimization 是 soft 模式，也就是上面所談的 Lazy Deoptimization。</p><h3 id=%E7%B5%90%E8%AB%96><a href=#%E7%B5%90%E8%AB%96 class=direct-link>#</a> 結論</h3><p>這篇文章介紹了 V8 引擎和 Turbofan 執行大家的 JS Code 時的優化方式跟原理。 寫出來的 code 越穩定好分析，編譯器就可以做越進階的優化。</p><p>其實絕大多數的 Web Application都是 IO-Bound 的，如何寫出讓 Compiler 好優化的 Code 可能在很多時候都不是個很關鍵的問題，畢竟寫出讓編譯器好優化的程式碼可能會破壞許多易用好維護的軟體設計原則。 但儘管如此，作為 Web 開發者相信對 JS 背後的執行環境有深一層的認識也是一件重要的事。</p><p>＊註一 ： TurboFan 所採取的 Sea-of-Nodes 是編譯器用來表示程式行為的表示方式的一種。相比傳統上常用的 Control Flow Graph 在做指令的 Scheduling 時把 Basic block 當作 Scheduling 的原子單位， Sea-of-Nodes 把所有的資料跟操作都變成單一的節點，並用 Effect-edge 來維持程式流程中的 State 關係，提升了 Scheduling 的彈性。 有興趣的人可以參考 [1]和[4]。</p><p>＊註二： V8 引擎中，具有相同的 Shape（ object 中所有 attribute 的 type 和name) 的 object 都會對應到一個相同的 Map，稱之為 Hidden class，裡面存放了這些 attribute 在 memory layout 中固定的 offset，是 V8 為了加速記憶體存取速度而出現的設計。[6]</p><h3 id=references%3A><a href=#references%3A class=direct-link>#</a> References:</h3><p>[1] Turbofan JIT Design <a href="https://docs.google.com/presentation/d/1sOEF4MlF7LeO7uq-uThJSulJlTh--wgLeaVibsbb3tc/edit#slide=id.g5499b9c42_01170" rel="noopener noreferrer" target=_blank>https://docs.google.com/presentation/d/1sOEF4MlF7LeO7uq-uThJSulJlTh--wgLeaVibsbb3tc/edit#slide=id.g5499b9c42_01170</a></p><p>[2] An overview of Turbofan Compiler <a href="https://docs.google.com/presentation/d/1H1lLsbclvzyOF3IUR05ZUaZcqDxo7_-8f4yJoxdMooU/edit#slide=id.g18ceb14729_0_124" rel="noopener noreferrer" target=_blank>https://docs.google.com/presentation/d/1H1lLsbclvzyOF3IUR05ZUaZcqDxo7_-8f4yJoxdMooU/edit#slide=id.g18ceb14729_0_124</a></p><p>[3] Turbofan IR <a href="https://docs.google.com/presentation/d/1Z9iIHojKDrXvZ27gRX51UxHD-bKf1QcPzSijntpMJBM/edit#slide=id.g19134d40cb_0_0" rel="noopener noreferrer" target=_blank>https://docs.google.com/presentation/d/1Z9iIHojKDrXvZ27gRX51UxHD-bKf1QcPzSijntpMJBM/edit#slide=id.g19134d40cb_0_0</a></p><p>[4] An Introduction to TurboFan<br> <a href=https://www.mdeditor.tw/pl/po7T/zh-tw rel="noopener noreferrer" target=_blank>https://www.mdeditor.tw/pl/po7T/zh-tw</a></p><p>[5] Deoptimization in V8 <a href="https://docs.google.com/presentation/d/1Z6oCocRASCfTqGq1GCo1jbULDGS-w-nzxkbVF7Up0u0/edit#slide=id.g19ea708688_0_10" rel="noopener noreferrer" target=_blank>https://docs.google.com/presentation/d/1Z6oCocRASCfTqGq1GCo1jbULDGS-w-nzxkbVF7Up0u0/edit#slide=id.g19ea708688_0_10</a></p><p>[6] V8 Hidden class <br><a href=https://engineering.linecorp.com/en/blog/v8-hidden-class/ rel="noopener noreferrer" target=_blank>https://engineering.linecorp.com/en/blog/v8-hidden-class/</a></p><p>[7] V8 Function Optimization <br><a href=https://erdem.pl/2019/08/v-8-function-optimization rel="noopener noreferrer" target=_blank>https://erdem.pl/2019/08/v-8-function-optimization</a></p><p>[8] Escape Analysis in V8<br> <a href="https://www.youtube.com/watch?v=KiWEWLwQ3oI" rel="noopener noreferrer" target=_blank>https://www.youtube.com/watch?v=KiWEWLwQ3oI</a></p><p>[9] Turbofan Inlining Heuristics <a href=https://docs.google.com/document/d/1VoYBhpDhJC4VlqMXCKvae-8IGuheBGxy32EOgC2LnT8/edit rel="noopener noreferrer" target=_blank>https://docs.google.com/document/d/1VoYBhpDhJC4VlqMXCKvae-8IGuheBGxy32EOgC2LnT8/edit</a></p><p>[10] JavaScript engine fundamentals: Shapes and Inline Caches<br><a href=https://mathiasbynens.be/notes/shapes-ics rel="noopener noreferrer" target=_blank title=https://mathiasbynens.be/notes/shapes-ics>https://mathiasbynens.be/notes/shapes-ics</a></p><div class=article-footer><a href=https://tech-blog.cymetrics.io/posts/cymetrics/turbofan/ on-click=share><img alt=Share src="/img/icons/icon_external link hyperlink.svg" height=24 width=24>Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class=post-tags><a href=/tags/front-end/ class=post-tag>#Front-end</a> <a href=/tags/javascript/ class=post-tag>#JavaScript</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href=/posts/nick/owasp-cwe/ >資安規範實戰篇 : OWASP + CWE</a></li><li><a href=/posts/crystal/email-sec-examples/ >關於 email security 的大小事 — 範例篇</a></li><li><a href=/posts/huli/xss-attack-and-defense/ >淺談 XSS 攻擊與防禦的各個環節</a></li><li><a href=/posts/jo/zerobased-cross-site-scripting/ >零基礎資安系列（二）-認識 XSS（Cross-Site Scripting）</a></li><li><a href=/posts/maxchiu/indexing/ >從Indexing的角度切入MySQL-Innodb與PostgreSQL的效能比較</a></li></ol></div><div class=article-author><img alt=maxchiu src=/img/authors/max_logo.jpeg class=article-author__img data-deopt=true><div class=article-author__info><div class=article-author__title>Author</div><div class=article-author__author><a href=/posts/maxchiu>maxchiu</a></div><div class=article-author__intro>Fullstack rookie, also love developing games and visual computing</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async src=https://utteranc.es/client.js crossorigin=anonymous id=utterance-script issue-term=title label=utterance repo=cymetrics/blog theme=github-light></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"從編譯器優化角度初探 Javascript的V8 引擎","image":["https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/1__NyZv46I1bYz4K7ngiT__W9Q-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__6JLpKVtBq4eIEljk-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__FK2W6kz9__36yXHnm-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__pq5o__C__DCDLht__XB-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0____DVw6OQA0S5z1Ryu-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__ec5paOPfU9S1XkoU-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__cSphl2MMRjAZlmi3-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__WTJD__3E4soas9mJh-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0______KJ__E7A8zUnQ2BP-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__tzW02alSCz__NNYJD-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__ysU6PBHyDXMgEG4c-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__Uk6z7x4EsoOieT2J-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/1__dBY1pw8ZHWqe__I__SfLGPyw-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/1__Tll__Gz2BbaIIYreX4s0H1g-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__aD0KzOXJwDqy__rXO-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__Akv2Bje8G0v9ilEw-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/1__U__ToZYPMtzR8AZcc9cGqQA-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__iyespGXRfBRYgYUm-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__AWTn6yUGsGVEZEgf-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__4P7hndqriK0eWdQN-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__KEMsyBqrOWpWdash-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__frVKSQdgjWzqL__Ls-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__L6lZmMx5NWshUaI__-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__RBX4Eyd__16Ud7A__x-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/DiveIntoTurbofan/0__kSr7ZNJFmbrhn1QG-1920w.jpg","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/max_logo.jpeg"],"author":{"@type":"Person","name":"maxchiu"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/cymetrics/turbofan/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/cymetrics/turbofan/","datePublished":"2021-04-07","dateModified":"2021-07-29","description":"這篇文章想以V8引擎對於JS的實現為例來探討編譯器優化的一些基礎議題並搭配實驗，希望能讓讀者對於血汗的編譯器到底在背後幫我們完成了多少事情有點概念。 一般人對於 JS 這種 Scripting Language 的印象大概就是相比於 C++..."}</script><script type=application/ld+json>{   
  "@context":"http://schema.org",
  "@type":"BreadcrumbList",
  "itemListElement":[
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Cymetrics Tech Blog",
      "item": "https://tech-blog.cymetrics.io"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Archive",
      "item": "https://tech-blog.cymetrics.io/archive/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "從編譯器優化角度初探 Javascript的V8 引擎",
      "item": "https://tech-blog.cymetrics.io/posts/cymetrics/turbofan/"
    }
  ]
}</script></article></main><footer><div class=footer-logos><a href=https://www.facebook.com/Cymetrics-100957872049641 rel="noopener noreferrer" target=_blank><img alt=facebook src="/img/icons/icon_social media_facebook.svg" height=30 width=30></a><a href=https://www.linkedin.com/company/onedegree-hk rel="noopener noreferrer" target=_blank><img alt=linkedin src="/img/icons/icon_social media_linkedln.svg" height=30 width=30></a><a href=https://tech-blog.cymetrics.io/feed/feed.xml rel="noreferrer noopener" target=_blank><img alt="rss feed" src=/img/icons/rss-feed.svg height=30 width=30></a></div><div class=copyright>© 2021 Cymetrics Tech Blog</div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })
      

      /*
      const toggleEl = document.querySelector('#color-scheme-toggle')
      const bodyEl = document.querySelector('body');
      const DARK = 'dark';
      const LIGHT = 'light';
      const currentTheme = localStorage.getItem("theme") ||
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : LIGHT);
      setTheme(currentTheme)

      toggleEl.addEventListener("click", handleToggleEvent)

      function handleToggleEvent(){
        const isDark = bodyEl.classList.toggle(DARK);
        const theme = isDark ? DARK : LIGHT;
        setTheme(theme)
        localStorage.setItem('theme', theme);
      }
      function setTheme(theme){
        if (theme === DARK) {
          setUtterancesTheme(DARK)
          bodyEl.classList.add(DARK);
          toggleEl.src = toggleEl.src.replace(DARK, LIGHT);
        }else{
          setUtterancesTheme(LIGHT)
          toggleEl.src = toggleEl.src.replace(LIGHT, DARK);
        }
      }

      var isUtterancesLoaded = false
      window.addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') {
          return;
        }
        isUtterancesLoaded = true
      });

      function setUtterancesTheme(theme) {
        let utterancesIframe = document.querySelector('.utterances iframe')
        if (!isUtterancesLoaded) {
          return requestAnimationFrame(() => setUtterancesTheme(theme))
        }

        utterancesIframe.contentWindow.postMessage({
          type: 'set-theme',
          theme: theme === DARK ? 'github-dark-orange' : 'github-light'
        }, 'https://utteranc.es');
      }
    */</script></body></html>