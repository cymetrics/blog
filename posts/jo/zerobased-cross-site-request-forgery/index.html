<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>零基礎資安系列（一）-認識 CSRF（Cross Site Request Forgery）</title><meta content="零基礎資安系列（一）-認識 CSRF（Cross Site Request Forgery）" property="og:title"><meta content="零基礎資安系列（一）-認識 CSRF（Cross Site Request Forgery）" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="# 前言陌生人＝ Hacker 菜單 ＝ Request桌號＝ cookie 註1 老闆＝ web server 你 ＝ User想像你到一家餐廳吃飯，陌生人拿了一張有你桌號的菜單點餐之後給老闆，結果老闆問也不問便收了菜單並將帳記到了你的身上，這就是 CSRF 的基礎概念。" name="description"><meta content="# 前言陌生人＝ Hacker 菜單 ＝ Request桌號＝ cookie 註1 老闆＝ web server 你 ＝ User想像你到一家餐廳吃飯，陌生人拿了一張有你桌號的菜單點餐之後給老闆，結果老闆問也不問便收了菜單並將帳記到了你的身上，這就是 CSRF 的基礎概念。" name="twitter:description"><meta content="# 前言陌生人＝ Hacker 菜單 ＝ Request桌號＝ cookie 註1 老闆＝ web server 你 ＝ User想像你到一家餐廳吃飯，陌生人拿了一張有你桌號的菜單點餐之後給老闆，結果老闆問也不問便收了菜單並將帳記到了你的身上，這就是 CSRF 的基礎概念。" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/jo/zerobased-cross-site-request-forgery/" property="og:url"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/jo/zerobased-cross-site-request-forgery/cover.jpeg" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/jo/zerobased-cross-site-request-forgery/cover.jpeg" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://tech-blog.cymetrics.io/posts/jo/zerobased-cross-site-request-forgery/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,input{font-family:inherit;font-size:100%;line-height:1.15;overflow:visible}button{text-transform:none}input{margin:0}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}[hidden]{display:none}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,ol,p,pre{font-size:1em}ol,p,pre{margin-bottom:1.5em}body,ol,p,pre{font-size:1rem;line-height:1.6}ol,p,pre{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,ol,p,pre{font-size:1.1rem;line-height:1.6}h2,h3,ol,p,pre{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}body,ol,p,pre{font-size:1.2rem;line-height:1.6}h2,h3,ol,p,pre{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}code{border-radius:.3em;color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}form{padding:1.5em 1.5em 0;border:.2rem solid #202020}button,input{border-radius:.3em;max-width:100%}form,input{margin-bottom:1.5em}input{padding:.75em;display:inline}button+label,input+label,label+*{page-break-before:always}label{display:inline-block}form>:not(fieldset){margin-right:.75em}button{background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}input[type=url]{border:1px solid #595959;padding:.75em}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.function{color:#f08d49}.token.property{color:#f8c555}.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a> <a href="/en">English</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">零基礎資安系列（一）-認識 CSRF（Cross Site Request Forgery）</h1><aside class="w-full"><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/zerobased/" class="post-tag">#ZeroBased</a> <a href="/tags/csrf/" class="post-tag">#CSRF</a></div><div class="post-avatar"><img alt="jo" src="/img/authors/jo_logo.png" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/jo">jo</a></div><div class="post-avatar__time">26 May 2021</div></div></div><div class="notice-block" data-nosnippet="">我們正在尋找一位 Security Engineer 加入我們的團隊，詳情請參考<a href="https://github.com/cymetrics/blog/issues/13" rel="noopener noreferrer" target="_blank">職缺資訊</a></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><h2 id="%E5%89%8D%E8%A8%80"><a href="#%E5%89%8D%E8%A8%80" class="direct-link">#</a> 前言</h2><blockquote><p>陌生人＝ <strong>Hacker</strong> 菜單 ＝ <strong>Request</strong><br>桌號＝ <strong>cookie 註1</strong> 老闆＝ <strong>web server</strong> 你 ＝ <strong>User</strong></p><p>想像你到一家餐廳吃飯，陌生人拿了一張有你桌號的菜單點餐之後給老闆，結果老闆問也不問便收了菜單並將帳記到了你的身上，這就是 CSRF 的基礎概念。</p></blockquote><h2 id="%E9%87%8B%E4%BE%8B"><a href="#%E9%87%8B%E4%BE%8B" class="direct-link">#</a> 釋例</h2><p>CSRF ( Cross Site Request Forgery )，翻成中文叫做<strong>跨站請求偽造</strong>，其實字面上把他猜成拆開成請求偽造和跨站之後就蠻好理解的，怎麼說呢？ 我以前言的例子來說明一下<strong>跨站請求偽造是怎麼一回事</strong></p><p>先講請求偽造，請求偽造的意思很好理解，指的是陌生人拿了一張有你桌號的菜單點自己想點的餐之後給老闆這件事（ Hacker 用帶著你 cookie 的 Request 送給 web server ），那至於跨站跨在哪裡呢？</p><p>跨在陌生人在你不知情的情況下把有你桌號的菜單送給了老闆，所以跨過了本該知情的你（送出的人不同，所以送出 Request 的 Domain 註2) 也會不同），CSRF 的本質在於 web server 無條件信任 cookie 而沒有再確認或以其他方式驗證（ 等於老闆問也不問無條件相信菜單上的桌號，也不看是誰送的），因此只能保證這個Request 發自某個 User ，卻不能保證請求本身是 User 自願發出的（ 等於菜單上的桌號是你的，但不代表這個菜是你點的 ）。</p><h2 id="csrf-%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B"><a href="#csrf-%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B" class="direct-link">#</a> CSRF 攻擊流程</h2><p>用簡單的圖帶你看一下 Hacker 的犯案過程</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/jo/zerobased-cross-site-request-forgery/p1-1920w.webp 1920w, /img/posts/jo/zerobased-cross-site-request-forgery/p1-1280w.webp 1280w, /img/posts/jo/zerobased-cross-site-request-forgery/p1-840w.webp 840w, /img/posts/jo/zerobased-cross-site-request-forgery/p1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/jo/zerobased-cross-site-request-forgery/p1-1920w.png 1920w, /img/posts/jo/zerobased-cross-site-request-forgery/p1-1280w.png 1280w, /img/posts/jo/zerobased-cross-site-request-forgery/p1-840w.png 840w, /img/posts/jo/zerobased-cross-site-request-forgery/p1-320w.png 320w" type="image/png"><img alt="" src="/img/posts/jo/zerobased-cross-site-request-forgery/p1-1920w.png" height="597" width="800" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 597'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnElEQVQImU3OMQqDMABGYWeP6ik8iqNHcHSsRGIzSRA0JBrUShZJYwb9S9pS+tZveREAKWWe5wCu68JfEYA0TeM4FkIM7wCc5/m1LMuSJCmKYlmWqqqUUoyxfd+DOeee1m7b1nXdOI7GGM65tTbYPM83QgYh3HHoaaKUGmO898GUlLQs74TUdd00Def88xXssa66bde+11p773/DL88+pswZ/0eTAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><ol><li>User 訪問並登入 A 網站</li><li>User 獲得 Cookie 並存至 User 瀏覽器</li><li>User 在未登出 A 網站的情況下瀏覽 B 網站，接著 Hacker 以 B 網站的 Domain 以 A 網站給 User 的 Cookie 對 A 網站發送請求，如果 A 網站沒發現的話就 GG 了。</li></ol><p>＊Ｂ網站會在自身的網站中加入含 A 網站 Domain 的 Javascript ，例如：上方圖中的 <strong>A/pay?to=B</strong> ，這裡的 A 就是指 A 網站 Domain ，然後去執行 Pay 這個動作給 B ，這個攻擊的破綻就是剛剛前言例子中提到的，送出資料的Domain 不同，另外，貼心小提醒，在惡意網站中就算只是滑鼠移過圖片也可能會執行惡意的 Javascript 千萬不要覺得我都不點就沒事。</p><p>通常 Hacker 發現網站有漏洞時，都會以金流及竊取隱私資料為主要攻擊面向，畢竟 Hacker 除了做興趣也是要吃飯，因此當網站在設計關於金流及隱私資料的架構時需要特別小心，</p><h2 id="hacker%E5%AF%A6%E9%9A%9B%E5%88%A9%E7%94%A8csrf%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B"><a href="#hacker%E5%AF%A6%E9%9A%9B%E5%88%A9%E7%94%A8csrf%E6%BC%8F%E6%B4%9E%E6%A1%88%E4%BE%8B" class="direct-link">#</a> Hacker實際利用CSRF漏洞案例</h2><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/jo/zerobased-cross-site-request-forgery/p2-1920w.webp 1920w, /img/posts/jo/zerobased-cross-site-request-forgery/p2-1280w.webp 1280w, /img/posts/jo/zerobased-cross-site-request-forgery/p2-840w.webp 840w, /img/posts/jo/zerobased-cross-site-request-forgery/p2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/jo/zerobased-cross-site-request-forgery/p2-1920w.png 1920w, /img/posts/jo/zerobased-cross-site-request-forgery/p2-1280w.png 1280w, /img/posts/jo/zerobased-cross-site-request-forgery/p2-840w.png 840w, /img/posts/jo/zerobased-cross-site-request-forgery/p2-320w.png 320w" type="image/png"><img alt="" src="/img/posts/jo/zerobased-cross-site-request-forgery/p2-1920w.png" height="430" width="650" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 650 430'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA+ElEQVQImR3MMS8DYQCA4e8X0GvVJBo9ZRUmESRsEgn+AvEDkFwa/AFiEgshTVgYGptRYqhBRXLf9XoVS2+o1rmk53KhTt5P2uFd3uERtZqDaZpYloVt20gpcRwH13Wpu3XCMEQphWh5bRqNd4J2QPwb96bve5yc3VAoXHJ+ccXxaRERRd+0PJ9m8wP/06fz88dzucTgQJpkIkWiT2NMH0cQxwSvb3S+op7WzamajGZ1RjI6w0MZJiemEBVZ4f72jtLDI0/lFyVlVRWL111RpbQ0Wn+SXDaHODg8Yie/h5HfxzB22do2WN/YZGZ6jqXZBVbnF1lbXuEffuWs5f7FF50AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><strong>photo by <a href="https://www.ithome.com.tw/news/139205" rel="noopener noreferrer" target="_blank">https://www.ithome.com.tw/news/139205</a></strong></p><p>這個新聞是經典的 XSS 與 CSRF 聯動的漏洞， Hacker 在注入 XSS 之後，只要造訪被注入 XSS 頁面的是主辦單位， Hacker 可利用 CSRF 漏洞把自己的角色變更為協辦單位，而獲得可以存取社團所有功能的權限，包括利用程式變更主辦單位 PayPal 帳號的電子郵件，這表示之後這個社團舉辦的各種活動所收取的款項，都會流落到 Hacker 所指定的帳號中，而且因為電子郵件被變更，所以主辦單位也不會收到任何的郵件通知。</p><p>＊如果是對 XSS 不了解的朋友，歡迎看我的第二篇文章喔 XD</p><h3 id="%E9%81%94%E6%88%90-csrf-%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B%E4%B8%89%E8%A6%81%E7%B4%A0"><a href="#%E9%81%94%E6%88%90-csrf-%E6%94%BB%E6%93%8A%E6%B5%81%E7%A8%8B%E4%B8%89%E8%A6%81%E7%B4%A0" class="direct-link">#</a> 達成 CSRF 攻擊流程三要素</h3><ol><li>有一個可以觸發惡意腳本的動作</li><li>只以單一條件驗證網站身份，例如：只驗證 cookie 或 token</li><li>沒有驗證或是驗證的參數可以預測（固定的 cookie ）</li></ol><h2 id="%E5%A6%82%E4%BD%95%E9%98%B2%E7%AF%84-csrf"><a href="#%E5%A6%82%E4%BD%95%E9%98%B2%E7%AF%84-csrf" class="direct-link">#</a> 如何防範 CSRF</h2><p>防範 CSRF 的重點在於打破 CSRF 攻擊流程三要素，</p><ol><li>增加所有敏感動作的驗證方式，例如：金流、提交個資 等…多加一道驗證碼的機制</li><li>增加無法預測的參數，常見且有效的防範方式例如：<strong>CSRF token (在頁面的 form 或是 custom header 裡面放一個 token 並要求 client request 要夾帶這個 token )</strong></li></ol><h2 id="%E5%AF%A6%E4%BD%9C-csrf-token-%E9%82%8F%E8%BC%AF"><a href="#%E5%AF%A6%E4%BD%9C-csrf-token-%E9%82%8F%E8%BC%AF" class="direct-link">#</a> 實作 CSRF Token 邏輯</h2><p><strong>建立</strong>：在 User 打開網頁時，Server 會根據 User 的身份生成一個 Token ，將 Token 存放在頁面中（通常生成的基礎是 User 名稱加上隨機亂數或是時間戳記的加密組合，另外需要注意的是 Token 需要額外放置，不能依然存放在 Cookie 中，不然一樣會被整包帶走 ，建議是存在 Server 的 Session中）。</p><p><strong>傳送請求</strong>：之後只要有添加 Token 的頁面在提交請求時，都需要加上這個Token ，請求才會被允許，通常對於GET請求，Token會附在請求的網址之後，這樣 URL 會變成 <code>http://url?csrftoken=tokenvalue</code>而 POST 請求則會在 form 的最後加上：</p><pre class="language-txt"><code class="language-txt">&lt;input type=「hidden」 name=「csrftoken」 value=「tokenvalue」/>`</code></pre><p>把Token以參數的形式加入請求了。</p><p><strong>驗證</strong>：當 User 發送當有請求的 Token 給 Server 時，Server 為了要確定 Token 的時間有效性和正確性，會先解密 Token，對比加密過後的 User 名稱和當時的隨機亂數及時間戳記，如果加密的資料一致而且時間戳記沒有過期，Server 就會驗證通過，確認 Token 是有效的。</p><h2 id="%E7%B8%BD%E7%B5%90"><a href="#%E7%B8%BD%E7%B5%90" class="direct-link">#</a> 總結</h2><p>除了加上 CSRF Token 及多重驗證的防範方式以外，為避免 CSRF 風險，建議在每階段架構和設計時，使用經過審查的套件或框架。 使用諸如 owasp csrfguard 之類的反 CSRF 套件可以降低網頁 CSRF 的風險。</p><p>之後會再另開文章說明 CSRF 的兄弟 XSS 與網頁安全三本柱 Secure 、 samsite 、 httponly 他們之間不得不說的故事。</p><h2 id="%E5%90%8D%E8%A9%9E%E8%A7%A3%E9%87%8B"><a href="#%E5%90%8D%E8%A9%9E%E8%A7%A3%E9%87%8B" class="direct-link">#</a> 名詞解釋</h2><p><strong>註1</strong>：cookie：用來記錄User在網站上的操作及憑證，大多數電商網站，如PChome等都會使用 cookie 來紀錄網頁上的的操作資訊，常見的是紀錄購物車、會員登入或瀏覽紀錄、停留時間等，讓Web可以識別用戶的身分，User登入過後，可以無需再次登入就可以直接進行操作，。</p><p><strong>註2</strong>：domain：指的是網域名稱，簡單來說就是網站的地址，就如同住家地址一般，寄信的時候可以讓對方知道信是從哪裡寄來的。</p><p>熱騰騰的XSS文章出爐啦～</p><h2 id="%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80"><a href="#%E5%BB%B6%E4%BC%B8%E9%96%B1%E8%AE%80" class="direct-link">#</a> 延伸閱讀</h2><h3 id="%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89-%E8%AA%8D%E8%AD%98-xss%EF%BC%88cross-site-scripting%EF%BC%89"><a href="#%E9%9B%B6%E5%9F%BA%E7%A4%8E%E8%B3%87%E5%AE%89%E7%B3%BB%E5%88%97%EF%BC%88%E4%BA%8C%EF%BC%89-%E8%AA%8D%E8%AD%98-xss%EF%BC%88cross-site-scripting%EF%BC%89" class="direct-link">#</a> 零基礎資安系列（二）-認識 XSS（Cross-Site Scripting）</h3><blockquote><p><a href="https://tech-blog.cymetrics.io/jo/zerobased-cross-site-scripting">認識 XSS(Cross-Site Scripting</a></p></blockquote><h2 id="%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><a href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99" class="direct-link">#</a> 參考資料</h2><blockquote><p><a href="https://blog.techbridge.cc/2017/02/25/csrf-introduction/" rel="noopener noreferrer" target="_blank">https://blog.techbridge.cc/2017/02/25/csrf-introduction/</a></p></blockquote><blockquote><p><a href="https://kknews.cc/zh-tw/tech/veqpbna.html" rel="noopener noreferrer" target="_blank">https://kknews.cc/zh-tw/tech/veqpbna.html</a></p></blockquote><blockquote><p><a href="https://zh.wikipedia.org/wiki/%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0" rel="noopener noreferrer" target="_blank">https://zh.wikipedia.org/wiki/跨站請求偽造</a></p></blockquote><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/jo/zerobased-cross-site-request-forgery/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/zerobased/" class="post-tag">#ZeroBased</a> <a href="/tags/csrf/" class="post-tag">#CSRF</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/huli/sql-injection-in-action/">SQL injection 實戰：在限制底下提升速度</a></li><li><a href="/posts/nick/selenuim/">資安也要自動化 Selenium</a></li><li><a href="/posts/huli/what-is-log4j-and-log4shell/">從監視攝影機理解 Log4j 跟 Log4Shell 漏洞</a></li><li><a href="/posts/huli/learn-frontend-from-security-pov/">接觸資安才發現我不懂前端</a></li><li><a href="/posts/huli/clickjacking-intro/">不識廬山真面目：Clickjacking 點擊劫持攻擊</a></li></ol></div><div class="article-author"><img alt="jo" src="/img/authors/jo_logo.png" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/jo">jo</a></div><div class="article-author__intro">Love Cyber Security and commit to Cyber Security science popularization</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"零基礎資安系列（一）-認識 CSRF（Cross Site Request Forgery）","image":["https://tech-blog.cymetrics.io/img/posts/jo/zerobased-cross-site-request-forgery/p1-1920w.png","https://tech-blog.cymetrics.io/img/posts/jo/zerobased-cross-site-request-forgery/p2-1920w.png","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/jo_logo.png"],"author":{"@type":"Person","name":"jo"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/jo/zerobased-cross-site-request-forgery/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/jo/zerobased-cross-site-request-forgery/","datePublished":"2021-05-26","dateModified":"2022-04-22","description":"# 前言 陌生人＝ Hacker 菜單 ＝ Request 桌號＝ cookie 註1 老闆＝ web server 你 ＝ User 想像你到一家餐廳吃飯，陌生人拿了一張有你桌號的菜單點餐之後給老闆，結果老闆問也不問便收了菜單並將帳記到了你的身上，這就是 CSRF 的基礎概念。..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>