<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>WordPress Plugin Amelia &lt; 1.0.49 敏感資訊洩露漏洞細節</title><meta content="WordPress Plugin Amelia < 1.0.49 敏感資訊洩露漏洞細節" property="og:title"><meta content="WordPress Plugin Amelia < 1.0.49 敏感資訊洩露漏洞細節" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="Amelia 是一個由 TMS 公司所開發的 WordPress 外掛，能夠輕鬆幫你的 WordPress 網站加上預約系統的功能，例如說診所、理髮廳或是家教等等，都很適合使用這個外掛來架一個簡單的預約系統。根據 WordPress 官方的統計，大約有 40,000 個網站都安裝了這個 plugin。在三月初的時候我針對 Amelia 這套系統的原始碼做了一些研究，找到了三個都是敏感資訊洩露的漏洞" name="description"><meta content="Amelia 是一個由 TMS 公司所開發的 WordPress 外掛，能夠輕鬆幫你的 WordPress 網站加上預約系統的功能，例如說診所、理髮廳或是家教等等，都很適合使用這個外掛來架一個簡單的預約系統。根據 WordPress 官方的統計，大約有 40,000 個網站都安裝了這個 plugin。在三月初的時候我針對 Amelia 這套系統的原始碼做了一些研究，找到了三個都是敏感資訊洩露的漏洞" name="twitter:description"><meta content="Amelia 是一個由 TMS 公司所開發的 WordPress 外掛，能夠輕鬆幫你的 WordPress 網站加上預約系統的功能，例如說診所、理髮廳或是家教等等，都很適合使用這個外掛來架一個簡單的預約系統。根據 WordPress 官方的統計，大約有 40,000 個網站都安裝了這個 plugin。在三月初的時候我針對 Amelia 這套系統的原始碼做了一些研究，找到了三個都是敏感資訊洩露的漏洞" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/" property="og:url"><link href="https://blog.huli.tw/2022/03/30/wordpress-plugin-amelia-sensitive-information-disclosure/" rel="canonical"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/cover.png" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/cover.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,ol,p,pre,ul{font-size:1em}ol,p,pre,ul{margin-bottom:1.5em}body,ol,p,pre,ul{font-size:1rem;line-height:1.6}ol,p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,ol,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}body,ol,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.632rem}}table{display:table}code,pre,table{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol,li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.namespace{color:#e2777a}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property{color:#f8c555}.token.important,.token.keyword{color:#cc99cd}.token.string,.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a> <a href="/en">English</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">WordPress Plugin Amelia &lt; 1.0.49 敏感資訊洩露漏洞細節</h1><aside class="w-full"><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a></div><div class="post-avatar"><img alt="huli" src="/img/authors/huli_logo.jpg" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/huli">huli</a></div><div class="post-avatar__time">30 Mar 2022</div></div></div><div class="notice-block" data-nosnippet="" style="display:none;">我們正在尋找一位 Security Engineer 加入我們的團隊，詳情請參考<a href="https://github.com/cymetrics/blog/issues/13" rel="noopener noreferrer" target="_blank">職缺資訊</a></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p><a href="https://tw.wordpress.org/plugins/ameliabooking/" rel="noopener noreferrer" target="_blank">Amelia</a> 是一個由 TMS 公司所開發的 WordPress 外掛，能夠輕鬆幫你的 WordPress 網站加上預約系統的功能，例如說診所、理髮廳或是家教等等，都很適合使用這個外掛來架一個簡單的預約系統。根據 WordPress 官方的統計，大約有 40,000 個網站都安裝了這個 plugin。</p><p>在三月初的時候我針對 Amelia 這套系統的原始碼做了一些研究，找到了三個都是敏感資訊洩露的漏洞：</p><ul><li><code>CVE-2022-0720</code> Amelia &lt; 1.0.47 - Customer+ Arbitrary Appointments Update and Sensitive Data Disclosure (CVSS 6.3)</li><li><code>CVE-2022-0825</code> Amelia &lt; 1.0.49 - Customer+ Arbitrary Appointments Status Update (CVSS 6.3)</li><li><code>CVE-2022-0837</code> Amelia &lt; 1.0.48 - Customer+ SMS Service Abuse and Sensitive Data Disclosure (CVSS 5.4)</li></ul><p>如果被攻擊者利用這些漏洞，可以取得所有消費者的資料，包括姓名、電話以及預約資訊。</p><p>底下我會簡單介紹一下 Amelia 的架構以及這三個漏洞的細節。</p><h2 id="amelia-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9"><a href="#amelia-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%B4%B9" class="direct-link">#</a> Amelia 基本介紹</h2><p>安裝好 Amelia 以後，你可以新增一個預約頁面，大概是長這樣：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-320w.png 320w" type="image/png"><img alt="intro1" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1920w.png" height="1032" width="1514" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1514 1032'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAIAAACepSOSAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAs0lEQVQImQGoAFf/AM7k+X+48YW67oS47Ia36YK05YGy4nus3dLi8gCcx/IAbd8GcdoFbdQMb9ABZMYCX8AAVLWkxOMAo8rwDnXbGnnXF3XRFnDKE2zEE2m/B161qsfjAJ/H7gdu1BRz0RBtyQxowwxlvQphtwBWrafE4AClyewUcs8gd8sdcsUabr8ZaroYZ7UMXKqsxuAA9vj76e/15+315ez05e305Ozz5+3z6O3z9/j6AZNi4ASqriAAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>在預約時需要提供一些基本資料，例如說姓名以及 email 等等，輸入後即可完成預約：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-320w.png 320w" type="image/png"><img alt="intro2" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1920w.png" height="1714" width="1686" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1686 1714'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfElEQVQImVXOwQ6CQAwEUP7/r/wO0YMQoArBXZawFtohgxy0t+nrJC2qIQ+TAuglPtsAwM3cvShlbsYMIKUcwkxwNzPCtRkBA6DK6gk3SXWfmMFxwE7o0kMi747tL8TqNX3hr1F2sSYwr3yH2wPaIO8FwPJZL3fVjbXNbAd3ornG07e+XAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>完成預約以後，Amelia 會幫你在 WordPress 系統裡面新增一個低權限的帳號，並且把重設密碼的連結寄到剛剛提供的信箱。帳號開通以後，就可以登入 WordPress 管理剛剛的預約：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-320w.png 320w" type="image/png"><img alt="intro3" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1920w.png" height="1222" width="2526" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2526 1222'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAIAAAAcxIEBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmklEQVQImWXKqQ7CQBCA4X0DUA2hQSDRWBSah8LiUJzVWF6EcPRuCG/A1W13tjOzdAkg+fLLX3T7w/Fkmp0vu/3hePL9IPwVhFEUJ0maid5g5G221lokrm1t/4iW21ksV9ZapYA+GBGRCJHJvMgY0XDc2feQJZQVIRKzQWI0TE/J90I0nfZ87clCxkmaawIFWlcAugRQt0d1zd9UL4o7NzkNOgAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>使用方式介紹完以後，我們來看一下更技術的部分。</p><h2 id="wordpress-%E5%A4%96%E6%8E%9B%E8%88%87-amelia-%E6%9E%B6%E6%A7%8B%E4%BB%8B%E7%B4%B9"><a href="#wordpress-%E5%A4%96%E6%8E%9B%E8%88%87-amelia-%E6%9E%B6%E6%A7%8B%E4%BB%8B%E7%B4%B9" class="direct-link">#</a> WordPress 外掛與 Amelia 架構介紹</h2><p>WordPress 的外掛有很多，每一個的寫法都不太一樣，但因為是外掛，所以會呼叫 WordPress 提供的函式來註冊事件。</p><p><code>add_action</code> 這個函式就扮演著很重要的角色，你可以幫特定的 action 加上一個 hook，當這個 action 被觸發時，就會呼叫到你提供的函式。</p><p>其中由 <code>wp_ajax_nopriv_</code> 開頭的 action，可以透過 <code>wp-admin/admin-ajax.php</code> 來呼叫，相關程式碼節錄如下（<a href="https://github.com/WordPress/WordPress/blob/master/wp-admin/admin-ajax.php" rel="noopener noreferrer" target="_blank">admin-ajax.php</a>）：</p><pre class="language-php"><code class="language-php"><span class="token language-php php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token variable">$action</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">is_user_logged_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// If no action is registered, return a Bad Request response.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">has_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$action</span><span class="token punctuation">}</span></span>"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">wp_die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token number">400</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">/**<br>   * Fires authenticated Ajax actions for logged-in users.<br>   *<br>   * The dynamic portion of the hook name, `$action`, refers<br>   * to the name of the Ajax action callback being fired.<br>   *<br>   * @since 2.1.0<br>   */</span><br>  <span class="token function">do_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$action</span><span class="token punctuation">}</span></span>"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>  <span class="token comment">// If no action is registered, return a Bad Request response.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">has_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_nopriv_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$action</span><span class="token punctuation">}</span></span>"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">wp_die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'0'</span><span class="token punctuation">,</span> <span class="token number">400</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">/**<br>   * Fires non-authenticated Ajax actions for logged-out users.<br>   *<br>   * The dynamic portion of the hook name, `$action`, refers<br>   * to the name of the Ajax action callback being fired.<br>   *<br>   * @since 2.8.0<br>   */</span><br>  <span class="token function">do_action</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"wp_ajax_nopriv_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$action</span><span class="token punctuation">}</span></span>"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token delimiter important">?></span></span></code></pre><p>以 Amelia 來說，在 <code>ameliabooking.php</code> 中註冊了兩個 hook：</p><pre class="language-php"><code class="language-php"><span class="token comment">/** Isolate API calls */</span><br><span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_ajax_wpamelia_api'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AmeliaBooking\Plugin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wpAmeliaApiCall'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_ajax_nopriv_wpamelia_api'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AmeliaBooking\Plugin'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wpAmeliaApiCall'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>有 <code>nopriv</code> 的代表沒有權限（未登入）也可以呼叫，沒有的代表需要登入 WordPress 系統才能呼叫，而許多的 plugin 會選擇自己處理身份驗證相關的邏輯，所以會把兩個動作都導到同一個地方。</p><p>而 <code>wpAmeliaApiCall</code> 這個函式則是註冊了 routes：</p><pre class="language-php"><code class="language-php"><span class="token comment">/**<br> * API Call<br> *<br> * @throws \InvalidArgumentException<br> */</span><br><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function function-definition">wpAmeliaApiCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        <span class="token comment">/** @var Container $container */</span><br>        <span class="token variable">$container</span> <span class="token operator">=</span> <span class="token keyword">require</span> <span class="token constant">AMELIA_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/src/Infrastructure/ContainerConfig/container.php'</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$app</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">App</span><span class="token punctuation">(</span><span class="token variable">$container</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Initialize all API routes</span><br>        <span class="token class-name static-context">Routes</span><span class="token operator">::</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token variable">$app</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'ERROR: '</span> <span class="token operator">.</span> <span class="token variable">$e</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>在 <code>src/Infrastructure/Routes</code> 底下有許多的資料夾跟檔案，裡面負責處理不同的路由，舉例來說，User 相關的路由在 <code>src/Infrastructure/Routes/User/User.php</code>，相關程式碼節錄如下：</p><pre class="language-php"><code class="language-php"><span class="token comment">/**<br> * Class User<br> *<br> * @package AmeliaBooking\Infrastructure\Routes\User<br> */</span><br><span class="token keyword">class</span> <span class="token class-name class-name-definition">User</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/**<br>     * @param App $app<br>     */</span><br>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function function-definition">routes</span><span class="token punctuation">(</span><span class="token class-name type-declaration">App</span> <span class="token variable">$app</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/wp-users'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetWPUsersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/authenticate'</span><span class="token punctuation">,</span> <span class="token class-name static-context">LoginCabinetController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/logout'</span><span class="token punctuation">,</span> <span class="token class-name static-context">LogoutCabinetController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Customers</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCustomersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateCustomerController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/delete/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/effect/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetUserDeleteEffectController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/customers/reauthorize'</span><span class="token punctuation">,</span> <span class="token class-name static-context">ReauthorizeController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Providers</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetProvidersController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateProviderController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/status/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateProviderStatusController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/delete/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/providers/effect/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetUserDeleteEffectController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">// Current User</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/users/current'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetCurrentUserController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>那實際上到底要怎麼呼叫到這些路由呢？在 <code>src/Infrastructure/ContainerConfig/request.php</code> 中，針對 request 的 query string 做了一些轉換：</p><pre class="language-php"><code class="language-php"><span class="token language-php php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Uri</span><span class="token punctuation">;</span><br><br><span class="token variable">$entries</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'request'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified type-declaration">AmeliaBooking<span class="token punctuation">\</span>Infrastructure<span class="token punctuation">\</span>Common<span class="token punctuation">\</span>Container</span> <span class="token variable">$c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>    <span class="token variable">$curUri</span> <span class="token operator">=</span> <span class="token class-name static-context">Uri</span><span class="token operator">::</span><span class="token function">createFromEnvironment</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'environment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token comment">// 附註：AMELIA_ACTION_SLUG = "action=wpamelia_api&call="</span><br>    <span class="token variable">$newRoute</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><br>        <span class="token punctuation">[</span><span class="token string single-quoted-string">'XDEBUG_SESSION_START=PHPSTORM&'</span> <span class="token operator">.</span> <span class="token constant">AMELIA_ACTION_SLUG</span><span class="token punctuation">,</span> <span class="token constant">AMELIA_ACTION_SLUG</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span><br>        <span class="token variable">$curUri</span><span class="token operator">-></span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$newPath</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">substr</span><span class="token punctuation">(</span><br>        <span class="token variable">$newRoute</span><span class="token punctuation">,</span><br>        <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token variable">$newRoute</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$newQuery</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">substr</span><span class="token punctuation">(</span><br>        <span class="token variable">$newRoute</span><span class="token punctuation">,</span><br>        <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$newRoute</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'&'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><br>    <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span><br><br>   <span class="token variable">$request</span> <span class="token operator">=</span> <span class="token class-name static-context">Request</span><span class="token operator">::</span><span class="token function">createFromEnvironment</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'environment'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>       <span class="token operator">-></span><span class="token function">withUri</span><span class="token punctuation">(</span><br>           <span class="token variable">$curUri</span><br>               <span class="token operator">-></span><span class="token function">withPath</span><span class="token punctuation">(</span><span class="token variable">$newPath</span><span class="token punctuation">)</span><br>               <span class="token operator">-></span><span class="token function">withQuery</span><span class="token punctuation">(</span><span class="token variable">$newQuery</span><span class="token punctuation">)</span><br>       <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">method_exists</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'getParam'</span><span class="token punctuation">)</span> <span class="token operator">&&</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'showAmeliaErrors'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'display_errors'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token function">ini_set</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'display_startup_errors'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token constant">E_ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$request</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre><p>簡單來說呢，當你的 request URL 長這樣的時候：<code>/wordpress/wp-admin/admin-ajax.php?action=wpamelia_api&call=/users/wp-users</code>，query string 就是 <code>action=wpamelia_api&call=/users/wp-users</code>，符合 AMELIA_ACTION_SLUG 的地方被換成空白之後，就變成了 <code>/users/wp-users</code>，就對應到了上面的檔案看到的路由，重新交由 Slim 這個 PHP 框架去處理。</p><p>而 <code>/users/wp-users</code> 對應到的是 <code>GetWPUsersController::class</code>，讓我們來看一下 controller 的程式碼：</p><pre class="language-php"><code class="language-php"><span class="token language-php php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token keyword">namespace</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>User</span><span class="token punctuation">;</span><br><br><span class="token keyword">use</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Commands<span class="token punctuation">\</span>User<span class="token punctuation">\</span>GetWPUsersCommand</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token package">AmeliaBooking<span class="token punctuation">\</span>Application<span class="token punctuation">\</span>Controller<span class="token punctuation">\</span>Controller</span><span class="token punctuation">;</span><br><span class="token keyword">use</span> <span class="token package">Slim<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Request</span><span class="token punctuation">;</span><br><br><span class="token comment">/**<br> * Class GetWPUsersController<br> *<br> * @package AmeliaBooking\Application\Controller\User<br> */</span><br><span class="token keyword">class</span> <span class="token class-name class-name-definition">GetWPUsersController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/**<br>     * Instantiates the Get WP Users command to hand it over to the Command Handler<br>     *<br>     * @param Request $request<br>     * @param         $args<br>     *<br>     * @return GetWPUsersCommand<br>     * @throws \RuntimeException<br>     */</span><br>    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function function-definition">instantiateCommand</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$command</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetWPUsersCommand</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword type-casting">int</span><span class="token punctuation">)</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'role'</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParam</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'role'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$requestBody</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getParsedBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">setCommandFields</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">,</span> <span class="token variable">$requestBody</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">return</span> <span class="token variable">$command</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></span></code></pre><p>這邊使用了設計模式中的 Command Pattern，把每一個動作都包裝成一個指令，那這個指令會被誰處理呢？每一個 controller 都繼承了 <code>AmeliaBooking\Application\Controller\Controller</code>，所以處理的程式碼就在裡面：</p><pre class="language-php"><code class="language-php"><span class="token comment">/**<br> * @param Request  $request<br> * @param Response $response<br> * @param          $args<br> *<br> * @return Response<br> * @throws \InvalidArgumentException<br> * @throws \RuntimeException<br> */</span><br><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">__invoke</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">Response</span> <span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/** @var Command $command */</span><br>    <span class="token variable">$command</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">instantiateCommand</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token punctuation">(</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteUserCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCategoryCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteServiceCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteExtraCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteLocationCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePaymentCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCouponCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCustomFieldCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteAppointmentCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteBookingCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventBookingCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCustomerCommand</span> <span class="token operator">||</span><br>            <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteNotificationCommand</span><br>        <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">/** @var CommandResult $commandResult */</span><br>    <span class="token variable">$commandResult</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">commandBus</span><span class="token operator">-></span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">emitSuccessEvent</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">eventBus</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">/** @var Response $response */</span><br>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Location'</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_REDIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">hasAttachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token variable">$responseBody</span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>            <span class="token string single-quoted-string">'message'</span> <span class="token operator">=></span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            <span class="token string single-quoted-string">'data'</span>    <span class="token operator">=></span> <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>        <span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">emitSuccessEvent</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">eventBus</span><span class="token punctuation">,</span> <span class="token variable">$commandResult</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>                <span class="token keyword">break</span><span class="token punctuation">;</span><br>            <span class="token keyword">case</span> <span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_CONFLICT</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_CONFLICT</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>                <span class="token keyword">break</span><span class="token punctuation">;</span><br>            <span class="token keyword">default</span><span class="token punctuation">:</span><br>                <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>                <span class="token keyword">break</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token comment">/** @var Response $response */</span><br>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withHeader</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'application/json;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">write</span><span class="token punctuation">(</span><br>            <span class="token function">json_encode</span><span class="token punctuation">(</span><br>                <span class="token variable">$commandResult</span><span class="token operator">-></span><span class="token function">hasDataInResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span><br>                    <span class="token variable">$responseBody</span> <span class="token punctuation">:</span> <span class="token function">array_merge</span><span class="token punctuation">(</span><span class="token variable">$responseBody</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'data'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>            <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>這邊先實例化一個指令之後，再丟到 commandBus 去做處理：<code>$this->commandBus->handle($command)</code>，程式碼在 <code>src/Infrastructure/ContainerConfig/command.bus.php</code>，節錄部分：</p><pre class="language-php"><code class="language-php"><span class="token language-php php"><span class="token delimiter important">&lt;?php</span><br><br><span class="token function">defined</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ABSPATH'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'No script kiddies please!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// @codingStandardsIgnoreStart</span><br><span class="token variable">$entries</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'command.bus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token variable">$commands</span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>        <span class="token comment">// User</span><br>        <span class="token class-name static-context class-name-fully-qualified">User<span class="token punctuation">\</span>DeleteUserCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                             <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>DeleteUserCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token class-name static-context class-name-fully-qualified">User<span class="token punctuation">\</span>GetCurrentUserCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                         <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetCurrentUserCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token class-name static-context class-name-fully-qualified">User<span class="token punctuation">\</span>GetUserDeleteEffectCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                    <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetUserDeleteEffectCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token class-name static-context class-name-fully-qualified">User<span class="token punctuation">\</span>GetWPUsersCommand</span><span class="token operator">::</span><span class="token keyword">class</span>                             <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">User<span class="token punctuation">\</span>GetWPUsersCommandHandler</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><br>        <span class="token comment">// more commands...</span><br>    <span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token class-name static-context class-name-fully-qualified">League<span class="token punctuation">\</span>Tactician<span class="token punctuation">\</span>Setup<span class="token punctuation">\</span>QuickStart</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token variable">$commands</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token comment">// @codingStandardsIgnoreEnd</span><br></span></code></pre><p>從中可以看出我們的 <code>GetWPUsersCommand</code> 會被 <code>User\GetWPUsersCommandHandler</code> 處理，所以主要的邏輯就在這裡面：</p><pre class="language-php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name class-name-definition">GetWPUsersCommandHandler</span> <span class="token keyword">extends</span> <span class="token class-name">CommandHandler</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/**<br>     * @param GetWPUsersCommand $command<br>     *<br>     * @return CommandResult<br>     * @throws AccessDeniedException<br>     * @throws InvalidArgumentException<br>     * @throws \AmeliaBooking\Infrastructure\Common\Exceptions\QueryExecutionException<br>     * @throws \Interop\Container\Exception\ContainerException<br>     */</span><br>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">handle</span><span class="token punctuation">(</span><span class="token class-name type-declaration">GetWPUsersCommand</span> <span class="token variable">$command</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanRead</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">EMPLOYEES</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to read employees.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanRead</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">CUSTOMERS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to read customers.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">checkMandatoryFields</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">/** @var UserService $userService */</span><br>        <span class="token variable">$userService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'users.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$adminIds</span> <span class="token operator">=</span> <span class="token variable">$userService</span><span class="token operator">-></span><span class="token function">getWpUserIdsByRoles</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'administrator'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token comment">/** @var WPUserRepository $wpUserRepository */</span><br>        <span class="token variable">$wpUserRepository</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'domain.wpUsers.repository'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Successfully retrieved users.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">[</span><br>            <span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">USER</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'s'</span> <span class="token operator">=></span> <span class="token variable">$wpUserRepository</span><span class="token operator">-></span><span class="token function">getAllNonRelatedWPUsers</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$adminIds</span><span class="token punctuation">)</span><br>        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>可以看到業務邏輯都在 <code>handle</code> 這個函式裡面，裡面先檢查了權限，接著透過 <code>userService</code> 抓取相關資料，再來用 <code>$result->setData</code> 設置要回傳的資料，最後回傳結果，交給其他 infra 相關程式碼處理。</p><p>另外，在 controller 中可以看到 command 相關的權限檢查：</p><pre class="language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>  <span class="token punctuation">(</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteUserCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCategoryCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteServiceCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteExtraCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteLocationCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePaymentCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCouponCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteCustomFieldCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteAppointmentCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteBookingCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteEventBookingCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeletePackageCustomerCommand</span> <span class="token operator">||</span><br>      <span class="token variable">$command</span> <span class="token keyword">instanceof</span> <span class="token class-name">DeleteNotificationCommand</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token variable">$response</span><span class="token operator">-></span><span class="token function">withStatus</span><span class="token punctuation">(</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">STATUS_INTERNAL_SERVER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>如果是這些 delete 的指令，就需要通過 <code>wp_verify_nonce</code> 的檢查，這是什麼東西呢？</p><p><code>wp_verify_nonce</code> 是 WordPress 提供用於安全性檢查的函式，對應的函式是 <code>wp_create_nonce</code>，在 WordPress 後台管理頁面有這樣一行程式碼：<code>var wpAmeliaNonce = '&lt;?php echo wp_create_nonce('ajax-nonce'); ?>';</code>，會產生一個名稱為 <code>ajax-nonce</code> 的 nonce，而這個 nonce 其實就是把一些字串 hash 過後的結果。</p><p>如果你拿不到 hash 時用的 salt，基本上不可能偽造出 nonce，因為 salt 預設都非常長，而且都是安裝時隨機產生的：</p><pre class="language-php"><code class="language-php"><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AUTH_KEY'</span><span class="token punctuation">,</span>         <span class="token string single-quoted-string">' Xakm&lt;o xQy rw4EMsLKM-?!T+,PFF})H4lzcW57AF0U@N@&lt; >M%G4Yt>f`z]MON'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SECURE_AUTH_KEY'</span><span class="token punctuation">,</span>  <span class="token string single-quoted-string">'LzJ}op]mr|6+![P}Ak:uNdJCJZd>(Hx.-Mh#Tz)pCIU#uGEnfFz|f ;;eU%/U^O~'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LOGGED_IN_KEY'</span><span class="token punctuation">,</span>    <span class="token string single-quoted-string">'|i|Ux`9&lt;p-h$aFf(qnT:sDO:D1P^wZ$$/Ra@miTJi9G;ddp_&lt;q}6H1)o|a +&JCM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'NONCE_KEY'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'%:R{[P|,s.KuMltH5}cI;/k&lt;Gx~j!f0I)m_sIyu+&NJZ)-iO>z7X>QYR0Z_XnZ@|'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AUTH_SALT'</span><span class="token punctuation">,</span>        <span class="token string single-quoted-string">'eZyT)-Naw]F8CwA*VaW#q*|.)g@o}||wf~@C-YSt}(dh_r6EbI#A,y|nU2{B#JBW'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SECURE_AUTH_SALT'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'!=oLUTXh,QW=H `}`L|9/^4-3 STz},T(w}W&lt;I`.JjPi)&lt;Bmf1v,HpGe}T1:Xt7n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'LOGGED_IN_SALT'</span><span class="token punctuation">,</span>   <span class="token string single-quoted-string">'+XSqHc;@Q*K_b|Z?NC[3H!!EONbh.n&lt;+=uKR:>*c(u`g~EJBf#8u#R{mUEZrozmm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'NONCE_SALT'</span><span class="token punctuation">,</span>       <span class="token string single-quoted-string">'h`GXHhD>SLWVfg1(1(N{;.V!MoE(SfbA_ksP@&`+AycHcAV$+?@3q+rxV{%^VyKT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>因此，透過 <code>wp_verify_nonce</code>，我們可以確保只有已登入的使用者能使用到某些功能，因為沒登入的話拿不到 nonce。</p><p>以上就是 Amelia 的基本架構跟處理流程，是我看過的幾個 plugin 中最為漂亮的一個，東西都整理得很好，架構也切得不錯，不會出現一堆雜七雜八的程式碼，要找東西也很好找，只要去 routes 看一下網址跟對應的 controller，循線找到 command 跟 command handler 即可。</p><p>接著，就來談談開頭提到的那三個漏洞。</p><h2 id="cve-2022-0720%3A-amelia-%3C-1.0.47---customer%2B-arbitrary-appointments-update-and-sensitive-data-disclosure"><a href="#cve-2022-0720%3A-amelia-%3C-1.0.47---customer%2B-arbitrary-appointments-update-and-sensitive-data-disclosure" class="direct-link">#</a> CVE-2022-0720: Amelia &lt; 1.0.47 - Customer+ Arbitrary Appointments Update and Sensitive Data Disclosure</h2><p>管理訂房相關的模組有兩個，一個叫做 Appointment，另一個叫做 Booking，他們是一對多的關係，一個 Appointment 底下可以對應到多個 Booking，相關路由如下：</p><p><code>src/Infrastructure/Routes/Booking/Appointment/Appointment.php</code></p><pre class="language-php"><code class="language-php"><span class="token keyword">class</span> <span class="token class-name class-name-definition">Appointment</span><br><span class="token punctuation">{</span><br>    <span class="token comment">/**<br>     * @param App $app<br>     *<br>     * @throws \InvalidArgumentException<br>     */</span><br>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function function-definition">routes</span><span class="token punctuation">(</span><span class="token class-name type-declaration">App</span> <span class="token variable">$app</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetAppointmentsController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">GetAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments'</span><span class="token punctuation">,</span> <span class="token class-name static-context">AddAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/delete/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">DeleteAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/status/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentStatusController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token variable">$app</span><span class="token operator">-></span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/appointments/time/{id:[0-9]+}'</span><span class="token punctuation">,</span> <span class="token class-name static-context">UpdateAppointmentTimeController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>以顯示 appointment 的路由 <code>/appointments/{id:[0-9]+}</code> 為例，對應到 <code>GetAppointmentController</code>，在 controller 中會去呼叫 <code>GetAppointmentCommandHandler</code>，裡面有段程式碼是這樣的：</p><pre class="language-php"><code class="language-php"><span class="token variable">$customerAS</span><span class="token operator">-></span><span class="token function">removeBookingsForOtherCustomers</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Collection</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token variable">$appointment</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>在回傳資料前，會把不屬於自己的 booking 全部都過濾掉，所以看不到其他人的資料，有做好權限管理。</p><p>而更新 appointment 的路由對應到的 controller 是 <code>UpdateAppointmentController</code>，又對應到了 <code>UpdateAppointmentCommandHandler.php</code>，部分程式碼如下：</p><pre class="language-php"><code class="language-php"><span class="token keyword">try</span> <span class="token punctuation">{</span><br>    <span class="token comment">/** @var AbstractUser $user */</span><br>    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">authorization</span><span class="token punctuation">(</span><br>        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'cabinet'</span> <span class="token operator">?</span> <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token class-name return-type">null</span><span class="token punctuation">,</span><br>        <span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getCabinetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthorizationException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span><br>        <span class="token punctuation">[</span><br>            <span class="token string single-quoted-string">'reauthorize'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><br>        <span class="token punctuation">]</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">isProvider</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span> <span class="token operator">&&</span> <span class="token operator">!</span><span class="token variable">$settingsDS</span><span class="token operator">-></span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'roles'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'allowWriteAppointments'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// update appointment</span></code></pre><p>開頭有檢查了兩樣東西，第一樣是使用者是否登入，所以儘管沒有 nonce 也可以進來這個路由，在這邊還是會被擋下來。第二樣則是使用者的身份，如果是 provider 才會檢查有沒有權限。</p><p>在 Amelia 中基本上有幾個角色，消費者（Customer)、服務提供者（Provider）以及管理員（Admin），所以只要我們不是 provider，就可以通過這邊的檢查。</p><p>開頭有提過只要透過 Amelia 的外掛隨便預約一個服務，就可以在 WordPress 的系統中註冊一個 customer 的帳號，這組帳號可以登入 WordPress，來管理自己之前的預約。</p><p>因此，這邊的權限檢查是有漏洞的，一個 customer 身份的使用者可以通過這邊的檢查，去竄改其他人的預約。雖然看起來好像很普通，但其實使用者在前台修改自己的預約時，用的是另外一個 <code>/bookings/{id}</code> 的 API，這個 appointment 的 API 我猜預設是給 provider 使用的，所以才沒考慮到 customer 的狀況。</p><p>那除了修改 booking 以外，還可以幹嘛呢？我們來看一下更新完的 response：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-320w.png 320w" type="image/png"><img alt="update booking" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1920w.png" height="1668" width="2084" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2084 1668'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnklEQVQImRXJURKCIBAAUO5/uT7LRh01y8UEARdYSNjGzzdP3Jtp6Md9NynQAqptx0V+Q4iHj6Lv5DS9jdmJolL4bD4ACyKWUkTXyte8IgYi8khytSEH+qXr1scw3xq4j/IxlUTb5q3zzHydAXWsxmt/aM+1gt5nDTbbI6GwjjaNzFwrM7OUDsAyXxBaObVhLeX8nTGSc8FjOs+Sc/4DR/KxyA097mcAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>我們可以看到 response 中有個 info 欄位，裡面有原本消費者的個人資料，包括姓名以及電話等等，這個欄位是在 <code>src/Application/Services/Reservation/AbstractReservationService.php</code> 中的 <code>processBooking</code> 時儲存的：</p><pre class="language-php"><code class="language-php"><span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'info'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><br><span class="token punctuation">[</span><br>    <span class="token string single-quoted-string">'firstName'</span> <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'firstName'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'lastName'</span>  <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'lastName'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'phone'</span>     <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'bookings'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'customer'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'locale'</span>    <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'locale'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'timeZone'</span>  <span class="token operator">=></span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'timeZone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'urlParams'</span> <span class="token operator">=></span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlParams'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$appointmentData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlParams'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span><br><span class="token punctuation">]</span><br><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>總結一下，因為權限檢查沒做好，所以 customer 可以更新其他人的預約，並且看到消費者的個人資料，而 appointment 的 ID 是流水號，所以直接列舉一下，就可以把系統中所有人的個資都撈出來。</p><h3 id="%E4%BF%AE%E5%BE%A9%E6%96%B9%E5%BC%8F"><a href="#%E4%BF%AE%E5%BE%A9%E6%96%B9%E5%BC%8F" class="direct-link">#</a> 修復方式</h3><p>在 1.0.47 版中，有做出了兩個變動，第一個是針對我回報的問題，加上了對於 customer 的權限檢查：</p><pre class="language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$userAS</span><span class="token operator">-></span><span class="token function">isCustomer</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>第二個改動則是 routes 的權限檢查，從負面表列變成正面表列，只有幾個特定的 command 不需登入：</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">validateNonce</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'POST'</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">LoginCabinetCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">AddBookingCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">AddStatsCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">MolliePaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">MolliePaymentNotifyCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">PayPalPaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">PayPalPaymentCallbackCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">RazorpayPaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">WooCommercePaymentCommand</span><span class="token punctuation">)</span> <span class="token operator">&&</span><br>        <span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">SuccessfulBookingCommand</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-></span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ameliaNonce'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ajax-nonce'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2 id="cve-2022-0825%3A-amelia-%3C-1.0.49---customer%2B-arbitrary-appointments-status-update"><a href="#cve-2022-0825%3A-amelia-%3C-1.0.49---customer%2B-arbitrary-appointments-status-update" class="direct-link">#</a> CVE-2022-0825: Amelia &lt; 1.0.49 - Customer+ Arbitrary Appointments Status Update</h2><p>這個漏洞跟上一個類似，都是屬於權限管理的問題，而這個漏洞的路由是 <code>$app->post('/appointments/status/{id:[0-9]+}', UpdateAppointmentStatusController::class);</code>，對應到的程式碼在 <code>src/Application/Commands/Booking/Appointment/UpdateAppointmentStatusCommandHandler.php</code>，開頭有先做權限檢查：</p><pre class="language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanWriteStatus</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">APPOINTMENTS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to update appointment status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// update appointment</span></code></pre><p>我們繼續往下追，去看看 <code>currentUserCanWriteStatus</code> 是怎麼實作的：</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">currentUserCanWriteStatus</span><span class="token punctuation">(</span><span class="token variable">$object</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">userCan</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token property">currentUser</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token keyword static-context">self</span><span class="token operator">::</span><span class="token constant">WRITE_STATUS_PERMISSIONS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>再往下追，找到 <code>userCan</code>：</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">userCan</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token keyword">instanceof</span> <span class="token class-name">Admin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">permissionsChecker</span><span class="token operator">-></span><span class="token function">checkPermissions</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>再往下一層，在 <code>src/Infrastructure/WP/PermissionsService/PermissionsChecker.php</code> 中可以看到 <code>checkPermissions</code> 的實作：</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">checkPermissions</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token variable">$object</span><span class="token punctuation">,</span> <span class="token variable">$permission</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token comment">// Admin can do all</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token keyword">instanceof</span> <span class="token class-name">Admin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Get the WP role name of the user, rollback to customer by default</span><br>    <span class="token variable">$wpRoleName</span> <span class="token operator">=</span> <span class="token variable">$user</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'wpamelia-'</span> <span class="token operator">.</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">'wpamelia-customer'</span><span class="token punctuation">;</span><br>    <span class="token comment">// Get the wp name of capability we are looking for.</span><br>    <span class="token variable">$wpCapability</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"amelia_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$permission</span><span class="token punctuation">}</span></span>_<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$object</span><span class="token punctuation">}</span></span>"</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$user</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">&&</span> <span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getExternalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token function">user_can</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-></span><span class="token function">getExternalId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$wpCapability</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// If user is guest check does it have capability</span><br>    <span class="token variable">$wpRole</span> <span class="token operator">=</span> <span class="token function">get_role</span><span class="token punctuation">(</span><span class="token variable">$wpRoleName</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token variable">$wpRole</span> <span class="token operator">!==</span> <span class="token constant">null</span> <span class="token operator">&&</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$wpRole</span><span class="token operator">-></span><span class="token property">capabilities</span><span class="token punctuation">[</span><span class="token variable">$wpCapability</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span><br>        <span class="token punctuation">(</span><span class="token keyword type-casting">bool</span><span class="token punctuation">)</span><span class="token variable">$wpRole</span><span class="token operator">-></span><span class="token property">capabilities</span><span class="token punctuation">[</span><span class="token variable">$wpCapability</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>這邊有個值得注意的地方，就是如果 user 是 <code>null</code> 的話，會被當成 <code>customer</code> 來看待，而實際檢查有沒有權限要看 capabilities 這個 table，在 <code>src/Infrastructure/WP/config/Roles.php</code>：</p><pre class="language-php"><code class="language-php"><span class="token comment">// Customer</span><br><span class="token punctuation">[</span><br>    <span class="token string single-quoted-string">'name'</span>         <span class="token operator">=></span> <span class="token string single-quoted-string">'wpamelia-customer'</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'label'</span>        <span class="token operator">=></span> <span class="token function">__</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Amelia Customer'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'amelia'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token string single-quoted-string">'capabilities'</span> <span class="token operator">=></span> <span class="token punctuation">[</span><br>        <span class="token string single-quoted-string">'read'</span>                             <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_read_menu'</span>                 <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_read_calendar'</span>             <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_read_appointments'</span>         <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_read_events'</span>               <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_write_status_appointments'</span> <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'amelia_write_time_appointments'</span>   <span class="token operator">=></span> <span class="token constant boolean">true</span><span class="token punctuation">,</span><br>    <span class="token punctuation">]</span><br><span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre><p>其中 <code>amelia_write_status_appointments</code> 是 true，代表 customer 有權限更新狀態。</p><p>剩下的部分就跟上一個漏洞一樣了，更新 appointment 之後資料會整包回傳，透過 info 這個欄位可以看到消費者的個人資料。另外，這個漏洞在 1.0.47 以前會是 pre-auth 的，因為 1.0.47 以前 routes 的權限檢查還沒變成正面表列，所以沒登入也可以存取到這個指令，再加上 user 是 null 的話預設是消費者身份，完成了整條攻擊鏈的串接：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-320w.png 320w" type="image/png"><img alt="update booking status" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1920w.png" height="1616" width="2072" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2072 1616'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmUlEQVQImSWMyw7CIBAA+f//01oP9hGgtQIlsLSwPNZY5zCXSYZ1/SDF4qzHcKyrmma+6T3GaD2wZy/miSuljgBaQ/fgUsoAodbK7jcxvKQ1JsYTIAlp/OH8AZiRjaMRwoJx6UxETesAIRJRa40hIl209vPyMVy9AT0gsJzzVehKpIxbth0L5poZANRa/xPEZPeTS5NKKrl8AbPZszF5XXsKAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h3 id="%E4%BF%AE%E5%BE%A9%E6%96%B9%E5%BC%8F-2"><a href="#%E4%BF%AE%E5%BE%A9%E6%96%B9%E5%BC%8F-2" class="direct-link">#</a> 修復方式</h3><p>在 1.0.49 版中，移除了 customer 的 <code>amelia_write_status_appointments</code> 這個權限。</p><h2 id="cve-2022-0837%3A-amelia-%3C-1.0.48---customer%2B-sms-service-abuse-and-sensitive-data-disclosure"><a href="#cve-2022-0837%3A-amelia-%3C-1.0.48---customer%2B-sms-service-abuse-and-sensitive-data-disclosure" class="direct-link">#</a> CVE-2022-0837: Amelia &lt; 1.0.48 - Customer+ SMS Service Abuse and Sensitive Data Disclosure</h2><p>來看最後一個權限檢查相關漏洞，出問題的路由是 <code>$app->post('/notifications/sms', SendAmeliaSmsApiRequestController::class);</code>，對應到的是 <code>SendAmeliaSmsApiRequestCommandHandler</code>：</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">handle</span><span class="token punctuation">(</span><span class="token class-name type-declaration">SendAmeliaSmsApiRequestCommand</span> <span class="token variable">$command</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">/** @var SMSAPIServiceInterface $smsApiService */</span><br>    <span class="token variable">$smsApiService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'application.smsApi.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">// Call method dynamically and pass data to the function. Method name is the request field.</span><br>    <span class="token variable">$apiResponse</span> <span class="token operator">=</span> <span class="token variable">$smsApiService</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setResult</span><span class="token punctuation">(</span><span class="token class-name static-context">CommandResult</span><span class="token operator">::</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setMessage</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Amelia SMS API request successful'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token variable">$result</span><span class="token operator">-></span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token variable">$apiResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>可以看到這邊沒有做任何的權限檢查，而我們可以控制傳到這邊的參數：</p><pre class="language-php"><code class="language-php"><span class="token variable">$apiResponse</span> <span class="token operator">=</span> <span class="token variable">$smsApiService</span><span class="token operator">-></span><span class="token punctuation">{</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'action'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token variable">$command</span><span class="token operator">-></span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>在 smsApiService 中有不少方法，而其中只有一個參數的包括可以拿到管理員個人資訊的 <code>getUserInfo</code>，可以拿到付款紀錄的 <code>getPaymentHistory</code>，以及可以發送測試簡訊的 <code>testNotification</code>：</p><pre class="language-php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'auth/info'</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">getPaymentHistory</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/payment/history'</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function function-definition">testNotification</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token variable">$route</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/sms/send'</span><span class="token punctuation">;</span><br><br>    <span class="token comment">/** @var SettingsService $settingsService */</span><br>    <span class="token variable">$settingsService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'domain.settings.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">/** @var EmailNotificationService $notificationService */</span><br>    <span class="token variable">$notificationService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'application.emailNotification.service'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token comment">/** @var PlaceholderService $placeholderService */</span><br>    <span class="token variable">$placeholderService</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">container</span><span class="token operator">-></span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"application.placeholder.<span class="token interpolation"><span class="token punctuation">{</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>.service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$appointmentsSettings</span> <span class="token operator">=</span> <span class="token variable">$settingsService</span><span class="token operator">-></span><span class="token function">getCategorySettings</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'appointments'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$notification</span> <span class="token operator">=</span> <span class="token variable">$notificationService</span><span class="token operator">-></span><span class="token function">getById</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'notificationTemplate'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$dummyData</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">getPlaceholdersDummyData</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sms'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$isForCustomer</span> <span class="token operator">=</span> <span class="token variable">$notification</span><span class="token operator">-></span><span class="token function">getSendTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token class-name static-context">NotificationSendTo</span><span class="token operator">::</span><span class="token constant">CUSTOMER</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$placeholderStringRec</span>  <span class="token operator">=</span> <span class="token string single-quoted-string">'recurring'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Placeholders'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token variable">$isForCustomer</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'Customer'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Sms'</span><span class="token punctuation">;</span><br>    <span class="token variable">$placeholderStringPack</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'package'</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Placeholders'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token variable">$isForCustomer</span> <span class="token operator">?</span> <span class="token string single-quoted-string">'Customer'</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'Sms'</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$dummyData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'recurring_appointments_details'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span><span class="token variable">$appointmentsSettings</span><span class="token punctuation">[</span><span class="token variable">$placeholderStringRec</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dummyData</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token variable">$dummyData</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'package_appointments_details'</span><span class="token punctuation">]</span>   <span class="token operator">=</span>  <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span><span class="token variable">$appointmentsSettings</span><span class="token punctuation">[</span><span class="token variable">$placeholderStringPack</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dummyData</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><br>    <span class="token variable">$body</span> <span class="token operator">=</span> <span class="token variable">$placeholderService</span><span class="token operator">-></span><span class="token function">applyPlaceholders</span><span class="token punctuation">(</span><br>        <span class="token variable">$notification</span><span class="token operator">-></span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token variable">$dummyData</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token punctuation">[</span><br>        <span class="token string single-quoted-string">'to'</span>   <span class="token operator">=></span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'recipientPhone'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'from'</span> <span class="token operator">=></span> <span class="token variable">$settingsService</span><span class="token operator">-></span><span class="token function">getSetting</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'notifications'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'smsAlphaSenderId'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token string single-quoted-string">'body'</span> <span class="token operator">=></span> <span class="token variable">$body</span><br>    <span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token variable">$route</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>實際測試截圖：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-320w.png 320w" type="image/png"><img alt="sms1" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1920w.png" height="1326" width="2052" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2052 1326'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkUlEQVQImT2J4QqDIBgAff+XG2MMIk1LraVpYalJy8+xDbp/d4eeFW9pN+nZ2SVugVDJWq6M3VNafUQEK0almbRz7jgORi2uv+q9zzkj0iguxrhHKCXnbE1oWKcXFVIAANRjIatOsUHTPszLeQIX/Ra28gOZWr5uRD1acedejv96gfTglJi8nuOa8vsspQDAtT9ah6gwJaZeJwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>發送測試簡訊：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1920w.webp 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1280w.webp 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-840w.webp 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1920w.png 1920w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1280w.png 1280w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-840w.png 840w, /img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-320w.png 320w" type="image/png"><img alt="sms2" src="/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1920w.png" height="1504" width="2064" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2064 1504'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlklEQVQImU3M7Q6CIBhAYe7/5qrN2tocGFDmy0eoiIDC29afPH+f7RDKxDCoyc3RewDDheyVWddgJk+uN84oA1DLPFnrz2fWddw5t+VMKAXQppQdERefODfaaTvavGXyuEvRSiXh84ItpjWlWGIuudZKoGH9qZWX7tnwPQQ8RAaujXgv2mUf6u/8N2VmPY97LRWxHgXxCyt0sgZLPfu6AAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>發送測試簡訊也是要扣錢的，我們只要一直打這個 endpoint，就會一直發送測試簡訊然後一直扣款，可以利用這個漏洞把管理員的錢燒光。</p><h3 id="%E4%BF%AE%E5%BE%A9%E6%96%B9%E5%BC%8F-3"><a href="#%E4%BF%AE%E5%BE%A9%E6%96%B9%E5%BC%8F-3" class="direct-link">#</a> 修復方式</h3><p>在 1.0.48 版中，於 controller 內加上了權限檢查：</p><pre class="language-php"><code class="language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">getPermissionsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">currentUserCanWrite</span><span class="token punctuation">(</span><span class="token class-name static-context">Entities</span><span class="token operator">::</span><span class="token constant">NOTIFICATIONS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'You are not allowed to send test email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2 id="%E7%B8%BD%E7%B5%90"><a href="#%E7%B8%BD%E7%B5%90" class="direct-link">#</a> 總結</h2><p>當開發的軟體變得愈來愈複雜，開發者往往容易忽略一些基本的權限檢查，以及對於權限有著錯誤的假設。舉例來說，雖然 appointment 相關的 API 是給 provider 用的，前端的消費者看不到這些 API，但是 WordPress 外掛的程式碼都是開放的，任何人只要看了程式碼，都能找出所有的 API 路徑。</p><p>在實作各種功能時，要記得把權限檢查放在第一位，確認當前的使用者對於欲操作的資源有權限以後，才繼續後面的流程。</p><p>最後附上時間軸：</p><p><code>2022-02-20</code> 透過 WPScan 回報更新預約漏洞，保留 CVE-2022-0720<br><code>2022-03-01</code> 發布 1.0.47 版，修復 CVE-2022-0720，部分資訊公開於 <a href="https://wpscan.com/vulnerability/435ef99c-9210-46c7-80a4-09cd4d3d00cf" rel="noopener noreferrer" target="_blank">WPScan</a><br><code>2022-03-02</code> 透過 WPScan 回報更新預約狀態漏洞，保留 CVE-2022-0825<br><code>2022-03-03</code> 透過 WPScan 回報 SMS 相關漏洞，保留 CVE-2022-0837<br><code>2022-03-09</code> 發布 1.0.48 版，修復 CVE-2022-0837，部分資訊公開於 <a href="https://wpscan.com/vulnerability/0882e5c0-f319-4994-9346-aa18438fda6a" rel="noopener noreferrer" target="_blank">WPScan</a><br><code>2022-03-14</code> 發布 1.0.49 版，修復 CVE-2022-0825，部分資訊公開於 <a href="https://wpscan.com/vulnerability/1a92a65f-e9df-41b5-9a1c-8e24ee9bf50e" rel="noopener noreferrer" target="_blank">WPScan</a><br><code>2022-03-26</code> 漏洞細節公開於 WPScan<br><code>2022-03-30</code> 文章發佈</p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/huli/android-apk-decompile-intro-4/">Android App 逆向入門之四：使用 Frida 進行動態分析</a></li><li><a href="/posts/jo/zerobased-APT/">零基礎資安系列（六）- 電影中酷駭客做的事？關於 APT（Advanced Persistent Threat）</a></li><li><a href="/posts/nick/website-go-live-attack/">為什麼網站才剛上線就被攻擊？</a></li><li><a href="/posts/huli/xss-attack-and-defense/">淺談 XSS 攻擊與防禦的各個環節</a></li><li><a href="/posts/jo/zerobased-secure-samesite-httponly/">零基礎資安系列（三）-網站安全三本柱（Secure & SameSite & HttpOnly）</a></li></ol></div><div class="article-author"><img alt="huli" src="/img/authors/huli_logo.jpg" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/huli">huli</a></div><div class="article-author__intro">Act as a bridge between Front-end and Security world</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"WordPress Plugin Amelia &lt; 1.0.49 敏感資訊洩露漏洞細節","image":["https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p1-intro-1-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p2-intro-2-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p3-intro-3-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p4-update-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p5-unauth-status-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p6-sms1-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/p7-sms2-1920w.png","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/huli_logo.jpg"],"author":{"@type":"Person","name":"huli"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/","datePublished":"2022-03-30","dateModified":"2025-06-18","description":"Amelia 是一個由 TMS 公司所開發的 WordPress 外掛，能夠輕鬆幫你的 WordPress 網站加上預約系統的功能，例如說診所、理髮廳或是家教等等，都很適合使用這個外掛來架一個簡單的預約系統。根據 WordPress 官方的統計，大約有 40,000..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2025 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a>. <a href="https://cymetrics.io/" rel="noopener noreferrer" target="_blank">Cymetrics</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>