<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>XSS 從頭談起：歷史與由來</title><meta content="XSS 從頭談起：歷史與由來" property="og:title"><meta content="XSS 從頭談起：歷史與由來" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="這篇原本想寫的是 XSS 的基礎，就大家都聽過的那三種類別：Stored(Persistent)、Reflected(Non-Persistent) 以及 DOM-based XSS，但當我正要開始寫的時候，腦中突然浮現了幾個問題：「XSS 是什麼時候出現的？這三種類別又是什麼時候開始被分類的？」因此，我花了點時間找了一些資料，這篇文章會跟大家談談 XSS 的歷史，讓我們一起更了解 XSS 的前世今生。" name="description"><meta content="這篇原本想寫的是 XSS 的基礎，就大家都聽過的那三種類別：Stored(Persistent)、Reflected(Non-Persistent) 以及 DOM-based XSS，但當我正要開始寫的時候，腦中突然浮現了幾個問題：「XSS 是什麼時候出現的？這三種類別又是什麼時候開始被分類的？」因此，我花了點時間找了一些資料，這篇文章會跟大家談談 XSS 的歷史，讓我們一起更了解 XSS 的前世今生。" name="twitter:description"><meta content="這篇原本想寫的是 XSS 的基礎，就大家都聽過的那三種類別：Stored(Persistent)、Reflected(Non-Persistent) 以及 DOM-based XSS，但當我正要開始寫的時候，腦中突然浮現了幾個問題：「XSS 是什麼時候出現的？這三種類別又是什麼時候開始被分類的？」因此，我花了點時間找了一些資料，這篇文章會跟大家談談 XSS 的歷史，讓我們一起更了解 XSS 的前世今生。" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/huli/xss-history/" property="og:url"><link href="https://blog.huli.tw/2021/10/11/xss-history/" rel="canonical"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,input{font-family:inherit;font-size:100%;line-height:1.15;overflow:visible}button{text-transform:none}input{margin:0}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,ol,p,pre{font-size:1em}ol,p,pre{margin-bottom:1.5em}body,ol,p,pre{font-size:1rem;line-height:1.6}ol,p,pre{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}body,ol,p,pre{font-size:1.1rem;line-height:1.6}h2,ol,p,pre{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}body,ol,p,pre{font-size:1.2rem;line-height:1.6}h2,ol,p,pre{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}code{border-radius:.3em;color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2{font-family:var(--font-family)}a:hover{text-decoration:underline}@media (max-width:767px){x:-moz-any-link{display:table-cell}}button,input{border-radius:.3em;max-width:100%}input{padding:.75em;margin-bottom:1.5em;display:inline}button+label,input+label,label+*{page-break-before:always}button,label{display:inline-block}button{background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button[disabled]{background:#e6e6e6;color:#404040;cursor:not-allowed}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}input[type=email],input[type=number],input[type=search],input[type=time],input[type=url]{border:1px solid #595959;padding:.75em}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.tag{color:#e2777a}.token.function,.token.number{color:#f08d49}.token.constant,.token.property{color:#f8c555}.token.important,.token.keyword{color:#cc99cd}.token.regex,.token.string,.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a> <a href="/en">English</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">XSS 從頭談起：歷史與由來</h1><aside class="w-full"><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/front-end/" class="post-tag">#Front-end</a></div><div class="post-avatar"><img alt="huli" src="/img/authors/huli_logo.jpg" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/huli">huli</a></div><div class="post-avatar__time">11 Oct 2021</div></div></div><div class="notice-block" data-nosnippet="" style="display:none;">我們正在尋找一位 Security Engineer 加入我們的團隊，詳情請參考<a href="https://github.com/cymetrics/blog/issues/13" rel="noopener noreferrer" target="_blank">職缺資訊</a></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>我以前有寫過一些關於 XSS 的文章，主要在談的是實作面的防範以及防禦的各個細節：</p><ol><li><a href="https://tech-blog.cymetrics.io/posts/huli/prevent-xss-might-be-harder-than-you-thought/">防止 XSS 可能比想像中困難</a></li><li><a href="https://tech-blog.cymetrics.io/posts/huli/xss-attack-and-defense/">淺談 XSS 攻擊與防禦的各個環節</a></li></ol><p>這篇原本想寫的是 XSS 的基礎，就大家都聽過的那三種類別：Stored(Persistent)、Reflected(Non-Persistent) 以及 DOM-based XSS，但當我正要開始寫的時候，腦中突然浮現了幾個問題：「XSS 是什麼時候出現的？這三種類別又是什麼時候開始被分類的？」</p><p>因此，我花了點時間找了一些資料，這篇文章會跟大家談談 XSS 的歷史，讓我們一起更了解 XSS 的前世今生。</p><h2 id="xss-%E7%9A%84%E8%AA%95%E7%94%9F"><a href="#xss-%E7%9A%84%E8%AA%95%E7%94%9F" class="direct-link">#</a> XSS 的誕生</h2><p>從微軟的 MSDN blog 在 2009 年 12 月發佈的文章標題：<a href="https://web.archive.org/web/20100723152801/http://blogs.msdn.com/b/dross/archive/2009/12/15/happy-10th-birthday-cross-site-scripting.aspx" rel="noopener noreferrer" target="_blank">Happy 10th birthday Cross-Site Scripting!</a> 中就可以看出 XSS（Cross-Site Scripting）這個名詞約莫是 1999 年 12 月誕生的，離現在已經 20 幾年了。</p><p>（下圖為上面連結的截圖）</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/xss-history/xss-10years-1920w.webp 1920w, /img/posts/huli/xss-history/xss-10years-1280w.webp 1280w, /img/posts/huli/xss-history/xss-10years-840w.webp 840w, /img/posts/huli/xss-history/xss-10years-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/xss-history/xss-10years-1920w.png 1920w, /img/posts/huli/xss-history/xss-10years-1280w.png 1280w, /img/posts/huli/xss-history/xss-10years-840w.png 840w, /img/posts/huli/xss-history/xss-10years-320w.png 320w" type="image/png"><img alt="xss-history" src="/img/posts/huli/xss-history/xss-10years-1920w.png" height="1398" width="1586" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1586 1398'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAHCAYAAAA1WQxeAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmklEQVQImSWM0Y6DIBRE+f9f3PRhs6tFES8XSREonkY6yck8zOQYq4VJGs/Q2OLJEk5CKrTWuGP0cIgqIgGNifQqvPJJKWVg5qny+MmIZGo9uXqn9zd9dMfYufP322m1D+V1XYN7vNs4L/w/FybrsG5HgpJSIufbWDFBI3bdWJxn3Tzee/Z9R0TGyWzO4dxKCMJxRGL8oqrD8AFo0tdjWuLj6wAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>原文最後有這麼一段話：</p><blockquote><p>Let's hope that ten years from now we'll be celebrating the death, not the birth, of Cross-Site Scripting!</p></blockquote><p>很遺憾的，2009 年的 10 年後，也就是 2019 年，XSS 依舊持續活躍著，在 2017 年的 OWASP top 10 排在第七名，2021 的版本則併入第三名 Injection 的類別。</p><p>而文中提到的：<a href="https://web.archive.org/web/20100516115740/http://www.cert.org/advisories/CA-2000-02.html" rel="noopener noreferrer" target="_blank">CERT® Advisory CA-2000-02 Malicious HTML Tags Embedded in Client Web Requests</a>，可以讓我們一窺最早期 XSS 的面貌。底下就讓我們簡單看一下這個網頁的內容：</p><blockquote><p>A web site may inadvertently include malicious HTML tags or script in a dynamically generated page based on unvalidated input from untrustworthy sources. This can be a problem when a web server does not adequately ensure that generated pages are properly encoded to prevent unintended execution of scripts, and when input is not validated to prevent malicious HTML from being presented to the user.</p></blockquote><p>在 Overview 的部分其實就把 XSS 的核心概念講得非常清楚了，server 沒有驗證輸入或是編碼，導致攻擊者可以插入一些惡意的 HTML 標籤或是 script。</p><blockquote><p>Malicious code provided by one client for another client</p><p>Sites that host discussion groups with web interfaces have long guarded against a vulnerability where one client embeds malicious HTML tags in a message intended for another client. For example, an attacker might post a message like <code>Hello message board. This is a message.&lt;SCRIPT>malicious code&lt;/SCRIPT>This is the end of my message.</code></p><p>When a victim with scripts enabled in their browser reads this message, the malicious code may be executed unexpectedly. Scripting tags that can be embedded in this way include <code>&lt;SCRIPT</code>> <code>&lt;OBJECT></code>, <code>&lt;APPLET></code>, and <code>&lt;EMBED></code>.</p><p>When client-to-client communications are mediated by a server, site developers explicitly recognize that data input is untrustworthy when it is presented to other users. Most discussion group servers either will not accept such input or will encode/filter it before sending anything to other readers.</p></blockquote><p>這一段則是後來被稱為「Stored XSS（也稱為 Persistent XSS）」的分類，假設有一個討論區可以讓人留言，一個惡意的攻擊者可以留這樣的內容：</p><pre class="language-html"><code class="language-html">Hello message board. This is a message.<br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SCRIPT</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">malicious code</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SCRIPT</span><span class="token punctuation">></span></span><br>This is the end of my message.</code></pre><p>當其他使用者看到這篇留言的時候，因為留言裡面有 <code>&lt;script></code> ，所以就會執行攻擊者所留下的 JavaScript 程式碼。</p><p>除了這個以外，<code>&lt;object></code>、<code>&lt;applet></code> 跟 <code>&lt;embed></code> 也都可以用來執行 JavaScript（話說 applet 這標籤應該已經沒用了，可參考：<a href="https://blog.huli.tw/2019/11/26/dont-break-web-smooshgate-and-keygen/" rel="noopener noreferrer" target="_blank">Don’t break the Web：以 SmooshGate 以及 keygen 為例 </a>）。</p><blockquote><p>Malicious code sent inadvertently by a client for itself</p><p>Many Internet web sites overlook the possibility that a client may send malicious data intended to be used only by itself. This is an easy mistake to make. After all, why would a user enter malicious code that only the user will see?</p><p>However, this situation may occur when the client relies on an untrustworthy source of information when submitting a request. For example, an attacker may construct a malicious link such as <code>&lt;A HREF="http://example.com/comment.cgi? mycomment=&lt;SCRIPT>malicious code&lt;/SCRIPT>"> Click here&lt;/A></code></p><p>When an unsuspecting user clicks on this link, the URL sent to <a href="http://example.co" rel="noopener noreferrer" target="_blank">example.co</a> includes the malicious code. If the web server sends a page back to the user including the value of mycomment, the malicious code may be executed unexpectedly on the client. This example also applies to untrusted links followed in email or newsgroup messages.</p></blockquote><p>這一段就很有趣了，標題是：「Malicious code sent inadvertently by a client for itself」，發送的內容基本上只有自己能看到。</p><p>例如說網址中 mycomment 這個參數會反映到畫面上，所以像是 <code>http://example.com/comment.cgi?mycomment=123</code>，畫面上面就會出現 123。</p><p>但只有自己能看到能做什麼呢？</p><p>因為是透過網址上的 query string 來傳遞資訊，因此可以產生這樣的一個連結：<code>http://example.com/comment.cgi?mycomment=&lt;SCRIPT>malicious code&lt;/SCRIPT></code>，接著再把這個連結傳給其他人，當其他人點了以後，畫面上就會出現 <code>&lt;SCRIPT>malicious code&lt;/SCRIPT></code>，照樣達成 XSS。</p><p>這就是 XSS 的另外一種分類：Reflected XSS，你的輸入會反映在畫面上。</p><p>而這兩種的差別在於 Stored XSS 就像它的名字一樣，XSS payload 是被保存住的，以討論區來說，文章是保存在資料庫中的，而 Reflected XSS 則不然。</p><p>以 PHP 為例，Reflected XSS 的程式碼可能會像這樣：</p><pre class="language-php"><code class="language-php"><span class="token language-php php"><span class="token delimiter important">&lt;?php</span><br>   <span class="token variable">$comment</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'comment'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token delimiter important">?></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><br>    <span class="token language-php php"><span class="token delimiter important">&lt;?=</span> <span class="token variable">$comment</span> <span class="token delimiter important">?></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre><p>把 GET 的參數直接反映在畫面上，所以每一次都必須透過 comment 這個參數把 payload 傳進去，否則不會觸發 XSS。</p><p>以上面提的「討論區」這個網站為例，Stored XSS 的破壞力應該是更強大的，因為只要點進去你這篇文章就會中招，可以想成你在 ptt 發了一篇文章，只要有鄉民點進來文章就會被攻擊，還滿容易觸發的。</p><p>但 Reflected XSS 就不太一樣了，這需要使用者點擊連結才會出事，像是你在 ptt 推文留了一個連結，鄉民要主動點那個連結才能觸發 XSS。</p><p>文中的其他部分也很有趣，例如說也有提到僅管把 JavaScript disabled，依然可以用 HTML 與 CSS 去竄改畫面等等，也有提到修補方式，在這邊：<a href="https://web.archive.org/web/20100527204457/http://www.cert.org/tech_tips/malicious_code_mitigation.html" rel="noopener noreferrer" target="_blank">Understanding Malicious Content Mitigation for Web Developers</a></p><p>修補方式除了我們熟悉的針對內容編碼以外，還有另一個是要「指定編碼方式」，這邊的編碼指的是 UTF-8 或是 ISO-8859-1 以及 big5 這種編碼。雖然說現在這個年代絕大部分網站都是 UTF-8 了，但早期其實不然。在以往瀏覽器還支援像是 UTF-7 這樣的編碼方式，就算不用一些特殊字元也可以達成 XSS：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>test page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><br>  +ADw-script+AD4-alert(1)+ADw-/script+AD4-<br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>範例取自：<a href="https://wooyun.js.org/drops/XSS%E5%92%8C%E5%AD%97%E7%AC%A6%E9%9B%86%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF.html" rel="noopener noreferrer" target="_blank">XSS 和字符集的那些事兒</a>，裡面有提到更多這種類似的問題，但大多數問題應該都發生在比較早期的瀏覽器上面。</p><h2 id="%E7%AC%AC%E4%B8%89%E7%A8%AE-xss-%E5%88%86%E9%A1%9E%E7%9A%84%E8%AA%95%E7%94%9F"><a href="#%E7%AC%AC%E4%B8%89%E7%A8%AE-xss-%E5%88%86%E9%A1%9E%E7%9A%84%E8%AA%95%E7%94%9F" class="direct-link">#</a> 第三種 XSS 分類的誕生</h2><p>有看過 XSS 文章的人都知道，最廣為人知的 XSS 分類大概就三種：</p><ol><li>Stored XSS（Persistent XSS）</li><li>Reflected XSS（Non-Persistent XSS）</li><li>DOM-based XSS</li></ol><p>再繼續往下之前，我先來問問看大家兩個問題。</p><p>第一個問題，假設現在我發了一篇文章，內容為 <code>&lt;img src=x onerror=alert(1)></code>，而顯示文章的頁面程式碼是這樣的：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  <span class="token function">getPost</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">post</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.article'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> post<span class="token punctuation">.</span>content<br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>因為用了 innerHTML 的緣故，所以就有了一個 XSS 漏洞，在這個狀況之下，我的留言確實有「保存」在資料庫，但也同時用了 DOM 去改變內容，那這個 XSS 應該被歸類在 Stored XSS，還是 DOM-based XSS？</p><p>第二個問題，假設網頁中有一段程式碼長這樣：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".search"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>這顯然可以透過 query string 製造出一個 XSS 漏洞，這個 XSS 確實反映了使用者的輸入，而且沒有被儲存在資料庫裡面，不過卻是用 DOM 去改變內容，那它應該是 Reflected XSS，還是 DOM-based XSS？</p><p>在繼續往下閱讀之前，大家可以先想一下上面這兩個問題。</p><p>先來講講我以前的答案，我之前是用下面的定義來分類這幾個的：</p><ol><li>我的 XSS payload（例如說 <code>&lt;script>alert(1)&lt;/script></code>）如果有存在資料庫，那就是 Stored XSS</li><li>如果不是，那就看我的 payload 是直接從後端輸出，還是透過 DOM 去賦值，前者就是 Reflected，後者就是 DOM-based</li></ol><p>後來我才發現這個分類方式是錯誤的，因為我被「stored」這個名詞誤導了，沒有意識到這背後的歷史背景。</p><p>這是什麼意思呢？在 1999 年 XSS 剛出來的時候，Ajax 還不存在（它是 2005 年才誕生的），所以前後端的資料交換應該都是透過表單送去 Server，並且直接把回應 render 出來。</p><p>換句話說，在 1999 年的時候，基本上沒有什麼操作是用 JavaScript 去更改畫面內容的，就算有，也是一些比較無關緊要的操作。但在 2021 年都不一樣了，在這個 SPA 盛行的年代，基本上都是透過 JavaScript 去呼叫 API，拿到資料以後再去更改畫面，後端只負責提供資料，前端靠著 JavaScript 來 render，這跟 20 年前完全不同。</p><p>XSS 的三種分類之中，前兩種 Stored 以及 Reflected 在 XSS 誕生之時就已經存在了，而第三種則晚了五年才出現（這邊的「出現」指的是有個名詞或分類來定義它，而不是指攻擊出現），出處應該是這一篇：<a href="http://www.webappsec.org/projects/articles/071105.shtml" rel="noopener noreferrer" target="_blank">DOM Based Cross Site Scripting or XSS of the Third Kind</a></p><p>文中的 Introduction 有這樣一個段落：</p><blockquote><p>XSS is typically categorized into “non-persistent” and “persistent” (“reflected” and “stored” accordingly, as defined in [4]). “Non-persistent” means that the malicious (Javascript) payload is echoed by the server in an immediate response to an HTTP request from the victim. “Persistent” means that the payload is stored by the system, and may later be embedded by the vulnerable system in an HTML page provided to a victim.</p></blockquote><p>重點是 Stored 跟 Reflected 這兩個分類都有一個前提：「payload 是由後端直接 render 的」，而這篇文章所提到的第三個分類 DOM-based，指的則是「payload 是由前端 render 出來的」，這就是第三種與前兩種的最大差異。</p><p>在判別 XSS 的時候，應該先確認的其實是「payload 是前端還是後端 render？」，如果是前端 render 出來，不論資料從哪裡來（從資料庫或是網址或任何地方都可以），就是 DOM-based XSS。如果是後端 render 出來，才去區分是 Stored 還是 Reflected。</p><p>因此，剛剛那兩個問題因為都是前端 render 的關係，都會被歸類在 DOM-based XSS。</p><p>上面的文章中就有舉一個類似的例子：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>HTML</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TITLE</span><span class="token punctuation">></span></span>Welcome!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TITLE</span><span class="token punctuation">></span></span><br>Hi<br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SCRIPT</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br><span class="token keyword">var</span> pos<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"name="</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">;</span><br>document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>SCRIPT</span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>BR</span><span class="token punctuation">></span></span><br>Welcome to our system<br>…<br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>HTML</span><span class="token punctuation">></span></span></code></pre><p>在文章的註解中還特別提到了：</p><blockquote><p>The malicious payload was not embedded in the raw HTML page at any time (unlike the other flavors of XSS).</p></blockquote><p>因為 payload 其實不存在於任何 HTML page（因為是後來才用 JavaScript 改變的），所以它不屬於 Stored 也不屬於 Reflected，是第三種新的類型的 XSS。</p><p>至於修補方式的話，由於是在前端用 JavaScript render，所以編碼的工作當然就是前端的開發者要負責，一個常見的方式是這樣（程式碼取自：<a href="https://stackoverflow.com/questions/2794137/sanitizing-user-input-before-adding-it-to-the-dom-in-javascript" rel="noopener noreferrer" target="_blank">Sanitizing user input before adding it to the DOM in Javascript</a>）：</p><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">sanitize</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><br>      <span class="token string">'&'</span><span class="token operator">:</span> <span class="token string">'&ampamp;'</span><span class="token punctuation">,</span><br>      <span class="token string">'&lt;'</span><span class="token operator">:</span> <span class="token string">'&amplt;'</span><span class="token punctuation">,</span><br>      <span class="token string">'>'</span><span class="token operator">:</span> <span class="token string">'&ampgt;'</span><span class="token punctuation">,</span><br>      <span class="token string">'"'</span><span class="token operator">:</span> <span class="token string">'&ampquot;'</span><span class="token punctuation">,</span><br>      <span class="token string">"'"</span><span class="token operator">:</span> <span class="token string">'&amp#x27;'</span><span class="token punctuation">,</span><br>      <span class="token string">"/"</span><span class="token operator">:</span> <span class="token string">'&amp#x2F;'</span><span class="token punctuation">,</span><br>  <span class="token punctuation">}</span><span class="token punctuation">;</span><br>  <span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token language-regex regex-source">[&&lt;>"'/]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> string<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">(</span>map<span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>但有一點要特別注意，那就是並不是這樣就萬事👌👌了，XSS 的防禦比較麻煩的點是要針對不同情境做處理，如同 <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html" rel="noopener noreferrer" target="_blank">OWASP: Cross Site Scripting Prevention Cheat Sheet</a> 中有提到的，如果你的輸出是要放到 <code>&lt;a href=""></code> 裡面的話，需要考慮到 <code>javascript:alert(1)</code> 這種形式的 payload，這時候上面的 sanitize function 就沒有用了。</p><h2 id="%E7%B5%90%E8%AA%9E"><a href="#%E7%B5%90%E8%AA%9E" class="direct-link">#</a> 結語</h2><p>其實一開始會發現分錯，是因為在 <a href="https://zeroday.hitcon.org/" rel="noopener noreferrer" target="_blank">HITCON ZeroDay</a> 平台上所回報的漏洞分類被改變，才讓我意識到自己對於這幾種的分法理解錯誤，在這邊也感謝負責審查的工作人員。</p><p>除了這幾種分法以外，其實也有其他種的分類方式，例如說使用者需要自己輸入 XSS payload 的 Self XSS，或者是利用 HTML 解析不一致而達成的 Mutation XSS 等等，其實都是 XSS 很有趣的應用，以後有機會再來跟大家分享。</p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/huli/xss-history/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/front-end/" class="post-tag">#Front-end</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/huli/sql-injection-in-action/">SQL injection 實戰：在限制底下提升速度</a></li><li><a href="/posts/crystal/pwn-intro/">PWN 入門 - buffer overflow 是什麼？</a></li><li><a href="/posts/jo/zerobased-common-risk-fix/">資安科普番外篇（二）-如何有效率選擇風險進行修復 feat.風險和法規息息相關？！</a></li><li><a href="/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-zh/">比較 Java 和 Golang 在撰寫併發時處理共享變數的差異</a></li><li><a href="/posts/maxchiu/indexing/">從Indexing的角度切入MySQL-Innodb與PostgreSQL的效能比較</a></li></ol></div><div class="article-author"><img alt="huli" src="/img/authors/huli_logo.jpg" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/huli">huli</a></div><div class="article-author__intro">Act as a bridge between Front-end and Security world</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"XSS 從頭談起：歷史與由來","image":["https://tech-blog.cymetrics.io/img/posts/huli/xss-history/xss-10years-1920w.png","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/huli_logo.jpg"],"author":{"@type":"Person","name":"huli"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/huli/xss-history/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/huli/xss-history/","datePublished":"2021-10-11","dateModified":"2024-11-27","description":"我以前有寫過一些關於 XSS 的文章，主要在談的是實作面的防範以及防禦的各個細節： 防止 XSS 可能比想像中困難 淺談 XSS 攻擊與防禦的各個環節 這篇原本想寫的是 XSS..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a>. <a href="https://oneinfinity.global/" rel="noopener noreferrer" target="_blank">OneInfinity</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>