<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>有缺陷的重設密碼機制如何演變成帳號奪取漏洞？以 Matters 為例</title><meta content="有缺陷的重設密碼機制如何演變成帳號奪取漏洞？以 Matters 為例" property="og:title"><meta content="有缺陷的重設密碼機制如何演變成帳號奪取漏洞？以 Matters 為例" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="重設密碼是幾乎所有網站都有的機制，但如果設計不當，就有可能變成能夠讓攻擊者奪取他人帳號的漏洞，這篇將以實際案例說明以及探討這個問題" name="description"><meta content="重設密碼是幾乎所有網站都有的機制，但如果設計不當，就有可能變成能夠讓攻擊者奪取他人帳號的漏洞，這篇將以實際案例說明以及探討這個問題" name="twitter:description"><meta content="重設密碼是幾乎所有網站都有的機制，但如果設計不當，就有可能變成能夠讓攻擊者奪取他人帳號的漏洞，這篇將以實際案例說明以及探討這個問題" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/huli/reset-password-vulnerability/" property="og:url"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://tech-blog.cymetrics.io/posts/huli/reset-password-vulnerability/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,input{font-family:inherit;font-size:100%;line-height:1.15;overflow:visible}button{text-transform:none}input{margin:0}[type=button],[type=reset],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,ol,p,pre{font-size:1em}ol,p,pre{margin-bottom:1.5em}body,ol,p,pre{font-size:1rem;line-height:1.6}ol,p,pre{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}body,ol,p,pre{font-size:1.1rem;line-height:1.6}h2,ol,p,pre{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}body,ol,p,pre{font-size:1.2rem;line-height:1.6}h2,ol,p,pre{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}code{border-radius:.3em;color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2{font-family:var(--font-family)}a:hover{text-decoration:underline}button,input{border-radius:.3em;max-width:100%}input{padding:.75em;margin-bottom:1.5em;display:inline}button+label,input+label,label+*{page-break-before:always}label{display:inline-block}button,input[type=reset]{background:#f2f2f2;color:#191919;cursor:pointer;display:inline-block;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover,input[type=reset]:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}input[type=email],input[type=number],input[type=password],input[type=url]{border:1px solid #595959;padding:.75em}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property{color:#f8c555}.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a> <a href="/en">English</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">有缺陷的重設密碼機制如何演變成帳號奪取漏洞？以 Matters 為例</h1><aside class="w-full"><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a></div><div class="post-avatar"><img alt="huli" src="/img/authors/huli_logo.jpg" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/huli">huli</a></div><div class="post-avatar__time">04 Jan 2022</div></div></div><div class="notice-block" data-nosnippet="" style="display:none;">我們正在尋找一位 Security Engineer 加入我們的團隊，詳情請參考<a href="https://github.com/cymetrics/blog/issues/13" rel="noopener noreferrer" target="_blank">職缺資訊</a></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>重設密碼是幾乎所有網站都有的機制，最常見的是透過 email 寄送一個重設密碼的連結，點進去連結以後就可以幫這個帳號設定新的密碼。這個機制雖然常見，卻有一些關於安全性的小細節要注意。</p><p>這次要來寫的，是我在今年六月底的時候回報的由重設密碼功能引起的帳號奪取（account takeover）漏洞。</p><p><a href="https://matters.news/" rel="noopener noreferrer" target="_blank">Matters News</a> 是一個去中心化而且應用加密貨幣相關技術的寫作社群平台，我以前曾經寫過一篇<a href="https://tech-blog.cymetrics.io/posts/huli/prevent-xss-might-be-harder-than-you-thought/">《防止 XSS 可能比想像中困難》</a>分享我怎麼找到他們的 XSS 漏洞。</p><p>在談這次的漏洞之前，我們先來看看一般重設密碼的功能是如何設計的。</p><p>話說，如果你好奇為什麼密碼只能重設，而不是「找回密碼」，可以先參考這一篇：<a href="https://tech-blog.cymetrics.io/posts/huli/why-only-reset-password-not-retrieve-password/">為什麼忘記密碼時只能重設，不把舊密碼告訴我？</a></p><h2 id="%E5%85%B8%E5%9E%8B%E7%9A%84%E9%87%8D%E8%A8%AD%E5%AF%86%E7%A2%BC%E5%8A%9F%E8%83%BD"><a href="#%E5%85%B8%E5%9E%8B%E7%9A%84%E9%87%8D%E8%A8%AD%E5%AF%86%E7%A2%BC%E5%8A%9F%E8%83%BD" class="direct-link">#</a> 典型的重設密碼功能</h2><p>基本上忘記密碼的流程都大同小異，不外乎就是：</p><ol><li>使用者填入當初註冊帳號時的 email</li><li>系統寄送重設密碼的連結到第一步的 email</li><li>使用者點擊信中的連結，前往重設密碼頁面</li><li>使用者輸入新的密碼，送出表單</li><li>密碼重設成功，使用者可以利用新的密碼登入</li></ol><p>這個流程如果要是安全的，就必須確保：</p><ol><li>系統寄送信件的目的地，真的是使用者本人的 email</li><li>重設密碼的連結無法被猜出來</li></ol><p>先來談談第一點，有些人會想說：「這不是很基本嗎？我填入 <a href="mailto:user@example.com" rel="noopener noreferrer" target="_blank">user@example.com</a>，當然是把信件寄送給 <a href="mailto:user@example.com" rel="noopener noreferrer" target="_blank">user@example.com</a> 啊！」</p><p>不不不，這可不一定，有些系統在接收 email 這個參數時，居然可以是一個陣列，所以你可以填入：<code>["victim@example.com", "attacker@example.com"]</code>，然後 attacker 就會收到 victim 的重設密碼信件！</p><p>聽起來很不可思議，但確實發生過：</p><ol><li><a href="https://hackerone.com/reports/322985" rel="noopener noreferrer" target="_blank">Ability to reset password for account</a></li><li><a href="https://hackerone.com/reports/1175081" rel="noopener noreferrer" target="_blank">Full account takeover of any user through reset password</a></li></ol><p>再來談談第二點，如果重設密碼的連結可以被猜出來，就代表攻擊者可以代替 user 重設密碼。</p><p>或更精確地說，重設密碼的 token 不能被猜出來。</p><p>舉例來說，如果重設密碼的連結長得像這樣：<code>https://example.com/reset-password?token=user@example.com</code>，那我就可以幫任何人重設密碼了，顯然很不安全。</p><p>所以一般來說，token 都會產生一組 unique id，例如說 UUID v4，長得像這樣：<code>2c59d26a-f99a-425e-bb69-91e7c6ffe54d</code>，有 128 個 bit，也就是 2^128 種組合，要猜中的可能性微乎其微。</p><p>若是產生的 token 強度不夠的話，就會提高暴力破解成功的機率。</p><p>不過要特別注意的是儘管如此，有些系統的漏洞在其他地方，例如說寄送 email 時，重設密碼的網址或是 host 是可以控制的！像是只要在 request header 裡面加上 <code>X-Forwarded-Host: abc.com</code>，重設密碼的連結就會變成：<code>https://abc.com/reset-password?token=...</code>，使用者收到信以後如果不小心點了連結，這個 token 就會發到攻擊者的伺服器去，他一樣可以利用這個 token 來重設密碼，進行帳號奪取。</p><p>這也是有發生過實際案例的：</p><ol><li><a href="https://hackerone.com/reports/226659" rel="noopener noreferrer" target="_blank">Password Reset link hijacking via Host Header Poisoning</a></li><li><a href="https://hackerone.com/reports/182670" rel="noopener noreferrer" target="_blank">Email link poisoning / Host header attack</a></li></ol><p>除了這些以外，其實還有許多小細節要注意，例如說：</p><ol><li>重設密碼的 token 應該只能使用一次</li><li>重設密碼的 token 應該要有過期時間</li><li>如果使用者產生了新的重設密碼 token，舊的應該要廢棄</li></ol><p>之所以會有這些限制，也是為了降低暴力破解的可行性。</p><p>假設時間無限的話，理論上暴力破解絕對可以猜出 token，因此防止暴力破解的重點有兩個，一個是盡量增加破解所需的時間，讓這個時間大到超過一千年或更久，第二個重點是限制時間，而實際的方法有幾種，例如說：</p><ol><li>把基數加大，例如說六碼數字的可能性只有一百萬種，但若是換成六碼英文加數字就有 20 億種，要猜測的數量多了 2000 倍，就需要花更多時間</li><li>把可猜測的時間降低，例如說 300 秒後 token 就會過期，假設可能性有 1 億種，那每秒必須要猜 30 萬種才能保證猜中</li></ol><p>接著，我們就來看一下 Matters 的重設密碼機制出了什麼事情。</p><h2 id="matters-%E7%9A%84%E9%87%8D%E8%A8%AD%E5%AF%86%E7%A2%BC%E6%A9%9F%E5%88%B6"><a href="#matters-%E7%9A%84%E9%87%8D%E8%A8%AD%E5%AF%86%E7%A2%BC%E6%A9%9F%E5%88%B6" class="direct-link">#</a> Matters 的重設密碼機制</h2><p>下圖是 Matters 重設密碼的畫面，一樣是填入 email，然後寄一個連結到信箱：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/reset-password-vulnerability/matters-1920w.webp 1920w, /img/posts/huli/reset-password-vulnerability/matters-1280w.webp 1280w, /img/posts/huli/reset-password-vulnerability/matters-840w.webp 840w, /img/posts/huli/reset-password-vulnerability/matters-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/reset-password-vulnerability/matters-1920w.png 1920w, /img/posts/huli/reset-password-vulnerability/matters-1280w.png 1280w, /img/posts/huli/reset-password-vulnerability/matters-840w.png 840w, /img/posts/huli/reset-password-vulnerability/matters-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/reset-password-vulnerability/matters-1920w.png" height="649" width="925" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 925 649'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA1UlEQVQImSXLsU7CQACA4XsnE9YuJia4MeDgoKu60NhJ00QicSUEm4BvYMSFRDHQ3rXGu6O0Kg/QjTBaOsj8m+D0L98v3mYhaZrSux9w4Xp4fpvWdYfWpc/Jucupe4UYj5/JswX+7R17Th2n3sQ5PKK236B20OT4zEOo8AWtP5BKkiTxblikc5bfXzyOnngYDhHGzjHGoqRkOp2xWq/Z/m75qSrCLCMIAoTWGmstkZS8TiYURUFZllSbDXn+Sfum84+MMcRxTBRFu0qleE8S+sGAbrfHHzFvoTxOkAUzAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>重設密碼的 request 長這樣：</p><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span><br>   <span class="token string">"operationName"</span><span class="token operator">:</span><span class="token string">"SendVerificationCode"</span><span class="token punctuation">,</span><br>   <span class="token string">"variables"</span><span class="token operator">:</span><span class="token punctuation">{</span><br>      <span class="token string">"input"</span><span class="token operator">:</span><span class="token punctuation">{</span><br>         <span class="token string">"email"</span><span class="token operator">:</span><span class="token string">"user@example.com"</span><span class="token punctuation">,</span><br>         <span class="token string">"type"</span><span class="token operator">:</span><span class="token string">"password_reset"</span><span class="token punctuation">,</span><br>         <span class="token string">"redirectUrl"</span><span class="token operator">:</span><span class="token string">"https://matters.news/forget?email=user%40example.com"</span><br>      <span class="token punctuation">}</span><br>   <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>這是我收到的連結：<code>https://matters.news/forget?email=user%40example.com&code=UYBQ912rhd_9s3TfywZnk1kQl6PCaDjPlXuNX3Df&type=password_reset</code></p><p>從這邊其實我們就可以發現第一個問題，就是看起來收到的連結的前半段是由 <code>redirectUrl</code> 所控制的。如果我們攔截 request 以後修改 <code>redirectUrl</code> 參數，修改成 <code>https://cymetrics.io</code>，會發現信箱內收到的連結確實變成由 <code>https://cymetrics.io</code> 開頭！</p><p>如此一來，就有了前面所說的漏洞，如果使用者點了信中的連結，那我們的 server 就會收到 token，就可以幫使用者重設密碼。</p><p>接著我們看一下有沒有暴力破解的問題，token 本身看起來複雜度滿高的，長度是 40 個字，由大小寫英文字母、數字以及底線所組成。</p><p>雖然看起來應該不會有問題，但 Matters 是開源的，所以我們可以直接去看一下 <code>SendVerificationCode</code> 是如何實作的，程式碼在這邊：<a href="https://github.com/thematters/matters-server/blob/v3.19.0/src/mutations/user/sendVerificationCode.ts" rel="noopener noreferrer" target="_blank">https://github.com/thematters/matters-server/blob/v3.19.0/src/mutations/user/sendVerificationCode.ts</a></p><p>我們關注的是產生 code 的地方，主要是這一段：</p><pre class="language-js"><code class="language-js"><span class="token comment">// insert record</span><br><span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">createVerificationCode</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  userId<span class="token operator">:</span> viewer<span class="token punctuation">.</span>id<span class="token punctuation">,</span><br>  email<span class="token punctuation">,</span><br>  type<span class="token punctuation">,</span><br>  strong<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>redirectUrl<span class="token punctuation">,</span> <span class="token comment">// strong random code for link</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>而這個 <code>userService.createVerificationCode</code> 的程式碼則是在這裡：<a href="https://github.com/thematters/matters-server/blob/v3.19.0/src/connectors/userService.ts#L1500" rel="noopener noreferrer" target="_blank">https://github.com/thematters/matters-server/blob/v3.19.0/src/connectors/userService.ts#L1500</a></p><pre class="language-js"><code class="language-js"><span class="token function function-variable">createVerificationCode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span><br>  userId<span class="token punctuation">,</span><br>  email<span class="token punctuation">,</span><br>  type<span class="token punctuation">,</span><br>  strong<span class="token punctuation">,</span><br>  expiredAt<span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>  userId<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">null</span><br>  email<span class="token operator">:</span> string<br>  type<span class="token operator">:</span> string<br>  strong<span class="token operator">?</span><span class="token operator">:</span> boolean<br>  expiredAt<span class="token operator">?</span><span class="token operator">:</span> Date<br><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> code <span class="token operator">=</span> strong <span class="token operator">?</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">:</span> _<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">999999</span><span class="token punctuation">)</span><br><br>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">baseCreate</span><span class="token punctuation">(</span><br>    <span class="token punctuation">{</span><br>      uuid<span class="token operator">:</span> <span class="token function">v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      userId<span class="token punctuation">,</span><br>      email<span class="token punctuation">,</span><br>      type<span class="token punctuation">,</span><br>      code<span class="token punctuation">,</span><br>      expiredAt<span class="token operator">:</span><br>        expiredAt <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">VERIFICATION_CODE_EXIPRED_AFTER</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>    <span class="token punctuation">}</span><span class="token punctuation">,</span><br>    <span class="token string">'verification_code'</span><br>  <span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>從這邊我們看到一個重點，就是在系統內 code 的產生分兩種類型，strong 的是 <code>nanoid(40)</code>，不 strong 的則是 100000~999999 的六碼數字，而這個 strong 的參數是由有沒有傳入 <code>redirectUrl</code> 而決定的。</p><p>也就是說，如果我們在建立 reset password 的驗證碼時把 <code>redirectUrl</code> 參數拿掉，code 就會從原本的 40 個字，瞬間降低成六位數的數字！</p><p>而驗證碼的過期時間 <code>VERIFICATION_CODE_EXIPRED_AFTER</code> 是五分鐘，也就是 300 秒，900000/300 = 3000，只要我們一秒能發送 3000 個 request 到 server，就能暴力破解 reset password 的 token，進而奪取使用者帳號。</p><p>但其實這樣的說法不太精確，因為我們可以發 3000 個，不代表 server 就可以處理 3000 個，所以還要看 server 能接受的 request 數量，而且在這之前，還有另一個限制要繞過。</p><h2 id="rate-limiting"><a href="#rate-limiting" class="direct-link">#</a> Rate limiting</h2><p>增加暴力破解難度的方法之一就是 rate limiting，許多網站或是 WAF 都有這個功能，能夠阻止短時間內大量的 request。</p><p>而 Matters 的 rate limit 是用 nginx 來處理，程式碼在這裡：<a href="https://github.com/thematters/matters-server/blob/v3.19.0/.ebextensions/rate-limit-connections.config" rel="noopener noreferrer" target="_blank">https://github.com/thematters/matters-server/blob/v3.19.0/.ebextensions/rate-limit-connections.config</a></p><pre><code>limit_req_zone $http_x_forwarded_for zone=application:16m rate=5r/s;
<p>limit_req zone=application burst=20 nodelay;<br>
limit_req_status 429;<br>
limit_conn_status 429;</p>
<h1 id="pass-real-ip-from-client-to-nginx"><a href="#pass-real-ip-from-client-to-nginx" class="direct-link">#</a> pass real IP from client to NGINX</h1>
<p>real_ip_header X-Forwarded-For;<br>
set_real_ip_from 0.0.0.0/0;</p>
<p>server {<br>
# set error page for HTTP code 429<br>
error_page 429 @ratelimit;<br>
location @ratelimit {<br>
return 429 '["Connection Limit Exceeded"]\n';<br>
}</p>
<pre><code>listen 80;

# 底下省略
</code></pre>
</code><p><code>}<br>
</code></p></pre><p></p><p>nginx 的 rate limit 基本上都是以 IP 為主，如果真的想繞過的話可以嘗試看看 <a href="https://rhinosecuritylabs.com/aws/bypassing-ip-based-blocking-aws/" rel="noopener noreferrer" target="_blank">IP rotate</a>，一個簡單的方式是去 AWS 上開很多 API gateway 當 proxy，然後你就有了一堆不同的 IP 可以輪流使用。</p><p>但這邊還用不上這個技巧，因為在設定中可以看到它使用了 <code>$http_x_forwarded_for</code> 這個參數，如果沒有管理好的話，可以自己傳入 <code>X-Forwarded-For</code> 來偽造任意 IP，藉此繞過 rate limit 的限制。</p><p>而 Matters 在這邊顯然沒有設置好，因此 rate limit 算是虛設。</p><p>做到這邊，只要我們能夠一秒發送 3000 個 request 就能做出 POC，證明攻擊確實可行，但還有沒有其他的方法，能讓這個數字再小一點呢？</p><h2 id="%E5%90%8C%E6%99%82%E5%AD%98%E5%9C%A8%E7%9A%84%E9%A9%97%E8%AD%89%E7%A2%BC"><a href="#%E5%90%8C%E6%99%82%E5%AD%98%E5%9C%A8%E7%9A%84%E9%A9%97%E8%AD%89%E7%A2%BC" class="direct-link">#</a> 同時存在的驗證碼</h2><p>在開頭的時候有提過重設密碼有一些小細節要注意，像是：</p><ol><li>重設密碼的 token 應該只能使用一次</li><li>重設密碼的 token 應該要有過期時間</li><li>如果使用者產生了新的重設密碼 token，舊的應該要廢棄</li></ol><p>而 Matters 前兩點都做了，就是唯獨第三點沒有做好。從程式碼中我們可以看出當新的驗證碼建立時，舊的並不會刪除或是標記為廢棄。</p><p>這會有什麼影響呢？我們來算個簡單的數學吧！</p><p>驗證碼的組合總共有 900,000 種，我們有 300 秒的時間可以攻擊，如果可以在這段時間內發送 900,000 個 request 而且 server 也有處理，就一定可以猜到重設密碼的驗證碼。</p><p>若是我們改成先不要猜，而是先發送 1000 次的重設密碼請求，因為舊的驗證碼依然有效，所以這時我們猜一次，猜中任何一組的機率就是 1000/900000 = 1/900，變成原本的 1000 倍。</p><p>猜 1000 次的話，猜中的機率就是「1 - 每次都猜不中的機率」，大約是 <code>1 - (899/900)^1000</code> = 67%，如果猜到 5000 次的話，猜中的機率就是 <code>1 - (899/900)^5000</code> = 99.6%。</p><p>也就是說，我們只要發送 1000 個重設密碼的請求外加 5000 個確認驗證碼的請求，總共 6000 個請求，就有 99.6% 的機率可以正確猜到至少一組驗證碼！</p><p>可以寫個簡單的小程式來驗證我們的機率計算：</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><br><br><span class="token keyword">const</span> rounds <span class="token operator">=</span> <span class="token number">100000</span> <span class="token comment">// 跑十萬輪取平均 </span><br><span class="token keyword">const</span> guessRounds <span class="token operator">=</span> <span class="token number">5000</span> <span class="token comment">// 猜 5000 次</span><br><span class="token keyword">const</span> tokenCount <span class="token operator">=</span> <span class="token number">1000</span> <span class="token comment">// 1000 個合法驗證碼</span><br><span class="token keyword">let</span> winCount <span class="token operator">=</span> <span class="token number">0</span> <br><br><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> r<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> r<span class="token operator">&lt;</span>rounds<span class="token punctuation">;</span> r<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">let</span> ans <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>tokenCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    ans<span class="token punctuation">[</span>_<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">999999</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">let</span> isWin <span class="token operator">=</span> <span class="token boolean">false</span><br>  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>guessRounds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">const</span> guessNumber <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">999999</span><span class="token punctuation">)</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ans<span class="token punctuation">[</span>guessNumber<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      isWin <span class="token operator">=</span> <span class="token boolean">true</span><br>      <span class="token keyword">break</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isWin<span class="token punctuation">)</span> winCount<span class="token operator">++</span><br><span class="token punctuation">}</span><br><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>winCount<span class="token operator">*</span><span class="token number">100</span> <span class="token operator">/</span> rounds<span class="token punctuation">)</span><br><span class="token comment">// 輸出：99.626，我們算出的機率差不多</span></code></pre><p>原本要發 900,001 個 request 才能有 100% 的機率可以猜中，現在只要犧牲一點點正確性，變成 99.6% 的機率猜中，就可以把 request 數量降低到 6000 次，低了 150 倍！</p><p>原本我們在五分鐘內一秒要發 3000 個 request，現在一秒只要 20 個 request 就好（其實這邊也只是大略計算，因為是有順序性的，必須要等 1000 個發送驗證碼的 request 結束後才能開始猜，而這 1000 個可能又會花個幾秒，但這邊為了方便計算先忽略不計，對整體的影響不大）</p><p>就因為這個重設密碼的小缺陷，沒有把上一組驗證碼淘汰掉，導致我們可以產生多組驗證碼，大幅降低暴力破解的難度。只要能在五分鐘內發送 6000 個 request，就有 99.6% 的機率可以更改一組帳號的密碼。</p><p>由於這是重設密碼功能，所以改完密碼之後你就可以直接用他的身份登入系統，達成帳號奪取，把其他人的帳號都變成是你的。如果想要擴大影響性的話，可以奪取管理員的帳號，就有機會進入管理後台進行更多操作。</p><h2 id="%E5%BB%BA%E8%AD%B0%E4%BF%AE%E8%A3%9C%E6%96%B9%E5%BC%8F"><a href="#%E5%BB%BA%E8%AD%B0%E4%BF%AE%E8%A3%9C%E6%96%B9%E5%BC%8F" class="direct-link">#</a> 建議修補方式</h2><p>第一個要修的地方是重設密碼的小缺陷，在使用者產生新的驗證碼時，舊的應該要被淘汰掉，保證永遠只有最新的一組可以通過驗證，這樣攻擊者猜中的機率就永遠是 1/n，而不會像上面的範例那樣，可以把機率提高 1000 倍或更多倍。</p><p>第二個則是驗證碼的產生不該由 <code>redirectUrl</code> 參數來決定，而是應該由驗證碼的 type 來決定，如果是 reset password，就一定要是 strong，這樣子就會用 <code>nanoid(40)</code> 來產生，猜中的機率就變得微乎其微，大幅降低暴力破解的可行性。</p><p>第三個是 redirectUrl 不應該從前端傳入，而是直接把網址寫在後端。如果真的要從前端傳入，那後端要做好完善的檢查，確保 redirectUrl 傳入的是合法的路徑，而不是讓攻擊者可以傳入任意網址（不過如果攻擊者能結合 <a href="https://tech-blog.cymetrics.io/posts/huli/open-redirect/">open redirect</a>，又是另外一回事了）</p><p>最後一個則是 nginx 的 rate limit 限制不應該用 <code>X-Forwarded-For</code> 來決定，就算真的要用這個，也要確保它的值無法由攻擊者自行傳入。</p><h2 id="%E7%B8%BD%E7%B5%90"><a href="#%E7%B8%BD%E7%B5%90" class="direct-link">#</a> 總結</h2><p>重設密碼機制看似簡單，但其實一不小心還是有可能做出有漏洞的機制，導致攻擊者有機可趁，在 HackTricks 上有個頁面專門在講 reset password 可能會有的問題：<a href="https://book.hacktricks.xyz/pentesting-web/reset-password" rel="noopener noreferrer" target="_blank">Reset/Forgotten Password Bypass</a>，除了這篇提到的以外還有更多的問題，整理得很詳細，很值得參考看看。</p><p>如果你以為只有一般的網站會有這種問題，那你就錯了。一名資安研究員 Laxman Muthiyah 發現可以用 concurrent 的方式繞過 <a href="https://thezerohack.com/hack-any-instagram" rel="noopener noreferrer" target="_blank">Instagram</a> 的 rate limiting，成功發送 200 個 request，並且用 1000 台機器產生出 20 萬個 request，就有 20% 的機率攻擊成功。</p><p>只要有 5000 台機器，就能拿下任何帳號。5000 台聽起來很多，成本應該很高對吧？但如果善用 cloud service 的話，他估算可能只需要 150 美金左右即可達成一次攻擊（因為算小時收費，只要開一兩個小時即可）</p><p>而他也在去年七月用同樣的手法繞過<a href="https://thezerohack.com/how-i-might-have-hacked-any-microsoft-account" rel="noopener noreferrer" target="_blank">微軟</a>的 rate limiting，並且拿到 5 萬美金的獎金。</p><p>像這種漏洞如果能成功被利用，就能夠直接奪取他人的帳號，影響很大，需要多加注意相關的安全性。看到這裡，大家不妨也檢查一下自家的重設密碼機制是否安全。</p><p>最後，這次找到漏洞以後一樣有回報給 Matters，底下是完整時間軸：</p><p><code>2021-06-24</code> 回報漏洞給 Matters<br><code>2021-06-25</code> 收到 Matters 回覆，確認漏洞存在<br><code>2021-08-20</code> Matters 修復部分功能，產生新的驗證碼時會淘汰舊的<br><code>2021-08-26</code> Matters 確認漏洞評級為 High，獎金為 150 USD<br><code>2021-10-28</code> 關心後續修復狀況，確認是否修補完畢<br><code>2021-11-30</code> Matters 增強 non-strong 的驗證碼基數<br><code>2021-12-02</code> 文章初稿完成，與 Matters 確認是否可發布<br><code>2021-12-21</code> Matters 確認問題已修復完畢以及可發布文章</p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/huli/reset-password-vulnerability/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/">WordPress Plugin Amelia &lt; 1.0.49 敏感資訊洩露漏洞細節</a></li><li><a href="/posts/zet/uuid-shellcode-loader/">跟端點防護軟體玩玩貓捉老鼠的遊戲 - Shellcode loader</a></li><li><a href="/posts/genchilu/cache-strategy-zh/">來談談後端快取策略</a></li><li><a href="/posts/huli/xss-history/">XSS 從頭談起：歷史與由來</a></li><li><a href="/posts/nick/cybersecurity-loss/">資安弱點會造成多大損失 ?</a></li></ol></div><div class="article-author"><img alt="huli" src="/img/authors/huli_logo.jpg" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/huli">huli</a></div><div class="article-author__intro">Act as a bridge between Front-end and Security world</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"有缺陷的重設密碼機制如何演變成帳號奪取漏洞？以 Matters 為例","image":["https://tech-blog.cymetrics.io/img/posts/huli/reset-password-vulnerability/matters-1920w.png","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/huli_logo.jpg"],"author":{"@type":"Person","name":"huli"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/huli/reset-password-vulnerability/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/huli/reset-password-vulnerability/","datePublished":"2022-01-04","dateModified":"2022-12-21","description":"重設密碼是幾乎所有網站都有的機制，最常見的是透過 email 寄送一個重設密碼的連結，點進去連結以後就可以幫這個帳號設定新的密碼。這個機制雖然常見，卻有一些關於安全性的小細節要注意。 這次要來寫的，是我在今年六月底的時候回報的由重設密碼功能引起的帳號奪取（account..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a>. <a href="https://oneinfinity.global/" rel="noopener noreferrer" target="_blank">OneInfinity</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>