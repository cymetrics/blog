<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>Android App 逆向入門之二：修改 smali 程式碼</title><meta content="Android App 逆向入門之二：修改 smali 程式碼" property="og:title"><meta content="Android App 逆向入門之二：修改 smali 程式碼" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="在第一篇當中我們學到了基礎中的基礎，靠著 Apktool 把 apk 拆開，修改資源以後組裝回去，並且把對齊且簽署過的 apk 裝回手機上面。而接下來的這一篇，我們要來看看如何修改程式碼。" name="description"><meta content="在第一篇當中我們學到了基礎中的基礎，靠著 Apktool 把 apk 拆開，修改資源以後組裝回去，並且把對齊且簽署過的 apk 裝回手機上面。而接下來的這一篇，我們要來看看如何修改程式碼。" name="twitter:description"><meta content="在第一篇當中我們學到了基礎中的基礎，靠著 Apktool 把 apk 拆開，修改資源以後組裝回去，並且把對齊且簽署過的 apk 裝回手機上面。而接下來的這一篇，我們要來看看如何修改程式碼。" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/huli/android-apk-decompile-intro-2/" property="og:url"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/huli/android-apk-decompile-intro/cover2.png" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/huli/android-apk-decompile-intro/cover2.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://tech-blog.cymetrics.io/posts/huli/android-apk-decompile-intro-2/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,ol,p,pre{font-size:1em}ol,p,pre{margin-bottom:1.5em}body,ol,p,pre{font-size:1rem;line-height:1.6}ol,p,pre{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}body,ol,p,pre{font-size:1.1rem;line-height:1.6}h2,ol,p,pre{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}body,ol,p,pre{font-size:1.2rem;line-height:1.6}h2,ol,p,pre{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol{margin-bottom:0}dd{padding-bottom:.75em;margin-left:2.25em}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.namespace{color:#e2777a}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.keyword{color:#cc99cd}.token.string,.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a> <a href="/en">English</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">Android App 逆向入門之二：修改 smali 程式碼</h1><aside class="w-full"><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/mobile/" class="post-tag">#Mobile</a></div><div class="post-avatar"><img alt="huli" src="/img/authors/huli_logo.jpg" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/huli">huli</a></div><div class="post-avatar__time">21 Feb 2022</div></div></div><div class="notice-block" data-nosnippet="" style="display:none;">我們正在尋找一位 Security Engineer 加入我們的團隊，詳情請參考<a href="https://github.com/cymetrics/blog/issues/13" rel="noopener noreferrer" target="_blank">職缺資訊</a></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>在第一篇當中我們學到了基礎中的基礎，靠著 Apktool 把 apk 拆開，修改資源以後組裝回去，並且把對齊且簽署過的 apk 裝回手機上面。</p><p>而接下來的這一篇，我們要來看看如何修改程式碼。</p><p>我們的目的是在一台有 root 的手機上繞過檢查，讓 app 顯示沒有 root。如果你是用沒有 root 的手機來測試的話，你可以反過來，將 app 改成會偵測出你有 root。</p><p>系列文連結：</p><ol><li><a href="/posts/huli/android-apk-decompile-intro-1/">Android App 逆向入門之一：拆開與重組 apk</a></li><li><a href="/posts/huli/android-apk-decompile-intro-2/">Android App 逆向入門之二：修改 smali 程式碼</a></li><li><a href="/posts/huli/android-apk-decompile-intro-3/">Android App 逆向入門之三：監聽 app 封包</a></li><li><a href="/posts/huli/android-apk-decompile-intro-4/">Android App 逆向入門之四：使用 Frida 進行動態分析</a></li></ol><h2 id="%E4%BB%80%E9%BA%BC%E6%98%AF-smali"><a href="#%E4%BB%80%E9%BA%BC%E6%98%AF-smali" class="direct-link">#</a> 什麼是 Smali</h2><p>在我們利用 <code>apktool d</code> 拆開的內容中，有一個資料夾叫做 smali，裡面存放著的就是從 classes.dex 還原出來的東西，也就是程式碼。但這些程式碼跟你想的可能不太一樣，例如說我們可以來看看 <code>smali/com/cymetrics/demo/MainActivity.smali</code>：</p><pre class="language-java"><code class="language-java"><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token keyword">public</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>cymetrics<span class="token operator">/</span>demo<span class="token operator">/</span><span class="token class-name">MainActivity</span><span class="token punctuation">;</span><br><span class="token punctuation">.</span><span class="token keyword">super</span> <span class="token class-name">Landroidx</span><span class="token operator">/</span>appcompat<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">AppCompatActivity</span><span class="token punctuation">;</span><br><span class="token punctuation">.</span>source <span class="token string">"MainActivity.java"</span><br><br><br># direct methods<br><span class="token punctuation">.</span>method <span class="token keyword">public</span> constructor <span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">V</span><br>    <span class="token punctuation">.</span>locals <span class="token number">0</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">16</span><br>    invoke<span class="token operator">-</span>direct <span class="token punctuation">{</span>p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroidx</span><span class="token operator">/</span>appcompat<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">AppCompatActivity</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br>    <span class="token keyword">return</span><span class="token operator">-</span><span class="token keyword">void</span><br><span class="token punctuation">.</span>end method<br><br><br># virtual methods<br><span class="token punctuation">.</span>method <span class="token keyword">protected</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Landroid</span><span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">Bundle</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br>    <span class="token punctuation">.</span>locals <span class="token number">1</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">20</span><br>    invoke<span class="token operator">-</span><span class="token keyword">super</span> <span class="token punctuation">{</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroidx</span><span class="token operator">/</span>appcompat<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">AppCompatActivity</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Landroid</span><span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">Bundle</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br>    <span class="token keyword">const</span> p1<span class="token punctuation">,</span> <span class="token number">0x7f0b001c</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">21</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>cymetrics<span class="token operator">/</span>demo<span class="token operator">/</span><span class="token class-name">MainActivity</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br>    <span class="token keyword">const</span> p1<span class="token punctuation">,</span> <span class="token number">0x7f080122</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">22</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>cymetrics<span class="token operator">/</span>demo<span class="token operator">/</span><span class="token class-name">MainActivity</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">;</span><br><br>    move<span class="token operator">-</span>result<span class="token operator">-</span>object p1<br><br>    check<span class="token operator">-</span>cast p1<span class="token punctuation">,</span> <span class="token class-name">Landroidx</span><span class="token operator">/</span>appcompat<span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">Toolbar</span><span class="token punctuation">;</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">23</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>cymetrics<span class="token operator">/</span>demo<span class="token operator">/</span><span class="token class-name">MainActivity</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setSupportActionBar</span><span class="token punctuation">(</span><span class="token class-name">Landroidx</span><span class="token operator">/</span>appcompat<span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">Toolbar</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br>    <span class="token keyword">const</span> p1<span class="token punctuation">,</span> <span class="token number">0x7f08007a</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">25</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>cymetrics<span class="token operator">/</span>demo<span class="token operator">/</span><span class="token class-name">MainActivity</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">;</span><br><br>    move<span class="token operator">-</span>result<span class="token operator">-</span>object p1<br><br>    check<span class="token operator">-</span>cast p1<span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>google<span class="token operator">/</span>android<span class="token operator">/</span>material<span class="token operator">/</span>floatingactionbutton<span class="token operator">/</span><span class="token class-name">FloatingActionButton</span><span class="token punctuation">;</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">26</span><br>    <span class="token keyword">new</span><span class="token operator">-</span>instance v0<span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>cymetrics<span class="token operator">/</span>demo<span class="token operator">/</span><span class="token class-name">MainActivity</span>$<span class="token number">1</span><span class="token punctuation">;</span><br><br>    invoke<span class="token operator">-</span>direct <span class="token punctuation">{</span>v0<span class="token punctuation">,</span> p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>cymetrics<span class="token operator">/</span>demo<span class="token operator">/</span><span class="token class-name">MainActivity</span>$<span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">Lcom</span><span class="token operator">/</span>cymetrics<span class="token operator">/</span>demo<span class="token operator">/</span><span class="token class-name">MainActivity</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p1<span class="token punctuation">,</span> v0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>google<span class="token operator">/</span>android<span class="token operator">/</span>material<span class="token operator">/</span>floatingactionbutton<span class="token operator">/</span><span class="token class-name">FloatingActionButton</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span>$<span class="token class-name">OnClickListener</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br>    <span class="token keyword">return</span><span class="token operator">-</span><span class="token keyword">void</span><br><span class="token punctuation">.</span>end method<br><br><span class="token punctuation">.</span>method <span class="token keyword">public</span> <span class="token function">onCreateOptionsMenu</span><span class="token punctuation">(</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">Menu</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br>    <span class="token punctuation">.</span>locals <span class="token number">2</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">38</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>cymetrics<span class="token operator">/</span>demo<span class="token operator">/</span><span class="token class-name">MainActivity</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">getMenuInflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">MenuInflater</span><span class="token punctuation">;</span><br><br>    move<span class="token operator">-</span>result<span class="token operator">-</span>object v0<br><br>    <span class="token keyword">const</span><span class="token operator">/</span>high16 v1<span class="token punctuation">,</span> <span class="token number">0x7f0c0000</span><br><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">MenuInflater</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token class-name">ILandroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">Menu</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br>    <span class="token keyword">const</span><span class="token operator">/</span><span class="token number">4</span> p1<span class="token punctuation">,</span> <span class="token number">0x1</span><br><br>    <span class="token keyword">return</span> p1<br><span class="token punctuation">.</span>end method<br><br><span class="token punctuation">.</span>method <span class="token keyword">public</span> <span class="token function">onOptionsItemSelected</span><span class="token punctuation">(</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">MenuItem</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br>    <span class="token punctuation">.</span>locals <span class="token number">2</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">47</span><br>    invoke<span class="token operator">-</span><span class="token keyword">interface</span> <span class="token punctuation">{</span>p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">MenuItem</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">I</span><br><br>    move<span class="token operator">-</span>result v0<br><br>    <span class="token keyword">const</span> v1<span class="token punctuation">,</span> <span class="token number">0x7f08003f</span><br><br>    <span class="token keyword">if</span><span class="token operator">-</span>ne v0<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> <span class="token operator">:</span>cond_0<br><br>    <span class="token keyword">const</span><span class="token operator">/</span><span class="token number">4</span> p1<span class="token punctuation">,</span> <span class="token number">0x1</span><br><br>    <span class="token keyword">return</span> p1<br><br>    <span class="token punctuation">.</span>line <span class="token number">54</span><br>    <span class="token operator">:</span>cond_0<br>    invoke<span class="token operator">-</span><span class="token keyword">super</span> <span class="token punctuation">{</span>p0<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroidx</span><span class="token operator">/</span>appcompat<span class="token operator">/</span>app<span class="token operator">/</span><span class="token class-name">AppCompatActivity</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">onOptionsItemSelected</span><span class="token punctuation">(</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">MenuItem</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result p1<br><br>    <span class="token keyword">return</span> p1<br><span class="token punctuation">.</span>end method<br></code></pre><p>如果你覺得看起來不是很好閱讀，那是正常的。</p><p>Smali 是跑在 Android Dalvik VM 上的 byte code，有著自己的一套語法規則，如果想要看到我們熟悉的 Java 程式碼，必須要將 smali 還原成 Java。</p><h2 id="%E5%88%A9%E7%94%A8-jadx-%E9%82%84%E5%8E%9F%E5%87%BA-java-%E7%A8%8B%E5%BC%8F%E7%A2%BC"><a href="#%E5%88%A9%E7%94%A8-jadx-%E9%82%84%E5%8E%9F%E5%87%BA-java-%E7%A8%8B%E5%BC%8F%E7%A2%BC" class="direct-link">#</a> 利用 jadx 還原出 Java 程式碼</h2><p>接著我們要用到另外一套工具：<a href="https://github.com/skylot/jadx" rel="noopener noreferrer" target="_blank">jadx</a>，GitHub 上面它對自己的描述是：Dex to Java decompiler。</p><p>安裝過程我一樣省略，接著我們用 jadx 把 apk 拆開：</p><pre class="language-shell"><code class="language-shell"><span class="token comment"># -r 代表不要把 resource 拆開，因為我們只關注程式碼</span><br><span class="token comment"># -d 代表目的地</span><br>jadx -r demoapp.apk -d jadx-demoapp</code></pre><p>跑完以後就會看到多了一個 jadx-demoapp 的資料夾，我們點進去裡面的 <code>sources/com/cymetrics/demo/MainActivity.java</code>，可以看到如下內容：</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cymetrics<span class="token punctuation">.</span>demo</span><span class="token punctuation">;</span><br><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Bundle</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">Menu</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">MenuItem</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">View</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">AppCompatActivity</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>widget<span class="token punctuation">.</span></span><span class="token class-name">Toolbar</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>material<span class="token punctuation">.</span>floatingactionbutton<span class="token punctuation">.</span></span><span class="token class-name">FloatingActionButton</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>android<span class="token punctuation">.</span>material<span class="token punctuation">.</span>snackbar<span class="token punctuation">.</span></span><span class="token class-name">Snackbar</span><span class="token punctuation">;</span><br><span class="token comment">/* loaded from: classes.dex */</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{</span><br>    <span class="token comment">/* JADX INFO: Access modifiers changed from: protected */</span><br>    <span class="token punctuation annotation">@Override</span> <span class="token comment">// androidx.appcompat.app.AppCompatActivity, androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span><br>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> bundle<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>bundle<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token function">setSupportActionBar</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Toolbar</span><span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>toolbar<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">FloatingActionButton</span><span class="token punctuation">)</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>fab<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// from class: com.cymetrics.demo.MainActivity.1</span><br>            <span class="token punctuation annotation">@Override</span> <span class="token comment">// android.view.View.OnClickListener</span><br>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name">Snackbar</span><span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token string">"Replace with your own action"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAction</span><span class="token punctuation">(</span><span class="token string">"Action"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token punctuation annotation">@Override</span> <span class="token comment">// android.app.Activity</span><br>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onCreateOptionsMenu</span><span class="token punctuation">(</span><span class="token class-name">Menu</span> menu<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">getMenuInflater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>menu<span class="token punctuation">.</span>menu_main<span class="token punctuation">,</span> menu<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token punctuation annotation">@Override</span> <span class="token comment">// android.app.Activity</span><br>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onOptionsItemSelected</span><span class="token punctuation">(</span><span class="token class-name">MenuItem</span> menuItem<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>menuItem<span class="token punctuation">.</span><span class="token function">getItemId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>action_settings<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onOptionsItemSelected</span><span class="token punctuation">(</span>menuItem<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br></code></pre><p>這才是我們想看到的內容嘛！因為這個 apk 沒有經過混淆，所以幾乎可以看到完整的 java 檔案，跟原始碼差不了多少。</p><p>簡單講一下混淆（Obfuscation），混淆就是把程式碼打亂，讓人不容易看出來原本的程式碼是什麼，例如說把變數名字都換成 aa, bb, cc, dd 這種沒有意義的名稱之類的，就是最基本的混淆。在 Android 開發中通常透過 ProGuard 這個工具來做混淆。</p><p>像上面那樣的程式碼很明顯就沒有混淆過，讓人很容易就能看出原本的邏輯。</p><p>這次我們要來改動的程式碼在 <code>com/cymetrics/demo/FirstFragment.java</code>：</p><pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cymetrics<span class="token punctuation">.</span>demo</span><span class="token punctuation">;</span><br><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Bundle</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">LayoutInflater</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">View</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">ViewGroup</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">android<span class="token punctuation">.</span>widget<span class="token punctuation">.</span></span><span class="token class-name">TextView</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">Fragment</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>scottyab<span class="token punctuation">.</span>rootbeer<span class="token punctuation">.</span></span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><br><span class="token comment">/* loaded from: classes.dex */</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FirstFragment</span> <span class="token keyword">extends</span> <span class="token class-name">Fragment</span> <span class="token punctuation">{</span><br>    <span class="token punctuation annotation">@Override</span> <span class="token comment">// androidx.fragment.app.Fragment</span><br>    <span class="token keyword">public</span> <span class="token class-name">View</span> <span class="token function">onCreateView</span><span class="token punctuation">(</span><span class="token class-name">LayoutInflater</span> layoutInflater<span class="token punctuation">,</span> <span class="token class-name">ViewGroup</span> viewGroup<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bundle<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> layoutInflater<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>fragment_first<span class="token punctuation">,</span> viewGroup<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token punctuation annotation">@Override</span> <span class="token comment">// androidx.fragment.app.Fragment</span><br>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onViewCreated</span><span class="token punctuation">(</span><span class="token class-name">View</span> view<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bundle<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> bundle<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        view<span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>button_first<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setOnClickListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">View<span class="token punctuation">.</span>OnClickListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// from class: com.cymetrics.demo.FirstFragment.1</span><br>            <span class="token punctuation annotation">@Override</span> <span class="token comment">// android.view.View.OnClickListener</span><br>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> view2<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                <span class="token class-name">TextView</span> textView <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TextView</span><span class="token punctuation">)</span> view2<span class="token punctuation">.</span><span class="token function">getRootView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>textview_first<span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RootBeer</span><span class="token punctuation">(</span>view2<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isRooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                    textView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Rooted!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                    textView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Safe, not rooted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>主要的邏輯是這一段：</p><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">View</span> view2<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token class-name">TextView</span> textView <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TextView</span><span class="token punctuation">)</span> view2<span class="token punctuation">.</span><span class="token function">getRootView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>textview_first<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RootBeer</span><span class="token punctuation">(</span>view2<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isRooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        textView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Rooted!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        textView<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"Safe, not rooted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>這一段會去呼叫一個第三方的 library 檢查是否有 root，有的話就顯示 <code>Rooted!</code>，沒有的話就顯示 <code>Safe, not rooted</code>。</p><p>在研究程式碼邏輯時，我們可以看著 java 程式碼，但如果要改 code 的話，就不是改 java code 這麼簡單了，我們必須要直接去改 smali 的 code，才能把 app 重新打包回去。</p><h2 id="%E4%BF%AE%E6%94%B9-smali-%E7%A8%8B%E5%BC%8F%E7%A2%BC"><a href="#%E4%BF%AE%E6%94%B9-smali-%E7%A8%8B%E5%BC%8F%E7%A2%BC" class="direct-link">#</a> 修改 smali 程式碼</h2><p>還記得我們用 Apktool 解開的資料夾嗎？smali 程式碼就在那裡面，路徑是：<code>smali/com/cymetrics/demo/FirstFragment$1.smali</code>，仔細找一下內容，就可以找到 onClick 的程式碼：</p><pre class="language-java"><code class="language-java"># virtual methods<br><span class="token punctuation">.</span>method <span class="token keyword">public</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br>    <span class="token punctuation">.</span>locals <span class="token number">2</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">32</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">getRootView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">;</span><br><br>    move<span class="token operator">-</span>result<span class="token operator">-</span>object v0<br><br>    <span class="token keyword">const</span> v1<span class="token punctuation">,</span> <span class="token number">0x7f08011c</span><br><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>v0<span class="token punctuation">,</span> v1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">;</span><br><br>    move<span class="token operator">-</span>result<span class="token operator">-</span>object v0<br><br>    check<span class="token operator">-</span>cast v0<span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">34</span><br>    <span class="token keyword">new</span><span class="token operator">-</span>instance v1<span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><br><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Landroid</span><span class="token operator">/</span>content<span class="token operator">/</span><span class="token class-name">Context</span><span class="token punctuation">;</span><br><br>    move<span class="token operator">-</span>result<span class="token operator">-</span>object p1<br><br>    invoke<span class="token operator">-</span>direct <span class="token punctuation">{</span>v1<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">Landroid</span><span class="token operator">/</span>content<span class="token operator">/</span><span class="token class-name">Context</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">35</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>v1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">isRooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result p1<br><br>    <span class="token keyword">if</span><span class="token operator">-</span>eqz p1<span class="token punctuation">,</span> <span class="token operator">:</span>cond_0<br><br>    <span class="token keyword">const</span><span class="token operator">-</span>string p1<span class="token punctuation">,</span> <span class="token string">"Rooted!"</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">36</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>v0<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br>    <span class="token keyword">goto</span> <span class="token operator">:</span>goto_0<br><br>    <span class="token operator">:</span>cond_0<br>    <span class="token keyword">const</span><span class="token operator">-</span>string p1<span class="token punctuation">,</span> <span class="token string">"Safe, not rooted"</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">38</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>v0<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br>    <span class="token operator">:</span>goto_0<br>    <span class="token keyword">return</span><span class="token operator">-</span><span class="token keyword">void</span><br><span class="token punctuation">.</span>end method</code></pre><p>簡單講解一下一些基礎的 smali 語法，<code>.method public onClick(Landroid/view/View;)V</code> 就是說有一個 public 的 method 叫做 onClick，接收一個參數類型是 <code>android/view/View</code>，括號最後面的 V 則代表 void，沒有回傳值。</p><p><code>.locals 2</code> 指的是這個 function 會用到兩個暫存器，也就是 v0 跟 v1，如果你用到 v2 的話就會出錯，因此如果需要更多暫存器，記得要改這邊。</p><p>參數的話會用 p 來表示，通常 p0 代表 this，p1 就是第一個參數，因此 <code>invoke-virtual {p1}, Landroid/view/View;->getRootView()Landroid/view/View;</code> 就是把第一個參數丟進去呼叫 <code>getRootView()</code> 這個 method。</p><p>而這整段裡面，核心的程式碼是這一段：</p><pre class="language-java"><code class="language-java"><span class="token punctuation">.</span>line <span class="token number">35</span><br>invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>v1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">isRooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>move<span class="token operator">-</span>result p1<br><br><span class="token keyword">if</span><span class="token operator">-</span>eqz p1<span class="token punctuation">,</span> <span class="token operator">:</span>cond_0<br><br><span class="token keyword">const</span><span class="token operator">-</span>string p1<span class="token punctuation">,</span> <span class="token string">"Rooted!"</span><br><br><span class="token punctuation">.</span>line <span class="token number">36</span><br>invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>v0<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br><span class="token keyword">goto</span> <span class="token operator">:</span>goto_0<br><br><span class="token operator">:</span>cond_0<br><span class="token keyword">const</span><span class="token operator">-</span>string p1<span class="token punctuation">,</span> <span class="token string">"Safe, not rooted"</span></code></pre><p><code>if-eqz p1, :cond_0</code> 指的就是如果 p1 是 0，就跳到 <code>:cond_0</code> 的地方，而 p1 是 <code>RootBeer->isRooted()</code> 的回傳值。也就是說，p1 代表著 root 檢查的結果，只要能把 p1 改掉，就能偽造不同的結果。</p><p>這邊有很多種改法，例如說把原本的 <code>if-eqz</code> 改成 <code>if-nez</code>，就可以反轉邏輯，或我們可以直接將 p1 硬改成 0，順便加上 log 確認我們有執行到這裡：</p><pre class="language-java"><code class="language-java"><span class="token punctuation">.</span>line <span class="token number">35</span><br>invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>v1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">isRooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>move<span class="token operator">-</span>result p1<br><br># 加上 log，印出 <span class="token string">"we are here"</span><br><span class="token keyword">const</span><span class="token operator">-</span>string v1<span class="token punctuation">,</span> <span class="token string">"we are here"</span><br>invoke<span class="token operator">-</span><span class="token keyword">static</span> <span class="token punctuation">{</span>v1<span class="token punctuation">,</span> v1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>util<span class="token operator">/</span><span class="token class-name">Log</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">e</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">I</span><br><br># 將 p1 直接硬改成 <span class="token number">0</span><br><span class="token keyword">const</span><span class="token operator">/</span><span class="token number">4</span> p1<span class="token punctuation">,</span> <span class="token number">0x0</span><br><br><span class="token keyword">if</span><span class="token operator">-</span>eqz p1<span class="token punctuation">,</span> <span class="token operator">:</span>cond_0<br><br><span class="token keyword">const</span><span class="token operator">-</span>string p1<span class="token punctuation">,</span> <span class="token string">"Rooted!"</span><br><br><span class="token punctuation">.</span>line <span class="token number">36</span><br>invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>v0<span class="token punctuation">,</span> p1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><br><br><span class="token keyword">goto</span> <span class="token operator">:</span>goto_0<br><br><span class="token operator">:</span>cond_0<br><span class="token keyword">const</span><span class="token operator">-</span>string p1<span class="token punctuation">,</span> <span class="token string">"Safe, not rooted"</span></code></pre><p>加上那三行以後存檔，接著照著上一篇講的重新打包，安裝在手機上，打開 app 以後先看 log。</p><p>要看 Android 的 log 的話，需要用 <code>adb logcat</code> 這個指令來看，但如果你直接輸入這個指令，會噴一堆 log 出來，在這邊教大家兩個好用的指令。</p><p>第一個是 <code>adb logcat -c</code>，可以清掉之前的 log，第二個是：</p><pre class="language-shell"><code class="language-shell">adb logcat --pid<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>adb shell pidof -s com.cymetrics.demo<span class="token variable">`</span></span></code></pre><p>可以看到指定 package name 的 log，排除其他雜訊，這個真的很好用。</p><p>準備就緒以後，按下 app 內的 <code>CHECK ROOT</code> 按鈕，就會看到一條新的 log：</p><pre class="language-shell"><code class="language-shell">01-25 09:32:06.528 <span class="token number">27651</span> <span class="token number">27651</span> E we are here: we are here</code></pre><p>以及畫面上出現的 <code>Safe, not rooted</code> 的字樣，就大功告成了。</p><h2 id="%E6%9B%B4%E6%94%B9%E5%85%B6%E4%BB%96%E5%9C%B0%E6%96%B9%E7%9A%84%E7%A8%8B%E5%BC%8F%E7%A2%BC"><a href="#%E6%9B%B4%E6%94%B9%E5%85%B6%E4%BB%96%E5%9C%B0%E6%96%B9%E7%9A%84%E7%A8%8B%E5%BC%8F%E7%A2%BC" class="direct-link">#</a> 更改其他地方的程式碼</h2><p>剛剛我們改動了 fragment 中的程式碼，也就是程式的邏輯，把 <code>isRooted()</code> 的回傳值取代掉，讓它永遠是 false，繞過了檢查。</p><p>但如果程式中還有其他地方也會做類似的檢查那就麻煩了，因為我們必須找出每一個做檢查的地方，然後都做類似的事情，把每一處都改掉。</p><p>因此，一個比較有效率的方法是直接去改動這個第三方 library 的程式碼，讓 <code>isRooted</code> 永遠都回傳 false，這樣就算 app 在多個地方都有檢查，也會一起被繞過。</p><p>呼叫 function 時的程式碼是 <code>Lcom/scottyab/rootbeer/RootBeer;->isRooted()</code>，因此我們可以順藤摸瓜找到這個檔案：<code>com/scottyab/rootbeer/RootBeer.smali</code>，搜尋 <code>isRooted</code> 就會找到程式碼：</p><pre class="language-java"><code class="language-java"><span class="token punctuation">.</span>method <span class="token keyword">public</span> <span class="token function">isRooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br>    <span class="token punctuation">.</span>locals <span class="token number">1</span><br><br>    <span class="token punctuation">.</span>line <span class="token number">44</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">detectRootManagementApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result v0<br><br>    <span class="token keyword">if</span><span class="token operator">-</span>nez v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_1<br><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">detectPotentiallyDangerousApps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result v0<br><br>    <span class="token keyword">if</span><span class="token operator">-</span>nez v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_1<br><br>    <span class="token keyword">const</span><span class="token operator">-</span>string v0<span class="token punctuation">,</span> <span class="token string">"su"</span><br><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">,</span> v0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">checkForBinary</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result v0<br><br>    <span class="token keyword">if</span><span class="token operator">-</span>nez v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_1<br><br>    <span class="token punctuation">.</span>line <span class="token number">45</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">checkForDangerousProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result v0<br><br>    <span class="token keyword">if</span><span class="token operator">-</span>nez v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_1<br><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">checkForRWPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result v0<br><br>    <span class="token keyword">if</span><span class="token operator">-</span>nez v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_1<br><br>    <span class="token punctuation">.</span>line <span class="token number">46</span><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">detectTestKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result v0<br><br>    <span class="token keyword">if</span><span class="token operator">-</span>nez v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_1<br><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">checkSuExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result v0<br><br>    <span class="token keyword">if</span><span class="token operator">-</span>nez v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_1<br><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">checkForRootNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result v0<br><br>    <span class="token keyword">if</span><span class="token operator">-</span>nez v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_1<br><br>    invoke<span class="token operator">-</span>virtual <span class="token punctuation">{</span>p0<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>scottyab<span class="token operator">/</span>rootbeer<span class="token operator">/</span><span class="token class-name">RootBeer</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">checkForMagiskBinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br><br>    move<span class="token operator">-</span>result v0<br><br>    <span class="token keyword">if</span><span class="token operator">-</span>eqz v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_0<br><br>    <span class="token keyword">goto</span> <span class="token operator">:</span>goto_0<br><br>    <span class="token operator">:</span>cond_0<br>    <span class="token keyword">const</span><span class="token operator">/</span><span class="token number">4</span> v0<span class="token punctuation">,</span> <span class="token number">0x0</span><br><br>    <span class="token keyword">goto</span> <span class="token operator">:</span>goto_1<br><br>    <span class="token operator">:</span>cond_1<br>    <span class="token operator">:</span>goto_0<br>    <span class="token keyword">const</span><span class="token operator">/</span><span class="token number">4</span> v0<span class="token punctuation">,</span> <span class="token number">0x1</span><br><br>    <span class="token operator">:</span>goto_1<br>    <span class="token keyword">return</span> v0<br><span class="token punctuation">.</span>end method</code></pre><p>想要 patch 這個函式非常簡單，我們讓它永遠都回傳 false 就好：</p><pre class="language-java"><code class="language-java"><span class="token punctuation">.</span>method <span class="token keyword">public</span> <span class="token function">isRooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Z</span><br>    <span class="token punctuation">.</span>locals <span class="token number">1</span><br>    <br>    # 在開頭新增底下這兩行，永遠回傳 <span class="token boolean">false</span><br>    <span class="token keyword">const</span><span class="token operator">/</span><span class="token number">4</span> v0<span class="token punctuation">,</span> <span class="token number">0x0</span><br>    <span class="token keyword">return</span> v0<br>    <br>    # 以下省略<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><br><span class="token punctuation">.</span>end method</code></pre><p>接著一樣重新打包之後安裝在手機上，就能看到繞過的成果。</p><h2 id="%E7%B8%BD%E7%B5%90"><a href="#%E7%B8%BD%E7%B5%90" class="direct-link">#</a> 總結</h2><p>在這篇裡面我們學到了如何閱讀基本的 smali 程式碼以及修改它，也學到了該如何利用 <code>adb logcat</code> 來看 Android app 的 log，並且實際下去修改 smali，反轉原本的邏輯，去繞過 app 對於 root 的檢查。</p><p>加上 log 是一個我覺得雖然看起來好像很笨很沒效率，但其實很有用的方法，就跟寫程式出錯的時候我會加一大堆 <code>console.log</code> 一樣，透過 log 來確認程式的執行流程跟自己預期中的相符，對於還原邏輯很有幫助。</p><p>最後，這篇我只有稍微提了一下 smali，如果想更了解 smali 的語法，可以參考底下文章：</p><ol><li><a href="https://www.jianshu.com/p/9931a1e77066" rel="noopener noreferrer" target="_blank">Android逆向基础：Smali语法</a></li><li><a href="https://blog.csdn.net/chenrunhua/article/details/41250613" rel="noopener noreferrer" target="_blank">APK反编译之一：基础知识--smali文件阅读</a></li></ol><p>在下一篇文章中，我會介紹如何去監聽 app 向外發送的 request 以及 response，幫助我們了解 app 跟 API server 的溝通。</p><p>系列文連結：</p><ol><li><a href="/posts/huli/android-apk-decompile-intro-1/">Android App 逆向入門之一：拆開與重組 apk</a></li><li><a href="/posts/huli/android-apk-decompile-intro-2/">Android App 逆向入門之二：修改 smali 程式碼</a> - 你在這篇</li><li><a href="/posts/huli/android-apk-decompile-intro-3/">Android App 逆向入門之三：監聽 app 封包</a></li><li><a href="/posts/huli/android-apk-decompile-intro-4/">Android App 逆向入門之四：使用 Frida 進行動態分析</a></li></ol><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/huli/android-apk-decompile-intro-2/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/mobile/" class="post-tag">#Mobile</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/huli/wordpress-plugin-vikbooking-unauth-rce/">WordPress Plugin VikBooking &lt;= 1.5.3 Unauthorized RCE 漏洞細節</a></li><li><a href="/posts/crystal/email-sec-settings-spf/">關於 email security 的大小事 — 設定篇 SPF</a></li><li><a href="/posts/genchilu/javas-thread-model-and-golang-goroutine-zh/">Java’s Thread Model and Golang Goroutine</a></li><li><a href="/posts/jo/zerobased-injectionattack/">零基礎資安系列（四）-認識注入攻擊（ Injection Attack）</a></li><li><a href="/posts/jo/zerobased-cross-site-request-forgery/">零基礎資安系列（一）-認識 CSRF（Cross Site Request Forgery）</a></li></ol></div><div class="article-author"><img alt="huli" src="/img/authors/huli_logo.jpg" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/huli">huli</a></div><div class="article-author__intro">Act as a bridge between Front-end and Security world</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Android App 逆向入門之二：修改 smali 程式碼","image":["https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/huli_logo.jpg"],"author":{"@type":"Person","name":"huli"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/huli/android-apk-decompile-intro-2/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/huli/android-apk-decompile-intro-2/","datePublished":"2022-02-21","dateModified":"2023-01-31","description":"在第一篇當中我們學到了基礎中的基礎，靠著 Apktool 把 apk 拆開，修改資源以後組裝回去，並且把對齊且簽署過的 apk 裝回手機上面。 而接下來的這一篇，我們要來看看如何修改程式碼。 我們的目的是在一台有 root 的手機上繞過檢查，讓 app 顯示沒有..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a>. <a href="https://oneinfinity.global/" rel="noopener noreferrer" target="_blank">OneInfinity</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>