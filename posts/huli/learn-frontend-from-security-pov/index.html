<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>接觸資安才發現我不懂前端</title><meta content="接觸資安才發現我不懂前端" property="og:title"><meta content="接觸資安才發現我不懂前端" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="這陣子有玩了一些 CTF，對於前端也從另一個角度看了一陣子，學到很多新的前端知識，換句話說，我在一個新的領域（資安）重新學習到了我原本熟悉的領域（前端）的知識，這種感覺十分特別，因此這篇文章想跟大家分享我學到的一些東西，希望能讓大家感受到我當初的驚訝。" name="description"><meta content="這陣子有玩了一些 CTF，對於前端也從另一個角度看了一陣子，學到很多新的前端知識，換句話說，我在一個新的領域（資安）重新學習到了我原本熟悉的領域（前端）的知識，這種感覺十分特別，因此這篇文章想跟大家分享我學到的一些東西，希望能讓大家感受到我當初的驚訝。" name="twitter:description"><meta content="這陣子有玩了一些 CTF，對於前端也從另一個角度看了一陣子，學到很多新的前端知識，換句話說，我在一個新的領域（資安）重新學習到了我原本熟悉的領域（前端）的知識，這種感覺十分特別，因此這篇文章想跟大家分享我學到的一些東西，希望能讓大家感受到我當初的驚訝。" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/huli/learn-frontend-from-security-pov/" property="og:url"><link href="https://blog.huli.tw/2021/10/25/learn-frontend-from-security-pov/" rel="canonical"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}template{display:none}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,ol,p,pre{font-size:1em}ol,p,pre{margin-bottom:1.5em}body,ol,p,pre{font-size:1rem;line-height:1.6}ol,p,pre{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,ol,p,pre{font-size:1.1rem;line-height:1.6}h2,h3,ol,p,pre{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}body,ol,p,pre{font-size:1.2rem;line-height:1.6}h2,h3,ol,p,pre{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}@media (max-width:767px){x:-moz-any-link{display:table-cell}}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}section{margin-left:auto;margin-right:auto;width:900px}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.tag{color:#e2777a}.token.boolean,.token.function,.token.number{color:#f08d49}.token.constant,.token.property{color:#f8c555}.token.keyword{color:#cc99cd}.token.attr-value,.token.string{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.entity{cursor:help}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a> <a href="/en">English</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">接觸資安才發現我不懂前端</h1><aside class="w-full"><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/front-end/" class="post-tag">#Front-end</a></div><div class="post-avatar"><img alt="huli" src="/img/authors/huli_logo.jpg" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/huli">huli</a></div><div class="post-avatar__time">25 Oct 2021</div></div></div><div class="notice-block" data-nosnippet="" style="display:none;">我們正在尋找一位 Security Engineer 加入我們的團隊，詳情請參考<a href="https://github.com/cymetrics/blog/issues/13" rel="noopener noreferrer" target="_blank">職缺資訊</a></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>此文章是我在 Modern Web 2021 的分享：《接觸資安才發現前端的水真深》的文字版，當時的演講影片尚未釋出，想看簡報的話在這邊：<a href="https://speakerdeck.com/aszx87410/jie-chu-zi-an-cai-fa-xian-qian-duan-de-shui-zhen-shen-modern-web-2021" rel="noopener noreferrer" target="_blank">slides</a></p><p>我自己覺得影片加上簡報的效果應該會比文字好，但想說用文字留一份紀錄也不錯，因此還是寫了這篇文章，內容會有些許與影片不同，有點像是再重新寫了一遍。</p><h2 id="%E5%8E%9F%E4%BE%86%E6%88%91%E4%B8%8D%E6%87%82%E5%89%8D%E7%AB%AF"><a href="#%E5%8E%9F%E4%BE%86%E6%88%91%E4%B8%8D%E6%87%82%E5%89%8D%E7%AB%AF" class="direct-link">#</a> 原來我不懂前端</h2><p>這個標題是我接觸到資安的世界以後，最真實的想法。</p><p>身為一個前端工程師，自認為對前端頗為熟悉，無論是原生的 JavaScript 還是一些框架或函式庫，多少都用過或者聽過，連看到許多奇形怪狀的 JavaScript 題目也不會感到太過驚訝，覺得已經沒什麼能讓我「哇！」這樣的驚嘆。</p><p>直到我接觸了資安相關的東西，才知道是我太天真。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p1-ice-1920w.webp 1920w, /img/posts/huli/learn-frontend-from-security-pov/p1-ice-1280w.webp 1280w, /img/posts/huli/learn-frontend-from-security-pov/p1-ice-840w.webp 840w, /img/posts/huli/learn-frontend-from-security-pov/p1-ice-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p1-ice-1920w.jpg 1920w, /img/posts/huli/learn-frontend-from-security-pov/p1-ice-1280w.jpg 1280w, /img/posts/huli/learn-frontend-from-security-pov/p1-ice-840w.jpg 840w, /img/posts/huli/learn-frontend-from-security-pov/p1-ice-320w.jpg 320w" type="image/jpeg"><img alt="" src="/img/posts/huli/learn-frontend-from-security-pov/p1-ice-1920w.jpg" height="911" width="600" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 600 911'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAKCAIAAAAYbLhkAAAACXBIWXMAAAidAAAInQGyjvixAAAAyUlEQVQImQG+AEH/ADBzxTZ4ukqDvWOLtUt/ujB/2wAzkOFcmtCKrMlunchfm9YuiOkALIbSj7XTdpm8KGSqEHLVCWrSAAZUxARv3ABw4wBWyQdLtAY9lAAmf9RLjLZCh7s6dqsLRJMBMIAAD2zAD2nPBWfjEnzlEmqwAilvAAZKpQRv5wBv8gh67BBUoQMfVwAEKmwLgM8VqfoSd78BHVoCDC4AAgovBSVUD0RxByJNAQcoAQEMAAAACgAAEgAAEwAAEQAABQAAAPMUQOePuQ3cAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>前端工程師所接觸的前端，跟資安工程師所看到的前端是兩個不同的面向。資安的重點在於各式各樣的攻擊手法，要想辦法繞過既有的限制，找到一條新的道路。但是前端工程師根本不需要知道那些東西，因為他是在沒有限制的狀況下來寫 code 的。</p><p>這陣子有玩了一些 CTF，對於前端也從另一個角度看了一陣子，學到很多新的前端知識，換句話說，我在一個新的領域（資安）重新學習到了我原本熟悉的領域（前端）的知識，這種感覺十分特別，因此這篇文章想跟大家分享我學到的一些東西，希望能讓大家感受到我當初的驚訝。</p><p>此文章分成三個主題：</p><ol><li>繞過各種限制</li><li>XS leaks</li><li>其他你可能不知道的功能</li></ol><h2 id="%E7%B9%9E%E9%81%8E%E5%90%84%E7%A8%AE%E9%99%90%E5%88%B6"><a href="#%E7%B9%9E%E9%81%8E%E5%90%84%E7%A8%AE%E9%99%90%E5%88%B6" class="direct-link">#</a> 繞過各種限制</h2><p>談到前端安全，第一個想到的想必是 XSS，有關 XSS 的文章跟介紹之前寫過不少了，有興趣的話可以參考：<a href="https://tech-blog.cymetrics.io/posts/huli/xss-history/">XSS 從頭談起：歷史與由來</a>，這邊就不再贅述。</p><p>一個最簡單直覺的 XSS payload 會長這樣：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>但這種形式的 XSS 不夠有趣，而且很容易被防禦住，所以我們先暫時不講這個，來看一些比較有趣的，例如說這個：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>non_exist</span> <span class="token special-attr"><span class="token attr-name">onerror</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token language-javascript javascript value"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span></code></pre><p>這一段 HTML 利用 event handler 的方式去執行 JavaScript，我們載入一張不存在的圖片，就會觸發 onerror 事件，執行到裡面的程式碼。還有一點值得注意的是，其實屬性不需要加 <code>""</code> 也可以。</p><p>還可以再更進一步，變成這樣：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span> <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token language-javascript javascript value"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span></code></pre><p>這次連 src 都不需要了，直接用 <code>&lt;svg></code> 搭配 <code>onload</code> 事件去執行程式碼。</p><p>假設小明是一位後端工程師，責任是去過濾這些輸入的字串，讓它不要產生 XSS 漏洞，除了過濾 <code>&lt;script></code> 以外，小明也過濾了空格。理由很簡單，像是這種用屬性來執行的 XSS，屬性跟標籤之間一定要有空格對吧？那一旦把空格濾掉，不就沒辦法利用屬性來做 XSS 了嗎？</p><p>天真的小明踢到了鐵板，因為其實可以這樣：</p><pre class="language-html"><code class="language-html">&lt;svg/onload=alert(1)><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span>    <span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token language-javascript javascript value"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span><br><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><br><span class="token special-attr"><span class="token attr-name">onload</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token language-javascript javascript value"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span></span><span class="token punctuation">></span></span></code></pre><p>除了空格以外，<code>/</code>、tab 還有換行都是合法的分隔符號，所以如果只取代空格的話是沒有用的。</p><p>小明知道這個規則以後，察覺到根本問題其實不是空格，而是 <code>onxxx</code> 這種以 on 開頭的 event handler，於是他把 on 開頭的屬性全都過濾掉了，心想：「只要沒辦法用 event handler，就沒辦法 XSS 吧？」</p><p>聽起來十分合理，但他不知道的是，就算沒有 event handler 也可以：</p><pre class="language-html"><code class="language-html">&lt;iframe/src="javascript:alert(1)"></code></pre><p><code>javascript:</code> 開頭的字串稱為 JavaScript pseudo protocol，在一些地方可以用來執行程式碼，之前我們在<a href="https://tech-blog.cymetrics.io/posts/huli/open-redirect/">《在做跳轉功能時應該注意的問題：Open Redirect》</a>中就有提過這個特性。</p><p>小明的防禦再度破功，只好再次加強，把 <code>javascript</code> 這個看起來很危險的字串取代掉，這樣應該就沒事了吧？</p><p>殊不知，原來在 <code>javascript</code> 這幾個字中間塞入 tab 以後，居然還是有效：</p><pre class="language-html"><code class="language-html">&lt;iframe/src="javas    cript:alert(1)"></code></pre><p>小明修正了程式碼，把那些有的沒的像是空白、空行或是 tab 全都取代成空字串，然後再檢查一次有沒有 <code>javascript</code>，有的話就過濾掉，如此一來，上面的 payload 就無法運作了。</p><p>但小明忘記網頁上的資訊是可以編碼的，例如說你想在畫面上呈現 <code>&lt;h1></code>，你要編碼成 <code>&amplt;h1&ampgt;</code>，這樣畫面呈現的是你要的東西，而不是被當作 h1 標籤來解析。除了那些特殊符號，一般的文字也可以用 <code>&#{ascii_code};</code> 來編碼，例如說 <code>j</code> 的 ascii code 是 106，就可以編碼成 <code>&amp#106;</code>：</p><pre class="language-html"><code class="language-html">&lt;iframe/src="<span class="token entity" title="j">&amp#106;</span>avascript:alert(1)"></code></pre><p>如果你想要的話，可以把整串字全部都編碼，就只會剩下一些符號跟數字而已。</p><p>惱怒的小明這次不演了，直接禁用 <code>src</code> 屬性，想說「那我把 src 都禁用就沒事了吧？不要再來煩我了！」</p><p>但他忘記的事情是，<code>&lt;a></code> 也可以用這個屬性：</p><pre class="language-html"><code class="language-html">&lt;a/href="<span class="token entity" title="j">&amp#106;</span>avascript:alert(1)">點我<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></code></pre><p>只是這次就不會自動觸發了，需要使用者主動點擊才能觸發。</p><p>最後小明真的受不了了，於是覆蓋了一張 <a href="https://github.com/cure53/DOMPurify" rel="noopener noreferrer" target="_blank">DOMPurify</a>，結束這個回合。</p><p>除了上面的這些標籤跟屬性的繞過以外，JavaScript 本身的繞過也滿好玩的，例如說：「有沒有辦法在不使用 <code>()</code> 的狀況下執行函式？」</p><p>如果你有用過 React 的 styled-components 或類似的東西，應該寫過像這樣的程式碼：</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> Box <span class="token operator">=</span> styled<span class="token punctuation">.</span>div<span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string"><br>  background: red;<br></span><span class="token string template-punctuation">`</span></span></code></pre><p>為什麼這樣就可以產生出一個 component 呢？這是因為反引號除了可以用來當作 template string 以外，也可以拿來當作函式呼叫，這我在 <a href="https://blog.huli.tw/2021/06/07/xss-challenge-by-intigriti-writeup-may/" rel="noopener noreferrer" target="_blank">Intigriti’s 0521 XSS 挑戰解法：限定字元組合程式碼</a>裡面有提到過。</p><p>所以可以這樣寫：</p><pre class="language-js"><code class="language-js">alert<span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string">1</span><span class="token string template-punctuation">`</span></span></code></pre><p>那如果現在連反引號都不能用呢？有沒有其他方法？</p><p>有一個我第一次看到的時候讚嘆了許久的方法：</p><pre class="language-js"><code class="language-js">onerror<span class="token operator">=</span>alert<span class="token punctuation">;</span><span class="token keyword">throw</span> <span class="token number">1</span></code></pre><p>它把 <code>window.onerror</code> 改寫成 <code>alert</code>，再拋出一個錯誤，而這個錯誤因為沒有被 catch 到，就會被 <code>window.onerror</code> 接住，最後被丟到 alert 裡面執行。</p><p>除了 alert 以外，改寫一下就可以執行任意程式碼：</p><pre class="language-js"><code class="language-js">onerror<span class="token operator">=</span>eval<span class="token punctuation">;</span><br><span class="token keyword">throw</span> <span class="token string">"=alert\x281\x29"</span></code></pre><p>第一行跟剛剛一樣，只是這次把 <code>onerror</code> 變成了 <code>eval</code>，但第二行是在做什麼呢？先講一下那個 <code>\x28</code> 跟 <code>\x29</code>，分別是 <code>()</code> 的編碼。</p><p>但為什麼前面多一個 <code>=</code>？</p><p>這是因為把錯誤拋出去的時候，如果是 Chrome，它最後會產生的字串是：<code>Uncaught {err_message}</code>，像是 <code>throw 1</code>，就會產生出 <code>Uncaught 1</code>，但這樣並不是一段 JavaScript 程式碼，丟到 <code>eval</code> 會直接噴出錯誤。</p><p>所以我們把 <code>"=alert\x281\x29"</code> 丟出去，就會變成 <code>Uncaught=alert\x281\x29</code>，整句變成了一個 expression，<code>Uncaught</code> 被當作是沒有宣告的全域變數，它的值是 <code>alert(1)</code> 的回傳值，如此一來，整段 error message 就變成合法的 JavaScript 程式碼了！利用這樣的方式丟給 eval，就可以正常執行。</p><p>其實還有一些更驚人的手法，但篇幅有限而且有些我也還在努力看懂，所以就先在此打住，以下圖做個總結：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p2-explosion-1920w.webp 1920w, /img/posts/huli/learn-frontend-from-security-pov/p2-explosion-1280w.webp 1280w, /img/posts/huli/learn-frontend-from-security-pov/p2-explosion-840w.webp 840w, /img/posts/huli/learn-frontend-from-security-pov/p2-explosion-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p2-explosion-1920w.jpg 1920w, /img/posts/huli/learn-frontend-from-security-pov/p2-explosion-1280w.jpg 1280w, /img/posts/huli/learn-frontend-from-security-pov/p2-explosion-840w.jpg 840w, /img/posts/huli/learn-frontend-from-security-pov/p2-explosion-320w.jpg 320w" type="image/jpeg"><img alt="" src="/img/posts/huli/learn-frontend-from-security-pov/p2-explosion-1920w.jpg" height="841" width="600" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 600 841'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAJCAIAAABxOqH0AAAACXBIWXMAAAliAAAJYgFi28+MAAAA0UlEQVQImQHGADn/AObm5oKCgsvLzH9+ewAISwsgeA4RJAD39/fr6+z///9ydYciJV9PUpIbI1oA0dHRpqanv723dIK5gn7SpZLTQFTCAPDw8Ly8vt7b1pCj10BguCQlfSxHqQDIyMi8vLzLy8mDgZOim7LUyN9oXH8Ay8vLlZSUsra1s5if27e9vba7pnWLAOXl5dHR0ePk4oqJkzc9WiVPYDk3VACwsLCfn6CnpqJheY4bb6Qxvd8jYZQA4ODgrq6v29vXfIegBh9zGVCcHT97dkpvFx9EFUoAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h3 id="%E5%AD%97%E6%95%B8%E9%99%90%E5%88%B6"><a href="#%E5%AD%97%E6%95%B8%E9%99%90%E5%88%B6" class="direct-link">#</a> 字數限制</h3><p>除了上面那些屬性以及字元的限制以外，還有另一種限制叫做字數限制。</p><p>舉例來說，如果有個網站的暱稱有 XSS 漏洞，可是只能輸入最多 25 個字，這種情況下只跳出一個 alert 是沒有殺傷力的，你有辦法執行任意程式碼嗎？</p><p>最短的 XSS payload <code>&lt;svg/onload=></code> 的這個骨架就有 13 個字了，因此我們只剩下 12 個字可以來執行程式碼，這時候就需要用到一個技巧，那就是「利用現有資訊」，像是這樣：</p><pre class="language-js"><code class="language-js"><span class="token comment">// 13 + 18 = 31 字</span><br><span class="token operator">&lt;</span>svg<span class="token operator">/</span>onload<span class="token operator">=</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string">'</span><span class="token string template-punctuation">`</span></span><span class="token operator">+</span>location<span class="token punctuation">)</span><span class="token operator">></span></code></pre><p>這短短的程式碼隱藏了不少細節，首先呢，如果你想拿到網址，你會怎麼做？<code>location.href</code> 嗎？更短的做法是把 <code>location</code> 轉成字串，你一樣能拿到網址。但網址本身不是合法的程式碼，所以我們要在前面加上一個單引號，接著再利用網址列上的 <code>#</code>，例如說這樣：<code>https://example.com#';alert(1)</code>，跟單引號拼起來就會變成：</p><pre class="language-js"><code class="language-js"><span class="token string">'https://example.com#'</span><span class="token punctuation">;</span><span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre><p>這就是一段合法的 JavaScript 程式碼了，因為它變成一個字串後面接指令！</p><p>除了 <code>location</code> 以外，<code>document.URL</code> 也可以拿到網址，但這字數明顯比 <code>locaton</code> 多，可是你知道嗎，<code>document</code> 可以省略，變成這樣：</p><pre class="language-js"><code class="language-js"><span class="token comment">// 13 + 13 = 26 字</span><br><span class="token operator">&lt;</span>svg<span class="token operator">/</span>onload<span class="token operator">=</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string template-punctuation">`</span><span class="token string">'</span><span class="token string template-punctuation">`</span></span><span class="token operator">+</span><span class="token constant">URL</span><span class="token punctuation">)</span><span class="token operator">></span></code></pre><p>為什麼不需要寫 <code>document</code>？這是因為有個隱藏的規格，在 event handler 裡面的 inline 程式碼，預設就會有 document 這個 scope：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p3-spec-1920w.webp 1920w, /img/posts/huli/learn-frontend-from-security-pov/p3-spec-1280w.webp 1280w, /img/posts/huli/learn-frontend-from-security-pov/p3-spec-840w.webp 840w, /img/posts/huli/learn-frontend-from-security-pov/p3-spec-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p3-spec-1920w.jpg 1920w, /img/posts/huli/learn-frontend-from-security-pov/p3-spec-1280w.jpg 1280w, /img/posts/huli/learn-frontend-from-security-pov/p3-spec-840w.jpg 840w, /img/posts/huli/learn-frontend-from-security-pov/p3-spec-320w.jpg 320w" type="image/jpeg"><img alt="" src="/img/posts/huli/learn-frontend-from-security-pov/p3-spec-1920w.jpg" height="784" width="2250" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2250 784'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAAA5NAAAOTQFG1WgJAAAAhUlEQVQImXXO2Q6DIBRFUf//I02U6oUiBSJ3rFNsmr51Pe/knE5E8NbaKqrnP11KyTk3unEcHlRN2ViIyLAdhBuTsDAzd7VWAAgh5Bg55tczZ1/WKogn4t4aEdHdpZS89wAA8wTTPPTo+vfkaggQY2Dm724pZVkW+1DbVA6VXcRU1cx+/y67L7n2rio9rQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>用 debugger 看也很明顯，所以儘管我們只輸入 URL，也會因為 scope 跟 with 的關係找到 document.URL</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p4-debugger-1920w.webp 1920w, /img/posts/huli/learn-frontend-from-security-pov/p4-debugger-1280w.webp 1280w, /img/posts/huli/learn-frontend-from-security-pov/p4-debugger-840w.webp 840w, /img/posts/huli/learn-frontend-from-security-pov/p4-debugger-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p4-debugger-1920w.jpg 1920w, /img/posts/huli/learn-frontend-from-security-pov/p4-debugger-1280w.jpg 1280w, /img/posts/huli/learn-frontend-from-security-pov/p4-debugger-840w.jpg 840w, /img/posts/huli/learn-frontend-from-security-pov/p4-debugger-320w.jpg 320w" type="image/jpeg"><img alt="" src="/img/posts/huli/learn-frontend-from-security-pov/p4-debugger-1920w.jpg" height="454" width="886" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 886 454'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAIAAACaUPOvAAAACXBIWXMAAAadAAAGnQHoL67mAAAArUlEQVQImRXH23LCIBAAUP7/x/rQp2qnSRPHToOybMJlFwgxKuA4c16OAInDYbjKUSoY/lBp4wLZQD6yi+wCC4KPYD5r/W1taK2rrW+1L8+f2/a174fH41tclQV0Cuw04WKTfJdmE0CTRjI2Cbgc2Z1zUomnGBZ5WRKn27qV8nyrRcwzGmtijPf7nvM6/yNOmi3nnInYOS+cZ+uZQly33XMcx5NGLKW01gCg6/oXqWO3VyDcGzgAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>只差一個字就可以壓在 25 個字以內了，還有其他招式嗎？有，請先看一下底下的程式碼，你預期的輸出是什麼？</p><pre class="language-js"><code class="language-js">name <span class="token operator">=</span> <span class="token number">123</span><br>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> name <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span></code></pre><p>應該是 true 對吧？123 是數字，十分合理啊！但如果你真的在瀏覽器上面執行，會發現輸出居然是 false，因為 <code>typeof name</code> 是 string！</p><p>這是因為 name 是一個特別的屬性，它代表了這個視窗的名稱，或簡單一點也可以想成是這個分頁的名稱，換句話說，同一個分頁儘管內容不同，依然會共享同一個名稱！</p><p>假設我要攻擊的網站是 <a href="http://example.com" rel="noopener noreferrer" target="_blank">example.com</a>，我的網站是 <a href="http://huli.tw" rel="noopener noreferrer" target="_blank">huli.tw</a>，我可以在我的網站底下這樣寫：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"><br>  name <span class="token operator">=</span> <span class="token string">'alert(1)'</span><br>  window<span class="token punctuation">.</span>location <span class="token operator">=</span> <span class="token string">'http://example.com'</span><br></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>設置完 name 以後跳轉過去目標網站，接著在目標網站輸入這組 payload：</p><pre class="language-js"><code class="language-js"><span class="token comment">// 13 + 10 = 23 字</span><br><span class="token operator">&lt;</span>svg<span class="token operator">/</span>onload<span class="token operator">=</span><span class="token function">eval</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">></span></code></pre><p>因為 name 會共享的關係，就可以成功執行我想要的程式碼，這次只要 23 個字，成功壓在 25 個字以內。</p><p>有一個網站叫做 <a href="https://tinyxss.terjanq.me/" rel="noopener noreferrer" target="_blank">Tiny XSS Payloades</a>，專門收集這些很短的 payload，裡面有更多千奇百怪的 payload，有需要的話可以參考看看，我所知道的 payload 也都是從這個網站來的。</p><h2 id="xs-leaks"><a href="#xs-leaks" class="direct-link">#</a> XS leaks</h2><p>上面講完了一些限制的繞過以後，我們來看看另一個主題，叫做 Cross-Site Leaks（簡寫為 XS Leaks），這個攻擊其實就是網頁上的一種 side-channel attack，有關於 side-channel attack，我之前在 <a href="https://blog.huli.tw/2021/02/19/cors-guide-5/" rel="noopener noreferrer" target="_blank">CORS 完全手冊（五）：跨來源的安全性問題</a>裡面有提到過，用很知名的 Spectre 來舉例。</p><p>什麼是 side-channel attack 呢？就是你透過一些方法「間接」得知了資訊，例如說假設你面前有一個燈泡，但你的眼睛完全看不見，連光源都感受不到，你要怎麼知道這個燈泡現在是亮的還是不亮的？</p><p>有一種方式是透過「溫度」，因為燈泡如果亮著會發光，可能會產生熱能（先假設這前提為真然後忽略一些 edge case，舉例用途而已），因此你摸燈泡的時候就感覺得到熱度，這就是透過溫度間接得知了燈泡亮不亮這個資訊。</p><p>把這個概念用在網頁上的話也是類似的，透過一些方法間接得知網頁上的資訊，我們來看兩個例子。</p><h3 id="%E6%90%9C%E5%B0%8B%E8%88%87%E4%B8%8B%E8%BC%89"><a href="#%E6%90%9C%E5%B0%8B%E8%88%87%E4%B8%8B%E8%BC%89" class="direct-link">#</a> 搜尋與下載</h3><p>假設現在有一個具有搜尋與下載功能的網站，可以在 query string 直接帶入想要搜尋的字串，例如說 <code>https://example.com/download?q=example</code>，如果資料庫裡面沒有符合的資料，就會出現一個「查無使用者」的畫面：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p5-search1-1920w.webp 1920w, /img/posts/huli/learn-frontend-from-security-pov/p5-search1-1280w.webp 1280w, /img/posts/huli/learn-frontend-from-security-pov/p5-search1-840w.webp 840w, /img/posts/huli/learn-frontend-from-security-pov/p5-search1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p5-search1-1920w.png 1920w, /img/posts/huli/learn-frontend-from-security-pov/p5-search1-1280w.png 1280w, /img/posts/huli/learn-frontend-from-security-pov/p5-search1-840w.png 840w, /img/posts/huli/learn-frontend-from-security-pov/p5-search1-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/learn-frontend-from-security-pov/p5-search1-1920w.png" height="1560" width="2788" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2788 1560'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA0UlEQVQImVXKsUrDUABA0fctEgv+QUOcHFrNq3sg8p4kv9KAg41TplApIi4aalE6KIImU0jaDNLWQeiSuV8g3NIuweUOlyOEEFiWhed5aKVQSnGpNa7rIqXEMAx2RuwSxzFlWZLnOeW8YjavSNN0/3zfb2AURaRZxqwoWC8X/C6++VmtqOv6Pwz6fcaTCQ+3Q5KrgMfwmrvRiKckwXGcBg7CG77epoTjDPP1j/OXDffPUz4/3lFaN7DdNunZZxx3JAfdC466DiedU3rS5rDV2sMtYgCJWCBwlHkAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>反之，如果有資料的話，就會直接跳出原生的檔案下載視窗，讓你直接下載相對應的檔案：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p6-search2-1920w.webp 1920w, /img/posts/huli/learn-frontend-from-security-pov/p6-search2-1280w.webp 1280w, /img/posts/huli/learn-frontend-from-security-pov/p6-search2-840w.webp 840w, /img/posts/huli/learn-frontend-from-security-pov/p6-search2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p6-search2-1920w.png 1920w, /img/posts/huli/learn-frontend-from-security-pov/p6-search2-1280w.png 1280w, /img/posts/huli/learn-frontend-from-security-pov/p6-search2-840w.png 840w, /img/posts/huli/learn-frontend-from-security-pov/p6-search2-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/learn-frontend-from-security-pov/p6-search2-1920w.png" height="1452" width="2404" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2404 1452'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAp0lEQVQImV3NwQmDQBCF4fUiHtTubMAGhAQ3rLETFW/eFcSLkFRgGWIHirvwB9eEhDx4zMB8MMJ1XeI4Js9zpLyRXCRXqUhTiVKKKIpwHAcRBAHTNHHEGGPnb4ZhOGEYhozjyLIsrOtqsdGafd8t7PseIQTC9326rmOeZ7ZtQ2tt+4FN03xfPx8P9Pvwn7ZtT+h5HvcsoygKyrKkqirbY6/rmiRJLHwBtrOsr+ekUUQAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>身為一個攻擊者，我們知道這個資訊以後可以做些什麼呢？</p><p>假設我有一個自己的網站，網址是 <code>https://huli.tw</code>，接著我在我的網站上面把剛剛的範例網站用 iframe 嵌入：</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><br>iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">"https://example.com/download?q=user01"</span><br>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span></code></pre><p>這時候關鍵的來了，如果 <code>user01</code> 這筆資料不存在於資料庫裡面，當我試著存取 <code>iframe.contentWindow.origin</code> 的時候就會出錯，這是因為 <code>huli.tw</code> 跟 <code>example.com</code> 不是同源的網站，所以被瀏覽器的 Same-Origin Policy 擋了下來。</p><p>但是呢！如果 <code>user01</code> 這筆資料存在於資料庫裡面，不是就會直接跳出下載畫面嗎？這時候如果我去存取 <code>iframe.contentWindow.origin</code>，就不會出錯，因為我會拿到 <code>null</code> 這個結果。</p><p>所以我們可以根據存取 <code>iframe.contentWindow.origin</code> 的結果，得知某個關鍵字是否存在於資料庫裡面：</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><br>iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">"https://example.com/download?q=user01"</span><br>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span><br><br><span class="token comment">// 先假設一秒後會載入完畢，可以做到更精確但先跳過</span><br><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">try</span> <span class="token punctuation">{</span><br>        iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>origin<br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'使用者存在'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'使用者不存在'</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span></code></pre><p>這就是 XS leaks，我們明明在 A 網站，卻可以利用一些技巧去得知 B 網站的資訊。</p><p>完整的攻擊實作會把上面的攻擊腳本延伸，例如說先測 <code>a</code> 再測 <code>b</code> 之類的，假設測到 <code>b</code> 是存在的，那就重複剛剛的流程去測 <code>ba</code>, <code>bb</code>...，如此一來就可以洩漏出至少一組的使用者帳號。接著只要把這個網頁的連結傳給有權限存取到 <code>https://example.com/download</code> 頁面而且處於登入狀態下的人，點開以後攻擊就會啟動。</p><p>雖然說聽起來前置步驟有點多，但它確實是個可行的攻擊手法。</p><h3 id="id-%E7%9A%84%E5%A5%A7%E5%A6%99"><a href="#id-%E7%9A%84%E5%A5%A7%E5%A6%99" class="direct-link">#</a> id 的奧妙</h3><p>假設現在有個標榜隱私度極高的社群網站，你沒有辦法看到你好友的好友有誰，看不到共同好友，所以你也不知道誰跟誰是朋友，只知道自己有哪些朋友。</p><p>你跟 user id 是 123 的 David 是好朋友，所以當你點進他的個人頁面：<a href="http://example.com/users/123" rel="noopener noreferrer" target="_blank">http://example.com/users/123</a> 時，會看到一個按鈕「傳送訊息」，按鈕的 id 是 message：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p7-id1-1920w.webp 1920w, /img/posts/huli/learn-frontend-from-security-pov/p7-id1-1280w.webp 1280w, /img/posts/huli/learn-frontend-from-security-pov/p7-id1-840w.webp 840w, /img/posts/huli/learn-frontend-from-security-pov/p7-id1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p7-id1-1920w.png 1920w, /img/posts/huli/learn-frontend-from-security-pov/p7-id1-1280w.png 1280w, /img/posts/huli/learn-frontend-from-security-pov/p7-id1-840w.png 840w, /img/posts/huli/learn-frontend-from-security-pov/p7-id1-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/learn-frontend-from-security-pov/p7-id1-1920w.png" height="1480" width="2140" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2140 1480'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAyUlEQVQImU3NMWrCUACA4dwmJ8iQA5QsgWzdEkOLlodSDNIWTActIdC1k1up7ynRJPr6FDpU4wV06drD/IUitOMPH/yW67q0oojWVUwvajNwLxHtG8IoJI5jbNvGSpKE/eeOeqP5eJlxunjmfV6x0muapsH3fSwhBFprlFIUdYneGObL4reNMXie9w9JhX4t2MoKPV2gpPxDSb/P7rDHyJKvcMJ3543j9YR1vaI5nHdBEJBlGY/DlHH3nidxx+j2gTRNyfMcx3H4AVYUiwObYQqxAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>而你跟 user id 是 210 的 Peter 並不是好友，所以點進他的頁面以後，會看到另一個按鈕叫做「加入好友」，id 是 add：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p8-id2-1920w.webp 1920w, /img/posts/huli/learn-frontend-from-security-pov/p8-id2-1280w.webp 1280w, /img/posts/huli/learn-frontend-from-security-pov/p8-id2-840w.webp 840w, /img/posts/huli/learn-frontend-from-security-pov/p8-id2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/huli/learn-frontend-from-security-pov/p8-id2-1920w.png 1920w, /img/posts/huli/learn-frontend-from-security-pov/p8-id2-1280w.png 1280w, /img/posts/huli/learn-frontend-from-security-pov/p8-id2-840w.png 840w, /img/posts/huli/learn-frontend-from-security-pov/p8-id2-320w.png 320w" type="image/png"><img alt="" src="/img/posts/huli/learn-frontend-from-security-pov/p8-id2-1920w.png" height="1480" width="2102" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2102 1480'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAxUlEQVQImSXLTU6DQACG4TkUIXHnEUhQFw7GJjRAEewJ7KrYHaUuG3fS8qMlw6QrO3gCde1tXiMunzffJyzLwpOSa08STabMzy6Ibn3kjYeUEtu2EXEc8zEMHLTi+Fzzdb7iuK1GD8aQpinC9336vqcsS+q2QXeKqm1GK6UIguB/pLUeY/OyR7UH3nb16L9zGIaIWTTjZAxd/crn5YYfueX76omuank3J5IkQTiOQ1EUZMuMfL4gv3sgv1/wuMxYF2tc1+UXk4SMxqi8sWkAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>這聽起來都沒什麼問題，十分合理的實作，網頁上的元素有 id 再合理不過了。不過，其實這樣也會有 XS leaks 的風險。</p><p>瀏覽器有一個貼心的功能不知道大家有沒有注意過，當網址後面加上 <code>#id</code> 的時候，瀏覽器會自動跳到有這個 id 的段落然後把元素 focus（如果可以被 focus 的話），文章的錨點（anchor）功能就是靠這個，才能跳到特定的段落去。</p><p>因此當我連到 <a href="http://example.com/users/123#message" rel="noopener noreferrer" target="_blank">http://example.com/users/123#message</a> 時，如果我跟 id 為 123 的人是好友，那頁面上就會出現傳送訊息的按鈕，瀏覽器就會跳到按鈕那邊並且把按鈕 focus。那如果我跟 123 不是好友呢？那就不會有任何事情發生。所以我們可以透過這個差異，來知道 id 123 的人是不是當前使用者的好友。</p><p>做法跟剛剛的搜尋下載很像，都是要先把目標網頁嵌入 iframe 之中，如果有這個 id 存在，那 iframe 就會 focus，而原本的 body 就會 blur：</p><pre class="language-js"><code class="language-js">window<span class="token punctuation">.</span><span class="token function function-variable">onblur</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'是好友'</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><br>iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'https://example.com/users/123#message'</span><br>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span></code></pre><p>接著把這個網頁傳給你想知道他好友狀況的人，他一打開網頁之後，你就能知道他跟 123 是不是好朋友。如果這個網站的 id 是流水號，你就可以遍歷每一個 id，得知他的好友清單裡面有誰。</p><p>以上就是兩個 XS leaks 的範例，都是透過一些瀏覽器或是 JS 的特性來達成的攻擊，如果你對這些有興趣，可以參考：<a href="https://xsleaks.dev/" rel="noopener noreferrer" target="_blank">XS-Leaks Wiki</a>，裡面有更多更有趣的案例（我所知道的這些也是從這個網站來的）</p><p>如果想看 XS leaks 的實際案例，這邊有很多：<a href="https://terjanq.github.io/Bug-Bounty/Google/cache-attack-06jd2d2mz2r0/index.html" rel="noopener noreferrer" target="_blank">Mass XS-Search using Cache Attack</a>，而最近的這一個也很有趣：<a href="https://jub0bs.com/posts/2021-10-12-xsleak-stack/" rel="noopener noreferrer" target="_blank">Abusing Slack’s file-sharing functionality to de-anonymise fellow workspace members</a></p><h2 id="%E5%85%B6%E4%BB%96%E4%BD%A0%E5%8F%AF%E8%83%BD%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84%E5%8A%9F%E8%83%BD"><a href="#%E5%85%B6%E4%BB%96%E4%BD%A0%E5%8F%AF%E8%83%BD%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84%E5%8A%9F%E8%83%BD" class="direct-link">#</a> 其他你可能不知道的功能</h2><p>最後一個段落裡面想跟大家分享一些「你可能不知道」的功能，或更精確一點來說，是「我知道以後很驚訝」的功能，我原本沒有想到原來可以這樣做。</p><h3 id="%E8%AE%80%E5%8F%96%E4%B8%8D%E5%90%8C-path-%E7%9A%84-cookie"><a href="#%E8%AE%80%E5%8F%96%E4%B8%8D%E5%90%8C-path-%E7%9A%84-cookie" class="direct-link">#</a> 讀取不同 path 的 cookie</h3><p>在設定 Cookie 的時候有許多參數可以設置，其中一個叫做 path，例如說我設定 cookie 的 path 是 <code>/siteA</code>，那當我在 <code>/siteB</code> 的時候，就沒辦法讀取到 <code>/siteA</code> 的 cookie，因為 path 不一樣，所以沒辦法拿到。</p><p>但其實不一定，如果你的網站沒有阻擋 iframe 嵌入，而且 cookie 又沒有設置 HttpOnly，就可以利用 iframe 來讀取不同 path 的 cookie：</p><pre class="language-js"><code class="language-js"><span class="token comment">// 假設我們在 https://example.com/siteA</span><br><span class="token keyword">const</span> iframe <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'iframe'</span><span class="token punctuation">)</span><br>iframe<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'https://example.com/siteB'</span><br>iframe<span class="token punctuation">.</span><span class="token function function-variable">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <br>  <span class="token function">alert</span><span class="token punctuation">(</span>iframe<span class="token punctuation">.</span>contentWindow<span class="token punctuation">.</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>iframe<span class="token punctuation">)</span></code></pre><p>這是因為 <code>https://example.com/siteA</code> 跟 <code>https://example.com/siteB</code> 雖然 path 不同，但是是同源的，因此可以直接透過 iframe 來存取同源的其他網頁的 document，就可以利用這個特性拿到 <code>document.cookie</code></p><p>如果沒有支援 iframe，那其實 <code>window.open</code> 也可以達到一樣的效果：</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> win <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'//example.com/siteB'</span><span class="token punctuation">)</span><br><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">alert</span><span class="token punctuation">(</span>win<span class="token punctuation">.</span>document<span class="token punctuation">.</span>cookie<span class="token punctuation">)</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span></code></pre><p>不過要注意的是 <code>window.open</code> 預設會被擋住，要使用者主動允許才能開啟，或者是要使用者做操作以後執行（例如說把上面那段放在 button onclick 裡面）。</p><p>而我後來發現其實 <a href="https://datatracker.ietf.org/doc/html/rfc6265#section-8.5" rel="noopener noreferrer" target="_blank">RFC 6265</a> 的 section 8.5: Weak Confidentiality 就有提到了（奇怪，以前讀的時候怎麼沒注意到）：</p><blockquote><p>Cookies do not always provide isolation by path. Although the network-level protocol does not send cookies stored for one path to another, some user agents expose cookies via non-HTTP APIs, such as HTML's document.cookie API. Because some of these user agents (e.g., web browsers) do not isolate resources received from different paths, a resource retrieved from one path might be able to access cookies stored for another path.</p></blockquote><h3 id="%E8%AE%80%E5%8F%96-pdf-%E5%85%A7%E5%AE%B9"><a href="#%E8%AE%80%E5%8F%96-pdf-%E5%85%A7%E5%AE%B9" class="direct-link">#</a> 讀取 PDF 內容</h3><p>假設你的網站上嵌入了一個 same origin 的 pdf 檔案，像這樣：</p><pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>embed</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/test.pdf<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></code></pre><p>這時候你該怎麼用 JS 去讀取這個 pdf 裡面的內容？想必答案一定就是 fetch 或是 xhr 了：</p><pre class="language-js"><code class="language-js"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/test.pdf"</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> res<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'pdf'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>那如果 fetch 沒辦法用呢？舉例來說，server 在後端擋住來自 fetch 的請求（利用 <a href="https://web.dev/fetch-metadata/" rel="noopener noreferrer" target="_blank">Fetch Metadata</a>），這時候該怎麼辦呢？有沒有什麼方法可以讀到 PDF 的內容？</p><p>我以前一直覺得不可能有，直到我學到了一個隱藏的 <a href="https://source.chromium.org/chromium/chromium/src/+/master:chrome/browser/resources/pdf/pdf_viewer.js;l=770" rel="noopener noreferrer" target="_blank">Chrome API</a>：</p><pre class="language-js"><code class="language-js"><span class="token comment">/** @override */</span><br><span class="token function">handleScriptingMessage</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">handleScriptingMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">delayScriptingMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">case</span> <span class="token string">'getSelectedText'</span><span class="token operator">:</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>pluginController_<span class="token punctuation">.</span><span class="token function">getSelectedText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><br>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleSelectedTextReply</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">break</span><span class="token punctuation">;</span><br>    <span class="token keyword">case</span> <span class="token string">'getThumbnail'</span><span class="token operator">:</span><br>      <span class="token keyword">const</span> getThumbnailData <span class="token operator">=</span><br>          <span class="token comment">/** @type {GetThumbnailMessageData} */</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">const</span> page <span class="token operator">=</span> getThumbnailData<span class="token punctuation">.</span>page<span class="token punctuation">;</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>pluginController_<span class="token punctuation">.</span><span class="token function">requestThumbnail</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><br>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendScriptingMessage</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">break</span><span class="token punctuation">;</span><br>    <span class="token keyword">case</span> <span class="token string">'print'</span><span class="token operator">:</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>pluginController_<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">break</span><span class="token punctuation">;</span><br>    <span class="token keyword">case</span> <span class="token string">'selectAll'</span><span class="token operator">:</span><br>      <span class="token keyword">this</span><span class="token punctuation">.</span>pluginController_<span class="token punctuation">.</span><span class="token function">selectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">break</span><span class="token punctuation">;</span><br>    <span class="token keyword">default</span><span class="token operator">:</span><br>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>從這段程式碼裡面可以看出有兩個指令 <code>selectAll</code> 跟 <code>getSelectedText</code>，前者可以全選 PDF 的內容，後者可以拿到選取的文字，因此只要結合這兩個，就能拿到 PDF 裡面的文字內容：</p><pre class="language-js"><code class="language-js"><span class="token comment">// HTML: &lt;embed id="f" onload="loaded()" src="..."></span><br><br>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'getSelectedTextReply'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token function">alert</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>selectedText<span class="token punctuation">)</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><br><br><span class="token keyword">function</span> <span class="token function">loaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  f<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span><span class="token string">'selectAll'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><br>  f<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span><span class="token string">'getSelectedText'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>一個簡單的 demo 網頁：<a href="https://aszx87410.github.io/demo/mw2021/05-pdf/index.html" rel="noopener noreferrer" target="_blank">https://aszx87410.github.io/demo/mw2021/05-pdf/index.html</a></p><p>雖然說這個技巧只能用在文字上面，但這種隱藏的功能真是令人興奮。</p><h2 id="%E7%B5%90%E8%AA%9E"><a href="#%E7%B5%90%E8%AA%9E" class="direct-link">#</a> 結語</h2><p>先補充一下，上述的有些攻擊並不是所有環境都適用，例如說有些攻擊需要網站沒有擋 iframe，而拿來身份驗證的 cookie 可能也不能設定 SameSite，否則就會失效，利用 name 來傳 payload 的方法在某些瀏覽器可能也不適用，但我覺得這都不影響這些攻擊的有趣程度。</p><p>文章中有些繞過的部分並沒有寫得很完整，因為我把重點放在「找到至少一種繞過方式」，而不是「寫出所有繞過方式」，想看更完整的繞過技巧可以參考：<a href="https://netsec.expert/posts/xss-in-2021/" rel="noopener noreferrer" target="_blank">Cheatsheet: XSS that works in 2021</a>。</p><p>這篇文章提到的許多技巧，都是我透過打 CTF 學習而來，例如說下載檔案的 XS leaks 從 <a href="https://github.com/aszx87410/ctf-writeups/issues/25" rel="noopener noreferrer" target="_blank">LINE CTF 2021 - Your Note</a>，讀取不同 path 的 cookie 是從 <a href="https://github.com/aszx87410/ctf-writeups/issues/19" rel="noopener noreferrer" target="_blank">DiceCTF 2021 - Web IDE</a> 學到的，Chrome 的隱藏 API 則是在 <a href="https://github.com/aszx87410/ctf-writeups/issues/23" rel="noopener noreferrer" target="_blank">zer0pts CTF 2021 - PDF Generator</a> 學習到的技巧，透過 CTF 讓我看見了不一樣的 Web。</p><p>以上就是我近期學習到的一些與前端相關的知識，每一個都超出了我的想像，希望這篇文章有讓大家感受到我當初的驚訝，覺得：「哇，原來前端還有這些東西，我怎麼都不知道」。</p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/huli/learn-frontend-from-security-pov/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/front-end/" class="post-tag">#Front-end</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/huli/xss-history/">XSS 從頭談起：歷史與由來</a></li><li><a href="/posts/crystal/email-sec-settings-dkimdmarc/">關於 email security 的大小事 — 設定篇 DKIM、DMARC</a></li><li><a href="/posts/crystal/email-sec-theory/">關於 email security 的大小事 — 原理篇</a></li><li><a href="/posts/jo/zerobased-secure-samesite-httponly/">零基礎資安系列（三）-網站安全三本柱（Secure & SameSite & HttpOnly）</a></li><li><a href="/posts/maxchiu/aop/">來談談 AOP (Aspect-Oriented Programming) 的精神與各種主流實現模式的差異</a></li></ol></div><div class="article-author"><img alt="huli" src="/img/authors/huli_logo.jpg" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/huli">huli</a></div><div class="article-author__intro">Act as a bridge between Front-end and Security world</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"接觸資安才發現我不懂前端","image":["https://tech-blog.cymetrics.io/img/posts/huli/learn-frontend-from-security-pov/p1-ice-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/huli/learn-frontend-from-security-pov/p2-explosion-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/huli/learn-frontend-from-security-pov/p3-spec-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/huli/learn-frontend-from-security-pov/p4-debugger-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/huli/learn-frontend-from-security-pov/p5-search1-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/learn-frontend-from-security-pov/p6-search2-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/learn-frontend-from-security-pov/p7-id1-1920w.png","https://tech-blog.cymetrics.io/img/posts/huli/learn-frontend-from-security-pov/p8-id2-1920w.png","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/huli_logo.jpg"],"author":{"@type":"Person","name":"huli"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/huli/learn-frontend-from-security-pov/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/huli/learn-frontend-from-security-pov/","datePublished":"2021-10-25","dateModified":"2023-06-16","description":"此文章是我在 Modern Web 2021 的分享：《接觸資安才發現前端的水真深》的文字版，當時的演講影片尚未釋出，想看簡報的話在這邊：slides..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a>. <a href="https://oneinfinity.global/" rel="noopener noreferrer" target="_blank">OneInfinity</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>