<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>隱藏在 React 下的機制： Fiber</title><meta content="隱藏在 React 下的機制： Fiber" property="og:title"><meta content="隱藏在 React 下的機制： Fiber" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="在尚未使用 Fiber 前，由於畫面更新前須由 reconciler ( React ) 調度完後才會送到 renderer，且當畫面複雜時，更動一個 state 狀態時也需要將底下的所有子元件重新 render 出一份 virtual dom，而在過去這個部分全部只由一個主線程去做同步式渲染，因此當有一個 Component 需要費時較多時間時，將會把主線程 block，當時間一長，就有可能導致來不及更新至指定時間範圍內，造成無法順利渲染，會有不順暢的情況發生。" name="description"><meta content="在尚未使用 Fiber 前，由於畫面更新前須由 reconciler ( React ) 調度完後才會送到 renderer，且當畫面複雜時，更動一個 state 狀態時也需要將底下的所有子元件重新 render 出一份 virtual dom，而在過去這個部分全部只由一個主線程去做同步式渲染，因此當有一個 Component 需要費時較多時間時，將會把主線程 block，當時間一長，就有可能導致來不及更新至指定時間範圍內，造成無法順利渲染，會有不順暢的情況發生。" name="twitter:description"><meta content="在尚未使用 Fiber 前，由於畫面更新前須由 reconciler ( React ) 調度完後才會送到 renderer，且當畫面複雜時，更動一個 state 狀態時也需要將底下的所有子元件重新 render 出一份 virtual dom，而在過去這個部分全部只由一個主線程去做同步式渲染，因此當有一個 Component 需要費時較多時間時，將會把主線程 block，當時間一長，就有可能導致來不及更新至指定時間範圍內，造成無法順利渲染，會有不順暢的情況發生。" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/" property="og:url"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p1.png" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p1.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><link href="https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/" rel="canonical"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,ol,p,pre,ul{font-size:1em}ol,p,pre,ul{margin-bottom:1.5em}body,ol,p,pre,ul{font-size:1rem;line-height:1.6}ol,p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,ol,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}body,ol,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}article,header,img,video{max-width:100%;margin:0 auto}img,video{height:auto}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{width:42.5em}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol,li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.tag{color:#e2777a}.token.function,.token.number{color:#f08d49}.token.property{color:#f8c555}.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a> <a href="/en">English</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">隱藏在 React 下的機制： Fiber</h1><aside class="w-full"><div class="post-tags"><a href="/tags/front-end/" class="post-tag">#Front-end</a></div><div class="post-avatar"><img alt="ming-you-tsai" src="/img/authors/mingyou_avatar.jpeg" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/mingyou">ming-you-tsai</a></div><div class="post-avatar__time">28 May 2021</div></div></div><div class="notice-block" data-nosnippet="">我們正在尋找一位 Security Engineer 加入我們的團隊，詳情請參考<a href="https://github.com/cymetrics/blog/issues/13" rel="noopener noreferrer" target="_blank">職缺資訊</a></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>不知不覺都 2021 年中了，從 React 16.3 的重大更新後也已經過了兩年多了，不知到大家還記不記得當時的兩大重要功能，其一為 Function Component ( hooks )，另一個大家比較不那麼熟悉但卻也很重要的則應該屬 Fiber 架構，但其實會有 hook 的設計也是也是因為上述架構的關係。</p><p>在當時引想大家最多的應該屬生命週期的變換，不曉得大家是否還記得當時最常用到的生命週期 <code>componentWillUpdate</code>/<code>componentWillReceiveProps</code> 將被廢除時驚訝的心情? 而當時也加入了兩個新的 lifecycle 來解決以上問題。</p><ul><li>getDerivedStateFromProps</li><li>getSnapshotBeforeUpdate</li></ul><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p1-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-840w.webp 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p1-1920w.png 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-1280w.png 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-840w.png 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-320w.png 320w" type="image/png"><img alt="Re: React 常用的生命週期(1)" src="/img/posts/mingyou/deep-dive-into-react-fiber/p1-1920w.png" height="1215" width="1737" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1737 1215'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmUlEQVQImR3OQY7DIBBEUV8icgxNA93gYJssRiPN/W/2R/aipFo8lWp5rcK6KaLGFgvVB22/ni7qbDGz3CikRp9/qJ1Yv3OhpWNtPHCxdpBtEMtA/UsZv4hNJO8kdYJUlpgqkjuxHKiffK4f/DNJpT0rDzI/qN7xltl7YZ6VeRaSJoJW3venW4ZUUDPeokg1YqmsIaHmbJL5Bxf5So+Qi81WAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><a href="https://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/" rel="noopener noreferrer" target="_blank">https://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/</a></p><p>至於為什麼會產生以下的變化呢？這就要說說本次的主題 Fiber 了。</p><h2 id="fiber-%E6%98%AF%E4%BB%80%E9%BA%BC"><a href="#fiber-%E6%98%AF%E4%BB%80%E9%BA%BC" class="direct-link">#</a> Fiber 是什麼</h2><p>Fiber 屬於更為底層的抽象行為，目的是為了達到以下幾種功能</p><ul><li>幫不同類型的工作分配優先順序</li><li>暫停工作，稍後回來</li><li>當不需要工作時取消</li><li>重新使用已經完成的工作</li></ul><p>在尚未使用 Fiber 前，由於畫面更新前須由 reconciler ( React ) 調度完後才會送到 renderer，且當畫面複雜時，更動一個 state 狀態時也需要將底下的所有子元件重新 render 出一份 virtual dom，而在過去這個部分全部只由一個主線程去做同步式渲染，因此當有一個 Component 需要費時較多時間時，將會把主線程 block，當時間一長，就有可能導致來不及更新至指定時間範圍內，造成無法順利渲染，會有不順暢的情況發生。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p2-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-840w.webp 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p2-1920w.png 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-1280w.png 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-840w.png 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-320w.png 320w" type="image/png"><img alt="Re: sync mode 和 async mode 的差異" src="/img/posts/mingyou/deep-dive-into-react-fiber/p2-1920w.png" height="768" width="1024" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1024 768'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyklEQVQYlS2OTUvEMBiE+1fEfm1i1ebN27TJ6qoryILgZS8LgggqrCDowYN48pc/kuphYAYeZqaojdBaT2M8dZb915yFxnqKbHoJeE2IJFyInMiEOfI0VmawOGiEu9slP+/XfO0v+H694vMl8rE7J60SZYbMccANS0Qjfkg4nXB+wkmk68e/ubL1bDZnvD2v2T9e8rSL3G+Vh23gZlhRWaWojNCdKhpGwhiZYmIYJ3pRYlzT9ZEi11UL4bDNJ5XaKpVRylYoF24+/gtOoWffOGowHAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><a href="https://twitter.com/acdlite/status/977291318324948992" rel="noopener noreferrer" target="_blank">https://twitter.com/acdlite/status/977291318324948992</a></p><h2 id="fiber-%E7%9A%84%E7%94%A2%E7%94%9F%E5%8F%8A%E4%BD%9C%E7%94%A8"><a href="#fiber-%E7%9A%84%E7%94%A2%E7%94%9F%E5%8F%8A%E4%BD%9C%E7%94%A8" class="direct-link">#</a> Fiber 的產生及作用</h2><p>為了解決此問題，React 制定了 fiber 的結構，利用非同步的渲染方式來解決，將各元件拆解，也避免了長時間占用主線程所導致卡頓的問題。 ( 所使用的 <a href="https://developer.mozilla.org/zh-TW/docs/Web/API/Window/requestIdleCallback" rel="noopener noreferrer" target="_blank">API</a>， <a href="https://github.com/facebook/react/blob/4c7036e807fa18a3e21a5182983c7c0f05c5936e/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1541" rel="noopener noreferrer" target="_blank">source code</a> )</p><p>傳統 React 更新時會分成兩個時期</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p3-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-840w.webp 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p3-1920w.png 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-1280w.png 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-840w.png 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-320w.png 320w" type="image/png"><img alt="Re: React 更新時期" src="/img/posts/mingyou/deep-dive-into-react-fiber/p3-1920w.png" height="740" width="1202" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1202 740'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnElEQVQImTWO2Y7CMAxF+/8/OBJC84BAiKW0TZPYcZaD8DB+uLLvJk+tD05z5Oe68tiF/zkvybkg5vfUxyBrJWRDrcGAkAvXNbGLIV9uWpLS+8BqJ2r1tJTKlo1byGy5fI1Z+X1svFLheHmiUrzp9Ioc7oFU6p9Ra+O5C7UNbnOgqrkY1Zhjca21zsQYnqB/AN+LNUJWlihEMX/tDdfD6Ts9+mnDAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><ul><li>reconciliation / render 階段 ( 判斷哪先元件需要更新，可中斷 )</li><li>commit 階段 ( 插入、移動、刪除節點，不可中斷 )</li></ul><p>reconciliation phase 會先通過 render 更新元件，在第一次實建立 Fiber 節點，並在之後更新與上一次所渲染的 DOM 比較，因此在 render 階段將執行以下生命週期方法判斷是否有更新：</p><ul><li>componentWillMount (已廢棄)</li><li>componentWillReceiveProps (已廢棄)</li><li>componentWillUpdate (已廢棄)</li><li>getDerivedStateFromProps</li><li>shouldComponentUpdate</li></ul><p>react 可以根據目前的狀況調整，可以選擇一次處理單個或者多個 fiber 並且調整優先權，因此可以異步執行及中斷，但也因為如此，內部的邏輯必須避免 side effect。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p4-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-840w.webp 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p4-1920w.png 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-1280w.png 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-840w.png 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-320w.png 320w" type="image/png"><img alt="Re: Commit phrase 和 render phrase" src="/img/posts/mingyou/deep-dive-into-react-fiber/p4-1920w.png" height="768" width="1024" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1024 768'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAuElEQVQYlTWP227CMBBE/SkVys0mCSG+5SZZpFCgaR9a8f+/ciq78DA72p2VZkYUSiMbg2osMqL956o2lHtD1EUcqrWUaqSQA1njydTAW6HZyT49iqzSTLPh8W352Sy/25M/HeG4kEmNyKXBT4772XE7e24Xz8e747p65n4hj3Z1N3LdHhx0oNOBKWyU9cjRryzrnYOeEVVt6cySgtshcLp8oX2g3MdCjqin4LnsU4t4bPspCXF/4Q+0d2UW4YzGcAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>在 render 階段執行完後將會產生包含著 side effect 的 fiber 節點樹，而 side effect 事實上就是 commit 階段所需要更新操作，會在執行 commit 階段時輪詢 side effect 列表去對 DOM 進行修改。</p><p>以下是commit階段執行的生命週期方法列表：</p><ul><li>getSnapshotBeforeUpdate</li><li>componentDidMount</li><li>componentDidUpdate</li><li>componentWillUnmount</li></ul><p>因為這些方法在同步commit階段執行，所以它們可能包含副作用或更動 DOM。</p><p>而前面說到被廢除的兩個 lifecycle 因為是屬於 render phase，有機會被多次執行，為了避免 side effect 發生，才會移除此 lifecycle。</p><ul><li><code>componentWillUpdate</code></li><li><code>componentWillReceiveProps</code></li></ul><p>而拿掉以上 API 後則利用 <code>getDerivedStateFromProps</code> 來取代 <code>componentWillReceiveProps</code>，但由於 <code>getDerivedStateFromProps</code> 被設計成靜態函數，不用擔心 side effect 所帶來的影響，不過要避免從 props 等等去觸發 side effect。</p><h2 id="fiber-nodes-%E5%92%8C-fiber-tree"><a href="#fiber-nodes-%E5%92%8C-fiber-tree" class="direct-link">#</a> Fiber nodes 和 Fiber tree</h2><p>在 reconciliation 時，每個 component 的 render 方法回傳的資料都會合併到 Fiber tree 中，每個React元素都有一個對應的 Fiber nodes，用來記錄對應的工作內容，而特別的地方在於在每次 render 時不會重新產生 Fiber node。</p><p>更確切的說，每個 Fiber 就是一個 worker ，提供了跟踪，調度，暫停和中止工作的方法。</p><p>每一個 Fiber Node 節點與 Virtual Dom 對應，所有 Fiber Node 連接起來形成 Fiber tree，為單向連結串列的樹狀結構：<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p5-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-840w.webp 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p5-1920w.png 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-1280w.png 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-840w.png 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-320w.png 320w" type="image/png"><img alt="Re: Fiber tree" src="/img/posts/mingyou/deep-dive-into-react-fiber/p5-1920w.png" height="1120" width="1562" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1562 1120'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA50lEQVQYlT2NsU7DMBiEfzpQCZaoiG5OY/+yQtsnQGJBbBU8AVMWIj9AhkphZYKVl8jCRFsWJuA9smWILVlRhgwccgWcdLrluzuiPx0e09fnx2gYBrLWXjjnHgBQlmVER7/MaDze5263Je/9Zdu2zwEKpnm6fNfMr0KITRzHmyiKtkVRPAEoQxfAAZ2lcywWSzAzpJSYTE5gjHkD8Pi/xFpDKfWtmKE1Yzo9RZ7nLwBMXddZ13W3lEh5I2KxmiXJKk31NRFdVVWV931/3zTN2lq7JsVMM5nsM6gsy3Bx7pwrvPd33nvzA6Urb/B4+Y2qAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>主要是為了將原本的樹狀遞迴輪詢轉變成循環輪詢，配合 requestIdleCallback API, 實現任務拆分、中斷與恢復。</p><p>大概結構如下：</p><pre class="language-js"><code class="language-js">type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token comment">// 標籤類型</span><br>  tag<span class="token operator">:</span> TypeOfWork<span class="token punctuation">,</span><br><br>  key<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span><br><br>  <span class="token comment">// 與 Fiber 所關聯的類型</span><br>  type<span class="token operator">:</span> any<span class="token punctuation">,</span><br><br>  <span class="token comment">// local 狀態</span><br>  stateNode<span class="token operator">:</span> any<span class="token punctuation">,</span><br><br>  <span class="token comment">// 以下區塊負責處理 Fiber</span><br><br>  <span class="token keyword">return</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// 單向連結串列結構</span><br>  child<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  sibling<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  index<span class="token operator">:</span> number<span class="token punctuation">,</span><br><br>  <span class="token operator">...</span><br><br><br>  <span class="token comment">// 輸出用的狀態</span><br>  memoizedState<span class="token operator">:</span> any<span class="token punctuation">,</span><br><br>  <span class="token operator">...</span><br><br>  <span class="token comment">// 紀錄在單向鏈結串列中的下一個 Fiber </span><br>  nextEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// 子樹中具有 side effect 的第一個和最後一個光纖</span><br>  <span class="token comment">// 當我們重用已完成的工作時，我們重用 link list 的一部分</span><br>  firstEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  lastEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// 快速確定子樹是否沒有正在等待的更動</span><br>  pendingWorkPriority<span class="token operator">:</span> PriorityLevel<span class="token punctuation">,</span><br><br><br>  <span class="token comment">// 如果工作在光纖上進行，而該光纖已經在較低的優先權開始了一部分工作</span><br>  <span class="token comment">// 那麼我們需要將已完成的工作儲存著。直到我們需要重新開始處理它為止</span><br>  <span class="token comment">// 它可能與 "目前" 的 child 不同。</span><br>  progressedChild<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><br>  <span class="token operator">...</span><br><span class="token punctuation">}</span></code></pre><p>在這結構中，nextEffect / firstEffect / lastEffect 將在後面的章節 ( Effect List ) 中表現出相當的重要性。</p><h2 id="workinprogress-tree"><a href="#workinprogress-tree" class="direct-link">#</a> workInProgress tree</h2><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> <span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <br>    <span class="token keyword">let</span> workInProgress <span class="token operator">=</span> current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        workInProgress <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token operator">...</span><br>    workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> current<span class="token punctuation">;</span><br>    current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span><br>    <span class="token operator">...</span><br>    <span class="token keyword">return</span> workInProgress<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p><a href="https://github.com/facebook/react/blob/4c7036e807/packages/react-reconciler/src/ReactFiber.new.js#L254" rel="noopener noreferrer" target="_blank">source code</a></p><p>React 在第一次 render 時會將各節點紀錄為 Fiber Tree，而在之後檢查時會建立一個 workInProgress tree ，等待 workInProgress tree 完成後就會被當作 current tree，而此稱為<code>雙緩衝技術</code> (double buffering)。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p6-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-840w.webp 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p6-1920w.png 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-1280w.png 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-840w.png 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-320w.png 320w" type="image/png"><img alt="" src="/img/posts/mingyou/deep-dive-into-react-fiber/p6-1920w.png" height="1265" width="1871" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1871 1265'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAh0lEQVQImT2OQQ7CMAwE+//PceOEQIILQQLSJE0aO+mguCqH9Vry7MrTRmeodUVUgG6qKmhvdpvGqLJSamFVxfnMJ61IU9oBjYaQAjEFa7i+Fs6Pmb7twHBrGktcIiFFfBYuz4jzi4UMOhLaBB9mWhdSVU63L6FUA/9Nw0Wr/Qcb93fGzcWgH6+Q0v3va0oMAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><a href="https://www.youtube.com/watch?v=ZCuYPiUIONs&t=1040s" rel="noopener noreferrer" target="_blank">source video</a></p><h2 id="effect-list"><a href="#effect-list" class="direct-link">#</a> Effect List</h2><p>在上一張圖中，有標記標籤的元件是需要 side effect 進行處理的，為了達到高效的處理，因此需要將原本的樹狀咧表轉換為線性列表，才能夠快速的遍歷，除此之外還會省略沒有 side effect 的節點，流程如下圖：</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p7-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-840w.webp 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p7-1920w.png 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-1280w.png 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-840w.png 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-320w.png 320w" type="image/png"><img alt="" src="/img/posts/mingyou/deep-dive-into-react-fiber/p7-1920w.png" height="1162" width="1680" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1680 1162'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmUlEQVQImTWOQQuCQBSE/f9/J+ge0VmCoksWeqiwUnQ1dfe998VmzmFgmGFmEjPFUNQEL4LpRGgKRAX9e0mkIJ5xGhhFeFY1t/3qp2UJxYaud7SuAYTsrRzTHVO+IUI1kMQ5tYDrHa5z1J9Adq8pD2t0eGEwh2KlaKBxLeI7mvJCesqpz1swP3+Kk8u3yQ+YbymqkepxhbHiC8Ee0INa0vh/AAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>順序的部分是從子到父的方式去執行，在各個階段如果為該層結構<strong>第一個節點</strong>會記錄在 firstEffect，其後則會記錄在 nextEffect 當中，並會在父層級將其合併起來並將自己綁入 lastEffect ，並向上傳遞，遇到沒有 effect 的節點會直接向上傳遞而不進行更動，最後將所有順序傳遞至 Root 層建立出如下圖的 effect list。</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p8-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-840w.webp 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p8-1920w.png 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-1280w.png 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-840w.png 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-320w.png 320w" type="image/png"><img alt="Re: Effect list" src="/img/posts/mingyou/deep-dive-into-react-fiber/p8-1920w.png" height="783" width="1268" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1268 783'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfUlEQVQImWWPwQ7CMAxD+/9/iTggNsSWrmmbsNQoXTVAHKxE9oushAaDtR0+gTZ07N9Z8MWGcZ1jF3HFZSLsdkCeBWt+bd1IRTpUVLGkMloG6BVxJcS4gUVRX4osiqwKFkGq8ql+bhkzMW5LwiNmTMS4r6nLsxP8f+RXDr4BHWXrJ/Vp1zQAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><a href="https://youtu.be/ZCuYPiUIONs?t=1373" rel="noopener noreferrer" target="_blank">source video</a></p><h2 id="render-%E9%9A%8E%E6%AE%B5%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%BE%AA%E7%92%B0"><a href="#render-%E9%9A%8E%E6%AE%B5%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%BE%AA%E7%92%B0" class="direct-link">#</a> Render 階段的工作循環</h2><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">isYieldy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isYieldy<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Flush work without yielding</span><br>    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Flush asynchronous work until the deadline runs out of time.</span><br>    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&&</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>在上面<a href="https://github.com/facebook/react/blob/f765f022534958bcf49120bf23bc1aa665e8f651/packages/react-reconciler/src/ReactFiberScheduler.js#L1136" rel="noopener noreferrer" target="_blank">程式碼</a>中，nextUnitOfWork 存有 workInProgress 樹中的 Fiber nodes。當 React 輪詢 Fiber tree 時，它會使用這個變量來知曉是否有任何其他 Fiber nodes 具有未完成的工作。目前的 Fiber 處理完後，nextUnitOfWork 會指向下一個 Fiber node 或者 null (結束)。</p><p>輪詢 Fiber trees 主要根據以下四個功能：</p><ul><li>performUnitOfWork</li><li>beginWork</li><li>completeUnitOfWork</li><li>completeWork</li></ul><p>執行順序參考如下圖：</p><p><img alt="" src="/img/posts/mingyou/deep-dive-into-react-fiber/p9.gif" height="420" width="780"><br><a href="https://images.indepth.dev/images/2019/08/tmp2.gif" rel="noopener noreferrer" target="_blank">source image</a></p><p>由於透過了深度優先搜尋(DFS)，整個流程會優先執行底部 child node 的工作，最後才會到 parent node。</p><h2 id="commit-%E9%9A%8E%E6%AE%B5"><a href="#commit-%E9%9A%8E%E6%AE%B5" class="direct-link">#</a> Commit 階段</h2><p>在這個階段，React 會將 render phase 所產生的 workInProgress tree 轉移到 current tree，並執行 render phase 所比對所產生的 Effect list，此步驟將會有更新 Dom 的節點等等的操作，假如有不需更新的項目將不會包含在 Effect list 中，所以不會被 commit (更新)。</p><p>而執行完後的 current tree 將會被放到 finishedWork tree 中。</p><p>而在此階段將會觸發以下操作：</p><ul><li>執行 getSnapshotBeforeUpdate event</li><li>執行 componentWillUnmount event</li><li>執行所有 DOM 操作</li><li>將 finishedWork tree 設置為 current tree</li><li>執行 componentDidMount event</li><li>執行 componentDidUpdate event</li></ul><h3 id="dom-%E6%9B%B4%E6%96%B0"><a href="#dom-%E6%9B%B4%E6%96%B0" class="direct-link">#</a> Dom 更新</h3><p><a href="https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L376" rel="noopener noreferrer" target="_blank">commitAllHostEffects</a> 是React在其中執行DOM更新的函數。該函數定義了 Dom 需要執行的操作類型。</p><h2 id="%E8%BC%83%E5%B0%91%E5%9C%A8%E7%94%A8-class-component-%EF%BC%8C%E9%82%A3%E4%BE%86%E8%AB%87%E8%AB%87-function-component"><a href="#%E8%BC%83%E5%B0%91%E5%9C%A8%E7%94%A8-class-component-%EF%BC%8C%E9%82%A3%E4%BE%86%E8%AB%87%E8%AB%87-function-component" class="direct-link">#</a> 較少在用 class component ，那來談談 function component</h2><p>時至今日，function component 搭配 hooks 幾乎已成了主流，而 function component 在渲染時可以避免多餘的判斷 (<a href="https://github.com/facebook/react/blob/v16.13.1/packages/react-reconciler/src/ReactFiberBeginWork.js#L1306" rel="noopener noreferrer" target="_blank">mountIndeterminateComponent</a>)</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p10-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-840w.webp 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p10-1920w.png 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-1280w.png 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-840w.png 840w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-320w.png 320w" type="image/png"><img alt="RE: React hooks" src="/img/posts/mingyou/deep-dive-into-react-fiber/p10-1920w.png" height="424" width="684" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 684 424'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAABAUlEQVQImQH2AAn/AN+gLQqD//8A6rtQDuPDdxLWtlwe1rNRH9mmPgvWtVQQ1rVVENe2VBAAxNiWJsXct3+HoHEW////AOnA9wDa2ogJzdp9Et3FYAXSw5AHx7yLCADJ3OV8xN/TgteyqDrsv76r/Lu/NaLMtEC71Me9hauTG////wAAAAABAMbW7pmuz+hD2KWfTe7Avv/utLRelsOuSL7VzNhWfFIasMPjWLbL6GMAwdyqMsffvqmmqocaAAAAAGKXXACbwn0mncJ/Y2ynAASasdhPmK/TWQCR3/gMbNv5PWHh/xlU4v8VOd7/A5wAAANLAAAEulRSEGQAAAUAAAABcJh/yKOL+OcAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><a href="https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba" rel="noopener noreferrer" target="_blank">under-the-hood-of-reacts-hooks-system</a></p><p>而大家常用的 <a href="https://github.com/facebook/react/blob/4c7036e807/packages/react-reconciler/src/ReactFiberHooks.new.js" rel="noopener noreferrer" target="_blank">hook</a> 則會形成 hook 鍊，保存在 Fiber 的 memoizedState 中，通過 dispatcher 去更新 fiber 內的 state 及 effect 狀態：</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> hook<span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span><br>  memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">// hook 的狀態</span><br>  baseState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//起始 state</span><br>  baseQueue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//起始 queue</span><br>  queue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//需要更新的update</span><br>  next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//下一個hook</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>例如 const [state, updateState] = useState(initialState)， memoizedState 就是 initialState。</p><p>每個 hook 都會被放到 queue 當中。當您調用 setState 函數時，React 其實不會立即調用 updater 函式，而是將其保存在隊列中並安排重新渲染。</p><h3 id="%E5%8F%83%E8%80%83"><a href="#%E5%8F%83%E8%80%83" class="direct-link">#</a> 參考</h3><p><a href="https://segmentfault.com/a/1190000039225217" rel="noopener noreferrer" target="_blank">https://segmentfault.com/a/1190000039225217</a><br><a href="https://twitter.com/acdlite/status/977291318324948992" rel="noopener noreferrer" target="_blank">https://twitter.com/acdlite/status/977291318324948992</a><br><a href="https://indepth.dev/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react" rel="noopener noreferrer" target="_blank">https://indepth.dev/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react</a><br><a href="https://www.bilibili.com/video/av48384879/" rel="noopener noreferrer" target="_blank">https://www.bilibili.com/video/av48384879/</a></p><p>延伸閱讀<br><a href="https://segmentfault.com/a/1190000017241034?utm_source=sf-related" rel="noopener noreferrer" target="_blank">https://segmentfault.com/a/1190000017241034?utm_source=sf-related</a></p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/front-end/" class="post-tag">#Front-end</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/huli/android-apk-decompile-intro-3/">Android App 逆向入門之三：監聽 app 封包</a></li><li><a href="/posts/huli/xss-history/">XSS 從頭談起：歷史與由來</a></li><li><a href="/posts/crystal/email-sec-examples/">關於 email security 的大小事 — 範例篇</a></li><li><a href="/posts/jo/zerobased-common-risk-exposure/">資安科普番外篇（一）-大意了啊沒有閃！常見網站曝險你中了幾項？！</a></li><li><a href="/posts/jo/zerobased-cross-site-scripting/">零基礎資安系列（二）-認識 XSS（Cross-Site Scripting）</a></li></ol></div><div class="article-author"><img alt="ming-you-tsai" src="/img/authors/mingyou_avatar.jpeg" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/mingyou">ming-you-tsai</a></div><div class="article-author__intro">Front-end Developer</div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"隱藏在 React 下的機制： Fiber","image":["https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p1-1920w.png","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p2-1920w.png","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p3-1920w.png","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p4-1920w.png","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p5-1920w.png","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p6-1920w.png","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p7-1920w.png","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p8-1920w.png","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p9.gif","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p10-1920w.png","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/mingyou_avatar.jpeg"],"author":{"@type":"Person","name":"ming-you-tsai"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/","datePublished":"2021-05-28","dateModified":"2022-04-22","description":"不知不覺都 2021 年中了，從 React 16.3 的重大更新後也已經過了兩年多了，不知到大家還記不記得當時的兩大重要功能，其一為 Function Component ( hooks )，另一個大家比較不那麼熟悉但卻也很重要的則應該屬 Fiber 架構，但其實會有 hook..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>