<!DOCTYPE html><html domain=cymetrics.io ga-id=G-3VBVCXV9Z0 lang=en><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel=icon type=image/png><meta content=#f9c412 name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>隱藏在 React 下的機制： Fiber</title><meta content="隱藏在 React 下的機制： Fiber" property=og:title><meta content="從 React 16.3 的重大更新後也已經過了兩年多了，不知到大家還記不記得當時的兩大重要功能，其一為 Function Component ( hooks )，另一個大家比較不那麼熟悉但卻也很重要的則應該屬 Fiber 架構。而在過去這個部分全部只由一個主線程去做同步式渲染。" name=description><meta content="從 React 16.3 的重大更新後也已經過了兩年多了，不知到大家還記不記得當時的兩大重要功能，其一為 Function Component ( hooks )，另一個大家比較不那麼熟悉但卻也很重要的則應該屬 Fiber 架構。而在過去這個部分全部只由一個主線程去做同步式渲染。" property=og:description><meta content=summary_large_image name=twitter:card><meta content=@ name=twitter:site><meta content=@ name=twitter:creator><meta content=https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p1.png property=og:image><meta content=hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk name=google-site-verification><link href=https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="Cymetrics Tech Blog"><link href=/ rel=preconnect crossorigin=""><script async src="/js/min.js?hash=b870cb012d" defer></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary: #00bcb2;--primary-dark: #ffd349;--fgColor: #222;--bgColor: #eee;--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;padding:.375em 1.5em;background:rgba(255,255,255,.9);font-weight:200;text-align:right}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}share-widget{position:fixed;right:20px;bottom:20px;opacity:.9;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);position:fixed;opacity:.8;z-index:1000;font-size:10px}#nav{z-index:2;position:relative}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;top:0;bottom:0;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}h1{text-align:left;font-size:3em;line-height:1.25;margin:.67em 0 .5em;font-size:2.074rem}hr{box-sizing:content-box;height:0;overflow:visible;border-bottom:1px solid #eee}a{background-color:transparent;color:#f9c412;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none}button,input{font-family:inherit;font-size:100%;line-height:1.15;overflow:visible}button{text-transform:none}input{margin:0}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=checkbox]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em}h1,h2,h3{margin-bottom:1.36rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.6rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}h1,h2{line-height:2.4rem}h2{font-size:1.728rem}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h1{font-size:3.0978rem;line-height:1.25}h2{font-size:2.7097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h1,h2,h3,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h1{font-size:3rem}h2{font-size:2.05rem}h3{font-size:1.5rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h1,h2,h3,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){padding:1.5em;overflow-x:scroll}code{border-radius:.3em;color:var(--primary);padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%;background:#2d2d2d}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}button,input{border-radius:.3em;max-width:100%}input{padding:.75em;margin-bottom:1.5em;display:inline}button+input[type=checkbox],button+label,input+input[type=checkbox],input+label,label+*{page-break-before:always}.copyright,button,label{display:inline-block}button{background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}input[type=number],input[type=time],input[type=url]{border:1px solid #595959;padding:.75em}input[type=checkbox]{flex-grow:0;margin:.75em .375em .75em 0;vertical-align:middle}input[type=checkbox]+label{page-break-before:avoid}*{border:0;box-sizing:border-box}header,img,video{margin:0 auto;max-width:100%}img,video{height:auto}body,header nav a{font-family:var(--font-family)}body{background:var(--bgColor);color:var(--fgColor)}header label{display:block}header{padding:4.5em 1.5em 3em;width:50.5em;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ul{margin-top:0}header nav h1{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav a{font-weight:700;text-decoration:none;color:#181818;margin-left:1.5em}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;border-top:.5px solid #ccc;min-height:60vh}footer{font-size:14px;padding:3em;text-align:center}footer>*{margin:.5em}footer nav a img{vertical-align:middle}footer nav,footer p{font-size:90%}article{max-width:100%;padding:1.5em;width:50.5em;margin:0 auto;word-break:break-word}li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#2d2d2d}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.tag{color:#e2777a}.token.function,.token.number{color:#f08d49}.token.property{color:#f8c555}.token.keyword{color:#cc99cd}.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.inserted{color:green}.avatar{width:50px;border-radius:50%;overflow:hidden;margin:inherit}.avatar-large{width:75px}.utterances{position:relative;box-sizing:border-box;width:100%;max-width:760px;margin-left:auto;margin-right:auto}.flex{display:flex}.items-center{align-items:center}.w-full{width:100%}#menu__control,.menu__btn{display:none}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}nav a:hover{color:#595959}@media screen and (max-width:960px){#nav .nav__links a{margin-right:.5rem;margin-left:.5rem}}@media screen and (max-width:840px){header nav{padding:0}#nav,.menu__btn{position:relative}#nav h1{padding:.375rem 1.5rem;justify-content:space-between}#nav h1 *{margin:0}.menu__btn{display:inline-block;width:1.5rem;height:1.5rem;border:1px solid #191919;border-radius:.3rem}.menu__btn::before{content:"";position:absolute;top:51%;left:50%;transform:translate(-50%,-50%);height:.1rem;width:.9rem;background-color:#2d2d2d;border-radius:.1rem;box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn:hover{filter:brightness(.6)}#nav h1,.nav__links{display:flex;align-items:center;width:100%}.nav__links{flex-direction:column;justify-content:center;height:0;max-height:0;overflow:hidden;position:absolute;top:2.24em;transition:max-height .6s ease;margin:0;padding:0;z-index:-1;background:rgba(255,255,255,.9)}.nav__links a{text-align:center;width:100%;padding:.5rem 0;transition:all .3s ease-out}.nav__links a:hover{color:#f9c412;background:rgba(245,245,245,.9)}#menu__control:checked+.nav__links{height:auto;max-height:100vh}}#rss{vertical-align:text-top}#nav{display:flex}#color-scheme-toggle{cursor:pointer;vertical-align:text-top;display:inline-block;margin-right:1em}body.dark{background:var(--fgColor);color:var(--bgColor);--primary: var(--primary-dark)}@media (prefers-color-scheme:dark){body.dark{background:var(--fgColor);color:var(--bgColor);--primary: var(--primary-dark)}}.posts{max-width:100%}.post{display:flex;margin-bottom:1em;padding:1em 0}.summary{font-size:1rem;line-height:1.25rem;margin:.5em 0;overflow:hidden;word-break:break-word}@media (max-width:480px){.post{padding:0}.summary{display:none}}</style><header><nav><div id=nav><h1><a href=/ title=Homepage>Cymetrics Tech Blog</a> <label class=menu__btn for=menu__control><span>選單</span></label></h1><img alt="switch dark mode" height=22 src=/img/dark.svg width=22 id=color-scheme-toggle> <input id=menu__control type=checkbox><div class=nav__links><a href=/tags/ >Tags</a> <a href=/about/ >About</a></div></div><div id=reading-progress aria-hidden=true></div></nav><h1 class=w-full>隱藏在 React 下的機制： Fiber</h1><aside class=w-full><div class="flex items-center"><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/mingyou_avatar-1920w.avif 1920w, /img/authors/mingyou_avatar-1280w.avif 1280w, /img/authors/mingyou_avatar-640w.avif 640w, /img/authors/mingyou_avatar-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/mingyou_avatar-1920w.webp 1920w, /img/authors/mingyou_avatar-1280w.webp 1280w, /img/authors/mingyou_avatar-640w.webp 640w, /img/authors/mingyou_avatar-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/mingyou_avatar-1920w.jpg 1920w, /img/authors/mingyou_avatar-1280w.jpg 1280w, /img/authors/mingyou_avatar-640w.jpg 640w, /img/authors/mingyou_avatar-320w.jpg 320w" type=image/jpeg><img alt=avatar height=100 src=/img/authors/mingyou_avatar-1920w.jpg width=100 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 100 100'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAbElEQVQI12Ng6KyGIKauGiCCcxkQrNYyhrZyFAlGoMLWcqvFM3XnTgIyGCH6gJgZyGoqyduzJXj9MoamYma4BMjo5hLfNYtdV84DMpjgEoxAqq1CZlqnwfzJQAYjuuXtlUBRLK4CKmTqRDgXAMhzRLdTwZfIAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)" class=avatar></picture><span style="margin-left: 12px;"><a href=/posts/mingyou>ming-you-tsai</a> published on 2021-05-28</span></div><div style="text-align: left;"><a href=/tags/front-end/ class=post-tag>#Front-end</a></div></aside><dialog id=message></dialog></header><main><article><p>不知不覺都 2021 年中了，從 React 16.3 的重大更新後也已經過了兩年多了，不知到大家還記不記得當時的兩大重要功能，其一為 Function Component ( hooks )，另一個大家比較不那麼熟悉但卻也很重要的則應該屬 Fiber 架構，但其實會有 hook 的設計也是也是因為上述架構的關係。<p>在當時引想大家最多的應該屬生命週期的變換，不曉得大家是否還記得當時最常用到的生命週期 <code>componentWillUpdate</code>/<code>componentWillReceiveProps</code> 將被廢除時驚訝的心情? 而當時也加入了兩個新的 lifecycle 來解決以上問題。<ul><li>getDerivedStateFromProps<li>getSnapshotBeforeUpdate</ul><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p1-1920w.avif 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-1280w.avif 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-640w.avif 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p1-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-640w.webp 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p1-1920w.jpg 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-1280w.jpg 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-640w.jpg 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p1-320w.jpg 320w" type=image/jpeg><img alt="Re: React 常用的生命週期(1)" height=1215 src=/img/posts/mingyou/deep-dive-into-react-fiber/p1-1920w.jpg width=1737 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1737 1215'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmUlEQVQI1x2PQQ7DIAwE+USVhNhgDCQkoYeqUv//s63hYNlajVZj91oIyxZAQbHtgpQbyvHMm0K2HeEG5Lmg9h+C3tA65kGQCi1tgk7LhagNuzSE/Ia0L0g7KB5gAzwluJ2TBdWgy6Ab5/NBPjtYymyZkObLPCpyiTiqoN/JRqyF4UPCOpwG6VnMR7GSPZDUWhMWz5aZOEX8ARf5So8JqFtsAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><a href=https://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/ target=_blank>https://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/</a><p>至於為什麼會產生以下的變化呢？這就要說說本次的主題 Fiber 了。<h2 id=fiber-%E6%98%AF%E4%BB%80%E9%BA%BC><a href=#fiber-%E6%98%AF%E4%BB%80%E9%BA%BC target=_blank class=direct-link>#</a> Fiber 是什麼</h2><p>Fiber 屬於更為底層的抽象行為，目的是為了達到以下幾種功能<ul><li>幫不同類型的工作分配優先順序<li>暫停工作，稍後回來<li>當不需要工作時取消<li>重新使用已經完成的工作</ul><p>在尚未使用 Fiber 前，由於畫面更新前須由 reconciler ( React ) 調度完後才會送到 renderer，且當畫面複雜時，更動一個 state 狀態時也需要將底下的所有子元件重新 render 出一份 virtual dom，而在過去這個部分全部只由一個主線程去做同步式渲染，因此當有一個 Component 需要費時較多時間時，將會把主線程 block，當時間一長，就有可能導致來不及更新至指定時間範圍內，造成無法順利渲染，會有不順暢的情況發生。<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p2-1920w.avif 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-1280w.avif 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-640w.avif 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p2-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-640w.webp 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p2-1920w.jpg 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-1280w.jpg 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-640w.jpg 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p2-320w.jpg 320w" type=image/jpeg><img alt="Re: sync mode 和 async mode 的差異" height=768 src=/img/posts/mingyou/deep-dive-into-react-fiber/p2-1920w.jpg width=1024 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1024 768'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAzElEQVQY0y2PQUvDUBCE81fEpEkTqzb7Ni95r1q1ghQKvfRSEERQoYKgBw/iyV/+uS96GHYGZmdns0ktVI2jrB2ThOYfoxZK41kic/E4jYhEWh84k4H6xBYbGY3ZUSlsNwt+3m/5Olzx/XrD50vgY39JXEbyZKpPPW23QDTgOkvSgdYZJDCb93/n8sqxXl/w9rzi8HjN0z5wv1Medp67bknRKFlhcbNzRX2P7wNDiHT9YD2VEFaWFshSXDEVjqtUUu0zpbCZm86n7Vj8F06hZ988vr8vAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><a href=https://twitter.com/acdlite/status/977291318324948992 target=_blank>https://twitter.com/acdlite/status/977291318324948992</a><h2 id=fiber-%E7%9A%84%E7%94%A2%E7%94%9F%E5%8F%8A%E4%BD%9C%E7%94%A8><a href=#fiber-%E7%9A%84%E7%94%A2%E7%94%9F%E5%8F%8A%E4%BD%9C%E7%94%A8 target=_blank class=direct-link>#</a> Fiber 的產生及作用</h2><p>為了解決此問題，React 制定了 fiber 的結構，利用非同步的渲染方式來解決，將各元件拆解，也避免了長時間占用主線程所導致卡頓的問題。 ( 所使用的 <a href=https://developer.mozilla.org/zh-TW/docs/Web/API/Window/requestIdleCallback target=_blank>API</a>， <a href=https://github.com/facebook/react/blob/4c7036e807fa18a3e21a5182983c7c0f05c5936e/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1541 target=_blank>source code</a> )<p>傳統 React 更新時會分成兩個時期<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p3-1920w.avif 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-1280w.avif 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-640w.avif 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p3-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-640w.webp 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p3-1920w.jpg 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-1280w.jpg 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-640w.jpg 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p3-320w.jpg 320w" type=image/jpeg><img alt="Re: React 更新時期" height=740 src=/img/posts/mingyou/deep-dive-into-react-fiber/p3-1920w.jpg width=1202 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1202 740'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnUlEQVQI1zVPyw7CMAzr//8gEkIcJtA09u7SNunLZGXk4jSxXcfkUtHNhFu/YTwC/vVaXZvZENvblFrhOcH6CI4ZqNBe0G8Oh5LCNTOrYxR1jamAVHBWkIRdhYP1inIRPeM57lic4PGewEGaU7cQ7h8Lp6JG5JQxabaUK4bZInFsS1KcSdou5wIDzXgqUOrvCgXRXFZ/WimA1P2M9gXXw+k7NdOpEwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><ul><li>reconciliation / render 階段 ( 判斷哪先元件需要更新，可中斷 )<li>commit 階段 ( 插入、移動、刪除節點，不可中斷 )</ul><p>reconciliation phase 會先通過 render 更新元件，在第一次實建立 Fiber 節點，並在之後更新與上一次所渲染的 DOM 比較，因此在 render 階段將執行以下生命週期方法判斷是否有更新：<ul><li>componentWillMount (已廢棄)<li>componentWillReceiveProps (已廢棄)<li>componentWillUpdate (已廢棄)<li>getDerivedStateFromProps<li>shouldComponentUpdate</ul><p>react 可以根據目前的狀況調整，可以選擇一次處理單個或者多個 fiber 並且調整優先權，因此可以異步執行及中斷，但也因為如此，內部的邏輯必須避免 side effect。<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p4-1920w.avif 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-1280w.avif 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-640w.avif 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p4-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-640w.webp 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p4-1920w.jpg 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-1280w.jpg 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-640w.jpg 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p4-320w.jpg 320w" type=image/jpeg><img alt="Re: Commit phrase 和 render phrase" height=768 src=/img/posts/mingyou/deep-dive-into-react-fiber/p4-1920w.jpg width=1024 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1024 768'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAuElEQVQY0zWPWW7CQBBEfRQUeZvBJsazeZNGMRAgho9E3P8qjxlDPqpL3dXqrkpyqRC1RtYmcMDuxWWlKbaaqCexyCAUsicXHWntSGXHJld8iHZdTNJSMYyax93wuxj+ljf/WPx+IhXhUiY0brBcj5bL0XE5Ob4PlvPsGNuJLL6rmp7z8uBTeZqAwS8UVc/ezUzzNcxHkrIyNHpajZvO83W6oZwPXmIgS9RX41kw+Epp2bXDKsT+H0+0d2UWec3s3QAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><p>在 render 階段執行完後將會產生包含著 side effect 的 fiber 節點樹，而 side effect 事實上就是 commit 階段所需要更新操作，會在執行 commit 階段時輪詢 side effect 列表去對 DOM 進行修改。<p>以下是commit階段執行的生命週期方法列表：<ul><li>getSnapshotBeforeUpdate<li>componentDidMount<li>componentDidUpdate<li>componentWillUnmount</ul><p>因為這些方法在同步commit階段執行，所以它們可能包含副作用或更動 DOM。<p>而前面說到被廢除的兩個 lifecycle 因為是屬於 render phase，有機會被多次執行，為了避免 side effect 發生，才會移除此 lifecycle。<ul><li><code>componentWillUpdate</code><li><code>componentWillReceiveProps</code></ul><p>而拿掉以上 API 後則利用 <code>getDerivedStateFromProps</code> 來取代 <code>componentWillReceiveProps</code>，但由於 <code>getDerivedStateFromProps</code> 被設計成靜態函數，不用擔心 side effect 所帶來的影響，不過要避免從 props 等等去觸發 side effect。<h2 id=fiber-nodes-%E5%92%8C-fiber-tree><a href=#fiber-nodes-%E5%92%8C-fiber-tree target=_blank class=direct-link>#</a> Fiber nodes 和 Fiber tree</h2><p>在 reconciliation 時，每個 component 的 render 方法回傳的資料都會合併到 Fiber tree 中，每個React元素都有一個對應的 Fiber nodes，用來記錄對應的工作內容，而特別的地方在於在每次 render 時不會重新產生 Fiber node。<p>更確切的說，每個 Fiber 就是一個 worker ，提供了跟踪，調度，暫停和中止工作的方法。<p>每一個 Fiber Node 節點與 Virtual Dom 對應，所有 Fiber Node 連接起來形成 Fiber tree，為單向連結串列的樹狀結構：<br><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p5-1920w.avif 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-1280w.avif 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-640w.avif 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p5-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-640w.webp 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p5-1920w.jpg 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-1280w.jpg 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-640w.jpg 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p5-320w.jpg 320w" type=image/jpeg><img alt="Re: Fiber tree" height=1120 src=/img/posts/mingyou/deep-dive-into-react-fiber/p5-1920w.jpg width=1562 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1562 1120'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4klEQVQY02NggAE2bobjx44y/fr1i+Hdu3c279+/b/v//z9DYmIiAwMXVA0TOzuY3rlzB8OnT58c3759Ow2kCIQZNNW196sqK2+TlZXdLicnt11AQGBHaWlpL1CyBqQXSDMyaKhr/tfS0v6vrKz8X1FR8b+QkPD/zMzMXUDJHrhJyqqq/5WUlP4pARWpqir/FxMT/Z+enr4BKJn56NGjxC9fvkQzKCgq+srKyXrJKyh4qaur+gCtcF69enX6t2/fal++fFkJ9EQlA9AEBnlFBTANAjU1NSArLIG+KwV6IA2IMwGlK2/wyQaCnQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><p>主要是為了將原本的樹狀遞迴輪詢轉變成循環輪詢，配合 requestIdleCallback API, 實現任務拆分、中斷與恢復。<p>大概結構如下：<pre class=language-js><code class=language-js>type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span><br>  <span class="token comment">// 標籤類型</span><br>  tag<span class="token operator">:</span> TypeOfWork<span class="token punctuation">,</span><br><br>  key<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span><br><br>  <span class="token comment">// 與 Fiber 所關聯的類型</span><br>  type<span class="token operator">:</span> any<span class="token punctuation">,</span><br><br>  <span class="token comment">// local 狀態</span><br>  stateNode<span class="token operator">:</span> any<span class="token punctuation">,</span><br><br>  <span class="token comment">// 以下區塊負責處理 Fiber</span><br><br>  <span class="token keyword">return</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// 單向連結串列結構</span><br>  child<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  sibling<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  index<span class="token operator">:</span> number<span class="token punctuation">,</span><br><br>  <span class="token operator">...</span><br><br><br>  <span class="token comment">// 輸出用的狀態</span><br>  memoizedState<span class="token operator">:</span> any<span class="token punctuation">,</span><br><br>  <span class="token operator">...</span><br><br>  <span class="token comment">// 紀錄在單向鏈結串列中的下一個 Fiber </span><br>  nextEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// 子樹中具有 side effect 的第一個和最後一個光纖</span><br>  <span class="token comment">// 當我們重用已完成的工作時，我們重用 link list 的一部分</span><br>  firstEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br>  lastEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><br>  <span class="token comment">// 快速確定子樹是否沒有正在等待的更動</span><br>  pendingWorkPriority<span class="token operator">:</span> PriorityLevel<span class="token punctuation">,</span><br><br><br>  <span class="token comment">// 如果工作在光纖上進行，而該光纖已經在較低的優先權開始了一部分工作</span><br>  <span class="token comment">// 那麼我們需要將已完成的工作儲存著。直到我們需要重新開始處理它為止</span><br>  <span class="token comment">// 它可能與 "目前" 的 child 不同。</span><br>  progressedChild<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span><br><br>  <span class="token operator">...</span><br><span class="token punctuation">}</span></code></pre><p>在這結構中，nextEffect / firstEffect / lastEffect 將在後面的章節 ( Effect List ) 中表現出相當的重要性。<h2 id=workinprogress-tree><a href=#workinprogress-tree target=_blank class=direct-link>#</a> workInProgress tree</h2><pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> <span class="token operator">...</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <br>    <span class="token keyword">let</span> workInProgress <span class="token operator">=</span> current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        workInProgress <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token operator">...</span><br>    workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> current<span class="token punctuation">;</span><br>    current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span><br>    <span class="token operator">...</span><br>    <span class="token keyword">return</span> workInProgress<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p><a href=https://github.com/facebook/react/blob/4c7036e807/packages/react-reconciler/src/ReactFiber.new.js#L254 target=_blank>source code</a><p>React 在第一次 render 時會將各節點紀錄為 Fiber Tree，而在之後檢查時會建立一個 workInProgress tree ，等待 workInProgress tree 完成後就會被當作 current tree，而此稱為<code>雙緩衝技術</code> (double buffering)。<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p6-1920w.avif 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-1280w.avif 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-640w.avif 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p6-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-640w.webp 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p6-1920w.jpg 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-1280w.jpg 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-640w.jpg 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p6-320w.jpg 320w" type=image/jpeg><img alt="" height=1265 src=/img/posts/mingyou/deep-dive-into-react-fiber/p6-1920w.jpg width=1871 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1871 1265'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAh0lEQVQI1z2OzQ4CIQyE9/1fzpsno4leXBOVf2gLO7boehg6hG+mLBsGTH0IWBhQbyL1Mvp8W+wgbqhU0USwuoJXauAuGvxB1hBSQFRZw/mRcbx5jO0L2Fx2E3NUOMIVxuketTHP0IT2hHSGC15XMBIJDpc3QqUJ/ptsstD8H/R2fRasvk7oA6+Q0v0iX/piAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><a href="https://www.youtube.com/watch?v=ZCuYPiUIONs&t=1040s" target=_blank>source video</a><h2 id=effect-list><a href=#effect-list target=_blank class=direct-link>#</a> Effect List</h2><p>在上一張圖中，有標記標籤的元件是需要 side effect 進行處理的，為了達到高效的處理，因此需要將原本的樹狀咧表轉換為線性列表，才能夠快速的遍歷，除此之外還會省略沒有 side effect 的節點，流程如下圖：<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p7-1920w.avif 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-1280w.avif 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-640w.avif 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p7-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-640w.webp 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p7-1920w.jpg 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-1280w.jpg 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-640w.jpg 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p7-320w.jpg 320w" type=image/jpeg><img alt="" height=1162 src=/img/posts/mingyou/deep-dive-into-react-fiber/p7-1920w.jpg width=1680 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1680 1162'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAnElEQVQI1zWOwQ6CQAxE+f/fMfFujGdiovEiGjioQYXAorC77T53JfTQpNPpm2YhKAFFg+BECGrxXYWoRG3eZal5cUx2ZIqmZ9Ny26/+syymRBg+ht50gFC8lWO+w5YbUqn6SAopymOi0QyG9usp7i31YY2Or0hiNiWkxIvO9Igb6OoL+amkPW8huPmnFLn8Zt0Y9Z6qmWgeV5gafsEe0IMzXKPUAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><p>順序的部分是從子到父的方式去執行，在各個階段如果為該層結構<strong>第一個節點</strong>會記錄在 firstEffect，其後則會記錄在 nextEffect 當中，並會在父層級將其合併起來並將自己綁入 lastEffect ，並向上傳遞，遇到沒有 effect 的節點會直接向上傳遞而不進行更動，最後將所有順序傳遞至 Root 層建立出如下圖的 effect list。<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p8-1920w.avif 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-1280w.avif 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-640w.avif 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p8-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-640w.webp 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p8-1920w.jpg 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-1280w.jpg 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-640w.jpg 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p8-320w.jpg 320w" type=image/jpeg><img alt="Re: Effect list" height=783 src=/img/posts/mingyou/deep-dive-into-react-fiber/p8-1920w.jpg width=1268 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1268 783'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfElEQVQI12WP2w6DMAxD+f+/nPaABtOgIb2ka/CaUsGmPbix4qNYHXYodC+wifoeOvx3NpjRvrjP1OR8wm1yKFpOuILaLtiCozQo5oyFY2/poFXQ6kC0wUtGemeEOkOFvQg4yVX92gJm5zEujCcFTNU/Vm6y7AT/P/Iryz8dZesnlaY8FAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><a href="https://youtu.be/ZCuYPiUIONs?t=1373" target=_blank>source video</a><h2 id=render-%E9%9A%8E%E6%AE%B5%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%BE%AA%E7%92%B0><a href=#render-%E9%9A%8E%E6%AE%B5%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%BE%AA%E7%92%B0 target=_blank class=direct-link>#</a> Render 階段的工作循環</h2><pre class=language-js><code class=language-js><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">isYieldy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isYieldy<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Flush work without yielding</span><br>    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>    <span class="token comment">// Flush asynchronous work until the deadline runs out of time.</span><br>    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&&</span> <span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>在上面<a href=https://github.com/facebook/react/blob/f765f022534958bcf49120bf23bc1aa665e8f651/packages/react-reconciler/src/ReactFiberScheduler.js#L1136 target=_blank>程式碼</a>中，nextUnitOfWork 存有 workInProgress 樹中的 Fiber nodes。當 React 輪詢 Fiber tree 時，它會使用這個變量來知曉是否有任何其他 Fiber nodes 具有未完成的工作。目前的 Fiber 處理完後，nextUnitOfWork 會指向下一個 Fiber node 或者 null (結束)。<p>輪詢 Fiber trees 主要根據以下四個功能：<ul><li>performUnitOfWork<li>beginWork<li>completeUnitOfWork<li>completeWork</ul><p>執行順序參考如下圖：<p><img alt="" height=420 src=/img/posts/mingyou/deep-dive-into-react-fiber/p9.gif width=780><br><a href=https://images.indepth.dev/images/2019/08/tmp2.gif target=_blank>source image</a><p>由於透過了深度優先搜尋(DFS)，整個流程會優先執行底部 child node 的工作，最後才會到 parent node。<h2 id=commit-%E9%9A%8E%E6%AE%B5><a href=#commit-%E9%9A%8E%E6%AE%B5 target=_blank class=direct-link>#</a> Commit 階段</h2><p>在這個階段，React 會將 render phase 所產生的 workInProgress tree 轉移到 current tree，並執行 render phase 所比對所產生的 Effect list，此步驟將會有更新 Dom 的節點等等的操作，假如有不需更新的項目將不會包含在 Effect list 中，所以不會被 commit (更新)。<p>而執行完後的 current tree 將會被放到 finishedWork tree 中。<p>而在此階段將會觸發以下操作：<ul><li>執行 getSnapshotBeforeUpdate event<li>執行 componentWillUnmount event<li>執行所有 DOM 操作<li>將 finishedWork tree 設置為 current tree<li>執行 componentDidMount event<li>執行 componentDidUpdate event</ul><h3 id=dom-%E6%9B%B4%E6%96%B0><a href=#dom-%E6%9B%B4%E6%96%B0 target=_blank class=direct-link>#</a> Dom 更新</h3><p><a href=https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L376 target=_blank>commitAllHostEffects</a> 是React在其中執行DOM更新的函數。該函數定義了 Dom 需要執行的操作類型。<h2 id=%E8%BC%83%E5%B0%91%E5%9C%A8%E7%94%A8-class-component-%EF%BC%8C%E9%82%A3%E4%BE%86%E8%AB%87%E8%AB%87-function-component><a href=#%E8%BC%83%E5%B0%91%E5%9C%A8%E7%94%A8-class-component-%EF%BC%8C%E9%82%A3%E4%BE%86%E8%AB%87%E8%AB%87-function-component target=_blank class=direct-link>#</a> 較少在用 class component ，那來談談 function component</h2><p>時至今日，function component 搭配 hooks 幾乎已成了主流，而 function component 在渲染時可以避免多餘的判斷 (<a href=https://github.com/facebook/react/blob/v16.13.1/packages/react-reconciler/src/ReactFiberBeginWork.js#L1306 target=_blank>mountIndeterminateComponent</a>)<p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p10-1920w.avif 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-1280w.avif 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-640w.avif 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p10-1920w.webp 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-1280w.webp 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-640w.webp 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/mingyou/deep-dive-into-react-fiber/p10-1920w.jpg 1920w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-1280w.jpg 1280w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-640w.jpg 640w, /img/posts/mingyou/deep-dive-into-react-fiber/p10-320w.jpg 320w" type=image/jpeg><img alt="RE: React hooks" height=424 src=/img/posts/mingyou/deep-dive-into-react-fiber/p10-1920w.jpg width=684 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 684 424'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAABAUlEQVQI1wH2AAn/AN+gLQqD//8A6rtQDuPDdxLWtlwe1rNRH9mmPgvWtVQQ1rVVENe2VBAAxNiWJsXct3+HoHEW////AOnA9wDa2ogJzdp9Et3FYAXSw5AHx7yLCADJ3OV8xN/TgteyqDrsv76r/Lu/NaLMtEC71Me9hauTG////wAAAAABAMbW7pmuz+hD2KWfTe7Avv/utLRelsOuSL7VzNhWfFIasMPjWLbL6GMAwdyqMsffvqmmqocaAAAAAGKXXACbwn0mncJ/Y2ynAASasdhPmK/TWQCR3/gMbNv5PWHh/xlU4v8VOd7/A5wAAANLAAAEulRSEGQAAAUAAAABcJh/yCJc0C4AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><a href=https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba target=_blank>under-the-hood-of-reacts-hooks-system</a><p>而大家常用的 <a href=https://github.com/facebook/react/blob/4c7036e807/packages/react-reconciler/src/ReactFiberHooks.new.js target=_blank>hook</a> 則會形成 hook 鍊，保存在 Fiber 的 memoizedState 中，通過 dispatcher 去更新 fiber 內的 state 及 effect 狀態：<pre class=language-js><code class=language-js><span class="token keyword">const</span> hook<span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span><br>  memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">// hook 的狀態</span><br>  baseState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//起始 state</span><br>  baseQueue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//起始 queue</span><br>  queue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//需要更新的update</span><br>  next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//下一個hook</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>例如 const [state, updateState] = useState(initialState)， memoizedState 就是 initialState。<p>每個 hook 都會被放到 queue 當中。當您調用 setState 函數時，React 其實不會立即調用 updater 函式，而是將其保存在隊列中並安排重新渲染。<h3 id=%E5%8F%83%E8%80%83><a href=#%E5%8F%83%E8%80%83 target=_blank class=direct-link>#</a> 參考</h3><p><a href=https://segmentfault.com/a/1190000039225217 target=_blank>https://segmentfault.com/a/1190000039225217</a><br><a href=https://twitter.com/acdlite/status/977291318324948992 target=_blank>https://twitter.com/acdlite/status/977291318324948992</a><br><a href=https://indepth.dev/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react target=_blank>https://indepth.dev/posts/1008/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react</a><br><a href=https://www.bilibili.com/video/av48384879/ target=_blank>https://www.bilibili.com/video/av48384879/</a><p>延伸閱讀<br><a href="https://segmentfault.com/a/1190000017241034?utm_source=sf-related" target=_blank>https://segmentfault.com/a/1190000017241034?utm_source=sf-related</a><hr><p><h3>Author</h3><div class="flex items-center"><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/mingyou_avatar-1920w.avif 1920w, /img/authors/mingyou_avatar-1280w.avif 1280w, /img/authors/mingyou_avatar-640w.avif 640w, /img/authors/mingyou_avatar-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/mingyou_avatar-1920w.webp 1920w, /img/authors/mingyou_avatar-1280w.webp 1280w, /img/authors/mingyou_avatar-640w.webp 640w, /img/authors/mingyou_avatar-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/authors/mingyou_avatar-1920w.jpg 1920w, /img/authors/mingyou_avatar-1280w.jpg 1280w, /img/authors/mingyou_avatar-640w.jpg 640w, /img/authors/mingyou_avatar-320w.jpg 320w" type=image/jpeg><img alt=avatar height=100 src=/img/authors/mingyou_avatar-1920w.jpg width=100 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 100 100'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAbElEQVQI12Ng6KyGIKauGiCCcxkQrNYyhrZyFAlGoMLWcqvFM3XnTgIyGCH6gJgZyGoqyduzJXj9MoamYma4BMjo5hLfNYtdV84DMpjgEoxAqq1CZlqnwfzJQAYjuuXtlUBRLK4CKmTqRDgXAMhzRLdTwZfIAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)" class="avatar avatar-large"></picture><h3 style="margin-left: 12px;"><a href=/posts/mingyou>ming-you-tsai</a></h3></div><p>Front-end Developer<p><p><a href=https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/ on-click=share>Share this post</a></p><script async src=https://utteranc.es/client.js crossorigin=anonymous id=utterance-script issue-term=title label=utterance repo=cymetrics/blog theme=github-light></script><share-widget><button aria-label=Share href=https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/ on-click=share><div></div></button></share-widget><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"隱藏在 React 下的機制： Fiber","image":["https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p1-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p2-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p3-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p4-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p5-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p6-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p7-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p8-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p9.gif","https://tech-blog.cymetrics.io/img/posts/mingyou/deep-dive-into-react-fiber/p10-1920w.jpg","https://tech-blog.cymetrics.io/img/authors/mingyou_avatar-1920w.jpg"],"author":"ming-you-tsai","genre":"Insert a schema.org genre","publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","logo":{"@type":"ImageObject","url":"/img/favicon/favicon-192x192.png?hash=42b087227d"}},"url":"https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/mingyou/deep-dive-into-react-fiber/","datePublished":"2021-05-28","dateModified":"2021-07-21","description":"不知不覺都 2021 年中了，從 React 16.3 的重大更新後也已經過了兩年多了，不知到大家還記不記得當時的兩大重要功能，其一為 Function Component ( hooks )，另一個大家比較不那麼熟悉但卻也很重要的則應該屬 Fiber 架構，但其實會有 hook..."}</script></article></main><footer><div class=copyright>© 2021 Cymetrics Tech Blog</div><a href=https://tech-blog.cymetrics.io/feed/feed.xml id=rss><img alt="rss feed" height=18 src=/img/rss-feed.svg width=18></a></footer><script>// light/dark theme switch
      const toggleEl = document.querySelector('#color-scheme-toggle')
      const bodyEl = document.querySelector('body');
      const DARK = 'dark';
      const LIGHT = 'light';
      const currentTheme = localStorage.getItem("theme") ||
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : LIGHT);
      setTheme(currentTheme)

      toggleEl.addEventListener("click", handleToggleEvent)

      function handleToggleEvent(){
        const isDark = bodyEl.classList.toggle(DARK);
        const theme = isDark ? DARK : LIGHT;
        setTheme(theme)
        localStorage.setItem('theme', theme);
      }
      function setTheme(theme){
        if (theme === DARK) {
          setUtterancesTheme(DARK)
          bodyEl.classList.add(DARK);
          toggleEl.src = toggleEl.src.replace(DARK, LIGHT);
        }else{
          setUtterancesTheme(LIGHT)
          toggleEl.src = toggleEl.src.replace(LIGHT, DARK);
        }
      }

      var isUtterancesLoaded = false
      window.addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') {
          return;
        }
        isUtterancesLoaded = true
      });

      function setUtterancesTheme(theme) {
        let utterancesIframe = document.querySelector('.utterances iframe')
        if (!isUtterancesLoaded) {
          return requestAnimationFrame(() => setUtterancesTheme(theme))
        }

        utterancesIframe.contentWindow.postMessage({
          type: 'set-theme',
          theme: theme === DARK ? 'github-dark-orange' : 'github-light'
        }, 'https://utteranc.es');
      }</script>