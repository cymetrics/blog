<!DOCTYPE html><html domain=cymetrics.io ga-id=G-3VBVCXV9Z0 lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel=icon type=image/png><meta content=#f9c412 name=theme-color><meta content="max-snippet:-1, max-image-preview: large, max-video-preview: -1" name=robots><title>The Difference Between Java and Golang in Writing Concurrent Code to Access Shared Variable</title><meta content="The Difference Between Java and Golang in  Writing Concurrent Code to Access Shared Variable" property=og:title><meta content="When writing concurrency code, we often use mechanisms like Lock or Synchronized to protect share resources (sometimes it’s a piece of..." name=description><meta content="When writing concurrency code, we often use mechanisms like Lock or Synchronized to protect share resources (sometimes it’s a piece of..." property=og:description><meta content=summary_large_image name=twitter:card><meta content=@ name=twitter:site><meta content=@ name=twitter:creator><meta content=hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk name=google-site-verification><link href=https://tech-blog.cymetrics.io/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-en/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="Cymetrics Tech Blog"><link href=/ rel=preconnect crossorigin=""><script async src="/js/min.js?hash=4aa09e9651" defer></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}share-widget{position:fixed;right:20px;bottom:20px;opacity:.9;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);position:fixed;opacity:.8;z-index:1000;font-size:10px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,select{font-family:inherit;font-size:100%;line-height:1.15;text-transform:none}button{overflow:visible}select{margin:0}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,p,pre,ul{font-size:1em}p,pre,ul{margin-bottom:1.5em}body,p,pre,ul{font-size:1rem;line-height:1.6}p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,h3,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}body,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,h3,p,pre,ul{margin-bottom:1.632rem}}th{font-weight:600;border-bottom:1px solid #595959;overflow:auto;padding:.75em;text-align:left;vertical-align:top}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){padding:1.5em;overflow-x:scroll}code{border-radius:.3em;color:#e33671;padding:0 .3em;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}button,select{border-radius:.3em;max-width:100%}button+label,label+*,select+label{page-break-before:always}select{margin-bottom:1.5em;display:inline;border:1px solid #595959;padding:.75em}button,label{display:inline-block}button{background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*,.utterances{box-sizing:border-box}*{border:0}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}figure img,header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;flex-direction:column}header p,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ul{margin-bottom:0}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}figure{margin:1.5em}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#2d2d2d}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.property{color:#f8c555}.token.builtin,.token.keyword{color:#cc99cd}.token.string,.token.variable{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.inserted{color:green}.utterances{position:relative;width:100%;max-width:760px;margin-left:auto;margin-right:auto}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4a5568}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title,header{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id=nav><div class=nav-title><a href=/ class=nav-logo title=Homepage></a> <label class=menu__btn for=menu__control><span>Menu</span></label></div><div class=nav__links><a href=/archive/ >Archive</a> <a href=/tags/ >Tags</a> <a href=/about/ >About</a></div></div><div id=reading-progress aria-hidden=true></div></nav><h1 class=w-full>The Difference Between Java and Golang in Writing Concurrent Code to Access Shared Variable</h1><aside class=w-full><div class=post-tags><a href=/tags/back-end/ class=post-tag>#Back-end</a> <a href=/tags/java/ class=post-tag>#java</a> <a href=/tags/golang/ class=post-tag>#golang</a> <a href=/tags/volatile/ class=post-tag>#volatile</a> <a href=/tags/concurrency/ class=post-tag>#concurrency</a></div><div class=post-avatar><img src=/img/authors/genchilu_logo.jpeg alt=genchilu class=post-avatar__img data-deopt=true><div class=post-avatar__info><div class=post-avatar__author><a href=/posts/genchilu>genchilu</a></div><div class=post-avatar__time>03 May 2021</div></div></div></aside><dialog id=message></dialog></header><main><article><div id=post-page></div><p>When writing concurrency code, we often use mechanisms like Lock or Synchronized to protect share resources (sometimes it’s a piece of code). What if we merely want to protect one variable but not a whole code? It’s too expensive to use Lock or Synchronized to protect just one variable.</p><p>Let’s see one simple Golang code:</p><pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">BenchmarkLocke</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span><br>		a <span class="token operator">:=</span> <span class="token number">0</span><br>		<span class="token keyword">var</span> l sync<span class="token punctuation">.</span>Mutex<br>		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>			l<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>			a<span class="token operator">++</span><br>			l<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>And profiling of the code will tell you how expensive Lock cost, as shown below:</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-1920w.avif 1920w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-1280w.avif 1280w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-640w.avif 640w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-1920w.webp 1920w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-1280w.webp 1280w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-640w.webp 640w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-1920w.jpg 1920w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-1280w.jpg 1280w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-640w.jpg 640w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-320w.jpg 320w" type=image/jpeg><img src=/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-1920w.jpg alt="" height=996 width=1400 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1400 996'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAIAAABV+fA3AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAj0lEQVQI1z2OywoCMQxF+/+/JcxG3AiiokxXVkuZtvSVvmiMVTyQSy83acI45w8hlJTRGEQcY5CWUnrvzBHeO629fP2zlFJrleE04JzkK86QxFpL/Ywcmai35+1C6jfVak0fIvt+Iu7X07Jbj4fzfoEUQ4hUDCcZQG+q90YYo0PwAPDLaJoOmy8sORtraOUbA260bYHB3cMAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>You can see that lots of CPU time were wasted in Lock.</p><p>To improve performance, often we would not use lock if we just want to protect one variable instead of the piece of code.</p><p>In this article, I will introduce how to protect these share variables in Java and Golang.</p><p>In the very beginning, three things need to care: <strong>atomicity</strong>, <strong>visibility</strong>, and <strong>ordering</strong>. It’s too hard to understand from words, so let’s see examples directly.</p><h1 id=atomicity><a href=#atomicity class=direct-link>#</a> Atomicity</h1><p>The action to access shared variable must be executed all in once and indivisibly. A line of code may be composed of several cpu instructions, like the codei++ is composed of 3 cpu instructions: <code>read value</code>, <code>add 1 to value</code> and <code>save value</code>. If two threads run i++ simultaneously, all these cpu instructions may be executed interleaved:</p><pre class=language-text><code class=language-text>thread1 load value 100  <br>thread2 load value 100  <br>thread1 add 1 to value 101  <br>thread2 add 1 to value 101  <br>thread1 save value 101  <br>thread2 save value 101</code></pre><p>Finally, we get a wrong answer: i = 101, which is not correct.<br>Let’s look at a simple Java example :</p><pre class=language-java><code class=language-java><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Atomic</span> <span class="token punctuation">{</span><br>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span><br>        <span class="token keyword">int</span> times <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span><br><br>        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token class-name">Counter</span> counter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>times<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>                counter<span class="token punctuation">.</span>i<span class="token operator">++</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>counter<span class="token punctuation">.</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token punctuation">{</span><br>        <span class="token keyword">int</span> i<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Line 16 should print 100000, but the value printed is always less than 100000. That’s why we must care about atomicity.</p><h1 id=visibility><a href=#visibility class=direct-link>#</a> Visibility</h1><p>In Multicore architecture, every CPU has its cache. Thus CPU can load value from cache, which is faster than loading value from main memory. The architecture looks like below:</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-1920w.avif 1920w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-1280w.avif 1280w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-640w.avif 640w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-1920w.webp 1920w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-1280w.webp 1280w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-640w.webp 640w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-1920w.jpg 1920w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-1280w.jpg 1280w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-640w.jpg 640w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-320w.jpg 320w" type=image/jpeg><img src=/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-1920w.jpg alt="" height=398 width=452 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 452 398'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAHCAIAAAC6O5sJAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAoUlEQVQI1w3G0Q6CIBQAUP7/i9rspdnMrZrKQjMTRXJGygVEEt/qPB3kV7dZ6efRW+0X/c82T/7r0ApvQaL7KbDs5vitjPc9Pn5hQEZDmpEwunaMdy0Lo0ua5RoASeNiTIMwoYN59rA7XM6ETcqiCcyDS0IHXHa45HkjqheMUqPPpCoORSPSgiVFm1NBajF8JHJu0UoZrefZWGslSFrXSqkfAWOVMXFvbbIAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>So it’s clear that the value of a variable may exist in multi CPU’s cache. If cpu1 changes the value of one variable but cpu2 did not aware of that, cpu2 may use the old value until cpu2 reload the value from main memory.</p><p>Here is simple Java code to show the problem:</p><pre class=language-java><code class=language-java><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span><br>    <span class="token class-name">Flag</span> flag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">{</span><br>        <span class="token keyword">while</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>bool<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token comment">// do nothing</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">{</span><br>        flag<span class="token punctuation">.</span>bool <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Unreachable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Flag</span> <span class="token punctuation">{</span><br>    <span class="token keyword">boolean</span> bool <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Even thread t2 had changed the flag to true in line 12, thread t1 would still live in an infinite loop in line 4~6. That’s because t1 does not see a new value of the flag.</p><h1 id=ordering><a href=#ordering class=direct-link>#</a> Ordering</h1><p>Sometimes the compile would reordering instructions due to the purpose of optimizations. As a result, the ordering of instructions running in your machine may not as your imagination. See these three codes:</p><pre class=language-text><code class=language-text>a = 1  <br>b = 2  <br>c = a + b</code></pre><p>line 3 is a dependency on line1 & line2, so the real ordering of instructions may like below:</p><pre class=language-text><code class=language-text>b = 2  <br>a = 1  <br>c = a + b</code></pre><p>It’s ok when your code is running on a single thread. But when running on multi-thread, the reordering may cause some bug you can not understand. Take the code for example:</p><pre class=language-java><code class=language-java><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><br><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><br>    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        i<span class="token operator">++</span><span class="token punctuation">;</span><br>        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">{</span><br>            a<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><br>            b<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">==</span><span class="token number">1</span> <span class="token operator">&&</span> a<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token class-name">String</span> err <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%th round, Non thread safe!"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">break</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>In the writing order, we assign a=2 first and then b=1, so it should never happen that the code runs the block behind the if condition in line 12. But it’s possible. Although it’s very rare to happen, it DO happen.</p><p>Note that visibility and ordering are often seen together as the problem of <a href=https://en.wikipedia.org/wiki/Happened-before target=_blank>happen-before</a>.</p><p>It’s common that implementing singleton pattern with double-checked locking to improve performance. If you were not aware of happen-before, it may cause some issue: even if the singleton instance is not null, that does not mean that system had finished constructed the singleton instance. You can see more detail in this <a href=https://en.wikipedia.org/wiki/Double-checked_locking target=_blank>wiki</a>.</p><p>So let’s see how Java and Golang solve these issues.</p><h1 id=java><a href=#java class=direct-link>#</a> Java</h1><h2 id=how-java-solve-atomicity><a href=#how-java-solve-atomicity class=direct-link>#</a> How Java solve Atomicity</h2><p>Java provides <strong>package java.util.concurrent.atomic</strong> to guarantee the atomicity when accessing a shared variable. For example, we could use <strong>AtomicInteger</strong> to fix the first example in the beginning like below:</p><pre class=language-java><code class=language-java><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span><br>    <span class="token keyword">int</span> times <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span><br><br>    <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name">Counter</span> counter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>times<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span><br>            counter<span class="token punctuation">.</span>i<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>counter<span class="token punctuation">.</span>i<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token punctuation">{</span><br>    <span class="token class-name">AtomicInteger</span> i <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><h2 id=how-java-solve-happen-before><a href=#how-java-solve-happen-before class=direct-link>#</a> How Java solve happen-before</h2><p>Java uses keyword <strong>volatile</strong> to ensure happen-before. Once you declare a variable with volatile, then happen-before is guaranteed in that variable.</p><p>Let’s look at the secondary example in the beginning, I use volatile to declare the variable as below:</p><pre class=language-java><code class=language-java><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span><br>    <span class="token class-name">Flag</span> flag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Flag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">{</span><br>        <span class="token keyword">while</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>bool<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token comment">// do nothing</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">{</span><br>        flag<span class="token punctuation">.</span>bool <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>bool<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span>bool<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Unreachable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Flag</span> <span class="token punctuation">{</span><br>    <span class="token keyword">volatile</span> <span class="token keyword">boolean</span>  bool <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>Now when thread t2 updates bool variable in Flag, thread t1 would be aware of that and escape from the for loop.</p><p>Then the third example. After I declare variables a and b with volatile, Compiler would make sure that a=2 happen before b=1, so it would guarantee that the program never enters if statement.</p><pre class=language-java><code class=language-java><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> a<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><br><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span><br>    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        i<span class="token operator">++</span><span class="token punctuation">;</span><br>        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">{</span><br>            a<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><br>            b<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token operator">==</span><span class="token number">1</span> <span class="token operator">&&</span> a<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            <span class="token class-name">String</span> err <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%th round, Nonthread safe!"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">break</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><h1 id=golang><a href=#golang class=direct-link>#</a> Golang</h1><h2 id=how-golang-solve-atomicity><a href=#how-golang-solve-atomicity class=direct-link>#</a> How Golang solve Atomicity</h2><p>Golang provides its atomicity tool kit, too.</p><p>Do you remember the Golang’s Lock example at the beginning of the article? We can use atomic instead of Lock:</p><pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">BenchmarkFib10</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> n<span class="token operator">++</span> <span class="token punctuation">{</span><br>		a <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><br>		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span><br>			atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&</span>a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>If you run benchmark, you would figure out the performance gap between Lock and atomicity:</p><pre class=language-bash><code class=language-bash>BenchmarkLock-8 <span class="token number">9266</span> <span class="token number">134075</span> ns/op <span class="token number">8</span> B/op <span class="token number">1</span> allocs/op  <br>BenchmarkAtomic-8 <span class="token number">19225</span> <span class="token number">62309</span> ns/op <span class="token number">8</span> B/op <span class="token number">1</span> allocs/op</code></pre><p>And below is the profiling of atomicity:</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-1920w.avif 1920w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-1280w.avif 1280w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-640w.avif 640w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-1920w.webp 1920w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-1280w.webp 1280w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-640w.webp 640w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-1920w.jpg 1920w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-1280w.jpg 1280w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-640w.jpg 640w, /img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-320w.jpg 320w" type=image/jpeg><img src=/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-1920w.jpg alt="" height=1326 width=1394 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1394 1326'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkUlEQVQI11WMWQ7CMBBDc//r9AjABYryU/JTsXRBmSwzWSaglgACxJPlD9uykFJ2XaeUGsYRxuHOXEpVEfM8T9NU3VhrL2dG5FthzmJ9syzVzOmYnc3MMQTxCp9pMLBrmna7Qee88+I7D94f9u3Q94SeiD5X65pSct4yM2io/IoK6CsR5pxjjH+F1poQrTEG4AF3lLX8orPDWAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h2 id=how-golang-solve-happen-before%3F><a href=#how-golang-solve-happen-before%3F class=direct-link>#</a> How Golang solve happen-before?</h2><p>According to Golang’s official blog, Golang would guarantee happen-before in these conditions:</p><ul><li>Initialization</li><li>Goroutine creation</li><li>Goroutine destruction</li><li>Channel communication</li><li>Locks</li><li>Once</li></ul><p>But Golang does not provide something like volatile in Java to protect one variable share between goroutines. In terms of visibility, Such as below code may be incorrect synchronization:</p><pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>	flag <span class="token operator">:=</span> <span class="token boolean">true</span><br><br>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">for</span> flag <span class="token punctuation">{</span><br>			<span class="token keyword">continue</span><br>		<span class="token punctuation">}</span><br>		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Never end\n"</span><span class="token punctuation">)</span><br>	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	flag <span class="token operator">=</span> <span class="token boolean">false</span><br><br>	<span class="token keyword">for</span> <span class="token punctuation">{</span><br>		<span class="token keyword">continue</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>line 5~10 would never end.</p><p>Then ordering. <a href="https://medium.com/r/?url=https%3A%2F%2Fgolang.org%2Fref%2Fmem" target=_blank>The Official Goalng Blog</a> mentions that this code is non-concurrence safe:</p><pre class=language-go><code class=language-go><span class="token keyword">var</span> a<span class="token punctuation">,</span> b <span class="token builtin">int</span><br><br><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	a <span class="token operator">=</span> <span class="token number">1</span><br>	b <span class="token operator">=</span> <span class="token number">2</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token function">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><br>	<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token keyword">go</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>	<span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><p>It may happen that g prints 2 and then 1. So we must protect that variable with something like Lock to protect it. But how come an effective Language like Golang would handle this issue in such a heavy way?</p><p>Look at this Golang’s official blog, we can see how to solve the issue in Golang way. The blog mentions that:</p><blockquote><p>Do not communicate by sharing memory; instead, share memory by communicating.</p></blockquote><p>That’s the way Golang encourages you to do: using <a href=https://en.wikipedia.org/wiki/Communicating_sequential_processes target=_blank>CSP model</a>. So I think the key way to solve the shared variable in concurrency in Golang is “NOT TO SHARE IT”. Instead, you should use chan to communicate. And as mentioned above, chan DO guarantee happen-before!</p><p>According to discuss above, I think it should pass flag through chan in the visibility example:</p><pre class=language-go><code class=language-go><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><br>	done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span><br><br>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>done <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		flag <span class="token operator">:=</span> <span class="token boolean">true</span><br>		<span class="token keyword">for</span> flag <span class="token punctuation">{</span><br>			<span class="token keyword">select</span> <span class="token punctuation">{</span><br>			<span class="token keyword">case</span> flag <span class="token operator">=</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span><br>				<span class="token keyword">break</span><br>			<span class="token punctuation">}</span><br>		<span class="token punctuation">}</span><br>		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"End of goroutine\n"</span><span class="token punctuation">)</span><br><br>	<span class="token punctuation">}</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><br><br>	done <span class="token operator">&lt;-</span> <span class="token boolean">false</span><br>	<span class="token function">close</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><br><br>	<span class="token keyword">for</span> <span class="token punctuation">{</span><br>		<span class="token keyword">continue</span><br>	<span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre><p>Also, I think it should pass a and b through chan in the ordering example, the code may look like:</p><pre class=language-go><code class=language-go><span class="token keyword">var</span> a<span class="token punctuation">,</span> b <span class="token builtin">int</span><br><br><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span>done <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	chana <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><br>	chanb <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><br>	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>chana<span class="token punctuation">)</span><br>		<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>chanb<span class="token punctuation">)</span><br><br>		chana <span class="token operator">&lt;-</span> <span class="token number">1</span><br>		chanb <span class="token operator">&lt;-</span> <span class="token number">2</span><br>		<span class="token keyword">for</span> <span class="token punctuation">{</span><br>			<span class="token keyword">select</span> <span class="token punctuation">{</span><br>			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span><br>				<span class="token keyword">return</span><br>			<span class="token punctuation">}</span><br>		<span class="token punctuation">}</span><br>	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><br>	<span class="token keyword">return</span> chana<span class="token punctuation">,</span> chanb<br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	<span class="token function">print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><br>	<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>	done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><br>	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><br><br>	chana<span class="token punctuation">,</span> chanb <span class="token operator">:=</span> <span class="token function">f</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><br>	a <span class="token operator">=</span> <span class="token operator">&lt;-</span>chana<br>	b <span class="token operator">=</span> <span class="token operator">&lt;-</span>chanb<br>	<span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">}</span></code></pre><h3 id=conclusion><a href=#conclusion class=direct-link>#</a> Conclusion</h3><p>The most difficult part of writing concurrency code is that most of the bug is not determined, uncertain, and can not reproduce easily, thus it’s had to debug.</p><p>That’s why we should dig deeper into detail in how a program langue handle concurrency, understand how your code would run in your machine and prevent you from doing thing wrong.</p><div class=article-footer><a href=https://tech-blog.cymetrics.io/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-en/ on-click=share><img src="/img/icons/icon_external link hyperlink.svg" height=24 width=24>Share this post</a></div><div class=article-author><img src=/img/authors/genchilu_logo.jpeg alt=genchilu class=article-author__img data-deopt=true><div class=article-author__info><div class=article-author__title>Author</div><div class=article-author__author><a href=/posts/genchilu>genchilu</a></div><div class=article-author__intro>I am Genchi, a backend engineer in Taiwan.</div></div></div><script async src=https://utteranc.es/client.js crossorigin=anonymous id=utterance-script issue-term=title label=utterance repo=cymetrics/blog theme=github-light></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"The Difference Between Java and Golang in  Writing Concurrent Code to Access Shared Variable","image":["https://tech-blog.cymetrics.io/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/lock-profiling-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/cpu-architecture-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable/atomic-profiling-1920w.jpg","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/genchilu_logo.jpeg"],"author":"genchilu","genre":"Insert a schema.org genre","publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","logo":{"@type":"ImageObject","url":"/img/favicon/favicon-192x192.png?hash=42b087227d"}},"url":"https://tech-blog.cymetrics.io/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-en/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/genchilu/the-difference-between-java-and-golang-in-writing-concurrent-code-to-access-shared-variable-en/","datePublished":"2021-05-03","dateModified":"2021-07-29","description":"When writing concurrency code, we often use mechanisms like Lock or Synchronized to protect share resources (sometimes it’s a piece of..."}</script></article></main><footer><div class=footer-logos><a href=https://www.facebook.com/Cymetrics-100957872049641 target=_blank><img src="/img/icons/icon_social media_facebook.svg" alt=facebook height=30 width=30></a><a href=https://www.linkedin.com/company/onedegree-hk target=_blank><img src="/img/icons/icon_social media_linkedln.svg" alt=linkedin height=30 width=30></a><a href=https://tech-blog.cymetrics.io/feed/feed.xml target=_blank><img src=/img/icons/rss-feed.svg alt="rss feed" height=18 width=18></a></div><div class=copyright>© 2021 Cymetrics Tech Blog</div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })
      

      /*
      const toggleEl = document.querySelector('#color-scheme-toggle')
      const bodyEl = document.querySelector('body');
      const DARK = 'dark';
      const LIGHT = 'light';
      const currentTheme = localStorage.getItem("theme") ||
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : LIGHT);
      setTheme(currentTheme)

      toggleEl.addEventListener("click", handleToggleEvent)

      function handleToggleEvent(){
        const isDark = bodyEl.classList.toggle(DARK);
        const theme = isDark ? DARK : LIGHT;
        setTheme(theme)
        localStorage.setItem('theme', theme);
      }
      function setTheme(theme){
        if (theme === DARK) {
          setUtterancesTheme(DARK)
          bodyEl.classList.add(DARK);
          toggleEl.src = toggleEl.src.replace(DARK, LIGHT);
        }else{
          setUtterancesTheme(LIGHT)
          toggleEl.src = toggleEl.src.replace(LIGHT, DARK);
        }
      }

      var isUtterancesLoaded = false
      window.addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') {
          return;
        }
        isUtterancesLoaded = true
      });

      function setUtterancesTheme(theme) {
        let utterancesIframe = document.querySelector('.utterances iframe')
        if (!isUtterancesLoaded) {
          return requestAnimationFrame(() => setUtterancesTheme(theme))
        }

        utterancesIframe.contentWindow.postMessage({
          type: 'set-theme',
          theme: theme === DARK ? 'github-dark-orange' : 'github-light'
        }, 'https://utteranc.es');
      }
    */</script></body></html>