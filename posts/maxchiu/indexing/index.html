<!DOCTYPE html><html domain=tech-blog.cymetrics.io ga-id=G-3VBVCXV9Z0 lang=zh><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel=icon type=image/png><meta content=#5789d3 name=theme-color><title>從Indexing的角度切入MySQL-Innodb與PostgreSQL的效能比較</title><meta content=從Indexing的角度切入MySQL-Innodb與PostgreSQL的效能比較 property=og:title><meta content=從Indexing的角度切入MySQL-Innodb與PostgreSQL的效能比較 name=twitter:title><meta content=summary name=twitter:card><meta content="這篇文章想要以 MySQL (在本文中所參考的儲存引擎為 innodb ) 和PostgreSQL 為例，來討論一些 Relational Database 在底層操作資料時的一些基本原理。 更確切地說，從DB系統管理Index的方式來切入。" name=description><meta content="這篇文章想要以 MySQL (在本文中所參考的儲存引擎為 innodb ) 和PostgreSQL 為例，來討論一些 Relational Database 在底層操作資料時的一些基本原理。 更確切地說，從DB系統管理Index的方式來切入。" name=twitter:description><meta content="這篇文章想要以 MySQL (在本文中所參考的儲存引擎為 innodb ) 和PostgreSQL 為例，來討論一些 Relational Database 在底層操作資料時的一些基本原理。 更確切地說，從DB系統管理Index的方式來切入。" property=og:description><meta content=article property=og:type><meta content=https://tech-blog.cymetrics.io/posts/maxchiu/indexing/ property=og:url><meta content="Cymetrics Tech Blog" property=og:site_name><meta content=https://tech-blog.cymetrics.io/img/favicon/favicon-192x192.png property=og:image><meta content=https://tech-blog.cymetrics.io/img/favicon/favicon-192x192.png name=twitter:image><meta content=hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk name=google-site-verification><link href=https://tech-blog.cymetrics.io/posts/maxchiu/indexing/ rel=canonical><meta content=no-referrer-when-downgrade name=referrer><link href=/feed/feed.xml rel=alternate type=application/atom+xml title="Cymetrics Tech Blog"><link href=/ rel=preconnect crossorigin=""><script async src="/js/min.js?hash=4aa09e9651" defer></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}share-widget{position:fixed;right:20px;bottom:20px;opacity:.9;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);position:fixed;opacity:.8;z-index:1000;font-size:10px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}html{line-height:1.15;-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b,strong{font-weight:700}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button,select{font-family:inherit;font-size:100%;line-height:1.15;text-transform:none}button{overflow:visible}select{margin:0}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}summary{display:list-item}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem}h4{font-size:1.5em;margin-bottom:1em;line-height:1.5em}body,p{font-size:1em}p{margin-bottom:1.5em}h3,h4{line-height:1.5rem;margin-bottom:1rem}h4{font-size:1.2rem}body,p{font-size:1rem;line-height:1.6}p{margin-bottom:1.36rem}@media (min-width:600px){h3{font-size:1.7989rem;line-height:2rem}h4{font-size:1.3554rem;line-height:1.56rem;margin-bottom:1.296rem}body,p{font-size:1.1rem;line-height:1.6}h3,p{margin-bottom:1.496rem}}@media (min-width:1200px){h3{font-size:1.5rem}h4{font-size:1.15rem;line-height:1.42rem;margin-bottom:1.2rem}body,p{font-size:1.2rem;line-height:1.6}h3,p{margin-bottom:1.632rem}}table{display:table;overflow-x:auto}h1,h3,h4{font-family:var(--font-family)}a:hover{text-decoration:underline}button,select{border-radius:.3em;max-width:100%}button+label,label+*,select+label{page-break-before:always}select{margin-bottom:1.5em;display:inline;border:1px solid #595959;padding:.75em}button,label{display:inline-block}button{background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*,.utterances{box-sizing:border-box}*{border:0}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;flex-direction:column}header p{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}blockquote{padding:0 1.5em;margin:1.5em 0 1.5em 1.5em;border-left:4px solid var(--primary)}blockquote footer{background:0 0;display:block;color:#ccc;padding:.75em 0;font-size:90%;text-align:start}.utterances{position:relative;width:100%;max-width:760px;margin-left:auto;margin-right:auto}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color);--paginationCurrentColor: #666356}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title,header{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}</style></head><body><header><nav><div id=nav><div class=nav-title><a href=/ class=nav-logo title=Homepage></a> <label class=menu__btn for=menu__control><span>Menu</span></label></div><div class=nav__links><a href=/archive/ >Archive</a> <a href=/tags/ >Tags</a> <a href=/about/ >About</a></div></div><div id=reading-progress aria-hidden=true></div></nav><h1 class=w-full>從Indexing的角度切入MySQL-Innodb與PostgreSQL的效能比較</h1><aside class=w-full><div class=post-tags><a href=/tags/back-end/ class=post-tag>#Back-end</a></div><div class=post-avatar><img alt=maxchiu src=/img/authors/max_logo.jpeg class=post-avatar__img data-deopt=true><div class=post-avatar__info><div class=post-avatar__author><a href=/posts/maxchiu>maxchiu</a></div><div class=post-avatar__time>12 Mar 2021</div></div></div></aside><dialog id=message></dialog></header><main><article><div id=post-page></div><p><img alt="" src=/img/posts/max/IndexingComparisonOfMySQLAndPostgres/1__D99fysQ1Z0zfpa390g4QvQ.gif height=425 width=640></p><p>如果你用的資料庫是屬於 Relational Database ，在這個年代用SQL進行資料庫的存取已經變成一件理所當然的事了。MySQL 、PostgreSQL 、MsSQL…不論是開源抑或是由大廠主導的 SQL 專案都擁有各自的擁護者 。</p><p>其實如果單純以使用與操作的角度去這些不同的資料庫的官網和 document 看過一圈，可能不太容易看出有什麼關鍵性的差異。然而儘管這些資料庫在表面上看起來都提供了類似 Function ，但是對於同樣的一個邏輯， 不同家的資料庫之間的底層的物理實作卻有不少大相徑庭的地方。</p><p>這篇文章想要以 MySQL (在本文中所參考的儲存引擎為 innodb ) 和PostgreSQL 為例，來討論一些 Relational Database 在底層操作資料時的一些基本原理。 更確切地說，從DB系統管理Index的方式來切入。</p><h3 id=indexes-%3A-%E6%B1%BA%E5%AE%9A%E8%B3%87%E6%96%99%E5%AD%98%E5%8F%96%E9%80%9F%E5%BA%A6%E7%9A%84%E9%97%9C%E9%8D%B5><a href=#indexes-%3A-%E6%B1%BA%E5%AE%9A%E8%B3%87%E6%96%99%E5%AD%98%E5%8F%96%E9%80%9F%E5%BA%A6%E7%9A%84%E9%97%9C%E9%8D%B5 class=direct-link>#</a> Indexes : 決定資料存取速度的關鍵</h3><p>首先來談談 MySQL 和 PostgreSQL 在資料儲存上最關鍵的差異 : Indexes 。</p><p><a href=https://www.tutorialspoint.com/mysql/mysql-indexes.htm rel="noopener noreferrer" target=_blank>網路上的教學</a>都會說， 對於 table 中經常需要用來當作查詢依據的 column ，把它設成 index 速度就會提升。這背後的原因是因為對於資料庫背後儲存資料的 Data structure 來說 ，被選為 Index 的 Column 就會成為資料結構中的排序依據。</p><p>“假設”某個資料庫背後是用 <a href=https://en.wikipedia.org/wiki/Binary_tree rel="noopener noreferrer" target=_blank>Binary Tree</a>（實際上通常是 <a href=https://zh.wikipedia.org/wiki/B%E6%A0%91 rel="noopener noreferrer" target=_blank>B-Tree</a> 的各種延伸版本）來當作核心資料結構的話，一筆資料的 row 就是一個 node。 那例如說在下圖的資料結構，一筆資料會有Name、Height、id 三個欄位，那當我們把欄位 “ id” 設為 index的話 ，這棵樹（也就是資料庫存放資料的結構）就會照著 id 的值來排序。</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-1920w.avif 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-1280w.avif 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-640w.avif 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-1920w.webp 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-1280w.webp 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-640w.webp 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-1920w.jpg 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-1280w.jpg 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-640w.jpg 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-1920w.jpg height=536 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 536'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAj0lEQVQI10WNMQrFIBBEvalHSOUJAtYBC0tDCsUy6b2GZcBK7NIlhWZ+XEj+wM4Muw+W4VFrrQdyzogxUq+1Ut73DdatT9eyLOCc49ULsm6lFAzDgJTSB4cQPpCg4zgwjiPO86TDNE3w3v/faa1hraWFUgrOOer7vkMIgeu6wOZ5xrZtdDDGYF3XD5JSEvQDCXG+e6OV88AAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>看到這裡有自己設計過 DB Schema 的朋友們可能就會好奇，</p><blockquote><p>“咦但是有時候我同一張 table 裡面會有好幾個 column 會設成 index 耶</p></blockquote><blockquote><p>那這樣資料庫要以哪個為基準排序啊？”</p></blockquote><p>在討論這個問題前我們必須先瞭解兩個概念：clustered index 和 non-clustered index。</p><h3 id=clustered-index-%E8%88%87-non-clustered-index><a href=#clustered-index-%E8%88%87-non-clustered-index class=direct-link>#</a> Clustered Index 與 Non-Clustered Index</h3><p>如果要用一句話概括說明這兩者的差異，可以說 Clustered Index 是“完整資料(包含所有 column）在 Storage 中實際上的排序依據 ” 而 Non-clustered Index則是 “跟完整資料分開來放的欄位子集合的排序依據”。</p><p>說得白話一點就是完整的資料在 storage 裡面用 clustered-index 當作排序依據， clustered-index 相近的資料在 storage 中也會在比較接近的位置。 且因爲他是實際上 storage 在 partition 資料時的依據，所以只能有一個 clustered index。</p><p>而資料庫會另外複製幾份被使用者選為 non-clustered index 的 column 資料， 在其他 storage 的空間創造只包含這些 non-clustered index 的資料結構。每多一個 index 就多創造一份。而這些 non-clustered index 跟實際上 storage中的資料的物理位置沒有直接的關連。</p><p>以上面的例子為例， id（預設是 Primary Key）就是 clustered index ，而如果使用者在 name 和 height 上都 create index 的話（預設狀況 create 新的 index 就是 non-clustered index），資料庫會創造出額外的兩份複製的子集合資料結構。</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-1920w.avif 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-1280w.avif 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-640w.avif 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-1920w.webp 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-1280w.webp 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-640w.webp 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-1920w.jpg 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-1280w.jpg 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-640w.jpg 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-1920w.jpg height=485 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 485'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmElEQVQI10WNPQrFIBCEPZ2YPr2XEDxLinTpIikscoWAtY1twNoiEMifk+eCeVN9OzPsMPyUc0aVUgp93xPf9/1lrMK2bUgpoes6WGvJe57nX7yui0BrDSnl97lpGkzTRFw6rE6EEOC9Jy6a55nuKuacA+cc53mS0bYtxnEkXpYFQgjs+w4WY8QwDDiOg0JjzPdpXVfKyvQLXtDTn7rjGUwAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-1920w.avif 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-1280w.avif 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-640w.avif 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-1920w.webp 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-1280w.webp 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-640w.webp 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-1920w.jpg 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-1280w.jpg 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-640w.jpg 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-1920w.jpg height=580 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 580'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAqklEQVQY0z2PIQ6AMAxFdxcsDq7BAXayTWHw6AWJ3SQZAkMCgoQEC4TBZx1hX+x37ctPy57nwXVdIG/bFvM8g+S8yH1fMRr+yrIMUsr/6+77JleMXiEEmqbBeZ7Ytg11XWMcx5DkwQ8qigJlWcbEPM9RVVWA/CqK9X0fh/u+Q2sd0tZ1dV3XfRDnPEIEJEmCZVlgjHFpmsJaq9g0TRGinYZhoMtwHIejmpJeZVjdV7stp4sAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>這兩個新的 tree 分別各自以不同的 non-clustered index 進行排序.。當使用者要查詢資料時， 資料庫就會從判斷指令中的條件使用的欄位是否是有被設為index 的欄位，有的話就會從對應的 tree 裡面尋找。</p><p>例如下 <strong>SELECT * WHERE Height > 165</strong> ，資料庫不會從圖一中原本包含完整資料的結構中尋找， 而是會從複製出來的圖二的結構中尋找對應的 node。</p><p>然而眼尖的朋友可能發現, 如果是**SELECT ***的話，就算在圖二的 tree 中找到了需要的 nodes，裡面也沒有包含其他欄位的資料讓我回傳啊！</p><p>一個可能的解法是在 create index 時下<strong>INCLUDE</strong> clause ，可以讓資料庫在創建新的 non-clustered index tree 時把被 include 的欄位資料一起放進去。 但是如果 table 中的欄位很多，那這樣每次要 create 新的 index 時創造出來的新的tree 就會無敵大，對 storage 是一個大負荷。</p><p>所以實際上除了用 clustered index 排序的原本資料外，這些額外的 index tree的節點都還包括了一個 field，放的正是 clustered index。 例如圖二以 height 當non-clustered index 的 tree 中實際上會有額外對應的 clustered index (此例中也就是 id )</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-1920w.avif 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-1280w.avif 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-640w.avif 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-1920w.webp 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-1280w.webp 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-640w.webp 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-1920w.jpg 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-1280w.jpg 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-640w.jpg 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-1920w.jpg height=452 width=752 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 752 452'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAIAAAB1kpiRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAiklEQVQI10WMPQrEIBSEvZx9riOphHgGsfEEdhILm4BHkFwghbVVCv+yGVbYfcWbb2ZgyOd7vXd8rfW6roAxxszJlFprKcVaq5Rqrf1rGIgxhlI6Nxhj27bNSfI8D+i6rhACBsDHcXjvAahIznlZlhgjPOdcCAGY4Xme5L5vKWVKCalzbt93wC98Acq3l9tjOpQOAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p><strong>SELECT * WHERE Height > 165</strong>這個指令在查詢時就會變成先從此樹中找到符合條件的node，再用對應的clustered index(id)去圖一中的樹查詢。</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-1920w.avif 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-1280w.avif 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-640w.avif 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-1920w.webp 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-1280w.webp 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-640w.webp 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-1920w.jpg 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-1280w.jpg 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-640w.jpg 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-1920w.jpg height=303 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 303'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAYAAACeuGYRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA10lEQVQY0z2OQWuDQBSE95/nUAK5BgwlIRdb6EmkuetB/QNB0K5CvCS4ZVM3MbGbuOpO10Azp+Ex75shWmtIKZGmCfhhD/Q9/nVtGvxUFSiluNS1lrcbhmHgRCmF9n7HYj4HTVMMxldlifp4RPfbYEe/8GpZEIxpZu6mgJPOkF8mE8iTgP32jjCKnk3xdov1avnws+lUX87n0XLiui6EEPiwbTRmju/7SJIEWZYhDCOUjOFzs0GrlHYcB9+McRIEwbgTnuc9iONDnucoigJxHD9BRnrMcqM/BfjoXNXtLhsAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>以上這個流程就是 ＭySQL-Innodb 中用 index 加速資料查詢的流程和原理</p><p>看來很完美！ 收工～</p><p>..</p><p>…</p><p>……</p><p>然而現實總是殘酷的， 這樣的流程有個潛在的大問題。</p><p>先從 non-clustered index 取得 clustered index 再去查詢，看起來只是從查詢一次變成兩次而已， 然而實際上如果進行非常大範圍的Range Query， non-clustered index一個range中對應的clustered-index資料在實際硬碟的存放位置是非常散亂的，這個查詢clustered-index tree的步驟會在Storage中發生非常巨量的Random Access,效能的大幅下降是可以預期。</p><p>如果我們想要 Select 全部的欄位，但是卻不想要回去 clustered-index tree 裡面查詢， 有辦法嗎？</p><h3 id=postgresql%E7%9A%84%E8%A7%A3%E6%B3%95%EF%BC%9A><a href=#postgresql%E7%9A%84%E8%A7%A3%E6%B3%95%EF%BC%9A class=direct-link>#</a> PostgreSQL的解法：</h3><p>PostgreSQL看到了 MySQL-Innodb 中這樣的痛點， 所以在設計上採取了一個策略 ： 不使用 clustered index tree。</p><p>沒有 clustered index 意味著的就是完整的原始資料無法進行排序（因為沒有排序的依據） 在 PostgreSQL 的中存放完整資料的地方稱之為 Heap。 這個Heap 是個無序的結構，每一筆資料存在 storage 中是不給予這些資料順序任何的保證的。</p><p>而 non-clustered index 的部分,，PostgreSQL 則是從在每個 node 裡面儲存Clustered-index，改成儲存一個指向 Heap 中對應完整資料的 row 所在位置的指標. (注意此處的指標不是 memory 的指標，而是用來在資料庫中標記唯一所在位置的 <a href=https://www.postgresql.org/docs/8.0/storage-page-layout.html rel="noopener noreferrer" target=_blank>Page</a> 的資訊) *</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-1920w.avif 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-1280w.avif 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-640w.avif 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-1920w.webp 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-1280w.webp 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-640w.webp 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-1920w.jpg 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-1280w.jpg 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-640w.jpg 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-1920w.jpg height=284 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 284'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAYAAACeuGYRAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA50lEQVQY0yWPv0vDUBSF8x9XSrKIkEmRvDZbSBcdpIMYtXRy6VKDOoi4hAZsjUVaSKaktsT88OUzrz1wuXDu5X7nakmSEMcxaZpSliVSSpR+i4Isy4iiiMfplDzPZVVVahRoQggcx0GIHudnp6wXc2gkf3VNU1e8+D7uYKCWZd167dFA03Ud0zQxDAO92yV6e6VYfUO+xTo5xp9M9uSjTkdud7sDybZtXNel37fpWRbr+QdsUq4vL1h9Lnh/fuJhPKb42cg774av5TLQVE6FVV1Vw0FXwyFZ+2c4m3E/Gu3j3XoeYRgG/62b3hElTZQcAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><blockquote><p>看到這裡可能會有人想問,“那為何 MySQL不也直接在 Non-clustered index tree的 node 中存放指標就好了？</p></blockquote><p>這點也正是 PostgreSQL 以 Heap 存放原始完整資料的主要原因. 因為 Heap 不保證資料順序,所以任何資料被 update 或 insert ，現有的其他資料都不需要變更存放的位置, 相較之下 Innodb 因為是依照 clustered index 來排序,任何資料的 clustered index 被更改或插入新的資料都會造成其他資料的存放位置依照index 發生相對應的變化。<br>（以 B-Tree 來說, 會為了維持 tree 的 balance 而發生樹的結構的變化，因為clustered index 必須反映實際物理位置，所以 clustered index 順序更新必須同時更新 disk 中的資料位置, 造成大量的時間消耗）</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-1920w.avif 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-1280w.avif 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-640w.avif 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-1920w.webp 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-1280w.webp 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-640w.webp 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-1920w.jpg 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-1280w.jpg 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-640w.jpg 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-1920w.jpg height=492 width=800 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 492'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAeElEQVQI1z2N2w5FERBD/f9/iheCEHczR8c+JPUwXW1Va4211iJjDDvnOOf8F6WUeIwxFREx4FqrCEYphXvvAvJ9U+HHEdBJvgBg7z3NOS+IRsyEEB4UY5SV004Iv0bAmIS51uK9N38Aff4FAZ0ZaQZsrRWd9gf+ALuY6U1a129mAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>正是因為資料位置的不變的特性，讓 PostgreSQL 的指標實現成為可能。所以在PostgreSQL 中，用 Non-clustered index 查詢資料，不需要再跑去 clustered index tree 裡面查詢，直接拿指標位置去 storage 裡面對應的 Page 取出資料即可。</p><p>然而這樣的設計並非沒有 Trade-Off 的。</p><p>儘管在用 Non-clustered Index 進行 <strong>SELECT *</strong> 之類的查詢時會因為少一次tree lookup 而有效率上的提升。但因為這種實現方式完全捨棄了 clustered-index，所以如果是用 primary key（以Innodb 來說就是 clustered index ） 來查詢， 反而會多了一個用指標查詢的步驟。</p><p>且因為 Heap 沒有辦法保證任何資料在物理上的 Locality（在前面提過, clustered index 才有辦法保證 index 跟 storage 中物理位置的相似性），所以無法像 MySQL-Innodb 一樣以 clustered-index 進行 Range Query 時有Locality的優勢。</p><p>綜上所述，我們大致可以把這兩種資料庫實現Indexing的方式用以下幾點歸納：</p><p><picture><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-1920w.avif 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-1280w.avif 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-640w.avif 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-320w.avif 320w" type=image/avif><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-1920w.webp 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-1280w.webp 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-640w.webp 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-320w.webp 320w" type=image/webp><source sizes="(max-width: 608px) 100vw, 608px" srcset="/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-1920w.jpg 1920w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-1280w.jpg 1280w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-640w.jpg 640w, /img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-320w.jpg 320w" type=image/jpeg><img alt="" src=/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-1920w.jpg height=319 width=754 decoding=async loading=lazy style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 754 319'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAFCAIAAAD+GJp4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAxElEQVQI1wG5AEb/AH6IkVtqeF5pdmyCmH6dvn2auX6dvYChw3+ewIKgv4aoy5Gw0ABEbZYUTYkUUI9Kd6OQqb+QrMeZt9KUscyMpr+TrsibuNSkv9gAU4CwJmaqJGarWYa0nrPFk6rAobrRobrRk6m+nLTKnrbOrMPYAFGBsyJjpiBjqliHt6K4y5640abB2qfC26XA2qzH4a7L5rTO5QBYgawsZJ0raKdkkLy0y+Cqxd6mv9apw9qsxt6rxNulvtawx9xCk2/MrQfMCwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>以剛剛包含了 id、 Name 跟 Height 的 table (person) 為例 ：（當然以下的前提都是資料的 rows 非常非常多的狀況，且我們把 id、Name、 Height 都 create Index）</p><p>SELECT p.*<br>FROM person p<br>WHERE p.Height &lt; 170;</p><p>對這樣的指令來說， 因為要 Select 全部的欄位， 而查詢條件是 non-clustered index, 所以根據我們前面所說，因為 MySQL-Innodb 還必須去 clustered index tree 裡面搜尋一遍，是可以預期 PostgreSQL 是比較快的。</p><p>SELECT p.*<br>FROM person p<br>WHERE <a href=http://p.id rel="noopener noreferrer" target=_blank>p.id</a> > 18;</p><p>這個指令，儘管要 Select 全部的欄位,但因為 id 是 clustered index， 用id來當作查詢條件時對 Innodb 來說就直接在 clusterd index tree 裡面搜尋了，找到就可直接回傳。而對 PostgreSQL 來說因為id仍然是 non-clusterd index (跟 Heap 分開的)， 所以 PostgreSQL 反而還會多了一次用指標去資料庫把資料撈出來的步驟。 因此這樣的操作是可以預期 MySQL 是有優勢的。</p><p>SELECT <a href=http://p.Name rel="noopener noreferrer" target=_blank>p.Name</a><br>FROM person p<br>WHERE <a href=http://p.Name rel="noopener noreferrer" target=_blank>p.Name</a> = "David";</p><p>至於這個指令，因為要回傳的 column 就是 non-clustered index，所以不論是Innodb 還是 PostgreSQL 都只要在查詢 non-clustered index tree 時直接回傳Name 就好了， 跟 Clustered Index tree 和 Heap 都沒關係，所以兩者的資料儲存方式不同不會讓這樣的查詢有太大效能差異。</p><h4 id=%E7%B5%90%E8%AB%96-%3A><a href=#%E7%B5%90%E8%AB%96-%3A class=direct-link>#</a> 結論 :</h4><p>一般來說如果用 Primary Key 來查詢時，因為 MySQL-Innodb 是用 Clustered-index， 所以速度較快，尤其在進行 Range Query 時因為 clustered-index在Storage 中的 locality，所以速度會大幅提升。</p><p>而如果是需要經常對不同欄位進行檢索的 Table， 因為 PostgreSQL 在 non-clustered index 的資料結構的節點中有直接存放實際資料的位置，所以速度會比起要再次去 clustered index 資料結構查詢的 MySQL-Innodb來的快。</p><p>另外，當要 select 的欄位全部都被 include 在 non-clustered index 的資料結構中時，理論上兩者的效率便不會有太大的差別。（不過， INCLUDE clause只支援 PostgreSQL11 以後的版本，因此如果 PostgreSQL 沒有 INCLUDE 的話Innodb 還是會快一些的）</p><div class=article-footer><a href=https://tech-blog.cymetrics.io/posts/maxchiu/indexing/ on-click=share><img alt=Share src="/img/icons/icon_external link hyperlink.svg" height=24 width=24>Share this post</a></div><div class=article-author><img alt=maxchiu src=/img/authors/max_logo.jpeg class=article-author__img data-deopt=true><div class=article-author__info><div class=article-author__title>Author</div><div class=article-author__author><a href=/posts/maxchiu>maxchiu</a></div><div class=article-author__intro>Fullstack rookie, also love developing games and visual computing</div></div></div><script async src=https://utteranc.es/client.js crossorigin=anonymous id=utterance-script issue-term=title label=utterance repo=cymetrics/blog theme=github-light></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"從Indexing的角度切入MySQL-Innodb與PostgreSQL的效能比較","image":["https://tech-blog.cymetrics.io/img/posts/max/IndexingComparisonOfMySQLAndPostgres/1__D99fysQ1Z0zfpa390g4QvQ.gif","https://tech-blog.cymetrics.io/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__lAtWJh8SO8RBVIxR-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vIig59JPmcPAXOZ9-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__vsWcHf9LzLOdY__D3-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__oM__jfRfuw6nkKmE5-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__FgE15QZVAhf__hZhu-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__y9JhQLyEkTuIgTJQ-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__fHXzicHiDkxS1uTE-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/max/IndexingComparisonOfMySQLAndPostgres/0__ZXKx4__FyY7rop1wV-1920w.jpg","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/max_logo.jpeg"],"author":"maxchiu","publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-192x192.png"}},"url":"https://tech-blog.cymetrics.io/posts/maxchiu/indexing/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/maxchiu/indexing/","datePublished":"2021-03-12","dateModified":"2021-07-29","description":"如果你用的資料庫是屬於 Relational Database ，在這個年代用SQL進行資料庫的存取已經變成一件理所當然的事了。MySQL 、PostgreSQL 、MsSQL…不論是開源抑或是由大廠主導的 SQL 專案都擁有各自的擁護者 。..."}</script></article></main><footer><div class=footer-logos><a href=https://www.facebook.com/Cymetrics-100957872049641 rel="noopener noreferrer" target=_blank><img alt=facebook src="/img/icons/icon_social media_facebook.svg" height=30 width=30></a><a href=https://www.linkedin.com/company/onedegree-hk rel="noopener noreferrer" target=_blank><img alt=linkedin src="/img/icons/icon_social media_linkedln.svg" height=30 width=30></a><a href=https://tech-blog.cymetrics.io/feed/feed.xml rel="noreferrer noopener" target=_blank><img alt="rss feed" src=/img/icons/rss-feed.svg height=30 width=30></a></div><div class=copyright>© 2021 Cymetrics Tech Blog</div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })
      

      /*
      const toggleEl = document.querySelector('#color-scheme-toggle')
      const bodyEl = document.querySelector('body');
      const DARK = 'dark';
      const LIGHT = 'light';
      const currentTheme = localStorage.getItem("theme") ||
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK : LIGHT);
      setTheme(currentTheme)

      toggleEl.addEventListener("click", handleToggleEvent)

      function handleToggleEvent(){
        const isDark = bodyEl.classList.toggle(DARK);
        const theme = isDark ? DARK : LIGHT;
        setTheme(theme)
        localStorage.setItem('theme', theme);
      }
      function setTheme(theme){
        if (theme === DARK) {
          setUtterancesTheme(DARK)
          bodyEl.classList.add(DARK);
          toggleEl.src = toggleEl.src.replace(DARK, LIGHT);
        }else{
          setUtterancesTheme(LIGHT)
          toggleEl.src = toggleEl.src.replace(LIGHT, DARK);
        }
      }

      var isUtterancesLoaded = false
      window.addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') {
          return;
        }
        isUtterancesLoaded = true
      });

      function setUtterancesTheme(theme) {
        let utterancesIframe = document.querySelector('.utterances iframe')
        if (!isUtterancesLoaded) {
          return requestAnimationFrame(() => setUtterancesTheme(theme))
        }

        utterancesIframe.contentWindow.postMessage({
          type: 'set-theme',
          theme: theme === DARK ? 'github-dark-orange' : 'github-light'
        }, 'https://utteranc.es');
      }
    */</script></body></html>