<!DOCTYPE html><html domain="tech-blog.cymetrics.io" ga-id="G-3VBVCXV9Z0" lang="zh-TW"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><meta content="CYBER,Cymetrics,Security" name="keywords"><link href="/img/favicon/favicon-192x192.png?hash=42b087227d" rel="icon" type="image/png"><meta content="#5789d3" name="theme-color"><title>那些隱藏在 CDN 中的危險：為什麼 CDN 可能沒有你想的那麼安全</title><meta content="那些隱藏在 CDN 中的危險：為什麼 CDN 可能沒有你想的那麼安全" property="og:title"><meta content="那些隱藏在 CDN 中的危險：為什麼 CDN 可能沒有你想的那麼安全" name="twitter:title"><meta content="summary_large_image" name="twitter:card"><meta content="內容分發網絡 (CDN) 是現代網際網路占比相當重要的一個部分，它為全世界的使用者提供快速可靠的連結與與網路資源。但是，儘管 CDN 提供了許多好處，它們也會引入許多人可能不知道的新的安全風險。本文中將探討 CDN 的隱藏危險，並探討為什麼 CDN 可能不像你想像的那麼安全。透過簡單介紹 CDN 可能引入的各種漏洞，探討如何保護自己和您的企業免受這些威脅。本文可幫助您更好地了解 CDN 所涉及的潛在風險及其如何緩解這些風險。" name="description"><meta content="內容分發網絡 (CDN) 是現代網際網路占比相當重要的一個部分，它為全世界的使用者提供快速可靠的連結與與網路資源。但是，儘管 CDN 提供了許多好處，它們也會引入許多人可能不知道的新的安全風險。本文中將探討 CDN 的隱藏危險，並探討為什麼 CDN 可能不像你想像的那麼安全。透過簡單介紹 CDN 可能引入的各種漏洞，探討如何保護自己和您的企業免受這些威脅。本文可幫助您更好地了解 CDN 所涉及的潛在風險及其如何緩解這些風險。" name="twitter:description"><meta content="內容分發網絡 (CDN) 是現代網際網路占比相當重要的一個部分，它為全世界的使用者提供快速可靠的連結與與網路資源。但是，儘管 CDN 提供了許多好處，它們也會引入許多人可能不知道的新的安全風險。本文中將探討 CDN 的隱藏危險，並探討為什麼 CDN 可能不像你想像的那麼安全。透過簡單介紹 CDN 可能引入的各種漏洞，探討如何保護自己和您的企業免受這些威脅。本文可幫助您更好地了解 CDN 所涉及的潛在風險及其如何緩解這些風險。" property="og:description"><meta content="article" property="og:type"><meta content="https://tech-blog.cymetrics.io/posts/seadog007/dangers-in-cdn/" property="og:url"><link href="https://tech-blog.cymetrics.io/posts/seadog007/dangers-in-cdn/" rel="canonical"><meta content="Cymetrics Tech Blog" property="og:site_name"><meta content="https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/cover.png" property="og:image"><meta content="https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/cover.png" name="twitter:image"><meta content="hsZQwAip9iIbys-i4PJp_MfpNiA6w6RB0hYdWLiLUuk" name="google-site-verification"><meta content="always" name="referrer"><link href="/feed/feed.xml" rel="alternate" type="application/atom+xml" title="Cymetrics Tech Blog"><link href="/" rel="preconnect" crossorigin=""><script async="" src="/js/min.js?hash=7f26b2ece8" defer=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3VBVCXV9Z0"></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-3VBVCXV9Z0');</script><script csp-hash="">if (/Mac OS X/.test(navigator.userAgent))document.documentElement.classList.add('apple')</script><style>:root{--primary-color: #5789d3;--primary-dark-color: #ffd349;--fgColor: #2f2f2f;--bgColor: linear-gradient(to top, #efefef, #ffffff);--primary: var(--primary-color);--primary-dark: var(--primary-dark-color);--fg: var(--fgColor);--bg: var(--bgColor);--progressColor: #ffd349;--main-width: calc(100vw - 3em)}main img{content-visibility:auto}article *{scroll-margin-top:50px}header nav{z-index:1;position:fixed;top:0;left:0;width:100vw;background:#fff;font-weight:200;text-align:right;padding:0}@media (min-width:37.5em){:root{--main-width: calc(37.5em - 3em)}}dialog,share-widget{position:fixed;opacity:.9}share-widget{right:20px;bottom:20px;width:50px;height:50px;border-radius:50%;overflow:hidden;box-shadow:2px 3px 5px 2px rgba(0,0,0,.2)}@media screen and (max-width:376px){share-widget{display:none}}share-widget div{margin-left:50%;transform:translateX(-50%);width:20px;height:20px;background-image:url(/img/share.svg);background-repeat:no-repeat;background-position:center;background-size:contain}.apple share-widget div{background-image:url(/img/share-apple.svg)}share-widget button{margin:0;padding:0;width:100%;height:100%;transition:.3s}share-widget button:active{transform:scale(1.2)}dialog{background-color:var(--primary-dark);z-index:1000;font-size:14px}#reading-progress{z-index:1;background-color:var(--progressColor);width:100vw;position:absolute;left:0;bottom:0;height:2px;transform:translate(-100vw,0);will-change:transform;pointer-events:none}#posts li{margin-bottom:.5em}button,html{line-height:1.15}html{-webkit-text-size-adjust:100%;font-family:"Open Sans",-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Helvetica,Arial,"Noto Sans TC","PingFang TC","Hiragino Sans GB","Heiti TC","Microsoft YaHei","Microsoft Jhenghei",sans-serif;--font-family: "Open Sans", -apple-system, system-ui, BlinkMacSystemFont,
    "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Helvetica, Arial,
    "Noto Sans TC", "PingFang TC", "Hiragino Sans GB", "Heiti TC",
    "Microsoft YaHei", "Microsoft Jhenghei", sans-serif}body{margin:0}body.lock{overflow:hidden}a{background-color:transparent;text-underline-offset:2px;text-decoration:none;color:var(--primary)}b{font-weight:700}code{overflow-x:auto;border-radius:.3em;color:#e33671;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:90%}img{border-style:none;max-width:100%;height:auto;margin:0 auto}button{font-family:inherit;font-size:100%;overflow:visible;text-transform:none}[type=button],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}h2{font-size:2.5em;line-height:1.2;margin-bottom:.6em;line-height:2.4rem;margin-bottom:1.36rem;font-size:1.728rem}h3{font-size:2em;line-height:1.125;margin-bottom:.75em;font-size:1.4rem}h4{font-size:1.5em;margin-bottom:1em;line-height:1.5em}body,ol,p,ul{font-size:1em}ol,p,ul{margin-bottom:1.5em}h3,h4{line-height:1.5rem;margin-bottom:1rem}h4{font-size:1.2rem}body,ol,p,ul{font-size:1rem;line-height:1.6}ol,p,ul{margin-bottom:1.36rem}@media (min-width:600px){h2{font-size:2.0097rem;line-height:2.52rem}h3{font-size:1.7989rem;line-height:2rem}h4{font-size:1.3554rem;line-height:1.56rem;margin-bottom:1.296rem}body,ol,p,ul{font-size:1.1rem;line-height:1.6}h2,h3,ol,p,ul{margin-bottom:1.496rem}}@media (min-width:1200px){h2{font-size:2.05rem}h3{font-size:1.5rem}h4{font-size:1.15rem;line-height:1.42rem;margin-bottom:1.2rem}body,ol,p,ul{font-size:1.2rem;line-height:1.6}h2,h3,ol,p,ul{margin-bottom:1.632rem}}h1,h2,h3,h4{font-family:var(--font-family)}a:hover{text-decoration:underline}button{border-radius:.3em;max-width:100%;background:#f2f2f2;color:#191919;cursor:pointer;padding:.75em 1.5em;text-align:center;margin:0 .75em 1.5em 0}button+label,label+*{page-break-before:always}button,label{display:inline-block}button:hover{background:#d9d9d9;color:#000}button:not([disabled]){background:#f9c412;color:#181818;background:var(--primary)}button:not([disabled]):hover{background:#ba9005;color:#000;background:var(--primary-dark)}*{border:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg);color:var(--fg)}header label{display:block}article,header{max-width:100%;width:42.5em;margin:0 auto}header{padding:4.5em 24px 0;text-align:center;display:flex;align-items:center;flex-direction:column}header p,ol,ul{margin-top:0}header nav .nav-title{float:left;font-size:inherit;line-height:inherit;margin:0;text-align:left}header nav label{color:#000;cursor:pointer;margin:0;font-style:normal;text-align:right}main{max-width:70rem;margin:0 auto;min-height:60vh}article{padding:1.5em;word-break:break-word}li ol,li ul{margin-bottom:0}::-webkit-scrollbar-thumb:hover{background:var(--primary)}.w-full{width:100%}body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}@media (prefers-color-scheme:dark){body.dark{--fg: var(--bgColor);--bg: var(--fgColor);--primary: var(--primary-dark-color)}}h1{font-size:32px;line-height:1.25;margin:.67em 0;text-align:left}header aside{font-size:16px;color:#4b4b4b}.post,footer{border-top:1px solid #ccc}.post{padding-top:35px;margin-top:35px}.menu__btn{display:inline-block;width:24px;height:24px;position:relative}.menu__btn span{opacity:0;width:1px;height:1px;overflow:hidden;display:block}.menu__btn::after,.menu__btn::before{content:"";position:absolute;top:51%;left:50%;height:2px;width:17px;background-color:#2d2d2d;border-radius:.1rem}.menu__btn::before{transform:translate(-50%,-50%);box-shadow:0 .3rem 0 #2d2d2d,0 -.3rem 0 #2d2d2d}.menu__btn::after{display:none;transform:translate(-50%,-50%) rotate(90deg)}.menu__btn.menu__btn--close{z-index:9;transform:rotate(45deg)}.menu__btn.menu__btn--close::before{box-shadow:none}.menu__btn.menu__btn--close::after{display:block}#nav,#nav .nav-title{display:flex;align-items:center}#nav{position:relative;height:68px;z-index:2}#nav .nav-title{padding:.375rem 1.5rem;width:100%;justify-content:space-between}#nav .nav-title *,.article-footer img{margin:0}.nav__links{display:none;flex-direction:column;position:fixed;z-index:3;top:0;left:0;right:0;bottom:0;padding:86px 48px 0;background-image:linear-gradient(to top,#efefef,#fff),linear-gradient(to bottom,#f9f9f9,#f9f9f9)}.nav__links--open{display:flex}.nav__links a{text-align:left;width:100%;padding:.5rem 0;transition:all .3s ease-out;font-weight:700;text-decoration:none;color:var(--fg)}.nav__links a:hover{color:var(--primary-color)}.nav-logo{width:260px;height:40px;background:url(/img/logo1.png) no-repeat center center;background-size:contain}footer{margin-top:48px;font-size:14px;padding:24px;text-align:center}.copyright{display:inline-block}footer>*{margin:.5em}.footer-logos{display:flex;align-items:center;justify-content:center}.footer-logos a:not(:first-child){margin-left:32px}.post-tags{display:flex;gap:0 16px;flex-wrap:wrap}.direct-link{display:none}.post-avatar{margin-top:27px;display:flex;align-items:center;height:36px}.post-avatar__img{width:36px;height:36px;overflow:hidden;margin:0;border-radius:50%}.post-avatar__time{font-size:13px}.post-avatar__info{margin-left:8px;color:#747474;text-align:left}.post-avatar__author{font-size:14px;font-weight:700}.article-footer{margin-top:40px;border-bottom:1px solid #ccc;padding-bottom:52px}.article-footer a{float:right;display:flex;align-items:center;color:var(--fg);font-weight:700;margin-left:4px}.article-author{margin-top:34px;display:flex;align-items:flex-start;margin-bottom:48px}.article-author__img{width:80px;height:80px;overflow:hidden;margin:0;border-radius:50%;flex-shrink:0}.article-author__info{margin-left:16px;text-align:left}.article-author__title{color:#747474;font-size:16px}.article-author__author{font-size:22px;font-weight:700;line-height:1em}.article-author__intro{color:#2f2f2f;margin-top:8px}@media (min-width:768px){h1{font-size:48px}header aside{font-size:20px}header nav a:first-of-type{margin-left:auto}header nav a:last-of-type{margin-right:1.5em}.menu__btn{display:none}#nav,footer{max-width:1168px}#nav{height:80px;margin:0 auto}.nav-logo{width:313px}.nav__links{display:flex;flex-direction:row;position:static;padding:0;background-image:none}.nav__links a{text-align:center;margin-left:56px}footer{display:flex;flex-direction:row-reverse;justify-content:space-between;align-items:center;margin-left:auto;margin-right:auto}}.notice-block{text-align:left;background:rgba(87,137,211,.2);padding:16px;margin-top:24px;border-radius:8px}</style></head><body><header><nav><div id="nav"><div class="nav-title"><a href="/" class="nav-logo" title="Homepage"></a> <label class="menu__btn" for="menu__control"><span>Menu</span></label></div><div class="nav__links"><a href="/archive/">Archive</a> <a href="/tags/">Tags</a> <a href="/about/">About</a> <a href="/en">English</a></div></div><div id="reading-progress" aria-hidden="true"></div></nav><h1 class="w-full">那些隱藏在 CDN 中的危險：為什麼 CDN 可能沒有你想的那麼安全</h1><aside class="w-full"><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/cdn/" class="post-tag">#CDN</a> <a href="/tags/cloud/" class="post-tag">#Cloud</a> <a href="/tags/internet/" class="post-tag">#Internet</a> <a href="/tags/network/" class="post-tag">#Network</a> <a href="/tags/networking/" class="post-tag">#Networking</a></div><div class="post-avatar"><img alt="seadog007" src="/img/authors/seadog007_logo.png" class="post-avatar__img" data-deopt="true"><div class="post-avatar__info"><div class="post-avatar__author"><a href="/posts/seadog007">seadog007</a></div><div class="post-avatar__time">02 Jun 2023</div></div></div><div class="notice-block" data-nosnippet="" style="display:none;">我們正在尋找一位 Security Engineer 加入我們的團隊，詳情請參考<a href="https://github.com/cymetrics/blog/issues/13" rel="noopener noreferrer" target="_blank">職缺資訊</a></div></aside><dialog id="message"></dialog></header><main><article><div id="post-page"></div><p>內容分發網絡 (CDN) 是現代網際網路占比相當重要的一個部分，它為全世界的使用者提供快速可靠的連結與與網路資源。但是，儘管 CDN 提供了許多好處，它們也會引入許多人可能不知道的新的安全風險。本文中將探討 CDN 的隱藏危險，並探討為什麼 CDN 可能不像你想像的那麼安全。透過簡單介紹 CDN 可能引入的各種漏洞，探討如何保護自己和您的企業免受這些威脅。本文可幫助您更好地了解 CDN 所涉及的潛在風險及其如何緩解這些風險。</p><h2 id="cdn-%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F"><a href="#cdn-%E6%98%AF%E4%BB%80%E9%BA%BC%EF%BC%9F" class="direct-link">#</a> CDN 是什麼？</h2><p>CDN 英文全稱為 Content Delivery Network 或者 Content Distribution Network，中譯為內容分發網路</p><p>對於 CDN 的介紹，其實不少公司都寫得蠻詳細的，像是做 CDN 起家的大廠 Cloudflare 就有做過詳細的介紹</p><ul><li><a href="https://www.cloudflare.com/zh-tw/learning/cdn/what-is-a-cdn/" rel="noopener noreferrer" target="_blank">什麼是 CDN？</a></li></ul><p>在這邊要簡單介紹一下，CDN 基本上就是一組放在不同地方的 Server，這些 Server 提供附近的使用者存取相關網頁，藉此來達到多種不同的功能。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cdn_cf-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/cdn_cf-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/cdn_cf-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/cdn_cf-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cdn_cf-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/cdn_cf-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/cdn_cf-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/cdn_cf-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/cdn_cf-1920w.png" height="2834" width="5667" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 5667 2834'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAIAAAAcxIEBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkklEQVQImTXKuw6CMBgGUN7/nVwMDhqNEEEoLcjgjSC1hba0/xcTQ6LLmU4kLApNqcS+p0QSt2AGuaZcUzlBOETCIhkQN++ks3wK6eDjW1i1i5mi2iGqHRr/ybqRvXSl3Lq1u8e8uYaTpIvHbzBluQnbuy/HcHi6Y+9rh1QSm/6jGAzTc65IOHCLyoAbnBVVZhlf5fSWvjtOs5QAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br>(Source: <a href="https://www.cloudflare.com/zh-tw/learning/cdn/what-is-a-cdn/" rel="noopener noreferrer" target="_blank">Cloudflare Blog</a>)</p><h3 id="%E7%82%BA%E4%BB%80%E9%BA%BC%E8%A6%81%E7%94%A8-cdn"><a href="#%E7%82%BA%E4%BB%80%E9%BA%BC%E8%A6%81%E7%94%A8-cdn" class="direct-link">#</a> 為什麼要用 CDN</h3><p>「用自己的伺服器直接讓使用者連線不行嗎？為什麼我們會需要使用 CDN？」<br>你可能會這樣想，但實際上因為 CDN 業者所擁有的資源與提供的不同功能，所以使用 CDN 在較大型的網站上已經變為常態。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cdn_benifit-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/cdn_benifit-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/cdn_benifit-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/cdn_benifit-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cdn_benifit-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/cdn_benifit-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/cdn_benifit-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/cdn_benifit-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/cdn_benifit-1920w.png" height="896" width="2124" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2124 896'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAFCAYAAABxeg0vAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAx0lEQVQImSWN20rDQABE8/v2P9QHoQQUtKCCSCjFK9ZWeom0iaCmLdlssrekzZGN8zbDOUygjMbWjmgY8T4Z43M1uOT55YkDLYvlnN9NhnEWzwbaGrRzhBcD7ocP7IGz/jl30aiTR4+vxKuU5rD/FyqtELJAWdeJvjdti3F1t9umQRlDXgi0F9ZpwvXtTXeZfKUcn55ga8sqWdMPQ2Ql8cxRr0dRlgTbXDCLUypj+M52vE2XSKXIdjnjjxhRVvxsciazT7ZC8gelityVlvcNjAAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>舉例來說，因為 CDN 廠商所放置的伺服器與網路節點存在世界各地，最主要的功能就是可以幫購買 CDN 服務的用戶節省原伺服器的頻寬，同個地區的使用者存取同一靜態資源，可以經由 CDN 的暫存，就不用再連回原本伺服器，節省原站頻寬。並可以接收來自該區域的 DDoS 流量，做第一層的阻擋。</p><p>CDN 因為站點分佈廣，所以也可以提供相對應地區的使用者較低的連線延遲，改善連線速度。</p><p>CDN 也大多會提供 HTTPS Reverse Proxy 的服務，將原本沒有 HTTPS 的服務加上 HTTPS 作保護。</p><p>有些 CDN 甚至提供 WAF / IP 規則等的保護，可以保護後面的主機不受惡意攻擊。也可以起到避免攻擊者拿到原站 IP 的作用。</p><h3 id="cdn-%E6%98%AF%E6%80%8E%E9%BA%BC%E9%81%8B%E4%BD%9C%E7%9A%84%E5%91%A2%EF%BC%9F"><a href="#cdn-%E6%98%AF%E6%80%8E%E9%BA%BC%E9%81%8B%E4%BD%9C%E7%9A%84%E5%91%A2%EF%BC%9F" class="direct-link">#</a> CDN 是怎麼運作的呢？</h3><p>剛剛說了，CDN 其實就是一組在世界各地的伺服器，當使用者連往這些伺服器時，這些 CDN 伺服器會將請求轉發回原站。畫成圖的話看起來應該會長這樣。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cdn_work-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/cdn_work-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/cdn_work-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/cdn_work-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cdn_work-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/cdn_work-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/cdn_work-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/cdn_work-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/cdn_work-1920w.png" height="852" width="1580" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1580 852'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAACXBIWXMAABYlAAAWJQFJUiTwAAABD0lEQVQYlWNQdZrBp+W7iUfesYeh/Nx/Bhgo3vGfQdspmcHAp4QRxOcWlGZg0HTq0hZS8HI3sjPjnPniPxcbJ48mEyOD2v///5nkzGOYNJ0zwJo5eEUZGKwcQzi5uXk0rCPbxXNW/ZcQlVRQ4uXmkM1Z+lMwYfpLWTFlcwUGBgZDTj5xZgYd90l68kaZtv+LGBj+///PKCoqKi4mJia+8cl/xqzl/+XFlEzsGBgY4ti5BdkYeDgYWBkYGHRNguqki7f9l+LkFdZnYGDQrNn7XzC08xqvvIoOt6SEuDA7jwgDQ0paLpODozNHRKAb099//xlcXd04PDw82Z1L9jAkzXrLoKBjyyDAx8PAKyLLAACis0Bm0aJlGgAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h2 id="cdn-%E6%89%80%E5%B8%B6%E4%BE%86%E7%9A%84%E9%A2%A8%E9%9A%AA"><a href="#cdn-%E6%89%80%E5%B8%B6%E4%BE%86%E7%9A%84%E9%A2%A8%E9%9A%AA" class="direct-link">#</a> CDN 所帶來的風險</h2><p>使用 CDN 並不是沒有風險，畢竟在網站資訊到達使用者手上前還經過了 CDN 的伺服器，這些 CDN 可能會提供一些額外的功能。當網站設定有誤時，可能就會導致一些安全風險的產生。如：</p><ul><li>錯誤的 IP 紀錄方式</li><li>無效的 Cache 機制</li><li>意想不到的傳輸協定</li><li>繞過阻擋清單</li><li>Domain 聲譽影響</li></ul><p>當然還有更多由 CDN 帶來的風險，但礙於篇幅限制這邊就只舉例這五個。</p><h3 id="1.-%E9%8C%AF%E8%AA%A4%E7%9A%84-ip-%E7%B4%80%E9%8C%84%E6%96%B9%E5%BC%8F"><a href="#1.-%E9%8C%AF%E8%AA%A4%E7%9A%84-ip-%E7%B4%80%E9%8C%84%E6%96%B9%E5%BC%8F" class="direct-link">#</a> 1. 錯誤的 IP 紀錄方式</h3><p>一般 HTTP 伺服器紀錄 IP 位置的方式，是利用 TCP Socket 的 Src IP 欄位來記錄位置的。<br>但如果今天是由 CDN 轉發來的請求，因為 CDN 伺服器會成為客戶端向原站進行請求，所以 Src IP 會是 CDN 伺服器的回源 IP。進而造成原站伺服器紀錄到錯的 IP，導致之後的鑑識調查/事件應變/稽核相關流程發生問題。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/ip_wrong-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/ip_wrong-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/ip_wrong-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/ip_wrong-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/ip_wrong-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/ip_wrong-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/ip_wrong-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/ip_wrong-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/ip_wrong-1920w.png" height="852" width="1580" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1580 852'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAACXBIWXMAABYlAAAWJQFJUiTwAAABE0lEQVQYlWNQdZ7Op+W3kUfesY+h8tJ/BhjIXP6fIX7me2a3+HY+R+8kwdDaPZwMmk6d2kIK3m4GNsacM57+52Lj4NFkYmJU+///P6NrzTHObA8fmSJne5309C5hBkuHIE4+Pn4dq4hW8dzV/8XFpBVV+Pm45XOX/xWIn/5KTtU0UJ2PX8zaMW4SO4OO+0R9BaM0x/8qDAz///9nEBcXlxQXl5C89v8/Y9by//IiCoZ2DAwMsQwMDKwMvBwMbAwMDLqmQfXSxdv+S3HyiegzMjBo1e77LxjaeY1PUd2AW0pKSlhC2YyRISomidnC0orf38uJGeQxOzs7HgcHB26HjMUMKfO/Mijo2DII8PEw8ArLMgAAAZlF7VApmfkAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>為了解決這個問題，CDN 廠商通常會在轉發的 HTTP 請求中塞入特定 HTTP Header 來將實際客戶端的 IP 告訴原站伺服器<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/ip_http_header-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/ip_http_header-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/ip_http_header-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/ip_http_header-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/ip_http_header-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/ip_http_header-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/ip_http_header-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/ip_http_header-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/ip_http_header-1920w.png" height="852" width="1580" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1580 852'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAACXBIWXMAABYlAAAWJQFJUiTwAAABGUlEQVQYlQEOAfH+ACVCmA4qTbAMHkGOAGmw/wBKR0IFP0BCCyIWAgk+UGoKRGGLDjpLZBJRfLwJAClCiisSIEpGMj42CJrp/wkICw4rBgUEKXGPvQo/XIUPOUFNHTc7QS1FYIgTADpBUwkODg8sOlmFF22s/xcWGiAjDgwJHmeb6BJWgsMmIjZTKAoPGDo6X5QHACxHkS4gMmZB/zoAAP///wAXFxgZGBgYGcT//wFnovggFSAxPQAAAFwAAAAFAA0JAAYAAAAuNFJ+G3S3/xoJDhQwAAAAKWmZ4BdEYo0YIScwDBoaGhMXJDgBAF1fZgM5OTsPT0pBAwAAAAA+Pj4MQEBAC0FtrwBUfLgAISw9ABAODAAOFB0Axp1BAKaHGmAAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>如上圖的 CDN 伺服器就是在轉發的請求中利用 Real-IP 這個 Header 來告訴原站伺服器真正客戶端的位置。</p><p>這些預設的 HTTP Header Name 其實如果有用過的話都會知道，也較少人會去更改，如：</p><ul><li>Cloudflare: CF-Connecting-IP</li><li>Akamai: True-Client-IP</li><li>Cloudfront: CloudFront-Viewer-Address</li><li>Fastly: Fastly-Client-IP</li></ul><p>但這個 HTTP Header 也有可能被攻擊者濫用，攻擊者如果知道原站伺服器的位置的話（如利用掃描全網等方式獲得），可以直接向原站伺服器傳送帶有特定 HTTP Header 的請求，藉此來達到偽冒 IP 的效果，造成錯誤紀錄。甚至 Bypass 相關 ACL 設定。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/ip_log_attack-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/ip_log_attack-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/ip_log_attack-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/ip_log_attack-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/ip_log_attack-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/ip_log_attack-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/ip_log_attack-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/ip_log_attack-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/ip_log_attack-1920w.png" height="852" width="1580" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1580 852'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAACXBIWXMAABYlAAAWJQFJUiTwAAABEElEQVQYlWNQdZrOp+W7kVvesZeh7Mx/BhiIbD/JUHLkP5NzfAe/o0+KUETtHk4GLecuXWElXw9jOyPOyXf/c7Fx8mgwMTKoTjnyn801dRqvsYOvbKSDg15BRrcwA8N/sGmqltETxEt2/RcTFpdV4+HiUEyf+UQotOGguqJZsAaPgISVc+I0dgYLa2deB0c3CRNdFRFNUQZuC1NDDnsHZzbb6HbmzCV/FEQVDG0ZGBhiGBgYWBn09PQEdXV1NXT19BXjs2pYmJmZNRgYGJTjei+Ju6VMkFBQ0+eWkpISllK1YGQwMDBg1dfXF9TX1+cxMTFhUVZWFlBUVORzSZnMENJwgEFJ145BgI+HgU9ElgEAtF09lp+iSh0AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h4 id="%E8%A7%A3%E6%B3%95"><a href="#%E8%A7%A3%E6%B3%95" class="direct-link">#</a> 解法</h4><p>對於這個情況其實有兩種解決方法</p><ul><li>只 Rewrite CDN 過來的請求</li><li>直接封鎖非 CDN 伺服器來的所有請求</li></ul><ol><li><p>只 Rewrite CDN 伺服器送過來的請求的話，就會像下圖這樣，都記錄到正確的 IP。這種解法的缺點是，若非常見 Reverse Proxy (如：Nginx、Apache) 負責紀錄相關 IP 的話，會較難實作與設定<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/ip_log_partial-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/ip_log_partial-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/ip_log_partial-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/ip_log_partial-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/ip_log_partial-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/ip_log_partial-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/ip_log_partial-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/ip_log_partial-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/ip_log_partial-1920w.png" height="852" width="1580" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1580 852'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAACXBIWXMAABYlAAAWJQFJUiTwAAABEklEQVQYlWNQcZrOp+W7kVvesYeh7PR/BhiIaj/JUHzkP5NLQheflU+aUFDdAU4GLeduXWElP3djeyOO6Y//c7Fx8mgwMTKoTj70n805bSaPtWuwhIWti7pP3kJ+BiMGBkZmBgZ1i/BWyfwN/8WFxWXVeLg4FNNmPhEObTigrmQWosElIGltkzSLnSGjchXTpoPPmRkczjDYVV9lsDI3YrNzcGazie5gzln9X1ZYTt+agYEhkoGBgYXh//9fDP///2fgkHdgBLmVkZFRjYGBQTm256KEW3KfqpFTlIS2qbOyZ/4KDoaCggIGBwcHBiMjIwYVVVUGJSUlfnlZSV5D+2AGC5dwYzNbTwsLpwAzC5cwTQDQ6kXz9QGvgQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p></li><li><p>直接封鎖非 CDN 來的請求，這種方式在設定上較快速與較好實作，也不用擔心兩種不同的情況<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/ip_deny-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/ip_deny-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/ip_deny-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/ip_deny-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/ip_deny-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/ip_deny-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/ip_deny-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/ip_deny-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/ip_deny-1920w.png" height="852" width="1580" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1580 852'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAACXBIWXMAABYlAAAWJQFJUiTwAAABBklEQVQYlWNQcZrOp+W7kVvesYeh7PR/BhiIaj/FkLvrP5NLQieflU+aUFDdAU4GLeduXWElP3dje2OOqQ/+c7Fx8miwMTGqTdj5j90pdTq3tUuguIWti7pP3kJ+BiMGBkZmBgZ1i7BWycIt/8VFxWU1GFgZZBOWfeMPrd+nq2IVqcnJL25lnTSbnSGjchXThv1PmBmMFjG4PPrPAHLIc0NnyfTITikWYTk9VjZOOwYGhhgGBgZWhv//Ee5kZmCQZxBVVt1h6OFa41OoyMDAwCTCw8ErIysvzCOiyMgQExPDoK6uziAlIc4gKiYqKistL3FFQpNhSfYasAG8bEwMwiIiDIxADgD15zy8MkqZiQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p></li></ol><h3 id="2.-%E7%84%A1%E6%95%88%E7%9A%84-cache-%E6%A9%9F%E5%88%B6"><a href="#2.-%E7%84%A1%E6%95%88%E7%9A%84-cache-%E6%A9%9F%E5%88%B6" class="direct-link">#</a> 2. 無效的 Cache 機制</h3><p>CDN 大多都會提供暫存機制，來讓原站不會一直收到重複的請求浪費流量，但若錯誤設定 Cache 機制的話也可能會帶來安全性風險。如：</p><ul><li>被惡意植入前端後門</li><li>洩漏使用者資料</li></ul><h4 id="%E7%82%BA%E4%BB%80%E9%BA%BC%E9%80%99%E6%9C%83%E7%99%BC%E7%94%9F%EF%BC%9F"><a href="#%E7%82%BA%E4%BB%80%E9%BA%BC%E9%80%99%E6%9C%83%E7%99%BC%E7%94%9F%EF%BC%9F" class="direct-link">#</a> 為什麼這會發生？</h4><p>CDN 判斷一個資源要被暫存與否，通常是利用副檔名或者伺服器所回傳的 MIME Type 來判斷。像是 Cloudflare 就是純利用副檔名進行判斷。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cf_default_cache-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/cf_default_cache-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/cf_default_cache-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/cf_default_cache-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cf_default_cache-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/cf_default_cache-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/cf_default_cache-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/cf_default_cache-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/cf_default_cache-1920w.png" height="350" width="1668" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1668 350'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAAECAYAAABodtTSAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA4klEQVQYlT2JTU+CAACGOTcvaa1JoKBb9uVIoyHF+BDBrV9QKLO6NPCMZqtDdegG/OOniVuHZ++e5xXu/HtG7pSrkVOhW37lA9NjeOtVfmMHHCk99upNaocStQOJptRCkluIkoxQpCHFckr+OiZPfMplSJFMyJMJZRpWXqYBv88WX7HJz8Lie25wrZ3TPTnl4rKP8PkS8r7wyR4ssshmNXPIHm3WM4dVtF2Xt7nLOrL5eArYxB6beIxp6OiGiTYYIqhnGkqvT11UdjTbFQ1R/W+NY5X9ba/+XZOVDkqni9xW+ANxiHWzoycZwQAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>如果你的 CDN 只使用了副檔名進行判斷依據，可能會導致以下的情況發生，<code>/test.css?v=1</code> 與 <code>/test.css?v=2</code> 在原站上可能是不同的東西，但在經過 CDN 之後回傳了相同的結果。</p><p>CDN 通常會有相關的設定可以做更改，來決定應該依照哪些特徵（HTTP Path/Query）來判定這個是不是同個資源。</p><h4 id="case-study---chatgpt"><a href="#case-study---chatgpt" class="direct-link">#</a> Case Study - ChatGPT</h4><p>ChatGPT 伺服器因為不正確的 Rewrite 了 HTTP Path，導致 <code>/session</code> 與 <code>/session/test.css</code> 都會指向同一個 API。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/chatgpt_tweet-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/chatgpt_tweet-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/chatgpt_tweet-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/chatgpt_tweet-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/chatgpt_tweet-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/chatgpt_tweet-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/chatgpt_tweet-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/chatgpt_tweet-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/chatgpt_tweet-1920w.png" height="604" width="1638" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1638 604'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAYAAACeuGYRAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAm0lEQVQYlY2OSw7CMAxEk7CoqFCLlDSJ00/oJ2waqVfgCOy4/0kGxYIVGxZPI1sz9ojX84GUZlyHBCHEf6zbHeM4IoSAvh/gieC955mIWL+74uu6DiLnjOM4sOeMaZpgrWUDU8yfsHMOMUZQCBBaaxhjULRtW6ZpGlRVhXNd4yJPv/VKpXKhfFm3jZmXBTHe+CpZB6UUm6WUHHoDIx1PqoUMFd0AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>但因 ChatGPT 使用剛剛所說的利用副檔名判斷是否應該快取的 Cloudflare，所以 <code>/session/test.css</code> 的這個請求會被 CDN 快取。這時候攻擊者可以做以下的事：</p><ol><li>傳送 <code>chat.openai.com/api/auth/session/aaa.css</code> 的連結給被害人（或是直接亂撒讓別人點）</li><li>當有人點了這個連結後，CDN 伺服器就會把回傳結果暫存起來</li><li>攻擊者此時就可以存取這個連結來獲得其他人的 ChatGPT Access Token</li></ol><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/chatgpt_hit-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/chatgpt_hit-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/chatgpt_hit-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/chatgpt_hit-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/chatgpt_hit-1920w.jpg 1920w, /img/posts/seadog007/dangers-in-cdn/chatgpt_hit-1280w.jpg 1280w, /img/posts/seadog007/dangers-in-cdn/chatgpt_hit-840w.jpg 840w, /img/posts/seadog007/dangers-in-cdn/chatgpt_hit-320w.jpg 320w" type="image/jpeg"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/chatgpt_hit-1920w.jpg" height="776" width="2106" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 2106 776'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAFCAIAAAAR2vFGAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAxklEQVQImR3EawvBUBjA8eMF8yW80uxD8GVd3oxIIYnyQikpGubSctnB1NFczsyec4ZH/Pv1J6da1W01/HbdNw0AeFxvx2b90mnCoCf7XWnN34hCCGINx1tjQs2Fs1yxzfZMqW0uqTn3nIM8s8/Tx39kMzbs6exorRnds/3pfrlducdGfc+aCQEyFBKeUgQkSKpCTYWaFmraS1Uxk3Zte+e7Tsjv+OGI3h9BJYpxBZXY7xGCiQTPZV29wPU8lHWolIJyESrFLwhUmj/eCaXYAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br>(Source: <a href="https://twitter.com/naglinagli/status/1639351113571868673" rel="noopener noreferrer" target="_blank">https://twitter.com/naglinagli/status/1639351113571868673</a>)</p><h4 id="%E8%A7%A3%E6%B3%95-2"><a href="#%E8%A7%A3%E6%B3%95-2" class="direct-link">#</a> 解法</h4><ul><li>好好設定 Cache 相關的設定<ul><li>很難</li><li>檢查以下設定是否在 CDN 跟原站上都一致<ul><li>URL rewrites</li><li>Parameter</li></ul></li></ul></li><li>利用套件設定 HTTP 的 Cache-Control Header，讓不該被暫存的東西不要被 CDN 暫存</li></ul><h3 id="3.-%E6%84%8F%E6%83%B3%E4%B8%8D%E5%88%B0%E7%9A%84%E5%82%B3%E8%BC%B8%E5%8D%94%E5%AE%9A"><a href="#3.-%E6%84%8F%E6%83%B3%E4%B8%8D%E5%88%B0%E7%9A%84%E5%82%B3%E8%BC%B8%E5%8D%94%E5%AE%9A" class="direct-link">#</a> 3. 意想不到的傳輸協定</h3><p>CDN 通常會幫你啟用一些你想不到，較新世代的傳輸協定，如：HTTP/2、HTTP/3、QUIC、IPv6 等。</p><p>這邊以 IPv6 為例，通常 CDN 會幫你啟用 IPv4 + IPv6 Dual Stack，讓使用兩種不同 IP 協定的人都可以連上你的網站。下圖為 Akamai Site Accelerator 的設定<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/akamai_v6-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/akamai_v6-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/akamai_v6-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/akamai_v6-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/akamai_v6-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/akamai_v6-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/akamai_v6-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/akamai_v6-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/akamai_v6-1920w.png" height="356" width="1606" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1606 356'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAECAYAAACHtL/sAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAaklEQVQYlY3OSw7CMBAEUd//mmERAZIt7Ik8nk8hXwCyeKpdq0trjTEk37VxPl9cU/EEi/zHVySl1so1Z9Yh7JFpjkaiHj+tSBcLSu+dtVaKXPQx8AgS7thHKcfx4NN7igiqirtjZnf47hc4d/rzDVITmgAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>但也有 CDN 是預設開啟且無法關閉的，如 Cloudflare<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cf_v6-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/cf_v6-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/cf_v6-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/cf_v6-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cf_v6-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/cf_v6-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/cf_v6-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/cf_v6-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/cf_v6-1920w.png" height="750" width="1224" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1224 750'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAo0lEQVQImU2Ou27DMBAE+f9/lNKNy1SxDbdKAkUwyTu+GQjSGFRh+IDBNrPYMyklrLX03tn3/cW2bYQQcOIZjhlCrZV1XXm/IbfWiLkQU8F474/maOWcKaWQciOXSq2FnAutdcyyLEzTxDzPOOdQVUT0yAORY9F4EUSVGBMhRlQDzgtexn+K9Urr/5jz9Y+Pz19Olweni+V899x+0ouvKfBtK08rhORsiXod6AAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>這樣可能導致應用程式發生未預期的錯誤，或者是相關 ACL 遭繞過。</p><h4 id="case-study---popcat"><a href="#case-study---popcat" class="direct-link">#</a> Case Study - Popcat</h4><p>如果不知道 <a href="https://popcat.click/" rel="noopener noreferrer" target="_blank">Popcat</a> 是什麼的人，這邊稍微做個簡單介紹。Popcat 是個點擊類型的遊戲，這個遊戲會把玩家的點擊次數彙整往 API 送，並加進 IP 所屬國家的排行榜。</p><ul><li>Popcat 分為兩個部分<ul><li>前端<ul><li>30 秒把前端總共點擊的次數回傳給 API</li></ul></li><li>API<ul><li>一次請求只能包含 800 個點擊</li><li>30 秒內同個 IP 只能有一個 HTTP 請求</li></ul></li></ul></li></ul><p>我們的目的很明顯就是要拿到一堆 IP 來快速刷榜。但遊戲設計者在設計之初沒有考慮到 IPv6 這個協議，大概率可能是因為他原站主機只有 IPv4 的支援。在遊戲設計者使用 Cloudflare 後，我們可以看到這個站實際上是有 AAAA (IPv6) 的 DNS 紀錄的，也就是說我們可以利用 IPv6 來連到這個站。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/popcat_v6-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/popcat_v6-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/popcat_v6-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/popcat_v6-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/popcat_v6-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/popcat_v6-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/popcat_v6-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/popcat_v6-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/popcat_v6-1920w.png" height="578" width="1140" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1140 578'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAGCAYAAAAVMmT4AAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmElEQVQYlVWPWw6EIAxF24iP+EARAj+6/0WxFriTa9SZ+WiaNL09p7LvO5xz1VqLvu9hjIGqQkSeKnfPchwH1nWty7JgnmeM43jVMAxo25bhcoezhBBgra3OOTDAvm0bSJymibPSdd338nmelVepQJUfhX+NGCPxlaimad7A466ql4aqZiHOGFO5yCfpeeORUkKMsVDVe58/h9dH4Dji9SAAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>我們可以用以下幾種方式來獲得一大把的 IPv6 位置</p><ul><li>With Own v6 Allocation</li><li>ISPs provided IPv6 Address</li><li>4in6 Tunnel</li></ul><p>More Details: <a href="https://hackmd.io/@seadog007/popcat" rel="noopener noreferrer" target="_blank">https://hackmd.io/@seadog007/popcat</a></p><h4 id="%E8%A7%A3%E6%B3%95-3"><a href="#%E8%A7%A3%E6%B3%95-3" class="direct-link">#</a> 解法</h4><p>CDN 引入 IPv6 相關的風險有兩種解法</p><ul><li>禁用 CDN 的 IPv6 功能</li><li>想辦法讓原站應用程式支援<ul><li>非自行開發的系統可能會成為難點</li></ul></li></ul><h3 id="4.-%E7%B9%9E%E9%81%8E%E9%98%BB%E6%93%8B%E6%B8%85%E5%96%AE"><a href="#4.-%E7%B9%9E%E9%81%8E%E9%98%BB%E6%93%8B%E6%B8%85%E5%96%AE" class="direct-link">#</a> 4. 繞過阻擋清單</h3><p>CDN 通常會多種多樣的內建阻擋清單，來提供一些合規或者是簡易防火牆的功能。<br>如 Akamai 內建的 List，有分為 IP 與 GEO 兩種類型<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/akamai_bl-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/akamai_bl-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/akamai_bl-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/akamai_bl-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/akamai_bl-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/akamai_bl-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/akamai_bl-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/akamai_bl-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/akamai_bl-1920w.png" height="634" width="1280" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1280 634'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAYAAACTphZWAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAk0lEQVQImT2N2wqEMBBD/f+PtItiZXVFpUw7l7RdnAcfQkIIJ8N32y3GtRFRBVDNzD3nXJm5qmpNKXk37PsPIXz6dV3dzFyA9ZxzV1VXKaUD6MMcN4QQ+nmezcyaqroTURORxsztvu8GoD3juiyLk5n5pT1kEfEupeSPw7xuZRxHmaZZYlzlOA5RVSEiKaW8GYD8ARWj02VC1TdTAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>又如 Cloudflare 內建的 Geo Firewall Policy，或者是付費版的 IP List<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cf_rule-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/cf_rule-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/cf_rule-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/cf_rule-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cf_rule-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/cf_rule-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/cf_rule-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/cf_rule-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/cf_rule-1920w.png" height="612" width="790" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 790 612'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAfElEQVQYlV2PCQpEIQxDvf9FRXDf9w7p8D/DFEKKtnkqWmtkraUQAnvvnVD33tdFKYVijLT35iH0uHDOUUqJzjkkcPC79QiJY4xvEhrvPeWcac7JWmtxAgSCqLWSlJKUUowzxjASS8DBeUhr/b7lH8s4DOFnQECIBxKopz40ZfXFyF41XwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cf_bl-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/cf_bl-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/cf_bl-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/cf_bl-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/cf_bl-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/cf_bl-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/cf_bl-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/cf_bl-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/cf_bl-1920w.png" height="612" width="800" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 800 612'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAHCAYAAADam2dgAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAjUlEQVQYlT2OCwrEIAxEvf9JK42Gam39NMky2d0KDyGOLxNijLJtm+37obRXu65mrX2579twQs5ZiMiISFNKVkqx8zydWqs9z2OBiASDMYb23m2t9TLn9NtNOWdjZmVmN4wx/BEWEbHAzIL9vXdFBwxV1bu8oZSS/AyKPgCfYEIYhFKKmxD6rwEwwITiH9xo9AuUo51jAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>這些功能可能可以在不同場景中幫助到網站營運者，如為了合規需求所需的 ITAR, OFAC 地區清單，或者是因為地區法規可以提供的色情內容有所差別，也有些遊戲業者因為地區分潤需求利用此方式限制遊戲可以存取 API 的地區。</p><p>但是如果稍微研究一下，其實不難發現不同 CDN 廠商實作 GeoIP 的方式有所不同：如 Cloudflare 是使用 Maxmind 的 DB 來做 IP 的國家判斷，而 Akamai 是爬 IRRDB 到最下層來判斷這個 IP（相當於 whois）。</p><p>這會造成什麼問題呢？我們可以利用不同方式假冒 IP 位置的地區，讓他跟 IP 實際使用區域不一致，進而繞過相關設定，我們也可以搭配本篇前述所說的 IPv6 問題，以極低成本讓攻擊者繞過網站所設定的 ACL。</p><h4 id="demo---akamai"><a href="#demo---akamai" class="direct-link">#</a> Demo - Akamai</h4><ol><li><p>我們要先拿一段 >/48 的 IPv6，如這邊使用了 <code>2a0f:5707:ffa4::/46</code> 這段 IP<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/demo_v6_1-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/demo_v6_1-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/demo_v6_1-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/demo_v6_1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/demo_v6_1-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/demo_v6_1-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/demo_v6_1-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/demo_v6_1-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/demo_v6_1-1920w.png" height="722" width="1512" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1512 722'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAYAAACTphZWAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAg0lEQVQImV2MMQ7DMAwD/f9XFd37gnbqHCexHUuWYYpFDCRDCRx4A6UQY8TJUQ9YN7RmGGPA3WFm0NagqtNDrUKpwjO9d6oqxxgEQBGZfiXknH0rh2+1OskbALM/768/Hy836x72bWcU4VLKvHb3mzOqjSXX+SOklLimxGVd78F/X/4DCY3Wbl17ZVkAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p></li><li><p>建立一個 More specific 的 whois 資料，其中 Country 欄位可以自行填寫<br>像這邊是建立了一個 /48 的 IP 段<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/demo_v6_2-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/demo_v6_2-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/demo_v6_2-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/demo_v6_2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/demo_v6_2-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/demo_v6_2-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/demo_v6_2-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/demo_v6_2-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/demo_v6_2-1920w.png" height="420" width="1676" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1676 420'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAECAYAAABREWWJAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAiUlEQVQImY3JWw6CMABE0e5/Zwas0CIgFFr6gCVYE5wxkuin8ST3YzIipXVft21/I7kD+Dtxz5k5P/jxBAh8509CXiro5gqlNaZpQozxqOt63IYBMSWEEOC9R1XXGEeDECK8DxAnqSlVy6btOc+W1jouy0KtG5blmbO1dM4dX1GUlPLCWikaY/gC4qXgvlgsvhoAAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p></li></ol><p>Country: KP 指定說這段 IP 歸屬地是 DPRK<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/demo_v6_3-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/demo_v6_3-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/demo_v6_3-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/demo_v6_3-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/demo_v6_3-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/demo_v6_3-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/demo_v6_3-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/demo_v6_3-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/demo_v6_3-1920w.png" height="792" width="696" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 696 792'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAcAAAAICAYAAAA1BOUGAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmklEQVQImU3N0W6EIBRFUf//C5to8aGAygUuY6VqxnE3OknT/bqScxoRoe97rLV8WYtzjqVWrhrvB7qu49MY2ralN4bXcbxRS0FiZN93wuPBoEpeV9bnkyYE4Zq+mlJGtBC1sN8owjzPN/rlm+Hn/XfPxhj/0IaEGSPH+Q9FIpwnLisfzuOnQF0qTUqJEALbtjGNIyVnVJVaK78MZ9TjAXom8gAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><ol start="3"><li>這時候我們如果利用這段 IP 連往使用 IRRDB 作為 GeoIP 來源的 CDN（如 Akamai），就可以繞過相關阻擋規則<br>這邊也可以用 Akamai 所提供的工具做 IP Geo 檢查<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/demo_v6_4-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/demo_v6_4-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/demo_v6_4-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/demo_v6_4-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/demo_v6_4-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/demo_v6_4-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/demo_v6_4-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/demo_v6_4-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/demo_v6_4-1920w.png" height="732" width="1492" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1492 732'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAFCAYAAACTphZWAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA3ElEQVQImR2Lq04DQRhGB8KicDUYUsFNYDE0VSUBJIKEgELgELg6nmAR25QOYWEhGN6GlyjDpZ0dxLKzM93t/38kI445J0es7p3RzuEltXZPKNrYp5WtHi22u7Sw1qGldpei9R4tbx9RtHlA4vT8AjLNcJ+9YviQQT6+IJEp4oFEnIwQJ3e4HUiM0meI47d3Hn9PufwrGMwMIDCfN1xZyzPvuWnq4MRV/ITxh4JSCjrPURQFyrKEMQZTraHUJ4z5RV3XENf9G3z9TFBZi8o5OOdCsNaGSes8jN57/AMzWqiz0ci5EgAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></li></ol><p>以此類推，我們也可以建立其他國家的 IP 段，像日本的段我們就可以用來打日本遊戲，而不用擔心使用 VPN 被阻擋等問題。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/demo_v6_5-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/demo_v6_5-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/demo_v6_5-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/demo_v6_5-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/demo_v6_5-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/demo_v6_5-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/demo_v6_5-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/demo_v6_5-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/demo_v6_5-1920w.png" height="396" width="1596" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1596 396'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAECAYAAACHtL/sAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAhUlEQVQYlXWOywoEMQgE8/+/OmM0CWyc9dGLuc1hGwpaRagWEV8R8QLAISL+YmZORD7n9Mz09pgHM+O+CXMuVF9rITMRES9qZ2YgIlDvUFU0NY8xBpglRSSJKJk5e+dU1axExKFiZufWe8/P3tnU4hjUk4igqPm6bqg+L5Pq7n4MynjvjR9vkvho0jZU+wAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h4 id="demo---cloudflare"><a href="#demo---cloudflare" class="direct-link">#</a> Demo - Cloudflare</h4><p>如果是使用外部 GeoIP DB 的 CDN 廠商如 Cloudflare，我們可以從外部 DB 下手<br>我們知道 Cloudflare 用的 GeoIP DB 是 Maxmind，這時候我們可以發現 Maxmind 有提供 GeoIP 修正的表單可以填寫<br><a href="https://www.maxmind.com/en/geoip-location-correction" rel="noopener noreferrer" target="_blank">https://www.maxmind.com/en/geoip-location-correction</a></p><p>惡意攻擊者也可以利用這種方式來將指定 IP 修正至其他國家，來繞過 Geo 類型的阻擋清單。</p><h4 id="%E8%A7%A3%E6%B3%95-4"><a href="#%E8%A7%A3%E6%B3%95-4" class="direct-link">#</a> 解法</h4><ul><li>比較各家 CDN 所使用的 GeoIP 實作方式</li><li>不要太過度相信 CDN Geo 相關規則所阻擋完剩下的請求<ul><li>可能用了 VPN、跳板等</li><li>原生 IP 地址就是被改過的</li></ul></li></ul><h3 id="5.-domain-%E8%81%B2%E8%AD%BD%E5%BD%B1%E9%9F%BF"><a href="#5.-domain-%E8%81%B2%E8%AD%BD%E5%BD%B1%E9%9F%BF" class="direct-link">#</a> 5. Domain 聲譽影響</h3><p>要暸解這個弱點，首先我們要先了解 HTTPS 跟 HTTP Reverse Proxy 運作的原理。<br>首先，CDN 伺服器可能一個 IP 就負責成千上萬個網站，所以這些網站的使用者都會連往同一台伺服器，CDN 伺服器勢必要判斷使用者想去哪。</p><p>HTTP Reverse Proxy（CDN 也是種 Reverse Proxy）利用的是 HTTP Header 中的 Host 欄位來做判斷，看使用者想連往哪個網站。</p><p>HTTPS 因為有 SSL/TLS 在前面做保護，所以在 SSL/TLS 握手完之前，Reverse Proxy 沒辦法看到 HTTP 的 Header，這時候怎麼判斷使用者想連往哪個網站呢？因應這個問題所以 Reverse Proxy 使用了 SSL/TLS Handshake 中的 Server Name Indication (SNI) 欄位來做判斷。</p><p>這也是我們可以使用 <code>-H Host</code> 的方式指定要連往哪個 HTTP 站點<br><code>curl -H 'Host: www.example.com' http://&lt;ip></code></p><p>但 HTTPS 站點就不能透過指定 HTTP Header 來連到（除非是該 IP 的 Default Server）<br><code>curl -H ‘Host: www.example.com’ https://&lt;ip></code></p><p>我們必須透過 curl 的 --resolve 參數來做到這件事<br><code>curl --resolve www.example.com:443:&lt;ip> https://www.example.com</code></p><p>許多防火牆對於 HTTPS 流量，用來判斷的依據也是 SNI<br>那如果今天這兩個欄位不一致會發生什麼事？我們用 SNI A 配上 HTTP Host B，如果今天 CDN Server 使用的是 SNI Prefer Forwarding 的話，就單純只看 SNI 來決定要把請求轉發給哪個原站，這時候如果原站沒有再做一次其他轉發的話，基本上是沒有問題的</p><p>但如果今天 CDN 使用的是 Host Prefer Forwarding，這時候，你用 SNI A 連到的站，會看到 B 網站的內容，這時候可能就會有攻擊情況產生。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/fw_table-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/fw_table-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/fw_table-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/fw_table-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/fw_table-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/fw_table-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/fw_table-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/fw_table-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/fw_table-1920w.png" height="564" width="1330" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1330 564'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAFCAYAAABxeg0vAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAn0lEQVQImS2O2xKDIAxE+f8PrIBVIIhVBBUvfd1OsA/JTHbm7IkInxFTnBHTguM6sZUd+1HqrPuGch41K/9b8DrvC3GJkFphyQmd6eE81SLO8rZCvltQGCC44fre1aC0Qlozur6DDwOm+QG4NLQa8xggWMevhBBAzsFaA2ctBu/hiPCSDVJOaJUEET0AWxjwRLDGVJAB8oRGyeelVlfrDwCM3iVwUFI7AAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>因為這個問題已存在一段時間，有些 CDN 已針對此問題做出相對應的修復，在 SNI 跟 Host Header 不一致的情況下，各家 CDN 的回應大概像是這樣：</p><ul><li>Cloudflare: 403</li><li>Cloudfront: 403</li><li>Akamai: 503 or 400</li><li>Fastly: Host Prefer Forwarding</li></ul><p>像 Fastly 沒有做好相關的阻擋及防範，我們可以利用這個方式來達成稱為 Domain Fronting 的攻擊。在更糟的情況下，如果 CDN 在加入 Domain 時沒有檢查 Domain 的擁有權，我們可以加入任意名稱的 Domain 來做轉發，這樣在有 SSL Inspection 的環境中，同樣也可以繞過相關偵測。</p><p>舉例來說，我們可以加入叫做 <a href="http://there-is-no-way.this.exist.com" rel="noopener noreferrer" target="_blank">there-is-no-way.this.exist.com</a> 的 Domain 進入 Fastly，而在當有 SSL Inspection 的環境中瀏覽時，看到的 HTTP Header 就會是這個 Domain。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/fastly_1-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/fastly_1-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/fastly_1-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/fastly_1-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/fastly_1-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/fastly_1-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/fastly_1-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/fastly_1-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/fastly_1-1920w.png" height="350" width="1638" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1638 350'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAAECAYAAABodtTSAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAtklEQVQYlZWIy2rCQABF832+BSFtNaY+sN316wpKfIIgfkPVmXHizCSbClV36SlVUFx64XAuxyuE79R6H5TCN3J+k2rQJecHFJ9fyftNCk8h5Xqb0kvr/CuNzplqcPF/86LJlM9BxHAyYzAc049GzBdLxDbmayNZCcVK3LyW6sqlKbz9/htnLYlzWGuIY83h8MMj87ZaE+92OOdIkgRjDGmaYqxFSolSio0QaK05Hk/8AlmW3fEHZoXgFsFuFh4AAAAASUVORK5CYII='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h4 id="demo"><a href="#demo" class="direct-link">#</a> Demo</h4><p>我們先在 Fastly 上加入了一個 <code>www.president.gov.tw</code> 的 Domain，且我們知道 <code>bbc.com</code> 是用了 Fastly 的服務，這時候我們可以 curl 來存取這個網站。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/fastly_2-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/fastly_2-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/fastly_2-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/fastly_2-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/fastly_2-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/fastly_2-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/fastly_2-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/fastly_2-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/fastly_2-1920w.png" height="362" width="1602" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1602 362'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAECAYAAACHtL/sAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAdklEQVQYlZ2OywpDIQwFg1xfoCY+FiL6/z8ZTFFoN4UuuhgmDFkcqLWy956PiYitteycY0TkEML16YeU0v097Q0AgNRahYjk3H8AUkrZiLiVUvt5ng9a62sA+AVIjHHnnGXOKb13aa3JGEPWWrch4l1ojPla8AIfHUXALd+6rwAAAABJRU5ErkJggg=='%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><p>這時候各種檢查機制看起來會長的像是這樣</p><ul><li>SSL Inspection：<a href="http://www.president.gov.tw" rel="noopener noreferrer" target="_blank">www.president.gov.tw</a></li><li>SNI Inspection：<a href="http://bbc.com" rel="noopener noreferrer" target="_blank">bbc.com</a></li><li>IP Firewall：151.101.64.81 (AS54113 / Fastly, Inc.)</li><li>內容：103.147.22.128:80（跟上面都沒關係）</li></ul><p>會發現這個內容實際上的位置，因為利用了 CDN 隱藏原站 IP 的特性，並不存在客戶端任何檢查機制可以看到的範圍，這也導致惡意攻擊更難被識別與阻擋。</p><h4 id="case-study-%E2%80%93-china-apt"><a href="#case-study-%E2%80%93-china-apt" class="direct-link">#</a> Case Study – China APT</h4><p>中國 APT 曾用 <a href="http://pypi.python.org" rel="noopener noreferrer" target="_blank">pypi.python.org</a> 來做 fronting domain，這時候各種客戶端的阻擋機制看起來會是這樣的：</p><ul><li>DNS：Query for <a href="http://pypi.python.org" rel="noopener noreferrer" target="_blank">pypi.python.org</a></li><li>IP Based Firewall：Connect for Fastly （<a href="http://151.xxx.xxx.xxx" rel="noopener noreferrer" target="_blank">151.xxx.xxx.xxx</a>）</li><li>SNI Check：<a href="http://pypi.python.org" rel="noopener noreferrer" target="_blank">pypi.python.org</a></li></ul><p>幾乎各種檢查機制都會被繞過，以下是事件相關的 Cobalt Strike Beacon Profile<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/china_apt-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/china_apt-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/china_apt-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/china_apt-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/china_apt-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/china_apt-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/china_apt-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/china_apt-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/china_apt-1920w.png" height="430" width="1552" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1552 430'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAECAYAAABREWWJAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAn0lEQVQImVWOsW7CQBQE/TkR9u69OzA+u8I+2pSho6emI+HTT28jHIRIMRptNduM41RzztXMKoBK8uXdNFWk9Np8+I1mKUWlFMUYBUAkV4NB5zHrE50+ALXkP0CqKcejz4eDm5mTXAHgDMFP2+Rf0Tx3nQ+bjQ/tH/u2dQLezPOsZVnU9/1a5aP6fHBJSffdVt8WdAvUTzTdLegaKAP0C/TVYI7Rl5IRAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture><br>(Source: <a href="https://teamt5.org/en/posts/hiding-in-plain-sight-obscuring-c2s-by-abusing-cdn-services/" rel="noopener noreferrer" target="_blank">Hiding in Plain Sight: Obscuring C2s by Abusing CDN Services</a>)</p><h4 id="%E5%BD%B1%E9%9F%BF"><a href="#%E5%BD%B1%E9%9F%BF" class="direct-link">#</a> 影響</h4><p>這個問題會對 Domain 聲譽造成影響，如 <a href="http://bbc.com" rel="noopener noreferrer" target="_blank">bbc.com</a>，在 Virustotal 上的相關結果是長這樣的。Domain 聲譽遭受影響可能導致 Email 被拒收或部分使用者連不上。<br><picture><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/bbc_virus-1920w.webp 1920w, /img/posts/seadog007/dangers-in-cdn/bbc_virus-1280w.webp 1280w, /img/posts/seadog007/dangers-in-cdn/bbc_virus-840w.webp 840w, /img/posts/seadog007/dangers-in-cdn/bbc_virus-320w.webp 320w" type="image/webp"><source sizes="(max-width: 758px) 100vw, 758px" srcset="/img/posts/seadog007/dangers-in-cdn/bbc_virus-1920w.png 1920w, /img/posts/seadog007/dangers-in-cdn/bbc_virus-1280w.png 1280w, /img/posts/seadog007/dangers-in-cdn/bbc_virus-840w.png 840w, /img/posts/seadog007/dangers-in-cdn/bbc_virus-320w.png 320w" type="image/png"><img alt="" src="/img/posts/seadog007/dangers-in-cdn/bbc_virus-1920w.png" height="768" width="1224" decoding="async" loading="lazy" style="background-size:cover;background-image:url(&#34;data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http%3A//www.w3.org/2000/svg' xmlns%3Axlink='http%3A//www.w3.org/1999/xlink' viewBox='0 0 1224 768'%3E%3Cfilter id='b' color-interpolation-filters='sRGB'%3E%3CfeGaussianBlur stdDeviation='.5'%3E%3C/feGaussianBlur%3E%3CfeComponentTransfer%3E%3CfeFuncA type='discrete' tableValues='1 1'%3E%3C/feFuncA%3E%3C/feComponentTransfer%3E%3C/filter%3E%3Cimage filter='url(%23b)' preserveAspectRatio='none' height='100%25' width='100%25' xlink%3Ahref='data%3Aimage/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAGCAYAAAD68A/GAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAk0lEQVQImUWO4QoCMQyD7/2fU4UTbm1vbq1dt8h2ioHQ/ghfsqlqJ+bOIt3MekQse2t9Kr7ezAzEDKsVWitETpRSQMQwe+OnGRws5wjV0dwHEY+cX+M40roRMdzbWEQWgZuiuYNZUGrFkdL6c86oqosI4n9wVtfvBFVD7/2qVlUkIrhewUmaxH1/4nZ/4MwZrTV8AOiR6GgkweUrAAAAAElFTkSuQmCC'%3E%3C/image%3E%3C/svg%3E&#34;)"></picture></p><h4 id="%E8%A7%A3%E6%B3%95-5"><a href="#%E8%A7%A3%E6%B3%95-5" class="direct-link">#</a> 解法</h4><p>對於這種問題，基本上 CDN 使用者可以做的有限，只能好好挑選 CDN 廠牌，又或者試著說服他們修復這個問題。</p><h2 id="%E7%B8%BD%E7%B5%90"><a href="#%E7%B8%BD%E7%B5%90" class="direct-link">#</a> 總結</h2><p>看完這篇文章，你覺得使用 CDN 很糟糕嗎？當然這場演講、這篇文章並不是要叫大家不要用 CDN，在大多數的時候，使用 CDN 能帶來的好處遠遠大於使用 CDN 的缺點。</p><p>CDN 提供了網站管理者更多的保護，但 CDN 使用者還是需要確認 CDN 所提供的最佳實作方式（Best Practices Guide），並比較不同的 CDN 廠商。最後，不要過度相信 CDN 所提供的功能，這些功能有可能會導致原始網站運作不正常或出現弱點。</p><p>有任何資安方面相關的問題都歡迎留言討論，或者直接聯繫 <a href="https://cymetrics.io/zh-tw/" rel="noopener noreferrer" target="_blank">Cymetrics</a> 尋求相關協助。</p><div class="article-footer"><a href="https://tech-blog.cymetrics.io/posts/seadog007/dangers-in-cdn/" on-click="share"><img alt="Share" src="/img/icons/icon_external link hyperlink.svg" height="24" width="24">Share this post</a></div><div><p style="font-weight: bold;">Tag</p><div class="post-tags"><a href="/tags/security/" class="post-tag">#Security</a> <a href="/tags/cdn/" class="post-tag">#CDN</a> <a href="/tags/cloud/" class="post-tag">#Cloud</a> <a href="/tags/internet/" class="post-tag">#Internet</a> <a href="/tags/network/" class="post-tag">#Network</a> <a href="/tags/networking/" class="post-tag">#Networking</a></div><p style="font-weight: bold;">Recommendation</p><ol><li><a href="/posts/huli/defi-poly-network-hacked/">Poly Network 遭駭事件分析</a></li><li><a href="/posts/zet/golang-poc-scanner/">使用 golang 設計與實作批量檢測工具</a></li><li><a href="/posts/crystal/dns-hacking-3/">DNS Hacking 之 Subdomain Enumeration 的技巧與自動化挖掘</a></li><li><a href="/posts/nick/directory/">秒懂 Directory Traversal(目錄遍歷)</a></li><li><a href="/posts/jo/zerobased-common-risk-fix/">資安科普番外篇（二）-如何有效率選擇風險進行修復 feat.風險和法規息息相關？！</a></li></ol></div><div class="article-author"><img alt="seadog007" src="/img/authors/seadog007_logo.png" class="article-author__img" data-deopt="true"><div class="article-author__info"><div class="article-author__title">Author</div><div class="article-author__author"><a href="/posts/seadog007">seadog007</a></div><div class="article-author__intro"></div></div></div><p style="font-weight: bold;">Discussion(login required)</p><script async="" src="https://utteranc.es/client.js" crossorigin="anonymous" id="utterance-script" issue-term="title" label="utterance" repo="cymetrics/blog" theme="github-light"></script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"那些隱藏在 CDN 中的危險：為什麼 CDN 可能沒有你想的那麼安全","image":["https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/cdn_cf-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/cdn_benifit-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/cdn_work-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/ip_wrong-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/ip_http_header-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/ip_log_attack-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/ip_log_partial-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/ip_deny-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/cf_default_cache-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/chatgpt_tweet-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/chatgpt_hit-1920w.jpg","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/akamai_v6-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/cf_v6-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/popcat_v6-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/akamai_bl-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/cf_rule-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/cf_bl-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/demo_v6_1-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/demo_v6_2-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/demo_v6_3-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/demo_v6_4-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/demo_v6_5-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/fw_table-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/fastly_1-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/fastly_2-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/china_apt-1920w.png","https://tech-blog.cymetrics.io/img/posts/seadog007/dangers-in-cdn/bbc_virus-1920w.png","https://tech-blog.cymetrics.io/img/icons/icon_external link hyperlink.svg","https://tech-blog.cymetrics.io/img/authors/seadog007_logo.png"],"author":{"@type":"Person","name":"seadog007"},"publisher":{"@type":"Organization","name":"Cymetrics Tech Blog","url":"https://tech-blog.cymetrics.io","logo":{"@type":"ImageObject","url":"https://tech-blog.cymetrics.io/img/favicon/favicon-512x512.png","width":512,"height":512}},"url":"https://tech-blog.cymetrics.io/posts/seadog007/dangers-in-cdn/","mainEntityOfPage":"https://tech-blog.cymetrics.io/posts/seadog007/dangers-in-cdn/","datePublished":"2023-06-02","dateModified":"2023-08-28","description":"內容分發網絡 (CDN) 是現代網際網路占比相當重要的一個部分，它為全世界的使用者提供快速可靠的連結與與網路資源。但是，儘管 CDN 提供了許多好處，它們也會引入許多人可能不知道的新的安全風險。本文中將探討 CDN 的隱藏危險，並探討為什麼 CDN..."}</script></article></main><footer><div class="footer-logos"><a href="https://www.facebook.com/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="facebook" src="/img/icons/icon_social media_facebook.svg" height="30" width="30"></a><a href="https://www.linkedin.com/company/cymetrics" rel="noopener noreferrer" target="_blank"><img alt="linkedin" src="/img/icons/icon_social media_linkedln.svg" height="30" width="30"></a><a href="https://tech-blog.cymetrics.io/feed/feed.xml" rel="noreferrer noopener" target="_blank"><img alt="rss feed" src="/img/icons/rss-feed.svg" height="30" width="30"></a></div><div class="copyright">© 2021 Cymetrics Tech Blog, based on <a href="https://github.com/google/eleventy-high-performance-blog" rel="noopener noreferrer" target="_blank">eleventy-high-performance-blog</a>. <a href="https://oneinfinity.global/" rel="noopener noreferrer" target="_blank">OneInfinity</a></div></footer><script>// light/dark theme switch
      // disable dark mode for now
      const menuBtn = document.querySelector('.menu__btn')
      menuBtn.addEventListener('click', function() {
        document.querySelector('body').classList.toggle('lock')
        menuBtn.classList.toggle('menu__btn--close');
        document.querySelector('.nav__links').classList.toggle('nav__links--open')
      })</script></body></html>